/*!
 * Copyright 2004-2015, AfterLogic Corp.
 * Licensed under AGPLv3 license or AfterLogic license
 * if commerical version of the product was purchased.
 * See the LICENSE file for a full license statement.
 */
!function($,window,ko,crossroads,hasher){"use strict";function CBrowser(){this.edge=/edge/.test(navigator.userAgent.toLowerCase()),this.ie11=!!navigator.userAgent.match(/Trident.*rv[ :]*11\./),this.ie=/msie/.test(navigator.userAgent.toLowerCase())&&!window.opera||this.ie11,this.ieVersion=this.getIeVersion(),this.ie8AndBelow=this.ie&&this.ieVersion<=8,this.ie9AndBelow=this.ie&&this.ieVersion<=9,this.ie10AndAbove=this.ie&&this.ieVersion>=10,this.opera=!!window.opera||/opr/.test(navigator.userAgent.toLowerCase()),this.firefox=/firefox/.test(navigator.userAgent.toLowerCase()),this.chrome=/chrome/.test(navigator.userAgent.toLowerCase())&&!/opr/.test(navigator.userAgent.toLowerCase()),this.chromeIos=/crios/.test(navigator.userAgent.toLowerCase()),this.safari=/safari/.test(navigator.userAgent.toLowerCase())&&!this.chromeIos}function CAjax(){this.sUrl="?/Ajax/",this.requests=ko.observableArray([]),this.openedRequestsCount=ko.observable(0),this.requests.subscribe(function(){this.openedRequestsCount(this.requests().length)},this),this.aActionsWithoutAuthForSend=["SystemLogin","SystemUpdateLanguageOnLogin","SystemLogout","AccountCreate","SystemSetMobile","AccountRegister","AccountGetForgotQuestion","AccountValidateForgotQuestion","AccountChangeForgotPassword"],this.aActionsWithoutAuthForSendExt=["SocialRegister","HelpdeskRegister","HelpdeskForgot","HelpdeskLogin","HelpdeskForgotChangePassword","SystemLogout","CalendarList","CalendarEventList","FilesPub"]}function CRouting(){this.defaultScreen=Enums.Screens.Mailbox,this.currentScreen=Enums.Screens.Mailbox,this.lastMailboxHash=ko.observable(Enums.Screens.Mailbox),this.lastHelpdeskHash=ko.observable(Enums.Screens.Helpdesk),this.lastSettingsHash=ko.observable(Enums.Screens.Settings),this.currentHash=ko.observable(""),this.previousHash=ko.observable("")}function CLinkBuilder(){}function CMessageSender(){this.replyText=ko.observable(""),this.replyDraftUid=ko.observable(""),this.postponedMailData=null}function CPrefetcher(){this.prefetchStarted=ko.observable(!1),this.serverInitializationsDone=ko.observable(!1),this.helpdeskInitialized=ko.observable(!1),this.fetchersIdentitiesPrefetched=ko.observable(!1),this.init()}function CSelector(e,t,i,s,o,n,a,r,l,h){this.fBeforeSelectCallback=null,this.fSelectCallback=t||function(){},this.fDeleteCallback=i||function(){},this.fDblClickCallback=!bMobileApp&&s?s:function(){},this.fEnterCallback=o||function(){},this.bResetCheckedOnClick=!Utils.isUnd(a)&&!!a,this.bCheckOnSelect=!Utils.isUnd(r)&&!!r,this.bUnselectOnCtrl=!Utils.isUnd(l)&&!!l,this.bDisableMultiplySelection=!Utils.isUnd(h)&&!!h,this.useKeyboardKeys=ko.observable(!1),this.list=ko.observableArray([]),e&&e.subscribe&&e.subscribe(function(e){this.list(e)},this),this.multiplyLineFactor=n,this.oLast=null,this.oListScope=null,this.oScrollScope=null,this.iTimer=0,this.iFactor=1,this.KeyUp=Enums.Key.Up,this.KeyDown=Enums.Key.Down,this.KeyLeft=Enums.Key.Up,this.KeyRight=Enums.Key.Down,this.multiplyLineFactor&&(this.multiplyLineFactor.subscribe?this.multiplyLineFactor.subscribe(function(e){this.iFactor=0<e?e:1},this):this.iFactor=Utils.pInt(this.multiplyLineFactor),this.KeyUp=Enums.Key.Up,this.KeyDown=Enums.Key.Down,this.KeyLeft=Enums.Key.Left,this.KeyRight=Enums.Key.Right,$("html").hasClass("rtl")&&(this.KeyLeft=Enums.Key.Right,this.KeyRight=Enums.Key.Left)),this.sActionSelector="",this.sSelectabelSelector="",this.sCheckboxSelector="";var c=this;this.listChecked=ko.computed({read:function(){var e=_.filter(this.list(),function(e){var t=e.checked(),i=e.selected();return t||c.bCheckOnSelect&&i});return e},write:function(e){e=!!e,_.each(this.list(),function(t){t.checked(e)}),this.list.valueHasMutated()},owner:this}),this.checkAll=ko.computed({read:function(){return 0<this.listChecked().length},write:function(e){this.listChecked(!!e)},owner:this}),this.selectorHook=ko.observable(null),this.selectorHook.subscribe(function(){var e=this.selectorHook();e&&e.selected(!1)},this,"beforeChange"),this.selectorHook.subscribe(function(e){e&&e.selected(!0)},this),this.itemSelected=ko.computed({read:this.selectorHook,write:function(e){this.selectorHook(e),e&&(this.oLast=e)},owner:this}),this.list.subscribe(function(e){if(_.isArray(e)){var t=this.itemSelected();t&&(_.find(e,function(e){return t===e})||this.itemSelected(null))}else this.itemSelected(null)},this),this.listCheckedOrSelected=ko.computed({read:function(){var e=this.itemSelected(),t=this.listChecked();return 0<t.length?t:e?[e]:[]},write:function(e){e?this.listChecked(!0):(this.itemSelected(null),this.listChecked(!1))},owner:this}),this.listCheckedAndSelected=ko.computed({read:function(){var e=[],t=this.itemSelected(),i=this.listChecked();return i&&(e=i.slice(0)),t&&_.indexOf(i,t)===-1&&e.push(t),e},write:function(e){e?this.listChecked(!0):(this.itemSelected(null),this.listChecked(!1))},owner:this}),this.isIncompleteChecked=ko.computed(function(){var e=this.list().length,t=this.listChecked().length;return 0<e&&0<t&&e>t},this),this.onKeydownBinded=_.bind(this.onKeydown,this)}function CApi(){this.openPgp=null,this.openPgpCallbacks=[]}function CStorage(){this.bHtml5=!0,this.init()}function CPhone(){this.provider=null,this.report=ko.observable(""),this.missedCalls=ko.observable(!1),this.phoneToCall=ko.observable(""),this.action=ko.observable(Enums.PhoneAction.Offline),this.action.subscribe(function(e){switch(e){case Enums.PhoneAction.Offline:this.provider.reconnect(6e4);break;case Enums.PhoneAction.OfflineError:this.provider.reconnect(6e4);break;case Enums.PhoneAction.OfflineInit:this.provider.init();break;case Enums.PhoneAction.OfflineActive:break;case Enums.PhoneAction.Online:App.Screens.hidePopup(PhonePopup),App.desktopNotify({action:"hide"}),this.provider.reconnect(),this.provider.hangup();break;case Enums.PhoneAction.OnlineActive:break;case Enums.PhoneAction.Outgoing:this.provider.call(this.getFormattedPhone(this.phoneToCall()));break;case Enums.PhoneAction.OutgoingConnect:break;case Enums.PhoneAction.Incoming:break;case Enums.PhoneAction.IncomingConnect:App.Screens.hidePopup(PhonePopup),App.desktopNotify({action:"hide"}),this.provider.answer()}},this)}function CPhoneWebrtc(){this.phone=App.Phone,this.action=App.Phone.action,this.stack=ko.observable(null),this.registerSession=ko.observable(null),this.callSession=ko.observable(null),this.stackConf=ko.observable(null),this.registerConf=ko.observable(null),this.hangupConf=ko.observable(null),this.isStarted=ko.observable(!1),this.eventSessionBinded=this.eventSession.bind(this),this.createStackErrorBinded=this.createStackError.bind(this),this.createStackBinded=this.createStack.bind(this),this.audioRemote=document.getElementById("audio_remote"),this.interval=0}function CPhoneFlash(){this.flash=null,this.jqFlash=null,this.phone=App.Phone,this.voiceApp=App.Phone.voiceApp,this.report=App.Phone.report,this.action=App.Phone.action,this.voiceImpi=AppData.User.VoiceImpi,this.voicePassword=AppData.User.VoicePassword,this.sessionid=ko.observable(""),this.callState=ko.observable(""),this.initStatus=ko.observable(!1),this.connectStatus=ko.observable(!1),this.init()}function CPhoneTwilio(){this.phone=App.Phone,this.action=App.Phone.action,this.device=null,this.connection=null,this.token=null,this.webSocket=null}function OpenPgp(e,t){this.pgp=e,this.pgpKeyring=new this.pgp.Keyring(new this.pgp.Keyring.localstore(t)),this.keys=ko.observableArray([]),this.reloadKeysFromStorage()}function OpenPgpKey(e){this.pgpKey=e;var t=this.pgpKey.getPrimaryUser();this.user=t&&t.user?t.user.userId.userid:this.pgpKey.users&&this.pgpKey.users[0]?this.pgpKey.users[0].userId.userid:"",this.emailParts=Utils.Address.getEmailParts(this.user)}function OpenPgpResult(){this.result=!0,this.errors=null,this.notices=null,this.exceptions=null}function ConfirmAnotherMessageComposedPopup(){this.fConfirmCallback=null,this.shown=!1}function AlertPopup(){this.alertDesc=ko.observable(""),this.closeCallback=null,this.title=ko.observable(""),this.okButtonText=ko.observable(Utils.i18n("MAIN/BUTTON_OK"))}function ConfirmPopup(){this.fConfirmCallback=null,this.confirmDesc=ko.observable(""),this.title=ko.observable(""),this.okButtonText=ko.observable(Utils.i18n("MAIN/BUTTON_OK")),this.cancelButtonText=ko.observable(Utils.i18n("MAIN/BUTTON_CANCEL")),this.shown=!1}function AccountCreatePopup(){this.defaultAccountId=AppData.Accounts.defaultId,this.loading=ko.observable(!1),this.friendlyName=ko.observable(""),this.email=ko.observable(""),this.incomingMailLogin=ko.observable(""),this.incomingLoginFocused=ko.observable(!1),this.incomingMailPassword=ko.observable(""),this.oIncoming=new CServerPropertiesViewModel(143,993,!1,"acc_create_incoming",Utils.i18n("SETTINGS/ACCOUNT_PROPERTIES_INCOMING_MAIL")),this.outgoingMailLogin=ko.observable(""),this.outgoingMailPassword=ko.observable(""),this.oOutgoing=new CServerPropertiesViewModel(25,465,!1,"acc_create_outgoing",Utils.i18n("SETTINGS/ACCOUNT_PROPERTIES_OUTGOING_MAIL"),this.oIncoming.server),this.useSmtpAuthentication=ko.observable(!0),this.friendlyNameFocus=ko.observable(!1),this.emailFocus=ko.observable(!1),this.incomingPasswordFocus=ko.observable(!1),this.incomingMailFocus=ko.observable(!1),this.isFirstStep=ko.observable(!0),this.isFirstTitle=ko.observable(!0),this.isConnectToMailType=ko.observable(!1),this.isFirstStep.subscribe(function(e){e||this.clearServers()},this),this.incomingLoginFocused.subscribe(function(){this.incomingLoginFocused()&&""===this.incomingMailLogin()&&this.incomingMailLogin(this.email())},this)}function CreateIdentityPopup(){this.oIdentityPropertiesViewModel=new CIdentityPropertiesViewModel(this,!0)}function FetcherAddPopup(){this.loading=ko.observable(!1),this.newFolderCreating=ko.observable(!1),this.incomingMailLogin=ko.observable(""),this.incomingMailPassword=ko.observable(""),this.oIncoming=new CServerPropertiesViewModel(110,995,!1,"fectcher_add_incoming",Utils.i18n("SETTINGS/ACCOUNT_FETCHER_POP3_SERVER")),this.folder=ko.observable(""),this.options=ko.observableArray([]),App.MailCache.folderList.subscribe(function(){this.populateOptions()},this),this.addNewFolderCommand=Utils.createCommand(this,this.onAddNewFolderClick),this.leaveMessagesOnServer=ko.observable(!1),this.loginIsSelected=ko.observable(!1),this.passwordIsSelected=ko.observable(!1),this.defaultOptionsAfterRender=Utils.defaultOptionsAfterRender}function SystemFoldersPopup(){this.folders=App.MailCache.editedFolderList,this.sentFolderFullName=ko.observable(""),this.draftsFolderFullName=ko.observable(""),this.spamFolderFullName=ko.observable(""),this.trashFolderFullName=ko.observable(""),this.options=ko.observableArray([]),this.defaultOptionsAfterRender=Utils.defaultOptionsAfterRender,this.allowSpamFolderEditing=ko.computed(function(){var e=AppData.Accounts.getEdited(),t=e.extensionExists("AllowSpamFolderExtension");return t&&!AppData.IsMailsuite},this)}function FolderCreatePopup(){this.loading=ko.observable(!1),App.MailCache.folderListLoading.subscribe(function(){var e=App.MailCache.folderListLoading.indexOf(App.MailCache.editedFolderList().iAccountId)!==-1;!e&&this.loading()&&(this.fCallback&&this.fCallback(this.folderName(),this.parentFolder()),this.loading(!1),this.closeCommand())},this),this.options=ko.observableArray([]),this.parentFolder=ko.observable(""),this.folderName=ko.observable(""),this.folderNameFocus=ko.observable(!1),this.fCallback=null,this.defaultOptionsAfterRender=Utils.defaultOptionsAfterRender}function ChangePasswordPopup(){this.currentPassword=ko.observable(""),this.newPassword=ko.observable(""),this.confirmPassword=ko.observable(""),this.isHelpdesk=ko.observable(!1),this.hasOldPassword=ko.observable(!1)}function FileStorageFolderCreatePopup(){this.fCallback=null,this.folderName=ko.observable(""),this.folderName.focus=ko.observable(!1),this.folderName.error=ko.observable(""),this.folderName.subscribe(function(){this.folderName.error("")},this)}function FileStorageLinkCreatePopup(){this.fCallback=null,this.link=ko.observable(""),this.linkPrev=ko.observable(""),this.linkFocus=ko.observable(!1),this.checkTimeout=null,this.urlChecked=ko.observable(!1),this.saveCommand=Utils.createCommand(this,this.executeSave,function(){return this.urlChecked()}),this.fileItem=ko.observable(new CCommonFileModel)}function FileStorageRenamePopup(){this.fCallback=null,this.item=null,this.name=ko.observable(""),this.name.focus=ko.observable(!1),this.name.error=ko.observable(""),this.name.subscribe(function(){this.name.error("")},this)}function FileStorageSharePopup(){this.item=null,this.pub=ko.observable(""),this.pubFocus=ko.observable(!1)}function FileStoragePopup(){this.fileStorageViewModel=new CFileStorageViewModel(!0),this.fileStorageViewModel.onSelectClickPopupBinded=_.bind(this.onSelectClick,this),this.fCallback=null}function CalendarPopup(){this.fCallback=null,this.calendarId=ko.observable(null),this.calendarName=ko.observable(""),this.calendarDescription=ko.observable(""),this.calendarNameFocus=ko.observable(!1),this.calendarDescriptionFocus=ko.observable(!1),this.colors=ko.observableArray([]),this.selectedColor=ko.observable(this.colors()[0]),this.popupTitle=ko.observable("")}function CalendarImportPopup(){this.fCallback=null,this.oJua=null,this.allowDragNDrop=ko.observable(!1),this.visibility=ko.observable(!1),this.importing=ko.observable(!1),this.color=ko.observable(""),this.calendarId=ko.observable("")}function CalendarSharePopup(){this.guestsDom=ko.observable(),this.guestsDom.subscribe(function(e){this.initInputosaurus(this.guestsDom,this.guests,this.guestsLock)},this),this.ownersDom=ko.observable(),this.ownersDom.subscribe(function(){this.initInputosaurus(this.ownersDom,this.owners,this.ownersLock)},this),this.guestsLock=ko.observable(!1),this.guests=ko.observable("").extend({reversible:!0}),this.guests.subscribe(function(){this.guestsLock()||($(this.guestsDom()).val(this.guests()),$(this.guestsDom()).inputosaurus("refresh"))},this),this.ownersLock=ko.observable(!1),this.owners=ko.observable("").extend({reversible:!0}),this.owners.subscribe(function(){this.ownersLock()||($(this.ownersDom()).val(this.owners()),$(this.ownersDom()).inputosaurus("refresh"))},this),this.defaultAccount=AppData.Accounts.getDefault(),this.fCallback=null,this.calendarId=ko.observable(null),this.selectedColor=ko.observable(""),this.calendarUrl=ko.observable(""),this.exportUrl=ko.observable(""),this.icsLink=ko.observable(""),this.isPublic=ko.observable(!1),this.shares=ko.observableArray([]),this.owner=ko.observable(""),this.recivedAnim=ko.observable(!1).extend({autoResetToFalse:500}),this.whomAnimate=ko.observable(""),this.newShare=ko.observable(""),this.newShareFocus=ko.observable(!1),this.newShareAccess=ko.observable(Enums.CalendarAccess.Read),this.sharedToAll=ko.observable(!1),this.sharedToAllAccess=ko.observable(Enums.CalendarAccess.Read),this.canAdd=ko.observable(!1),this.aAccess=[{value:Enums.CalendarAccess.Read,display:Utils.i18n("CALENDAR/CALENDAR_ACCESS_READ")},{value:Enums.CalendarAccess.Write,display:Utils.i18n("CALENDAR/CALENDAR_ACCESS_WRITE")}],this.showGlobalContacts=!!AppData.User.ShowGlobalContacts}function CalendarGetLinkPopup(){this.fCallback=null,this.calendarId=ko.observable(null),this.selectedColor=ko.observable(""),this.calendarUrl=ko.observable(""),this.exportUrl=ko.observable(""),this.icsLink=ko.observable(""),this.isPublic=ko.observable(!1),this.pubUrl=ko.observable("")}function CalendarEventPopup(){this.defaultAccount=AppData.Accounts?AppData.Accounts.getDefault():null,this.modified=!1,this.isPublic=bExtApp,this.isEditable=ko.observable(!1),this.isEditableReminders=ko.observable(!1),this.selectedCalendarIsShared=ko.observable(!1),this.selectedCalendarIsEditable=ko.observable(!1),this.callbackSave=null,this.callbackDelete=null,this.timeFormatMoment="HH:mm",this.dateFormatMoment="MM/DD/YYYY",this.dateFormatDatePicker="mm/dd/yy",this.ampmTimeFormat=ko.observable(!1),this.calendarId=ko.observable(null),this.id=ko.observable(null),this.uid=ko.observable(null),this.recurrenceId=ko.observable(null),this.allEvents=ko.observable(Enums.CalendarEditRecurrenceEvent.AllEvents),this.FCMoment=null,this.isMyEvent=ko.observable(!1),this.startDom=ko.observable(null),this.endDom=ko.observable(null),this.repeatEndDom=ko.observable(null),this.yearlyDayText=ko.observable(""),this.monthlyDayText=ko.observable(""),this.subject=ko.observable("").extend({disableLinebreaks:!0}),this.description=ko.observable(""),this.lockSelectStartEndDate=ko.observable(!1),this.startDate=ko.observable(""),this.startTime=ko.observable(""),this.startTime.subscribe(function(){this.selectStartDate()},this),this.allDay=ko.observable(!1),this.allDay.subscribe(function(e){e||this.setActualTime()},this),this.endDate=ko.observable(""),this.endTime=ko.observable(""),this.endTime.subscribe(function(){this.selectEndDate()},this),this.repeatEndDate=ko.observable(""),this.isEvOneDay=ko.observable(!0),this.isEvOneTime=ko.observable(!0),this.isRepeat=ko.observable(!1),this.location=ko.observable("").extend({disableLinebreaks:!0}),this.repeatPeriodOptions=ko.observableArray(this.getDisplayedPeriods()),this.repeatWeekIntervalOptions=ko.observableArray([1,2,3,4]),this.repeatMonthIntervalOptions=ko.observableArray(this.getDisplayedIntervals()),this.defaultAlarms=ko.observableArray([5,10,15,30,60,120,180,240,300,360,420,480,540,600,660,720,1080,1440,2880,4320,5760,10080,20160]),this.alarmOptions=ko.observableArray([]),this.timeOptions=ko.observableArray(Utils.Calendar.getTimeListStepHalfHour(AppData.User.defaultTimeFormat()!==Enums.TimeFormat.F24?"hh:mm A":"HH:mm")),AppData.User.defaultTimeFormat.subscribe(function(){this.timeOptions(Utils.Calendar.getTimeListStepHalfHour(AppData.User.defaultTimeFormat()!==Enums.TimeFormat.F24?"hh:mm A":"HH:mm"))},this),this.displayedAlarms=ko.observableArray([]),this.displayedAlarms.subscribe(function(){this.disableAlarms()},this),this.excluded=ko.observable(!1),this.repeatPeriod=ko.observable(Enums.CalendarRepeatPeriod.None),this.repeatPeriod.subscribe(function(e){this.setDayOfWeek(),this.isRepeat(!!e)},this),this.repeatInterval=ko.observable(1),this.repeatCount=ko.observable(null),this.repeatWeekNum=ko.observable(null),this.weekMO=ko.observable(!1),this.weekTU=ko.observable(!1),this.weekWE=ko.observable(!1),this.weekTH=ko.observable(!1),this.weekFR=ko.observable(!1),this.weekSA=ko.observable(!1),this.weekSU=ko.observable(!1),this.always=ko.observable(1),this.appointment=ko.observable(!1),this.attendees=ko.observableArray([]),this.attenderStatus=ko.observable(0),this.owner=ko.observable(""),this.ownerName=ko.observable(""),this.recivedAnim=ko.observable(!1).extend({autoResetToFalse:500}),this.whomAnimate=ko.observable(""),this.guestAutocompleteItem=ko.observable(null),this.guestAutocomplete=ko.observable(""),this.guestEmailFocus=ko.observable(!1),this.guestAutocomplete.subscribe(function(e){""===e&&this.guestAutocompleteItem(null)},this),this.condition=ko.observable(""),this.autosizeTrigger=ko.observable(!0),this.calendars=null,this.calendarsList=ko.observableArray([]),this.calendarColor=ko.observable(""),this.selectedCalendarId=ko.observable(""),this.selectedCalendarName=ko.observable(""),this.selectedCalendarId.subscribe(function(e){if(e){var t=this.calendars.getCalendarById(e);this.selectedCalendarName(t.name()),this.selectedCalendarIsShared(t.isShared()),this.selectedCalendarIsEditable(t.isEditable()),this.changeCalendarColor(e)}},this),this.subjectFocus=ko.observable(!1),this.descriptionFocus=ko.observable(!1),this.locationFocus=ko.observable(!1),this.dateEdit=ko.observable(!1),this.repeatEdit=ko.observable(!1),this.guestsEdit=ko.observable(!1),this.defaultOptionsAfterRender=Utils.defaultOptionsAfterRender,this.isEditForm=ko.computed(function(){return!!this.id()},this),this.callbackAttendeeActionDecline=null,this.calendarAppointments=AppData.User.AllowCalendar&&AppData.User.CalendarAppointments,this.allChanges=ko.computed(function(){this.subject(),this.description(),this.location(),this.isRepeat(),this.allDay(),this.repeatPeriod(),this.repeatInterval(),this.repeatCount(),this.repeatWeekNum(),this.startDate(),this.startTime(),this.endDate(),this.endTime(),this.repeatEndDate(),this.displayedAlarms(),this.weekMO(),this.weekTU(),this.weekWE(),this.weekTH(),this.weekFR(),this.weekSA(),this.weekSU(),this.always(),this.attendees(),this.selectedCalendarId(),this.modified=!0},this),this.phaseArray=[""],_.each(Utils.i18n("CALENDAR/REMINDER_PHRASE").split(/\s/),function(e){var t=this.phaseArray.length-1;"%"===e.substr(0,1)||"%"===this.phaseArray[t].substr(-1,1)?this.phaseArray.push(e):this.phaseArray[t]+=" "+e},this),this.isAppointmentButtonsVisible=ko.observable(!1),this.bCalendarAttachFileToEventEnabled=AppData.App.CalendarAttachFileToEventEnabled,this.bCalendarAttachFileToEventEnabled&&(this.oJua=null,this.eventUploaderButton=ko.observable(null),this.eventUploaderButton.subscribe(function(){this.initUploader()},this),this.attachName=ko.observable(""),this.attachTempName=ko.observable(""),this.attachDownloadLink=ko.observable(""),this.attachUploaded=ko.observable(!1))}function CalendarEditRecurrenceEventPopup(){this.fCallback=null,this.confirmDesc=Utils.i18n("CALENDAR/EDIT_RECURRENCE_CONFIRM_DESCRIPTION"),this.onlyThisInstanceButtonText=ko.observable(Utils.i18n("CALENDAR/ONLY_THIS_INSTANCE")),this.allEventsButtonText=ko.observable(Utils.i18n("CALENDAR/ALL_EVENTS_IN_THE_SERIES")),this.cancelButtonText=ko.observable(Utils.i18n("MAIN/BUTTON_CANCEL"))}function CalendarSelectCalendarsPopup(){this.fCallback=null,this.fProceedUploading=null,this.calendars=null,this.calendarsList=ko.observableArray([]),this.calendarColor=ko.observable(""),this.selectedCalendarName=ko.observable(""),this.selectedCalendarId=ko.observable(""),this.selectedCalendarId.subscribe(function(e){if(e){var t=this.calendars.getCalendarById(e);this.selectedCalendarName(t.name()),this.selectedCalendarIsEditable(t.isEditable()),this.changeCalendarColor(e)}},this),this.selectedCalendarIsEditable=ko.observable(!1)}function PhonePopup(){this.phone=App.Phone,this.action=this.phone.action,this.report=this.phone.report,this.text=ko.observable(""),this.callback=null}function CGenerateOpenPgpKeyPopup(){this.pgp=null,this.emails=ko.observableArray([]),this.selectedEmail=ko.observable(""),this.password=ko.observable(""),this.keyLengthOptions=[1024,2048],this.selectedKeyLength=ko.observable(1024),this.process=ko.observable(!1)}function CShowOpenPgpKeyArmorPopup(){this.allowSendEmails=ko.computed(function(){return AppData.App.AllowWebMail&&AppData.Accounts.isCurrentAllowsMail()},this),this.armor=ko.observable(""),this.htmlArmor=ko.computed(function(){return Utils.encodeHtml(this.armor().replace(/\r/g,""))},this),this.user=ko.observable(""),this.private=ko.observable(!1),this.titleText=ko.computed(function(){return this.private()?Utils.i18n("OPENPGP/POPUP_TITLE_VIEW_PRIVATE_KEY",{USER:this.user()}):Utils.i18n("OPENPGP/POPUP_TITLE_VIEW_PUBLIC_KEY",{USER:this.user()})},this),this.downloadLinkHref=ko.computed(function(){var e="#",t=null;return window.URL=window.webkitURL||window.URL,Blob&&window.URL&&Utils.isFunc(window.URL.createObjectURL)&&(t=new Blob([this.armor()],{type:"text/plain"}),e=window.URL.createObjectURL(t)),e},this),this.downloadLinkFilename=ko.computed(function(){var e=this.user().replace(/</g,"").replace(/>/g,""),t=this.private()?"OPENPGP/PRIVATE_KEY_FILENAME":"OPENPGP/PUBLIC_KEY_FILENAME";return Utils.i18n(t,{USER:e})+".asc"},this),this.domKey=ko.observable(null)}function CImportOpenPgpKeyPopup(){this.pgp=null,this.keyArmor=ko.observable(""),this.keyArmorFocused=ko.observable(!1),this.keys=ko.observableArray([]),this.hasExistingKeys=ko.observable(!1),this.headlineText=ko.computed(function(){return Utils.i18n("OPENPGP/INFO_TEXT_INCLUDES_KEYS_PLURAL",{},null,this.keys().length)},this)}function COpenPgpEncryptPopup(){this.data=ko.observable(""),this.fromEmail=ko.observable(""),this.emails=ko.observableArray([]),this.okCallback=null,this.cancelCallback=null,this.sign=ko.observable(!0),this.password=ko.observable(""),this.passwordFocused=ko.observable(!1),this.encrypt=ko.observable(!0),this.signEncryptButtonText=ko.computed(function(){var e=Utils.i18n("OPENPGP/BUTTON_SIGN_ENCRYPT");return this.sign()&&!this.encrypt()&&(e=Utils.i18n("OPENPGP/BUTTON_SIGN")),!this.sign()&&this.encrypt()&&(e=Utils.i18n("OPENPGP/BUTTON_ENCRYPT")),e},this),this.isEnableSignEncrypt=ko.computed(function(){return this.sign()||this.encrypt()},this),this.signEncryptCommand=Utils.createCommand(this,this.executeSignEncrypt,this.isEnableSignEncrypt),this.signAndSend=ko.observable(!1)}function ContactCreatePopup(){this.displayName=ko.observable(""),this.email=ko.observable(""),this.phone=ko.observable(""),this.address=ko.observable(""),this.skype=ko.observable(""),this.facebook=ko.observable(""),this.focusDisplayName=ko.observable(!1),this.loading=ko.observable(!1),this.fCallback=null,this.oContext=null}function PlayerPopup(){this.iframe=ko.observable("")}function CAppSettingsModel(e){this.AllowWebMail=!0,this.AllowUsersChangeInterfaceSettings=!0,this.AllowUsersChangeEmailSettings=!0,this.AllowUsersAddNewAccounts=!0,this.SiteName="",this.Languages=[{name:"English",value:"en"}],this.Themes=["Default"],this.DateFormats=[],this.DefaultLanguage="English",this.AttachmentSizeLimit=1024e4,this.ImageUploadSizeLimit=1024e4,this.FileSizeLimit=1024e4,this.AutoSave=!0,this.AutoSaveIntervalSeconds=60,this.IdleSessionTimeout=0,this.AllowInsertImage=!0,this.AllowBodySize=!1,this.MaxBodySize=600,this.MaxSubjectSize=255,this.JoinReplyPrefixes=!0,this.AllowTemplateFolders=[],this.AllowSaveAttachmentToServer=!1,this.AllowAppRegisterMailto=!0,this.AllowPrefetch=!0,this.MaxPrefetchBodiesSize=5e4,this.LoginFormType=Enums.LoginFormType.Email,this.LoginAtDomainValue="",this.AllowRegistration=!1,this.AllowPasswordReset=!1,this.RegistrationDomains=[],this.RegistrationQuestions=[],this.DemoWebMail=!0,this.DemoWebMailLogin="",this.DemoWebMailPassword="",this.LoginDescription="",this.GoogleAnalyticsAccount="",this.ShowQuotaBar=!1,this.ServerUseUrlRewrite=!1,this.AllowLanguageOnLogin=!1,this.FlagsLangSelect=!1,this.CustomLoginUrl="",this.CustomLogoutUrl="",this.IosDetectOnLogin=!1,this.AllowContactsSharing=!1,this.DefaultLanguageShort="en",this.AllowOpenPgp=e,this.DefaultTab="",this.AllowIosProfile=!0,this.PasswordMinLength=0,this.PasswordMustBeComplex=!1,this.AllowComposeShortcuts=!0,this.SettingsFilesAppsEnabled=!0,this.SettingsMobilesyncAppsEnabled=!0,this.CalendarAttachFileToEventEnabled=!1,this.CalendarNotificationEnabled=!1,this.HideLogout=!1}function CUserSettingsModel(){this.IdUser=1,this.MailsPerPage=20,this.ContactsPerPage=20,this.iInterval=-1,this.AutoCheckMailInterval=0,this.DefaultTheme="Default",this.DefaultLanguage="English",this.DefaultLanguageShort="en",this.DefaultDateFormat="MM/DD/YYYY",this.defaultTimeFormat=ko.observable(Enums.TimeFormat.F24),this.ThreadsEnabled=!0,this.useThreads=ko.observable(!0),this.SaveRepliedToCurrFolder=!0,this.AllowChangeInputDirection=!1,this.DesktopNotifications=!1,this.EmailNotification="",this.AllowCompose=!0,this.AllowReply=!0,this.AllowForward=!0,this.SaveMail=Enums.SaveMail.Checked,this.AllowFetcher=!1,this.OutlookSyncEnable=!0,this.MobileSyncEnable=!0,this.ShowPersonalContacts=!0,this.ShowGlobalContacts=!1,this.IsFilesSupported=!1,this.IsHelpdeskSupported=!1,this.IsHelpdeskAgent=!1,this.HelpdeskIframeUrl="",this.ShowContacts=this.ShowPersonalContacts||this.ShowGlobalContacts,this.LastLogin=0,this.LoginsCount=0,this.SocialName=0,this.IsDemo=!1,this.AllowVoice=!1,this.SipRealm="",this.SipWebsocketProxyUrl="",this.SipOutboundProxyUrl="",this.SipCallerID="",this.SipImpi="",this.SipImpu="",this.SipPassword="",this.VoiceProvider="",this.AllowCalendar=!0,this.CalendarSharing=!1,this.CalendarAppointments=!1,this.CalendarShowWeekEnds=!1,this.CalendarShowWorkDay=!1,this.CalendarWorkDayStarts=0,this.CalendarWorkDayEnds=0,this.CalendarWeekStartsOn=0,this.CalendarDefaultTab=Enums.CalendarDefaultTab.Month,this.mobileSync=ko.observable(null),this.MobileSyncDemoPass="demo",this.outlookSync=ko.observable(null),this.OutlookSyncDemoPass="demo",this.AllowHelpdeskNotifications=!1,this.IsCollaborationSupported=!1,this.AllowFilesSharing=!1,this.DefaultFontName="Tahoma",this.fillDefaultFontName(),this.DefaultFontSize=3,this.fillDefaultFontSize(),this.enableOpenPgp=ko.observable(!1),this.AllowAutosaveInDrafts=!0,this.AutosignOutgoingEmails=!1,this.filesEnable=ko.observable(!0),this.helpdeskSignature=ko.observable(""),this.helpdeskSignatureEnable=ko.observable(!1),this.SocialAccounts=ko.observableArray([]),this.CanLoginWithPassword=!0}function CAccountModel(){this.id=ko.observable(0),this.email=ko.observable(""),this.allowMail=ko.observable(!0),this.passwordSpecified=ko.observable(!0),this.extensions=ko.observableArray([]),this.fetchers=ko.observable(null),this.identities=ko.observable(null),this.friendlyName=ko.observable(""),this.incomingMailLogin=ko.observable(""),this.incomingMailServer=ko.observable(""),this.incomingMailPort=ko.observable(143),this.incomingMailSsl=ko.observable(!1),this.isInternal=ko.observable(!1),this.isLinked=ko.observable(!1),this.isDefault=ko.observable(!1),this.outgoingMailAuth=ko.observable(0),this.outgoingMailLogin=ko.observable(""),this.outgoingMailServer=ko.observable(""),this.outgoingMailPort=ko.observable(25),this.outgoingMailSsl=ko.observable(!1),this.isExtended=ko.observable(!1),this.signature=ko.observable(null),this.autoresponder=ko.observable(null),this.forward=ko.observable(null),this.filters=ko.observable(null),this.quota=ko.observable(0),this.usedSpace=ko.observable(0),this.quotaRecieved=ko.observable(!1),this.fullEmail=ko.computed(function(){return Utils.Address.getFullEmail(this.friendlyName(),this.email())},this),this.isCurrent=ko.observable(!1),this.isEdited=ko.observable(!1),this.extensionsRequested=ko.observable(!1),this.canBeRemoved=ko.computed(function(){return!this.isInternal()&&(!this.isDefault()||this.isDefault()&&AppData.App.AllowUsersChangeEmailSettings)},this),this.removeHint=ko.computed(function(){var e="",t="";return this.isDefault()?(AppData.User.AllowCalendar&&AppData.User.ShowContacts?e=Utils.i18n("SETTINGS/ACCOUNTS_REMOVE_CONTACTS_CALENDARS_HINT"):AppData.User.AllowCalendar?e=Utils.i18n("SETTINGS/ACCOUNTS_REMOVE_CALENDARS_HINT"):AppData.User.ShowContacts&&(e=Utils.i18n("SETTINGS/ACCOUNTS_REMOVE_CONTACTS_HINT")),t=Utils.i18n("SETTINGS/ACCOUNTS_REMOVE_DEFAULT_HINT",{AND_OTHER:e}),AppData.Accounts.collection().length>1&&(t+=Utils.i18n("SETTINGS/ACCOUNTS_REMOVE_DEFAULT_NOTSINGLE_HINT"))):t=Utils.i18n("SETTINGS/ACCOUNTS_REMOVE_HINT"),t},this),this.removeConfirmation=ko.computed(function(){return this.isDefault()?this.removeHint()+Utils.i18n("SETTINGS/ACCOUNTS_REMOVE_DEFAULT_CONFIRMATION"):Utils.i18n("SETTINGS/ACCOUNTS_REMOVE_CONFIRMATION")},this)}function CAccountListModel(){this.defaultId=ko.observable(0),this.currentId=ko.observable(0),this.editedId=ko.observable(0),this.isCurrentAllowsMail=ko.observable(!0),this.bLockEditedWhenCurrentChange=!0,this.currentId.subscribe(function(e){var t=this.getCurrent();t.requestExtensions(),this.checkIfMailAllowed(),this.bLockEditedWhenCurrentChange||_.delay(_.bind(function(){this.editedId(e)},this),1e3)},this),this.collection=ko.observableArray([])}function CAddressModel(){this.sName="",this.sEmail="",this.sDisplay="",this.sFull="",this.loaded=ko.observable(!1),this.found=ko.observable(!1)}function CAddressListModel(){this.aCollection=[]}function CDateModel(){this.iTimeStampInUTC=0,this.oMoment=null}function CIdentityModel(){this.loyal=ko.observable(!1),this.isDefault=ko.observable(!1),this.enabled=ko.observable(!0),this.email=ko.observable(""),this.friendlyName=ko.observable(""),this.fullEmail=ko.computed(function(){return Utils.Address.getFullEmail(this.friendlyName(),this.email())},this),this.accountId=ko.observable(-1),this.id=ko.observable(-1),this.signature=ko.observable(""),this.useSignature=ko.observable(!1)}function CCommonFileModel(){this.isIosDevice=bIsIosDevice,this.isFolder=ko.observable(!1),this.isLink=ko.observable(!1),
this.linkType=ko.observable(Enums.FileStorageLinkType.Unknown),this.linkUrl=ko.observable(""),this.isPopupItem=ko.observable(!1),this.id=ko.observable(""),this.fileName=ko.observable(""),this.tempName=ko.observable(""),this.displayName=ko.observable(""),this.extension=ko.observable(""),this.oembed=ko.observable(""),this.linkType.subscribe(function(e){var t="";switch(e){case Enums.FileStorageLinkType.YouTube:t="YouTube";break;case Enums.FileStorageLinkType.Vimeo:App.browser.ie&&!App.browser.ie11||(t="Vimeo");break;case Enums.FileStorageLinkType.SoundCloud:App.browser.ie&&!App.browser.ie10AndAbove||(t="SoundCloud")}this.oembed(t)},this),this.fileName.subscribe(function(e){this.id(e),this.displayName(e),this.extension(this.isFolder()?"":Utils.getFileExtension(e))},this),this.size=ko.observable(0),this.friendlySize=ko.computed(function(){return this.size()>0?Utils.friendlySize(this.size()):""},this),this.content=ko.observable(""),this.accountId=ko.observable(AppData.Accounts?AppData.Accounts.defaultId():null),this.hash=ko.observable(""),this.thumb=ko.observable(!1),this.iframedView=ko.observable(!1),this.downloadLink=ko.computed(function(){return Utils.getDownloadLinkByHash(this.accountId(),this.hash())},this),this.viewLink=ko.computed(function(){var e=Utils.File.getViewLinkByHash(this.accountId(),this.hash());return this.iframedView()?Utils.getIframeWrappwer(this.accountId(),e):e},this),this.thumbnailSrc=ko.observable(""),this.thumbnailLoaded=ko.observable(!1),this.thumbnailSessionUid=ko.observable(""),this.thumbnailLink=ko.computed(function(){return this.thumb()?Utils.getViewThumbnailLinkByHash(this.accountId(),this.hash()):""},this),this.type=ko.observable(""),this.uploadUid=ko.observable(""),this.uploaded=ko.observable(!1),this.uploadError=ko.observable(!1),this.visibleImportLink=ko.computed(function(){return AppData.User.enableOpenPgp()&&"asc"===this.extension().toLowerCase()&&""!==this.content()&&!this.isPopupItem()},this),this.isViewMimeType=ko.computed(function(){return-1!==$.inArray(this.type(),aViewMimeTypes)||this.iframedView()},this),this.isMessageType=ko.observable(!1),this.visibleViewLink=ko.computed(function(){return this.isVisibleViewLink()&&!this.isPopupItem()},this),this.visibleOpenLink=ko.computed(function(){return""!==this.linkUrl()},this),this.visibleDownloadLink=ko.computed(function(){return!this.isPopupItem()&&!this.visibleOpenLink()},this),this.visibleSaveToServerLink=ko.observable(!1),this.subFiles=ko.observableArray([]),this.allowExpandSubFiles=ko.observable(!1),this.subFilesLoaded=ko.observable(!1),this.subFilesCollapsed=ko.observable(!1),this.subFilesStartedLoading=ko.observable(!1),this.visibleExpandLink=ko.computed(function(){return this.allowExpandSubFiles()&&!this.subFilesCollapsed()&&!this.subFilesStartedLoading()},this),this.visibleExpandingText=ko.computed(function(){return this.allowExpandSubFiles()&&!this.subFilesCollapsed()&&this.subFilesStartedLoading()},this),this.visibleSpinner=ko.observable(!1),this.statusText=ko.observable(""),this.statusTooltip=ko.computed(function(){return this.uploadError()?this.statusText():""},this),this.progressPercent=ko.observable(0),this.visibleProgress=ko.observable(!1),this.uploadStarted=ko.observable(!1),this.uploadStarted.subscribe(function(){this.uploadStarted()?(this.uploaded(!1),this.visibleProgress(!0),this.progressPercent(20)):(this.progressPercent(100),this.visibleProgress(!1),this.uploaded(!0))},this),this.allowDrag=ko.observable(!1),this.allowSelect=ko.observable(!1),this.allowCheck=ko.observable(!1),this.allowDelete=ko.observable(!1),this.allowUpload=ko.observable(!1),this.allowSharing=ko.observable(!1),this.allowHeader=ko.observable(!1),this.allowDownload=ko.observable(!0),this.downloadTitle=ko.computed(function(){var e="";return!this.allowSelect()&&this.allowDownload()&&(e=Utils.i18n("MESSAGE/ATTACHMENT_CLICK_TO_DOWNLOAD",{FILENAME:this.fileName(),SIZE:this.friendlySize()}),""===this.friendlySize()&&(e=e.replace(" ()",""))),e},this),this.oembedHtml=ko.observable("")}function CMailAttachmentModel(){this.folderName=ko.observable(""),this.messageUid=ko.observable(""),this.cid=ko.observable(""),this.contentLocation=ko.observable(""),this.inline=ko.observable(!1),this.linked=ko.observable(!1),this.mimePartIndex=ko.observable(""),this.messagePart=ko.observable(null),CCommonFileModel.call(this),this.visibleSaveToServerLink=ko.computed(function(){return AppData.App.AllowSaveAttachmentToServer&&""!==this.messageUid()},this),this.savingToServer=ko.observable(!1),this.saveToServerText=ko.computed(function(){return this.savingToServer()?Utils.i18n("SETTINGS/BUTTON_SAVING"):Utils.i18n("MESSAGE/ATTACHMENT_SAVE_TO_SERVER")},this),this.isMessageType=ko.computed(function(){return this.type(),this.mimePartIndex(),"message/rfc822"===this.type()&&""!==this.mimePartIndex()},this)}function CFolderModel(e){this.iAccountId=e,this.bNamespace=!1,this.iLevel=0,this.sDelimiter="",this.bExists=!0,this.sUidNext="",this.sHash="",this.messageCount=ko.observable(0),this.unseenMessageCount=ko.observable(0),this.sRealUnseenMessageCount=0,this.hasExtendedInfo=ko.observable(!1),this.fullName=ko.observable(""),this.fullNameHash=ko.observable(""),this.bSelectable=!0,this.subscribed=ko.observable(!0),this.isTemplateStorage=ko.observable(!1),this.name=ko.observable(""),this.nameForEdit=ko.observable(""),this.subfolders=ko.observableArray([]),this.subfoldersMessagesCount=ko.observable(0),this.type=ko.observable(Enums.FolderTypes.User),this.bVirtual=!1,this.selected=ko.observable(!1),this.expanded=ko.observable(!1),this.recivedAnim=ko.observable(!1).extend({autoResetToFalse:500}),this.edited=ko.observable(!1),this.oMessages={},this.oUids={},this.aResponseHandlers=[],this.aRequestedUids=[],this.aRequestedThreadUids=[],this.requestedLists=[],this.hasChanges=ko.observable(!1),this.relevantInformationLastMoment=null}function CFolderListModel(){this.iAccountId=0,this.bInitialized=ko.observable(!1),this.expandFolders=ko.observable(!1),this.expandNames=ko.observableArray([]),this.collection=ko.observableArray([]),this.options=ko.observableArray([]),this.sNamespaceFolder="",this.oStarredFolder=null,this.oNamedCollection={},this.aLinedCollection=[];var e=this,t=function(e){return function(t){t&&t.type(e)}},i=function(t){return{read:function(){return this.collection(),t()?t().fullName():""},write:function(e){t(this.getFolderByFullName(e))},owner:e}};this.currentFolder=ko.observable(null),this.inboxFolder=ko.observable(null),this.sentFolder=ko.observable(null),this.draftsFolder=ko.observable(null),this.spamFolder=ko.observable(null),this.trashFolder=ko.observable(null),this.aTemplateFolders=[],this.countsCompletelyFilled=ko.observable(!1),this.inboxFolder.subscribe(t(Enums.FolderTypes.User),this,"beforeChange"),this.sentFolder.subscribe(t(Enums.FolderTypes.User),this,"beforeChange"),this.draftsFolder.subscribe(t(Enums.FolderTypes.User),this,"beforeChange"),this.spamFolder.subscribe(t(Enums.FolderTypes.User),this,"beforeChange"),this.trashFolder.subscribe(t(Enums.FolderTypes.User),this,"beforeChange"),this.inboxFolder.subscribe(t(Enums.FolderTypes.Inbox)),this.sentFolder.subscribe(t(Enums.FolderTypes.Sent)),this.draftsFolder.subscribe(t(Enums.FolderTypes.Drafts)),this.spamFolder.subscribe(t(Enums.FolderTypes.Spam)),this.trashFolder.subscribe(t(Enums.FolderTypes.Trash)),this.inboxFolderFullName=ko.computed(i(this.inboxFolder)),this.sentFolderFullName=ko.computed(i(this.sentFolder)),this.draftsFolderFullName=ko.computed(i(this.draftsFolder)),this.spamFolderFullName=ko.computed(i(this.spamFolder)),this.trashFolderFullName=ko.computed(i(this.trashFolder)),this.currentFolderFullName=ko.computed(i(this.currentFolder)),this.currentFolderType=ko.computed(function(){return this.currentFolder()?this.currentFolder().type():Enums.FolderTypes.User},this),this.sDelimiter=""}function CMessageModel(){this.accountId=ko.observable(AppData.Accounts.currentId()),this.folder=ko.observable(""),this.uid=ko.observable(""),this.subject=ko.observable(""),this.emptySubject=ko.computed(function(){return""===Utils.trim(this.subject())},this),this.subjectForDisplay=ko.computed(function(){return this.emptySubject()?Utils.i18n("MAILBOX/EMPTY_SUBJECT"):this.subject()},this),this.messageId=ko.observable(""),this.size=ko.observable(0),this.friendlySize=ko.computed(function(){return Utils.friendlySize(this.size())},this),this.textSize=ko.observable(0),this.oDateModel=new CDateModel,this.fullDate=ko.observable(""),this.oFrom=new CAddressListModel,this.fullFrom=ko.observable(""),this.oTo=new CAddressListModel,this.to=ko.observable(""),this.fromOrToText=ko.observable(""),this.oCc=new CAddressListModel,this.cc=ko.observable(""),this.oBcc=new CAddressListModel,this.bcc=ko.observable(""),this.oSender=new CAddressListModel,this.oReplyTo=new CAddressListModel,this.seen=ko.observable(!1),this.flagged=ko.observable(!1),this.partialFlagged=ko.observable(!1),this.answered=ko.observable(!1),this.forwarded=ko.observable(!1),this.hasAttachments=ko.observable(!1),this.hasIcalAttachment=ko.observable(!1),this.hasVcardAttachment=ko.observable(!1),this.showCalendarIcon=ko.computed(function(){return AppData.User.AllowCalendar&&this.hasIcalAttachment()},this),this.folderObject=ko.computed(function(){return App.MailCache.getFolderByFullName(this.accountId(),this.folder())},this),this.threadsAllowed=ko.computed(function(){var e=this.folderObject(),t=e&&(e.type()===Enums.FolderTypes.Drafts||e.type()===Enums.FolderTypes.Spam||e.type()===Enums.FolderTypes.Trash);return AppData.User.useThreads()&&!t},this),this.otherSendersAllowed=ko.computed(function(){var e=this.folderObject();return e&&e.type()!==Enums.FolderTypes.Drafts&&e.type()!==Enums.FolderTypes.Sent},this),this.threadPart=ko.observable(!1),this.threadPart.subscribe(function(){this.threadPart()&&(this.partialFlagged(!1),this.threadSenders(!1))},this),this.threadParentUid=ko.observable(""),this.threadUids=ko.observableArray([]),this.threadSenders=ko.observableArray([]),this.threadMoreSendersText=ko.observable(""),this.threadSendersText=ko.computed(function(){if(this.otherSendersAllowed()){var e=this.threadSenders();if(e.length>3)return this.threadMoreSendersText(Utils.i18n("MAILBOX/THREAD_MORE_SENDERS",{COUNT:e.length-1})),", "+e[0];if(this.threadMoreSendersText(""),e.length>0)return e.unshift(""),e.join(", ")}return""},this),this.threadSendersVisible=ko.computed(function(){return this.threadSendersText().length>0},this),this.threadMoreSendersVisible=ko.computed(function(){return this.threadMoreSendersText().length>0},this),this.threadCount=ko.computed(function(){return this.threadUids().length},this),this.threadUnreadCount=ko.observable(0),this.threadOpened=ko.observable(!1),this.threadLoading=ko.observable(!1),this.threadLoadingVisible=ko.computed(function(){return this.threadsAllowed()&&this.threadOpened()&&this.threadLoading()},this),this.threadCountVisible=ko.computed(function(){return this.threadsAllowed()&&this.threadCount()>0&&!this.threadLoading()},this),this.threadCountHint=ko.computed(function(){return this.threadCount()>0?this.threadOpened()?Utils.i18n("MAILBOX/THREAD_TOOLTIP_FOLD"):this.threadUnreadCount()>0?Utils.i18n("MAILBOX/THREAD_TOOLTIP_HAS_UNSEEN_PLURAL",{},null,this.threadUnreadCount()):Utils.i18n("MAILBOX/THREAD_TOOLTIP_UNFOLD"):""},this),this.threadCountForLoad=ko.observable(5),this.threadNextLoadingVisible=ko.observable(!1),this.threadNextLoadingLinkVisible=ko.observable(!1),this.threadFunctionLoadNext=null,this.threadShowAnimation=ko.observable(!1),this.threadHideAnimation=ko.observable(!1),this.importance=ko.observable(Enums.Importance.Normal),this.draftInfo=ko.observableArray([]),this.sensitivity=ko.observable(Enums.Sensitivity.Nothing),this.hash=ko.observable(""),this.downloadLink=ko.computed(function(){return this.hash().length>0?Utils.getDownloadLinkByHash(this.accountId(),this.hash()):""},this),this.completelyFilled=ko.observable(!1),this.checked=ko.observable(!1),this.checked.subscribe(function(e){if(!this.threadOpened()&&App.MailCache.useThreadsInCurrentList()){var t=App.MailCache.folderList().getFolderByFullName(this.folder());_.each(this.threadUids(),function(i){var s=t.oMessages[i];s&&s.checked(e)})}},this),this.selected=ko.observable(!1),this.deleted=ko.observable(!1),this.trimmed=ko.observable(!1),this.trimmedTextSize=ko.observable(0),this.inReplyTo=ko.observable(""),this.references=ko.observable(""),this.readingConfirmation=ko.observable(""),this.isPlain=ko.observable(!1),this.text=ko.observable(""),this.textBodyForNewWindow=ko.observable(""),this.$text=null,this.rtl=ko.observable(!1),this.hasExternals=ko.observable(!1),this.isExternalsShown=ko.observable(!1),this.isExternalsAlwaysShown=ko.observable(!1),this.foundCids=ko.observableArray([]),this.attachments=ko.observableArray([]),this.usesAttachmentString=!1,this.allAttachmentsHash="",this.safety=ko.observable(!1),this.sourceHeaders=ko.observable(""),this.date=ko.observable(""),this.ical=ko.observable(null),this.vcard=ko.observable(null),this.textRaw=ko.observable(""),this.encryptedMessage=ko.observable(!1),this.signedMessage=ko.observable(!1),this.domMessageForPrint=ko.observable(null),this.Custom={}}function CUidListModel(){this.resultCount=ko.observable(-1),this.search=ko.observable(""),this.filters=ko.observable(""),this.collection=ko.observableArray([]),this.threadUids={}}function CIcalModel(){this.uid=ko.observable(""),this.lastModification=ko.observable(!0),this.sSequence=1,this.file=ko.observable(""),this.attendee=ko.observable(""),this.type=ko.observable(""),this.icalType=ko.observable(""),this.icalConfig=ko.observable(""),this.type.subscribe(function(){var e=this.type().split("-"),t=e.shift(),i=_.find(Enums.IcalType,function(e){return t===e},this),s=e.join("-"),o=_.find(Enums.IcalConfig,function(e){return s===e},this);t!==i&&(t=Enums.IcalType.Save),this.icalType(t),s!==o&&(s=Enums.IcalConfig.NeedsAction),this.icalConfig(s),this.fillDecisions()},this),this.isRequestType=ko.computed(function(){return this.icalType()===Enums.IcalType.Request},this),this.isCancelType=ko.computed(function(){return this.icalType()===Enums.IcalType.Cancel},this),this.cancelDecision=ko.observable(""),this.isReplyType=ko.computed(function(){return this.icalType()===Enums.IcalType.Reply},this),this.replyDecision=ko.observable(""),this.isSaveType=ko.computed(function(){return this.icalType()===Enums.IcalType.Save},this),this.isJustSaved=ko.observable(!1),this.isAccepted=ko.computed(function(){return this.icalConfig()===Enums.IcalConfig.Accepted},this),this.isDeclined=ko.computed(function(){return this.icalConfig()===Enums.IcalConfig.Declined},this),this.isTentative=ko.computed(function(){return this.icalConfig()===Enums.IcalConfig.Tentative},this),this.location=ko.observable(""),this.description=ko.observable(""),this.when=ko.observable(""),this.calendarId=ko.observable(""),this.calendars=ko.observableArray([]),AppData.SingleMode&&window.opener&&window.opener.App?(this.calendars(window.opener.App.CalendarCache.calendars()),window.opener.App.CalendarCache.calendars.subscribe(function(){this.calendars(window.opener.App.CalendarCache.calendars())},this)):(this.calendars(App.CalendarCache.calendars()),App.CalendarCache.calendars.subscribe(function(){this.calendars(App.CalendarCache.calendars())},this)),this.selectedCalendarId=ko.observable(""),this.chosenCalendarName=ko.computed(function(){var e=null;return""!==this.calendarId()&&(e=_.find(this.calendars(),function(e){return e.id===this.calendarId()},this)),e?e.name:""},this),this.calendarIsChosen=ko.computed(function(){return""!==this.chosenCalendarName()},this),this.visibleCalendarDropdown=ko.computed(function(){return!this.calendarIsChosen()&&this.calendars().length>1&&(this.isRequestType()||this.isSaveType())},this),this.visibleCalendarName=ko.computed(function(){return this.calendarIsChosen()},this),this.visibleFirstCalendarName=ko.computed(function(){return 1===this.calendars().length&&!this.calendarIsChosen()},this),this.visibleCalendarRow=ko.computed(function(){return""!==this.attendee()&&(this.visibleCalendarDropdown()||this.visibleCalendarName()||this.visibleFirstCalendarName())},this),this.visibleRequestButtons=ko.computed(function(){return this.isRequestType()&&""!==this.attendee()},this),this.animation=ko.observable(!1)}function CVcardModel(){this.uid=ko.observable(""),this.file=ko.observable(""),this.name=ko.observable(""),this.email=ko.observable(""),this.exists=ko.observable(!1),this.isJustSaved=ko.observable(!1)}function CContactModel(){this.allowSendEmails=ko.computed(function(){return AppData.App.AllowWebMail&&AppData.Accounts.isCurrentAllowsMail()},this),this.sEmailDefaultType=Enums.ContactEmailType.Personal,this.sPhoneDefaultType=Enums.ContactPhoneType.Mobile,this.sAddressDefaultType=Enums.ContactAddressType.Personal,this.voiceApp=null,App.Phone&&(this.voiceApp=App.Phone.voiceApp),this.idContact=ko.observable(""),this.idUser=ko.observable(""),this.global=ko.observable(!1),this.itsMe=ko.observable(!1),this.isNew=ko.observable(!1),this.readOnly=ko.observable(!1),this.edited=ko.observable(!1),this.extented=ko.observable(!1),this.personalCollapsed=ko.observable(!1),this.businessCollapsed=ko.observable(!1),this.otherCollapsed=ko.observable(!1),this.groupsCollapsed=ko.observable(!1),this.displayName=ko.observable(""),this.firstName=ko.observable(""),this.lastName=ko.observable(""),this.nickName=ko.observable(""),this.skype=ko.observable(""),this.facebook=ko.observable(""),this.displayNameFocused=ko.observable(!1),this.primaryEmail=ko.observable(this.sEmailDefaultType),this.primaryPhone=ko.observable(this.sPhoneDefaultType),this.primaryAddress=ko.observable(this.sAddressDefaultType),this.mainPrimaryEmail=ko.computed({read:this.primaryEmail,write:function(e){!Utils.isUnd(e)&&0<=Utils.inArray(e,[Enums.ContactEmailType.Personal,Enums.ContactEmailType.Business,Enums.ContactEmailType.Other])?this.primaryEmail(e):this.primaryEmail(Enums.ContactEmailType.Personal)},owner:this}),this.mainPrimaryPhone=ko.computed({read:this.primaryPhone,write:function(e){!Utils.isUnd(e)&&0<=Utils.inArray(e,[Enums.ContactPhoneType.Mobile,Enums.ContactPhoneType.Personal,Enums.ContactPhoneType.Business])?this.primaryPhone(e):this.primaryPhone(Enums.ContactPhoneType.Mobile)},owner:this}),this.mainPrimaryAddress=ko.computed({read:this.primaryAddress,write:function(e){!Utils.isUnd(e)&&0<=Utils.inArray(e,[Enums.ContactAddressType.Personal,Enums.ContactAddressType.Business])?this.primaryAddress(e):this.primaryAddress(Enums.ContactAddressType.Personal)},owner:this}),this.personalEmail=ko.observable(""),this.personalStreetAddress=ko.observable(""),this.personalCity=ko.observable(""),this.personalState=ko.observable(""),this.personalZipCode=ko.observable(""),this.personalCountry=ko.observable(""),this.personalWeb=ko.observable(""),this.personalFax=ko.observable(""),this.personalPhone=ko.observable(""),this.personalMobile=ko.observable(""),this.businessEmail=ko.observable(""),this.businessCompany=ko.observable(""),this.businessDepartment=ko.observable(""),this.businessJob=ko.observable(""),this.businessOffice=ko.observable(""),this.businessStreetAddress=ko.observable(""),this.businessCity=ko.observable(""),this.businessState=ko.observable(""),this.businessZipCode=ko.observable(""),this.businessCountry=ko.observable(""),this.businessWeb=ko.observable(""),this.businessFax=ko.observable(""),this.businessPhone=ko.observable(""),this.otherEmail=ko.observable(""),this.otherBirthdayMonth=ko.observable("0"),this.otherBirthdayDay=ko.observable("0"),this.otherBirthdayYear=ko.observable("0"),this.otherNotes=ko.observable(""),this.etag=ko.observable(""),this.sharedToAll=ko.observable(!1),this.birthdayIsEmpty=ko.computed(function(){var e="0"===this.otherBirthdayMonth(),t="0"===this.otherBirthdayDay(),i="0"===this.otherBirthdayYear();return e||t||i},this),this.otherBirthday=ko.computed(function(){var e="",t=Utils.pInt(this.otherBirthdayYear()),i=Utils.pInt(this.otherBirthdayMonth()),s=Utils.pInt(this.otherBirthdayDay()),o=new CDateModel;if(!this.birthdayIsEmpty()){var n=moment().diff(moment(t+"/"+i+"/"+s,"YYYY/MM/DD"),"years"),a=Utils.i18n("CONTACTS/YEARS_TEXT_PLURAL",{COUNT:n},null,n);o.setDate(t,0<i?i-1:0,s),e=o.getShortDate()+" ("+a+")"}return e},this),this.groups=ko.observableArray([]),this.groupsIsEmpty=ko.computed(function(){return 0===this.groups().length},this),this.email=ko.computed({read:function(){var e="";switch(this.primaryEmail()){case Enums.ContactEmailType.Personal:e=this.personalEmail();break;case Enums.ContactEmailType.Business:e=this.businessEmail();break;case Enums.ContactEmailType.Other:e=this.otherEmail()}return e},write:function(e){switch(this.primaryEmail()){case Enums.ContactEmailType.Personal:this.personalEmail(e);break;case Enums.ContactEmailType.Business:this.businessEmail(e);break;case Enums.ContactEmailType.Other:this.otherEmail(e);break;default:this.primaryEmail(this.sEmailDefaultType),this.email(e)}},owner:this}),this.personalIsEmpty=ko.computed(function(){var e=this.personalEmail()!==this.email()?this.personalEmail():"";return""==""+e+this.personalStreetAddress()+this.personalCity()+this.personalState()+this.personalZipCode()+this.personalCountry()+this.personalWeb()+this.personalFax()+this.personalPhone()+this.personalMobile()},this),this.businessIsEmpty=ko.computed(function(){var e=this.businessEmail()!==this.email()?this.businessEmail():"";return""==""+e+this.businessCompany()+this.businessDepartment()+this.businessJob()+this.businessOffice()+this.businessStreetAddress()+this.businessCity()+this.businessState()+this.businessZipCode()+this.businessCountry()+this.businessWeb()+this.businessFax()+this.businessPhone()},this),this.otherIsEmpty=ko.computed(function(){var e=this.otherEmail()!==this.email()?this.otherEmail():"";return""==""+e+this.otherNotes()&&this.birthdayIsEmpty()},this),this.phone=ko.computed({read:function(){var e="";switch(this.primaryPhone()){case Enums.ContactPhoneType.Mobile:e=this.personalMobile();break;case Enums.ContactPhoneType.Personal:e=this.personalPhone();break;case Enums.ContactPhoneType.Business:e=this.businessPhone()}return e},write:function(e){switch(this.primaryPhone()){case Enums.ContactPhoneType.Mobile:this.personalMobile(e);break;case Enums.ContactPhoneType.Personal:this.personalPhone(e);break;case Enums.ContactPhoneType.Business:this.businessPhone(e);break;default:this.primaryPhone(this.sEmailDefaultType),this.phone(e)}},owner:this}),this.address=ko.computed({read:function(){var e="";switch(this.primaryAddress()){case Enums.ContactAddressType.Personal:e=this.personalStreetAddress();break;case Enums.ContactAddressType.Business:e=this.businessStreetAddress()}return e},write:function(e){switch(this.primaryAddress()){case Enums.ContactAddressType.Personal:this.personalStreetAddress(e);break;case Enums.ContactAddressType.Business:this.businessStreetAddress(e);break;default:this.primaryAddress(this.sEmailDefaultType),this.address(e)}},owner:this}),this.emails=ko.computed(function(){var e=[];return""!==this.personalEmail()&&e.push({text:Utils.i18n("CONTACTS/OPTION_PERSONAL")+": "+this.personalEmail(),value:Enums.ContactEmailType.Personal}),""!==this.businessEmail()&&e.push({text:Utils.i18n("CONTACTS/OPTION_BUSINESS")+": "+this.businessEmail(),value:Enums.ContactEmailType.Business}),""!==this.otherEmail()&&e.push({text:Utils.i18n("CONTACTS/OPTION_OTHER")+": "+this.otherEmail(),value:Enums.ContactEmailType.Other}),e},this),this.phones=ko.computed(function(){var e=[];return""!==this.personalMobile()&&e.push({text:Utils.i18n("CONTACTS/LABEL_MOBILE")+": "+this.personalMobile(),value:Enums.ContactPhoneType.Mobile}),""!==this.personalPhone()&&e.push({text:Utils.i18n("CONTACTS/OPTION_PERSONAL")+": "+this.personalPhone(),value:Enums.ContactPhoneType.Personal}),""!==this.businessPhone()&&e.push({text:Utils.i18n("CONTACTS/OPTION_BUSINESS")+": "+this.businessPhone(),value:Enums.ContactPhoneType.Business}),e},this),this.addresses=ko.computed(function(){var e=[];return""!==this.personalStreetAddress()&&e.push({text:Utils.i18n("CONTACTS/OPTION_PERSONAL")+": "+this.personalStreetAddress(),value:Enums.ContactAddressType.Personal}),""!==this.businessStreetAddress()&&e.push({text:Utils.i18n("CONTACTS/OPTION_BUSINESS")+": "+this.businessStreetAddress(),value:Enums.ContactAddressType.Business}),e},this),this.hasEmails=ko.computed(function(){return 0<this.emails().length},this),this.extented.subscribe(function(e){e&&(this.personalCollapsed(!this.personalIsEmpty()),this.businessCollapsed(!this.businessIsEmpty()),this.otherCollapsed(!this.otherIsEmpty()),this.groupsCollapsed(!this.groupsIsEmpty()))},this),this.birthdayMonthSelect=CContactModel.birthdayMonthSelect,this.birthdayYearSelect=CContactModel.birthdayYearSelect,this.birthdayDaySelect=ko.computed(function(){for(var e=1,t=Utils.pInt(Utils.daysInMonth(this.otherBirthdayMonth(),this.otherBirthdayYear())),i="",s=[{text:Utils.i18n("DATETIME/DAY"),value:"0"}];e<=t;e++)i=e.toString(),s.push({text:i,value:i});return s},this);for(var e=new Date,t="",i=e.getFullYear(),s=1932;i>=s;i--)t=i.toString(),this.birthdayYearSelect.push({text:t,value:t});this.canBeSave=ko.computed(function(){return""!==this.displayName()||!!this.emails().length},this),this.sendMailLink=ko.computed(function(){return bMobileApp?this.getSendMailLink(this.email()):"#"},this),this.sendMailToPersonalLink=ko.computed(function(){return bMobileApp?this.getSendMailLink(this.personalEmail()):"#"},this),this.sendMailToBusinessLink=ko.computed(function(){return bMobileApp?this.getSendMailLink(this.businessEmail()):"#"},this),this.sendMailToOtherLink=ko.computed(function(){return bMobileApp?this.getSendMailLink(this.otherEmail()):"#"},this)}function CGroupModel(){this.isNew=ko.observable(!1),this.readOnly=ko.observable(!1),this.idGroup=ko.observable(""),this.idUser=ko.observable(""),this.name=ko.observable(""),this.isOrganization=ko.observable(!1),this.email=ko.observable(""),this.country=ko.observable(""),this.city=ko.observable(""),this.company=ko.observable(""),this.fax=ko.observable(""),this.phone=ko.observable(""),this.state=ko.observable(""),this.street=ko.observable(""),this.web=ko.observable(""),this.zip=ko.observable(""),this.edited=ko.observable(!1),this.nameFocused=ko.observable(!1),this.canBeSave=ko.computed(function(){return""!==this.name()},this),this.newContactsInGroupCount=ko.observable(0),this.newContactsInGroupHint=ko.computed(function(){var e=this.newContactsInGroupCount();return this.isNew()&&0<e?Utils.i18n("CONTACTS/CONTACT_ADD_TO_NEW_HINT_PLURAL",{COUNT:e},null,e):""},this),this.events=ko.observableArray([])}function CContactListItemModel(){this.bIsGroup=!1,this.bIsOrganization=!1,this.bReadOnly=!1,this.bItsMe=!1,this.bGlobal=!1,this.sId="",this.sName="",this.sEmail="",this.bSharedToAll=!1,this.deleted=ko.observable(!1),this.checked=ko.observable(!1),this.selected=ko.observable(!1),this.recivedAnim=ko.observable(!1).extend({autoResetToFalse:500}),this.groupType=ko.observable([])}function CCalendarModel(){this.id=0,this.cTag=0,this.name=ko.observable(""),this.description=ko.observable(""),this.owner=ko.observable(""),this.isDefault=!1,this.isShared=ko.observable(!1),this.isSharedToAll=ko.observable(!1),this.sharedToAllAccess=Enums.CalendarAccess.Read,this.isPublic=ko.observable(!1),this.url=ko.observable(""),this.davUrl=ko.observable(""),this.exportUrl=ko.observable(""),this.pubUrl=ko.observable(""),this.shares=ko.observableArray([]),this.events=ko.observableArray([]),this.eventsCount=ko.computed(function(){return this.events().length},this),this.access=ko.observable(Enums.CalendarAccess.Write),this.control=ko.computed(function(){return!(this.access()===Enums.CalendarAccess.Read&&this.isSharedToAll())},this),this.color=ko.observable(""),this.color.subscribe(function(){this.events(_.map(this.events(),function(e){return e.backgroundColor=e.borderColor=this.color(),e},this)),this.name.valueHasMutated()},this),this.active=ko.observable(!0),this.startDateTime=0,this.endDateTime=0,this.account=AppData.Accounts?AppData.Accounts.getDefault():null,this.addEmailToName=!1}function CCalendarListModel(e){this.parentOnCalendarActiveChange=e.onCalendarActiveChange,this.parentOnCalendarCollectionChange=e.onCalendarCollectionChange,this.defaultCal=ko.observable(null),this.currentCal=ko.observable(null),this.collection=ko.observableArray([]),this.collection.subscribe(function(){this.pickCurrentCalendar(this.defaultCal()),this.parentOnCalendarCollectionChange&&this.parentOnCalendarCollectionChange()},this),this.count=ko.computed(function(){return this.collection().length},this),this.own=ko.computed(function(){var e=_.filter(this.collection(),function(e){return!e.isShared()});return e},this),this.ownCount=ko.computed(function(){return this.own().length},this),this.shared=ko.computed(function(){var e=_.filter(this.collection(),function(e){return e.isShared()&&!e.isSharedToAll()});return e},this),this.sharedCount=ko.computed(function(){return this.shared().length},this),this.sharedToAll=ko.computed(function(){var e=_.filter(this.collection(),function(e){return e.isShared()&&e.isSharedToAll()});return e},this),this.sharedToAllCount=ko.computed(function(){return this.sharedToAll().length},this),this.ids=ko.computed(function(){return _.map(this.collection(),function(e){return e.id},this)},this)}function CFileModel(){this.id=ko.observable(""),this.fileName=ko.observable(""),this.nameForEdit=ko.observable(""),this.storageType=ko.observable(Enums.FileStorageType.Personal),this.lastModified=ko.observable(""),this.path=ko.observable(""),this.fullPath=ko.observable(""),this.publicHash=ko.observable(""),this.selected=ko.observable(!1),this.checked=ko.observable(!1),this.isFolder=ko.observable(!1),this.edited=ko.observable(!1),this.isExternal=ko.observable(!1),this.isLink=ko.observable(!1),this.linkType=ko.observable(0),this.linkUrl=ko.observable(""),this.thumbnailExternalLink=ko.observable(""),this.deleted=ko.observable(!1),this.recivedAnim=ko.observable(!1).extend({autoResetToFalse:500}),this.shared=ko.observable(!1),this.owner=ko.observable(""),this.ownerHeaderText=ko.computed(function(){return Utils.i18n("FILESTORAGE/OWNER_HEADER_EMAIL",{OWNER:this.owner()})},this),this.lastModifiedHeaderText=ko.computed(function(){return Utils.i18n("FILESTORAGE/OWNER_HEADER_LAST_MODIFIED_DATE_TEXT",{LASTMODIFIED:this.lastModified()})},this),CCommonFileModel.call(this),this.fileName.subscribe(function(e){this.nameForEdit(e)},this),this.type=this.storageType,this.uploaded=ko.observable(!0),this.downloadLink=ko.computed(function(){return Utils.getFilestorageDownloadLinkByHash(AppData.Accounts?AppData.Accounts.currentId():null,this.hash(),this.publicHash())},this),this.viewLink=ko.computed(function(){if(this.isLink())return this.linkUrl();var e=Utils.getFilestorageViewLinkByHash(AppData.Accounts?AppData.Accounts.currentId():null,this.hash(),this.publicHash());return this.iframedView()?Utils.getIframeWrappwer(AppData.Accounts?AppData.Accounts.currentId():null,e):e},this),this.isViewable=ko.computed(function(){var e=!1,t=["JPEG","JPG","PNG","GIF","HTM","HTML","TXT","CSS","ASC","JS","PDF","BMP"];return _.indexOf(t,this.extension().toUpperCase())>=0&&(e=!0),(this.iframedView()||e||this.isLink())&&!this.isPopupItem()},this),this.visibleViewLink=ko.computed(function(){return(""!==this.oembed()||""===this.linkUrl())&&this.isViewable()},this),this.thumbnailLink=ko.computed(function(){return this.isExternal()||this.isLink()&&(this.linkType()===Enums.FileStorageLinkType.GoogleDrive||this.linkType()===Enums.FileStorageLinkType.YouTube||this.linkType()===Enums.FileStorageLinkType.Vimeo||this.linkType()===Enums.FileStorageLinkType.SoundCloud)?this.thumbnailExternalLink():this.thumb()?Utils.getFilestorageViewThumbnailLinkByHash(this.accountId(),this.hash(),this.publicHash()):""},this),this.edited.subscribe(function(e){e===!1&&this.nameForEdit(this.fileName())},this),this.canShare=ko.computed(function(){return this.storageType===Enums.FileStorageType.Personal||this.storageType===Enums.FileStorageType.Corporate;
},this)}function CPostModel(){this.Id=null,this.IdThread=null,this.IdOwner=null,this.sFrom="",this.sDate="",this.iType=null,this.bSysType=!1,this.bThreadOwner=null,this.sText="",this.collapsed=ko.observable(!1),this.attachments=ko.observableArray([]),this.allowDownloadAttachmentsLink=!0,this.itsMe=ko.observable(!1),this.canBeDeleted=this.itsMe}function CThreadListModel(){this.Id=null,this.ThreadHash="",this.IdOwner=null,this.ItsMe=!1,this.aOwner=[],this.sSubject="",this.sEmail="",this.sName="",this.sFrom="",this.sFromFull="",this.time=ko.observable(0),this.state=ko.observable(0),this.unseen=ko.observable(!1),this.postsCount=ko.observable(0),this.date=ko.computed(function(){return moment(1e3*this.time()).fromNow(!1)},this),this.printableState=ko.computed(function(){var e="",t=this.ItsMe?"_FOR_CLIENT":"";switch(this.state()){case Enums.HelpdeskThreadStates.Pending:e=Utils.i18n("HELPDESK/THREAD_STATE_PENDING"+t);break;case Enums.HelpdeskThreadStates.Resolved:e=Utils.i18n("HELPDESK/THREAD_STATE_RESOLVED"+t);break;case Enums.HelpdeskThreadStates.Waiting:e=Utils.i18n("HELPDESK/THREAD_STATE_WAITING"+t);break;case Enums.HelpdeskThreadStates.Answered:e=Utils.i18n("HELPDESK/THREAD_STATE_ANSWERED"+t);break;case Enums.HelpdeskThreadStates.Deferred:e=Utils.i18n("HELPDESK/THREAD_STATE_DEFERRED"+t)}return e},this),this.deleted=ko.observable(!1),this.checked=ko.observable(!1),this.selected=ko.observable(!1)}function CHelpdeskAttachmentModel(){CCommonFileModel.call(this),this.downloadLink=ko.computed(function(){var e=!bExtApp&&AppData&&AppData.Accounts?AppData.Accounts.currentId():0,t=bExtApp&&AppData?AppData.TenantHash:"";return Utils.getDownloadLinkByHash(e,this.hash(),bExtApp,t)},this),this.viewLink=ko.computed(function(){var e=!bExtApp&&AppData&&AppData.Accounts?AppData.Accounts.currentId():0,t=bExtApp&&AppData?AppData.TenantHash:"";return Utils.File.getViewLinkByHash(e,this.hash(),bExtApp,t)},this),this.thumbnailLink=ko.computed(function(){var e=!bExtApp&&AppData&&AppData.Accounts?AppData.Accounts.currentId():0,t=bExtApp&&AppData?AppData.TenantHash:"",i=this.thumb()?Utils.getViewThumbnailLinkByHash(e,this.hash(),bExtApp,t):"";return i},this)}function CSignatureModel(){this.iAccountId=0,this.type=ko.observable(!0),this.options=ko.observable(0),this.signature=ko.observable("")}function CAutoresponderModel(){this.iAccountId=0,this.enable=!1,this.subject="",this.message=""}function CFetcherModel(){this.FETCHER=!0,this.id=ko.observable(0),this.accountId=ko.observable(0),this.isEnabled=ko.observable(!1),this.isLocked=ko.observable(!1).extend({autoResetToFalse:1e3}),this.email=ko.observable(""),this.userName=ko.observable(""),this.folder=ko.observable(""),this.signatureOptions=ko.observable(!1),this.signature=ko.observable(""),this.incomingMailServer=ko.observable(""),this.incomingMailPort=ko.observable(0),this.incomingMailSsl=ko.observable(!1),this.incomingMailLogin=ko.observable(""),this.leaveMessagesOnServer=ko.observable(""),this.isOutgoingEnabled=ko.observable(!1),this.outgoingMailServer=ko.observable(""),this.outgoingMailPort=ko.observable(0),this.outgoingMailSsl=ko.observable(!1),this.outgoingMailAuth=ko.observable(!1),this.fullEmail=ko.computed(function(){return Utils.Address.getFullEmail(this.userName(),this.email())},this)}function CFetcherListModel(){this.accountId=0,this.collection=ko.observableArray([])}function CForwardModel(){this.iAccountId=0,this.enable=!1,this.email=""}function CSieveFiltersModel(){this.iAccountId=0,this.collection=ko.observableArray([])}function CSieveFilterModel(e){this.iAccountId=e,this.enable=ko.observable(!0).extend({reversible:!0}),this.field=ko.observable("").extend({reversible:!0}),this.condition=ko.observable("").extend({reversible:!0}),this.filter=ko.observable("").extend({reversible:!0}),this.action=ko.observable("").extend({reversible:!0}),this.folder=ko.observable("").extend({reversible:!0})}function CInformationViewModel(){this.iAnimationDuration=500,this.iReportDuration=5e3,this.iErrorDuration=1e4,this.loadingMessage=ko.observable(""),this.loadingHidden=ko.observable(!0),this.loadingVisible=ko.observable(!1),this.reportMessage=ko.observable(""),this.reportHidden=ko.observable(!0),this.reportVisible=ko.observable(!1),this.reportVisibleClose=ko.observable(!1),this.iReportTimeout=-1,this.errorMessage=ko.observable(""),this.errorHidden=ko.observable(!0),this.errorVisible=ko.observable(!1),this.iErrorTimeout=-1,this.isHtmlError=ko.observable(!1),this.gray=ko.observable(!1)}function CHeaderBaseViewModel(){var e=this;this.mobileApp=bMobileApp,this.mobileDevice=AppData.AllowMobile&&bMobileDevice,this.hideLogout=AppData.App.HideLogout,this.allowWebMail=AppData.App.AllowWebMail,this.currentAccountId=AppData.Accounts.currentId,this.currentAccountId.subscribe(function(){_.delay(function(){e.changeMailLinkText()},300)},this),this.tabs=App.headerTabs,this.mailLinkText=ko.observable(""),this.accounts=ko.computed(function(){return 1===AppData.Accounts.collection().length?AppData.Accounts.collection():_.filter(AppData.Accounts.collection(),function(e){return e.allowMail()})},this),this.currentTab=App.Screens.currentScreen,this.isMailboxTab=ko.computed(function(){return this.currentTab()===Enums.Screens.Mailbox},this),this.helpdeskUnseenCount=App.helpdeskUnseenCount,this.helpdeskUnseenVisible=ko.computed(function(){return this.currentTab()!==Enums.Screens.Helpdesk&&!!this.helpdeskUnseenCount()},this),this.helpdeskPendingCount=App.helpdeskPendingCount,this.helpdeskPendingVisible=ko.computed(function(){return this.currentTab()!==Enums.Screens.Helpdesk&&!!this.helpdeskPendingCount()},this),this.mailUnseenCount=App.mailUnseenCount,this.mailUnseenVisible=ko.computed(function(){return this.currentTab()!==Enums.Screens.Mailbox&&!!this.mailUnseenCount()},this),this.mailboxHash=App.Routing.lastMailboxHash,this.settingsHash=App.Routing.lastSettingsHash,this.contactsRecivedAnim=App.ContactsCache.recivedAnim,this.calendarRecivedAnim=App.CalendarCache.recivedAnim,this.appCustomLogo=ko.observable(AppData.AppStyleImage||""),AfterLogicApi.runPluginHook&&AfterLogicApi.runPluginHook("view-model-defined",[this.__name,this])}function CHeaderViewModel(){CHeaderBaseViewModel.call(this),this.oPhone=App.Phone?new CPhoneViewModel:null}function CPageSwitcherViewModel(e,t){this.shown=!1,this.currentPage=ko.observable(1),this.count=ko.observable(e),this.perPage=ko.observable(t),this.firstPage=ko.observable(1),this.lastPage=ko.observable(1),this.pagesCount=ko.computed(function(){var e=Math.ceil(this.count()/this.perPage());return e>0?e:1},this),ko.computed(function(){var e=20,t=4,i=this.pagesCount(),s=this.currentPage(),o=s,n=s;if(i>1)for(;;){if(e--,1<o&&(o--,t--),0===t)break;if(i>n&&(n++,t--),0===t)break;if(0===e)break}this.firstPage(o),this.lastPage(n)},this),this.visibleFirst=ko.computed(function(){return this.firstPage()>1},this),this.visibleLast=ko.computed(function(){return this.lastPage()<this.pagesCount()},this),this.clickPage=_.bind(this.clickPage,this),this.pages=ko.computed(function(){var e=this.firstPage(),t=[];if(this.firstPage()<this.lastPage())for(;e<=this.lastPage();e++)t.push({number:e,current:e===this.currentPage(),clickFunc:this.clickPage});return t},this),this.hotKeysBind()}function CHtmlEditorViewModel(e,t){this.mobileApp=bMobileApp,this.oParent=t,this.creaId="creaId"+Math.random().toString().replace(".",""),this.textFocused=ko.observable(!1),this.workareaDom=ko.observable(),this.uploaderAreaDom=ko.observable(),this.editorUploaderBodyDragOver=ko.observable(!1),this.editorUploaderProgress=ko.observable(!1),this.htmlEditorDom=ko.observable(),this.toolbarDom=ko.observable(),this.colorPickerDropdownDom=ko.observable(),this.insertLinkDropdownDom=ko.observable(),this.insertImageDropdownDom=ko.observable(),this.isEnable=ko.observable(!0),this.isEnable.subscribe(function(){this.oCrea&&this.oCrea.setEditable(this.isEnable())},this),this.bInsertImageAsBase64=e,this.bAllowFileUpload=!(e&&void 0===window.File),this.allowInsertImage=ko.observable(AppData.App.AllowInsertImage),this.lockFontSubscribing=ko.observable(!1),this.bAllowImageDragAndDrop=!App.browser.ie10AndAbove,this.aFonts=["Arial","Arial Black","Courier New","Tahoma","Times New Roman","Verdana"],this.sDefaultFont=AppData.User.DefaultFontName,this.correctFontFromSettings(),this.selectedFont=ko.observable(""),this.selectedFont.subscribe(function(){!this.oCrea||this.lockFontSubscribing()||this.inactive()||this.oCrea.fontName(this.selectedFont())},this),this.iDefaultSize=AppData.User.DefaultFontSize,this.selectedSize=ko.observable(0),this.selectedSize.subscribe(function(){!this.oCrea||this.lockFontSubscribing()||this.inactive()||this.oCrea.fontSize(this.selectedSize())},this),this.visibleInsertLinkPopup=ko.observable(!1),this.linkForInsert=ko.observable(""),this.linkFocused=ko.observable(!1),this.visibleLinkPopup=ko.observable(!1),this.linkPopupDom=ko.observable(null),this.linkHrefDom=ko.observable(null),this.linkHref=ko.observable(""),this.visibleLinkHref=ko.observable(!1),this.visibleImagePopup=ko.observable(!1),this.visibleImagePopup.subscribe(function(){this.onImageOut()},this),this.imagePopupTop=ko.observable(0),this.imagePopupLeft=ko.observable(0),this.imageSelected=ko.observable(!1),this.tooltipText=ko.observable(""),this.tooltipPopupTop=ko.observable(0),this.tooltipPopupLeft=ko.observable(0),this.visibleInsertImagePopup=ko.observable(!1),this.imageUploaderButton=ko.observable(null),this.uploadedImagePathes=ko.observableArray([]),this.imagePathFromWeb=ko.observable(""),this.visibleFontColorPopup=ko.observable(!1),this.oFontColorPicker=new CColorPickerViewModel(Utils.i18n("HTMLEDITOR/TEXT_COLOR_CAPTION"),this.setTextColorFromPopup,this),this.oBackColorPicker=new CColorPickerViewModel(Utils.i18n("HTMLEDITOR/BACKGROUND_COLOR_CAPTION"),this.setBackColorFromPopup,this),this.activitySource=ko.observable(1),this.activitySourceSubscription=null,this.inactive=ko.observable(!1),this.inactive.subscribe(function(){var e=this.removeAllTags(this.getText());this.inactive()?""!==e&&"&nbsp;"!==e||(this.setText('<span style="color: #AAAAAA;">'+Utils.i18n("HTMLEDITOR/SIGNATURE_PLACEHOLDER")+"</span>"),this.oCrea&&this.oCrea.setBlur()):e===Utils.i18n("HTMLEDITOR/SIGNATURE_PLACEHOLDER")&&this.setText("")},this),this.allowChangeInputDirection=Utils.isRTL()||AppData.User.AllowChangeInputDirection,this.disabled=ko.observable(!1),this.textChanged=ko.observable(!1),AfterLogicApi.runPluginHook&&AfterLogicApi.runPluginHook("view-model-defined",[this.__name,this])}function CColorPickerViewModel(e,t,i){this.aGreyColors=["rgb(0, 0, 0)","rgb(68, 68, 68)","rgb(102, 102, 102)","rgb(153, 153, 153)","rgb(204, 204, 204)","rgb(238, 238, 238)","rgb(243, 243, 243)","rgb(255, 255, 255)"],this.aBrightColors=["rgb(255, 0, 0)","rgb(255, 153, 0)","rgb(255, 255, 0)","rgb(0, 255, 0)","rgb(0, 255, 255)","rgb(0, 0, 255)","rgb(153, 0, 255)","rgb(255, 0, 255)"],this.aColorLines=[["rgb(244, 204, 204)","rgb(252, 229, 205)","rgb(255, 242, 204)","rgb(217, 234, 211)","rgb(208, 224, 227)","rgb(207, 226, 243)","rgb(217, 210, 233)","rgb(234, 209, 220)"],["rgb(234, 153, 153)","rgb(249, 203, 156)","rgb(255, 229, 153)","rgb(182, 215, 168)","rgb(162, 196, 201)","rgb(159, 197, 232)","rgb(180, 167, 214)","rgb(213, 166, 189)"],["rgb(224, 102, 102)","rgb(246, 178, 107)","rgb(255, 217, 102)","rgb(147, 196, 125)","rgb(118, 165, 175)","rgb(111, 168, 220)","rgb(142, 124, 195)","rgb(194, 123, 160)"],["rgb(204, 0, 0)","rgb(230, 145, 56)","rgb(241, 194, 50)","rgb(106, 168, 79)","rgb(69, 129, 142)","rgb(61, 133, 198)","rgb(103, 78, 167)","rgb(166, 77, 121)"],["rgb(153, 0, 0)","rgb(180, 95, 6)","rgb(191, 144, 0)","rgb(56, 118, 29)","rgb(19, 79, 92)","rgb(11, 83, 148)","rgb(53, 28, 117)","rgb(116, 27, 71)"],["rgb(102, 0, 0)","rgb(120, 63, 4)","rgb(127, 96, 0)","rgb(39, 78, 19)","rgb(12, 52, 61)","rgb(7, 55, 99)","rgb(32, 18, 77)","rgb(76, 17, 48)"]],this.caption=e,this.pickHandler=t,this.pickContext=i,this.colorPickerDom=ko.observable(null)}function CPhoneViewModel(){this.phone=App.Phone,this.action=this.phone.action,this.report=this.phone.report,this.logs=ko.observableArray([]),this.logsToShow=ko.observableArray([]),this.spinner=ko.observable(!0),this.tooltip=ko.observable(Utils.i18n("PHONE/NOT_CONNECTED")),this.indicator=ko.observable(Utils.i18n("PHONE/MISSED_CALLS")),this.dropdownShow=ko.observable(!1),this.input=ko.observable(""),this.input.subscribe(function(e){this.dropdownShow(""===e&&this.action()===Enums.PhoneAction.OnlineActive)},this),this.inputFocus=ko.observable(!1),this.inputFocus.subscribe(function(e){e&&""===this.input()&&this.action()===Enums.PhoneAction.OnlineActive&&this.dropdownShow(!0)},this),this.phoneAutocompleteItem=ko.observable(null),this.action.subscribe(function(e){switch(e){case Enums.PhoneAction.Offline:this.tooltip(Utils.i18n("PHONE/NOT_CONNECTED"));break;case Enums.PhoneAction.OfflineError:this.tooltip(Utils.i18n("Connection error"));break;case Enums.PhoneAction.OfflineInit:this.tooltip(Utils.i18n("PHONE/CONNECTING"));break;case Enums.PhoneAction.OfflineActive:break;case Enums.PhoneAction.Online:this.tooltip(Utils.i18n("PHONE/CONNECTED")),this.input(""),this.report(""),this.timer("stop");break;case Enums.PhoneAction.OnlineActive:break;case Enums.PhoneAction.Outgoing:this.timer("start");break;case Enums.PhoneAction.OutgoingConnect:this.tooltip(Utils.i18n("In Call"));break;case Enums.PhoneAction.Incoming:break;case Enums.PhoneAction.IncomingConnect:this.tooltip(Utils.i18n("In Call")),this.report(""),this.timer("start")}},this),$(document).on("click",_.bind(function(e){0===$(e.target).closest(".item.phone, .ui-autocomplete").length&&this.action()===Enums.PhoneAction.OnlineActive&&(this.action(Enums.PhoneAction.Online),this.dropdownShow(!1))},this))}function CWrapLoginViewModel(){this.bSocialInviteMode="string"==typeof Utils.Common.getRequestParam("invite-auth"),this.socialInviteTitle=Utils.i18n("LOGIN/SOCIAL_INVITE_TITLE",{SITENAME:AppData.App.SiteName}),this.socialInviteText=Utils.i18n("LOGIN/SOCIAL_INVITE_TEXT"),this.rtl=ko.observable(Utils.isRTL()),this.allowRegistration=AppData.App.AllowRegistration,this.allowPasswordReset=AppData.App.AllowPasswordReset,this.oLoginViewModel=new CLoginViewModel,this.allowRegistration&&(this.oRegisterViewModel=new CRegisterViewModel),this.allowPasswordReset&&(this.oForgotViewModel=new CForgotViewModel),this.gotoForgot=this.allowPasswordReset?this.oForgotViewModel.gotoForgot:ko.observable(!1),this.gotoRegister=ko.observable(!1),this.emailVisible=this.oLoginViewModel.emailVisible,this.loginVisible=this.oLoginViewModel.loginVisible,this.loginDescription=ko.observable(AppData.App.LoginDescription||""),this.aLanguages=AppData.App.Languages,this.currentLanguage=ko.observable(AppData.App.DefaultLanguage),this.allowLanguages=ko.observable(AppData.App.AllowLanguageOnLogin),this.viewLanguagesAsDropdown=ko.observable(!AppData.App.FlagsLangSelect),this.loginCustomLogo=ko.observable(AppData.LoginStyleImage||""),AfterLogicApi.runPluginHook&&AfterLogicApi.runPluginHook("view-model-defined",[this.__name,this])}function CLoginAdvancedViewModel(){var e=AppData.LoginAdvanced;this.bEnabled=!(!e||!e.Enabled),this.bEnabled&&(this.displayForm=ko.observable(!1),this.triggerLinkText=ko.computed(function(){return this.displayForm()?Utils.i18n("LOGIN/LINK_LESS_OPTIONS"):Utils.i18n("LOGIN/LINK_MORE_OPTIONS")},this),this.oIncoming=new CServerPropertiesViewModel(e.IncomingPort||143,e.IncomingSslPort||993,!!e.IncomingUseSsl,"acc_login_incoming",Utils.i18n("SETTINGS/ACCOUNT_PROPERTIES_INCOMING_MAIL")),this.oOutgoing=new CServerPropertiesViewModel(e.OutgoingPort||25,e.OutgoingSslPort||465,!!e.OutgoingUseSsl,"acc_login_outgoing",Utils.i18n("SETTINGS/ACCOUNT_PROPERTIES_OUTGOING_MAIL"),this.oIncoming.server),this.bShowUseSmtpAuth=!!e.ShowUseSmtpAuth,this.useSmtpAuthentication=ko.observable(!!e.UseSmtpAuth),this.advancedLoginForm=ko.observable(null))}function CLoginViewModel(){this.oLoginAdvancedViewModel=new CLoginAdvancedViewModel,this.allowRegistration=AppData.App.AllowRegistration,this.allowPasswordReset=AppData.App.AllowPasswordReset,this.email=ko.observable(""),this.login=ko.observable(""),this.password=ko.observable(""),this.emailFocus=ko.observable(!1),this.loginFocus=ko.observable(!1),this.passwordFocus=ko.observable(!1),this.loading=ko.observable(!1),this.changingLanguage=ko.observable(!1),this.loginFocus.subscribe(function(e){e&&""===this.login()&&this.login(this.email())},this),this.loginFormType=ko.observable(AppData.App.LoginFormType),this.loginAtDomainValue=ko.observable(AppData.App.LoginAtDomainValue),this.loginAtDomainValueWithAt=ko.computed(function(){var e=this.loginAtDomainValue();return""===e?"":"@"+e},this),this.emailVisible=ko.computed(function(){return Enums.LoginFormType.Login!==this.loginFormType()},this),this.loginVisible=ko.computed(function(){return Enums.LoginFormType.Email!==this.loginFormType()},this),this.signMeType=ko.observable(AppData.App.LoginSignMeType),this.signMe=ko.observable(Enums.LoginSignMeType.DefaultOn===this.signMeType()),this.signMeType.subscribe(function(){this.signMe(Enums.LoginSignMeType.DefaultOn===this.signMeType())},this),this.signMeFocused=ko.observable(!1),this.emailDom=ko.observable(null),this.loginDom=ko.observable(null),this.passwordDom=ko.observable(null),this.focusedField="",this.canBeLogin=ko.computed(function(){return!this.loading()&&!this.changingLanguage()},this),this.signInButtonText=ko.computed(function(){return this.loading()?Utils.i18n("LOGIN/BUTTON_SIGNING_IN"):Utils.i18n("LOGIN/BUTTON_SIGN_IN")},this),this.loginCommand=Utils.createCommand(this,this.signIn,this.canBeLogin),this.email(AppData.App.DemoWebMailLogin||""),this.password(AppData.App.DemoWebMailPassword||""),AfterLogicApi.runPluginHook&&AfterLogicApi.runPluginHook("view-model-defined",[this.__name,this]),this.shake=ko.observable(!1).extend({autoResetToFalse:800})}function CForgotViewModel(){this.gotoForgot=ko.observable(!1),this.gotoForgot.subscribe(function(){this.visibleEmailForm(!0),this.visibleQuestionForm(!1),this.visiblePasswordForm(!1)},this),this.visibleEmailForm=ko.observable(!0),this.email=ko.observable(""),this.emailFocus=ko.observable(!1),this.gettingQuestion=ko.observable(!1),this.getQuestionButtonText=ko.computed(function(){return this.gettingQuestion()?Utils.i18n("LOGIN/BUTTON_GETTING_QUESTION"):Utils.i18n("LOGIN/BUTTON_GET_QUESTION")},this),this.allowGetQuestion=ko.computed(function(){return!this.gettingQuestion()&&""!==Utils.trim(this.email())},this),this.getQuestionCommand=Utils.createCommand(this,this.executeGetQuestion,this.allowGetQuestion),this.visibleQuestionForm=ko.observable(!1),this.question=ko.observable(""),this.answer=ko.observable(""),this.answerFocus=ko.observable(!1),this.validatingAnswer=ko.observable(!1),this.validateAnswerButtonText=ko.computed(function(){return this.validatingAnswer()?Utils.i18n("LOGIN/BUTTON_VALIDATING_ANSWER"):Utils.i18n("LOGIN/BUTTON_VALIDATE_ANSWER")},this),this.allowValidatingAnswer=ko.computed(function(){return!this.validatingAnswer()&&""!==Utils.trim(this.answer())},this),this.validateAnswerCommand=Utils.createCommand(this,this.executeValidateAnswer,this.allowValidatingAnswer),this.visiblePasswordForm=ko.observable(!1),this.password=ko.observable(""),this.confirmPassword=ko.observable(""),this.passwordFocus=ko.observable(!1),this.confirmPasswordFocus=ko.observable(!1),this.changingPassword=ko.observable(!1),this.changePasswordButtonText=ko.computed(function(){return this.changingPassword()?Utils.i18n("LOGIN/BUTTON_RESETTING_PASSWORD"):Utils.i18n("LOGIN/BUTTON_RESET_PASSWORD")},this),this.allowChangePassword=ko.computed(function(){var e=Utils.trim(this.password()),t=Utils.trim(this.confirmPassword()),i=""===e||""===t;return!this.changingPassword()&&!i},this),this.changePasswordCommand=Utils.createCommand(this,this.executeChangePassword,this.allowChangePassword),AfterLogicApi.runPluginHook&&AfterLogicApi.runPluginHook("view-model-defined",[this.__name,this])}function CRegisterViewModel(){this.name=ko.observable(""),this.login=ko.observable(""),this.password=ko.observable(""),this.confirmPassword=ko.observable(""),this.question=ko.observable(""),this.yourQuestion=ko.observable(""),this.answer=ko.observable(""),this.allowQuestionPart=Utils.isNonEmptyArray(AppData.App.RegistrationQuestions),this.visibleYourQuestion=ko.computed(function(){return this.question()===Utils.i18n("LOGIN/OPTION_YOUR_QUESTION")},this),this.nameFocus=ko.observable(!1),this.loginFocus=ko.observable(!1),this.passwordFocus=ko.observable(!1),this.confirmPasswordFocus=ko.observable(!1),this.questionFocus=ko.observable(!1),this.answerFocus=ko.observable(!1),this.yourQuestionFocus=ko.observable(!1),this.domains=ko.observable(Utils.isNonEmptyArray(AppData.App.RegistrationDomains)?AppData.App.RegistrationDomains:[]),this.domain=ko.computed(function(){return 1===this.domains().length?this.domains()[0]:""},this),this.selectedDomain=ko.observable(this.domains().length>0?this.domains()[0]:""),this.registrationQuestions=[],this.allowQuestionPart&&(this.registrationQuestions=_.map(_.union("",_.without(AppData.App.RegistrationQuestions,"*")),function(e){return{text:""!==e?e:Utils.i18n("LOGIN/LABEL_SELECT_QUESTION"),value:e}}),_.indexOf(AppData.App.RegistrationQuestions,"*")!==-1&&this.registrationQuestions.push({text:Utils.i18n("LOGIN/OPTION_YOUR_QUESTION"),value:Utils.i18n("LOGIN/OPTION_YOUR_QUESTION")})),this.loading=ko.observable(!1),this.canBeRegister=ko.computed(function(){var e=Utils.trim(this.login()),t=Utils.trim(this.password()),i=Utils.trim(this.confirmPassword()),s=Utils.trim(this.visibleYourQuestion()?this.yourQuestion():this.question()),o=Utils.trim(this.answer()),n=""===e||""===t||""===i||this.allowQuestionPart&&(""===s||""===o);return!this.loading()&&!n},this),this.registerButtonText=ko.computed(function(){return this.loading()?Utils.i18n("LOGIN/BUTTON_REGISTERING"):Utils.i18n("LOGIN/BUTTON_REGISTER")},this),this.registerCommand=Utils.createCommand(this,this.registerAccount,this.canBeRegister),AfterLogicApi.runPluginHook&&AfterLogicApi.runPluginHook("view-model-defined",[this.__name,this])}function CFolderListViewModel(){this.accounts=AppData.Accounts.collection,this.mobileApp=bMobileApp,this.folderList=App.MailCache.folderList,this.manageFoldersHash=App.Routing.buildHashFromArray([Enums.Screens.Settings,Enums.SettingsTab.EmailAccounts,Enums.AccountSettingsTab.Folders]),this.quotaProc=ko.observable(-1),this.quotaDesc=ko.observable(""),ko.computed(function(){if(!AppData.App||AppData.App&&!AppData.App.ShowQuotaBar)return!0;App.MailCache.quotaChangeTrigger();var e=AppData.Accounts.getCurrent(),t=e?e.quota():0,i=e?e.usedSpace():0,s=0<t?Math.ceil(i/t*100):-1;return s=100<s?100:s,this.quotaProc(s),this.quotaDesc(-1<s?Utils.i18n("MAILBOX/QUOTA_TOOLTIP",{PROC:s,QUOTA:Utils.friendlySize(1024*t)}):""),!0},this),this.isCurrentAllowsMail=AppData.Accounts.isCurrentAllowsMail}function CMessageListViewModel(e){this.isPublic=bExtApp,this.uploaderArea=ko.observable(null),this.bDragActive=ko.observable(!1),this.bDragActiveComp=ko.computed(function(){return this.bDragActive()},this),this.openMessageInNewWindowBinded=e,this.isFocused=ko.observable(!1),this.messagesContainer=ko.observable(null),this.searchInput=ko.observable(""),this.searchInputFrom=ko.observable(""),this.searchInputTo=ko.observable(""),this.searchInputSubject=ko.observable(""),this.searchInputText=ko.observable(""),this.searchSpan=ko.observable(""),this.highlightTrigger=ko.observable(""),this.currentMessage=App.MailCache.currentMessage,this.currentMessage.subscribe(function(){this.isFocused(!1),this.selector.itemSelected(this.currentMessage())},this),this.folderList=App.MailCache.folderList,this.folderList.subscribe(this.onFolderListSubscribe,this),this.folderFullName=ko.observable(""),this.folderType=ko.observable(Enums.FolderTypes.User),this.filters=ko.observable(""),this.uidList=App.MailCache.uidList,this.uidList.subscribe(function(){this.uidList().searchCountSubscription&&(this.uidList().searchCountSubscription.dispose(),this.uidList().searchCountSubscription=void 0),this.uidList().searchCountSubscription=this.uidList().resultCount.subscribe(function(){this.uidList().resultCount()>=0&&this.oPageSwitcher.setCount(this.uidList().resultCount())},this),this.uidList().resultCount()>=0&&this.oPageSwitcher.setCount(this.uidList().resultCount())},this),this.useThreads=ko.computed(function(){var e=this.folderList().currentFolder(),t=e&&e.withoutThreads(),i=""===this.uidList().search()&&""===this.uidList().filters();return AppData.User.useThreads()&&!t&&i},this),this.collection=App.MailCache.messages,this._search=ko.observable(""),this.search=ko.computed({read:function(){return Utils.trim(this._search())},write:this._search,owner:this}),this.isEmptyList=ko.computed(function(){return 0===this.collection().length},this),this.isNotEmptyList=ko.computed(function(){return 0!==this.collection().length},this),this.isSearch=ko.computed(function(){return this.search().length>0},this),this.isUnseenFilter=ko.computed(function(){return this.filters()===Enums.FolderFilter.Unseen},this),this.isLoading=App.MailCache.messagesLoading,this.isError=App.MailCache.messagesLoadingError,this.visibleInfoLoading=ko.computed(function(){return!this.isSearch()&&this.isLoading()},this),this.visibleInfoSearchLoading=ko.computed(function(){return this.isSearch()&&this.isLoading()},this),this.visibleInfoSearchList=ko.computed(function(){return this.isSearch()&&!this.isUnseenFilter()&&!this.isLoading()&&!this.isEmptyList()},this),this.visibleInfoMessageListEmpty=ko.computed(function(){return!this.isLoading()&&!this.isSearch()&&""===this.filters()&&this.isEmptyList()&&!this.isError()},this),this.visibleInfoStarredFolderEmpty=ko.computed(function(){return!this.isLoading()&&!this.isSearch()&&this.filters()===Enums.FolderFilter.Flagged&&this.isEmptyList()&&!this.isError()},this),this.visibleInfoSearchEmpty=ko.computed(function(){return this.isSearch()&&!this.isUnseenFilter()&&this.isEmptyList()&&!this.isError()&&!this.isLoading()},this),this.visibleInfoMessageListError=ko.computed(function(){return!this.isSearch()&&this.isError()},this),this.visibleInfoSearchError=ko.computed(function(){return this.isSearch()&&this.isError()},this),this.visibleInfoUnseenFilterList=ko.computed(function(){return this.isUnseenFilter()&&(this.isLoading()||!this.isEmptyList())},this),this.visibleInfoUnseenFilterEmpty=ko.computed(function(){return this.isUnseenFilter()&&this.isEmptyList()&&!this.isError()&&!this.isLoading()},this),this.searchText=ko.computed(function(){return Utils.i18n("MAILBOX/INFO_SEARCH_RESULT",{SEARCH:this.calculateSearchStringForDescription(),FOLDER:this.folderList().currentFolder()?this.folderList().currentFolder().displayName():""})},this),this.unseenFilterText=ko.computed(function(){return""===this.search()?Utils.i18n("MAILBOX/INFO_UNSEEN_FILTER_RESULT",{FOLDER:this.folderList().currentFolder()?this.folderList().currentFolder().displayName():""}):Utils.i18n("MAILBOX/INFO_SEARCH_UNSEEN_FILTER_RESULT",{SEARCH:this.calculateSearchStringForDescription(),FOLDER:this.folderList().currentFolder()?this.folderList().currentFolder().displayName():""})},this),this.unseenFilterEmptyText=ko.computed(function(){return""===this.search()?Utils.i18n("MAILBOX/INFO_UNSEEN_FILTER_EMPTY"):Utils.i18n("MAILBOX/INFO_SEARCH_UNSEEN_FILTER_EMPTY")},this),this.isEnableGroupOperations=ko.observable(!1).extend({throttle:250}),this.selector=new CSelector(this.collection,_.bind(this.routeForMessage,this),_.bind(this.onDeletePress,this),_.bind(this.onMessageDblClick,this),_.bind(this.onEnterPress,this)),this.checkedUids=ko.computed(function(){var e=this.selector.listChecked(),t=_.map(e,function(e){return e.uid()}),i=App.MailCache.folderList().currentFolder(),s=i?i.getThreadCheckedUidsFromList(e):[],o=_.union(t,s);return o},this),this.checkedOrSelectedUids=ko.computed(function(){var e=this.checkedUids();return 0===e.length&&App.MailCache.currentMessage()&&!App.MailCache.currentMessage().deleted()&&(e=[App.MailCache.currentMessage().uid()]),e},this),ko.computed(function(){this.isEnableGroupOperations(0<this.selector.listCheckedOrSelected().length)},this),this.checkAll=this.selector.koCheckAll(),this.checkAllIncomplite=this.selector.koCheckAllIncomplete(),this.pageSwitcherLocked=ko.observable(!1),this.oPageSwitcher=new CPageSwitcherViewModel(0,AppData.User.MailsPerPage),this.oPageSwitcher.currentPage.subscribe(function(e){var t=this.folderList().currentFolderFullName(),i=!bMobileApp&&this.currentMessage()?this.currentMessage().uid():"",s=this.search();this.pageSwitcherLocked()||this.changeRoutingForMessageList(t,e,i,s,this.filters())},this),this.currentPage=ko.observable(0),App.browser.firefox||App.browser.ie?this.listChangedThrottle=ko.observable(!1).extend({throttle:10}):this.listChangedThrottle=ko.observable(!1),this.firstCompleteCollection=ko.observable(!0),this.collection.subscribe(function(){this.collection().length>0&&this.firstCompleteCollection(!1)},this),this.currentAccountId=AppData.Accounts.currentId,this.listChanged=ko.computed(function(){return[this.firstCompleteCollection(),this.currentAccountId(),this.folderFullName(),this.filters(),this.search(),this.oPageSwitcher.currentPage()]},this),this.listChanged.subscribe(function(){this.listChangedThrottle(!this.listChangedThrottle())},this),this.bAdvancedSearch=ko.observable(!1),this.searchAttachmentsCheckbox=ko.observable(!1),this.searchAttachments=ko.observable(""),this.searchAttachments.subscribe(function(e){this.searchAttachmentsCheckbox(!!e)},this),this.searchAttachmentsFocus=ko.observable(!1),this.searchFromFocus=ko.observable(!1),this.searchSubjectFocus=ko.observable(!1),this.searchToFocus=ko.observable(!1),this.searchTextFocus=ko.observable(!1),this.searchTrigger=ko.observable(null),this.searchDateStartFocus=ko.observable(!1),this.searchDateEndFocus=ko.observable(!1),this.searchDateStartDom=ko.observable(null),this.searchDateStart=ko.observable(""),this.searchDateEndDom=ko.observable(null),this.searchDateEnd=ko.observable(""),this.dateFormatDatePicker="yy.mm.dd",this.attachmentsPlaceholder=ko.computed(function(){return Utils.i18n("MAILBOX/SEARCH_FIELD_HAS_ATTACHMENTS")},this),_.delay(_.bind(function(){this.createDatePickerObject(this.searchDateStartDom()),this.createDatePickerObject(this.searchDateEndDom())},this),1e3),this.isCurrentAllowsMail=AppData.Accounts.isCurrentAllowsMail;var t=Utils.i18n("MAILBOX/INFO_ADDING_NEW_ACCOUNT").split(/%STARTLINK%|%ENDLINK%/);this.sAddingInfo1=t.length>0?t[0]:"",this.sAddingInfo2=t.length>1?t[1]:"",this.sAddingInfo3=t.length>2?t[2]:""}function CMessagePaneViewModel(e){this.openMessageInNewWindowBinded=e,this.singleMode=ko.observable(AppData.SingleMode),this.isLoading=ko.observable(!1),App.MailCache.folderList.subscribe(this.onFolderListSubscribe,this),this.messages=App.MailCache.messages,this.messages.subscribe(this.onMessagesSubscribe,this),this.currentMessage=App.MailCache.currentMessage,this.currentMessage.subscribe(this.onCurrentMessageSubscribe,this),AppData.User.defaultTimeFormat.subscribe(this.onCurrentMessageSubscribe,this),this.displayedMessageUid=ko.observable(""),this.isCurrentMessage=ko.computed(function(){return!!this.currentMessage()},this),this.isCurrentMessageLoaded=ko.computed(function(){return this.isCurrentMessage()&&!this.isLoading()},this),this.visibleNoMessageSelectedText=ko.computed(function(){return this.messages().length>0&&!this.isCurrentMessage()},this),this.prevMessageUid=App.MailCache.prevMessageUid,this.nextMessageUid=App.MailCache.nextMessageUid,this.isEnablePrevMessage=ko.computed(function(){return"string"==typeof this.prevMessageUid()&&""!==this.prevMessageUid()},this),this.isEnableNextMessage=ko.computed(function(){return"string"==typeof this.nextMessageUid()&&""!==this.nextMessageUid()},this),this.isEnableDelete=this.isCurrentMessage,this.isEnableReply=this.isCurrentMessageLoaded,this.isEnableReplyAll=this.isCurrentMessageLoaded,this.isEnableResend=this.isCurrentMessageLoaded,this.isEnableForward=this.isCurrentMessageLoaded,
this.isEnablePrint=this.isCurrentMessageLoaded,this.isEnableSave=this.isCurrentMessage,this.allowSaveAsPdf=ko.observable(!!AppData.AllowSaveAsPdf),this.isEnableSaveAsPdf=ko.computed(function(){return this.isCurrentMessageLoaded()&&this.allowSaveAsPdf()},this),this.allowForwardAsAttachment=ko.observable(!0),this.isEnableForwardAsAttachment=ko.computed(function(){return this.isCurrentMessageLoaded()&&this.allowForwardAsAttachment()},this),this.deleteCommand=Utils.createCommand(this,this.executeDeleteMessage,this.isEnableDelete),this.prevMessageCommand=Utils.createCommand(this,this.executePrevMessage,this.isEnablePrevMessage),this.nextMessageCommand=Utils.createCommand(this,this.executeNextMessage,this.isEnableNextMessage),this.replyCommand=Utils.createCommand(this,this.executeReply,this.isEnableReply),this.replyAllCommand=Utils.createCommand(this,this.executeReplyAll,this.isEnableReplyAll),this.resendCommand=Utils.createCommand(this,this.executeResend,this.isEnableResend),this.forwardCommand=Utils.createCommand(this,this.executeForward,this.isEnableForward),this.printCommand=Utils.createCommand(this,this.executePrint,this.isEnablePrint),this.saveCommand=Utils.createCommand(this,this.executeSave,this.isEnableSave),this.saveAsPdfCommand=Utils.createCommand(this,this.executeSaveAsPdf,this.isEnableSaveAsPdf),this.forwardAsAttachment=Utils.createCommand(this,this.executeForwardAsAttachment,this.isEnableForwardAsAttachment),this.moreCommand=Utils.createCommand(this,null,this.isCurrentMessageLoaded),this.ical=ko.observable(null),this.icalSubscription=this.ical.subscribe(function(){null!==this.ical()&&(App.CalendarCache.firstRequestCalendarList(),this.icalSubscription.dispose())},this),this.vcard=ko.observable(null),this.visiblePicturesControl=ko.observable(!1),this.visibleShowPicturesLink=ko.observable(!1),this.visibleAppointmentInfo=ko.computed(function(){return null!==this.ical()},this),this.visibleVcardInfo=ko.computed(function(){return null!==this.vcard()},this),this.sensitivityText=ko.computed(function(){var e="";if(this.currentMessage())switch(this.currentMessage().sensitivity()){case Enums.Sensitivity.Confidential:e=Utils.i18n("MESSAGE/SENSITIVITY_CONFIDENTIAL");break;case Enums.Sensitivity.Personal:e=Utils.i18n("MESSAGE/SENSITIVITY_PERSONAL");break;case Enums.Sensitivity.Private:e=Utils.i18n("MESSAGE/SENSITIVITY_PRIVATE")}return e},this),this.visibleConfirmationControl=ko.computed(function(){return this.currentMessage()&&""!==this.currentMessage().readingConfirmation()},this),this.isCurrentNotDraftOrSent=ko.computed(function(){var e=App.MailCache.folderList().currentFolder();return e&&e.fullName().length>0&&e.type()!==Enums.FolderTypes.Drafts&&e.type()!==Enums.FolderTypes.Sent},this),this.isCurrentSentFolder=ko.computed(function(){var e=App.MailCache.folderList().currentFolder();return e&&e.fullName().length>0&&e.type()===Enums.FolderTypes.Sent},this),this.isCurrentNotDraftFolder=ko.computed(function(){var e=App.MailCache.folderList().currentFolder();return e&&e.fullName().length>0&&e.type()!==Enums.FolderTypes.Drafts},this),this.isVisibleReplyTool=this.isCurrentNotDraftOrSent,this.isVisibleResendTool=this.isCurrentSentFolder,this.isVisibleForwardTool=this.isCurrentNotDraftFolder,this.uid=ko.observable(""),this.folder=ko.observable(""),this.folder.subscribe(function(){this.jqPanelHelper&&this.jqPanelHelper.trigger("resize",[null,"min",null,!0])},this),this.subject=ko.observable(""),this.emptySubject=ko.computed(function(){return""===Utils.trim(this.subject())},this),this.subjectForDisplay=ko.computed(function(){return this.emptySubject()?Utils.i18n("MAILBOX/EMPTY_SUBJECT"):this.subject()},this),this.importance=ko.observable(Enums.Importance.Normal),this.oFromAddr=ko.observable(null),this.from=ko.observable(""),this.fromEmail=ko.observable(""),this.fullFrom=ko.observable(""),this.to=ko.observable(""),this.aToAddr=ko.observableArray([]),this.cc=ko.observable(""),this.aCcAddr=ko.observableArray([]),this.bcc=ko.observable(""),this.aBccAddr=ko.observableArray([]),this.allRecipients=ko.observable(""),this.aAllRecipients=ko.observableArray([]),this.recipientsContacts=ko.observableArray([]),this.currentAccountEmail=ko.observable(),this.meSender=Utils.i18n("MESSAGE/ME_SENDER"),this.meRecipient=Utils.i18n("MESSAGE/ME_RECIPIENT"),this.fullDate=ko.observable(""),this.midDate=ko.observable(""),this.textBody=ko.observable(""),this.textBodyForNewWindow=ko.observable(""),this.domTextBody=ko.observable(null),this.rtlMessage=ko.observable(!1),this.contentHasFocus=ko.observable(!1),this.decryptPassword=ko.observable(""),this.visibleDecryptControl=ko.observable(!1),this.visibleVerifyControl=ko.observable(!1),this.fakeHeader=ko.computed(function(){return!(this.visiblePicturesControl()||this.visibleConfirmationControl()||""!==this.sensitivityText()||this.visibleDecryptControl()||this.visibleVerifyControl())},this),this.mobileApp=bMobileApp,this.attachments=ko.observableArray([]),this.usesAttachmentString=!0,this.attachmentsInString=ko.computed(function(){return _.map(this.attachments(),function(e){return e.fileName()},this).join(", ")},this),this.notInlineAttachments=ko.computed(function(){return _.filter(this.attachments(),function(e){return!e.linked()})},this),this.visibleDownloadAllAttachments=ko.computed(function(){return AppData.ZipAttachments&&this.notInlineAttachments().length>1},this),this.visibleSaveAttachmentsToFiles=AppData.User.IsFilesSupported,this.visibleDownloadAllAttachmentsSeparately=ko.computed(function(){return this.notInlineAttachments().length>1},this),this.visibleExtendedDownload=ko.computed(function(){return!this.mobileApp&&(this.visibleDownloadAllAttachments()||this.visibleDownloadAllAttachmentsSeparately()||this.visibleSaveAttachmentsToFiles)},this),this.detailsVisible=ko.observable("1"===App.Storage.getData("MessageDetailsVisible")),this.detailsTooltip=ko.computed(function(){return this.detailsVisible()?Utils.i18n("MESSAGE/ACTION_HIDE_DETAILS"):Utils.i18n("MESSAGE/ACTION_SHOW_DETAILS")},this),this.hasNotInlineAttachments=ko.computed(function(){return this.notInlineAttachments().length>0},this),this.hasBodyText=ko.computed(function(){return this.textBody().length>0},this),this.visibleAddMenu=ko.observable(!1),this.replyText=ko.observable(""),this.replyTextFocus=ko.observable(!1),this.replyPaneVisible=ko.computed(function(){return this.currentMessage()&&this.currentMessage().completelyFilled()},this),this.replySendingStarted=ko.observable(!1),this.replySavingStarted=ko.observable(!1),this.replyAutoSavingStarted=ko.observable(!1),this.requiresPostponedSending=ko.observable(!1),this.replyAutoSavingStarted.subscribe(function(){!this.replyAutoSavingStarted()&&this.requiresPostponedSending()&&(App.MessageSender.sendPostponedMail(this.replyDraftUid()),this.requiresPostponedSending(!1))},this),ko.computed(function(){(!this.replyTextFocus()||this.replyAutoSavingStarted()||this.replySavingStarted()||this.replySendingStarted())&&this.stopAutosaveTimer(),!this.replyTextFocus()||this.replyAutoSavingStarted()||this.replySavingStarted()||this.replySendingStarted()||this.startAutosaveTimer()},this),this.saveButtonText=ko.computed(function(){return this.replyAutoSavingStarted()?Utils.i18n("COMPOSE/TOOL_SAVING"):Utils.i18n("COMPOSE/TOOL_SAVE")},this),this.replyDraftUid=ko.observable(""),this.replyLoadingText=ko.computed(function(){return this.replySendingStarted()?Utils.i18n("COMPOSE/INFO_SENDING"):this.replySavingStarted()?Utils.i18n("COMPOSE/INFO_SAVING"):""},this),this.isEnableSendQuickReply=ko.computed(function(){return this.isCurrentMessageLoaded()&&""!==this.replyText()&&!this.replySendingStarted()},this),this.isEnableSaveQuickReply=ko.computed(function(){return this.isEnableSendQuickReply()&&!this.replySavingStarted()&&!this.replyAutoSavingStarted()},this),this.saveQuickReplyCommand=Utils.createCommand(this,this.executeSaveQuickReply,this.isEnableSaveQuickReply),this.sendQuickReplyCommand=Utils.createCommand(this,this.executeSendQuickReplyCommand,this.isEnableSendQuickReply),this.domMessageHeader=ko.observable(null),this.domQuickReply=ko.observable(null),this.domMessageForPrint=ko.observable(null),this.replyTextFocusThrottled=ko.observable(!1).extend({throttle:50}),this.replyTextFocus.subscribe(function(){this.replyTextFocusThrottled(this.replyTextFocus())},this),this.isQuickReplyActive=ko.computed(function(){return this.replyText().length>0||this.replyTextFocusThrottled()},this),this.jqPanelHelper=null,this.visibleAttachments=ko.observable(!1),this.showMessage=function(){this.visibleAttachments(!1)},this.showAttachments=function(){this.visibleAttachments(!0)},this.defaultFontName=AppData.User.DefaultFontName,App.nowDateNumber&&App.nowDateNumber.subscribe(function(){this.updateMomentDate()},this),AfterLogicApi.runPluginHook&&AfterLogicApi.runPluginHook("view-model-defined",[this.__name,this])}function CMailViewModel(){this.folderList=App.MailCache.folderList,this.domFolderList=ko.observable(null),this.openMessageInNewWindowBinded=_.bind(this.openMessageInNewWindow,this),this.oFolderList=new CFolderListViewModel,this.oMessageList=new CMessageListViewModel(this.openMessageInNewWindowBinded),this.oMessagePane=new CMessagePaneViewModel(this.openMessageInNewWindowBinded),this.isEnableGroupOperations=this.oMessageList.isEnableGroupOperations,this.composeLink=ko.observable(App.Routing.buildHashFromArray(App.Links.compose())),this.composeCommand=Utils.createCommand(this,this.executeCompose,AppData.Accounts.isCurrentAllowsMail),this.checkMailCommand=Utils.createCommand(this,this.executeCheckMail,AppData.Accounts.isCurrentAllowsMail),this.checkMailIndicator=ko.observable(!0).extend({throttle:50}),ko.computed(function(){this.checkMailIndicator(App.MailCache.checkMailStarted()||App.MailCache.messagesLoading())},this),this.markAsReadCommand=Utils.createCommand(this.oMessageList,this.oMessageList.executeMarkAsRead,this.isEnableGroupOperations),this.markAsUnreadCommand=Utils.createCommand(this.oMessageList,this.oMessageList.executeMarkAsUnread,this.isEnableGroupOperations),this.markAllReadCommand=Utils.createCommand(this.oMessageList,this.oMessageList.executeMarkAllRead),this.moveToFolderCommand=Utils.createCommand(this,Utils.emptyFunction,this.isEnableGroupOperations),this.deleteCommand=Utils.createCommand(this.oMessageList,this.oMessageList.executeDelete,this.isEnableGroupOperations),this.selectedCount=ko.computed(function(){return this.oMessageList.checkedUids().length},this),this.emptyTrashCommand=Utils.createCommand(App.MailCache,App.MailCache.executeEmptyTrash,this.oMessageList.isNotEmptyList),this.emptySpamCommand=Utils.createCommand(App.MailCache,App.MailCache.executeEmptySpam,this.oMessageList.isNotEmptyList),this.spamCommand=Utils.createCommand(this.oMessageList,this.oMessageList.executeSpam,this.isEnableGroupOperations),this.notSpamCommand=Utils.createCommand(this.oMessageList,this.oMessageList.executeNotSpam,this.isEnableGroupOperations),this.bVisibleComposeMessage=AppData.User.AllowCompose,this.isVisibleReplyTool=ko.computed(function(){return this.folderList().currentFolder()&&this.folderList().currentFolderFullName().length>0&&this.folderList().currentFolderType()!==Enums.FolderTypes.Drafts&&this.folderList().currentFolderType()!==Enums.FolderTypes.Sent},this),this.isVisibleForwardTool=ko.computed(function(){return this.folderList().currentFolder()&&this.folderList().currentFolderFullName().length>0&&this.folderList().currentFolderType()!==Enums.FolderTypes.Drafts},this),this.isSpamFolder=ko.computed(function(){return this.folderList().currentFolderType()===Enums.FolderTypes.Spam},this),this.allowedSpamAction=ko.computed(function(){var e=AppData.Accounts.getCurrent();return!!this.folderList().spamFolder()&&!!e&&e.extensionExists("AllowSpamFolderExtension")&&!this.isSpamFolder()},this),this.allowedNotSpamAction=ko.computed(function(){var e=AppData.Accounts.getCurrent();return!!this.folderList().spamFolder()&&!!e&&e.extensionExists("AllowSpamFolderExtension")&&this.isSpamFolder()},this),this.isTrashFolder=ko.computed(function(){return this.folderList().currentFolderType()===Enums.FolderTypes.Trash},this),this.jqPanelHelper=null,this.mobileApp=bMobileApp,this.selectedPanel=ko.observable(Enums.MobilePanel.Items),App.MailCache.currentMessage.subscribe(function(){this.gotoMessagePane()},this)}function CComposeViewModel(){var e=this;this.toAddrDom=ko.observable(),this.toAddrDom.subscribe(function(){this.initInputosaurus(this.toAddrDom,this.toAddr,this.lockToAddr,"to")},this),this.ccAddrDom=ko.observable(),this.ccAddrDom.subscribe(function(){this.initInputosaurus(this.ccAddrDom,this.ccAddr,this.lockCcAddr,"cc")},this),this.bccAddrDom=ko.observable(),this.bccAddrDom.subscribe(function(){this.initInputosaurus(this.bccAddrDom,this.bccAddr,this.lockBccAddr,"bcc")},this),this.folderList=App.MailCache.folderList,this.folderList.subscribe(function(){this.getMessageOnRoute()},this),this.singleMode=ko.observable(AppData.SingleMode),this.isDemo=ko.observable(AppData.User.IsDemo),this.sending=ko.observable(!1),this.sending.subscribe(this.sendingAndSavingSubscription,this),this.saving=ko.observable(!1),this.saving.subscribe(this.sendingAndSavingSubscription,this),this.oHtmlEditor=new CHtmlEditorViewModel(!1,this),this.textFocused=this.oHtmlEditor.textFocused,this.visibleBcc=ko.observable(!1),this.visibleBcc.subscribe(function(){$html.toggleClass("screen-compose-bcc",this.visibleCc()),_.defer(_.bind(function(){$(this.bccAddrDom()).inputosaurus("resizeInput")},this))},this),this.visibleCc=ko.observable(!1),this.visibleCc.subscribe(function(){$html.toggleClass("screen-compose-cc",this.visibleCc()),_.defer(_.bind(function(){$(this.ccAddrDom()).inputosaurus("resizeInput")},this))},this),this.visibleCounter=ko.observable(!1),this.readingConfirmation=ko.observable(!1),this.saveMailInSentItems=ko.observable(!0),this.useSaveMailInSentItems=ko.observable(!1),this.composeUploaderButton=ko.observable(null),this.composeUploaderButton.subscribe(function(){this.initUploader()},this),this.composeUploaderDropPlace=ko.observable(null),this.composeUploaderBodyDragOver=ko.observable(!1),this.composeUploaderDragOver=ko.observable(!1),this.allowDragNDrop=ko.observable(!1),this.uploaderBodyDragOver=ko.computed(function(){return this.allowDragNDrop()&&this.composeUploaderBodyDragOver()},this),this.uploaderDragOver=ko.computed(function(){return this.allowDragNDrop()&&this.composeUploaderDragOver()},this),this.selectedImportance=ko.observable(Enums.Importance.Normal),this.selectedSensitivity=ko.observable(Enums.Sensitivity.Nothing),this.oSenderSelector=new CSenderSelector,this.senderAccountId=this.oSenderSelector.senderAccountId,this.senderList=this.oSenderSelector.senderList,this.visibleFrom=ko.computed(function(){return this.senderList().length>1},this),this.selectedSender=this.oSenderSelector.selectedSender,this.selectedFetcherOrIdentity=this.oSenderSelector.selectedFetcherOrIdentity,this.selectedFetcherOrIdentity.subscribe(function(){this.oHtmlEditor.isEditing()||this.oHtmlEditor.clearUndoRedo()},this),this.signature=ko.observable(""),this.prevSignature=ko.observable(null),ko.computed(function(){var e=App.MessageSender.getClearSignature(this.senderAccountId(),this.selectedFetcherOrIdentity());null===this.prevSignature()?(this.prevSignature(e),this.signature(e)):(this.prevSignature(this.signature()),this.signature(e),this.oHtmlEditor.changeSignatureContent(this.signature(),this.prevSignature()))},this),this.lockToAddr=ko.observable(!1),this.toAddr=ko.observable("").extend({reversible:!0}),this.toAddr.subscribe(function(){this.lockToAddr()||($(this.toAddrDom()).val(this.toAddr()),$(this.toAddrDom()).inputosaurus("refresh"))},this),this.lockCcAddr=ko.observable(!1),this.ccAddr=ko.observable("").extend({reversible:!0}),this.ccAddr.subscribe(function(){this.lockCcAddr()||($(this.ccAddrDom()).val(this.ccAddr()),$(this.ccAddrDom()).inputosaurus("refresh"))},this),this.lockBccAddr=ko.observable(!1),this.bccAddr=ko.observable("").extend({reversible:!0}),this.bccAddr.subscribe(function(){this.lockBccAddr()||($(this.bccAddrDom()).val(this.bccAddr()),$(this.bccAddrDom()).inputosaurus("refresh"))},this),this.recipientEmails=ko.computed(function(){var e=[this.toAddr(),this.ccAddr(),this.bccAddr()].join(",").split(","),t=[];return _.each(e,function(e){var i=Utils.trim(e),s=null;""!==i&&(s=Utils.Address.getEmailParts(i),s.email&&t.push(s.email))}),t},this),this.subject=ko.observable("").extend({reversible:!0}),this.counter=ko.observable(0),this.plainText=ko.observable(!1),this.textBody=ko.observable(""),this.textBody.subscribe(function(){this.oHtmlEditor.setText(this.textBody(),this.plainText()),this.oHtmlEditor.commit()},this),this.focusedField=ko.observable(""),this.textFocused.subscribe(function(){this.textFocused()&&this.focusedField("text")},this),this.subjectFocused=ko.observable(!1),this.subjectFocused.subscribe(function(){this.subjectFocused()&&this.focusedField("subject")},this),this.templateUid=ko.observable(""),this.templateFolderName=ko.observable(App.MailCache.getTemplateFolder()),this.draftUid=ko.observable(""),this.draftUid.subscribe(function(){App.MailCache.editedDraftUid(this.draftUid())},this),this.draftInfo=ko.observableArray([]),this.routeType=ko.observable(""),this.routeParams=ko.observableArray([]),this.inReplyTo=ko.observable(""),this.references=ko.observable(""),this.bUploadStatus=!1,this.iUploadAttachmentsTimer=0,this.messageUploadAttachmentsStarted=ko.observable(!1),this.messageUploadAttachmentsStarted.subscribe(function(t){window.clearTimeout(e.iUploadAttachmentsTimer),t?e.iUploadAttachmentsTimer=window.setTimeout(function(){e.bUploadStatus=!0,App.Api.showLoading(Utils.i18n("COMPOSE/INFO_ATTACHMENTS_LOADING"))},4e3):e.bUploadStatus?e.iUploadAttachmentsTimer=window.setTimeout(function(){e.bUploadStatus=!1,App.Api.hideLoading()},1e3):App.Api.hideLoading()},this),this.attachments=ko.observableArray([]),this.attachmentsChanged=ko.observable(!1),this.attachments.subscribe(function(){this.attachmentsChanged(!0)},this),this.notUploadedAttachments=ko.computed(function(){return _.filter(this.attachments(),function(e){return!e.uploaded()})},this),this.allAttachmentsUploaded=ko.computed(function(){return 0===this.notUploadedAttachments().length&&!this.messageUploadAttachmentsStarted()},this),this.notInlineAttachments=ko.computed(function(){return _.filter(this.attachments(),function(e){return!e.linked()})},this),this.notInlineAttachments.subscribe(function(){$html.toggleClass("screen-compose-attachments",this.notInlineAttachments().length>0)},this),this.allowStartSending=ko.computed(function(){return!this.saving()},this),this.allowStartSending.subscribe(function(){this.allowStartSending()&&this.requiresPostponedSending()&&(App.MessageSender.sendPostponedMail(this.draftUid()),this.requiresPostponedSending(!1))},this),this.requiresPostponedSending=ko.observable(!1),this.oJua=null,this.isDraftsCleared=ko.observable(!1),this.autoSaveTimer=-1,this.shown=ko.observable(!1),this.shown.subscribe(function(){this.shown()||this.stopAutosaveTimer()},this),this.backToListOnSendOrSave=ko.observable(!1),this.enableOpenPgp=AppData.User.enableOpenPgp,this.pgpSecured=ko.observable(!1),this.pgpSecured.subscribe(function(){this.oHtmlEditor.disabled(this.pgpSecured())},this),this.pgpEncrypted=ko.observable(!1),this.fromDrafts=ko.observable(!1),this.visibleDoPgpButton=ko.computed(function(){return this.enableOpenPgp()&&(!this.pgpSecured()||this.pgpEncrypted()&&this.fromDrafts())},this),this.visibleUndoPgpButton=ko.computed(function(){return this.enableOpenPgp()&&this.pgpSecured()&&(!this.pgpEncrypted()||!this.fromDrafts())},this),this.isEnableOpenPgpCommand=ko.computed(function(){return this.enableOpenPgp()&&!this.pgpSecured()},this),this.backToListCommand=Utils.createCommand(this,this.executeBackToList),this.sendCommand=Utils.createCommand(this,this.executeSend,this.isEnableSending),this.saveCommand=Utils.createCommand(this,this.executeSaveCommand,this.isEnableSaving),this.saveTemplateCommand=Utils.createCommand(this,this.executeTemplateSaveCommand,this.isEnableSaving),this.openPgpCommand=Utils.createCommand(this,this.confirmOpenPgp,this.isEnableOpenPgpCommand),this.messageFields=ko.observable(null),this.bottomPanel=ko.observable(null),this.mobileApp=bMobileApp,this.showHotkeysHints=!bMobileDevice&&!bMobileApp,this.aHotkeys=AppData.App.AllowComposeShortcuts?[{value:"Ctrl+Enter",action:Utils.i18n("COMPOSE/HOTKEY_SEND")},{value:"Ctrl+S",action:Utils.i18n("COMPOSE/HOTKEY_SAVE")},{value:"Ctrl+Z",action:Utils.i18n("COMPOSE/HOTKEY_UNDO")},{value:"Ctrl+Y",action:Utils.i18n("COMPOSE/HOTKEY_REDO")},{value:"Ctrl+K",action:Utils.i18n("COMPOSE/HOTKEY_LINK")},{value:"Ctrl+B",action:Utils.i18n("COMPOSE/HOTKEY_BOLD")},{value:"Ctrl+I",action:Utils.i18n("COMPOSE/HOTKEY_ITALIC")},{value:"Ctrl+U",action:Utils.i18n("COMPOSE/HOTKEY_UNDERLINE")}]:[],this.allowFiles=ko.observable(!1),this.closeBecauseSingleCompose=ko.observable(!1),this.changedInPreviousWindow=ko.observable(!1),this.minHeightAdjustTrigger=ko.observable(!1).extend({autoResetToFalse:105}),this.minHeightRemoveTrigger=ko.observable(!1).extend({autoResetToFalse:105}),this.jqContainers=$(".pSevenMain:first, .popup.compose_popup"),ko.computed(function(){this.minHeightAdjustTrigger(),this.minHeightRemoveTrigger(),_.delay(function(){$(".compose_popup .panel_content .panels").trigger("resize")},200)},this),this.hasSomethingToSave=ko.computed(function(){return this.isChanged()&&this.isEnableSaving()},this),this.saveAndCloseTooltip=ko.computed(function(){return this.hasSomethingToSave()?Utils.i18n("COMPOSE/TOOL_SAVE_CLOSE"):Utils.i18n("COMPOSE/TOOL_CLOSE")},this),window.opener&&setTimeout(function(){window.onbeforeunload=function(){if(e.hasSomethingToSave())return e.beforeHide(window.close),""}},1e3),this.splitterDom=ko.observable(),this.fromToExpandColapssed=ko.observable(!1),AfterLogicApi.runPluginHook&&AfterLogicApi.runPluginHook("view-model-defined",[this.__name,this])}function CSenderSelector(){this.senderList=ko.observableArray([]),this.senderAccountId=ko.observable(AppData.Accounts.currentId()),this.selectedFetcherOrIdentity=ko.observable(null),this.lockSelectedSender=ko.observable(!1),this.selectedSender=ko.observable(""),this.selectedSender.subscribe(function(){if(!this.lockSelectedSender()){var e=AppData.Accounts.getAccount(this.senderAccountId()),t=this.selectedSender(),i=null;0===t.indexOf("fetcher")?e.fetchers()&&(t=t.replace("fetcher",""),i=_.find(e.fetchers().collection(),function(e){return e.id()===Utils.pInt(t)})):i=_.find(e.identities(),function(e){return e.id()===Utils.pInt(t)}),i&&this.selectedFetcherOrIdentity(i)}},this)}function ComposePopup(){CComposeViewModel.call(this),this.minimized=ko.observable(!1),this.fPreventBackspace=function(e){var t=e.which===$.ui.keyCode.BACKSPACE,i="INPUT"===e.target.tagName||"TEXTAREA"===e.target.tagName,s="DIV"===e.target.tagName&&"true"===$(e.target).attr("contenteditable");!t||i||s||(e.preventDefault(),e.stopPropagation())},this.minimized.subscribe(function(){this.minimized()?this.preventBackspaceOff():this.shown()&&this.preventBackspaceOn()},this),this.minimizedTitle=ko.computed(function(){return this.subject()||Utils.i18n("COMPOSE/TITLE_MINIMIZED_NEW_MESSAGE")},this)}function CContactsImportViewModel(e){this.oJua=null,this.oParent=e,this.visibility=ko.observable(!1),this.importing=ko.observable(!1)}function CContactsViewModel(){this.isPublic=bExtApp,this.contactCount=ko.observable(0),this.uploaderArea=ko.observable(null),this.bDragActive=ko.observable(!1),this.bDragActiveComp=ko.computed(function(){return this.bDragActive()},this),this.importingHelpLink=App.getHelpLink("ImportingContacts"),this.allowSendEmails=ko.computed(function(){return AppData.App.AllowWebMail&&AppData.Accounts.isCurrentAllowsMail()},this),this.loadingList=ko.observable(!1),this.preLoadingList=ko.observable(!1),this.loadingList.subscribe(function(e){this.preLoadingList(e)},this),this.loadingViewPane=ko.observable(!1),this.showPersonalContacts=ko.observable(!1),this.showGlobalContacts=ko.observable(!1),this.showSharedToAllContacts=ko.observable(!1),this.showAllContacts=ko.computed(function(){return 1<[this.showPersonalContacts()?"1":"",this.showGlobalContacts()?"1":"",this.showSharedToAllContacts()?"1":""].join("").length},this),this.recivedAnimShare=ko.observable(!1).extend({autoResetToFalse:500}),this.recivedAnimUnshare=ko.observable(!1).extend({autoResetToFalse:500}),this.isGlobalGroupSelect=ko.observable(!0),this.isAllOrSubOrGlobalGroupSelect=ko.observable(!0),this.selectedGroupType=ko.observable(Enums.ContactsGroupListType.Personal),this.selectedGroupType.subscribe(function(e){this.isGlobalGroupSelect(e===Enums.ContactsGroupListType.Global),this.isAllOrSubOrGlobalGroupSelect(e===Enums.ContactsGroupListType.SubGroup||e===Enums.ContactsGroupListType.Global||e===Enums.ContactsGroupListType.All)},this),this.selectedGroupInList=ko.observable(null),this.selectedGroupInList.subscribe(function(){var e=this.selectedGroupInList();e&&e.selected(!1)},this,"beforeChange"),this.selectedGroupInList.subscribe(function(e){e&&this.showPersonalContacts()&&(e.selected(!0),this.selectedGroupType(Enums.ContactsGroupListType.SubGroup),this.requestContactList())},this),this.selectedGroup=ko.observable(null),this.selectedContact=ko.observable(null),this.selectedGroupContactsList=ko.observable(null),this.currentGroupId=ko.observable(""),this.oContactModel=new CContactModel,this.oGroupModel=new CGroupModel,this.oContactImportViewModel=new CContactsImportViewModel(this),this.selectedOldItem=ko.observable(null),this.selectedItem=ko.computed({read:function(){return this.selectedContact()||this.selectedGroup()||null},write:function(e){e instanceof CContactModel?(this.oContactImportViewModel.visibility(!1),this.selectedGroup(null),this.selectedContact(e)):e instanceof CGroupModel?(this.oContactImportViewModel.visibility(!1),this.selectedContact(null),this.selectedGroup(e),this.currentGroupId(e.idGroup())):(this.selectedGroup(null),this.selectedContact(null)),this.loadingViewPane(!1)},owner:this}),this.sortOrder=ko.observable(!0),this.sortType=ko.observable(Enums.ContactSortType.Name),this.collection=ko.observableArray([]),this.contactUidForRequest=ko.observable(""),this.collection.subscribe(function(){this.collection().length>0&&""!==this.contactUidForRequest()&&(this.requestContact(this.contactUidForRequest()),this.contactUidForRequest(""))},this),this.isSearchFocused=ko.observable(!1),this.searchInput=ko.observable(""),this.search=ko.observable(""),this.groupFullCollection=ko.observableArray([]),this.selectedContact.subscribe(function(e){if(e){var t=e.groups();_.each(this.groupFullCollection(),function(e){e.checked(e&&0<=Utils.inArray(e.Id(),t))})}},this),this.selectedGroupType.subscribe(function(e){Enums.ContactsGroupListType.All!==e||this.showAllContacts()?Enums.ContactsGroupListType.Personal===e&&!this.showPersonalContacts()&&this.showGlobalContacts()?this.selectedGroupType(Enums.ContactsGroupListType.Global):Enums.ContactsGroupListType.Global===e&&!this.showGlobalContacts()&&this.showPersonalContacts()?this.selectedGroupType(Enums.ContactsGroupListType.Personal):Enums.ContactsGroupListType.Personal!==e&&Enums.ContactsGroupListType.Global!==e&&Enums.ContactsGroupListType.SharedToAll!==e&&Enums.ContactsGroupListType.All!==e||(this.selectedGroupInList(null),this.selectedItem(null),this.selector.listCheckedOrSelected(!1),this.requestContactList()):this.selectedGroupType(Enums.ContactsGroupListType.Personal)},this),this.pageSwitcherLocked=ko.observable(!1),this.oPageSwitcher=new CPageSwitcherViewModel(0,AppData.User.ContactsPerPage),this.oPageSwitcher.currentPage.subscribe(function(){var e=this.selectedGroupType(),t=e===Enums.ContactsGroupListType.SubGroup?this.currentGroupId():"";this.pageSwitcherLocked()||App.Routing.setHash(App.Links.contacts(e,t,this.search(),this.oPageSwitcher.currentPage()))},this),this.currentPage=ko.observable(1),this.search.subscribe(function(e){this.searchInput(e)},this),this.searchSubmitCommand=Utils.createCommand(this,function(){var e=this.selectedGroupType(),t=e===Enums.ContactsGroupListType.SubGroup?this.currentGroupId():"";App.Routing.setHash(App.Links.contacts(e,t,this.searchInput()))}),this.selector=new CSelector(this.collection,_.bind(function(e){if(e){var t=this.selectedGroupType(),i=t===Enums.ContactsGroupListType.SubGroup?this.currentGroupId():"";App.Routing.setHash(App.Links.contacts(t,i,this.search(),this.oPageSwitcher.currentPage(),e.sId))}},this),_.bind(this.executeDelete,this),_.bind(this.onContactDblClick,this)),this.checkAll=this.selector.koCheckAll(),this.checkAllIncomplite=this.selector.koCheckAllIncomplete(),this.allowContactsSharing=!!AppData.App.AllowContactsSharing,this.isCheckedOrSelected=ko.computed(function(){return 0<this.selector.listCheckedOrSelected().length},this),this.isEnableAddContacts=this.isCheckedOrSelected,this.isEnableRemoveContactsFromGroup=this.isCheckedOrSelected,this.isEnableDeleting=this.isCheckedOrSelected,this.isEnableSharing=this.isCheckedOrSelected,this.visibleShareCommand=ko.computed(function(){return this.showPersonalContacts()&&this.showSharedToAllContacts()&&this.selectedGroupType()===Enums.ContactsGroupListType.Personal},this),this.visibleUnshareCommand=ko.computed(function(){return this.showPersonalContacts()&&this.showSharedToAllContacts()&&this.selectedGroupType()===Enums.ContactsGroupListType.SharedToAll},this),this.isSelectedGroupTypeNotGlobal=ko.computed(function(){return this.selectedGroupType()!==Enums.ContactsGroupListType.Global},this),this.isExport=ko.computed(function(){return this.contactCount()},this),this.newContactCommand=Utils.createCommand(this,this.executeNewContact,this.isSelectedGroupTypeNotGlobal),this.newGroupCommand=Utils.createCommand(this,this.executeNewGroup),this.addContactsCommand=Utils.createCommand(this,Utils.emptyFunction,this.isEnableAddContacts),this.deleteCommand=Utils.createCommand(this,this.executeDelete,this.isEnableDeleting),this.shareCommand=Utils.createCommand(this,this.executeShare,this.isEnableSharing),this.removeFromGroupCommand=Utils.createCommand(this,this.executeRemoveFromGroup,this.isEnableRemoveContactsFromGroup),this.importCommand=Utils.createCommand(this,this.executeImport),this.exportCSVCommand=Utils.createCommand(this,this.executeCSVExport,this.isExport),this.exportVCFCommand=Utils.createCommand(this,this.executeVCFExport,this.isExport),this.saveCommand=Utils.createCommand(this,this.executeSave),this.updateSharedToAllCommand=Utils.createCommand(this,this.executeUpdateSharedToAll,function(){return 1===this.selector.listCheckedOrSelected().length}),this.newMessageCommand=Utils.createCommand(this,function(){var e=this.selector.listCheckedOrSelected(),t=[];_.isArray(e)&&0<e.length&&(t=_.map(e,function(e){return e.EmailAndName()}),t=_.compact(t),App.Api.composeMessageToAddresses(t.join(", ")))},function(){return 0<this.selector.listCheckedOrSelected().length}),this.selector.listCheckedOrSelected.subscribe(function(e){this.oGroupModel.newContactsInGroupCount(e.length)},this),this.isSearch=ko.computed(function(){return""!==this.search()},this),this.isEmptyList=ko.computed(function(){return 0===this.collection().length},this),this.inGroup=ko.computed(function(){return Enums.ContactsGroupListType.SubGroup===this.selectedGroupType()},this),this.searchText=ko.computed(function(){return Utils.i18n("CONTACTS/INFO_SEARCH_RESULT",{SEARCH:this.search()})},this),this.mobileApp=bMobileApp,this.selectedPanel=ko.observable(Enums.MobilePanel.Items),this.selectedItem.subscribe(function(){var e=this.selectedItem()&&this.selectedItem()instanceof CGroupModel&&!this.selectedItem().isNew();this.selectedItem()&&!e?this.gotoViewPane():this.gotoContactList()},this)}function CSettingsViewModel(){this.aTabs=ko.observableArray([]),this.aHiddenTabs=ko.observableArray([]),AppData.App.AllowUsersChangeInterfaceSettings&&this.aTabs.push(new CCommonSettingsViewModel),AppData.App.AllowWebMail&&this.aTabs.push(new CEmailAccountsSettingsViewModel),
AppData.App.AllowUsersChangeInterfaceSettings&&AppData.User.AllowCalendar&&this.aTabs.push(new CCalendarSettingsViewModel),AppData.User.IsFilesSupported&&this.aTabs.push(new CCloudStorageSettingsViewModel),AppData.User.MobileSyncEnable&&this.aTabs.push(new CMobileSyncSettingsViewModel),AppData.User.OutlookSyncEnable&&this.aTabs.push(new COutLookSyncSettingsViewModel),AppData.User.IsHelpdeskSupported&&this.aTabs.push(new CHelpdeskSettingsViewModel),AppData.App.AllowOpenPgp&&this.aTabs.push(new CPgpSettingsViewModel),AfterLogicApi&&AfterLogicApi.getPluginsSettingsTabs&&_.each(AfterLogicApi.getPluginsSettingsTabs(),_.bind(function(e){this.aTabs.push(new e)},this)),this.tab=ko.observable(Enums.SettingsTab.Common),AppData.Accounts.currentId.subscribe(function(){App.Routing.lastSettingsHash(Enums.Screens.Settings)},this),this.allowFolderListOrder=ko.computed(function(){var e=AppData.Accounts.getEdited();return!!e&&!e.extensionExists("DisableFoldersManualSort")},this),this.folderListOrderUpdateDebounce=_.debounce(_.bind(this.folderListOrderUpdate,this),3e3),this.afterSortableFolderMoveBinded=_.bind(this.afterSortableFolderMove,this),AfterLogicApi.runPluginHook&&AfterLogicApi.runPluginHook("view-model-defined",[this.__name,this])}function CCommonSettingsViewModel(){this.allowWebMail=AppData.App.AllowWebMail,this.isRtl=Utils.isRTL(),this.aSkins=AppData.App.Themes,this.selectedSkin=ko.observable(AppData.User.DefaultTheme),this.aLanguages=AppData.App.Languages,this.selectedLanguage=ko.observable(AppData.User.DefaultLanguage),this.loading=ko.observable(!1),this.rangeOfNumbers=[10,20,30,50,75,100,150,200],this.messagesPerPageValues=ko.observableArray(this.rangeOfNumbers),this.messagesPerPage=ko.observable(this.rangeOfNumbers[0]),this.setMessagesPerPage(AppData.User.MailsPerPage),this.contactsPerPageValues=ko.observableArray(this.rangeOfNumbers),this.contactsPerPage=ko.observable(this.rangeOfNumbers[0]),this.setContactsPerPage(AppData.User.ContactsPerPage),this.autocheckmailInterval=ko.observable(AppData.User.AutoCheckMailInterval),this.timeFormat=ko.observable(AppData.User.defaultTimeFormat()),this.aDateFormats=Utils.getDateFormatsForSelector(),this.dateFormat=ko.observable(AppData.User.DefaultDateFormat),this.useThreads=ko.observable(AppData.User.useThreads()),this.saveRepliedToCurrFolder=ko.observable(AppData.User.SaveRepliedToCurrFolder),this.allowChangeInputDirection=ko.observable(AppData.User.AllowChangeInputDirection),this.desktopNotifications=ko.observable(AppData.User.DesktopNotifications),this.desktopNotifications.subscribe(function(e){var t=this;e&&"default"===window.Notification.permission&&window.Notification.requestPermission(function(e){"denied"===e&&(t.desktopNotifications(!1),t.desktopNotificationsIsEnable(!1))})},this),this.desktopNotificationsIsEnable=ko.observable(window.Notification&&"denied"!==window.Notification.permission),this.isMailto=ko.observable(App.browser.firefox||App.browser.chrome),this.emailNotification=ko.observable(AppData.User.EmailNotification),this.aAccountsEmails=AppData.Accounts.getAccountsEmails(),this.defaultAccount=AppData.Accounts.getDefault(),this.defaultAccountCanBeRemoved=ko.computed(function(){return this.defaultAccount.canBeRemoved()},this),this.defaultAccountRemoveHint=ko.computed(function(){return this.defaultAccount.removeHint()},this),this.bAllowContacts=AppData.User.ShowContacts,this.bAllowCalendar=AppData.User.AllowCalendar,this.bAllowThreads=AppData.User.ThreadsEnabled,this.firstState=this.getState()}function CEmailAccountsSettingsViewModel(){this.bShown=!1,this.accounts=AppData.Accounts.collection,this.onlyOneAccount=ko.computed(function(){var e=1===this.accounts().length&&!AppData.App.AllowUsersAddNewAccounts;return e&&(this.TabTitle=Utils.i18n("SETTINGS/TAB_EMAIL_ACCOUNT")),e},this),this.title=ko.computed(function(){return this.onlyOneAccount()?Utils.i18n("SETTINGS/TITLE_EMAIL_ACCOUNT"):Utils.i18n("SETTINGS/TITLE_EMAIL_ACCOUNTS")},this),this.currentAccountId=AppData.Accounts.currentId,this.editedAccountId=AppData.Accounts.editedId,this.defaultAccountId=AppData.Accounts.defaultId,this.defaultAccount=AppData.Accounts.getDefault(),this.isAllowMail=ko.observable(!0),this.isAllowFetcher=!!AppData.User.AllowFetcher,this.isAllowIdentities=!!AppData.AllowIdentities,this.oAccountProperties=new CAccountPropertiesViewModel(this),this.oAccountSignature=new CAccountSignatureViewModel(this),this.oAccountFilters=new CAccountFiltersViewModel(this),this.oAccountAutoresponder=new CAccountAutoresponderViewModel(this),this.oAccountForward=new CAccountForwardViewModel(this),this.oAccountFolders=new CAccountFoldersViewModel(this),this.oFetcherIncoming=new CFetcherIncomingViewModel(this),this.oFetcherOutgoing=new CFetcherOutgoingViewModel(this),this.oFetcherSignature=new CFetcherSignatureViewModel(this),this.oIdentityProperties=new CIdentityPropertiesViewModel(this,!1),this.fetcher=ko.observable(null),this.fetchers=ko.observable(null),this.firstFetcher=ko.observable(null),this.editedFetcherId=ko.observable(null),this.editedIdentityId=ko.observable(null),this.defaultAccount.fetchers.subscribe(function(e){if(e){var t=this.defaultAccount.fetchers(),i=t.collection()[0],s=i.id(),o=this.isFetcherTab(this.tab());this.fetchers(t),this.firstFetcher(i),o&&!t.hasFetcher(this.editedFetcherId())&&(this.editedFetcherId(s),this.editedIdentityId(null),this.onChangeFetcher(s))}else this.onChangeAccount(this.defaultAccountId())},this),this.allowProperties=ko.observable(!0),this.tab=ko.observable(Enums.AccountSettingsTab.Properties),this.allowUsersAddNewAccounts=AppData.App.AllowUsersAddNewAccounts,this.allowUsersChangeInterfaceSettings=AppData.App.AllowUsersChangeInterfaceSettings,this.allowAutoresponderExtension=ko.observable(!1),this.allowForwardExtension=ko.observable(!1),this.allowSieveFiltersExtension=ko.observable(!1),this.onChangeAccount(this.editedAccountId())}function CCalendarSettingsViewModel(){this.showWeekends=ko.observable(AppData.User.CalendarShowWeekEnds),this.loading=ko.observable(!1),this.availableTimes=ko.observableArray(Utils.Calendar.getTimeListStepHour(AppData.User.defaultTimeFormat()!==Enums.TimeFormat.F24?"hh:mm A":"HH:mm")),AppData.User.defaultTimeFormat.subscribe(function(){this.availableTimes(Utils.Calendar.getTimeListStepHour(AppData.User.defaultTimeFormat()!==Enums.TimeFormat.F24?"hh:mm A":"HH:mm"))},this),this.selectedWorkdayStarts=ko.observable(AppData.User.CalendarWorkDayStarts),this.selectedWorkdayEnds=ko.observable(AppData.User.CalendarWorkDayEnds),this.showWorkday=ko.observable(AppData.User.CalendarShowWorkDay),this.weekStartsOn=ko.observable(AppData.User.CalendarWeekStartsOn),this.defaultTab=ko.observable(AppData.User.CalendarDefaultTab),this.firstState=this.getState()}function CMobileSyncSettingsViewModel(){this.mobileSync=AppData.User.mobileSync,this.mobileSync.subscribe(this.onMobileSyncSubscribe,this),this.oResetPasswordViewModel=new CResetPasswordViewModel,this.enableDav=ko.observable(!1),this.davLogin=ko.observable(""),this.davServer=ko.observable(""),this.appPath=Utils.Common.getAppPath(),this.davCalendars=ko.observable([]),this.visibleCalendars=ko.computed(function(){return this.davCalendars().length>0},this),this.davPersonalContactsUrl=ko.observable(""),this.davCollectedAddressesUrl=ko.observable(""),this.davGlobalAddressBookUrl=ko.observable(""),this.davSharedWithAllUrl=ko.observable(""),this.bVisiblePersonalContacts=AppData.User.ShowPersonalContacts,this.bVisibleGlobalContacts=AppData.User.ShowGlobalContacts,this.bVisibleSharedWithAllContacts=!!AppData.App.AllowContactsSharing,this.bVisibleContacts=AppData.User.ShowContacts,this.bVisibleCalendar=AppData.User.AllowCalendar,this.bVisibleFiles=AppData.User.IsFilesSupported,this.bVisibleIosLink=bIsIosDevice,this.visibleDavViaUrls=ko.computed(function(){return this.visibleCalendars()||this.bVisibleContacts},this),this.bChanged=!1,this.isDemo=AppData.User.IsDemo,this.credentialsHintText=ko.observable(Utils.i18n("SETTINGS/MOBILE_CREDENTIALS_TITLE",{EMAIL:AppData.Accounts.getDefault().email()})),this.bSettingsFilesAppsEnabled=AppData.App.SettingsFilesAppsEnabled}function COutLookSyncSettingsViewModel(){this.outlookSync=AppData.User.outlookSync,this.outlookSync.subscribe(this.onOutlookSyncSubscribe,this),this.oResetPasswordViewModel=new CResetPasswordViewModel,this.visibleOutlookSync=ko.observable(!1),this.server=ko.observable(""),this.bChanged=!1,this.isDemo=AppData.User.IsDemo,this.outlookSyncPlugin32=App.getHelpLink("OutlookSyncPlugin32"),this.outlookSyncPlugin64=App.getHelpLink("OutlookSyncPlugin64"),this.outlookSyncPluginReadMore=App.getHelpLink("OutlookSyncPluginReadMore"),this.credentialsHintText=ko.observable(Utils.i18n("SETTINGS/OUTLOOKSYNC_CREDENTIALS_TITLE",{EMAIL:AppData.Accounts.getDefault().email()}))}function CResetPasswordViewModel(){this.oDefaultAccount=AppData.Accounts.getDefault(),this.showResetPasswordButton=ko.computed(function(){return!this.oDefaultAccount.allowMail()},this),this.resetPasswordButtonText=ko.computed(function(){return this.oDefaultAccount.passwordSpecified()?Utils.i18n("LOGIN/BUTTON_RESET_PASSWORD"):Utils.i18n("SETTINGS/ACCOUNT_PROPERTIES_SET_PASSWORD")},this);var e=Utils.i18n("SETTINGS/MOBILE_HINT_SET_PASSWORD").split(/%STARTLINK%|%ENDLINK%/);this.sHintSetPassword1=e.length>0?e[0]:"",this.sHintSetPassword2=e.length>1?e[1]:"",this.sHintSetPassword3=e.length>2?e[2]:""}function CPgpSettingsViewModel(){this.pgp=null,this.pgpLoaded=ko.observable(!1),this.keys=ko.observableArray([]),this.publicKeys=ko.computed(function(){var e=_.filter(this.keys(),function(e){return e.isPublic()});return _.map(e,function(e){return{user:e.getUser(),armor:e.getArmor(),key:e,private:!1}})},this),this.privateKeys=ko.computed(function(){var e=_.filter(this.keys(),function(e){return e.isPrivate()});return _.map(e,function(e){return{user:e.getUser(),armor:e.getArmor(),key:e}})},this),this.loading=ko.observable(!1),this.enableOpenPgp=ko.observable(AppData.User.enableOpenPgp()),this.allowAutosaveInDrafts=ko.observable(AppData.User.AllowAutosaveInDrafts),this.autosignOutgoingEmails=ko.observable(AppData.User.AutosignOutgoingEmails),this.bAllowAutoSave=AppData.App.AutoSave,this.firstState=this.getState()}function CAccountPropertiesViewModel(e){this.allowUsersChangeInterfaceSettings=AppData.App.AllowUsersChangeInterfaceSettings,this.allowUsersChangeEmailSettings=AppData.App.AllowUsersChangeEmailSettings,this.isAllowIdentities=!!AppData.AllowIdentities,this.account=ko.observable(0),this.isAllowMail=ko.observable(!1),this.isInternal=ko.observable(!0),this.isLinked=ko.observable(!0),this.isDefault=ko.observable(!1),this.removeHint=ko.observable(""),this.canBeRemoved=ko.observable(""),this.friendlyName=ko.observable(""),this.email=ko.observable(""),this.incomingMailLogin=ko.observable(""),this.incomingMailPassword=ko.observable(""),this.oIncoming=new CServerPropertiesViewModel(143,993,!1,"acc_edit_incoming",Utils.i18n("SETTINGS/ACCOUNT_PROPERTIES_INCOMING_MAIL")),this.outgoingMailLogin=ko.observable(""),this.outgoingMailPassword=ko.observable(""),this.oOutgoing=new CServerPropertiesViewModel(25,465,!1,"acc_edit_outgoing",Utils.i18n("SETTINGS/ACCOUNT_PROPERTIES_OUTGOING_MAIL"),this.oIncoming.server),this.loading=ko.observable(!1),this.allowChangePassword=ko.observable(!1),this.useSmtpAuthentication=ko.observable(!1),this.incLoginFocused=ko.observable(!1),this.incLoginFocused.subscribe(function(){this.incLoginFocused()&&""===this.incomingMailLogin()&&this.incomingMailLogin(this.email())},this),this.firstState=null}function CAccountFoldersViewModel(e){this.parent=e,this.highlighted=ko.observable(!1).extend({autoResetToFalse:500}),this.collection=ko.observableArray(App.MailCache.editedFolderList().collection()),this.bAllowTemplateFolders=AppData.App.AllowTemplateFolders,this.totalMessageCount=ko.observable(0),this.enableButtons=ko.computed(function(){return App.MailCache.editedFolderList().bInitialized()},this),App.MailCache.editedFolderList.subscribe(function(e){this.collection(e.collection()),this.setTotalMessageCount()},this),this.addNewFolderCommand=Utils.createCommand(this,this.onAddNewFolderClick,this.enableButtons),this.systemFoldersCommand=Utils.createCommand(this,this.onSystemFoldersClick,this.enableButtons),this.showMovedWithMouseItem=ko.computed(function(){var e=AppData.Accounts.getEdited();return!!e&&(!bMobileDevice&&!e.extensionExists("DisableFoldersManualSort"))},this),AfterLogicApi.runPluginHook&&AfterLogicApi.runPluginHook("view-model-defined",[this.__name,this])}function CAccountSignatureViewModel(e){this.parent=e,this.account=ko.observable(0),this.type=ko.observable(!1),this.useSignature=ko.observable(0),this.signature=ko.observable(""),this.loading=ko.observable(!1),this.account.subscribe(function(){this.getSignature()},this),this.oHtmlEditor=new CHtmlEditorViewModel(!0),this.enableImageDragNDrop=ko.observable(!1),this.enabled=ko.observable(!0),this.signature.subscribe(function(){this.oHtmlEditor.setText(this.signature())},this),this.getSignature(),this.firstState=null}function CAccountForwardViewModel(e){this.account=ko.observable(0),this.available=ko.computed(function(){var e=this.account();return e&&e.forward()},this),this.loading=ko.observable(!1),this.enable=ko.observable(!1),this.email=ko.observable(""),this.emailFocus=ko.observable(!1),this.account.subscribe(function(){this.getForward()},this),this.firstState=null}function CAccountAutoresponderViewModel(e){this.account=ko.observable(0),this.available=ko.computed(function(){var e=this.account();return e&&e.autoresponder()},this),this.loading=ko.observable(!1),this.enable=ko.observable(!1),this.subject=ko.observable(""),this.message=ko.observable(""),this.account.subscribe(function(){this.getAutoresponder()},this),this.firstState=null}function CAccountFiltersViewModel(){this.bShown=!1,this.oEditedAccount=null,this.foldersOptions=ko.observableArray([]),App.MailCache.editedFolderList.subscribe(function(){this.bShown&&this.populate()},this),this.loading=ko.observable(!0),this.saving=ko.observable(!1),this.collection=ko.observableArray([]),this.fieldOptions=[{text:Utils.i18n("SETTINGS/ACCOUNT_FILTERS_FIELD_FROM"),value:0},{text:Utils.i18n("SETTINGS/ACCOUNT_FILTERS_FIELD_TO"),value:1},{text:Utils.i18n("SETTINGS/ACCOUNT_FILTERS_FIELD_SUBJECT"),value:2}],this.conditionOptions=[{text:Utils.i18n("SETTINGS/ACCOUNT_FILTERS_COND_CONTAIN_SUBSTR"),value:0},{text:Utils.i18n("SETTINGS/ACCOUNT_FILTERS_COND_EQUAL_TO"),value:1},{text:Utils.i18n("SETTINGS/ACCOUNT_FILTERS_COND_NOT_CONTAIN_SUBSTR"),value:2}],this.actionOptions=[{text:Utils.i18n("SETTINGS/ACCOUNT_FILTERS_ACTION_MOVE"),value:3},{text:Utils.i18n("SETTINGS/ACCOUNT_FILTERS_ACTION_DELETE"),value:1}],this.phaseArray=[""],_.each(Utils.i18n("SETTINGS/ACCOUNT_FILTERS_PHRASE").split(/\s/),function(e){var t=this.phaseArray.length-1;"%"===e.substr(0,1)||"%"===this.phaseArray[t].substr(-1,1)?this.phaseArray.push(e):this.phaseArray[t]+=" "+e},this),this.firstState=null}function CFetcherIncomingViewModel(e){this.bShown=!1,this.loading=ko.observable(!1),this.idFetcher=ko.observable(null),this.isEnabled=ko.observable(!0),this.incomingMailLogin=ko.observable(""),this.incomingMailPassword=ko.observable(""),this.oIncoming=new CServerPropertiesViewModel(110,995,!1,"fetcher_edit_incoming",Utils.i18n("SETTINGS/ACCOUNT_FETCHER_POP3_SERVER")),this.sFetcherFolder="",this.folder=ko.observable(""),this.options=ko.observableArray([]),App.MailCache.folderList.subscribe(function(){this.populateOptions()},this),this.leaveMessagesOnServer=ko.observable(!1),this.passwordIsSelected=ko.observable(!1),this.defaultOptionsAfterRender=Utils.defaultOptionsAfterRender,this.firstState=null}function CFetcherOutgoingViewModel(e){this.defaultAccountId=AppData.Accounts.defaultId,this.loading=ko.observable(!1),this.fetcher=ko.observable(null),this.idFetcher=ko.observable(null),this.isEnabled=ko.observable(!0),this.email=ko.observable(""),this.userName=ko.observable(""),this.isOutgoingEnabled=ko.observable(!1),this.isOutgoingEnabled.subscribe(function(e){this.oOutgoing.isEnabled(e)},this),this.focusEmail=ko.observable(!1),this.oOutgoing=new CServerPropertiesViewModel(25,465,!1,"fetcher_edit_outgoing",Utils.i18n("SETTINGS/ACCOUNT_FETCHER_SMTP_SERVER")),this.outgoingMailAuth=ko.observable(!1),this.firstState=null}function CFetcherSignatureViewModel(e){this.defaultAccountId=AppData.Accounts.defaultId,this.idFetcher=ko.observable(null),this.fetcher=ko.observable(null),this.signature=ko.observable(""),this.loading=ko.observable(!1),this.type=ko.observable(!1),this.useSignature=ko.observable(0),this.oHtmlEditor=new CHtmlEditorViewModel(!0),this.enableImageDragNDrop=ko.observable(!1),this.enabled=e.oFetcherIncoming.isEnabled,this.enabled.subscribe(function(){this.oHtmlEditor.isEnable(this.enabled())},this),this.signature.subscribe(function(){this.oHtmlEditor.setText(this.signature())},this),this.firstState=null}function CHelpdeskSettingsViewModel(){this.allowNotifications=ko.observable(AppData.User.AllowHelpdeskNotifications),this.loading=ko.observable(!1),this.signature=ko.observable(AppData.User.helpdeskSignature()),this.signatureEnable=ko.observable(AppData.User.helpdeskSignatureEnable()),this.signatureEnable.subscribe(function(e){"1"!==e&&this.signatureFocused(!1)},this),this.signatureFocused=ko.observable(!1),this.domSignature=ko.observable(null)}function CCloudStorageSettingsViewModel(){this.loading=ko.observable(!1),this.allowFiles=AppData.User.IsFilesSupported,this.enableFiles=ko.observable(AppData.User.filesEnable()),this.appPath=Utils.Common.getAppPath(),this.credentialsHintText=ko.observable(Utils.i18n("SETTINGS/MOBILE_CREDENTIALS_TITLE",{EMAIL:AppData.Accounts.getDefault().email()})),this.firstState=this.getState(),AfterLogicApi.runPluginHook&&AfterLogicApi.runPluginHook("view-model-defined",[this.__name,this]),this.bSettingsFilesAppsEnabled=AppData.App.SettingsFilesAppsEnabled}function CIdentityPropertiesViewModel(e,t){this.defaultAccountId=AppData.Accounts.defaultId,this.oEmailAccountsSettings=e,this.oAccountProperties=e.oAccountProperties,this.bCreate=t,this.loading=ko.observable(!1),this.disableCheckbox=ko.observable(!1),this.identity=ko.observable(null),this.oHtmlEditor=new CHtmlEditorViewModel(!0),this.enabled=ko.observable(!0),this.isDefault=ko.observable(!1),this.email=ko.observable(""),this.loyal=ko.observable(!1),this.friendlyName=ko.observable(""),this.friendlyNameHasFocus=ko.observable(!1),this.signature=ko.observable(""),this.useSignature=ko.observable(0),this.enableImageDragNDrop=ko.observable(!1),this.signature.subscribe(function(){this.oHtmlEditor.setText(this.signature())},this),this.firstState=null}function CServerPropertiesViewModel(e,t,i,s,o,n){this.server=ko.observable(""),this.label=o,this.focused=ko.observable(!1),this.defaultPort=ko.observable(e),this.defaultSslPort=ko.observable(t),this.port=ko.observable(i?t:e),this.ssl=ko.observable(i),this.isEnabled=ko.observable(!0),this.id=s,_.isFunction(n)&&n.subscribe(function(){_.defer(_.bind(function(){""===this.server()&&this.server(n())},this))},this),this.ssl.subscribe(function(){this.ssl()?this.port()===this.defaultPort()&&this.port(this.defaultSslPort()):this.port()===this.defaultSslPort()&&this.port(this.defaultPort())},this)}function CCalendarViewModel(){var e=this;this.initialized=ko.observable(!1),this.isPublic=bExtApp,this.uploaderArea=ko.observable(null),this.bDragActive=ko.observable(!1),this.bDragActiveComp=ko.computed(function(){return this.bDragActive()},this),this.defaultAccount=AppData.Accounts?AppData.Accounts.getDefault():null,this.todayDate=new Date,this.aDayNames=Utils.i18n("DATETIME/DAY_NAMES").split(" "),this.popUpStatus=!1,this.linkRow=0,this.linkColumn=0,this.publicCalendarId=this.isPublic?AppData.CalendarPubHash:"",this.publicCalendarName=ko.observable(""),this.timeFormat=AppData.User.defaultTimeFormat()===Enums.TimeFormat.F24?"HH:mm":"hh:mm A",this.dateFormat=AppData.User.DefaultDateFormat,this.topPositionToday=ko.observable(".fc-widget-content.fc-today"),this.loadOnce=!1,this.scrollModel=ko.observable(null),this.scrollHeight=0,this.dateTitle=ko.observable(""),this.dateTitleHelper=ko.observableArray(Utils.i18n("DATETIME/MONTH_NAMES").split(" ")),this.selectedView=ko.observable(""),this.visibleWeekdayHeader=ko.computed(function(){return"month"===this.selectedView()},this),this.selectedView.subscribe(function(){this.resize()},this),this.$calendarGrid=null,this.calendarGridDom=ko.observable(null),this.$datePicker=null,this.datePickerDom=ko.observable(null),this.calendars=new CCalendarListModel({onCalendarCollectionChange:function(){e.refreshView()},onCalendarActiveChange:function(){e.refreshView()}}),this.colors=["#f09650","#f68987","#6fd0ce","#8fbce2","#b9a4f5","#f68dcf","#d88adc","#4afdb4","#9da1ff","#5cc9c9","#77ca71","#aec9c9"],this.busyDays=ko.observableArray([]),this.$inlineEditedEvent=null,this.inlineEditedEventText=null,this.checkStarted=ko.observable(!1),this.loaded=!1,this.startDateTime=0,this.endDateTime=0,this.needsToReload=!1,this.calendarListClick=function(e){e.active(!e.active())},this.currentCalendarDropdown=ko.observable(!1),this.currentCalendarDropdownOffset=ko.observable(0),this.calendarDropdownToggle=function(t,i){if(i&&t){var s=i.position(),o=i.outerHeight();e.currentCalendarDropdownOffset(parseInt(s.top,10)+o)}e.currentCalendarDropdown(t)},this.dayNamesResizeBinding=_.throttle(_.bind(this.resize,this),50),this.customscrollTop=ko.observable(0),this.fullcalendarOptions={handleWindowResize:!0,eventLimit:10,header:!1,editable:!this.isPublic,selectable:!this.isPublic,allDayText:Utils.i18n("CALENDAR/TITLE_ALLDAY"),dayNames:this.aDayNames,isRTL:Utils.isRTL(),scrollTime:moment.duration(8,"hours"),forceEventDuration:!0,columnFormat:{month:"dddd",week:"dddd D",day:"dddd D"},titleFormat:{month:"MMMM YYYY",week:"MMMM D[ YYYY]{ '-'[ MMMM] D YYYY}",day:"MMMM D, YYYY"},displayEventEnd:{month:!0,basicWeek:!0,default:!0},select:_.bind(this.createEventFromGrid,this),eventClick:_.bind(this.eventClickCallback,this),eventDragStart:_.bind(this.onEventDragStart,this),eventDragStop:_.bind(this.onEventDragStop,this),eventResizeStart:_.bind(this.onEventResizeStart,this),eventResizeStop:_.bind(this.onEventResizeStop,this),eventDrop:_.bind(this.moveEvent,this),eventResize:_.bind(this.resizeEvent,this),eventAfterRender:_.bind(function(e,t){},this),eventAfterAllRender:_.bind(this.updateAllEvents,this),viewRender:_.bind(this.viewRenderCallback,this),events:_.bind(this.eventsSource,this)},this.revertFunction=null,this.calendarSharing=AppData.User.AllowCalendar&&AppData.User.CalendarSharing,this.defaultViewName=ko.computed(function(){var e="month";switch(AppData.User.CalendarDefaultTab){case Enums.CalendarDefaultTab.Day:e="agendaDay";break;case Enums.CalendarDefaultTab.Week:e="agendaWeek";break;case Enums.CalendarDefaultTab.Month:e="month"}return e},this),this.iAutoReloadTimer=-1,this.dragEventTrigger=!1,this.delayOnEventResult=!1,this.delayOnEventResultData=[],this.refreshView=_.throttle(_.bind(this.refreshViewSingle,this),100),this.defaultCalendarId=ko.computed(function(){var e=this.calendars.defaultCal();if(e)return e.id},this),this.uploadCalendarId=ko.observable(""),this.changeFullCalendarDate=!0,this.domScrollWrapper=null,this.hotKeysBind()}function CFileStorageViewModel(e){this.allowSendEmails=ko.computed(function(){return!!(AppData.App&&AppData.App.AllowWebMail&&AppData.Accounts&&AppData.Accounts.isCurrentAllowsMail())},this),this.error=ko.observable(!1),this.loaded=ko.observable(!1),this.isPublic=bExtApp,this.publicHash=bExtApp?AppData.FileStoragePubHash:"",this.IsCollaborationSupported=AppData.User.IsCollaborationSupported,this.AllowFilesSharing=AppData.User.AllowFilesSharing,this.storages=ko.observableArray(),this.folders=ko.observableArray(),this.files=ko.observableArray(),this.uploadingFiles=ko.observableArray(),this.selected=ko.observable(!1),this.rootPath=ko.observable(Utils.i18n("FILESTORAGE/TAB_PERSONAL_FILES")),this.storageType=ko.observable(Enums.FileStorageType.Personal),this.storageType.subscribe(function(){var e=null;this.isPublic?this.rootPath(AppData.FileStoragePubParams.Name):(e=this.getStorageByType(this.storageType()),e&&this.rootPath(e.displayName())),this.selector.listCheckedAndSelected(!1)},this),this.iPathIndex=ko.observable(-1),this.pathItems=ko.observableArray(),this.dropPath=ko.observable(""),this.path=ko.computed(function(){var e=_.map(this.pathItems(),function(e){return e.id()});return e.join("/")},this),this.path.subscribe(function(e){this.dropPath(e)},this),this.collection=ko.computed(function(){var e=_.union(this.files(),this.getUploadingFiles());return e.sort(function(e,t){return e.fileName()===t.fileName()?0:e.fileName().toLowerCase()<t.fileName().toLowerCase()?-1:1}),_.union(this.folders(),e)},this),this.columnCount=ko.observable(1),this.selector=new CSelector(this.collection,null,_.bind(this.onItemDelete,this),_.bind(this.onItemDblClick,this),_.bind(this.onEnter,this),this.columnCount,!0,!0,!0),this.searchPattern=ko.observable(""),this.isSearchFocused=ko.observable(!1),this.renameCommand=Utils.createCommand(this,this.executeRename,function(){var e=this.selector.listCheckedAndSelected();return 1===e.length}),this.deleteCommand=Utils.createCommand(this,this.executeDelete,function(){var e=this.selector.listCheckedAndSelected();return 0<e.length}),this.downloadCommand=Utils.createCommand(this,this.executeDownload,function(){var e=this.selector.listCheckedAndSelected();return 1===e.length&&!e[0].isFolder()}),this.shareCommand=Utils.createCommand(this,this.executeShare,function(){var e=this.selector.listCheckedAndSelected();return 1===e.length&&!e[0].isLink()}),this.sendCommand=Utils.createCommand(this,this.executeSend,function(){var e=this.selector.listCheckedAndSelected(),t=_.filter(e,function(e){return!e.isFolder()},this);return t.length>0}),this.uploaderButton=ko.observable(null),this.uploaderArea=ko.observable(null),this.bDragActive=ko.observable(!1),this.bDragActiveComp=ko.computed(function(){var e=this.bDragActive();return e&&""===this.searchPattern()},this),this.bAllowDragNDrop=!1,this.uploadError=ko.observable(!1),this.quota=ko.observable(0),this.used=ko.observable(0),this.quotaDesc=ko.observable(""),this.quotaProc=ko.observable(-1),ko.computed(function(){if(!AppData.App||AppData.App&&!AppData.App.ShowQuotaBar)return!0;var e=this.quota(),t=this.used(),i=0<e?Math.ceil(t/e*100):-1;return i=100<i?100:i,this.quotaProc(i),this.quotaDesc(-1<i?Utils.i18n("MAILBOX/QUOTA_TOOLTIP",{PROC:i,QUOTA:Utils.friendlySize(e)}):""),!0},this),this.dragover=ko.observable(!1),this.loading=ko.observable(!1),this.loadedFiles=ko.observable(!1),this.fileListInfoText=ko.computed(function(){var e="";return this.loading()?e=Utils.i18n("FILESTORAGE/INFO_LOADING"):this.loadedFiles()?0===this.collection().length&&(this.isPublic?e=Utils.i18n("FILESTORAGE/INFO_PUBLIC_FOLDER_NOT_EXIST"):""!==this.searchPattern()||this.isPublic?e=Utils.i18n("FILESTORAGE/INFO_NO_ITEMS_FOUND"):""!==this.path()||this.isPopup?e=Utils.i18n("FILESTORAGE/INFO_FOLDER_IS_EMPTY"):this.bAllowDragNDrop&&(e=Utils.i18n("FILESTORAGE/INFO_FILESTORAGE_IS_EMPTY"))):this.error()&&(e=Utils.i18n("FILESTORAGE/ERROR_FILESTORAGE")),e},this),this.dragAndDropHelperBinded=_.bind(this.dragAndDropHelper,this),this.isPopup=!!e,this.isCurrentStorageExternal=ko.computed(function(){var e=this.getStorageByType(this.storageType());return e&&e.isExternal()},this),this.timerId=null}function CHelpdeskViewModel(){var e=this,t=function(t){return function(){e.executeChangeState(t),e.isQuickReplyHidden(!e.bAgent),t===Enums.HelpdeskThreadStates.Resolved&&(e.selectedItem(null),App.Routing.setHash([Enums.Screens.Helpdesk,""]))}};this.bRtl=Utils.isRTL(),this.iAutoCheckTimer=0,this.bExtApp=bExtApp,this.ajaxSendFunc=this.bExtApp?"sendExt":"send",this.bAgent=AppData.User.IsHelpdeskAgent,this.singleMode=AppData.SingleMode,this.externalUrl=ko.observable(AppData.HelpdeskIframeUrl),this.signature=AppData.User.helpdeskSignature,this.signatureEnable=AppData.User.helpdeskSignatureEnable,this.isSignatureVisible=ko.computed(function(){return""!==this.signature()&&"1"===this.signatureEnable()},this),this.loadingList=ko.observable(!0),this.loadingViewPane=ko.observable(!1),this.loadingMoreMessages=ko.observable(!1),this.threads=ko.observableArray([]),this.posts=ko.observableArray([]),this.iPingInterval=-1,this.iPingStartTimer=-1,this.selectedItem=ko.observable(null),this.previousSelectedItem=ko.observable(null),this.postForDelete=ko.observable(null),this.state=ko.observable(0),this.selectedItem.subscribe(function(e){this.state(e?e.state():0),this.subject(this.selectedItem()?this.bExtApp?this.selectedItem().sSubject:this.selectedItem().sFromFull:""),this.internalNote(!1),!this.bExtApp&&this.selectedItem()&&App.ContactsCache.getContactsByEmails([this.selectedItem().sEmail],this.onOwnerContactResponse,this),clearInterval(this.iPingInterval),clearTimeout(this.iPingStartTimer),this.watchers([]),this.selectedItem()&&(this.iPingStartTimer=setTimeout(_.bind(function(){this.executeThreadPing(this.selectedItem().Id),clearInterval(this.iPingInterval),this.iPingInterval=setInterval(_.bind(function(){this.executeThreadPing(this.selectedItem().Id)},this),18e4)},this),5e3))},this),this.listFilter=ko.observable(this.bAgent?Enums.HelpdeskFilters.Open:Enums.HelpdeskFilters.All),this.listFilter.subscribe(function(){this.requestThreadsList()},this),this.prevListFilter=ko.observable(""),this.hasMorePosts=ko.computed(function(){var e=this.selectedItem();return e&&e.postsCount()>this.posts().length},this).extend({throttle:1}),this.selector=new CSelector(this.threads,_.bind(this.onItemSelect,this),_.bind(this.onItemDelete,this),null,null,null,!1,!1,!1,!0),this.checkStarted=ko.observable(!1),this.checkAll=this.selector.koCheckAll(),this.checkAllIncomplite=this.selector.koCheckAllIncomplete(),this.ThreadsPerPage=10,this.oPageSwitcher=new CPageSwitcherViewModel(0,this.ThreadsPerPage),this.oPageSwitcher.currentPage.subscribe(function(){this.requestThreadsList()},this),this.isSearchFocused=ko.observable(!1),this.search=ko.observable(""),this.searchText=ko.computed(function(){return Utils.i18n("HELPDESK/INFO_SEARCH_RESULT",{SEARCH:this.search()})},this),this.deleteCommand=Utils.createCommand(this,this.executeDelete,this.isEnableListActions),this.openNewWindowCommand=Utils.createCommand(this,this.executeOpenNewWindow,this.isEnableListActions),this.checkCommand=Utils.createCommand(this,function(){this.requestThreadsList(),this.requestPosts(),this.startAutocheckmail()}),this.closeCommand=Utils.createCommand(this,t(Enums.HelpdeskThreadStates.Resolved),this.isEnableListActions),this.waitCommand=Utils.createCommand(this,t(Enums.HelpdeskThreadStates.Waiting),this.isEnableListActions),this.pendingCommand=Utils.createCommand(this,t(Enums.HelpdeskThreadStates.Pending),this.isEnableListActions),this.deferCommand=Utils.createCommand(this,t(Enums.HelpdeskThreadStates.Deferred),this.isEnableListActions),this.answerCommand=Utils.createCommand(this,t(Enums.HelpdeskThreadStates.Answered),this.isEnableListActions),this.postCommand=Utils.createCommand(this,this.executePostCreate,function(){return!!this.selectedItem()&&!this.isQuickReplyPaneEmpty()&&this.allAttachmentsUploaded()}),this.visibleNewThread=ko.observable(!1),this.newThreadId=ko.observable(0),this.newThreadText=ko.observable(""),this.newThreadCreating=ko.observable(!1),this.domNewThreadTextarea=ko.observable(null),this.newThreadTextFocus=ko.observable(null),this.createThreadCommand=Utils.createCommand(this,this.executeThreadCreate,function(){return this.visibleNewThread()&&this.newThreadText().length>0&&!this.newThreadCreating()}),this.createThreadButtonText=ko.computed(function(){return this.newThreadCreating()?Utils.i18n("MAIN/BUTTON_SENDING"):Utils.i18n("HELPDESK/BUTTON_CREATE")},this),this.commandGetOlderPosts=function(){var e=this.posts(),t=e[0]?e[0].Id:0;this.requestPosts(null,t)},this.externalContentUrl=ko.observable(""),AppData.HelpdeskIframeUrl&&(this.bAgent?this.externalContentUrl=ko.computed(function(){
var e="",t=this.selectedItem();return t&&(e=t.Email()),e?AppData.HelpdeskIframeUrl.replace(/\[EMAIL\]/g,e):""},this):AppData.User.Email&&(this.externalContentUrl=ko.computed(function(){return AppData.HelpdeskIframeUrl.replace(/\[EMAIL\]/g,AppData.User.Email)},this))),this.clientDetailsVisible=ko.observable(!App.Storage.hasData("HelpdeskUserDetails")||App.Storage.getData("HelpdeskUserDetails")),this.clientDetailsVisible.subscribe(function(e){App.Storage.setData("HelpdeskUserDetails",e)},this),this.subject=ko.observable(""),this.watchers=ko.observableArray([]),this.ownerExistsInContacts=ko.observable(!1),this.ownerContactInfoReceived=ko.observable(!1),this.ownerContact=ko.observable(this.bExtApp?null:new CContactModel),this.hasOwnerContact=ko.computed(function(){return!this.singleMode&&this.ownerContactInfoReceived()&&this.ownerExistsInContacts()},this),this.visibleAddToContacts=ko.computed(function(){return!this.singleMode&&this.ownerContactInfoReceived()&&!this.ownerExistsInContacts()},this),this.contactCardWidth=ko.observable(0),this.uploadedFiles=ko.observableArray([]),this.allAttachmentsUploaded=ko.computed(function(){var e=_.filter(this.uploadedFiles(),function(e){return!e.uploaded()});return 0===e.length},this),this.uploaderButton=ko.observable(null),this.uploaderButtonCompose=ko.observable(null),this.uploaderArea=ko.observable(null),this.bDragActive=ko.observable(!1),this.internalNote=ko.observable(!1),this.ccbccVisible=ko.observable(!1),this.ccAddrDom=ko.observable(),this.ccAddrDom.subscribe(function(){this.initInputosaurus(this.ccAddrDom,this.ccAddr,this.lockCcAddr,"cc")},this),this.lockCcAddr=ko.observable(!1),this.ccAddr=ko.observable("").extend({reversible:!0}),this.ccAddr.subscribe(function(){this.lockCcAddr()||($(this.ccAddrDom()).val(this.ccAddr()),$(this.ccAddrDom()).inputosaurus("refresh"))},this),this.bccAddrDom=ko.observable(),this.bccAddrDom.subscribe(function(){this.initInputosaurus(this.bccAddrDom,this.bccAddr,this.lockBccAddr,"bcc")},this),this.lockBccAddr=ko.observable(!1),this.bccAddr=ko.observable("").extend({reversible:!0}),this.bccAddr.subscribe(function(){this.lockBccAddr()||($(this.bccAddrDom()).val(this.bccAddr()),$(this.bccAddrDom()).inputosaurus("refresh"))},this),this.preventFalseClick=ko.observable(!1).extend({autoResetToFalse:500}),this.isQuickReplyHidden=ko.observable(!this.bAgent),this.domQuickReply=ko.observable(null),this.domQuickReplyTextarea=ko.observable(null),this.replySendingStarted=ko.observable(!1),this.replyPaneVisible=ko.observable(!0),this.replyText=ko.observable(""),this.replyTextFocus=ko.observable(!1),this.isQuickReplyActive=ko.observable(!1),this.replyTextFocus.subscribe(function(e){e&&(this.isQuickReplyActive(!0),this.setSignature(this.replyText,this.domQuickReplyTextarea()))},this),this.isQuickReplyActive.subscribe(function(){this.isQuickReplyActive()&&this.replyTextFocus(!0)},this),this.isQuickReplyPaneEmpty=ko.computed(function(){return Utils.trim(this.replyText())===this.signature()||""===this.replyText()},this),this.isNewThreadPaneEmpty=ko.computed(function(){return Utils.trim(this.newThreadText())===this.signature()||""===this.newThreadText()},this),this.isSearch=ko.computed(function(){return""!==this.search()},this),this.isEmptyList=ko.computed(function(){return 0===this.threads().length},this),this.bAgent?this.dynamicEmptyListInfo=ko.computed(function(){return this.isEmptyList()&&this.isSearch()?Utils.i18n("HELPDESK/INFO_SEARCH_EMPTY"):Utils.i18n("HELPDESK/INFO_EMPTY_OPEN_THREAD_LIST_AGENT")},this):this.dynamicEmptyListInfo=ko.computed(function(){return this.isEmptyList()&&this.isSearch()?Utils.i18n("HELPDESK/INFO_SEARCH_EMPTY"):Utils.i18n("HELPDESK/INFO_EMPTY_THREAD_LIST")},this),this.simplePreviewPane=ko.computed(function(){var e=this.selectedItem();return e?e.ItsMe:!this.bAgent},this),this.allowInternalNote=ko.computed(function(){return!this.simplePreviewPane()},this),this.scrollToTopTrigger=ko.observable(!1),this.scrollToBottomTrigger=ko.observable(!1),this.allowDownloadAttachmentsLink=!1,this.newThreadButtonWidth=ko.observable(0),this.focusedField=ko.observable(),this.requestFromLogin()}function CScreens(){var e=$(window);this.resizeAll=_.debounce(function(){e.resize()},100),this.oScreens={},this.currentScreen=ko.observable(""),this.informationScreen=ko.observable(null),this.popups=[]}function CMailCache(){this.currentAccountId=AppData.Accounts.currentId,this.currentAccountId.subscribe(function(e){var t=AppData.Accounts.getAccount(e),i=this.oFolderListItems[e];t&&(t.quotaRecieved(!1),this.messagesLoadingError(!1),i?this.folderList(i):(this.messagesLoading(t.allowMail()),this.folderList(new CFolderListModel),this.messages([]),this.currentMessage(null),this.getFolderList(e)))},this),this.editedAccountId=AppData.Accounts.editedId,this.editedAccountId.subscribe(function(e){var t=this.oFolderListItems[e];t?this.editedFolderList(t):this.currentAccountId()!==e&&(this.editedFolderList(new CFolderListModel),this.getFolderList(e))},this),this.oFolderListItems={},this.quotaChangeTrigger=ko.observable(!1),this.checkMailStarted=ko.observable(!1),this.checkMailStartedAccountId=ko.observable(0),this.defaultFolderList=ko.observable(new CFolderListModel),this.folderList=ko.observable(new CFolderListModel),this.folderListLoading=ko.observableArray([]),this.editedFolderList=ko.observable(new CFolderListModel),this.newMessagesCount=ko.computed(function(){var e=this.folderList().inboxFolder();return e?e.unseenMessageCount():0},this),this.newMessagesCount.subscribe(function(e){App.mailUnseenCount(e>99?"99+":e)},this),this.messages=ko.observableArray([]),this.messages.subscribe(function(){this.messages().length>0&&this.messagesLoadingError(!1)},this),this.uidList=ko.observable(new CUidListModel),this.page=ko.observable(1),this.messagesLoading=ko.observable(!1),this.messagesLoadingError=ko.observable(!1),this.currentMessage=ko.observable(null),this.currentMessage.subscribe(function(){this.currentMessage()&&AfterLogicApi.runPluginHook("view-message",[AppData.Accounts.currentId(),this.currentMessage().folder(),this.currentMessage().uid()])},this),this.nextMessageUid=ko.computed(function(){var e="",t="",i=null,s=null,o=!1;return this.currentMessage()&&AppData.SingleMode&&(o=this.currentMessage().threadPart()&&""!==this.currentMessage().threadParentUid(),i=this.folderList().getFolderByFullName(this.currentMessage().folder()),e=this.currentMessage().uid(),AppData.ThreadLevel||o?(AppData.ThreadLevel=!0,o&&(s=i.getMessageByUid(this.currentMessage().threadParentUid()),s&&(_.each(s.threadUids(),function(i,s,o){i===e&&s>0&&(t=o[s-1])}),(Utils.isUnd(t)||""===t)&&(t=s.uid())))):(_.each(this.uidList().collection(),function(i,s,o){i===e&&s>0&&(t=o[s-1])}),Utils.isUnd(t)&&(t=""),""===t&&window.opener&&window.opener.App&&window.opener.App.Prefetcher&&window.opener.App.Prefetcher.prefetchNextPage(e))),t},this),this.prevMessageUid=ko.computed(function(){var e=this.currentMessage()?this.currentMessage().uid():"",t="",i=null,s=null,o=!1;return this.currentMessage()&&AppData.SingleMode&&(o=this.currentMessage().threadPart()&&""!==this.currentMessage().threadParentUid(),i=this.folderList().getFolderByFullName(this.currentMessage().folder()),e=this.currentMessage().uid(),AppData.ThreadLevel||o?(AppData.ThreadLevel=!0,o?(s=i.getMessageByUid(this.currentMessage().threadParentUid()),s&&(_.each(s.threadUids(),function(i,s,o){i===e&&s+1<o.length&&(t=o[s+1])}),Utils.isUnd(t)&&(t=""))):this.currentMessage().threadCount()>0&&(t=this.currentMessage().threadUids()[0])):(_.each(this.uidList().collection(),function(i,s,o){i===e&&s+1<o.length&&(t=o[s+1])}),Utils.isUnd(t)&&(t=""),""===t&&window.opener&&window.opener.App&&window.opener.App.Prefetcher&&window.opener.App.Prefetcher.prefetchPrevPage(e))),t},this),this.savingDraftUid=ko.observable(""),this.editedDraftUid=ko.observable(""),this.disableComposeAutosave=ko.observable(!1),this.aResponseHandlers=[],AppData.User.useThreads.subscribe(function(){_.each(this.oFolderListItems,function(e){_.each(e.collection(),function(e){e.markHasChanges(),e.removeAllMessageListsFromCacheIfHasChanges()},this)},this),this.messages([])},this),this.iAutoCheckMailTimer=-1,this.waitForUnseenMessages=ko.observable(!0),this.iMessageSetSeenCount=0,this.__name="CMailCache"}function CContactsCache(){this.contacts={},this.responseHandlers={},this.vcardAttachments=[],this.recivedAnim=ko.observable(!1).extend({autoResetToFalse:500}),this.newContactParams=null}function CCalendarCache(){this.calendars=ko.observableArray([]),this.calendarsLoadingStarted=ko.observable(!1),this.icalAttachments=[],this.recivedAnim=ko.observable(!1).extend({autoResetToFalse:500}),this.calendarSettingsChanged=ko.observable(!1),this.calendarChanged=ko.observable(!1),this.canRequestCalendarList=ko.observable(!1)}function AbstractApp(){this.browser=new CBrowser;try{this.favico=!this.browser.ie8AndBelow&&window.Favico?new window.Favico({animation:"none"}):null}catch(e){this.favico=null}this.Ajax=new CAjax,this.Screens=new CScreens,this.Api=new CApi,this.Storage=new CStorage,this.helpdeskUnseenCount=ko.observable(0),this.helpdeskPendingCount=ko.observable(0),this.mailUnseenCount=ko.observable(0),this.InternetConnectionError=!1}function AppBase(){AbstractApp.call(this),this.headerTabs=ko.observableArray([]),this.screensTitle={},this.Phone=null,this.Routing=new CRouting,this.Links=new CLinkBuilder,this.MessageSender=new CMessageSender,this.Prefetcher=new CPrefetcher,this.MailCache=null,this.ContactsCache=new CContactsCache,this.CalendarCache=new CCalendarCache,this.currentScreen=this.Screens.currentScreen,this.currentScreen.subscribe(this.setTitle,this),this.focused=ko.observable(!0),this.focused.subscribe(function(){AppData.SingleMode||window.opener||this.setTitle()},this),this.filesRecievedAnim=ko.observable(!1).extend({autoResetToFalse:500}),this.init(),this.newMessagesCount=this.MailCache.newMessagesCount,this.newMessagesCount.subscribe(this.setTitle,this),this.currentMessage=this.MailCache.currentMessage,this.currentMessage.subscribe(this.setTitle,this),this.notification=null,this.initHeaderInfo(),this.sessionTimeoutFunctions=[],this.initSessionTimeout(),this.sResetPassHash=Utils.Common.getRequestParam("reset-pass")||""}function AppMain(){AppBase.call(this)}var Consts={},Enums={},Utils={},I18n=window.pSevenI18N||{},App={},AfterLogicApi={},AppData=window.pSevenAppData||{},bExtApp=!1,bMobileApp=!1,$html=$("html"),bIsWindowsPhone=-1<navigator.userAgent.indexOf("Windows Phone"),bIsIosDevice=!bIsWindowsPhone&&(-1<navigator.userAgent.indexOf("iPhone")||-1<navigator.userAgent.indexOf("iPod")||-1<navigator.userAgent.indexOf("iPad")),bIsAndroidDevice=!bIsWindowsPhone&&-1<navigator.userAgent.toLowerCase().indexOf("android"),bMobileDevice=bIsWindowsPhone||bIsIosDevice||bIsAndroidDevice,aViewMimeTypes=["image/jpeg","image/png","image/gif","text/html","text/plain","text/css","text/rfc822-headers","message/delivery-status","application/x-httpd-php","application/javascript"];window.Modernizr&&navigator&&window.Modernizr.addTest("pdf",function(){for(var e=navigator.mimeTypes,t=0,i=e.length;t<i;t++)if("application/pdf"===e[t].type)return aViewMimeTypes.push("application/pdf"),!0;return!1}),Date.now||(Date.now=function(){return(new Date).getTime()}),CBrowser.prototype.getIeVersion=function(){var e=navigator.userAgent.toLowerCase(),t=Utils.pInt(e.slice(e.indexOf("msie")+4,e.indexOf(";",e.indexOf("msie")+4)));return this.ie11&&(t=11),t},CAjax.prototype.AddActionsWithoutAuthForSendExt=function(e){e=Utils.isUnd(e)?"":e,""!==e&&_.indexOf(this.aActionsWithoutAuthForSendExt,e)===-1&&this.aActionsWithoutAuthForSendExt.push(e)},CAjax.prototype.AddActionsWithoutAuthForSend=function(e){e=Utils.isUnd(e)?"":e,""!==e&&_.indexOf(this.aActionsWithoutAuthForSend,e)===-1&&this.aActionsWithoutAuthForSend.push(e)},CAjax.prototype.hasOpenedRequests=function(e){return e=Utils.isUnd(e)?"":e,this.requests(_.filter(this.requests(),function(t){var i=t&&4===t.Xhr.readyState,s=!t||0===t.Xhr.readyState&&"abort"===t.Xhr.statusText,o=""===e||t&&t.Parameters.Action===e;return t&&!i&&!s&&o})),this.requests().length>0},CAjax.prototype.isSearchMessages=function(){var e=!1;return _.each(this.requests(),function(t){t&&t.Parameters&&"MessagesGetList"===t.Parameters.Action&&""!==t.Parameters.Search&&(e=!0)},this),e},CAjax.prototype.isAllowedActionWithoutAuth=function(e){return _.indexOf(this.aActionsWithoutAuthForSend,e)!==-1},CAjax.prototype.isAllowedExtAction=function(e){return"SocialRegister"===e||"HelpdeskRegister"===e||"HelpdeskForgot"===e||"HelpdeskLogin"===e||"SystemLogout"===e},CAjax.prototype.doSend=function(e,t,i,s){var o=_.bind(s||null,this,e,t,i),n=_.bind(this.fail,this,e,t,i),a=_.bind(this.always,this,e),r=null;AfterLogicApi.runPluginHook&&AfterLogicApi.runPluginHook("ajax-default-request",[e.Action,e]),AppData.Token&&(e.Token=AppData.Token),this.abortRequests(e),Utils.log("Ajax request send",e.Action,e),r=$.ajax({url:this.sUrl,type:"POST",async:!0,dataType:"json",data:e,success:o,error:n,complete:a,timeout:"MessagesGetBodies"===e.Action?1e5:5e4}),this.requests().push({Parameters:e,Xhr:r})},CAjax.prototype.send=function(e,t,i){var s=void 0===e.AccountID,o=s||AppData.Accounts.hasAccountWithId(e.AccountID);e&&(AppData.Auth&&o||this.isAllowedActionWithoutAuth(e.Action))&&(s&&"Login"!==e.Action&&(e.AccountID=AppData.Accounts.currentId()),this.doSend(e,t,i,this.done))},CAjax.prototype.sendExt=function(e,t,i){var s=_.indexOf(this.aActionsWithoutAuthForSendExt,e.Action)!==-1;e&&(AppData.Auth||s)&&(AppData.TenantHash&&(e.TenantHash=AppData.TenantHash),this.doSend(e,t,i,this.doneExt))},CAjax.prototype.abortRequests=function(e){switch(e.Action){case"MessageMove":case"MessageDelete":this.abortRequestByActionName("MessagesGetList",{Folder:e.Folder}),this.abortRequestByActionName("MessageGet");break;case"MessagesGetList":case"MessageSetSeen":case"MessageSetFlagged":this.abortRequestByActionName("MessagesGetList",{Folder:e.Folder});break;case"MessagesSetAllSeen":this.abortRequestByActionName("MessagesGetList",{Folder:e.Folder}),this.abortRequestByActionName("MessagesGetListByUids",{Folder:e.Folder});break;case"FolderClear":this.abortRequestByActionName("MessagesGetList",{Folder:e.Folder}),this.abortRequestByActionName("FoldersGetRelevantInformation");break;case"FoldersGetRelevantInformation":this.abortRequestByActionName("FoldersGetRelevantInformation");break;case"MessagesGetFlags":this.abortRequestByActionName("MessagesGetFlags");break;case"ContactList":case"ContactGlobalList":this.abortRequestByActionName("ContactList"),this.abortRequestByActionName("ContactGlobalList");break;case"ContactGet":case"ContactGlobal":this.abortRequestByActionName("ContactGet"),this.abortRequestByActionName("ContactGlobal");break;case"CalendarEventUpdate":this.abortRequestByActionName("CalendarEventUpdate",{calendarId:e.calendarId,uid:e.uid});break;case"CalendarList":this.abortRequestByActionName("CalendarList");break;case"CalendarEventList":this.abortRequestByActionName("CalendarEventList")}},CAjax.prototype.abortRequestByActionName=function(e,t){var i;_.each(this.requests(),function(s,o){if(i=!1,s&&s.Parameters.Action===e)switch(e){case"MessagesGetList":t.Folder===s.Parameters.Folder&&(i=!0);break;case"CalendarEventUpdate":t.calendarId===s.Parameters.calendarId&&t.uid===s.Parameters.uid&&(i=!0);break;default:i=!0}i&&(s.Xhr.abort(),this.requests()[o]=void 0)},this),this.requests(_.compact(this.requests()))},CAjax.prototype.abortAllRequests=function(){_.each(this.requests(),function(e){e&&e.Xhr.abort()},this),this.requests([])},CAjax.prototype.done=function(e,t,i,s,o,n){var a=this.isAllowedActionWithoutAuth(e.Action),r=AppData.Accounts.hasAccountWithId(e.AccountID),l=e.AccountID===AppData.Accounts.defaultId();if(Utils.log("Ajax request done",e.Action,o,Utils.getAjaxDataForLog(e.Action,s),e),a||r){if(s&&!s.Result)switch(s.ErrorCode){case Enums.Errors.InvalidToken:a||App.tokenProblem();break;case Enums.Errors.AuthError:l&&!a&&(this.abortAllRequests(),App.authProblem())}this.executeResponseHandler(t,i,s,e)}},CAjax.prototype.doneExt=function(e,t,i,s,o,n){this.executeResponseHandler(t,i,s,e)},CAjax.prototype.fail=function(e,t,i,s,o,n){var a={Result:!1,ErrorCode:0};switch(Utils.log("Ajax request fail",e.Action,o,e),o){case"abort":a={Result:!1,ErrorCode:Enums.Errors.NotDisplayedError};break;default:case"error":case"parseerror":a=""===n?{Result:!1,ErrorCode:Enums.Errors.NotDisplayedError}:{Result:!1,ErrorCode:Enums.Errors.DataTransferFailed}}this.executeResponseHandler(t,i,a,e)},CAjax.prototype.executeResponseHandler=function(e,t,i,s){i||(i={Result:!1,ErrorCode:0}),AfterLogicApi.runPluginHook&&AfterLogicApi.runPluginHook("ajax-default-response",[s.Action,i]),"function"!=typeof e||i.StopExecuteResponse||e.apply(t,[i,s])},CAjax.prototype.always=function(e,t,i){"abort"!==i&&(_.each(this.requests(),function(t,i){t&&_.isEqual(t.Parameters,e)&&(this.requests()[i]=void 0)},this),this.requests(_.compact(this.requests())),Utils.checkConnection(e.Action,i),App.Prefetcher&&"parsererror"!==i&&!this.hasOpenedRequests()&&App.Prefetcher.start())},Enums.Screens={Login:"login",Information:"information",Header:"header",Mailbox:"mailbox",SingleMessageView:"single-message-view",Compose:"compose",SingleCompose:"single-compose",Settings:"settings",Contacts:"contacts",Calendar:"calendar",FileStorage:"files",Helpdesk:"helpdesk",SingleHelpdesk:"single-helpdesk"},Enums.CalendarDefaultTab={Day:1,Week:2,Month:3},Enums.TimeFormat={F24:"0",F12:"1"},Enums.Errors={InvalidToken:101,AuthError:102,DataBaseError:104,LicenseProblem:105,DemoLimitations:106,Captcha:107,AccessDenied:108,CanNotGetMessage:202,ImapQuota:205,NotSavedInSentItems:304,NoRequestedMailbox:305,CanNotChangePassword:502,AccountOldPasswordNotCorrect:503,FetcherIncServerNotAvailable:702,FetcherLoginNotCorrect:703,HelpdeskThrowInWebmail:805,HelpdeskUserNotExists:807,HelpdeskUserNotActivated:808,IncorrectFileExtension:811,MailServerError:901,DataTransferFailed:1100,NotDisplayedError:1155},Enums.FolderTypes={Inbox:1,Sent:2,Drafts:3,Spam:4,Trash:5,Virus:6,Starred:7,Template:8,System:9,User:10},Enums.FolderFilter={Flagged:"flagged",Unseen:"unseen"},Enums.LoginFormType={Email:0,Login:3,Both:4},Enums.LoginSignMeType={DefaultOff:0,DefaultOn:1,Unuse:2},Enums.ReplyType={Reply:"reply",ReplyAll:"reply-all",Resend:"resend",Forward:"forward"},Enums.Importance={Low:5,Normal:3,High:1},Enums.Sensitivity={Nothing:0,Confidential:1,Private:2,Personal:3},Enums.ContactEmailType={Personal:"Personal",Business:"Business",Other:"Other"},Enums.ContactPhoneType={Mobile:"Mobile",Personal:"Personal",Business:"Business"},Enums.ContactAddressType={Personal:"Personal",Business:"Business"},Enums.ContactSortType={Email:"Email",Name:"Name",Frequency:"Frequency"},Enums.SaveMail={Hidden:0,Checked:1,Unchecked:2},Enums.SettingsTab={Common:"common",EmailAccounts:"accounts",Calendar:"calendar",MobileSync:"mobile_sync",OutLookSync:"outlook_sync",Helpdesk:"helpdesk",Pgp:"pgp",Services:"services",CloudStorage:"cloud-storage"},Enums.AccountSettingsTab={Properties:"properties",Signature:"signature",Filters:"filters",Autoresponder:"autoresponder",Forward:"forward",Folders:"folders",FetcherInc:"fetcher-inc",FetcherOut:"fetcher-out",FetcherSig:"fetcher-sig",IdentityProperties:"identity-properties",IdentitySignature:"identity-signature"},Enums.AccountCreationPopupType={OneStep:1,TwoSteps:2,ConnectToMail:3},Enums.ContactsGroupListType={Personal:0,SubGroup:1,Global:2,SharedToAll:3,All:4},Enums.IcalType={Request:"REQUEST",Reply:"REPLY",Cancel:"CANCEL",Save:"SAVE"},Enums.IcalConfig={Accepted:"ACCEPTED",Declined:"DECLINED",Tentative:"TENTATIVE",NeedsAction:"NEEDS-ACTION"},Enums.IcalConfigInt={Accepted:1,Declined:2,Tentative:3,NeedsAction:0},Enums.Key={Backspace:8,Tab:9,Enter:13,Shift:16,Ctrl:17,Esc:27,Space:32,PageUp:33,PageDown:34,End:35,Home:36,Up:38,Down:40,Left:37,Right:39,Del:46,Six:54,a:65,b:66,c:67,f:70,i:73,k:75,n:78,p:80,q:81,r:82,s:83,u:85,v:86,y:89,z:90,F5:116,Comma:188,Dot:190,Dash:192,Apostrophe:222},Enums.MouseKey={Left:0,Middle:1,Right:2},Enums.FileStorageType={Personal:"personal",Corporate:"corporate",Shared:"shared",GoogleDrive:"google",Dropbox:"dropbox"},Enums.FileStorageLinkType={Unknown:0,GoogleDrive:1,Dropbox:2,YouTube:3,Vimeo:4,SoundCloud:5},Enums.HelpdeskThreadStates={None:0,Pending:1,Waiting:2,Answered:3,Resolved:4,Deferred:5},Enums.HelpdeskPostType={Normal:0,Internal:1,System:2},Enums.HelpdeskFilters={All:0,Pending:1,Resolved:2,InWork:3,Open:4,Archived:9},Enums.CalendarAccess={Full:0,Write:1,Read:2},Enums.CalendarEditRecurrenceEvent={None:0,OnlyThisInstance:1,AllEvents:2},Enums.CalendarRepeatPeriod={None:0,Daily:1,Weekly:2,Monthly:3,Yearly:4},Enums.CalendarAlways={Disable:0,Enable:1},Enums.PhoneAction={Offline:"offline",OfflineError:"offline_error",OfflineInit:"offline_init",OfflineActive:"offline_active",Online:"online",OnlineActive:"online_active",Incoming:"incoming",IncomingConnect:"incoming_connect",Outgoing:"outgoing",OutgoingConnect:"outgoing_connect",Settings:"settings"},Enums.HtmlEditorImageSizes={Small:"small",Medium:"medium",Large:"large",Original:"original"},Enums.MobilePanel={Groups:1,Items:2,View:3},Enums.PgpAction={Import:"import",Generate:"generate",Encrypt:"encrypt",Sign:"sign",EncryptSign:"encrypt-sign",Verify:"ferify",DecryptVerify:"decrypt-ferify"},Enums.SocialType={Unknown:0,Google:1,Dropbox:2,Facebook:3,Twitter:4,Vkontakte:5},Enums.notificationPermission={Granted:"granted",Denied:"denied",Default:"default"},Enums.AnotherMessageComposedAnswer={Discard:"Discard",SaveAsDraft:"SaveAsDraft",Cancel:"Cancel"},Utils.inArray=$.inArray,Utils.isFunc=$.isFunction,Utils.trim=$.trim,Utils.emptyFunction=function(){},Utils.isUnd=function(e){return void 0===e},Utils.isNull=function(e){return null===e},Utils.isNormal=function(e){return!Utils.isUnd(e)&&!Utils.isNull(e)},Utils.isNumeric=function(e){return!!Utils.isNormal(e)&&/^[1-9]+[0-9]*$/.test(e.toString())},Utils.pInt=function(e){var t=window.parseInt(e,10);return isNaN(t)&&(t=0),t},Utils.pString=function(e){return Utils.isNormal(e)?e.toString():""},Utils.isNonEmptyArray=function(e,t){return t=t||1,_.isArray(e)&&t<=e.length},Utils.pImport=function(e,t,i){e[t]=i},Utils.pExport=function(e,t,i){return Utils.isUnd(e[t])?i:e[t]},Utils.encodeHtml=function(e){return e?e.toString().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"):""},Utils.i18n=function(e,t,i,s){var o="",n=Utils.isUnd(I18n[e])?Utils.isNormal(i)?i:e:I18n[e];if(Utils.isUnd(s)||(n=function(e,t){var i=Utils.getPlural(AppData.User.DefaultLanguage,e),s=t.split("|");return s&&s[i]?s[i]:s&&s[0]?s[0]:t}(s,n)),Utils.isNormal(t))for(o in t)if(t.hasOwnProperty(o)){var a=new RegExp("%"+o+"%","g");n=n.replace(a,t[o])}return n},Utils.roundNumber=function(e,t){return Math.round(e*Math.pow(10,t))/Math.pow(10,t)},Utils.friendlySize=function(e){var t=1024,i=t*t,s=t*t*t;return e=Utils.pInt(e),e>=s?Utils.roundNumber(e/s,1)+Utils.i18n("MAIN/GIGABYTES"):e>=i?Utils.roundNumber(e/i,1)+Utils.i18n("MAIN/MEGABYTES"):e>=t?Utils.roundNumber(e/t,0)+Utils.i18n("MAIN/KILOBYTES"):e+Utils.i18n("MAIN/BYTES")},Utils.timeOutAction=function(){var e={};return function(t,i,s){Utils.isUnd(e[t])&&(e[t]=0),window.clearTimeout(e[t]),e[t]=window.setTimeout(i,s)}}(),Utils.$log=null,Utils.aLog=[],Utils.log=function(){function e(e,t){return"string"==typeof t&&t.length>50?t.substring(0,50):t}if(AppData&&AppData.ClientDebug&&App.browser&&!App.browser.ie9AndBelow){var t=Utils.$log||$('<div style="display: none;"></div>').appendTo("body"),i=[];_.each(arguments,function(t){var s="string"==typeof t?t:JSON.stringify(t,e);0===i.length&&(s=" *** "+s+" *** "),i.push(s)}),i.push(moment().format(" *** D MMMM, YYYY, HH:mm:ss *** ")),Utils.$log=t,Utils.aLog.length>200&&Utils.aLog.shift(),Utils.aLog.push(Utils.encodeHtml(i.join(", "))),t.html(Utils.aLog.join("<br /><br />"))}},Utils.getAjaxDataForLog=function(e,t){var i=t;if(t&&t.Result)switch(e){case"MessagesGetList":case"MessagesGetListByUids":i={Result:{Uids:t.Result.Uids,UidNext:t.Result.UidNext,FolderHash:t.Result.FolderHash,MessageCount:t.Result.MessageCount,MessageUnseenCount:t.Result.MessageUnseenCount,MessageResultCount:t.Result.MessageResultCount}};break;case"MessageGet":i={Result:{Folder:t.Result.Folder,Uid:t.Result.Uid,Subject:t.Result.Subject,Size:t.Result.Size,TextSize:t.Result.TextSize,From:t.Result.From,To:t.Result.To}};break;case"MessagesGetBodies":i={Result:_.map(t.Result,function(e){return{Uid:e.Uid,Subject:e.Subject}})}}else t&&(i={Result:t.Result,ErrorCode:t.ErrorCode});return i},Utils.getImportContactsLink=function(){return"?/ImportContacts/"},Utils.getExportContactsLink=function(e){return"?/Raw/Contacts"+e+"/"},Utils.getExportCalendarLinkByHash=function(e,t){return"?/Raw/Calendar/"+e+"/"+t},Utils.getDownloadLinkByHash=function(e,t,i,s){return i=!Utils.isUnd(i)&&!!i,s=Utils.isUnd(s)?"":s,"?/Raw/Download/"+e+"/"+t+"/"+(i?"1":"0")+(""===s?"":"/"+s)},Utils.getIframeLinkByHash=function(e,t,i,s){return i=!Utils.isUnd(i)&&!!i,s=Utils.isUnd(s)?"":s,"?/Raw/Iframe/"+e+"/"+t+"/"+(i?"1":"0")+(""===s?"":"/"+s)},Utils.getIframeWrappwer=function(e,t){return"?/Raw/Iframe/"+e+"/"+window.encodeURIComponent(t)+"/"},Utils.getViewThumbnailLinkByHash=function(e,t,i,s){return i=!Utils.isUnd(i)&&!!i,s=Utils.isUnd(s)?"":s,"?/Raw/Thumbnail/"+e+"/"+t+"/"+(i?"1":"0")+(""===s?"":"/"+s)},Utils.getFilestorageDownloadLinkByHash=function(e,t,i){var s="?/Raw/FilesDownload/"+e+"/"+t;return Utils.isUnd(i)||(s=s+"/0/"+i),s},Utils.getEventDownloadLinkByHash=function(e,t){return"?/Raw/EventAttachment/"+e+"/"+t},Utils.getFilestorageViewLinkByHash=function(e,t,i){var s="?/Raw/FilesView/"+e+"/"+t;return Utils.isUnd(i)||(s=s+"/0/"+i),s},Utils.getFilestorageViewThumbnailLinkByHash=function(e,t,i){var s="?/Raw/FilesThumbnail/"+e+"/"+t;return Utils.isUnd(i)||(s=s+"/0/"+i),s},Utils.getFilestoragePublicViewLinkByHash=function(e){return"?/Window/Files/0/"+e},Utils.getFilestoragePublicDownloadLinkByHash=function(e){return"?/Raw/FilesPub/0/"+e},Utils.daysInMonth=function(e,t){return 0<e&&13>e&&0<t?new Date(t,e,0).getDate():31},Utils.WindowOpener={_iDefaultRatio:.8,_aOpenedWins:[],openMessage:function(e,t){if(e){var i=e.folder(),s=e.uid(),o="";o=t?App.Routing.buildHashFromArray([Enums.Screens.SingleCompose,"drafts",i,s]):App.Routing.buildHashFromArray([Enums.Screens.SingleMessageView,i,"msg"+s]),this.openTab(o)}},openTab:function(e,t){$.cookie("aft-cache-ctrl","1");var i=null;return i=window.open(e,"_blank"),i&&(i.focus(),i.name=t?t:AppData.Accounts?AppData.Accounts.currentId():0,this._aOpenedWins.push(i)),i},open:function(e,t,i){var s=i?",menubar=yes":",menubar=no",o="location=no,toolbar=no,status=no,scrollbars=yes,resizable=yes"+s,n=null;return t=t.replace(/\W/g,""),o+=this._getSizeParameters(),n=window.open(e,t,o),n.focus(),n.name=AppData.Accounts?AppData.Accounts.currentId():0,this._aOpenedWins.push(n),n},getOpenedDraftUids:function(){this._aOpenedWins=_.filter(this._aOpenedWins,function(e){return!e.closed});var e=_.map(this._aOpenedWins,function(e){return e.App&&window.location.origin===e.location.origin?e.App.MailCache.editedDraftUid():""});return App.Screens.hasOpenedMinimizedPopups()&&e.push(App.MailCache.editedDraftUid()),_.uniq(_.compact(e))},closeComposesWithDraftUids:function(e){_.each(this._aOpenedWins,function(t){t.App&&-1!==Utils.inArray(t.App.MailCache.editedDraftUid(),e)&&t.close()}),-1!==Utils.inArray(App.MailCache.editedDraftUid(),e)&&App.Api.closeComposePopup()},closeAll:function(){for(var e=this._aOpenedWins.length,t=0,i=null;t<e;t++)i=this._aOpenedWins[t],i.closed||i.close();this._aOpenedWins=[]},_getSizeParameters:function(){var e=window.screen.width,t=Math.ceil(e*this._iDefaultRatio),i=Math.ceil((e-t)/2),s=window.screen.height,o=Math.ceil(s*this._iDefaultRatio),n=Math.ceil((s-o)/2);return",width="+t+",height="+o+",top="+n+",left="+i}},Utils.delegateRun=function(e,t,i){e&&e[t]&&e[t].apply(e,_.isArray(i)?i:[])},Utils.strRepeat=function(e,t){return new Array(t+1).join(e)},Utils.deferredUpdate=function(e,t,i,s){!e.__interval&&t?(e.__state=!0,s(e,!0),e.__interval=window.setInterval(function(){e.__state||(s(e,!1),window.clearInterval(e.__interval),e.__interval=null)},i)):t||(e.__state=!1)},Utils.draggableMessages=function(){return $('<div class="draggable draggableMessages"><div class="content"><span class="count-text"></span></div></div>').appendTo("#pSevenHidden")},Utils.draggableContacts=function(){return $('<div class="draggable draggableContacts"><div class="content"><span class="count-text"></span></div></div>').appendTo("#pSevenHidden")},Utils.removeActiveFocus=function(){if(document&&document.activeElement&&document.activeElement.blur){var e=$(document.activeElement);(e.is("input")||e.is("textarea"))&&document.activeElement.blur()}},Utils.uiDropHelperAnim=function(e,t){var i=0,s=0,o=0,n=0,a=0,r=0,l=t.helper.clone().appendTo("#pSevenHidden"),h=$(e.target).find(".animGoal"),c=null;h=$(h[0]?h[0]:e.target),c=h&&h[0]?h.offset():null,c&&(i=window.Math.round(c.left),s=window.Math.round(c.top),a=h.width(),r=h.height(),o=i,0<a&&(o+=window.Math.round(a/2)),n=s,0<r&&(n+=window.Math.round(r/2)),l.animate({left:o+"px",top:n+"px","font-size":"0px",opacity:0},800,"easeOutQuint",function(){$(this).remove()}))},Utils.isTextFieldFocused=function(){var e=document&&document.activeElement?document.activeElement:null,t=e?e.tagName:null,i=e&&e.type?e.type.toLowerCase():null,s=e?e.contentEditable:null;return"INPUT"===t&&("text"===i||"password"===i||"email"===i)||"TEXTAREA"===t||"IFRAME"===t||"true"===s},Utils.removeSelection=function(){window.getSelection?window.getSelection().removeAllRanges():document.selection&&document.selection.empty()},Utils.getMonthNamesArray=function(){for(var e=Utils.i18n("DATETIME/MONTH_NAMES").split(" "),t=12,i=e.length;i<t;i++)e[i]="";return e},Utils.getPlural=function(e,t){var i=0;switch(t=Utils.pInt(t),e){case"Arabic":i=0===t?0:1===t?1:2===t?2:t%100>=3&&t%100<=10?3:t%100>=11?4:5;break;case"Bulgarian":i=1===t?0:1;break;case"Chinese-Simplified":i=0;break;case"Chinese-Traditional":i=1===t?0:1;break;case"Czech":i=1===t?0:t>=2&&t<=4?1:2;break;case"Danish":i=1===t?0:1;break;case"Dutch":i=1===t?0:1;break;case"English":i=1===t?0:1;break;case"Estonian":i=1===t?0:1;break;case"Finnish":i=1===t?0:1;break;case"French":i=1===t?0:1;break;case"German":i=1===t?0:1;break;case"Greek":i=1===t?0:1;break;case"Hebrew":i=1===t?0:1;break;case"Hungarian":i=1===t?0:1;break;case"Italian":i=1===t?0:1;break;case"Japanese":i=0;break;case"Korean":i=0;break;case"Latvian":i=t%10===1&&t%100!==11?0:0!==t?1:2;break;case"Lithuanian":i=t%10===1&&t%100!==11?0:t%10>=2&&(t%100<10||t%100>=20)?1:2;break;case"Norwegian":i=1===t?0:1;break;case"Persian":i=0;break;case"Polish":i=1===t?0:t%10>=2&&t%10<=4&&(t%100<10||t%100>=20)?1:2;break;case"Portuguese-Portuguese":i=1===t?0:1;break;case"Portuguese-Brazil":i=1===t?0:1;break;case"Romanian":i=1===t?0:0===t||t%100>0&&t%100<20?1:2;break;case"Russian":i=t%10===1&&t%100!==11?0:t%10>=2&&t%10<=4&&(t%100<10||t%100>=20)?1:2;break;case"Slovenian":i=t%10===1&&t%100!==11?0:t%10===2&&t%100!==12?1:2;break;case"Serbian":i=t%10===1&&t%100!==11?0:t%10>=2&&t%10<=4&&(t%100<10||t%100>=20)?1:2;break;case"Spanish":i=1===t?0:1;break;case"Swedish":i=1===t?0:1;break;case"Thai":i=0;break;case"Turkish":i=1===t?0:1;break;case"Ukrainian":i=t%10===1&&t%100!==11?0:t%10>=2&&t%10<=4&&(t%100<10||t%100>=20)?1:2;break;case"Vietnamese":i=0;break;default:i=0}return i},Utils.getFileExtension=function(e){var t="",i=e.lastIndexOf(".");return i>-1&&(t=e.substr(i+1)),t},Utils.getFileNameWithoutExtension=function(e){var t=e,i=e.lastIndexOf(".");return i>-1&&(t=e.substr(0,i)),t},Utils.defaultOptionsAfterRender=function(e,t){t&&(Utils.isUnd(t.disable)||ko.applyBindingsToNode(e,{disable:t.disable},t))},Utils.getDateFormatForMoment=function(e){var t="MM/DD/YYYY";switch(e){case"MM/DD/YYYY":t="MM/DD/YYYY";break;case"DD/MM/YYYY":t="DD/MM/YYYY";break;case"DD Month YYYY":t="DD MMMM YYYY"}return t},Utils.getDateFormatForDatePicker=function(e){var t="mm/dd/yy";
switch(e){case"MM/DD/YYYY":t="mm/dd/yy";break;case"DD/MM/YYYY":t="dd/mm/yy";break;case"DD Month YYYY":t="dd MM yy"}return t},Utils.getDateFormatsForSelector=function(){return _.map(AppData.App.DateFormats,function(e){switch(e){case"MM/DD/YYYY":return{name:Utils.i18n("DATETIME/DATEFORMAT_MMDDYYYY"),value:e};case"DD/MM/YYYY":return{name:Utils.i18n("DATETIME/DATEFORMAT_DDMMYYYY"),value:e};case"DD Month YYYY":return{name:Utils.i18n("DATETIME/DATEFORMAT_DDMONTHYYYY"),value:e};default:return{name:e,value:e}}})},Utils.getTitleForEvent=function(e){var t=e?Utils.trim(e.replace(/[\n\r]/," ")):"",i=t.indexOf(" ",180);return i>=0&&(t=t.substring(0,i)+"..."),t.length>200&&(t=t.substring(0,200)+"..."),t},Utils.desktopNotify=function(){var e=[];return function(t){if(t&&AppData.User.DesktopNotifications&&window.Notification&&!App.focused())switch(t.action){case"show":if(window.Notification.permission!==Enums.notificationPermission.Denied){var i,s={body:t.body||"",dir:t.dir||"auto",lang:t.lang||"",tag:t.tag||Math.floor(900*Math.random()+100),icon:t.icon||!1},o=function(){i=new window.Notification(t.title,s),i.onclick=function(e){t.callback&&t.callback(),i.close()},t.timeout&&setTimeout(function(){i.close()},t.timeout),e.push(i)};window.Notification.permission===Enums.notificationPermission.Granted?o():window.Notification.permission===Enums.notificationPermission.Default&&window.Notification.requestPermission(function(e){e===Enums.notificationPermission.Granted&&o()})}break;case"hide":_.each(e,function(i,s){t.tag===i.tag&&(i.close(),e.splice(s,1))});break;case"hideAll":_.each(e,function(e){e.close()}),e.length=0}}}(),Utils.isRTL=function(){return $html.hasClass("rtl")},Utils.validateFileOrFolderName=function(e){return e=Utils.trim(e),""!==e&&!/["\/\\*?<>|:]/.test(e)},Utils.shadeColor=function(e,t){var i=!1,s=0,o=0,n=0,a=0;return"#"===e[0]&&(e=e.slice(1),i=!0),s=window.parseInt(e,16),o=(s>>16)+t,o>255?o=255:o<0&&(o=0),n=(s>>8&255)+t,n>255?n=255:n<0&&(n=0),a=(255&s)+t,a>255?a=255:a<0&&(a=0),(i?"#":"")+(a|n<<8|o<<16).toString(16)},Utils.extend=function(e,t){var i=function(){};i.prototype=t.prototype,e.prototype=new i,e.prototype.constructor=e},Utils.thumbQueue=function(){var e={},t={},i=2;return function(s,o,n){o&&n?!(s in t)||t[s]>0?(s in t||(t[s]=i,e[s]=[]),t[s]--,n(o)):e[s].push({imageSrc:o,imageSrcObserver:n,messageUid:s}):e[s]&&e[s].length&&(e[s][0].imageSrcObserver(e[s][0].imageSrc),e[s].shift())}}(),Utils.checkConnection=function(){var e=-1,t=(new Date).getTime(),i=0,s=!1;return setInterval(function(){i=(new Date).getTime(),s=i>t+5e3+1e3,t=i,s&&App.Api.hideError(!0)},5e3),function(t,i){clearTimeout(e),"error"!==i?(App.InternetConnectionError=!1,App.Api.hideError(!0)):"SystemPing"===t?(App.InternetConnectionError=!0,App.Api.showError(Utils.i18n("WARNING/NO_INTERNET_CONNECTION"),!1,!0,!0),e=setTimeout(function(){App.Ajax.send({Action:"SystemPing"})},6e4)):App.Ajax.send({Action:"SystemPing"})}}(),Utils.loadScript=function(e,t,i,s){var o=document.createElement("script");!Utils.isUnd(s)&&t&&(window[s]=t),Utils.isUnd(i)&&(i={}),_.each(i,function(e,t){o.setAttribute(t,e)}),o.type="text/javascript",o.src=e,document.body.appendChild(o)},Utils.registerMailto=function(e){!window.navigator||!Utils.isFunc(window.navigator.registerProtocolHandler)||e&&1===App.Storage.getData("MailtoAsked")||(window.navigator.registerProtocolHandler("mailto",Utils.Common.getAppPath()+"#"+Enums.Screens.Compose+"/to/%s",""!==AppData.App.SiteName?AppData.App.SiteName:"WebMail"),App.Storage.setData("MailtoAsked",1))},Utils.CustomTooltip={_$Region:null,_$ArrowTop:null,_$Text:null,_$ArrowBottom:null,_iArrowBorderLeft:0,_iArrowMarginLeft:0,_iLeftShift:0,_bInitialized:!1,_bShown:!1,iHideTimer:0,iTimer:0,init:function(){this._bInitialized||(this._$Region=$('<span class="custom_tooltip"></span>').appendTo("body").hide(),this._$ArrowTop=$('<span class="custom_tooltip_arrow top"></span>').appendTo(this._$Region),this._$Text=$('<span class="custom_tooltip_text"></span>').appendTo(this._$Region),this._$ArrowBottom=$('<span class="custom_tooltip_arrow bottom"></span>').appendTo(this._$Region),this._iArrowMarginLeft=Utils.pInt(this._$ArrowTop.css("margin-left")),this._iArrowBorderLeft=Utils.pInt(this._$ArrowTop.css("border-left-width")),this._iLeftShift=Utils.pInt(this._$Region.css("margin-left"))+this._iArrowMarginLeft+this._iArrowBorderLeft,this._bInitialized=!0),this._$ArrowTop.show(),this._$ArrowBottom.hide(),this._$ArrowTop.css({"margin-left":this._iArrowMarginLeft+"px"}),this._$ArrowBottom.css({"margin-left":this._iArrowMarginLeft+"px"})},show:function(e,t){this.init();var i=t.offset(),s=t.width(),o=s<70?s/2:s/4,n=Utils.pInt(t.css("padding-left")),a=$("body");this._$Text.html(e),this._bShown=!0,this._$Region.stop().fadeIn(260,_.bind(function(){this._bShown||this._$Region.hide()},this)).css({top:i.top+t.outerHeight()+1,left:i.left+n+o-this._iLeftShift,right:"auto"}),a.outerHeight()<this._$Region.outerHeight()+this._$Region.offset().top&&(this._$ArrowTop.hide(),this._$ArrowBottom.show(),this._$Region.css({top:i.top-this._$Region.outerHeight()})),setTimeout(function(){a.width()<this._$Region.outerWidth(!0)+this._$Region.offset().left&&(this._$Region.css({left:"auto",right:0}),this._$ArrowTop.css({"margin-left":o+i.left-this._$Region.offset().left-this._iArrowBorderLeft+"px"}),this._$ArrowBottom.css({"margin-left":o+i.left-this._$Region.offset().left-this._iArrowBorderLeft+Utils.pInt(this._$Region.css("margin-right"))+"px"}))}.bind(this),1)},hide:function(){this._bInitialized&&(this._bShown=!1,this._$Region.hide())}},Utils.htmlStartsWithBlockquote=function(e){var t=e.split("<blockquote"),i=t.length>0?t[0]:"",s=Utils.trim(i.replace(/<[^>]*>/g,""));return""===s},Utils.escapeQuotes=function(e){return e.replace(/'/g,"\\'").replace(/"/g,'\\"')},Utils.checkCookies=function(){$.cookie("checkCookie","1",{path:"/"});var e="1"===$.cookie("checkCookie");return e||App.Screens.showError(Utils.i18n("WARNING/COOKIES_DISABLED"),!1,!0),e},Utils.calmEvent=function(e){e&&(e.stop&&e.stop(),e.preventDefault&&e.preventDefault(),e.stopPropagation&&e.stopPropagation(),e.stopImmediatePropagation&&e.stopImmediatePropagation(),e.cancelBubble=!0,e.returnValue=!1)},Utils.Calendar={},Utils.Calendar.getTimeListStepHour=function(e){var t=["01:00","02:00","03:00","04:00","05:00","06:00","07:00","08:00","09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00","00:00"];return _.map(t,function(t){var i=moment(t,"HH:mm"),s=i.format(e),o=i.format("H");return"00:00"===t&&(o="24"),{text:s,value:o}})},Utils.Calendar.getTimeListStepHalfHour=function(e){var t=["00:00","00:30","01:00","01:30","02:00","02:30","03:00","03:30","04:00","04:30","05:00","05:30","06:00","06:30","07:00","07:30","08:00","08:30","09:00","09:30","10:00","10:30","11:00","11:30","12:00","12:30","13:00","13:30","14:00","14:30","15:00","15:30","16:00","16:30","17:00","17:30","18:00","18:30","19:00","19:30","20:00","20:30","21:00","21:30","22:00","22:30","23:00","23:30"];return _.map(t,function(t){var i=moment(t,"HH:mm"),s=i.format(e);return{text:s,value:s}})},Utils.Common={},Utils.Common.getRequestParam=function(e){var t=[],i=[],s=null;return void 0===this.aGetParams&&(t=""!==location.search?location.search.substr(1).split("&"):[],t.length>0&&_.each(t,function(e){var t=e.split("=");i[t[0]]=t.length>1?t[1]:""}),this.aGetParams=i),void 0!==this.aGetParams[e]&&(s=this.aGetParams[e]),s},Utils.Common.getAppPath=function(){var e=window.location.origin||window.location.protocol+"//"+window.location.host;return e+window.location.pathname},Utils.Common.clearAndReloadLocation=function(e,t){if(e||""===window.location.search&&""===window.location.hash)window.location.reload();else{var i=Utils.Common.getAppPath();t||""===window.location.search||(i+=window.location.search),"replaceState"in history?(history.replaceState("",document.title,i),window.location.reload(!0)):window.location.href=i}},Utils.File={},Utils.File.getViewLinkByHash=function(e,t,i,s){var o="?/Raw/View/"+e+"/"+t,n=i===!0?"/1":"/0",a="string"==typeof s&&""!==s?"/"+s:"";return o+n+a},"object"!=typeof Utils&&(window.Utils={}),Utils.Message={},Utils.Message.showInlinePictures=function(e,t,i,s){var o=function(e){return _.find(t,function(t){return t.CID===e})},n=function(e){return _.find(t,function(t){return t.ContentLocation===e})};"string"!=typeof s&&(s=""),i.length>0&&($("[data-x-src-cid]",e).each(function(){var e=$(this).attr("data-x-src-cid"),t=o(e);t&&t.ViewLink.length>0&&$(this).attr("src",s+t.ViewLink)}),$("[data-x-style-cid]",e).each(function(){var e="",t=$(this).attr("data-x-style-cid-name"),i=$(this).attr("data-x-style-cid"),s=o(i);s&&s.ViewLink.length>0&&""!==t&&(e=$.trim($(this).attr("style")),e=""===e?"":";"===e.substr(-1)?e+" ":e+"; ",$(this).attr("style",e+t+": url('"+s.ViewLink+"')"))})),$("[data-x-src-location]",e).each(function(){var e=$(this).attr("data-x-src-location"),t=n(e);t||(t=o(e)),t&&t.ViewLink.length>0&&$(this).attr("src",s+t.ViewLink)})},Utils.Message.showExternalPictures=function(e){$("[data-x-src]",e).each(function(){$(this).attr("src",$(this).attr("data-x-src")).removeAttr("data-x-src")}),$("[data-x-style-url]",e).each(function(){var e=$.trim($(this).attr("style"));e=""===e?"":";"===e.substr(-1)?e+" ":e+"; ",$(this).attr("style",e+$(this).attr("data-x-style-url")).removeAttr("data-x-style-url")})},Utils.Message.joinReplyPrefixesInSubject=function(e,t,i){var s=[t.toUpperCase()],o=[i.toUpperCase()],n=_.union(s,o).join("|"),a="",r=e.split(":"),l=[],h="";return _.each(r,function(e){if(0===h.length){var a=$.trim(e.toUpperCase()),r=_.indexOf(s,a)!==-1,c=_.indexOf(o,a)!==-1,p=1,d=l.length>0?l[l.length-1]:null;if(!r&&!c){var u=new window.RegExp("^\\s?("+n+")\\s?[\\[\\(]([\\d]+)[\\]\\)]$","gi").exec(a);u&&3===u.length&&(r=_.indexOf(s,u[1].toUpperCase())!==-1,c=_.indexOf(o,u[1].toUpperCase())!==-1,p=Utils.pInt(u[2]))}r?d&&d.prefix===t?d.count+=p:l.push({prefix:t,count:p}):c?d&&d.prefix===i?d.count+=p:l.push({prefix:i,count:p}):h=e}else h+=":"+e}),_.each(l,function(e){a+=1===e.count?e.prefix+": ":e.prefix+"["+e.count+"]: "}),a+=$.trim(h)},Utils.Message.displayPrintMessageInWindow=function(e,t){if(App.browser.edge){var i=t.split(/<style[^>]*>/);2===i.length&&(i=_.union([i[0]],i[1].split("</style>"))),3===i.length&&($(e.document).find("head").append("<style scoped>"+i[1]+"</style>"),$(e.document.body).html(i[0]+i[2]))}else $(e.document.body).html(t)},Utils.Address={},Utils.Address.isCorrectEmail=function(e){return!!e.match(/^[A-Z0-9\"!#\$%\^\{\}`~&'\+\-=_\.]+@[A-Z0-9\.\-]+$/i)},Utils.Address.getFullEmail=function(e,t){var i="";return i=t.length>0?e.length>0?Utils.Address.isCorrectEmail(e)||e.indexOf(",")!==-1?'"'+e+'" <'+t+">":e+" <"+t+">":t:e},Utils.Address.getEmailParts=function(e,t){for(var i=e.indexOf('"'),s=e.indexOf('"',i+1),o=e.indexOf("<",s),n=-1,a=-1,r="",l="";o!==-1;)n=o,o=e.indexOf("<",o+1);return o=n,a=e.indexOf(">",o+1),o===-1?l=$.trim(e):(i=t?-1:i,r=i===-1?$.trim(e.substring(0,o)):$.trim(e.substring(i+1,s)),l=$.trim(e.substring(o+1,a))),{name:r,email:l,fullEmail:Utils.Address.getFullEmail(r,l)}},Utils.Address.getArrayRecipients=function(e,t){for(var i=[",",";"," "],s="",o=e,n=0,a=0,r="",l=null,h=[];o.length>0;){for(n=Utils.Address._getFirstSeparatorPosition(o,i),a=n;_.indexOf(i,o[a+1])!==-1;)a++;n===-1?(r=s+o,l=Utils.Address.getEmailParts(r),(t||Utils.Address.isCorrectEmail(l.email))&&h.push(l),o=""):(r=s+o.substring(0,n),l=Utils.Address.getEmailParts(r),Utils.Address.isCorrectEmail(l.email)?(h.push(l),s=""):s+=o.substring(0,a+1),o=o.substring(a+1))}return h},Utils.Address._getFirstSeparatorPosition=function(e,t){var i=-1;return _.each(t,function(t){var s=e.indexOf(t);s!==-1&&(i===-1||s<i)&&(i=s)}),i},Utils.Address.getIncorrectEmailsFromAddressString=function(e){for(var t=e.replace(/"[^"]*"/g,"").replace(/;/g,",").split(","),i=[],s=0,o=t.length,n="",a=null;s<o;s++)n=$.trim(t[s]),n.length>0&&(a=Utils.Address.getEmailParts($.trim(t[s])),Utils.Address.isCorrectEmail(a.email)||i.push(a.email));return i},ko.bindingHandlers.command={init:function(e,t,i,s){var o=$(e),n=t();if(!n||!n.enabled||!n.canExecute)throw new Error("You are not using command function");o.addClass("command"),ko.bindingHandlers[o.is("form")?"submit":"click"].init.apply(s,arguments)},update:function(e,t){var i=!0,s=$(e),o=t();i=o.enabled(),s.toggleClass("command-not-enabled",!i),i&&(i=o.canExecute(),s.toggleClass("unavailable",!i)),s.toggleClass("command-disabled disable disabled",!i),s.toggleClass("enable",i)}},ko.bindingHandlers.simpleTemplate={init:function(e,t){var i=$(e);i.length>0&&"replaced"!==i.data("replaced")&&(i.html(i.html().replace(/&lt;script(.*?)&gt;/i,"<script$1>").replace(/&lt;\/script(.*?)&gt;/i,"</script>")),i.data("replaced","replaced"))}},ko.bindingHandlers.findFocused={init:function(e){var t=$(e),i=null;i=t.find(".catch-focus"),i&&1===i.length&&i[0]&&i.on("blur",function(){t.removeClass("focused")}).on("focus",function(){t.addClass("focused")})}},ko.bindingHandlers.findFilled={init:function(e){var t=$(e),i=null,s=null;i=t.find(".catch-filled"),i&&1===i.length&&i[0]&&(s=function(){t.toggleClass("filled",""!==i.val())},s(),_.delay(s,200),i.on("change",s))}},ko.bindingHandlers.alert={init:function(e,t){window.alert(ko.utils.unwrapObservable(t()))},update:function(e,t){window.alert(ko.utils.unwrapObservable(t()))}},ko.bindingHandlers.onEnter={init:function(e,t,i,s){$(e).on("keydown",function(i){if(i.keyCode===Enums.Key.Enter)return $(e).trigger("change"),t().call(s,ko.dataFor(e)),!1})}},ko.bindingHandlers.onCtrlEnter={init:bMobileApp?null:function(e,t,i,s){var o=$(e);o.on("keydown",function(i){i.ctrlKey&&i.keyCode===Enums.Key.Enter&&(o.trigger("change"),t().call(s,ko.dataFor(e)))})}},ko.bindingHandlers.onEsc={init:bMobileApp?null:function(e,t,i,s){var o=$(e);o.on("keydown",function(i){i.keyCode===Enums.Key.Esc&&(o.trigger("change"),t().call(s,ko.dataFor(e)))})}},ko.bindingHandlers.onFocusSelect={init:function(e,t,i,s){$(e).on("focus",function(t){e.select()})}},ko.bindingHandlers.fadeIn={update:function(e,t){ko.utils.unwrapObservable(t())&&$(e).hide().fadeIn("fast")}},ko.bindingHandlers.fadeOut={update:function(e,t){ko.utils.unwrapObservable(t())&&$(e).fadeOut()}},ko.bindingHandlers.csstext={init:function(e,t){e&&e.styleSheet&&!Utils.isUnd(e.styleSheet.cssText)?e.styleSheet.cssText=ko.utils.unwrapObservable(t()):$(e).text(ko.utils.unwrapObservable(t()))},update:function(e,t){e&&e.styleSheet&&!Utils.isUnd(e.styleSheet.cssText)?e.styleSheet.cssText=ko.utils.unwrapObservable(t()):$(e).text(ko.utils.unwrapObservable(t()))}},ko.bindingHandlers.i18n={init:function(e,t){var i=$(e).data("i18n"),s=i?Utils.i18n(i):i;if(""!==s)switch(t()){case"value":$(e).val(s);break;case"text":$(e).text(s);break;case"html":$(e).html(s);break;case"title":$(e).attr("title",s);break;case"placeholder":$(e).attr({placeholder:s})}}},ko.bindingHandlers.link={init:function(e,t){$(e).attr("href",ko.utils.unwrapObservable(t()))}},ko.bindingHandlers.title={init:function(e,t){$(e).attr("title",ko.utils.unwrapObservable(t()))},update:function(e,t){$(e).attr("title",ko.utils.unwrapObservable(t()))}},ko.bindingHandlers.initDom={init:function(e,t){if(t())if(_.isArray(t()))for(var i=t(),s=i.length-1;0<=s;s--)i[s]($(e));else t()($(e))}},ko.bindingHandlers.customScrollbar={init:bMobileApp?null:function(e,t,i,s){if(!bMobileDevice){var o=$(e),n=_.defaults(t(),{oScroll:null,scrollToTopTrigger:null,scrollToBottomTrigger:null,scrollTo:null}),a=null;n=n,o.addClass("scroll-wrap").customscroll(n),a=o.data("customscroll"),n.oScroll&&Utils.isFunc(n.oScroll.subscribe)?n.oScroll(a):n.oScroll=a,Utils.isUnd(n.reset)||(e._customscroll_reset=_.throttle(function(){a.reset()},100)),n.scrollToTopTrigger&&Utils.isFunc(n.scrollToTopTrigger.subscribe)&&n.scrollToTopTrigger.subscribe(function(){a&&a.scrollToTop()}),n.scrollToBottomTrigger&&Utils.isFunc(n.scrollToBottomTrigger.subscribe)&&n.scrollToBottomTrigger.subscribe(function(){a&&a.scrollToBottom()}),n.scrollTo&&Utils.isFunc(n.scrollTo.subscribe)&&n.scrollTo.subscribe(function(){a&&a.scrollTo(n.scrollTo())})}},update:bMobileApp?null:function(e,t,i,s,o){bMobileDevice||(e._customscroll_reset&&e._customscroll_reset(),Utils.isUnd(t().top)||$(e).data("customscroll").vertical.set(t().top))}},ko.bindingHandlers.customOptions={init:function(){return{controlsDescendantBindings:!0}},update:function(e,t,i,s,o){for(var n=0,a=0,r=ko.utils.arrayMap(ko.utils.arrayFilter(e.childNodes,function(e){return e.tagName&&"OPTION"===e.tagName&&e.selected}),function(e){return ko.selectExtensions.readValue(e)||e.innerText||e.textContent}),l=e.scrollTop,h=ko.utils.unwrapObservable(t());e.length>0;)ko.cleanNode(e.options[0]),e.remove(0);if(h){"number"!=typeof h.length&&(h=[h]);var c=i().optionsBind;for(n=0,a=h.length;n<a;n++){var p=document.createElement("OPTION"),d=ko.utils.unwrapObservable(h[n]);ko.selectExtensions.writeValue(p,d),p.appendChild(document.createTextNode(d)),e.appendChild(p),c&&(p.setAttribute("data-bind",c),ko.applyBindings(o.createChildContext(d),p))}var u=e.getElementsByTagName("OPTION"),m=0,g=navigator.userAgent.indexOf("MSIE 6")>=0;for(n=0,a=u.length;n<a;n++)ko.utils.arrayIndexOf(r,ko.selectExtensions.readValue(u[n]))>=0&&(g?u[n].setAttribute("selected",!0):u[n].selected=!0,m++);e.scrollTop=l,m<r.length&&ko.utils.triggerEvent(e,"change")}}},ko.bindingHandlers.splitter={init:bMobileApp?null:function(e,t){setTimeout(function(){$(e).splitter(t())},1)}},ko.bindingHandlers.dropdown={update:function(e,t,i,s){var o,n,a,r=$(e),l=_.defaults(t(),{disabled:"disabled",expand:"expand",control:!0,container:".dropdown_content",scrollToTopContainer:".scroll-inner",passClick:!0,trueValue:!0}),h="function"==typeof l.control?l.control():l.control,c=r.find(".control"),p=r.find(".dropdown"),d=r.find(".dropdown_helper"),u=r.find(".dropdown_arrow"),m=r.find(".dropdown_arrow.bottom"),g=$(document),A=!1,f=function(){Utils.isUnd(l.callback)||l.callback.call(s,!!r.hasClass(l.expand)&&l.trueValue,r)},C=function(e){e.stopPropagation()},b=function(){l.scrollToTopContainer&&r.find(l.scrollToTopContainer).scrollTop(0)},S=function(e){Utils.isUnd(e)&&(e=!r.hasClass(l.expand)),!e&&r.hasClass(l.expand)&&b(),r.toggleClass(l.expand,e),m.length>0&&r.hasClass(l.expand)&&p.css({top:r.position().top-d.height()+"px",left:r.position().left+"px",width:"auto"})},y=function(e){o=d.offset(),Utils.isUnd(o)||(n=o.left+10,a=$(window).width()-(n+d.outerWidth(!0)),a>0&&(a=0),d.css("left",e||a+"px"),u.css("left",e||Math.abs(a?a+parseInt(u.css("margin-left")):0)+"px"))},E=function(e){var t=$(e.originalEvent.originalTarget).parents(".dropdown"),i=t.length>0;i||r.hasClass(l.disabled)||A||(S(),_.defer(function(){f()}),r.hasClass(l.expand)&&(l.close&&l.close.subscribe&&l.close(!0),_.defer(function(){g.on("click.dropdown",function(e){!l.passClick&&e.button===Enums.MouseKey.Right||A||(g.unbind("click.dropdown"),l.close&&l.close.subscribe&&l.close(!1),S(!1),f(),y(0)),A=!1})}),y()))};r.off(),c.off(),l.passClick||(r.find(l.container).on("click",C),r.on("click",C),c.on("click",C)),S(!1),l.close&&l.close.subscribe&&l.close.subscribe(function(e){e||(g.unbind("click.dropdown"),S(!1)),f()}),r.on("mousedown",function(e,t){A=$(e.target).hasClass("customscroll-scrollbar")||$(e.target.parentElement).hasClass("customscroll-scrollbar")}),r.on("click",function(e){h||E(e)}),c.on("click",function(e){h&&E(e)})}},ko.bindingHandlers.customSelect={init:function(e,t,i,s){var o=$(e),n=_.defaults(t(),{disabled:"disabled",selected:"selected",expand:"expand",control:!0,input:!1,expandState:function(){}}),a=[],r=n.control?o.find(".control"):o,l=o.find(".dropdown_content"),h=o.find(".link"),c=function(e){_.each(a,function(e){e.removeClass(n.selected)});var t=_.find(n.options,function(t){return t[n.optionsValue]===e});return Utils.isUnd(t)?t=n.options[0]:(a[_.indexOf(n.options,t)].addClass(n.selected),h.text($.trim(t[n.optionsText]))),t[n.optionsValue]},p=function(e){l.empty(),a=[],_.each(e?e:n.options,function(e){var t=$('<span class="item"></span>').text(e[n.optionsText]).data("value",e[n.optionsValue]),i=e.isDisabled;i?t.data("isDisabled",i).addClass("disabled"):t.data("isDisabled",i).removeClass("disabled"),a.push(t),l.append(t)},this)};p(),l.on("click",".item",function(){var e=$(this);e.data("isDisabled")||n.value(e.data("value"))}),!n.input&&n.value&&n.value.subscribe&&(n.value.subscribe(function(){var e=c(n.value());n.value()!==e&&n.value(e)},s),n.value.valueHasMutated()),n.input&&n.value&&n.value.subscribe&&(n.value.subscribe(function(){c(n.value())},s),n.value.valueHasMutated()),n.input&&n.value&&n.value.subscribe&&(n.value.subscribe(function(){c(n.value())},s),n.value.valueHasMutated()),n.alarmOptions&&n.alarmOptions.subscribe(function(){p()},s),n.timeOptions&&n.timeOptions.subscribe(function(e){p(e)},s),o.removeClass(n.expand),r.click(function(e){if(!o.hasClass(n.disabled)&&(o.toggleClass(n.expand),n.expandState(o.hasClass(n.expand)),o.hasClass(n.expand))){var t=o.find(".dropdown_content"),i=t.find(".selected");i.position()&&(t.scrollTop(0),t.scrollTop(i.position().top-100)),_.defer(function(){$(document).one("click",function(){o.removeClass(n.expand),n.expandState(!1)})})}})}},ko.bindingHandlers.moveToFolderFilter={init:function(e,t,i,s,o){var n=$(e),a=t(),r=$(e).find(a.container),l=_.isArray(a.options)?a.options:a.options(),h=a.value?a.value():"",c=_.find(l,function(e){return e[a.optionsValue]===h});c||(h="",a.value("")),n.removeClass("expand"),r.empty(),_.each(l,function(e){var t=$('<span class="item"></span>').text(e[a.optionsText]).data("value",e[a.optionsValue]);h===e[a.optionsValue]&&t.addClass("selected"),e.jq=t,r.append(t)}),r.on("click",".item",function(){var e=$(this).data("value");a.value(e)}),n.click(function(){n.toggleClass("expand"),n.hasClass("expand")&&_.defer(function(){$(document).one("click",function(){n.removeClass("expand")})})})},update:function(e,t){var i=$(e),s=t(),o=_.isArray(s.options)?s.options:s.options(),n=s.value?s.value():"",a=_.find(o,function(e){return e[s.optionsValue]===n}),r=i.find(".link");_.each(o,function(e){e.jq&&e.jq.toggleClass("selected",n===e[s.optionsValue])}),a&&r.text($.trim(a[s.optionsText]))}},ko.bindingHandlers.contactCardInMessage={update:bMobileApp||bMobileDevice?null:function(e,t,i,s){var o=$(e),n=t(),a=n.address,r=$("div.item_viewer[data-email='"+a+"']"),l=!1,h=0,c=function(){r&&o&&(l=!0,clearTimeout(h),setTimeout(function(){var e,t,i,s=o.offset();l&&s.left+s.top!==0&&(e=s.left+10,t=s.top+o.height()+6,i=$(window).width()-(e+396),i>0&&(i=0),r.addClass("expand").offset({top:t,left:e+i}))},180))},p=function(){l&&r&&o&&(l=!1,h=setTimeout(function(){l||r.removeClass("expand")},200))};r.length>0?(o.off().on("mouseover",function(){r.off().on("mouseenter",c).on("mouseleave",p).find(".link, .button").off(".links").on("click.links",function(){l=!1,r.removeClass("expand")}),setTimeout(function(){r.find(".link, .button").off("click.links").on("click.links",function(){l=!1,r.removeClass("expand")})}.bind(this),100),c()}).on("mouseout",p),l=!1,r.removeClass("expand")):o.off()}},ko.bindingHandlers.contactcard={init:bMobileApp||bMobileDevice?null:function(e,t,i,s){var o=$(e),n=!1,a=_.defaults(t(),{disabled:"disabled",expand:"expand",control:!0}),r=a.control?o.find(".control"):o;void 0!==a.trigger&&void 0!==a.trigger.subscribe&&(o.removeClass(a.expand),r.bind({mouseover:function(){!o.hasClass(a.disabled)&&a.trigger()&&(n=!0,_.delay(function(){n&&(void 0!==a.controlWidth&&void 0!==a.controlWidth.subscribe&&a.controlWidth(r.width()),o.addClass(a.expand))},200))},mouseout:function(){a.trigger()&&(n=!1,_.delay(function(){n||o.removeClass(a.expand)},200))}}))}},ko.bindingHandlers.checkmail={update:function(e,t,i,s,o){var n=e.oOptions||null,a=e.jqElement||null,r=e.oIconIE||null,l=t(),h=l.state;void 0!==l.state&&(a||(e.jqElement=a=$(e)),n||(e.oOptions=n=_.defaults(l,{activeClass:"process",duration:800})),Utils.deferredUpdate(a,h,n.duration,function(t,i){if(App.browser.ie9AndBelow)if(r||(e.oIconIE=r=a.find(".icon")),!r.__intervalIE&&i){var s=0,o="";r.__intervalIE=setInterval(function(){o="0px -"+20*s+"px",s=s<7?s+1:0,r.css({"background-position":o})},1e3/12)}else r.css({"background-position":"0px 0px"}),clearInterval(r.__intervalIE),r.__intervalIE=null;else t.toggleClass(n.activeClass,i)}))}},ko.bindingHandlers.heightAdjust={update:function(e,t,i){var s=e.jqElement||null,o=0,n=t().location,a=t().delay||400;s||(e.jqElement=s=$(e)),_.delay(function(){_.each(t().elements,function(e){var t=e();t&&(o+=t.is(":visible")?t.outerHeight():0)}),"top"===n||void 0===n?s.css({"padding-top":o,"margin-top":-o}):"bottom"===n&&s.css({"padding-bottom":o,"margin-bottom":-o})},a)}},ko.bindingHandlers.minHeightAdjust={update:function(e,t,i){var s=$(e),o=t(),n=o.adjustElement||$("body"),a=o.minHeight||0;o.removeTrigger&&n.css("min-height","inherit"),o.trigger&&_.delay(function(){n.css({"min-height":s.outerHeight(!0)+a})},100)}},ko.bindingHandlers.watchWidth={init:function(e,t){var i=!1;i||t().subscribe(function(){t()($(e).outerWidth()),i=!0},this)}},ko.bindingHandlers.columnCalc={init:function(e,t){var i=$(e),s=t().prop,o=null,n=0;o=i.find(t().itemSelector),void 0!==o[0]&&(n=o.outerWidth(!0),n=1>=n?1:n,s&&$(window).bind("resize",function(){var e=i.width();s(0<e?Math.floor(e/n):1)}))}},ko.bindingHandlers.listWithMoreButton={init:function(e,t){var i=$(e),s=!1;i.closest("div.panel.left_panel").resize(function(){var e=i.find("span.hotkey"),t=i.find("span.item"),o=i.find("span.more_hints").show(),n=i.width(),a=o.width(),r=!0;s?s=!1:(_.each(e,function(e,i){var o=$(e),l=o.width();r&&a+l<n?(s=!1,o.show(),$(t[i]).hide(),a+=l):(s=!0,r=!1,o.hide(),$(t[i]).show())}),r&&o.hide())})}},ko.bindingHandlers.quickReplyAnim={update:bMobileApp?null:function(e,t,i,s,o){var n=e.jqTextarea||null,a=e.jqStatus||null,r=e.jqButtons||null,l=e.jqElement||null,h=e.oPrevActions||null,c=t(),p=null;p=_.defaults(c,{saveAction:!1,sendAction:!1,activeAction:!1}),l||(e.jqElement=l=$(e),e.jqTextarea=n=l.find("textarea"),e.jqStatus=a=l.find(".status"),e.jqButtons=r=l.find(".buttons"),e.oPrevActions=h={saveAction:null,sendAction:null,activeAction:null}),App.browser.ie9AndBelow?(!n||l.defualtHeight||n.defualtHeight||(l.defualtHeight=l.outerHeight(),n.defualtHeight=n.outerHeight(),a.defualtHeight=r.outerHeight(),r.defualtHeight=r.outerHeight()),_.defer(function(){var e=h.activeAction!==p.activeAction,t=h.sendAction!==p.sendAction,i=h.saveAction!==p.saveAction;e&&(p.activeAction?(n.animate({height:n.defualtHeight+50},300),l.animate({"max-height":l.defualtHeight+r.defualtHeight+50},300)):(n.animate({height:n.defualtHeight},300),l.animate({"max-height":l.defualtHeight},300))),(t||i)&&(p.sendAction?(l.animate({"max-height":"30px"},300),a.animate({"max-height":"30px",opacity:1},300)):p.saveAction?l.animate({"max-height":0},300):(l.animate({"max-height":l.defualtHeight+r.defualtHeight+50},300),a.animate({"max-height":0,opacity:0},300)))})):(l.toggleClass("saving",p.saveAction),l.toggleClass("sending",p.sendAction),l.toggleClass("active",p.activeAction)),_.defer(function(){h=p})}},ko.extenders.reversible=function(e){var t=e();return e.commit=function(){t=e()},e.revert=function(){e(t)},e.commitedValue=function(){return t},e.changed=function(){return t!==e()},e},ko.extenders.autoResetToFalse=function(e,t){return e.iTimeout=0,e.subscribe(function(i){i&&(window.clearTimeout(e.iTimeout),e.iTimeout=window.setTimeout(function(){e.iTimeout=0,e(!1)},Utils.pInt(t)))}),e},Utils.createCommand=function(e,t,i){var s=t?function(){return!(!s.canExecute||!s.canExecute())&&t.apply(e,Array.prototype.slice.call(arguments))}:function(){};return s.enabled=ko.observable(!0),i=!!Utils.isUnd(i)||i,Utils.isFunc(i)?s.canExecute=ko.computed(function(){return s.enabled()&&i.call(e)}):s.canExecute=ko.computed(function(){return s.enabled()&&!!i}),s},ko.bindingHandlers.autocomplete={init:function(e,t){function i(e){return e.split(/,\s*/)}function s(e){return i(e).pop()}var o=t(),n=$(e);o&&n&&n[0]&&n.autocomplete({minLength:0,autoFocus:!0,source:function(e,t){o(s(e.term),t)},search:function(){return s(this.value).length>0},focus:function(){return!1},select:function(e,t){var s=i(this.value),o=null;return s.pop(),s.push(t.item.value),s.push(""),this.value=s.join(", ").slice(0,-2),n.trigger("change"),o=function(e){var t=e.value.length;e.blur(),e.focus(),e.setSelectionRange&&e.setSelectionRange(t,t)},o(n[0]),!1}}).on("click",function(){""===n.val()&&($(n.autocomplete("widget")).is(":visible")?n.autocomplete("close"):(n.autocomplete("option","minLength",0),n.autocomplete("search"),n.autocomplete("option","minLength",1)))})}},ko.bindingHandlers.autocompleteSimple={init:function(e,t,i,s,o){var n=$(e),a=t(),r=a.callback,l=a.dataAccessor?a.dataAccessor:Utils.emptyFunction(),h=a.deleteAccessor?a.deleteAccessor:Utils.emptyFunction(),c=Utils.emptyFunction(),p=null,d=null,u=function(){h(d),$.ui.autocomplete.prototype.__response.call(n.data("autocomplete"),_.filter(p,function(e){return e.value!==d.value}))};r&&n&&n[0]&&n.autocomplete({minLength:1,autoFocus:!0,position:{collision:"flip"},source:function(e,t){c=t,r(e.term,function(e){p=e,c(e)})},focus:function(e,t){d=t.item},open:function(e,t){$(n.autocomplete("widget")).find("span.del").on("click",function(e,t){Utils.calmEvent(e),u()})},select:function(e,t){return _.delay(function(){n.trigger("change")},5),l(t.item),!0}}).on("click",function(e,t){""===n.val()&&($(n.autocomplete("widget")).is(":visible")?n.autocomplete("close"):(n.autocomplete("option","minLength",0),n.autocomplete("search"),n.autocomplete("option","minLength",1)))}).on("keydown",function(e,t){p&&d&&!d.global&&e.keyCode===Enums.Key.Del&&e.shiftKey&&(Utils.calmEvent(e),u())})}},ko.bindingHandlers.draggablePlace={init:bMobileApp?null:function(e,t,i,s,o){if(null===t())return null;var n=i?i():null;$(e).draggable({distance:20,handle:".dragHandle",cursorAt:{top:0,left:0},helper:function(e){return t().apply(s,e&&e.target?[ko.dataFor(e.target),e.ctrlKey]:null)},start:n&&n.draggableDragStartCallback?n.draggableDragStartCallback:Utils.emptyFunction,stop:n&&n.draggableDragStopCallback?n.draggableDragStopCallback:Utils.emptyFunction}).on("mousedown",function(){Utils.removeActiveFocus()})}},ko.bindingHandlers.droppable={init:bMobileApp?null:function(e,t){var i=t(),s=i.valueFunc,o=i.switchObserv;!1!==s&&$(e).droppable({hoverClass:"droppableHover",drop:function(e,t){s(e,t)}}),o&&s!==!1&&(o.subscribe(function(t){$(e).data().droppable&&(t?$(e).droppable("disable"):$(e).droppable("enable"))},this),o.valueHasMutated())}},ko.bindingHandlers.draggable={init:bMobileApp?null:function(e,t){$(e).attr("draggable",ko.utils.unwrapObservable(t()))}},ko.bindingHandlers.autosize={init:function(e,t,i,s,o){var n=$(e),a=t(),r=n.height(),l=n.outerHeight(),h=n.innerHeight(),c=l-h,p=h-r,d=a.minHeight?a.minHeight:0,u=a.maxHeight?a.maxHeight:0,m=a.scrollableHeight?a.scrollableHeight:1e3,g=a.autosizeTrigger?a.autosizeTrigger:null,A=function(e){var t=0;App.browser.firefox&&(t=2*parseInt(n.css("padding-top"),10)),u?setTimeout(function(){n.prop("scrollHeight")<u?(n.height(d-p-c),n.height(n.prop("scrollHeight")+t-p)):n.height(u-p-c)},100):(e||n.prop("scrollHeight")<m)&&setTimeout(function(){n.height(d-p-c),n.height(n.prop("scrollHeight")+t-p)},100)};n.on("keydown",function(e,t){A()}),n.on("paste",function(e,t){A()}),g&&g.subscribe(function(e){A(e)},this),A()}},ko.extenders.disableLinebreaks=function(e,t){if(t){var i=ko.computed({read:function(){return e()},write:function(t){e(t.replace(/[\r\n\t]+/gm," "))}});return i(e()),i}return e},ko.bindingHandlers.fade={init:function(e,t,i,s,o){var n=$(e),a=$('<span class="faded"></span>'),r=_.defaults(t(),{color:null,css:"fadeout"}),l=r.color,h=r.css,c=function(e){var t=/^#?([a-f\d])([a-f\d])([a-f\d])$/i,i=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return e=e.replace(t,function(e,t,i,s){return t+t+i+i+s+s}),i?{r:parseInt(i[1],16),g:parseInt(i[2],16),b:parseInt(i[3],16)}:null},p=function(e,t){Utils.isRTL()?a.css("filter","progid:DXImageTransform.Microsoft.gradient(startColorstr='"+e+"', endColorstr='"+e+"',GradientType=1 )").css("background-image","-webkit-gradient(linear, left top, right top, color-stop(0%,"+t+",1)), color-stop(100%,"+t+",0)))").css("background-image","-moz-linear-gradient(left, "+t+",1)0%, "+t+",0)100%)").css("background-image","-webkit-linear-gradient(left, "+t+"1)0%,"+t+",0)100%)").css("background-image","-o-linear-gradient(left, "+t+",1)0%,"+t+",0)100%)").css("background-image","-ms-linear-gradient(left, "+t+",1)0%,"+t+",0)100%)").css("background-image","linear-gradient(left, "+t+",1)0%,"+t+",0)100%)"):a.css("filter","progid:DXImageTransform.Microsoft.gradient(startColorstr='"+e+"', endColorstr='"+e+"',GradientType=1 )").css("background-image","-webkit-gradient(linear, left top, right top, color-stop(0%,"+t+",0)), color-stop(100%,"+t+",1)))").css("background-image","-moz-linear-gradient(left, "+t+",0)0%, "+t+",1)100%)").css("background-image","-webkit-linear-gradient(left, "+t+",0)0%,"+t+",1)100%)").css("background-image","-o-linear-gradient(left, "+t+",0)0%,"+t+",1)100%)").css("background-image","-ms-linear-gradient(left, "+t+",0)0%,"+t+",1)100%)").css("background-image","linear-gradient(left, "+t+",0)0%,"+t+",1)100%)");
},d=function(e){if(""!==e){var t=c(e),i="rgba("+t.r+","+t.g+","+t.b;p(e,i)}};n.parent().addClass(h),n.after(a),void 0!==r.color.subscribe&&(d(l()),l.subscribe(function(e){d(e)},this))}},ko.bindingHandlers.highlighter={init:function(e,t,i,s,o){function n(){var t,i,s,o,n=0;return"undefined"!=typeof window.getSelection?(t=window.getSelection().getRangeAt(0),i=t.cloneRange(),i.selectNodeContents(e),i.setEnd(t.endContainer,t.endOffset),n=i.toString().length):"undefined"!=typeof document.selection&&"Control"!==document.selection.type&&(s=document.selection.createRange(),o=document.body.createTextRange(),o.moveToElementText(e),o.setEndPoint("EndToEnd",s),n=o.text.length),n}function a(t){var i,s,o;if(!e)return!1;if(document.createRange)i=document.createRange(),i.selectNodeContents(e),i.setStart(e,t),i.setEnd(e,t),s=window.getSelection(),s.removeAllRanges(),s.addRange(i);else{if(e.createTextRange)return o=e.createTextRange(),o.collapse(!0),o.moveEnd(t),o.moveStart(t),o.select(),!0;if(e.setSelectionRange)return e.setSelectionRange(t,t),!0}return!1}function r(e){if(b){var t=0,i=l.text(),s=i.split(m),o=[],r='<span class="search_highlight">$&</span>';$.each(s,function(e,t){_.any(u,function(e){return e===t})?$.each(t,function(e,t){o.push($(t.replace(/(.)/,r)))}):$.each(t,function(e,t){" "===t?o.push(document.createTextNode(" ")):o.push(document.createTextNode(t))})}),e?l.empty().append(o):(t=n(),l.empty().append(o),a(t))}}var l=$(e),h=t(),c=h.valueObserver?h.valueObserver:null,p=h.highlighterValueObserver?h.highlighterValueObserver:null,d=h.highlightTrigger?h.highlightTrigger:null,u=["from:","to:","subject:","text:","email:","has:","date:","text:","body:"],m=function(){var e="";return $.each(u,function(t,i){e=t?e+"|\\b"+i:e+"\\b"+i}),new RegExp("("+e+")","g")}(),g=function(e){return e.replace(/\xC2\xA0/g," ").replace(/\xA0/g," ").replace(/[\s]+/g," ")},A=-1,f=window.navigator.language||window.navigator.userLanguage,C=["zh","zh-TW","zh-CN","zh-HK","zh-SG","zh-MO","ja","ja-JP","ko","ko-KR","vi","vi-VN","th","th-TH"],b=!_.include(C,f);$(e).on("keydown",function(e){return e.keyCode!==Enums.Key.Enter}).on("keyup",function(e){var t=[Enums.Key.Left,Enums.Key.Right,Enums.Key.Home,Enums.Key.End],i=-1!==Utils.inArray(e.keyCode,t);return e.keyCode===Enums.Key.Shift||e.keyCode===Enums.Key.Ctrl||i||(e.ctrlKey||A===Enums.Key.Ctrl)&&e.keyCode===Enums.Key.a||(c(g(l.text())),r(!1)),A=e.keyCode,!0}).on("paste",function(e){return setTimeout(function(){c(g(l.text())),r(!1)},0),!0}),setTimeout(function(){r(!0)},0),d.notifySubscribers(),d.subscribe(function(e){setTimeout(function(){r(!!e)},0)},this),p.subscribe(function(){l.text(c())},this)}},ko.bindingHandlers.quoteText={init:function(e,t,i,s,o){var n=($(e),$('<span class="button_quote">'+Utils.i18n("HELPDESK/BUTTON_QUOTE")+"</span>")),a=t(),r=a.actionHandler,l=!1,h=null,c="";$("#pSevenContent").append(n),$(document.body).on("click",function(e){l=!!$(e.target).parents(".posts")[0],document.getSelection?(h=document.getSelection(),h&&(c=h.toString())):c=document.selection.createRange().text,l&&""!==c.replace(/[\n\r\s]/,"")?n.css({top:e.clientY+20,left:e.clientX+20}).show():n.hide()}),n.on("click",function(e){r.call(s,c)})}},ko.bindingHandlers.adjustHeightToContent={init:function(e,t,i,s,o){var n=$(e),a=null,r=null,l=null;_.delay(_.bind(function(){a=$(_.max(n.find(".title .text"),function(e){return e.offsetWidth})),r=a.parent(),l=r.find(".icon"),n.css("min-width",parseInt(r.css("margin-left"))+parseInt(r.css("padding-left"))+parseInt(l.width())+parseInt(l.css("margin-left"))+parseInt(l.css("margin-right"))+parseInt(l.css("padding-left"))+parseInt(l.css("padding-right"))+parseInt(a.width())+parseInt(a.css("margin-left"))+parseInt(a.css("padding-left"))+10)},this),1)}},ko.bindingHandlers.customTooltip={init:bMobileDevice||bMobileApp?null:function(e,t){var i=Utils.i18n(t()),s=$(e),o=s.find("span.dropdown"),n=!1,a=function(){var e=$(this);e.hasClass("expand")||(clearTimeout(Utils.CustomTooltip.iHideTimer),n=!0,clearTimeout(Utils.CustomTooltip.iTimer),Utils.CustomTooltip.iTimer=setTimeout(function(){n&&(e.hasClass("expand")?(n=!1,clearTimeout(Utils.CustomTooltip.iTimer),Utils.CustomTooltip.hide()):Utils.CustomTooltip.show(i,e))},100))},r=function(){clearTimeout(Utils.CustomTooltip.iHideTimer),Utils.CustomTooltip.iHideTimer=setTimeout(function(){n=!1,clearTimeout(Utils.CustomTooltip.iTimer),Utils.CustomTooltip.hide()},10)},l=function(){},h=function(){s.unbind("mouseover",a),s.unbind("mouseout",r),s.unbind("click",r),o.unbind("mouseover",r),o.unbind("mouseout",l),""!==i&&(s.bind("mouseover",a),s.bind("mouseout",r),s.bind("click",r),o.bind("mouseover",r),o.bind("mouseout",l))},c=null;"function"==typeof i&&(i=i()),h(),"function"==typeof t().subscribe&&null===c&&(c=t().subscribe(function(e){i=e,h()}))}},ko.bindingHandlers.foreachprop={transformObject:function(e){var t=[];for(var i in e)e.hasOwnProperty(i)&&t.push({key:i,value:e[i]});return t},init:function(e,t,i,s,o){var n=ko.utils.unwrapObservable(t()),a=ko.bindingHandlers.foreachprop.transformObject(n);return ko.applyBindingsToNode(e,{foreach:a},o),{controlsDescendantBindings:!0}}},CRouting.prototype.init=function(e){this.defaultScreen=e,hasher.initialized.removeAll(),hasher.changed.removeAll(),hasher.initialized.add(this.parseRouting,this),hasher.changed.add(this.parseRouting,this),hasher.init(),hasher.initialized.removeAll()};CRouting.prototype.finalize=function(){hasher.dispose()};CRouting.prototype.setHashFromString=function(e){var t=location.hash===decodeURIComponent(e);return t||(location.hash=e),t},CRouting.prototype.replaceHashWithoutMessageUid=function(e){if("string"==typeof e&&""!==e){var t=location.hash.replace("/msg"+e,"");this.replaceHashFromString(t)}},CRouting.prototype.replaceHashFromString=function(e){location.hash!==e&&location.replace(e)},CRouting.prototype.setHash=function(e){return this.setHashFromString(this.buildHashFromArray(e))},CRouting.prototype.replaceHash=function(e){this.replaceHashFromString(this.buildHashFromArray(e))},CRouting.prototype.replaceHashDirectly=function(e){hasher.stop(),this.replaceHashFromString(this.buildHashFromArray(e)),hasher.init()},CRouting.prototype.setPreviousHash=function(){location.hash=this.previousHash()},CRouting.prototype.buildHashFromArray=function(e){var t=0,i=0,s="";if(_.isArray(e))for(i=e.length;t<i;t++)e[t]=encodeURIComponent(e[t]);else e=[encodeURIComponent(e.toString())];return s=e.join("/"),""!==s&&(s="#"+s),s},CRouting.prototype.getHashFromHref=function(){var e=location.href.indexOf("#"),t="";return e!==-1&&(t=location.href.substr(e+1)),t},CRouting.prototype.isSingleMode=function(){var e=this.getScreenFromHash(),t=e===Enums.Screens.SingleMessageView||e===Enums.Screens.SingleCompose||e===Enums.Screens.SingleHelpdesk;return this.currentScreen=e,t},CRouting.prototype.goDirectly=function(e,t){hasher.stop(),this.setHash(e),this.parseRouting(t),hasher.init()},CRouting.prototype.historyBackWithoutParsing=function(e){hasher.stop(),location.hash=this.currentHash(),hasher.init()},CRouting.prototype.getScreenFromHash=function(){var e=this.getHashFromHref(),t=e.split("/");return decodeURIComponent(t.shift())||this.defaultScreen},CRouting.prototype.parseRouting=function(e){var t=App.Screens.getCurrentScreenModel(),i=_.bind(this.chooseScreen,this,e);t&&Utils.isFunc(t.beforeHide)?t.beforeHide(i):i()},CRouting.prototype.chooseScreen=function(e){var t=this.getHashFromHref(),i=t.split("/"),s=decodeURIComponent(i.shift())||this.defaultScreen,o=!!_.find(Enums.Screens,function(e){return e===s}),n=0,a=i.length;for(s===Enums.Screens.Mailbox&&this.lastMailboxHash(t),s===Enums.Screens.Helpdesk&&this.lastHelpdeskHash(t),s===Enums.Screens.Settings&&this.lastSettingsHash(t),this.previousHash(this.currentHash()),this.currentHash(t);n<a;n++)i[n]=decodeURIComponent(i[n]);switch($.isArray(e)&&(i=_.union(i,e)),this.currentScreen=s,s){case Enums.Screens.SingleMessageView:case Enums.Screens.SingleCompose:case Enums.Screens.SingleHelpdesk:AppData.SingleMode=!0,App.Screens.showCurrentScreen(s,i);break;default:o||(s=this.defaultScreen),AppData.SingleMode=!1,App.Screens.showNormalScreen(Enums.Screens.Header),App.Screens.showCurrentScreen(s,i);break;case Enums.Screens.Mailbox:AppData.SingleMode=!1,App.Screens.showNormalScreen(Enums.Screens.Header),App.Screens.showCurrentScreen(Enums.Screens.Mailbox,i)}},CLinkBuilder.prototype.mailbox=function(e,t,i,s,o){var n=[Enums.Screens.Mailbox];return t=Utils.isNormal(t)?Utils.pInt(t):1,i=Utils.isNormal(i)?Utils.pString(i):"",s=Utils.isNormal(s)?Utils.pString(s):"",o=Utils.isNormal(o)?Utils.pString(o):"",e&&""!==e&&n.push(e),o&&""!==o&&n.push("filter:"+o),1<t&&n.push("p"+t),i&&""!==i&&n.push("msg"+i),s&&""!==s&&n.push(s),n},CLinkBuilder.prototype.inbox=function(){return this.mailbox()},CLinkBuilder.prototype.parseMailbox=function(e){var t="INBOX",i=1,s="",o="",n="",a="",r=0;return Utils.isNonEmptyArray(e)&&(t=Utils.pString(e[r]),r++,e.length>r&&(a=Utils.pString(e[r]),a==="filter:"+Enums.FolderFilter.Flagged&&(n=Enums.FolderFilter.Flagged,r++),a==="filter:"+Enums.FolderFilter.Unseen&&(n=Enums.FolderFilter.Unseen,r++)),e.length>r&&(a=Utils.pString(e[r]),this.isPageParam(a)&&(i=Utils.pInt(a.substr(1)),i<=0&&(i=1),r++)),e.length>r&&(a=Utils.pString(e[r]),this.isMsgParam(a)&&(s=a.substr(3),r++)),e.length>r&&(o=Utils.pString(e[r]))),{Folder:t,Page:i,Uid:s,Search:o,Filters:n}},CLinkBuilder.prototype.contacts=function(e,t,i,s,o){var n=[Enums.Screens.Contacts];return"number"==typeof e&&n.push(e),t&&""!==t&&n.push(t),i&&""!==i&&n.push(i),Utils.isNumeric(s)&&n.push("p"+s),o&&""!==o&&n.push("cnt"+o),n},CLinkBuilder.prototype.parseContacts=function(e){var t=0,i=[Enums.ContactsGroupListType.Personal,Enums.ContactsGroupListType.SharedToAll,Enums.ContactsGroupListType.Global,Enums.ContactsGroupListType.All],s=Enums.ContactsGroupListType.All,o="",n="",a=1,r="";return Utils.isNonEmptyArray(e)&&(s=Utils.pInt(e[t]),t++,-1===Utils.inArray(s,i)&&(s=Enums.ContactsGroupListType.SubGroup),s===Enums.ContactsGroupListType.SubGroup&&(e.length>t?(o=Utils.pString(e[t]),t++):s=Enums.ContactsGroupListType.Personal),e.length>t&&!this.isPageParam(e[t])&&!this.isContactParam(e[t])&&(n=Utils.pString(e[t]),t++),e.length>t&&this.isPageParam(e[t])&&(a=Utils.pInt(e[t].substr(1)),t++,a<=0&&(a=1)),e.length>t&&this.isContactParam(e[t])&&(r=Utils.pString(e[t].substr(3)),t++)),{Type:s,GroupId:o,Search:n,Page:a,Uid:r}},CLinkBuilder.prototype.isPageParam=function(e){return"p"===e.substr(0,1)&&/^[1-9][\d]*$/.test(e.substr(1))},CLinkBuilder.prototype.isContactParam=function(e){return"cnt"===e.substr(0,3)&&/^[1-9][\d]*$/.test(e.substr(3))},CLinkBuilder.prototype.isMsgParam=function(e){return"msg"===e.substr(0,3)&&/^[1-9][\d]*$/.test(e.substr(3))},CLinkBuilder.prototype.compose=function(){var e=AppData.SingleMode?Enums.Screens.SingleCompose:Enums.Screens.Compose;return[e]},CLinkBuilder.prototype.composeFromMessage=function(e,t,i,s){var o=s||AppData.SingleMode?Enums.Screens.SingleCompose:Enums.Screens.Compose;return[o,e,t,i]},CLinkBuilder.prototype.composeWithToField=function(e){var t=AppData.SingleMode?Enums.Screens.SingleCompose:Enums.Screens.Compose;return[t,"to",e]},CLinkBuilder.prototype.parseToAddr=function(e){var t=decodeURI(Utils.pString(e)),i=t.indexOf("mailto:")!==-1,s=[],o=[],n="",a="",r="",l="";return i&&(s=t.replace(/^mailto:/,"").split("?"),t=s[0],2===s.length&&(o=s[1].split("&"),_.each(o,function(e){var t=e.split("=");if(2===t.length)switch(t[0].toLowerCase()){case"subject":n=t[1];break;case"cc":a=t[1];break;case"bcc":r=t[1];break;case"body":l=t[1]}}))),{to:t,hasMailto:i,subject:n,cc:a,bcc:r,body:l}},CMessageSender.prototype.setReplyData=function(e,t){this.replyText(e),this.replyDraftUid(t)},CMessageSender.prototype.send=function(e,t,i,s,o,n,a){var r=t.AccountID,l=App.MailCache.oFolderListItems[r],h="",c=l?l.sentFolderFullName():"",p=l?l.draftsFolderFullName():"",d=AppData.Accounts.getEmail(r),u=t.To.indexOf(d)>-1||t.Cc.indexOf(d)>-1||t.Bcc.indexOf(d)>-1,m=AppData.SingleMode&&window.opener&&window.opener.App?window.opener.App:App;if(AppData.User.SaveRepliedToCurrFolder&&!u&&Utils.isNonEmptyArray(t.DraftInfo,3)){var g=t.DraftInfo[2],A=l&&l.getFolderByFullName(g);A&&A.type()!==Enums.FolderTypes.Spam&&(c=g)}switch(t.Action=e,t.ShowReport=s,e){case"MessageSend":h=Utils.i18n("COMPOSE/INFO_SENDING"),i&&(t.SentFolder=c),""!==t.DraftUid&&(t.DraftFolder=p,m.MailCache.removeOneMessageFromCacheForFolder(t.AccountID,t.DraftFolder,t.DraftUid),m.Routing.replaceHashWithoutMessageUid(t.DraftUid));break;case"MessageSave":h=Utils.i18n("COMPOSE/INFO_SAVING"),"undefined"==typeof t.DraftFolder&&(t.DraftFolder=p),App.MailCache.savingDraftUid(t.DraftUid),m.MailCache.startMessagesLoadingWhenDraftSaving(t.AccountID,t.DraftFolder),m.Routing.replaceHashWithoutMessageUid(t.DraftUid)}s&&App.Api.showLoading(h),a?this.postponedMailData={Parameters:t,MessageSendResponseHandler:o,MessageSendResponseContext:n}:App.Ajax.send(t,o,n)},CMessageSender.prototype.sendPostponedMail=function(e){var t=this.postponedMailData,i=t.Parameters,s=i.AccountID,o=App.MailCache.oFolderListItems[s],n=o?o.draftsFolderFullName():"",a=AppData.SingleMode&&window.opener&&window.opener.App?window.opener.App:App;""!==e&&(i.DraftUid=e,i.DraftFolder=n,a.MailCache.removeOneMessageFromCacheForFolder(i.AccountID,i.DraftFolder,i.DraftUid),a.Routing.replaceHashWithoutMessageUid(i.DraftUid)),this.postponedMailData&&(App.Ajax.send(i,t.MessageSendResponseHandler,t.MessageSendResponseContext),this.postponedMailData=null)},CMessageSender.prototype.sendReplyMessage=function(e,t,i,s,o,n){var a=null,r=App.MailCache.currentMessage(),l=[],h=null;r&&(l=r.oTo.aCollection.concat(r.oCc.aCollection),h=this.getFirstFetcherOrIdentityByRecipientsOrDefault(l,r.accountId()),a=this.getReplyDataFromMessage(r,Enums.ReplyType.ReplyAll,r.accountId(),h,!1,t,i),a.AccountID=r.accountId(),h&&(a.FetcherID=h&&h.FETCHER?h.id():"",a.IdentityID=h&&!h.FETCHER?h.id():""),a.Bcc="",a.Importance=Enums.Importance.Normal,a.Sensitivity=Enums.Sensitivity.Nothing,a.ReadingConfirmation="0",a.IsQuickReply="1",a.IsHtml="1",a.Attachments=this.convertAttachmentsForSending(a.Attachments),this.send(e,a,AppData.User.getSaveMailInSentItems(),!1,s,o,n))},CMessageSender.prototype.convertAttachmentsForSending=function(e){var t={};return _.each(e,function(e){t[e.tempName()]=[e.fileName(),e.cid(),e.inline()?"1":"0",e.linked()?"1":"0",e.contentLocation()]}),t},CMessageSender.prototype.onMessageSendOrSaveResponse=function(e,t,i){var s,o,n,a=AppData.SingleMode&&window.opener&&window.opener.App?window.opener.App:App,r=!!e.Result;switch(i||App.Api.hideLoading(),t.Action){case"MessageSave":r?(t.ShowReport&&!i&&(-1!==Utils.inArray(t.DraftFolder,App.MailCache.getCurrentTemplateFolders())?App.Api.showReport(Utils.i18n("COMPOSE/REPORT_TEMPLATE_SAVED")):App.Api.showReport(Utils.i18n("COMPOSE/REPORT_MESSAGE_SAVED"))),e.Result.NewUid||(AppData.User.AllowAutosaveInDrafts=!1)):t.ShowReport&&(-1!==Utils.inArray(t.DraftFolder,App.MailCache.getCurrentTemplateFolders())?App.Api.showErrorByCode(e,Utils.i18n("COMPOSE/ERROR_TEMPLATE_SAVING")):App.Api.showErrorByCode(e,Utils.i18n("COMPOSE/ERROR_MESSAGE_SAVING")));break;case"MessageSend":if(r||e.ErrorCode===Enums.Errors.NotSavedInSentItems){if(r||e.ErrorCode!==Enums.Errors.NotSavedInSentItems)t.IsQuickReply?App.Api.showReport(Utils.i18n("COMPOSE/REPORT_MESSAGE_SENT")):a.Api.showReport(Utils.i18n("COMPOSE/REPORT_MESSAGE_SENT"));else{var l=App.MailCache.oFolderListItems[t.AccountID],h=l.getFolderByFullName(t.SentFolder),c=Utils.i18n("WARNING/SENT_EMAIL_NOT_SAVED",{FOLDER:h.displayName()});App.Api.showError(c)}_.isArray(t.DraftInfo)&&3===t.DraftInfo.length&&(n=t.DraftInfo[0],o=t.DraftInfo[1],s=t.DraftInfo[2],App.MailCache.markMessageReplied(t.AccountID,s,o,n))}else App.Api.showErrorByCode(e,Utils.i18n("COMPOSE/ERROR_MESSAGE_SENDING"));t.SentFolder&&a.MailCache.removeMessagesFromCacheForFolder(t.AccountID,t.SentFolder)}return t.DraftFolder&&!i&&a.MailCache.removeMessagesFromCacheForFolder(t.AccountID,t.DraftFolder),{Action:t.Action,Result:r,NewUid:e.Result?e.Result.NewUid:""}},CMessageSender.prototype.getReplyDataFromMessage=function(e,t,i,s,o,n,a){var r={DraftInfo:[],DraftUid:"",To:"",Cc:"",Bcc:"",Subject:"",Attachments:[],InReplyTo:e.messageId(),References:this.getReplyReferences(e)},l=[],h=e.oReplyTo.getFull(),c=e.oTo.getFull();switch((""===h||e.oFrom.getFirstEmail()===e.oReplyTo.getFirstEmail()&&""===e.oReplyTo.getFirstName())&&(h=e.oFrom.getFull()),n&&""!==n||(n=this.replyText(),this.replyText("")),"forward"===t?r.Text=n+this.getForwardMessageBody(e,i,s):"resend"===t?(r.Text=e.getConvertedHtml(),r.Cc=e.cc(),r.Bcc=e.bcc()):r.Text=n+this._getReplyMessageBody(e,i,s,o),a?r.DraftUid=a:(r.DraftUid=this.replyDraftUid(),this.replyDraftUid("")),t){case Enums.ReplyType.Reply:r.DraftInfo=[Enums.ReplyType.Reply,e.uid(),e.folder()],r.To=h,r.Subject=this.getReplySubject(e.subject(),!0),l=_.filter(e.attachments(),function(e){return e.linked()});break;case Enums.ReplyType.ReplyAll:r.DraftInfo=[Enums.ReplyType.ReplyAll,e.uid(),e.folder()],r.To=h,r.Cc=this._getReplyAllCcAddr(e,i,s),r.Subject=this.getReplySubject(e.subject(),!0),l=_.filter(e.attachments(),function(e){return e.linked()});break;case Enums.ReplyType.Resend:r.DraftInfo=[Enums.ReplyType.Resend,e.uid(),e.folder(),e.cc(),e.bcc()],r.To=c,r.Subject=e.subject(),l=e.attachments();break;case Enums.ReplyType.Forward:r.DraftInfo=[Enums.ReplyType.Forward,e.uid(),e.folder()],r.Subject=this.getReplySubject(e.subject(),!1),l=e.attachments()}return _.each(l,function(e){if(e.getCopy){var t=e.getCopy(),i=Date.now().toString();t.getInThumbQueue(i),r.Attachments.push(t)}}),r},CMessageSender.prototype.getReplyReferences=function(e){var t=e.references(),i=e.messageId(),s=t.indexOf(i);return s===-1&&(t+=" "+i),t},CMessageSender.prototype._getReplyMessageBody=function(e,t,i,s){var o=Utils.i18n("COMPOSE/REPLY_MESSAGE_TITLE",{DATE:e.oDateModel.getDate(),TIME:e.oDateModel.getTime(),SENDER:Utils.encodeHtml(e.oFrom.getFull())}),n="<br /><br />"+this.getSignatureText(t,i,s)+'<br /><br /><div data-anchor="reply-title">'+o+"</div><blockquote>"+e.getConvertedHtml()+"</blockquote>";return n},CMessageSender.prototype.getClearSignature=function(e,t){var i=AppData.Accounts.getAccount(e),s=!(t&&(t.useSignature?!t.useSignature():!t.signatureOptions())),o="";return i&&s&&(o=t&&t.accountId()===i.id()?t.signature():i.signature()&&parseInt(i.signature().options())?i.signature().signature():""),o},CMessageSender.prototype.getSignatureText=function(e,t,i){var s=this.getClearSignature(e,t);return i?'<div data-anchor="signature">'+s+"</div>":"<div>"+s+"</div>"},CMessageSender.prototype.getFirstFetcherOrIdentityByRecipientsOrDefault=function(e,t){var i=AppData.Accounts.getAccount(t),s=this.getAccountFetchersIdentitiesList(i),o=[],n=null;return _.each(e,function(e){if(!n)switch(o=_.filter(s,function(t){return e.sEmail===t.email}),o.length){case 0:break;case 1:n=o[0];break;default:n=_.find(o,function(t){return e.sEmail===t.email&&e.sName===t.name}),n||(n=_.find(o,function(e){return e.isDefault}),n||(n=o[0]))}}),n||(n=_.find(s,function(e){return e.isDefault})),n&&n.result},CMessageSender.prototype.getAccountFetchersIdentitiesList=function(e){var t=[];return e&&(e.fetchers()&&_.each(e.fetchers().collection(),function(e){t.push({email:e.email(),name:e.userName(),isDefault:!1,result:e})}),_.each(e.identities(),function(e){t.push({email:e.email(),name:e.friendlyName(),isDefault:e.isDefault(),result:e})})),t},CMessageSender.prototype.getForwardMessageBody=function(e,t,i){var s=Utils.encodeHtml(e.oCc.getFull()),o=""!==s?Utils.i18n("COMPOSE/FORWARD_MESSAGE_BODY_CC",{CCADDR:s}):"",n=Utils.i18n("COMPOSE/FORWARD_MESSAGE_TITLE",{FROMADDR:Utils.encodeHtml(e.oFrom.getFull()),TOADDR:Utils.encodeHtml(e.oTo.getFull()),CCPART:o,FULLDATE:e.oDateModel.getFullDate(),SUBJECT:e.subject()}),a="<br /><br />"+this.getSignatureText(t,i,!0)+'<br /><br /><div data-anchor="reply-title">'+n+"</div><br /><br />"+e.getConvertedHtml();return a},CMessageSender.prototype._getReplyAllCcAddr=function(e,t,i){var s=new CAddressListModel,o=_.union(e.oTo.aCollection,e.oCc.aCollection,e.oBcc.aCollection),n=_.find(AppData.Accounts.collection(),function(e){return e.id()===t},this),a=new CAddressModel,r=new CAddressModel;return a.sEmail=n.email(),r.sEmail=i?i.email():"",s.addCollection(o),s.excludeCollection(_.union(e.oFrom.aCollection,[a,r])),s.getFull()},CMessageSender.prototype.getReplySubject=function(e,t){var i=Utils.i18n("COMPOSE/REPLY_PREFIX"),s=Utils.i18n("COMPOSE/FORWARD_PREFIX"),o=t?i:s,n=o+": "+e;return AppData.App.JoinReplyPrefixes&&(n=Utils.Message.joinReplyPrefixesInSubject(n,i,s)),n},CMessageSender.prototype.getHtmlFromText=function(e){return e.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/\r/g,"").replace(/\n/g,"<br />")},CPrefetcher.prototype.init=function(){setInterval(_.bind(function(){this.start()},this),1e4)},CPrefetcher.prototype.start=function(){!AppData.Auth||AppData.SingleMode||App.InternetConnectionError||App.Ajax.hasOpenedRequests()||(this.prefetchStarted(!1),this.prefetchAll())},CPrefetcher.prototype.prefetchAll=function(){this.prefetchFetchersIdentities(),this.prefetchAccountFilters(),AppData.App.AllowPrefetch?(this.startMessagesPrefetch(),this.startThreadListPrefetch(),this.doServerInitializations(),this.prefetchStarredMessageList(),this.startOtherPagesPrefetch(),this.prefetchUnseenMessageList(),this.prefetchAccountQuota(),this.startOtherFoldersPrefetch(),this.prefetchCalendarList(),this.initHelpdesk()):(this.doServerInitializations(),this.prefetchStarredMessageList(),this.prefetchAccountQuota(),this.prefetchCalendarList(),this.initHelpdesk())},CPrefetcher.prototype.prefetchCalendarList=function(){this.prefetchStarted()||this.prefetchStarted(App.CalendarCache.firstRequestCalendarList())},CPrefetcher.prototype.prefetchFetchersIdentities=function(){AppData.SingleMode||this.fetchersIdentitiesPrefetched()||this.prefetchStarted()||!AppData.User.AllowFetcher&&!AppData.AllowIdentities||(AppData.Accounts.populateFetchersIdentities(),this.fetchersIdentitiesPrefetched(!0),this.prefetchStarted(!0))},CPrefetcher.prototype.initHelpdesk=function(){!AppData.User.IsHelpdeskSupported||this.prefetchStarted()||this.helpdeskInitialized()||(App.Screens.initHelpdesk(),this.helpdeskInitialized(!0),this.prefetchStarted(!0))},CPrefetcher.prototype.doServerInitializations=function(){AppData.SingleMode||this.prefetchStarted()||this.serverInitializationsDone()||(App.Ajax.send({Action:"SystemDoServerInitializations"}),this.serverInitializationsDone(!0),this.prefetchStarted(!0))},CPrefetcher.prototype.prefetchStarredMessageList=function(){if(!this.prefetchStarted()){var e=App.MailCache.folderList(),t=e?e.inboxFolder():null,i=null;t&&!t.hasChanges()&&(i=App.MailCache.requestMessageList(t.fullName(),1,"",Enums.FolderFilter.Flagged,!1,!1),i.RequestStarted&&this.prefetchStarted(!0))}},CPrefetcher.prototype.prefetchUnseenMessageList=function(){if(!this.prefetchStarted()){var e=App.MailCache.folderList(),t=e?e.inboxFolder():null,i=null;t&&!t.hasChanges()&&(i=App.MailCache.requestMessageList(t.fullName(),1,"",Enums.FolderFilter.Unseen,!1,!1),i.RequestStarted&&this.prefetchStarted(!0))}},CPrefetcher.prototype.startOtherPagesPrefetch=function(){this.prefetchStarted()||this.startPagePrefetch(App.MailCache.page()+1),this.prefetchStarted()||this.startPagePrefetch(App.MailCache.page()-1)},CPrefetcher.prototype.prefetchNextPage=function(e){var t=App.MailCache.uidList(),i=_.indexOf(t.collection(),e),s=Math.ceil(i/AppData.User.MailsPerPage)+1;this.startPagePrefetch(s-1)},CPrefetcher.prototype.prefetchPrevPage=function(e){var t=App.MailCache.uidList(),i=_.indexOf(t.collection(),e),s=Math.ceil((i+1)/AppData.User.MailsPerPage)+1;this.startPagePrefetch(s)},CPrefetcher.prototype.startPagePrefetch=function(e){var t=App.MailCache.folderList().currentFolder(),i=App.MailCache.uidList(),s=(e-1)*AppData.User.MailsPerPage,o=e>0&&s<i.resultCount(),n=null,a=null;t&&!t.hasChanges()&&o&&(n={folder:t.fullName(),page:e,search:i.search()},t.hasListBeenRequested(n)||(a=App.MailCache.requestMessageList(n.folder,n.page,n.search,"",!1,!1),a&&a.RequestStarted&&this.prefetchStarted(!0)))},CPrefetcher.prototype.startOtherFoldersPrefetch=function(){if(!this.prefetchStarted()){var e=App.MailCache.folderList(),t=e.currentFolderFullName(),i=AppData.Accounts.getCurrentFetchersAndFiltersFolderNames(),s=e?[e.inboxFolderFullName(),e.sentFolderFullName(),e.draftsFolderFullName(),e.spamFolderFullName()]:[],o=i.length<3?this.getOtherFolderNames(3-i.length):[],n=_.uniq(_.compact(_.union(s,i,o)));_.each(n,_.bind(function(i){t!==i&&this.startFolderPrefetch(e.getFolderByFullName(i))},this))}},CPrefetcher.prototype.getOtherFolderNames=function(e){var t=App.MailCache.folderList().inboxFolder(),i=t?t.subfolders():[],s=_.filter(App.MailCache.folderList().collection(),function(e){return!e.isSystem()},this),o=_.first(_.union(i,s),e);return _.map(o,function(e){return e.fullName()})},CPrefetcher.prototype.startFolderPrefetch=function(e){if(!this.prefetchStarted()&&e){var t=1,i="",s={folder:e.fullName(),page:t,search:i},o=null;e.hasListBeenRequested(s)||(o=App.MailCache.requestMessageList(s.folder,s.page,s.search,"",!1,!1),o&&o.RequestStarted&&this.prefetchStarted(!0))}},CPrefetcher.prototype.startThreadListPrefetch=function(){if(!this.prefetchStarted()){var e=[],t=App.MailCache.getCurrentFolder();_.each(App.MailCache.messages(),function(i){i.threadCount()>0&&_.each(i.threadUids(),function(i){var s=t.oMessages[i];s&&t.hasThreadUidBeenRequested(i)||e.push(i)})},this),e.length>0&&(e=e.slice(0,AppData.User.MailsPerPage),t.addRequestedThreadUids(e),t.loadThreadMessages(e),this.prefetchStarted(!0))}},CPrefetcher.prototype.startMessagesPrefetch=function(){if(!this.prefetchStarted()){var e=App.MailCache.currentAccountId(),t=App.MailCache.getCurrentFolder(),i=0,s=AppData.App.MaxPrefetchBodiesSize,o=[],n=null,a=2048,r=function(e){var n=!e.deleted()&&!e.completelyFilled(),r=!_.find(o,function(t){return t===e.uid()},this),l=!t.hasUidBeenRequested(e.uid());i<s&&n&&r&&l&&(o.push(e.uid()),i+=e.trimmedTextSize()+a)};t&&t.selected()&&(_.each(App.MailCache.messages(),r),_.each(t.oMessages,r),o.length>0&&(t.addRequestedUids(o),n={AccountID:e,Action:"MessagesGetBodies",Folder:t.fullName(),Uids:o},App.Ajax.send(n,this.onMessagesGetBodiesResponse,this),this.prefetchStarted(!0)))}},CPrefetcher.prototype.onMessagesGetBodiesResponse=function(e,t){var i=App.MailCache.getFolderByFullName(t.AccountID,t.Folder);_.isArray(e.Result)&&_.each(e.Result,function(e){i.parseAndCacheMessage(e,!1,!1)})},CPrefetcher.prototype.prefetchAccountQuota=function(){var e=AppData.Accounts.getCurrent(),t=AppData.App&&AppData.App.ShowQuotaBar,i=e&&!e.quotaRecieved();!this.prefetchStarted()&&t&&i&&(e.updateQuotaParams(),this.prefetchStarted(!0))},CPrefetcher.prototype.prefetchAccountFilters=function(){var e=AppData.Accounts.getCurrent();!this.prefetchStarted()&&e&&!e.filters()&&e.allowMail()&&e.extensionExists("AllowSieveFiltersExtension")&&(e.requestFilters(),this.prefetchStarted(!0))},CSelector.prototype.iTimer=0,CSelector.prototype.bResetCheckedOnClick=!1,CSelector.prototype.bCheckOnSelect=!1,CSelector.prototype.bUnselectOnCtrl=!1,CSelector.prototype.bDisableMultiplySelection=!1,CSelector.prototype.setBeforeSelectCallback=function(e){this.fBeforeSelectCallback=e||null},CSelector.prototype.getLastOrSelected=function(){var e=0,t=null;return _.each(this.list(),function(i){i.checked()&&e++,i.selected()&&(t=i)}),0===e&&t?t:this.oLast},CSelector.prototype.initOnApplyBindings=function(e,t,i,s,o){$(document).on("keydown",this.onKeydownBinded),this.oListScope=s,this.oScrollScope=o,this.sActionSelector=e,this.sSelectabelSelector=t,this.sCheckboxSelector=i;var n=this,a=function(e,t,i){var s=0,o=0,a=null,r=!1,l=!1,h=[],c=!1;if(t=t?t:null,i&&i.shiftKey&&null!==t&&null!==e&&t!==e)for(h=n.list(),c=t.checked(),s=0,o=h.length;s<o;s++)a=h[s],r=!1,a!==e&&a!==t||(r=!0),r&&(l=!l),(l||r)&&a.checked(c);t&&(n.oLast=t)};$(this.oListScope).on("dblclick",e,function(e){var t=ko.dataFor(this);!t||!e||e.ctrlKey||e.altKey||e.shiftKey||n.onDblClick(t)}),bMobileDevice&&$(this.oListScope).on("touchstart",e,function(e){if(e){var t=e.timeStamp,i=$(this).data("lastTouch")||t,s=t-i,o=e.originalEvent&&e.originalEvent.touches?e.originalEvent.touches.length:0;$(this).data("lastTouch",t),!s||s>250||o>1||(e.preventDefault(),$(this).trigger("dblclick"))}}),$(this.oListScope).on("click",e,function(e){var t=!0,i=null,s=n.getLastOrSelected(),o=ko.dataFor(this);o&&e&&(e.shiftKey?(t=!1,n.bDisableMultiplySelection||(null===n.oLast&&(n.oLast=o),o.checked(!o.checked()),a(s,o,e))):e.ctrlKey&&(t=!1,n.bDisableMultiplySelection||(n.oLast=o,i=n.itemSelected(),!i||i.checked()||o.checked()||i.checked(!0),n.bUnselectOnCtrl&&o===n.itemSelected()?(o.checked(!o.selected()),n.itemSelected(null)):o.checked(!o.checked()))),t&&(n.onSelect(o),n.scrollToSelected()))}),$(this.oListScope).on("click",i,function(e){var t=ko.dataFor(this);t&&e&&!n.bDisableMultiplySelection&&(e.shiftKey?(null===n.oLast&&(n.oLast=t),a(n.getLastOrSelected(),t,e)):n.oLast=t),e&&e.stopPropagation&&e.stopPropagation()}),$(this.oListScope).on("dblclick",i,function(e){e&&e.stopPropagation&&e.stopPropagation()})},CSelector.prototype.getResultSelection=function(e,t){var i=this,s=!1,o=!1,n=null,a=this.iFactor,r=!!this.multiplyLineFactor,l=0,h=0,c=[];if(!e&&-1<Utils.inArray(t,[this.KeyUp,this.KeyDown,this.KeyLeft,this.KeyRight,Enums.Key.PageUp,Enums.Key.PageDown,Enums.Key.Home,Enums.Key.End]))c=this.list(),c&&0<c.length&&(-1<Utils.inArray(t,[this.KeyDown,this.KeyRight,Enums.Key.PageUp,Enums.Key.Home])?n=c[0]:-1<Utils.inArray(t,[this.KeyUp,this.KeyLeft,Enums.Key.PageDown,Enums.Key.End])&&(n=c[c.length-1]));else if(e&&(c=this.list(),h=c?c.length:0,0<h))if(Enums.Key.Home===t||Enums.Key.PageUp===t||Enums.Key.End===t||Enums.Key.PageDown===t||r&&(Enums.Key.Left===t||Enums.Key.Right===t)||!r&&(Enums.Key.Up===t||Enums.Key.Down===t))_.each(c,function(a){if(!s)switch(t){case i.KeyUp:case i.KeyLeft:e===a?s=!0:n=a;break;case Enums.Key.Home:case Enums.Key.PageUp:n=a,s=!0;break;case i.KeyDown:case i.KeyRight:o?(n=a,s=!0):e===a&&(o=!0);break;case Enums.Key.End:case Enums.Key.PageDown:n=a}});else if(r&&this.KeyDown===t){for(;l<h;l++)if(e===c[l]){l+=a,h-1<l&&(l-=a),n=c[l];break}}else if(r&&this.KeyUp===t)for(l=h;l>=0;l--)if(e===c[l]){l-=a,0>l&&(l+=a),n=c[l];break}return n},CSelector.prototype.shiftClickResult=function(e,t,i){if(t){var s=!!this.multiplyLineFactor,o=!1,n=!1;-1<Utils.inArray(i,s?[Enums.Key.Left,Enums.Key.Right]:[Enums.Key.Up,Enums.Key.Down])?t.checked(!t.checked()):-1<Utils.inArray(i,s?[Enums.Key.Up,Enums.Key.Down,Enums.Key.PageUp,Enums.Key.PageDown,Enums.Key.Home,Enums.Key.End]:[Enums.Key.Left,Enums.Key.Right,Enums.Key.PageUp,Enums.Key.PageDown,Enums.Key.Home,Enums.Key.End])&&(n=!t.checked(),_.each(this.list(),function(i){var s=!1;i!==e&&t!==i||(o=!o,s=!0),(o||s)&&(i.checked(n),s=!1)}),s&&e&&(i===Enums.Key.Up||i===Enums.Key.Down)&&e.checked(!e.checked()))}},CSelector.prototype.clickNewSelectPosition=function(e,t){var i=this,s=0,o=null,n=this.itemSelected();o=this.getResultSelection(n,e),o?(t&&this.shiftClickResult(o,n,e),o&&this.fBeforeSelectCallback?(this.fBeforeSelectCallback(o,function(e){e&&(i.itemSelected(o),s=0===i.iTimer?50:150,0!==i.iTimer&&window.clearTimeout(i.iTimer),i.iTimer=window.setTimeout(function(){i.iTimer=0,i.onSelect(o,!1)},s),this.scrollToSelected())}),this.scrollToSelected()):(this.itemSelected(o),s=0===this.iTimer?50:150,0!==this.iTimer&&window.clearTimeout(this.iTimer),this.iTimer=window.setTimeout(function(){i.iTimer=0,i.onSelect(o)},s),this.scrollToSelected())):n&&t&&-1<Utils.inArray(e,[this.KeyUp,this.KeyDown,this.KeyLeft,this.KeyRight,Enums.Key.PageUp,Enums.Key.PageDown,Enums.Key.Home,Enums.Key.End])&&n.checked(!n.checked())},CSelector.prototype.onKeydown=function(e){var t=!0,i=0;return this.useKeyboardKeys()&&e&&!Utils.isTextFieldFocused()&&!App.Screens.hasOpenedMaximizedPopups()&&(i=e.keyCode,e.ctrlKey||this.KeyUp!==i&&this.KeyDown!==i&&this.KeyLeft!==i&&this.KeyRight!==i&&Enums.Key.PageUp!==i&&Enums.Key.PageDown!==i&&Enums.Key.Home!==i&&Enums.Key.End!==i?Enums.Key.Del!==i||e.ctrlKey||e.shiftKey?Enums.Key.Enter===i?0<this.list().length&&!e.ctrlKey&&(this.onEnter(this.itemSelected()),
t=!1):!e.ctrlKey||e.altKey||e.shiftKey||Enums.Key.a!==i||(this.checkAll(!(this.checkAll()&&!this.isIncompleteChecked())),t=!1):0<this.list().length&&(this.onDelete(),t=!1):(this.clickNewSelectPosition(i,e.shiftKey),t=!1)),t},CSelector.prototype.onDelete=function(){this.fDeleteCallback.call(this,this.listCheckedOrSelected())},CSelector.prototype.onEnter=function(e){var t=this;e&&this.fBeforeSelectCallback?this.fBeforeSelectCallback(e,function(i){i&&(t.itemSelected(e),t.fEnterCallback.call(this,e))}):(this.itemSelected(e),this.fEnterCallback.call(this,e))},CSelector.prototype.selectionFunc=function(e){this.itemSelected(null),this.bResetCheckedOnClick&&this.listChecked(!1),this.itemSelected(e),this.fSelectCallback.call(this,e)},CSelector.prototype.onSelect=function(e,t){if(t=!!Utils.isUnd(t)||!!t,this.fBeforeSelectCallback&&t){var i=this;this.fBeforeSelectCallback(e,function(t){t&&i.selectionFunc(e)})}else this.selectionFunc(e)},CSelector.prototype.onDblClick=function(e){this.fDblClickCallback.call(this,e)},CSelector.prototype.koCheckAll=function(){return ko.computed({read:this.checkAll,write:this.checkAll,owner:this})},CSelector.prototype.koCheckAllIncomplete=function(){return ko.computed({read:this.isIncompleteChecked,write:this.isIncompleteChecked,owner:this})},CSelector.prototype.scrollToSelected=function(){if(!this.oListScope||!this.oScrollScope)return!1;var e=20,t=$(this.sSelectabelSelector,this.oScrollScope),i=t.position(),s=this.oScrollScope.height(),o=t.outerHeight();return!(!i||!(i.top<0||i.top+o>s))&&(i.top<0?this.oScrollScope.scrollTop(this.oScrollScope.scrollTop()+i.top-e):this.oScrollScope.scrollTop(this.oScrollScope.scrollTop()+i.top-s+o+e),!0)},function(e){e.fn.splitter=function(t){return t=t||{},this.each(function(){var i=!1,s=!!t.collapse&&t.collapse,o=t.name,n=0,a=0,r=0,l={},h={},c=e(this),p=e(">*:not(css3pie)",c).each(function(){this.$=e(this)}),d=(t.splitHorizontal?"h":t.splitVertical?"v":t.type)||"v",u=e(".resize_handler",p.get(0)).attr({unselectable:"on"}),m="rtl"===c.css("direction"),g=e.extend({activeClass:"active",pxPerKey:8,tabIndex:0,accessKey:""},{v:{keyLeft:39,keyRight:37,type:"v",eventPos:"pageX",origin:"left",split:"width",pxSplit:"offsetWidth",side1:"Left",side2:"Right",fixed:"height",pxFixed:"offsetHeight",side3:"Top",side4:"Bottom"},h:{keyTop:40,keyBottom:38,type:"h",eventPos:"pageY",origin:"top",split:"height",pxSplit:"offsetHeight",side1:"Top",side2:"Bottom",fixed:"width",pxFixed:"offsetWidth",side3:"Left",side4:"Right"}}[d],t),A=function(e,t){var i=p.get(0)._min;r=e,s&&i-e>150&&(e=5,t=!0),t||(e=window.Math.max(i,c._overallWidth-p.get(1)._max,window.Math.min(e,p.get(0)._max,c._overallWidth-p.get(1)._min))),p.get(0).$.css(g.split,e),p.get(1).$.css(g.split,c._overallWidth-e),App.browser.ie8AndBelow||p.trigger("resize")},f=function(e){var i=(m?c._overallWidth-e[g.eventPos]:e[g.eventPos])+g._posSplit;A(i),Utils.isFunc(t.resizeFunc)&&t.resizeFunc()},C=function i(s){u.removeClass(g.activeClass),e("body").attr({unselectable:"off"}).removeClass("unselectable"),o&&App.Storage.setData(o+"ResizerWidth",p.get(0)[g.pxSplit]),e(document).unbind("mousemove",f).unbind("mouseup",i),Utils.isFunc(t.resizeFunc)&&t.resizeFunc()},b=function(t){i=!0,u.addClass(g.activeClass),g._posSplit=-((m?c._overallWidth-t[g.eventPos]:t[g.eventPos])-p.get(0)[g.pxSplit]),e("body").attr({unselectable:"on"}).addClass("unselectable"),e(document).bind("mousemove",f).bind("mouseup",C)},S=function(e,t){for(var i=0,s=1;s<arguments.length;s++)i+=window.Math.max(window.parseInt(e.css(arguments[s]),10)||0,0);return i};u.bind("mousedown",b),p.get(0)._paneName=g.side1,p.get(1)._paneName=g.side2,p.each(function(){this._min=g["min"+this._paneName]||S(this.$,"min-"+g.split),this._max=g["max"+this._paneName]||S(this.$,"max-"+g.split)||9999,this._init=void 0===g["size"+this._paneName]?window.parseInt(e.css(this,g.split),10):g["size"+this._paneName]}),n=o?App.Storage.getData(o+"ResizerWidth")||p.get(0)._init:p.get(0)._init,isNaN(n)&&(n=c[0][g.pxSplit],n=window.Math.round(n/p.length)),g.resizeToWidth&&!App.browser.ie8AndBelow&&e(window).bind("resize",function(e){e.target===this&&c.trigger("resize")}),c.bind("resize",function(e,t,s,o,n){var r=e.target.className+"_"+s;i&&(l={}),e.target===this&&(c._overallWidth=c[0][g.pxSplit],c._overallWidth<=0||(a=g.sizeRight||g.sizeBottom?c._overallWidth-p.get(1)[g.pxSplit]:p.get(0)[g.pxSplit],isNaN(t)?t=a:s&&(n?t=l[r]?l[r]:a:(i=!1,l[r]?(t=l[r],l[r]=null):(t===a?(l[r]=null,t=h[r]):l[r]=h[r]=a,_.each(l,function(e,t){t!==r&&(l[t]=null)})))),A(t,o)))}).trigger("resize",[n])})}}(jQuery),function(e){e.ui.autocomplete.prototype._renderItem=function(t,i){var s=i.label.match(/[a-zA-Z0-9.\-_]+@[a-zA-Z0-9.\-]+/g);return s&&(i.label=i.label.replace("<"+s[0]+">","<span style='opacity: 0.5'>&lt;"+s[0]+"&gt</span>")),e("<li>").append("<a>"+i.label+(i.global===!1?'<span class="del"></span>':"")+"</a>").appendTo(t)},e.ui.autocomplete.prototype._renderMenu=function(t,i){var s=this,o="";e.each(i,function(e,i){i&&i.category&&i.category!==o&&(o=i.category,t.append('<li class="ui-autocomplete-category">'+i.category+"</li>")),s._renderItemData(t,i)})},e.ui.autocomplete.prototype._move=function(e,t){return this.menu.element.is(":visible")?(this.menu.isFirstItem()&&/^previous/.test(e)?(this._value(this.term),this.menu._move("first","first",t)):this.menu.isLastItem()&&/^next/.test(e)&&(this._value(this.term),this.menu._move("last","last",t)),void this.menu[e](t)):void this.search(null,t)}}(jQuery),CApi.prototype.composeMessage=function(){App.Routing.setHash([Enums.Screens.Compose])},CApi.prototype.composeMessageFromDrafts=function(e,t){var i=App.Links.composeFromMessage("drafts",e,t);App.Routing.setHash(i)},CApi.prototype.composeMessageAsReplyOrForward=function(e,t,i){var s=App.Links.composeFromMessage(e,t,i);App.Routing.setHash(s)},CApi.prototype.composeMessageToAddresses=function(e){var t=App.Links.composeWithToField(e);App.Routing.setHash(t)},CApi.prototype.composeMessageWithVcard=function(e){var t=["vcard",e];App.Routing.goDirectly(App.Links.compose(),t)},CApi.prototype.composeMessageWithEml=function(e){var t=["eml",e];App.Routing.goDirectly(App.Links.compose(),t)},CApi.prototype.composeMessageWithPgpKey=function(e,t){var i=["data-as-file",e,t];App.Routing.goDirectly(App.Links.compose(),i)},CApi.prototype.composeMessageWithFiles=function(e){var t=["file",e];App.Routing.goDirectly(App.Links.compose(),t)},CApi.prototype.closeComposePopup=function(){},CApi.prototype.createMailAccount=function(e){},CApi.prototype.showChangeDefaultAccountPasswordPopup=function(){},CApi.prototype.showConfigureMailPopup=function(e){},CApi.prototype.downloadByUrl=function(e){var t=null;bMobileDevice?window.open(e):(t=$('<iframe style="display: none;"></iframe>').appendTo(document.body),t.attr("src",e),setTimeout(function(){t.remove()},6e4))},CApi.prototype.isPgpSupported=function(){return!(!window.crypto||!window.crypto.getRandomValues)},CApi.prototype.pgp=function(e,t){if(Utils.isFunc(e))if(this.openPgp)e(this.openPgp);else if(this.isPgpSupported()){null!==this.openPgpCallbacks?this.openPgpCallbacks.push(e):e(!1);var i=this;this.openPgpRequest||(this.openPgpRequest=!0,$.ajax({url:"static/js/openpgp.js",dataType:"script",cache:!0,complete:function(){i.openPgp=!!window.openpgp&&new OpenPgp(window.openpgp,"user_"+(t||"0")+"_"),null!==i.openPgpCallbacks&&_.each(i.openPgpCallbacks,function(e){e(i.openPgp)}),i.openPgpCallbacks=null}}))}else e(!1)},CApi.prototype.showLoading=function(e){App.Screens.showLoading(e)},CApi.prototype.hideLoading=function(){App.Screens.hideLoading()},CApi.prototype.showReport=function(e,t){App.Screens.showReport(e,t)},CApi.prototype.showError=function(e,t,i,s){App.Screens.showError(e,t,i,s)},CApi.prototype.hideError=function(e){App.Screens.hideError(e)},CApi.prototype.showPgpErrorByCode=function(e,t,i){var s=Utils.isNonEmptyArray(e.errors)?e.errors:[],o=Utils.isNonEmptyArray(e.notices)?e.notices:[],n=[],a=[],r="",l=!1,h=!0;if(_.each(_.union(s,o),function(e){if(2===e.length)switch(e[0]){case OpenPgpResult.Enum.GenerateKeyError:r=Utils.i18n("OPENPGP/ERROR_GENERATE_KEY");break;case OpenPgpResult.Enum.ImportKeyError:r=Utils.i18n("OPENPGP/ERROR_IMPORT_KEY");break;case OpenPgpResult.Enum.ImportNoKeysFoundError:r=Utils.i18n("OPENPGP/ERROR_IMPORT_NO_KEY_FOUND");break;case OpenPgpResult.Enum.PrivateKeyNotFoundError:case OpenPgpResult.Enum.PrivateKeyNotFoundNotice:a.push(e[1]);break;case OpenPgpResult.Enum.PublicKeyNotFoundError:h=!1,n.push(e[1]);break;case OpenPgpResult.Enum.PublicKeyNotFoundNotice:n.push(e[1]);break;case OpenPgpResult.Enum.KeyIsNotDecodedError:t===Enums.PgpAction.DecryptVerify?r=Utils.i18n("OPENPGP/ERROR_DECRYPT")+" "+Utils.i18n("OPENPGP/ERROR_KEY_NOT_DECODED",{USER:e[1]}):t!==Enums.PgpAction.Sign&&t!==Enums.PgpAction.EncryptSign||(r=Utils.i18n("OPENPGP/ERROR_SIGN")+" "+Utils.i18n("OPENPGP/ERROR_KEY_NOT_DECODED",{USER:e[1]}));break;case OpenPgpResult.Enum.SignError:r=Utils.i18n("OPENPGP/ERROR_SIGN");break;case OpenPgpResult.Enum.VerifyError:r=Utils.i18n("OPENPGP/ERROR_VERIFY");break;case OpenPgpResult.Enum.EncryptError:r=Utils.i18n("OPENPGP/ERROR_ENCRYPT");break;case OpenPgpResult.Enum.DecryptError:r=Utils.i18n("OPENPGP/ERROR_DECRYPT");break;case OpenPgpResult.Enum.SignAndEncryptError:r=Utils.i18n("OPENPGP/ERROR_ENCRYPT_OR_SIGN");break;case OpenPgpResult.Enum.VerifyAndDecryptError:r=Utils.i18n("OPENPGP/ERROR_DECRYPT_OR_VERIFY");break;case OpenPgpResult.Enum.DeleteError:r=Utils.i18n("OPENPGP/ERROR_DELETE_KEY");break;case OpenPgpResult.Enum.VerifyErrorNotice:r=Utils.i18n("OPENPGP/ERROR_VERIFY");break;case OpenPgpResult.Enum.NoSignDataNotice:l=!0}}),n.length>0?(n=_.without(n,""),n.length>0?r=Utils.i18n("OPENPGP/ERROR_NO_PUBLIC_KEYS_FOR_USERS_PLURAL",{USERS:n.join(", ")},null,n.length):t===Enums.PgpAction.Verify&&(r=Utils.i18n("OPENPGP/ERROR_NO_PUBLIC_KEY_FOUND_FOR_VERIFY")),h&&""!==r&&(r+=" "+Utils.i18n("OPENPGP/ERROR_MESSAGE_WAS_NOT_VERIFIED"))):a.length>0&&(a=_.without(a,""),a.length>0?r=Utils.i18n("OPENPGP/ERROR_NO_PRIVATE_KEYS_FOR_USERS_PLURAL",{USERS:a.join(", ")},null,a.length):t===Enums.PgpAction.DecryptVerify&&(r=Utils.i18n("OPENPGP/ERROR_NO_PRIVATE_KEY_FOUND_FOR_DECRYPT"))),""===r&&!l){switch(t){case Enums.PgpAction.Generate:r=Utils.i18n("OPENPGP/ERROR_GENERATE_KEY");break;case Enums.PgpAction.Import:r=Utils.i18n("OPENPGP/ERROR_IMPORT_KEY");break;case Enums.PgpAction.DecryptVerify:r=Utils.i18n("OPENPGP/ERROR_DECRYPT");break;case Enums.PgpAction.Verify:r=Utils.i18n("OPENPGP/ERROR_VERIFY");break;case Enums.PgpAction.Encrypt:r=Utils.i18n("OPENPGP/ERROR_ENCRYPT");break;case Enums.PgpAction.EncryptSign:r=Utils.i18n("OPENPGP/ERROR_ENCRYPT_OR_SIGN");break;case Enums.PgpAction.Sign:r=Utils.i18n("OPENPGP/ERROR_SIGN")}r=i}return""!==r&&App.Api.showError(r),l},CApi.prototype.showErrorByCode=function(e,t,i){var s=e.ErrorCode,o=e.ErrorMessage||"",n="";switch(s){default:n=t||Utils.i18n("WARNING/UNKNOWN_ERROR");break;case Enums.Errors.AuthError:n=Utils.i18n("WARNING/LOGIN_PASS_INCORRECT");break;case Enums.Errors.DataBaseError:n=Utils.i18n("WARNING/DATABASE_ERROR");break;case Enums.Errors.LicenseProblem:n=Utils.i18n("WARNING/INVALID_LICENSE");break;case Enums.Errors.DemoLimitations:n=Utils.i18n("DEMO/WARNING_THIS_FEATURE_IS_DISABLED");break;case Enums.Errors.Captcha:n=Utils.i18n("WARNING/CAPTCHA_IS_INCORRECT");break;case Enums.Errors.CanNotGetMessage:n=Utils.i18n("MESSAGE/ERROR_MESSAGE_DELETED");break;case Enums.Errors.NoRequestedMailbox:n=t+" "+Utils.i18n("COMPOSE/ERROR_INVALID_ADDRESS",{ADDRESS:e.Mailbox||""});break;case Enums.Errors.CanNotChangePassword:n=Utils.i18n("WARNING/UNABLE_CHANGE_PASSWORD");break;case Enums.Errors.AccountOldPasswordNotCorrect:n=Utils.i18n("WARNING/CURRENT_PASSWORD_NOT_CORRECT");break;case Enums.Errors.FetcherIncServerNotAvailable:n=Utils.i18n("WARNING/FETCHER_SAVE_ERROR");break;case Enums.Errors.FetcherLoginNotCorrect:n=Utils.i18n("WARNING/FETCHER_SAVE_ERROR");break;case Enums.Errors.HelpdeskUserNotExists:n=Utils.i18n("HELPDESK/ERROR_FORGOT_NO_ACCOUNT");break;case Enums.Errors.MailServerError:n=Utils.i18n("WARNING/CANT_CONNECT_TO_SERVER");break;case Enums.Errors.DataTransferFailed:n=Utils.i18n("WARNING/DATA_TRANSFER_FAILED");break;case Enums.Errors.NotDisplayedError:n=""}""!==n?(""!==o&&(n+=" ("+o+")"),this.showError(n,!1,!!i)):""!==o&&this.showError(o)},CApi.prototype.showErrorIfAttachmentSizeLimit=function(e,t){var i=Utils.i18n("COMPOSE/UPLOAD_ERROR_FILENAME_SIZE",{FILENAME:e,MAXSIZE:Utils.friendlySize(AppData.App.AttachmentSizeLimit)});return AppData.App.AttachmentSizeLimit>0&&t>AppData.App.AttachmentSizeLimit&&(App.Screens.showPopup(AlertPopup,[i]),!0)},CApi.prototype.deleteMessages=function(e,t,i){Utils.isFunc(i)||(i=function(){});var s=App.MailCache.folderList(),o=s.currentFolderFullName(),n=s.trashFolder(),a=n&&o===n.fullName(),r=s.spamFolder(),l=r&&o===r.fullName(),h=function(s){s&&(t.MailCache.deleteMessages(e),i())};l?(t.MailCache.deleteMessages(e),i()):a?App.Screens.showPopup(ConfirmPopup,[Utils.i18n("MAILBOX/CONFIRM_MESSAGES_DELETE"),h]):n?(t.MailCache.moveMessagesToFolder(n.fullName(),e),i()):n||App.Screens.showPopup(ConfirmPopup,[Utils.i18n("MAILBOX/CONFIRM_MESSAGES_DELETE_NO_TRASH_FOLDER"),h])},CApi.prototype.contactCreate=function(e,t,i,s){},CApi.prototype.composeMessage=function(){App.Screens.showPopup(ComposePopup)},CApi.prototype.composeMessageFromDrafts=function(e,t){var i=App.Links.composeFromMessage("drafts",e,t);i.shift(),App.Screens.showPopup(ComposePopup,[i])},CApi.prototype.composeMessageAsReplyOrForward=function(e,t,i){var s=App.Links.composeFromMessage(e,t,i);AppData.SingleMode?App.Routing.setHash(s):(s.shift(),App.Screens.showPopup(ComposePopup,[s]))},CApi.prototype.composeMessageToAddresses=function(e){var t=App.Links.composeWithToField(e);AppData.SingleMode?App.Routing.setHash(t):(t.shift(),App.Screens.showPopup(ComposePopup,[t]))},CApi.prototype.composeMessageWithVcard=function(e){var t=["vcard",e];App.Screens.showPopup(ComposePopup,[t])},CApi.prototype.composeMessageWithEml=function(e){var t=["eml",e];App.Screens.showPopup(ComposePopup,[t])},CApi.prototype.composeMessageWithPgpKey=function(e,t){var i=["data-as-file",e,t];App.Screens.showPopup(ComposePopup,[i])},CApi.prototype.composeMessageWithFiles=function(e){var t=["file",e];App.Screens.showPopup(ComposePopup,[t])},CApi.prototype.closeComposePopup=function(){App.Screens.showPopup(ComposePopup,[["close"]])},CApi.prototype.createMailAccount=function(e){App.Screens.showPopup(AccountCreatePopup,[Enums.AccountCreationPopupType.OneStep,e])},CApi.prototype.showChangeDefaultAccountPasswordPopup=function(){var e=AppData.Accounts.getDefault();App.Screens.showPopup(ChangePasswordPopup,[!1,e.passwordSpecified(),function(){e.passwordSpecified(!0),AfterLogicApi.runPluginHook&&AfterLogicApi.runPluginHook("api-mail-on-password-specified-success",[this.__name,this])}])},CApi.prototype.showConfigureMailPopup=function(e){var t=AppData.Accounts.getDefault();t&&!t.allowMail()&&App.Screens.showPopup(AccountCreatePopup,[Enums.AccountCreationPopupType.ConnectToMail,t.email(),e])},CApi.prototype.contactCreate=function(e,t,i,s){App.Screens.showPopup(ContactCreatePopup,[e,t,i,s])},CApi.prototype.showPlayer=function(e){App.Screens.showPopup(PlayerPopup,[e])},AfterLogicApi.addScreenToHeader=function(e,t,i,s,o){App.addScreenToHeader(e,t,i,s,o,!0)},AfterLogicApi.setDefaultTab=function(e){var t=!!_.find(Enums.Screens,function(t){return t===e});t&&(AppData.App.DefaultTab=e)},AfterLogicApi.aSettingsTabs=[],AfterLogicApi.addSettingsTab=function(e){e.prototype.TabName&&(Enums.SettingsTab[e.prototype.TabName]=e.prototype.TabName,AfterLogicApi.aSettingsTabs.push(e))},AfterLogicApi.getPluginsSettingsTabs=function(){return AfterLogicApi.aSettingsTabs},AfterLogicApi.getSetting=function(e){return AppData.App[e]},AfterLogicApi.getPluginSettings=function(e){return AppData&&AppData.Plugins?AppData.Plugins[e]:null},AfterLogicApi.getAuthToken=function(){return App.Storage.getData("AuthToken")},AfterLogicApi.oPluginHooks={},AfterLogicApi.addPluginHook=function(e,t){Utils.isFunc(t)&&($.isArray(this.oPluginHooks[e])||(this.oPluginHooks[e]=[]),this.oPluginHooks[e].push(t))},AfterLogicApi.runPluginHook=function(e,t){$.isArray(this.oPluginHooks[e])&&(t=t||[],_.each(this.oPluginHooks[e],function(e){e.apply(null,t)}))},AfterLogicApi.sendAjaxRequest=function(e,t,i){App.Ajax.send(e,t,i)},AfterLogicApi.i18n=Utils.i18n,AfterLogicApi.getArrayRecipients=Utils.Address.getArrayRecipients,AfterLogicApi.getEmailParts=Utils.Address.getEmailParts,AfterLogicApi.isCorrectEmail=Utils.Address.isCorrectEmail,AfterLogicApi.showAlertPopup=function(e){App.Screens.showPopup(AlertPopup,[e])},AfterLogicApi.showConfirmPopup=function(e,t){App.Screens.showPopup(ConfirmPopup,[e,t])},AfterLogicApi.showPopup=function(e,t){App.Screens.showPopup(e,t)},AfterLogicApi.showReport=function(e,t){App.Screens.showReport(e,t)},AfterLogicApi.showError=function(e){App.Screens.showError(e)},AfterLogicApi.getPrimaryAccountData=function(){var e=AppData.Accounts.getDefault();return{Id:e.id(),Email:e.email(),FriendlyName:e.friendlyName()}},AfterLogicApi.getCurrentAccountData=function(){var e=AppData.Accounts.getCurrent();return{Id:e.id(),Email:e.email(),FriendlyName:e.friendlyName()}},AfterLogicApi.isMobile=function(){return this.getAppDataItem("IsMobile")},AfterLogicApi.getRequestParam=Utils.Common.getRequestParam,AfterLogicApi.editedFolderList=function(){return App.MailCache.editedFolderList},AfterLogicApi.FileSizeLimit=AppData.App.FileSizeLimit,AfterLogicApi.isFunc=Utils.isFunc,AfterLogicApi.isUnd=Utils.isUnd,AfterLogicApi.emptyFunction=Utils.emptyFunction,AfterLogicApi.getAppDataItem=function(e){return AppData&&AppData[e]?AppData[e]:null},AfterLogicApi.WindowOpener=Utils.WindowOpener,AfterLogicApi.getAppPath=Utils.Common.getAppPath,AfterLogicApi.loadScript=Utils.loadScript,AfterLogicApi.createObjectInstance=function(sClassName){var oReg=new RegExp("^[a-zA-Z]+$");return oReg.test(sClassName)?eval("new "+sClassName+"()"):null},AfterLogicApi.openComposePopup=function(e,t,i,s,o,n){var a={to:e,cc:t,bcc:i,subject:s,body:o,attachments:n};App.Screens.showPopup(ComposePopup,[["message-data-object",a]])},CStorage.prototype.hasData=function(e){var t=this.bHtml5?localStorage.getItem(e):$.cookie(e);return!!t},CStorage.prototype.getData=function(e){var t=this.bHtml5?localStorage.getItem(e):$.cookie(e);return $.parseJSON(t)},CStorage.prototype.setData=function(e,t){var i=JSON.stringify(t);this.bHtml5?localStorage.setItem(e,i):$.cookie(e,i,{expires:30})},CStorage.prototype.removeData=function(e){this.bHtml5?localStorage.removeItem(e):$.cookie(e,null)},CStorage.prototype.init=function(){if("undefined"==typeof Storage)this.bHtml5=!1;else try{localStorage.setItem("check","val"),localStorage.removeItem("check")}catch(e){this.bHtml5=!1}},CPhone.prototype.init=function(){$.ajaxSettings.cache=!0,this.provider="sip"===AppData.User.VoiceProvider?new CPhoneWebrtc:new CPhoneTwilio,this.action(Enums.PhoneAction.OfflineInit)},CPhone.prototype.log=function(){},CPhone.prototype.onGetScript=function(e){e&&"success"===e?this.log("*************** gettingScript_success"):(this.log("*************** gettingScript_unknownError"),this.action(Enums.PhoneAction.OfflineError))},CPhone.prototype.showError=function(e){1===Utils.pInt(e)&&App.Api.showError(Utils.i18n("PHONE/ERROR_SERVER_UNAVAILABLE"),!1,!0)},CPhone.prototype.phoneSupport=function(e,t){var i=function(){try{try{var e=new ActiveXObject("ShockwaveFlash.ShockwaveFlash.6");try{e.AllowScriptAccess="always"}catch(e){return"6,0,0"}}catch(e){}return new ActiveXObject("ShockwaveFlash.ShockwaveFlash").GetVariable("$version").replace(/\D+/g,",").match(/^,?(.+),?$/)[1]}catch(e){try{if(navigator.mimeTypes["application/x-shockwave-flash"].enabledPlugin)return(navigator.plugins["Shockwave Flash 2.0"]||navigator.plugins["Shockwave Flash"]).description.replace(/\D+/g,",").match(/^,?(.+),?$/)[1]}catch(e){}}return"0,0,0"};!e||App.browser.chrome||t||bIsIosDevice?bIsIosDevice?this.log("*************** Device not supported"):t&&"0,0,0"===i()?this.log("*************** Please install flash player"):t&&i()<t&&this.log("*************** Please reinstall flash player"):this.log("*************** Browser not supported")},CPhone.prototype.incomingCall=function(e){var t,i,s;this.action(Enums.PhoneAction.Incoming),e&&(t=this,i={Action:"ContactSuggestions",Search:e,PhoneOnly:"1"},s=function(e){t.report(Utils.i18n("PHONE/INCOMING_CALL_FROM")+" "+e),App.Screens.showPopup(PhonePopup,[{text:e}]),App.desktopNotify({action:"show",title:e+" calling...",body:"Click here to answer.\r\n To drop the call, click End in the web interface.",callback:_.bind(function(){t.action(Enums.PhoneAction.IncomingConnect)},t),timeout:6e4})},App.Ajax.send(i,function(t){if(t&&t.Result&&t.Result.List&&t.Result.List[0]&&t.Result.List[0].Phones){var i="";$.each(t.Result.List[0].Phones,function(o,n){var a=t.Result.List[0],r=/[()\s_\-]/g,l=e.replace(r,""),h=n.replace(r,"");if(l===h)return i=""===a.Name?a.Email+" "+n:a.Name+" "+n,s(i),!1},this),""===i&&s(e)}else s(e)},this),this.missedCalls(!0))},CPhone.prototype.getFormattedPhone=function(e){e=e.toString();var t={8:"7"},i=/#/g.test(e)?e.split("#")[1]:e.replace(/[()\s_\-+]/g,"");return _.each(t,function(e,t){i=i.replace(new RegExp("^"+t,"g"),e)}),i},CPhone.prototype.getLogs=function(e,t){this.missedCalls(!1),this.provider.getLogs(e,t)},CPhone.prototype.getCleanedPhone=function(e){return e=e?e:"",e.replace("client:","")},CPhoneWebrtc.prototype.init=function(){var e=this;$.getScript("static/js/sipml.js",function(t,i,s){e.phone.onGetScript(i),"success"===i&&(e.setConfigs(),SIPml.setDebugLevel("fatal"),SIPml.init(e.createStackBinded,e.createStackErrorBinded))})},CPhoneWebrtc.prototype.setConfigs=function(){this.stackConf({realm:AppData.User.SipRealm,impi:AppData.User.SipImpi,impu:"sip:"+AppData.User.SipImpi+"@"+AppData.User.SipRealm,password:AppData.User.SipPassword,enable_rtcweb_breaker:!0,websocket_proxy_url:AppData.User.SipWebsocketProxyUrl,ice_servers:'[{ url: "stun:stun.afterlogic.com:3478"}]',events_listener:{events:"*",listener:this.eventSessionBinded}}),this.registerConf({audio_remote:this.audioRemote,expires:3600,events_listener:{events:"*",listener:this.eventSessionBinded},sip_caps:[{name:"+g.oma.sip-im",value:null},{name:"+audio",value:null},{name:"+sip.ice"},{name:"language",value:'"en,fr"'}]}),this.hangupConf({events_listener:{events:"*",listener:this.eventSessionBinded}})},CPhoneWebrtc.prototype.createStack=function(){this.stack(new SIPml.Stack(this.stackConf())),this.stack().start()},CPhoneWebrtc.prototype.createStackError=function(){this.phone.log("*************** Failed to initialize the engine")},CPhoneWebrtc.prototype.register=function(){this.registerSession(this.stack().newSession("register",this.registerConf())),this.registerSession().register()},CPhoneWebrtc.prototype.eventSession=function(e){this.phone.log("*************** "+e.type+" ("+e.description+")");var t=e.type;switch(t){case"starting":break;case"started":App.Api.hideError(),this.isStarted(!0),this.register();break;case"stopping":case"stopped":this.isStarted(!1),this.createStack();break;case"failed_to_stop":break;case"failed_to_start":this.phone.action(Enums.PhoneAction.OfflineError),this.isStarted(!1),this.reconnect(30);break;case"connecting":break;case"connected":"Connected"===e.description?this.phone.action(Enums.PhoneAction.Online):"In call"===e.description&&App.desktopNotify({action:"hide"});break;case"terminating":case"terminated":this.phone.action(Enums.PhoneAction.Online),"Disconnected"===e.description&&this.createStack();break;case"i_ao_request":break;case"media_added":break;case"media_removed":break;case"m_stream_video_remote_added":break;case"m_stream_audio_local_added":break;case"m_stream_audio_remote_added":break;case"i_request":break;case"o_request":break;case"sent_request":break;case"cancelled_request":break;case"i_new_call":this.callSession(e.newSession),this.callSession().setConfiguration(this.registerConf()),this.phone.incomingCall(this.callSession().getRemoteFriendlyName());break;case"i_new_message":break;case"m_permission_requested":break;case"m_permission_accepted":break;case"m_permission_refused":break;case"transport_error":break;case"global_error":break;case"message_error":break;case"webrtc_error":}},CPhoneWebrtc.prototype.call=function(e){this.isStarted()?(this.action("outgoing"),this.callSession(this.stack().newSession("call-audio",this.registerConf())),this.callSession().call(e),this.phone.log("*************** "+this.callSession().getRemoteFriendlyName())):this.createStack()},CPhoneWebrtc.prototype.answer=function(){this.callSession()&&this.callSession().accept(this.registerConf())},CPhoneWebrtc.prototype.hangup=function(){this.callSession()&&(this.callSession().hangup(this.hangupConf()),this.callSession().hangup({events_listener:{events:"*",listener:this.eventSessionBinded}}))},CPhoneWebrtc.prototype.reconnect=function(){var e=0;return function(t){clearInterval(e),t&&(e=setInterval(_.bind(function(){},this),t))}}(),CPhoneWebrtc.prototype.getLogs=function(e,t){e.call(t)},CPhoneFlash.prototype.init=function(){var e=this;$.getScript("static/js/swfobject.js",function(t,i,s){"success"===i&&(e.voiceApp(!0),swfobject.embedSWF("static/freeswitch.swf","flash","214","137","9.0.0","expressInstall.swf",{rtmp_url:"rtmp://217.199.220.26/phone"},{allowScriptAccess:"always",bgcolor:"#ece9e0"},[],!1),e.callbacks())})},CPhoneFlash.prototype.log=function(e){},CPhoneFlash.prototype.showPrivacy=function(){App.Screens.showPopup(PhonePopup,[{Action:Enums.PhoneAction.Settings,Callback:this.launchFlash.bind(this)}]);var e=$("#fake_flash"),t=e.offset(),i=e.width();this.jqFlash.css("left",t.left+i/2-107),this.jqFlash.css("top",t.top),this.jqFlash.css("visibility","visible"),this.flash.showPrivacy()},CPhoneFlash.prototype.checkMic=function(){return this.flash.isMuted()},CPhoneFlash.prototype.login=function(e,t){this.flash.login(e,t)},CPhoneFlash.prototype.newCall=function(){},CPhoneFlash.prototype.call=function(e){this.flash.makeCall("sip:7002@217.199.220.24","7003@217.199.220.26",[])},CPhoneFlash.prototype.answer=function(e){this.flash.answer(e)},CPhoneFlash.prototype.hangup=function(e){this.flash.hangup(e)},CPhoneFlash.prototype.addCall=function(e,t,i,s){},CPhoneFlash.prototype.launchFlash=function(e,t,i,s){this.jqFlash.css("top","-200px")},CPhoneFlash.prototype.callbacks=function(){var e=this;window.onInit=function(){e.log("**************** onInit"),e.initStatus(!0)},window.onConnected=function(t){e.log("**************** onConnected ("+t+")"),e.connectStatus(!0),e.sessionid(t),e.jqFlash=$("#flash"),e.flash=e.jqFlash[0],e.checkMic()&&e.showPrivacy(),e.login("7003@217.199.220.26","7003voippassword")},window.onDisconnected=function(){e.log("**************** onDisconnected")},window.onEvent=function(t){e.log("**************** onEvent ("+t+")")},window.onLogin=function(t,i,s){e.log("**************** onLogin ("+t+", "+i+", "+s+")")},window.onLogout=function(t,i){e.log("**************** onLogout ("+t+", "+i+")")},window.onMakeCall=function(t,i,s){e.log("**************** onMakeCall ("+t+", "+i+", "+s+")")},window.onHangup=function(t,i){e.log("**************** onHangup ("+t+", "+i+")")},window.onIncomingCall=function(t,i,s,o,n){e.log("**************** onIncomingCall ("+t+", "+i+", "+s+", "+o+", "+n+")"),e.addCall(t,i,s)},window.onDisplayUpdate=function(t,i,s){e.log("**************** onDisplayUpdate ("+t+", "+i+", "+s+")")},window.onCallState=function(t,i){e.log("**************** onCallState ("+t+", "+i+")"),e.callState(i)},window.onDebug=function(t){e.log("**************** onDebug ("+t+")")},window.onAttach=function(t){e.log("**************** onAttach ("+t+")")}},CPhoneTwilio.prototype.init=function(){App.Ajax.send({Action:"TwilioGetToken"},this.onTokenResponse,this)};CPhoneTwilio.prototype.onTokenResponse=function(e,t){var i=this;e&&e.Result?(this.phone.log("*************** twilioToken_requestTrue"),$.ajaxSettings.cache=!0,$.getScript("//static.twilio.com/libs/twiliojs/1.2/twilio.min.js",function(t,s,o){i.phone.onGetScript(s),"success"===s&&(i.token=e.Result,i.setupDevice(e.Result))})):i.phone.onGetScript()};CPhoneTwilio.prototype.setupDevice=function(e){var t=this;this.phone.log("*************** setup"),this.phone.phoneSupport(!1,"10,1,000"),this.device=Twilio.Device,this.device.setup(e,{}),this.device.ready(function(e){t.phone.log("*************** ready ",e),t.webSocket=window.socket,t.action(Enums.PhoneAction.Online)}),this.device.offline(function(e){t.phone.log("*************** offline ",e),t.action(Enums.PhoneAction.Offline)}),this.device.error(function(e){switch(t.phone.log("*************** error ",e),e.message){case"This AccessToken is no longer valid":case"Cannot register. Token not validated":t.token=null,t.device.destroy()}t.action(Enums.PhoneAction.OfflineError)}),this.device.connect(function(e){t.phone.log("*************** connect ",e),"outbound"===e.message.Direction?t.action(Enums.PhoneAction.Outgoing):"inbound"===e.message.Direction&&t.action(Enums.PhoneAction.Incoming)}),this.device.disconnect(function(e){t.phone.log("*************** disconnect ",e),t.action(Enums.PhoneAction.Online)}),this.device.incoming(function(e){t.phone.log("*************** incoming ",e),t.connection=e,t.phone.incomingCall(e.parameters.From)}),this.device.cancel(function(e){t.phone.log("*************** cancel ",e),t.action(Enums.PhoneAction.Online)}),this.device.presence(function(e){t.phone.log("*************** presence ",e)})},CPhoneTwilio.prototype.call=function(e){this.connection=this.device.connect({PhoneNumber:e,AfterlogicCall:1})},CPhoneTwilio.prototype.answer=function(){this.connection.accept()},CPhoneTwilio.prototype.hangup=function(){this.connection&&(this.connection.status&&"pending"===this.connection.status()?this.connection.reject():this.connection.disconnect(),"closed"!==this.connection.status()&&_.delay(_.bind(function(){this.hangup()},this),1e3))},CPhoneTwilio.prototype.reconnect=function(){var e=0;return function(t){clearInterval(e),t&&(e=setInterval(_.bind(function(){this.device&&this.token?this.device.setup(this.token):this.init()},this),t))}}(),CPhoneTwilio.prototype.getLogs=function(e,t){var i={Action:"TwilioGetLogs",StartTime:moment().subtract(3,"months").format("YYYY-MM-DD")};App.Ajax.send(i,e,t)},OpenPgp.prototype.pgp=null,OpenPgp.prototype.pgpKeyring=null,OpenPgp.prototype.keys=[],OpenPgp.prototype.getKeys=function(){return this.keys()},OpenPgp.prototype.getKeysObservable=function(){return this.keys},OpenPgp.prototype.reloadKeysFromStorage=function(){var e=[],t=this.pgpKeyring.getAllKeys();_.each(t,function(t){t&&t.primaryKey&&e.push(new OpenPgpKey(t))}),this.keys(e)},OpenPgp.prototype.convertToNativeKeys=function(e){return _.map(e,function(e){return e&&e.pgpKey?e.pgpKey:e})},OpenPgp.prototype.cloneKey=function(e){var t=null;return e&&(t=this.pgp.key.readArmored(e.armor()),t&&!t.err&&t.keys&&t.keys[0]?(t=t.keys[0],t&&t.primaryKey||(t=null)):t=null),t},OpenPgp.prototype.decryptKeyHelper=function(e,t,i,s){if(t)try{t.decrypt(Utils.pString(i)),t&&t.primaryKey&&t.primaryKey.isDecrypted||e.addError(OpenPgpResult.Enum.KeyIsNotDecodedError,s||"")}catch(t){e.addExceptionMessage(t,OpenPgpResult.Enum.KeyIsNotDecodedError,s||"")}else e.addError(OpenPgpResult.Enum.KeyIsNotDecodedError,s||"")},OpenPgp.prototype.verifyMessageHelper=function(e,t,i){var s=!1,o=null,n=[],a=[],r=[];if(i&&i.getSigningKeyIds)if(a=i.getSigningKeyIds(),a&&0<a.length)if(r=this.findKeysByEmails([t],!0),r&&0!==r.length){n=[];try{n=i.verify(this.convertToNativeKeys(r))}catch(i){e.addNotice(OpenPgpResult.Enum.VerifyErrorNotice,t)}n&&0<n.length&&(o=_.find(n,function(e){return e&&e.keyid&&e.valid}),o&&o.keyid&&r&&r[0]&&o.keyid.toHex().toLowerCase()===r[0].getId()?s=!0:e.addNotice(OpenPgpResult.Enum.VerifyErrorNotice,t))}else e.addNotice(OpenPgpResult.Enum.PublicKeyNotFoundNotice,t);else e.addNotice(OpenPgpResult.Enum.NoSignDataNotice);else e.addError(OpenPgpResult.Enum.UnknownError);return s||e.hasNotices()||e.addNotice(OpenPgpResult.Enum.VerifyErrorNotice),
s},OpenPgp.prototype.generateKey=function(e,t,i){var s=new OpenPgpResult,o=null;try{o=this.pgp.generateKeyPair({userId:e,numBits:Utils.pInt(i),passphrase:Utils.trim(t)})}catch(e){s.addExceptionMessage(e)}if(o&&o.privateKeyArmored)try{this.pgpKeyring.privateKeys.importKey(o.privateKeyArmored),this.pgpKeyring.publicKeys.importKey(o.publicKeyArmored),this.pgpKeyring.store()}catch(e){s.addExceptionMessage(e,OpenPgpResult.Enum.GenerateKeyError)}else s.addError(OpenPgpResult.Enum.GenerateKeyError);return this.reloadKeysFromStorage(),s},OpenPgp.prototype.splitKeys=function(e){var t=[],i=0,s=30,o=null,n=Utils.trim(e),a=/[\-]{3,6}BEGIN[\s]PGP[\s](PRIVATE|PUBLIC)[\s]KEY[\s]BLOCK[\-]{3,6}[\s\S]+?[\-]{3,6}END[\s]PGP[\s](PRIVATE|PUBLIC)[\s]KEY[\s]BLOCK[\-]{3,6}/gi;for(n=n.replace(/[\r\n]([a-zA-Z0-9]{2,}:[^\r\n]+)[\r\n]+([a-zA-Z0-9\/\\+=]{10,})/g,"\n$1---xyx---$2").replace(/[\n\r]+/g,"\n").replace(/---xyx---/g,"\n\n");;){if(o=a.exec(n),!o||0>s)break;o[0]&&o[1]&&o[2]&&o[1]===o[2]&&("PRIVATE"!==o[1]&&"PUBLIC"!==o[1]||(t.push([o[1],o[0]]),i++)),s--}return t},OpenPgp.prototype.importKeys=function(e){e=Utils.trim(e);var t=0,i=0,s=new OpenPgpResult,o=null,n=[];if(!e)return s.addError(OpenPgpResult.Enum.InvalidArgumentErrors);for(n=this.splitKeys(e),t=0;t<n.length;t++)if(o=n[t],"PRIVATE"===o[0])try{this.pgpKeyring.privateKeys.importKey(o[1]),i++}catch(e){s.addExceptionMessage(e,OpenPgpResult.Enum.ImportKeyError,"private")}else if("PUBLIC"===o[0])try{this.pgpKeyring.publicKeys.importKey(o[1]),i++}catch(e){s.addExceptionMessage(e,OpenPgpResult.Enum.ImportKeyError,"public")}return 0<i?this.pgpKeyring.store():s.addError(OpenPgpResult.Enum.ImportNoKeysFoundError),this.reloadKeysFromStorage(),s},OpenPgp.prototype.getArmorInfo=function(e){e=Utils.trim(e);var t=0,i=0,s=null,o=[],n=null,a=[];if(!e)return!1;for(a=this.splitKeys(e),t=0;t<a.length;t++)if(n=a[t],"PRIVATE"===n[0])try{s=this.pgp.key.readArmored(n[1]),s&&!s.err&&s.keys&&s.keys[0]&&o.push(new OpenPgpKey(s.keys[0])),i++}catch(e){o.push(null)}else if("PUBLIC"===n[0])try{s=this.pgp.key.readArmored(n[1]),s&&!s.err&&s.keys&&s.keys[0]&&o.push(new OpenPgpKey(s.keys[0])),i++}catch(e){o.push(null)}return o},OpenPgp.prototype.findKeyByID=function(e,t){t=!!t,e=e.toLowerCase();var i=_.find(this.keys(),function(i){var s=!1,o=null;return i&&t===i.isPublic()&&(o=i.pgpKey.getKeyIds(),o&&(s=_.find(o,function(t){return t&&t.toHex&&e===t.toHex().toLowerCase()}))),!!s});return i?i:null},OpenPgp.prototype.findKeysByEmails=function(e,t,i){t=!!t;var s=[],o=this.keys();return _.each(e,function(e){var n=_.find(o,function(i){return i&&t===i.isPublic()&&e===i.getEmail()});n?s.push(n):i&&i.addError(t?OpenPgpResult.Enum.PublicKeyNotFoundError:OpenPgpResult.Enum.PrivateKeyNotFoundError,e)}),s},OpenPgp.prototype.decryptAndVerify=function(e,t,i,s){var o=this,n=null,a=null,r=null,l=null,h=null,c=new OpenPgpResult,p=[];if(n=this.pgp.message.readArmored(e),n&&n.decrypt)if(p=n.getEncryptionKeyIds(),p&&(r=null,a=null,_.each(p,function(e){a||(a=o.findKeyByID(e.toHex(),!1),a&&t!==a.getEmail()&&(a=null))}),a&&(r=a),r||_.each(p,function(e){r||(r=o.findKeyByID(e.toHex(),!1))})),r){if(l=this.cloneKey(this.convertToNativeKeys([r])[0]),this.decryptKeyHelper(c,l,s,r.getEmail()),l&&!c.hasErrors())try{h=n.decrypt(l)}catch(e){c.addExceptionMessage(e,OpenPgpResult.Enum.DecryptError),h=null}h&&!c.hasErrors()&&(this.verifyMessageHelper(c,i,h),c.result=h.getText())}else c.addError(OpenPgpResult.Enum.PrivateKeyNotFoundError);return c},OpenPgp.prototype.verify=function(e,t){var i=null,s=new OpenPgpResult;return i=this.pgp.cleartext.readArmored(e),i&&i.getText&&i.verify?(this.verifyMessageHelper(s,t,i),s.result=i.getText()):s.addError(OpenPgpResult.Enum.CanNotReadMessage),s},OpenPgp.prototype.encrypt=function(e,t){var i=new OpenPgpResult,s=this.findKeysByEmails(t,!0,i);if(!i.hasErrors())try{i.result=this.pgp.encryptMessage(this.convertToNativeKeys(s),e)}catch(e){i.addExceptionMessage(e,OpenPgpResult.Enum.EncryptError)}return i},OpenPgp.prototype.sign=function(e,t,i){var s=new OpenPgpResult,o=null,n=null,a=this.findKeysByEmails([t],!1,s);if(!s.hasErrors()&&(o=this.convertToNativeKeys(a)[0],n=this.cloneKey(o),this.decryptKeyHelper(s,n,i,t),n&&!s.hasErrors()))try{s.result=this.pgp.signClearMessage([n],e)}catch(e){s.addExceptionMessage(e,OpenPgpResult.Enum.SignError,t)}return s},OpenPgp.prototype.signAndEncrypt=function(e,t,i,s){var o=null,n=null,a=new OpenPgpResult,r=this.findKeysByEmails([t],!1,a),l=this.findKeysByEmails(i,!0,a);if(!a.hasErrors()&&(o=this.convertToNativeKeys(r)[0],n=this.cloneKey(o),this.decryptKeyHelper(a,n,s,t),n&&!a.hasErrors()))try{a.result=this.pgp.signAndEncryptMessage(this.convertToNativeKeys(l),n,e)}catch(e){a.addExceptionMessage(e,OpenPgpResult.Enum.SignAndEncryptError)}return a},OpenPgp.prototype.deleteKey=function(e){var t=new OpenPgpResult;if(e)try{this.pgpKeyring[e.isPrivate()?"privateKeys":"publicKeys"].removeForId(e.getFingerprint()),this.pgpKeyring.store()}catch(e){t.addExceptionMessage(e,OpenPgpResult.Enum.DeleteError)}else t.addError(e?OpenPgpResult.Enum.UnknownError:OpenPgpResult.Enum.InvalidArgumentError);return this.reloadKeysFromStorage(),t},OpenPgpKey.prototype.pgpKey=null,OpenPgpKey.prototype.emailParts=null,OpenPgpKey.prototype.user="",OpenPgpKey.prototype.getId=function(){return this.pgpKey.primaryKey.getKeyId().toHex().toLowerCase()},OpenPgpKey.prototype.getEmail=function(){return this.emailParts.email||this.user},OpenPgpKey.prototype.getUser=function(){return this.user},OpenPgpKey.prototype.getFingerprint=function(){return this.pgpKey.primaryKey.getFingerprint()},OpenPgpKey.prototype.getBitSize=function(){return this.pgpKey.primaryKey.getBitSize()},OpenPgpKey.prototype.getArmor=function(){return this.pgpKey.armor()},OpenPgpKey.prototype.isPrivate=function(){return!!this.pgpKey.isPrivate()},OpenPgpKey.prototype.isPublic=function(){return!this.isPrivate()},OpenPgpResult.Enum={UnknownError:0,UnknownNotice:1,InvalidArgumentError:2,GenerateKeyError:10,ImportKeyError:20,ImportNoKeysFoundError:21,PrivateKeyNotFoundError:30,PublicKeyNotFoundError:31,KeyIsNotDecodedError:32,SignError:40,VerifyError:41,EncryptError:42,DecryptError:43,SignAndEncryptError:44,VerifyAndDecryptError:45,CanNotReadMessage:50,CanNotReadKey:51,DeleteError:60,PublicKeyNotFoundNotice:70,PrivateKeyNotFoundNotice:71,VerifyErrorNotice:72,NoSignDataNotice:73},OpenPgpResult.prototype.result=!1,OpenPgpResult.prototype.errors=null,OpenPgpResult.prototype.notices=null,OpenPgpResult.prototype.addError=function(e,t){return this.result=!1,this.errors=this.errors||[],this.errors.push([e||OpenPgpResult.Enum.UnknownError,t||""]),this},OpenPgpResult.prototype.addNotice=function(e,t){return this.notices=this.notices||[],this.notices.push([e||OpenPgpResult.Enum.UnknownNotice,t||""]),this},OpenPgpResult.prototype.addExceptionMessage=function(e,t,i){return e&&(this.result=!1,this.exceptions=this.exceptions||[],this.exceptions.push(""+(e.name||"unknown")+": "+(e.message||""))),Utils.isUnd(t)||this.addError(t,i),this},OpenPgpResult.prototype.hasErrors=function(){return this.errors&&0<this.errors.length},OpenPgpResult.prototype.hasNotices=function(){return this.notices&&0<this.notices.length},ConfirmAnotherMessageComposedPopup.prototype.onShow=function(e){Utils.isFunc(e)&&(this.fConfirmCallback=e),this.shown=!0},ConfirmAnotherMessageComposedPopup.prototype.onHide=function(){this.shown=!1},ConfirmAnotherMessageComposedPopup.prototype.popupTemplate=function(){return"Popups_ConfirmAnotherMessageComposedPopupViewModel"},ConfirmAnotherMessageComposedPopup.prototype.onDiscardClick=function(){this.shown&&this.fConfirmCallback&&this.fConfirmCallback(Enums.AnotherMessageComposedAnswer.Discard),this.closeCommand()},ConfirmAnotherMessageComposedPopup.prototype.onSaveAsDraftClick=function(){this.shown&&this.fConfirmCallback&&this.fConfirmCallback(Enums.AnotherMessageComposedAnswer.SaveAsDraft),this.closeCommand()},ConfirmAnotherMessageComposedPopup.prototype.onCancelClick=function(){this.fConfirmCallback&&this.fConfirmCallback(Enums.AnotherMessageComposedAnswer.Cancel),this.closeCommand()},ConfirmAnotherMessageComposedPopup.prototype.onEnterHandler=function(){this.onSaveAsDraftClick()},ConfirmAnotherMessageComposedPopup.prototype.onEscHandler=function(){this.onCancelClick()},AlertPopup.prototype.onShow=function(e,t,i,s){this.alertDesc(e),this.closeCallback=t||null,this.title(i||""),this.okButtonText(s||Utils.i18n("MAIN/BUTTON_OK"))},AlertPopup.prototype.popupTemplate=function(){return"Popups_AlertPopupViewModel"},AlertPopup.prototype.onEnterHandler=function(){this.close()},AlertPopup.prototype.close=function(){Utils.isFunc(this.closeCallback)&&this.closeCallback(),this.closeCommand()},ConfirmPopup.prototype.onShow=function(e,t,i,s,o){this.confirmDesc(e),this.title(i||""),this.okButtonText(s||Utils.i18n("MAIN/BUTTON_OK")),this.cancelButtonText(o||Utils.i18n("MAIN/BUTTON_CANCEL")),Utils.isFunc(t)&&(this.fConfirmCallback=t),this.shown=!0},ConfirmPopup.prototype.onHide=function(){this.shown=!1},ConfirmPopup.prototype.popupTemplate=function(){return"Popups_ConfirmPopupViewModel"},ConfirmPopup.prototype.onEnterHandler=function(){this.yesClick()},ConfirmPopup.prototype.yesClick=function(){this.shown&&this.fConfirmCallback&&this.fConfirmCallback(!0),this.closeCommand()},ConfirmPopup.prototype.noClick=function(){this.fConfirmCallback&&this.fConfirmCallback(!1),this.closeCommand()},ConfirmPopup.prototype.onEscHandler=function(){this.noClick()},AccountCreatePopup.prototype.popupTemplate=function(){return"Popups_AccountCreatePopupViewModel"},AccountCreatePopup.prototype.init=function(){this.isFirstTitle(!0),this.friendlyName(""),this.email(""),this.incomingMailLogin(""),this.incomingLoginFocused(!1),this.incomingMailPassword(""),this.outgoingMailLogin(""),this.outgoingMailPassword(""),this.oOutgoing.focused(!1),this.clearServers()},AccountCreatePopup.prototype.clearServers=function(){this.oIncoming.clear(),this.oOutgoing.clear(),this.useSmtpAuthentication(!0)},AccountCreatePopup.prototype.onShow=function(e,t,i){switch(this.fCallback=i,this.init(),e){case Enums.AccountCreationPopupType.TwoSteps:this.isFirstStep(!0),this.emailFocus(!0);break;case Enums.AccountCreationPopupType.OneStep:case Enums.AccountCreationPopupType.ConnectToMail:this.isFirstStep(!1),this.email(t),this.incomingMailLogin(t),this.incomingPasswordFocus(!0)}this.isConnectToMailType(e===Enums.AccountCreationPopupType.ConnectToMail)},AccountCreatePopup.prototype.onFirstSaveClick=function(){if(this.isEmptyFirstFields())this.loading(!1);else{var e={Action:"DomainGetDataByEmail",Email:this.email()};this.loading(!0),App.Ajax.send(e,this.onDomainGetDataByEmailResponse,this)}},AccountCreatePopup.prototype.onSecondSaveClick=function(){if(this.isEmptySecondFields())this.loading(!1);else{var e=AppData.Accounts.getDefault(),t=this.isConnectToMailType()||!e.allowMail()&&e.email()===this.email(),i={Action:t?"AccountConfigureMail":"AccountCreate",AccountID:this.defaultAccountId(),FriendlyName:this.friendlyName(),Email:this.email(),IncomingMailLogin:this.incomingMailLogin(),IncomingMailPassword:this.incomingMailPassword(),IncomingMailServer:this.oIncoming.server(),IncomingMailPort:this.oIncoming.getIntPort(),IncomingMailSsl:this.oIncoming.getIntSsl(),OutgoingMailLogin:this.outgoingMailLogin(),OutgoingMailPassword:this.outgoingMailPassword(),OutgoingMailServer:this.oOutgoing.server(),OutgoingMailPort:this.oOutgoing.getIntPort(),OutgoingMailSsl:this.oOutgoing.getIntSsl(),OutgoingMailAuth:this.useSmtpAuthentication()?2:0};this.loading(!0),App.Ajax.send(i,this.onAccountCreateResponse,this)}},AccountCreatePopup.prototype.onSaveClick=function(){this.loading()||(this.isFirstStep()?this.onFirstSaveClick():this.onSecondSaveClick())},AccountCreatePopup.prototype.onCancelClick=function(){this.closeCommand(),this.init()},AccountCreatePopup.prototype.onDomainGetDataByEmailResponse=function(e,t){var i=e.Result;this.incomingMailLogin(this.email()),i?(this.oIncoming.set(i.IncomingMailServer,i.IncomingMailPort,!!i.IncomingMailSsl),this.oOutgoing.set(i.OutgoingMailServer,i.OutgoingMailPort,!!i.OutgoingMailSsl),this.onSecondSaveClick()):(this.loading(!1),this.isFirstStep(!1),this.isFirstTitle(!1),this.incomingLoginFocused(!0))},AccountCreatePopup.prototype.onAccountCreateResponse=function(e,t){if(this.loading(!1),e.Result){var i=Utils.pInt(e.Result.IdAccount),s=AppData.Accounts.getAccount(i)||new CAccountModel;s.init(i,t.Email,t.FriendlyName),s.updateExtended(t),s.setExtensions(e.Result.Extensions),"AccountConfigureMail"===t.Action?(s.allowMailAfterConfiguring(),AppData.Accounts.collection.valueHasMutated(),AppData.Accounts.checkIfMailAllowed(),AppData.Accounts.populateIdentities(),AppData.Accounts.currentId.valueHasMutated()):(AppData.Accounts.addAccount(s),AppData.Accounts.populateIdentities(),AppData.Accounts.changeEditedAccount(i)),this.fCallback&&this.fCallback(i),this.closeCommand()}else App.Api.showErrorByCode(e,Utils.i18n("WARNING/CREATING_ACCOUNT_ERROR"))},AccountCreatePopup.prototype.isEmptyFirstFields=function(){switch(""){case this.email():return this.emailFocus(!0),!0;case this.incomingMailPassword():return this.incomingMailFocus(!0),!0;default:return!1}},AccountCreatePopup.prototype.isEmptySecondFields=function(){switch(""){case this.email():return this.emailFocus(!0),!0;case this.incomingMailLogin():return this.incomingLoginFocused(!0),!0;case this.oIncoming.server():return this.oIncoming.focused(!0),!0;case this.oOutgoing.server():return this.oOutgoing.focused(!0),!0;default:return!1}},CreateIdentityPopup.prototype.popupTemplate=function(){return"Popups_AccountCreateIdentityPopupViewModel"},CreateIdentityPopup.prototype.onShow=function(e){var t=AppData.Accounts.getAccount(e),i=new CIdentityModel;i.accountId(e),i.email(t.email()),this.oIdentityPropertiesViewModel.populate(i),this.oIdentityPropertiesViewModel.friendlyNameHasFocus(!0)},CreateIdentityPopup.prototype.cancel=function(){this.closeCommand()},FetcherAddPopup.prototype.popupTemplate=function(){return"Popups_FetcherAddPopupViewModel"},FetcherAddPopup.prototype.onShow=function(){this.bShown=!0,this.populateOptions(),this.incomingMailLogin(""),this.incomingMailPassword(""),this.oIncoming.clear(),this.folder(""),this.leaveMessagesOnServer(!0)},FetcherAddPopup.prototype.populateOptions=function(){this.bShown&&this.options(App.MailCache.folderList().getOptions("",!0,!1,!1))},FetcherAddPopup.prototype.onHide=function(){this.bShown=!1},FetcherAddPopup.prototype.onSaveClick=function(){if(this.isEmptyRequiredFields())App.Api.showError(Utils.i18n("WARNING/FETCHER_CREATE_ERROR"));else{var e={Action:"AccountFetcherCreate",AccountID:AppData.Accounts.defaultId(),Folder:this.folder(),IncomingMailLogin:this.incomingMailLogin(),IncomingMailPassword:""===this.incomingMailPassword()?"******":this.incomingMailPassword(),IncomingMailServer:this.oIncoming.server(),IncomingMailPort:this.oIncoming.getIntPort(),IncomingMailSsl:this.oIncoming.getIntSsl(),LeaveMessagesOnServer:this.leaveMessagesOnServer()?1:0};this.loading(!0),App.Ajax.send(e,this.onAccountFetcherCreateResponse,this)}},FetcherAddPopup.prototype.onAccountFetcherCreateResponse=function(e,t){this.loading(!1),e.Result?(AppData.Accounts.populateFetchers(),this.closeCommand()):App.Api.showErrorByCode(e)},FetcherAddPopup.prototype.onCancelClick=function(){this.newFolderCreating()||this.closeCommand()},FetcherAddPopup.prototype.onEscHandler=function(){this.onCancelClick()},FetcherAddPopup.prototype.isEmptyRequiredFields=function(){switch(""){case this.oIncoming.server():return this.oIncoming.focused(!0),!0;case this.incomingMailLogin():return this.loginIsSelected(!0),!0;case this.incomingMailPassword():return this.passwordIsSelected(!0),!0;default:return!1}},FetcherAddPopup.prototype.onAddNewFolderClick=function(){this.newFolderCreating(!0),App.Screens.showPopup(FolderCreatePopup,[_.bind(this.chooseFolderInList,this)])},FetcherAddPopup.prototype.chooseFolderInList=function(e,t){var i=App.MailCache.folderList().sDelimiter,s=[];""!==e&&""!==t&&(this.options(App.MailCache.folderList().getOptions("",!0,!1,!1)),_.each(this.options(),_.bind(function(o){e===o.name&&(s=o.fullName.split(i),s.pop(),t===s.join(i)&&this.folder(o.fullName))},this))),this.newFolderCreating(!1)},SystemFoldersPopup.prototype.onShow=function(){var e=App.MailCache.editedFolderList();this.options(e.getOptions(Utils.i18n("SETTINGS/ACCOUNT_FOLDERS_NO_USAGE_ASSIGNED"),!1,!1,!1)),this.sentFolderFullName(e.sentFolderFullName()),this.draftsFolderFullName(e.draftsFolderFullName()),this.allowSpamFolderEditing()&&this.spamFolderFullName(e.spamFolderFullName()),this.trashFolderFullName(e.trashFolderFullName())},SystemFoldersPopup.prototype.popupTemplate=function(){return"Popups_FolderSystemPopupViewModel"},SystemFoldersPopup.prototype.onResponseFoldersSetupSystem=function(e,t){e.Result===!1&&(App.Api.showErrorByCode(e,Utils.i18n("ACCOUNT_FOLDERS_ERROR_SETUP_SPECIAL_FOLDERS")),App.MailCache.getFolderList(AppData.Accounts.editedId()))},SystemFoldersPopup.prototype.onOKClick=function(){var e=App.MailCache.editedFolderList(),t=!1,i=null;this.sentFolderFullName()!==e.sentFolderFullName()&&(e.sentFolderFullName(this.sentFolderFullName()),t=!0),this.draftsFolderFullName()!==e.draftsFolderFullName()&&(e.draftsFolderFullName(this.draftsFolderFullName()),t=!0),this.allowSpamFolderEditing()&&this.spamFolderFullName()!==e.spamFolderFullName()&&(e.spamFolderFullName(this.spamFolderFullName()),t=!0),this.trashFolderFullName()!==e.trashFolderFullName()&&(e.trashFolderFullName(this.trashFolderFullName()),t=!0),t&&(i={Action:"FoldersSetupSystem",AccountID:AppData.Accounts.editedId(),Sent:e.sentFolderFullName(),Drafts:e.draftsFolderFullName(),Trash:e.trashFolderFullName(),Spam:e.spamFolderFullName()},App.Ajax.send(i,this.onResponseFoldersSetupSystem,this)),this.closeCommand()},SystemFoldersPopup.prototype.onCancelClick=function(){this.closeCommand()},SystemFoldersPopup.prototype.onEscHandler=function(){this.onCancelClick()},FolderCreatePopup.prototype.popupTemplate=function(){return"Popups_FolderCreatePopupViewModel"},FolderCreatePopup.prototype.onShow=function(e){this.options(App.MailCache.editedFolderList().getOptions(Utils.i18n("SETTINGS/ACCOUNT_FOLDERS_NO_PARENT"),!0,!1,!0)),this.fCallback=e,this.folderName(""),this.folderNameFocus(!0)},FolderCreatePopup.prototype.onResponseFolderCreate=function(e,t){e.Result?App.MailCache.getFolderList(AppData.Accounts.editedId()):(this.loading(!1),App.Api.showErrorByCode(e,Utils.i18n("SETTINGS/ACCOUNT_FOLDERS_CANT_CREATE_FOLDER")))},FolderCreatePopup.prototype.onOKClick=function(){var e=""===this.parentFolder()?App.MailCache.editedFolderList().sNamespaceFolder:this.parentFolder(),t={Action:"FolderCreate",AccountID:AppData.Accounts.editedId(),FolderNameInUtf8:this.folderName(),FolderParentFullNameRaw:e,Delimiter:App.MailCache.editedFolderList().sDelimiter};this.folderNameFocus(!1),this.loading(!0),App.Ajax.send(t,this.onResponseFolderCreate,this)},FolderCreatePopup.prototype.onCancelClick=function(){this.loading()||(this.fCallback&&this.fCallback("",""),this.closeCommand())},FolderCreatePopup.prototype.onEscHandler=function(){this.onCancelClick()},ChangePasswordPopup.prototype.onShow=function(e,t,i){this.isHelpdesk(e),this.hasOldPassword(t),this.fOnPasswordChangedCallback=i,this.currentPassword(""),this.newPassword(""),this.confirmPassword("")},ChangePasswordPopup.prototype.popupTemplate=function(){return"Popups_ChangePasswordPopupViewModel"},ChangePasswordPopup.prototype.onUpdatePasswordResponse=function(e,t){e.Result===!1?App.Api.showErrorByCode(e,Utils.i18n("SETTINGS/ACCOUNT_PROPERTIES_NEW_PASSWORD_UPDATE_ERROR")):(this.hasOldPassword()?App.Api.showReport(Utils.i18n("SETTINGS/ACCOUNT_PROPERTIES_CHANGE_PASSWORD_SUCCESS")):App.Api.showReport(Utils.i18n("SETTINGS/ACCOUNT_PROPERTIES_SET_PASSWORD_SUCCESS")),this.closeCommand(),"function"==typeof this.fOnPasswordChangedCallback&&this.fOnPasswordChangedCallback(),App.sResetPassHash="")},ChangePasswordPopup.prototype.onOKClick=function(){var e=null;this.confirmPassword()!==this.newPassword()?App.Api.showError(Utils.i18n("WARNING/PASSWORDS_DO_NOT_MATCH")):this.newPassword().length<AppData.App.PasswordMinLength?App.Api.showError(Utils.i18n("WARNING/PASSWORDS_MIN_LENGTH_ERROR").replace("%N%",AppData.App.PasswordMinLength)):!AppData.App.PasswordMustBeComplex||this.newPassword().match(/([0-9])/)&&this.newPassword().match(/([!,%,&,@,#,$,^,*,?,_,~])/)?this.isHelpdesk()?(e={Action:"HelpdeskUserPasswordUpdate",CurrentPassword:this.currentPassword(),NewPassword:this.newPassword()},App.Ajax.sendExt(e,this.onUpdatePasswordResponse,this)):(e={Action:"AccountUpdatePassword",AccountID:AppData.Accounts.editedId(),CurrentIncomingMailPassword:this.currentPassword(),NewIncomingMailPassword:this.newPassword(),Hash:App.sResetPassHash},App.Ajax.send(e,this.onUpdatePasswordResponse,this)):App.Api.showError(Utils.i18n("WARNING/PASSWORD_MUST_BE_COMPLEX"))},ChangePasswordPopup.prototype.onCancelClick=function(){this.closeCommand()},FileStorageFolderCreatePopup.prototype.onShow=function(e){this.folderName(""),this.folderName.focus(!0),this.folderName.error(""),Utils.isFunc(e)&&(this.fCallback=e)},FileStorageFolderCreatePopup.prototype.popupTemplate=function(){return"Popups_FileStorage_FolderCreatePopupViewModel"},FileStorageFolderCreatePopup.prototype.onOKClick=function(){if(this.folderName.error(""),this.fCallback){var e=this.fCallback(this.folderName());e?this.folderName.error(""+e):this.closeCommand()}else this.closeCommand()},FileStorageFolderCreatePopup.prototype.onCancelClick=function(){this.closeCommand()},FileStorageLinkCreatePopup.prototype.onShow=function(e){this.link(""),this.linkFocus(!0),Utils.isFunc(e)&&(this.fCallback=e),this.checkTimer=setTimeout(_.bind(this.checkUrl,this),2e3)},FileStorageLinkCreatePopup.prototype.popupTemplate=function(){return"Popups_FileStorage_LinkCreatePopupViewModel"},FileStorageLinkCreatePopup.prototype.checkUrl=function(){clearTimeout(this.checkTimer),this.link()!==this.linkPrev()&&(this.linkPrev(this.link()),App.Ajax.send({Action:"FilesCheckUrl",Url:this.link()},this.onFilesCheckUrlResponse,this)),this.checkTimer=setTimeout(_.bind(this.checkUrl,this),1e3)},FileStorageLinkCreatePopup.prototype.onFilesCheckUrlResponse=function(e){var t=new CCommonFileModel;e.Result?(t.isPopupItem(!0),t.linkUrl(this.link()),t.fileName(e.Result.Name),t.size(e.Result.Size),t.linkType(e.Result.LinkType?e.Result.LinkType:Enums.FileStorageLinkType.Unknown),t.allowDownload(!1),e.Result.Thumb&&(t.thumb(!0),t.thumbnailSrc(e.Result.Thumb)),this.fileItem(t),this.urlChecked(!0)):this.urlChecked(!1)},FileStorageLinkCreatePopup.prototype.executeSave=function(){this.fCallback&&(this.fCallback(this.fileItem()),this.link(""),this.linkPrev(""),this.urlChecked(!1)),clearTimeout(this.checkTimer),this.closeCommand()},FileStorageLinkCreatePopup.prototype.onCancelClick=function(){this.link(""),this.linkPrev(""),this.urlChecked(!1),clearTimeout(this.checkTimer),this.closeCommand()},FileStorageLinkCreatePopup.prototype.onEscHandler=function(){this.onCancelClick()},FileStorageRenamePopup.prototype.onShow=function(e,t){this.item=e,this.item.nameForEdit(this.item.fileName()),this.name(this.item.nameForEdit()),this.name.focus(!0),this.name.error(""),Utils.isFunc(t)&&(this.fCallback=t)},FileStorageRenamePopup.prototype.popupTemplate=function(){return"Popups_FileStorage_RenamePopupViewModel"},FileStorageRenamePopup.prototype.onOKClick=function(){if(this.name.error(""),this.fCallback){this.item.nameForEdit(this.name());var e=this.fCallback(this.item);e?this.name.error(""+e):this.closeCommand()}else this.closeCommand()},FileStorageRenamePopup.prototype.onCancelClick=function(){this.closeCommand()},FileStorageSharePopup.prototype.onShow=function(e){this.item=e,this.pub(""),App.Ajax.send({Action:"FilesCreatePublicLink",Account:AppData.Accounts.defaultId(),Type:e.storageType(),Path:e.path(),Name:e.fileName(),Size:e.size(),IsFolder:e.isFolder()?"1":"0"},this.onFilesCreatePublicLinkResponse,this)},FileStorageSharePopup.prototype.onFilesCreatePublicLinkResponse=function(e,t){e.Result&&(this.pub(e.Result),this.pubFocus(!0),this.item.shared(!0))},FileStorageSharePopup.prototype.popupTemplate=function(){return"Popups_FileStorage_SharePopupViewModel"},FileStorageSharePopup.prototype.onOKClick=function(){this.closeCommand()},FileStorageSharePopup.prototype.onFilesDeletePublicLinkResponse=function(e,t){this.closeCommand()},FileStorageSharePopup.prototype.onCancelSharingClick=function(){this.item&&(App.Ajax.send({Action:"FilesPublicLinkDelete",Account:AppData.Accounts.defaultId(),Type:this.item.storageType(),Path:this.item.path(),Name:this.item.fileName()},this.onFilesDeletePublicLinkResponse,this),this.item.shared(!1))},FileStoragePopup.prototype.onShow=function(e){Utils.isFunc(e)&&(this.fCallback=e),this.fileStorageViewModel.onShow()},FileStoragePopup.prototype.onApplyBindings=function(e){this.fileStorageViewModel.onApplyBindings(e)},FileStoragePopup.prototype.popupTemplate=function(){return"Popups_FileStorage_FileStoragePopupViewModel"},FileStoragePopup.prototype.onSelectClick=function(){var e=this.fileStorageViewModel.selector.listCheckedAndSelected(),t=_.filter(e,function(e){return!e.isFolder()},this);this.fCallback&&this.fCallback(t),this.closeCommand()},FileStoragePopup.prototype.onCancelClick=function(){this.closeCommand()},CalendarPopup.prototype.clearFields=function(){this.calendarName(""),this.calendarDescription(""),this.selectedColor(this.colors[0]),this.calendarId(null)},CalendarPopup.prototype.onShow=function(e,t,i){this.clearFields(),Utils.isFunc(e)&&(this.fCallback=e),Utils.isUnd(t)||(this.colors(t),this.selectedColor(t[0])),Utils.isUnd(i)?this.popupTitle(Utils.i18n("CALENDAR/TITLE_CREATE_CALENDAR")):(this.popupTitle(i.name()?Utils.i18n("CALENDAR/TITLE_EDIT_CALENDAR"):Utils.i18n("CALENDAR/TITLE_CREATE_CALENDAR")),this.calendarName(i.name?i.name():""),this.calendarDescription(i.description?i.description():""),this.selectedColor(i.color?i.color():""),this.calendarId(i.id?i.id:null)),$(document).on("keyup.calendar_create",_.bind(function(e){e.keyCode===Enums.Key.Enter&&this.onSaveClick()},this))},CalendarPopup.prototype.onHide=function(e,t,i){$(document).off("keyup.calendar_create")},CalendarPopup.prototype.popupTemplate=function(){return"Popups_Calendar_CalendarPopupViewModel"},CalendarPopup.prototype.onSaveClick=function(){""===this.calendarName()?App.Screens.showPopup(AlertPopup,[Utils.i18n("CALENDAR/WARNING_BLANK_CALENDAR_NAME")]):(this.fCallback&&(this.fCallback(this.calendarName(),this.calendarDescription(),this.selectedColor(),this.calendarId()),this.clearFields()),this.closeCommand())},CalendarPopup.prototype.onCancelClick=function(){this.closeCommand()},CalendarImportPopup.prototype.onShow=function(e,t){Utils.isFunc(e)&&(this.fCallback=e),Utils.isUnd(t)||(this.color(t.color?t.color():""),this.calendarId(t.id?t.id:""))},CalendarImportPopup.prototype.popupTemplate=function(){return"Popups_Calendar_ImportPopupViewModel"},CalendarImportPopup.prototype.onApplyBindings=function(e){var t=this;this.oJua=new Jua({action:"?/Upload/Calendars/",name:"jua-uploader",queueSize:1,clickElement:$("#jue_import_button",e),hiddenElementsPosition:Utils.isRTL()?"right":"left",disableAjaxUpload:!1,disableDragAndDrop:!0,disableMultiple:!0,hidden:{Token:function(){return AppData.Token},AccountID:function(){return AppData.Accounts.currentId()},AdditionalData:function(){return JSON.stringify({CalendarID:t.calendarId()})}}}),this.oJua.on("onStart",_.bind(this.onFileUploadStart,this)).on("onComplete",_.bind(this.onFileUploadComplete,this)),this.allowDragNDrop(this.oJua.isDragAndDropSupported())},CalendarImportPopup.prototype.onFileUploadStart=function(){this.importing(!0)},CalendarImportPopup.prototype.onFileUploadComplete=function(e,t,i){var s=!t||!i||i.Error||i.Result.Error||!1;this.importing(!1),s?i&&i.ErrorCode&&i.ErrorCode===Enums.Errors.IncorrectFileExtension?App.Api.showError(Utils.i18n("CALENDAR/ERROR_INCORRECT_FILE_EXTENSION")):App.Api.showError(Utils.i18n("WARNING/ERROR_UPLOAD_FILE")):(this.fCallback(),this.closeCommand())},CalendarImportPopup.prototype.onCancelClick=function(){this.closeCommand()},CalendarSharePopup.prototype.onShow=function(e,t){Utils.isFunc(e)&&(this.fCallback=e),Utils.isUnd(t)||(this.selectedColor(t.color()),this.calendarId(t.id),this.calendarUrl(t.davUrl()+t.url()),this.exportUrl(t.exportUrl()),this.icsLink(t.davUrl()+t.url()+"?export"),this.isPublic(t.isPublic()),this.owner(t.owner()),this.populateShares(t.shares()),this.sharedToAll(t.isSharedToAll()),this.sharedToAllAccess(t.sharedToAllAccess))},CalendarSharePopup.prototype.popupTemplate=function(){return"Popups_Calendar_SharePopupViewModel"},CalendarSharePopup.prototype.onSaveClick=function(){this.fCallback&&this.fCallback(this.calendarId(),this.isPublic(),this.getShares(),this.sharedToAll(),this.sharedToAllAccess()),this.closePopup()},CalendarSharePopup.prototype.onCancelClick=function(){this.closePopup()},CalendarSharePopup.prototype.onEscHandler=function(){this.onCancelClick()},CalendarSharePopup.prototype.closePopup=function(){this.cleanAll(),this.closeCommand()},CalendarSharePopup.prototype.cleanAll=function(){this.newShare(""),this.newShareAccess(Enums.CalendarAccess.Read),this.shareToAllAccess=ko.observable(Enums.CalendarAccess.Read),this.canAdd(!1)},CalendarSharePopup.prototype.autocompleteCallback=function(e,t){var i={Action:"ContactSuggestions",Search:e,GlobalOnly:"1"};App.Ajax.send(i,function(e){var i=[];e&&e.Result&&e.Result&&e.Result.List&&(i=_.map(e.Result.List,function(e){return e&&e.Email&&e.Email!==this.owner()?e.Name&&0<Utils.trim(e.Name).length?e.ForSharedToAll?{value:e.Name,name:e.Name,email:e.Email,frequency:e.Frequency}:{value:'"'+e.Name+'" <'+e.Email+">",name:e.Name,email:e.Email,frequency:e.Frequency}:{value:e.Email,name:"",email:e.Email,frequency:e.Frequency}:null},this),i=_.sortBy(_.compact(i),function(e){return e.frequency}).reverse()),t(i)},this)},CalendarSharePopup.prototype.itsMe=function(e){return e===this.defaultAccount.email()},CalendarSharePopup.prototype.initInputosaurus=function(e,t,i){e()&&$(e()).length>0&&$(e()).inputosaurus({width:"auto",parseOnBlur:!0,autoCompleteSource:_.bind(function(e,t){this.autocompleteCallback(e.term,t)},this),change:_.bind(function(e){i(!0),this.setRecipient(t,e.target.value),i(!1)},this),copy:_.bind(function(e){this.inputosaurusBuffer=e},this),paste:_.bind(function(){var e=this.inputosaurusBuffer||"";return this.inputosaurusBuffer="",e},this),mobileDevice:bMobileDevice})},CalendarSharePopup.prototype.setRecipient=function(e,t){e()===t?e.valueHasMutated():e(t)},CalendarSharePopup.prototype.getShares=function(){return $.merge(_.map(Utils.Address.getArrayRecipients(this.guests(),!1),function(e){return{name:e.name,email:e.email,access:Enums.CalendarAccess.Read}}),_.map(Utils.Address.getArrayRecipients(this.owners(),!1),function(e){return{name:e.name,email:e.email,access:Enums.CalendarAccess.Write}}))},CalendarSharePopup.prototype.populateShares=function(e){var t="",i="";_.each(e,function(e){e.access===Enums.CalendarAccess.Read?t=""!==e.name&&e.name!==e.email?t+'"'+e.name+'" <'+e.email+">,":t+e.email+", ":e.access===Enums.CalendarAccess.Write&&(i=""!==e.name&&e.name!==e.email?i+'"'+e.name+'" <'+e.email+">,":i+e.email+", ")},this),this.setRecipient(this.guests,t),this.setRecipient(this.owners,i)},CalendarGetLinkPopup.prototype.onShow=function(e,t){Utils.isFunc(e)&&(this.fCallback=e),Utils.isUnd(t)||(this.selectedColor(t.color()),this.calendarId(t.id),this.calendarUrl(t.davUrl()+t.url()),this.exportUrl(t.exportUrl()),this.icsLink(t.davUrl()+t.url()+"?export"),this.isPublic(t.isPublic()),this.pubUrl(t.pubUrl()),this.exportUrl(t.exportUrl()))},CalendarGetLinkPopup.prototype.popupTemplate=function(){return"Popups_Calendar_GetLinkPopupViewModel"},CalendarGetLinkPopup.prototype.onCancelClick=function(){this.fCallback&&this.fCallback(this.calendarId(),this.isPublic()),this.closeCommand()},CalendarGetLinkPopup.prototype.onEscHandler=function(){
this.onCancelClick()},CalendarEventPopup.prototype.initUploader=function(){this.bCalendarAttachFileToEventEnabled&&this.eventUploaderButton()&&null===this.oJua&&(this.oJua=new Jua({action:"?/Upload/EventAttachment/",name:"jua-uploader",queueSize:1,clickElement:this.eventUploaderButton(),hiddenElementsPosition:Utils.isRTL()?"right":"left",disableAjaxUpload:!1,hidden:{Token:function(){return AppData.Token},AccountID:function(){return AppData.Accounts.currentId()}}}),this.oJua.on("onSelect",_.bind(this.onFileUploadSelect,this)).on("onComplete",_.bind(this.onFileUploadComplete,this)))},CalendarEventPopup.prototype.onFileUploadSelect=function(e,t){return!(!this.bCalendarAttachFileToEventEnabled||App.Api.showErrorIfAttachmentSizeLimit(t.FileName,Utils.pInt(t.Size)))&&(this.attachName(t.FileName),this.attachTempName(""),this.attachDownloadLink(""),this.modified=!0,!0)},CalendarEventPopup.prototype.onFileUploadComplete=function(e,t,i){if(this.bCalendarAttachFileToEventEnabled){var s=i.Result&&i.Result.Attachment;s&&s.Name===this.attachName()&&(this.attachTempName(s.TempName),this.attachDownloadLink(Utils.getEventDownloadLinkByHash(AppData.Accounts?AppData.Accounts.currentId():null,s.Hash)),this.attachUploaded(!0))}},CalendarEventPopup.prototype.removeAttach=function(){this.bCalendarAttachFileToEventEnabled&&(this.attachName(""),this.attachTempName(""),this.attachDownloadLink(""),this.attachUploaded(!1),this.modified=!0)},CalendarEventPopup.prototype.downloadAttachment=function(){this.attachDownloadLink().length>0&&"#"!==this.attachDownloadLink()&&App.Api.downloadByUrl(this.attachDownloadLink())},CalendarEventPopup.prototype.createDatePickerObject=function(e,t){$(e).datepicker({showOtherMonths:!0,selectOtherMonths:!0,monthNames:Utils.getMonthNamesArray(),dayNamesMin:Utils.i18n("DATETIME/DAY_NAMES_MIN").split(" "),nextText:"",prevText:"",firstDay:AppData.User.CalendarWeekStartsOn,showOn:"both",buttonText:"",buttonImage:"skins/Default/images/calendar-icon.png",buttonImageOnly:!0,dateFormat:this.dateFormatDatePicker,onSelect:t}),$(e).mousedown(function(){$("#ui-datepicker-div").toggle()})},CalendarEventPopup.prototype.initializeDatePickers=function(){this.createDatePickerObject(this.startDom(),this.selectStartDate.bind(this)),this.createDatePickerObject(this.endDom(),this.selectEndDate.bind(this)),this.createDatePickerObject(this.repeatEndDom(),Utils.emptyFunction()),this.startDom().datepicker("option","dateFormat",this.dateFormatDatePicker),this.endDom().datepicker("option","dateFormat",this.dateFormatDatePicker),this.repeatEndDom().datepicker("option","dateFormat",this.dateFormatDatePicker)},CalendarEventPopup.prototype.onShow=function(e){var t=this.defaultAccount,i=t?t.email():"",s=t?t.friendlyName():"",o=e.End?e.End.clone():null,n=e.Start.clone(),a="",r=null,l="";this.bCalendarAttachFileToEventEnabled&&(_.isArray(e.Attachments)&&e.Attachments.length>0?(this.attachName(e.Attachments[0].filename),this.attachTempName(""),this.attachDownloadLink(Utils.getEventDownloadLinkByHash(AppData.Accounts?AppData.Accounts.currentId():null,e.Attachments[0].hash)),this.attachUploaded(!0)):(this.attachName(""),this.attachTempName(""),this.attachDownloadLink(""),this.attachUploaded(!1))),this.differenceInMinutes=null,this.FCMoment=e.FCMoment,this.calendarId(e.SelectedCalendar),this.calendars=e.Calendars,r=this.calendars.getCalendarById(this.calendarId()),r&&(l=r.owner()),this.callbackSave=e.CallbackSave,this.callbackDelete=e.CallbackDelete,this.callbackAttendeeActionDecline=e.CallbackAttendeeActionDecline,this.timeFormatMoment=e.TimeFormat,this.dateFormatMoment=Utils.getDateFormatForMoment(e.DateFormat),this.dateFormatDatePicker=Utils.getDateFormatForDatePicker(e.DateFormat),this.ampmTimeFormat(AppData.User.defaultTimeFormat()!==Enums.TimeFormat.F24),this.initializeDatePickers(),this.allDay(e.AllDay),this.setStartDate(n,!0),this.startTime(n.format(this.timeFormatMoment)),o&&this.allDay()&&o.subtract(1,"days"),o||(o=n),this.setEndDate(o,!0),this.endTime(o.format(this.timeFormatMoment)),this.calendars&&this.calendarsList(_.filter(this.calendars.collection(),function(e){return e.isEditable()})),this.selectedCalendarId(e.SelectedCalendar),this.selectedCalendarId.valueHasMutated(),this.changeCalendarColor(this.selectedCalendarId()),this.id(e.ID||null),this.uid(e.Uid||null),this.recurrenceId(e.RecurrenceId||null),this.subject(e.Subject||""),this.location(e.Location||""),this.description(e.Description||""),this.allEvents(e.AllEvents||Enums.CalendarEditRecurrenceEvent.AllEvents),this.populateAlarms(e.Alarms),this.appointment(e.Appointment),this.attendees(e.Attendees||[]),AppData.Accounts&&(a=AppData.Accounts.getAttendee(_.map(this.attendees(),function(e){return e.email},this))),this.isMyEvent(i===e.Owner&&a!==i||i===l&&a!==i),this.editableSwitch(this.selectedCalendarIsShared(),this.selectedCalendarIsEditable(),this.isMyEvent()),this.setCurrentAttenderStatus(a,e.Attendees||[]),this.owner(e.Owner||i),this.ownerName(e.OwnerName||(this.isMyEvent()&&this.owner()===t.email()?s:"")),this.guestAutocomplete(""),this.excluded(e.Excluded||!1),this.repeatRuleParse(e.RRule||null),null===this.id()&&this.subjectFocus(!0),this.autosizeTrigger.notifySubscribers(!0),this.modified=!1,this.isAppointmentButtonsVisible(this.appointment()&&this.selectedCalendarIsEditable()&&_.find(this.attendees(),function(e){return e.email===i}))},CalendarEventPopup.prototype.popupTemplate=function(){return"Popups_Calendar_EventPopupViewModel"},CalendarEventPopup.prototype.changeCalendarColor=function(e){if(Utils.isFunc(this.calendars.getCalendarById)){var t=this.calendars.getCalendarById(e);t&&(this.calendarColor(""),this.calendarColor(t.color()))}},CalendarEventPopup.prototype.onSaveClick=function(){if(""===this.subject())App.Screens.showPopup(AlertPopup,[Utils.i18n("CALENDAR/WARNING_EVENT_BLANK_SUBJECT"),_.bind(function(){this.subjectFocus(!0)},this)]);else{if(this.callbackSave){var e=parseInt(this.repeatPeriod()),t="",i=null,s=0,o=moment(this.getDateTime(this.startDom(),this.startTime())),n=moment(this.getDateTime(this.endDom(),this.endTime())),a={calendarId:this.calendarId(),newCalendarId:this.selectedCalendarId(),id:this.id(),uid:this.uid(),recurrenceId:this.recurrenceId(),allEvents:this.allEvents(),subject:this.subject(),title:Utils.getTitleForEvent(this.subject()),start:o,allDay:this.allDay(),location:this.location(),description:this.description(),alarms:this.getAlarmsArray(this.displayedAlarms()),attendees:this.attendees(),owner:this.owner(),modified:this.modified},r=parseInt(this.always()),l=null;this.bCalendarAttachFileToEventEnabled&&this.attachName()&&(l=[],this.attachTempName()?l.push({Name:this.attachName(),TempName:this.attachTempName()}):l.push({Name:this.attachName()})),a.attachments=l,this.allDay()&&n.add(1,"days"),a.end=n,e&&(t=this.repeatEndDom().datepicker("getDate"),i=t?moment(t).unix():null,s=this.repeatInterval(),e===Enums.CalendarRepeatPeriod.Daily&&r===Enums.CalendarAlways.Disable?a.rrule={byDays:[],count:null,end:2,interval:1,period:e,until:i,weekNum:null}:e===Enums.CalendarRepeatPeriod.Weekly&&r===Enums.CalendarAlways.Disable?(this.setDayOfWeek(),a.rrule={byDays:this.getDays(),count:null,end:2,interval:s,period:e,until:i,weekNum:null}):e===Enums.CalendarRepeatPeriod.Monthly?a.rrule={byDays:[],count:null,end:0,interval:1,period:e,until:null,weekNum:null}:e===Enums.CalendarRepeatPeriod.Yearly?a.rrule={byDays:[],count:null,end:0,interval:1,period:e,until:null,weekNum:null}:e===Enums.CalendarRepeatPeriod.Daily&&r===Enums.CalendarAlways.Enable?a.rrule={byDays:[],count:null,end:3,interval:1,period:e,until:i,weekNum:null}:e===Enums.CalendarRepeatPeriod.Weekly&&r===Enums.CalendarAlways.Enable&&(this.setDayOfWeek(),a.rrule={byDays:this.getDays(),count:null,end:3,interval:s,period:e,until:i,weekNum:null})),this.callbackSave(a)}this.closePopup()}},CalendarEventPopup.prototype.onEscHandler=function(){this.dateEdit()?this.dateEdit(!1):this.closePopup()},CalendarEventPopup.prototype.closePopup=function(){this.hideAll(),this.cleanAll(),this.closeCommand()},CalendarEventPopup.prototype.hideAll=function(){this.dateEdit(!1),this.repeatEdit(!1),this.guestsEdit(!1)},CalendarEventPopup.prototype.cleanAll=function(){this.subject(""),this.description(""),this.location(""),this.isRepeat(!1),this.allDay(!1),this.repeatPeriod(Enums.CalendarRepeatPeriod.None),this.repeatInterval(1),this.repeatCount(null),this.repeatWeekNum(null),this.startDate(""),this.startTime(""),this.endDate(""),this.endTime(""),this.repeatEndDate(""),this.displayedAlarms([]),this.weekMO(!1),this.weekTU(!1),this.weekWE(!1),this.weekTH(!1),this.weekFR(!1),this.weekSA(!1),this.weekSU(!1),this.attendees([]),this.always(1),this.selectedCalendarId(""),this.attendees([])},CalendarEventPopup.prototype.onDeleteClick=function(){if(this.callbackDelete){var e={calendarId:this.selectedCalendarId(),id:this.id(),uid:this.uid(),recurrenceId:this.recurrenceId(),allEvents:this.allEvents(),subject:this.subject(),title:Utils.getTitleForEvent(this.subject()),start:moment(this.getDateTime(this.startDom(),this.startTime())),end:moment(this.getDateTime(this.endDom(),this.endTime())),allDay:this.allDay(),location:this.location(),description:this.description()};this.callbackDelete(e)}this.closePopup()},CalendarEventPopup.prototype.showDates=function(e,t){t.stopPropagation(),this.dateEdit(!this.dateEdit())},CalendarEventPopup.prototype.showGuests=function(){if(this.attendees().length>0){var e=Utils.i18n("CALENDAR/CONFIRM_CLOSE_ATTENDEERS"),t=_.bind(function(e){e&&(this.guestsEdit(!1),this.guestEmailFocus(!1),this.attendees([]))},this);App.Screens.showPopup(ConfirmPopup,[e,t])}else this.guestsEdit(!this.guestsEdit()),this.guestEmailFocus(!this.guestEmailFocus())},CalendarEventPopup.prototype.onAddGuestClick=function(){var e=this.guestAutocompleteItem(),t=this.guestAutocomplete(),i=e||{name:"",email:t},s=_.any(this.attendees(),function(e){return e.email===i.email});""===i.email?App.Api.showError(Utils.i18n("CALENDAR/EVENT_ERROR_ENTER_EMAIL")):i.email===this.owner()?this.recivedAnim(!0):s?this.recivedAnim(!0):this.attendees.push({status:0,name:i.name,email:i.email}),this.whomAnimate(i.email),this.guestAutocomplete(""),this.guestEmailFocus(!0)},CalendarEventPopup.prototype.populateAlarms=function(e){e?(this.alarmOptions(this.getDisplayedAlarms(_.union(this.defaultAlarms(),e))),this.displayedAlarms(this.getDisplayedAlarms(e))):this.alarmOptions(this.getDisplayedAlarms(this.defaultAlarms()))},CalendarEventPopup.prototype.getDisplayedAlarms=function(e){var t,i,s=[];return e&&_.each(e,function(e,o){t=this["alarm"+e]=ko.observable(e),t.subscribe(function(){this.disableAlarms(),this.modified=!0},this),i=e>0&&e<60?Utils.i18n("CALENDAR/ALARM_MINUTES_PLURAL",{COUNT:e},null,e):e>=60&&e<1440?Utils.i18n("CALENDAR/ALARM_HOURS_PLURAL",{COUNT:e/60},null,e/60):e>=1440&&e<10080?Utils.i18n("CALENDAR/ALARM_DAYS_PLURAL",{COUNT:e/1440},null,e/1440):Utils.i18n("CALENDAR/ALARM_WEEKS_PLURAL",{COUNT:e/10080},null,e/10080),s.push({value:e,alarm:t,text:i,isDisabled:!1})},this),_.sortBy(s,function(e){return e.value})},CalendarEventPopup.prototype.getDisplayedPeriods=function(){return[{label:Utils.i18n("CALENDAR/EVENT_REPEAT_NEVER"),value:0},{label:Utils.i18n("CALENDAR/EVENT_REPEAT_DAILY"),value:1},{label:Utils.i18n("CALENDAR/EVENT_REPEAT_WEEKLY"),value:2},{label:Utils.i18n("CALENDAR/EVENT_REPEAT_MONTHLY"),value:3},{label:Utils.i18n("CALENDAR/EVENT_REPEAT_YEARLY"),value:4}]},CalendarEventPopup.prototype.getDisplayedIntervals=function(){for(var e=1,t=[];e<=30;e++)t.push({label:e+Utils.i18n("th"),value:e});return t},CalendarEventPopup.prototype.getAlarmsArray=function(e){var t=[];return _.each(e,function(e,i){t.push(e.alarm())},this),_.sortBy(t,function(e){return-e})},CalendarEventPopup.prototype.addFirstAlarm=function(){if(this.displayedAlarms().length){var e=Utils.i18n("CALENDAR/CONFIRM_CLOSE_ALARMS"),t=_.bind(function(e){e&&this.displayedAlarms.removeAll()},this);App.Screens.showPopup(ConfirmPopup,[e,t])}else this.displayedAlarms(this.getDisplayedAlarms([this.alarmOptions()[0].value]))},CalendarEventPopup.prototype.addAlarm=function(){var e,t,i=0;t=_.sortBy(this.displayedAlarms(),function(e){return e.alarm()}),_.each(t,function(e){var t=e.alarm();5!==t&&i<=5?i=5:10!==t&&i<=10?i=10:15!==t&&i<=15?i=15:30!==t&&i<=30?i=30:1440!==t&&i<=1440&&(i=1440)}),e=this.getDisplayedAlarms([i])[0],this["alarm"+i]=ko.observable(i),this.displayedAlarms.push(e)},CalendarEventPopup.prototype.removeAlarm=function(e){this.displayedAlarms.remove(e)},CalendarEventPopup.prototype.removeGuest=function(e){this.attendees.remove(e)},CalendarEventPopup.prototype.disableAlarms=function(){_.each(this.alarmOptions(),function(e,t){e.isDisabled=_.any(this.displayedAlarms(),function(t){return t.alarm()===e.value})},this),this.alarmOptions.valueHasMutated()},CalendarEventPopup.prototype.autocompleteCallback=function(e,t){var i={Action:"ContactSuggestions",Search:e,GlobalOnly:"0"};this.guestAutocompleteItem(null),App.Ajax.send(i,function(e){var i=[];e&&e.Result&&e.Result&&e.Result.List&&(i=_.map(e.Result.List,function(e){return e&&e.Email&&e.Email!==this.owner()?{value:e.Name&&0<Utils.trim(e.Name).length?'"'+e.Name+'" <'+e.Email+">":e.Email,name:e.Name,email:e.Email,frequency:e.Frequency,id:e.Id,global:e.Global,sharedToAll:e.SharedToAll}:null},this),i=_.sortBy(_.compact(i),function(e){return e.frequency}).reverse()),t(i)},this)},CalendarEventPopup.prototype.repeatRuleParse=function(e){var t=this.allEvents();this.repeatEndDom().datepicker("option","minDate",this.getDateTime(this.endDom())),e&&t===Enums.CalendarEditRecurrenceEvent.AllEvents&&(e.until&&this.repeatEndDom().datepicker("setDate",new Date(1e3*e.until)),e.byDays.length&&_.each(e.byDays,function(e){this["week"+e](!0)},this),this.repeatPeriod(e.period),this.repeatInterval(e.interval),this.repeatCount(e.count),this.repeatWeekNum(e.weekNum),this.always(3===e.end?1:0))},CalendarEventPopup.prototype.getDays=function(){var e=[];return this.weekMO()&&e.push("MO"),this.weekTU()&&e.push("TU"),this.weekWE()&&e.push("WE"),this.weekTH()&&e.push("TH"),this.weekFR()&&e.push("FR"),this.weekSA()&&e.push("SA"),this.weekSU()&&e.push("SU"),e},CalendarEventPopup.prototype.onMainPanelClick=function(){this.dateEdit()&&this.dateEdit(!1)},CalendarEventPopup.prototype.getDateWithoutYearIfMonthWord=function(e){var t=e.split(" "),i=moment(),s=i.format("YYYY");return 3===t.length&&s===t[2]?t[0]+" "+t[1]:e},CalendarEventPopup.prototype.setStartDate=function(e,t){t&&this.startDom().datepicker("setDate",e.toDate()),this.startDate(this.getDateWithoutYearIfMonthWord($(this.startDom()).val())),this.yearlyDayText(Utils.i18n("CALENDAR/EVENT_REPEAT_YEARLY_DAYMONTH",{DAYMONTH:e.format(this.getDateMonthFormat())})),this.monthlyDayText(Utils.i18n("CALENDAR/EVENT_REPEAT_MONTHLY_DAY",{DAY:e.format("DD")}))};CalendarEventPopup.prototype.selectStartDate=function(){if(!this.lockSelectStartEndDate()&&this.startDate()&&this.endDate()){this.lockSelectStartEndDate(!0);var e=this.FCMoment||moment,t=this.getDateTime(this.startDom(),this.startTime()),i=e(t),s=this.getDateTime(this.endDom(),this.endTime()),o=e(s);Utils.isNormal(this.differenceInMinutes)&&(o=i.clone().add(this.differenceInMinutes,"minutes"),s=o.toDate(),this.setEndDate(o,!0),this.endTime(o.format(this.timeFormatMoment))),o.diff(i,"minutes")<0&&(this.setEndDate(i,!0),this.endTime(i.format(this.timeFormatMoment))),this.isEvOneDay(0===o.diff(i,"days")),this.isEvOneTime(0===o.diff(i,"minutes")),this.setStartDate(i,!1),this.startTime(i.format(this.timeFormatMoment)),this.lockSelectStartEndDate(!1)}};CalendarEventPopup.prototype.getDateMonthFormat=function(){var e=this.dateFormatMoment.slice(0,-5);return Utils.inArray(e,["MM/DD","DD/MM","DD MMMM"])===-1&&(e="MM/DD"),e},CalendarEventPopup.prototype.setEndDate=function(e,t){t&&this.endDom().datepicker("setDate",e.toDate()),this.endDate(this.getDateWithoutYearIfMonthWord($(this.endDom()).val()))},CalendarEventPopup.prototype.selectEndDate=function(){if(!this.lockSelectStartEndDate()&&this.endDate()&&this.startDate()){this.lockSelectStartEndDate(!0);var e=this.FCMoment||moment,t=this.getDateTime(this.startDom(),this.startTime()),i=e(t),s=this.getDateTime(this.endDom(),this.endTime()),o=e(s);this.differenceInMinutes=o.diff(i,"minutes"),this.differenceInMinutes<0&&(this.setStartDate(o,!0),this.startTime(o.format(this.timeFormatMoment)),this.differenceInMinutes=0),this.isEvOneDay(0===o.diff(i,"days")),this.isEvOneTime(0===o.diff(i,"minutes")),this.setEndDate(o,!1),this.endTime(o.format(this.timeFormatMoment)),this.repeatEndDom().datepicker("option","minDate",s),this.isRepeat()||this.repeatEndDom().datepicker("setDate",o.add(7,"days").toDate()),this.lockSelectStartEndDate(!1)}},CalendarEventPopup.prototype.getDateTime=function(e,t){t=t?moment(t,this.timeFormatMoment).format("HH:mm"):"";var i=e.datepicker("getDate"),s=t?t.split(":"):[];return 2===s.length&&(i.setHours(s[0]),i.setMinutes(s[1])),i},CalendarEventPopup.prototype.setActualTime=function(){if(!this.lockSelectStartEndDate()&&this.endDate()&&this.startDate()){this.lockSelectStartEndDate(!0);var e=this.FCMoment||moment,t=e(),i=t.format(this.timeFormatMoment),s=this.getDateTime(this.startDom(),i),o=e(s),n=this.getDateTime(this.endDom(),i),a=e(n);o.minutes()>30?(o.add(60-o.minutes(),"minutes"),a.add(90-a.minutes(),"minutes")):(o.add(30-o.minutes(),"minutes"),a.add(60-a.minutes(),"minutes")),this.differenceInMinutes=a.diff(o,"minutes"),this.setStartDate(o,!0),this.startTime(o.format(this.timeFormatMoment)),this.setEndDate(a,!0),this.endTime(a.format(this.timeFormatMoment)),this.lockSelectStartEndDate(!1)}},CalendarEventPopup.prototype.onCalendarAppointmentSetActionResponse=function(e,t){e.Result||App.Api.showErrorByCode(e,Utils.i18n("WARNING/UNKNOWN_ERROR"))},CalendarEventPopup.prototype.setAppointmentAction=function(e){var t=Enums.IcalConfigInt.NeedsAction,i=this.attendees(),s=AppData.Accounts?AppData.Accounts.getAttendee(_.map(this.attendees(),function(e){return e.email},this)):"",o=_.find(this.attendees(),function(e){return e.email===s},this),n=this.calendars.getCalendarById(this.selectedCalendarId()),a={Action:"CalendarAppointmentSetAction",AppointmentAction:e,CalendarId:this.selectedCalendarId(),EventId:this.uid(),Attendee:s};if(o){switch(e){case Enums.IcalConfig.Accepted:t=Enums.IcalConfigInt.Accepted,App.CalendarCache.markIcalAccepted(this.uid());break;case Enums.IcalConfig.Tentative:t=Enums.IcalConfigInt.Tentative,App.CalendarCache.markIcalTentative(this.uid());break;case Enums.IcalConfig.Declined:t=Enums.IcalConfigInt.Declined,App.CalendarCache.markIcalNonexistent(this.uid())}App.Ajax.send(a,this.onCalendarAppointmentSetActionResponse,this),o.status=t,this.attendees([]),this.attendees(i),this.setCurrentAttenderStatus(o.email,this.attendees()),e===Enums.IcalConfig.Declined&&n&&this.callbackAttendeeActionDecline&&Utils.isFunc(this.callbackAttendeeActionDecline)&&(this.callbackAttendeeActionDecline(n,this.id()),this.closePopup())}},CalendarEventPopup.prototype.editableSwitch=function(e,t,i){this.isEditable(e&&t||i),this.isEditableReminders(t)},CalendarEventPopup.prototype.setCurrentAttenderStatus=function(e,t){var i=_.find(t,function(t){return t.email===e});this.attenderStatus(i?i.status:0)},CalendarEventPopup.prototype.getAttenderTextStatus=function(e){switch(e){case 0:e="pending";break;case 1:e="accepted";break;case 2:e="declined";break;case 3:e="tentative"}return e},CalendarEventPopup.prototype.setDayOfWeek=function(){if(this.repeatPeriod()===Enums.CalendarRepeatPeriod.Weekly&&!this.getDays().length){var e=this.getDateTime(this.startDom()).getDay();switch(e){case 0:this.weekSU(!0);break;case 1:this.weekMO(!0);break;case 2:this.weekTU(!0);break;case 3:this.weekWE(!0);break;case 4:this.weekTH(!0);break;case 5:this.weekFR(!0);break;case 6:this.weekSA(!0)}}},CalendarEventPopup.prototype.displayReminderPart=function(e,t){var i="";return i="%REMINDERS%"===e?"Reminders":"Text",t+i},CalendarEventPopup.prototype.autocompleteDeleteItem=function(e){var t={Action:"ContactSuggestionDelete",ContactId:e.id,SharedToAll:e.sharedToAll?"1":"0"};App.Ajax.send(t,function(e){return!0},this)},CalendarEditRecurrenceEventPopup.prototype.onShow=function(e){Utils.isFunc(e)&&(this.fCallback=e)},CalendarEditRecurrenceEventPopup.prototype.popupTemplate=function(){return"Popups_Calendar_EditRecurrenceEventPopupViewModel"},CalendarEditRecurrenceEventPopup.prototype.onlyThisInstanceButtonClick=function(){this.fCallback&&this.fCallback(Enums.CalendarEditRecurrenceEvent.OnlyThisInstance),this.closeCommand()},CalendarEditRecurrenceEventPopup.prototype.allEventsButtonClick=function(){this.fCallback&&this.fCallback(Enums.CalendarEditRecurrenceEvent.AllEvents),this.closeCommand()},CalendarEditRecurrenceEventPopup.prototype.cancelButtonClick=function(){this.fCallback&&this.fCallback(Enums.CalendarEditRecurrenceEvent.None),this.closeCommand()},CalendarEditRecurrenceEventPopup.prototype.onEscHandler=function(){this.cancelButtonClick()},CalendarSelectCalendarsPopup.prototype.onShow=function(e){this.fCallback=e.CallbackSave,this.fProceedUploading=e.ProceedUploading,this.calendars=e.Calendars,this.calendarsList(e.EditableCalendars),this.selectedCalendarId(e.DefaultCalendarId),this.changeCalendarColor(this.selectedCalendarId())},CalendarSelectCalendarsPopup.prototype.popupTemplate=function(){return"Popups_Calendar_CalendarSelectCalendarsPopupViewModel"},CalendarSelectCalendarsPopup.prototype.onSaveClick=function(){this.fCallback&&this.fCallback(this.selectedCalendarId(),this.fProceedUploading),this.closeCommand()},CalendarSelectCalendarsPopup.prototype.onCancelClick=function(){this.closeCommand()},CalendarSelectCalendarsPopup.prototype.changeCalendarColor=function(e){if(Utils.isFunc(this.calendars.getCalendarById)){var t=this.calendars.getCalendarById(e);t&&(this.calendarColor(""),this.calendarColor(t.color()))}},PhonePopup.prototype.popupTemplate=function(){return"Popups_PhonePopupViewModel"},PhonePopup.prototype.onShow=function(e){this.text(e.text),this.callback=e.Callback||Utils.emptyFunction},PhonePopup.prototype.onCancelClick=function(){this.closeCommand()},PhonePopup.prototype.onOKClick=function(){this.closeCommand(),this.callback()},PhonePopup.prototype.answer=function(){this.action(Enums.PhoneAction.IncomingConnect)},PhonePopup.prototype.hangup=function(){this.action(Enums.PhoneAction.Online)},CGenerateOpenPgpKeyPopup.prototype.onShow=function(e){this.pgp=e,this.emails(AppData.Accounts.getAllFullEmails()),this.selectedEmail(""),this.password(""),this.selectedKeyLength(2048),this.process(!1)},CGenerateOpenPgpKeyPopup.prototype.popupTemplate=function(){return"Popups_GenerateOpenPgpKeyPopupViewModel"},CGenerateOpenPgpKeyPopup.prototype.generate=function(){this.pgp&&(this.process(!0),_.delay(_.bind(function(){var e=this.pgp.generateKey(this.selectedEmail(),this.password(),this.selectedKeyLength());e&&e.result&&App.Api.showReport(Utils.i18n("OPENPGP/REPORT_KEY_SUCCESSFULLY_GENERATED")),e&&!e.result?(this.process(!1),App.Api.showPgpErrorByCode(e,Enums.PgpAction.Generate)):this.closeCommand()},this),50))},CShowOpenPgpKeyArmorPopup.prototype.onShow=function(e){this.armor(e.getArmor()),this.user(e.getUser()),this.private(e.isPrivate())},CShowOpenPgpKeyArmorPopup.prototype.popupTemplate=function(){return"Popups_ShowOpenPgpKeyArmorPopupViewModel"},CShowOpenPgpKeyArmorPopup.prototype.send=function(){""!==this.armor()&&""!==this.downloadLinkFilename()&&(App.Api.composeMessageWithPgpKey(this.armor(),this.downloadLinkFilename()),this.closeCommand())},CShowOpenPgpKeyArmorPopup.prototype.select=function(){var e=this.domKey()&&1===this.domKey().length?this.domKey()[0]:null,t=null,i=null;e&&window.getSelection&&document.createRange&&(i=document.createRange(),i.setStart(e,0),i.setEnd(e,1),t=window.getSelection(),t.removeAllRanges(),t.addRange(i))},CImportOpenPgpKeyPopup.prototype.onShow=function(e,t){this.pgp=e,this.keyArmor(t||""),this.keyArmorFocused(!0),this.keys([]),this.hasExistingKeys(!1),""!==this.keyArmor()&&this.checkArmor()},CImportOpenPgpKeyPopup.prototype.popupTemplate=function(){return"Popups_ImportOpenPgpKeyPopupViewModel"},CImportOpenPgpKeyPopup.prototype.checkArmor=function(){var e=null,t=[],i=this.pgp,s=!1;""===this.keyArmor()?this.keyArmorFocused(!0):i&&(e=i.getArmorInfo(this.keyArmor()),Utils.isNonEmptyArray(e)&&_.each(e,function(e){if(e){var o=i.findKeyByID(e.getId(),e.isPublic()),n=null!==o,a=e.isPublic()?"OPENPGP/PUBLIC_KEY_ADD_INFO":"OPENPGP/PRIVATE_KEY_ADD_INFO";s=s||n,t.push({armor:e.getArmor(),email:e.user,id:e.getId(),addInfo:Utils.i18n(a,{LENGTH:e.getBitSize()}),needToImport:ko.observable(!n),disabled:n})}}),0===t.length&&App.Api.showError(Utils.i18n("OPENPGP/ERROR_IMPORT_NO_KEY_FOUND")),this.keys(t),this.hasExistingKeys(s))},CImportOpenPgpKeyPopup.prototype.importKey=function(){var e=null,t=[];this.pgp&&(_.each(this.keys(),function(e){e.needToImport()&&t.push(e.armor)}),t.length>0?(e=this.pgp.importKeys(t.join("")),e&&e.result&&App.Api.showReport(Utils.i18n("OPENPGP/REPORT_KEY_SUCCESSFULLY_IMPORTED_PLURAL",{},null,t.length)),e&&!e.result&&App.Api.showPgpErrorByCode(e,Enums.PgpAction.Import,Utils.i18n("OPENPGP/ERROR_IMPORT_KEY")),this.closeCommand()):App.Api.showError(Utils.i18n("OPENPGP/ERROR_IMPORT_NO_KEY_SELECTED")))},COpenPgpEncryptPopup.prototype.onShow=function(e,t,i,s,o,n){this.data(e),this.fromEmail(t),this.emails(i),this.okCallback=o,this.cancelCallback=n,this.sign(!0),this.password(""),this.encrypt(!s),this.signAndSend(s)},COpenPgpEncryptPopup.prototype.popupTemplate=function(){return"Popups_OpenPgpEncryptPopupViewModel"},COpenPgpEncryptPopup.prototype.executeSignEncrypt=function(){var e=_.bind(function(e){e&&this.signEncrypt(e)},this);App.Api.pgp(e,AppData.User.IdUser)},COpenPgpEncryptPopup.prototype.signEncrypt=function(e){var t=this.data(),i=this.sign()?this.fromEmail():"",s=this.emails(),o=this.sign()?this.password():"",n=null,a="",r="";this.encrypt()?0===s.length?App.Api.showError(Utils.i18n("OPENPGP/ERROR_TO_ENCRYPT_SPECIFY_RECIPIENTS")):this.sign()?(r=Enums.PgpAction.EncryptSign,a=Utils.i18n("OPENPGP/REPORT_MESSAGE_SIGNED_ENCRYPTED_SUCCSESSFULLY"),n=e.signAndEncrypt(t,i,s,o)):(r=Enums.PgpAction.Encrypt,a=Utils.i18n("OPENPGP/REPORT_MESSAGE_ENCRYPTED_SUCCSESSFULLY"),n=e.encrypt(t,s)):this.sign()&&(r=Enums.PgpAction.Sign,a=Utils.i18n("OPENPGP/REPORT_MESSAGE_SIGNED_SUCCSESSFULLY"),n=e.sign(t,i,o)),n&&(n.result?(this.closeCommand(),this.okCallback&&(this.signAndSend()||App.Api.showReport(a),this.okCallback(n.result,this.encrypt()))):App.Api.showPgpErrorByCode(n,r))},COpenPgpEncryptPopup.prototype.cancel=function(){this.cancelCallback&&this.cancelCallback(),this.closeCommand()},COpenPgpEncryptPopup.prototype.onEscHandler=function(){this.cancel()},ContactCreatePopup.prototype.popupTemplate=function(){return"Popups_ContactCreatePopupViewModel"},ContactCreatePopup.prototype.onShow=function(e,t,i,s){this.displayName()===e&&this.email()===t||(this.displayName(e),this.email(t),this.phone(""),this.address(""),this.skype(""),this.facebook("")),Utils.isFunc(i)&&(this.fCallback=i),s&&(this.oContext=s)},ContactCreatePopup.prototype.onSaveClick=function(){if(this.canBeSave()){if(!this.loading()){var e={Action:"ContactCreate",PrimaryEmail:"Home",UseFriendlyName:"1",FullName:this.displayName(),HomeEmail:this.email(),HomePhone:this.phone(),HomeStreet:this.address(),Skype:this.skype(),Facebook:this.facebook()};this.loading(!0),App.Ajax.send(e,this.onContactCreateResponse,this)}}else App.Api.showError(Utils.i18n("CONTACTS/ERROR_EMPTY_CONTACT"))},ContactCreatePopup.prototype.onCancelClick=function(){this.loading(!1),this.closeCommand()},ContactCreatePopup.prototype.onContactCreateResponse=function(e,t){this.loading(!1),e.Result?(App.Api.showReport(Utils.i18n("CONTACTS/REPORT_CONTACT_SUCCESSFULLY_ADDED")),App.ContactsCache.clearInfoAboutEmail(t.HomeEmail),App.ContactsCache.getContactsByEmails([t.HomeEmail],this.fCallback,this.oContext),this.closeCommand()):App.Api.showErrorByCode(e,Utils.i18n("WARNING/CREATING_ACCOUNT_ERROR"))},ContactCreatePopup.prototype.canBeSave=function(){return""!==this.displayName()||""!==this.email()},ContactCreatePopup.prototype.goToContacts=function(){App.ContactsCache.newContactParams={displayName:this.displayName(),email:this.email(),phone:this.phone(),address:this.address(),skype:this.skype(),facebook:this.facebook()},this.closeCommand(),App.Routing.replaceHash(App.Links.contacts())},PlayerPopup.prototype.onShow=function(e){this.iframe(e)},PlayerPopup.prototype.popupTemplate=function(){return"Popups_PlayerPopupViewModel"},PlayerPopup.prototype.onClose=function(){Utils.isFunc(this.closeCallback)&&this.closeCallback(),this.closeCommand(),this.iframe("")},CAppSettingsModel.prototype.parse=function(e){this.AllowWebMail=!!e.AllowWebMail,this.AllowUsersChangeInterfaceSettings=!!e.AllowUsersChangeInterfaceSettings,this.AllowUsersChangeEmailSettings=!!e.AllowUsersChangeEmailSettings,this.AllowUsersAddNewAccounts=!!e.AllowUsersAddNewAccounts,this.SiteName=Utils.pString(e.SiteName),this.Languages=e.Languages,this.Themes=e.Themes,this.DateFormats=e.DateFormats,this.AttachmentSizeLimit=Utils.pInt(e.AttachmentSizeLimit),this.ImageUploadSizeLimit=Utils.pInt(e.ImageUploadSizeLimit),this.FileSizeLimit=Utils.pInt(e.FileSizeLimit),this.AutoSave=!!e.AutoSave,this.IdleSessionTimeout=60*Utils.pInt(e.IdleSessionTimeout)*1e3,this.AllowInsertImage=!!e.AllowInsertImage,this.AllowBodySize=!!e.AllowBodySize,this.MaxBodySize=Utils.pInt(e.MaxBodySize),this.MaxSubjectSize=Utils.pInt(e.MaxSubjectSize),this.JoinReplyPrefixes=!!e.JoinReplyPrefixes,this.AllowTemplateFolders=!!e.AllowTemplateFolders,this.AllowSaveAttachmentToServer=!!e.AllowSaveAttachmentToServer,this.AllowAppRegisterMailto=!!e.AllowAppRegisterMailto,this.AllowPrefetch=!!e.AllowPrefetch,this.LoginFormType=Utils.pInt(e.LoginFormType),this.LoginSignMeType=Utils.pInt(e.LoginSignMeType),this.LoginAtDomainValue=Utils.pString(e.LoginAtDomainValue),this.AllowRegistration=!!e.AllowRegistration,this.AllowPasswordReset=!!e.AllowPasswordReset,this.RegistrationDomains=e.RegistrationDomains,this.RegistrationQuestions=_.without(e.RegistrationQuestions,""),this.DemoWebMail=!!e.DemoWebMail,this.DemoWebMailLogin=Utils.pString(e.DemoWebMailLogin),this.DemoWebMailPassword=Utils.pString(e.DemoWebMailPassword),this.GoogleAnalyticsAccount=e.GoogleAnalyticsAccount,this.ShowQuotaBar=!!e.ShowQuotaBar,this.ServerUseUrlRewrite=!!e.ServerUseUrlRewrite,this.AllowLanguageOnLogin=!bMobileApp&&!!e.AllowLanguageOnLogin,this.FlagsLangSelect=!!e.FlagsLangSelect,this.DefaultLanguage=Utils.pString(e.DefaultLanguage),this.LoginDescription=Utils.pString(e.LoginDescription),this.CustomLoginUrl=Utils.pString(e.CustomLoginUrl),this.CustomLogoutUrl=Utils.pString(e.CustomLogoutUrl),this.IosDetectOnLogin=!!e.IosDetectOnLogin,this.AllowContactsSharing=!!e.AllowContactsSharing,""!==e.DefaultLanguageShort&&(this.DefaultLanguageShort=e.DefaultLanguageShort),this.DefaultTab=e.DefaultTab,this.AllowIosProfile=!!e.AllowIosProfile,this.PasswordMinLength=e.PasswordMinLength,this.PasswordMustBeComplex=!!e.PasswordMustBeComplex,this.SettingsFilesAppsEnabled=!!e.SettingsFilesAppsEnabled,this.SettingsMobilesyncAppsEnabled=!!e.SettingsMobilesyncAppsEnabled,this.CalendarAttachFileToEventEnabled=!!e.CalendarAttachFileToEventEnabled,this.CalendarNotificationEnabled=!!e.CalendarNotificationEnabled,this.HideLogout=!!e.HideLogout},CUserSettingsModel.prototype.fillDefaultFontName=function(){var e=Utils.pString(AppData.HtmlEditorDefaultFontName);""!==e&&(this.DefaultFontName=e)},CUserSettingsModel.prototype.fillDefaultFontSize=function(){var e=Utils.pInt(AppData.HtmlEditorDefaultFontSize);Utils.inArray(e,[2,3,5,7])!==-1&&(this.DefaultFontSize=e)},CUserSettingsModel.prototype.getSaveMailInSentItems=function(){var e=!0;switch(this.SaveMail){case Enums.SaveMail.Unchecked:e=!1;break;case Enums.SaveMail.Checked:case Enums.SaveMail.Hidden:e=!0}return e},CUserSettingsModel.prototype.getUseSaveMailInSentItems=function(){var e=!1;switch(this.SaveMail){case Enums.SaveMail.Unchecked:
case Enums.SaveMail.Checked:e=!0;break;case Enums.SaveMail.Hidden:e=!1}return e},CUserSettingsModel.prototype.parse=function(e){var t=null;null!==e&&(this.IdUser=Utils.pInt(e.IdUser),this.MailsPerPage=Utils.pInt(e.MailsPerPage),this.ContactsPerPage=Utils.pInt(e.ContactsPerPage),this.AutoCheckMailInterval=Utils.pInt(e.AutoCheckMailInterval),this.DefaultTheme=Utils.pString(e.DefaultTheme),this.DefaultLanguage=Utils.pString(e.DefaultLanguage),this.DefaultLanguageShort=Utils.pString(e.DefaultLanguageShort),this.DefaultDateFormat=Utils.pString(e.DefaultDateFormat),this.defaultTimeFormat(Utils.pString(e.DefaultTimeFormat)),this.ThreadsEnabled=!!e.ThreadsEnabled,this.useThreads(!!e.UseThreads),this.SaveRepliedToCurrFolder=!!e.SaveRepliedMessagesToCurrentFolder,this.DesktopNotifications=!!e.DesktopNotifications,this.EmailNotification=Utils.pString(e.EmailNotification),this.AllowChangeInputDirection=!!e.AllowChangeInputDirection,this.AllowCompose=!!e.AllowCompose,this.AllowReply=!!e.AllowReply,this.AllowForward=!!e.AllowForward,this.SaveMail=Utils.pInt(e.SaveMail),this.AllowFetcher=!!e.AllowFetcher,this.OutlookSyncEnable=!!e.OutlookSyncEnable,this.MobileSyncEnable=!!e.MobileSyncEnable,this.ShowPersonalContacts=!!e.ShowPersonalContacts,this.ShowGlobalContacts=!!e.ShowGlobalContacts,this.ShowContacts=this.ShowPersonalContacts||this.ShowGlobalContacts,this.IsFilesSupported=!!e.IsFilesSupported&&!bMobileApp,this.filesEnable(!!e.FilesEnable&&!bMobileApp),this.IsHelpdeskSupported=!!e.IsHelpdeskSupported&&!bMobileApp,this.IsHelpdeskAgent=!!e.IsHelpdeskAgent,this.helpdeskSignature(Utils.pString(e.HelpdeskSignature)),this.helpdeskSignatureEnable(e.HelpdeskSignatureEnable?"1":"0"),this.LastLogin=Utils.pInt(e.LastLogin),this.LoginsCount=Utils.pInt(e.LoginsCount),this.SocialName=Utils.pString(e.SocialName),this.AllowCalendar=!!e.AllowCalendar&&!bMobileApp,this.CalendarSharing=!!e.CalendarSharing,this.CalendarAppointments=!!e.CalendarAppointments,this.IsDemo=!!e.IsDemo,this.AllowVoice=!!e.AllowVoice,this.SipRealm=e.SipRealm,this.SipWebsocketProxyUrl=e.SipWebsocketProxyUrl,this.SipOutboundProxyUrl=e.SipOutboundProxyUrl,this.SipCallerID=e.SipCallerID,this.SipImpi=e.SipImpi,this.SipImpu=e.SipImpu,this.SipPassword=e.SipPassword,this.VoiceProvider=e.VoiceProvider,this.AllowHelpdeskNotifications=e.AllowHelpdeskNotifications,this.IsCollaborationSupported=!!e.IsCollaborationSupported,this.AllowFilesSharing=!!e.AllowFilesSharing,this.enableOpenPgp(!!e.EnableOpenPgp),this.AllowAutosaveInDrafts=!!e.AllowAutosaveInDrafts&&!!AppData.App&&AppData.App.AutoSave,t=e.Calendar,t&&(this.CalendarShowWeekEnds=!!t.ShowWeekEnds,this.CalendarShowWorkDay=!!t.ShowWorkDay,this.CalendarWorkDayStarts=Utils.pInt(t.WorkDayStarts),this.CalendarWorkDayEnds=Utils.pInt(t.WorkDayEnds),this.CalendarWeekStartsOn=Utils.pInt(t.WeekStartsOn),this.CalendarDefaultTab=Utils.pInt(t.DefaultTab)),this.SocialAccounts(e.SocialAccounts),this.CanLoginWithPassword=!!e.CanLoginWithPassword)},CUserSettingsModel.prototype.updateCommonSettings=function(e,t,i,s,o,n,a,r,l,h,c,p){var d=this.defaultTimeFormat()!==a;this.MailsPerPage=e,this.ContactsPerPage=t,this.AutoCheckMailInterval=i,App.MailCache.setAutocheckmailTimer(),this.DefaultTheme=s,this.DefaultLanguage=o,this.DefaultDateFormat=n,this.defaultTimeFormat(a),this.useThreads("1"===r),this.SaveRepliedToCurrFolder="1"===l,this.AllowChangeInputDirection="1"===c,this.DesktopNotifications="1"===h,this.EmailNotification=p,d&&App.nowDateNumber.valueHasMutated()},CUserSettingsModel.prototype.updateOpenPgpSettings=function(e,t,i){this.enableOpenPgp("1"===e),this.AllowAutosaveInDrafts="1"===t},CUserSettingsModel.prototype.updateCalendarSettings=function(e,t,i,s,o,n){this.CalendarShowWeekEnds=e,this.CalendarShowWorkDay=t,this.CalendarWorkDayStarts=i,this.CalendarWorkDayEnds=s,this.CalendarWeekStartsOn=o,this.CalendarDefaultTab=n},CUserSettingsModel.prototype.updateHelpdeskSettings=function(e,t,i){this.AllowHelpdeskNotifications=e,this.helpdeskSignature(t),this.helpdeskSignatureEnable(i)},CUserSettingsModel.prototype.onUserSettingsGetSyncResponse=function(e,t){e.Result?(this.mobileSync(e.Result.Mobile),this.outlookSync(e.Result.Outlook)):App.Api.showErrorByCode(e)},CUserSettingsModel.prototype.requestSyncSettings=function(){null!==this.mobileSync()&&null!==this.outlookSync()||App.Ajax.send({Action:"UserSettingsGetSync"},this.onUserSettingsGetSyncResponse,this)},CAccountModel.prototype.init=function(e,t,i){this.id(e),this.email(t),this.friendlyName(i),this.signature(new CSignatureModel)},CAccountModel.prototype.onAccountGetQuotaResponse=function(e,t){e&&e.Result&&_.isArray(e.Result)&&1<e.Result.length&&(this.quota(Utils.pInt(e.Result[1])),this.usedSpace(Utils.pInt(e.Result[0])),App.MailCache.quotaChangeTrigger(!App.MailCache.quotaChangeTrigger())),this.quotaRecieved(!0)},CAccountModel.prototype.updateQuotaParams=function(){var e={Action:"AccountGetQuota",AccountID:this.id()};AppData.App&&AppData.App.ShowQuotaBar&&this.allowMail()&&App.Ajax.send(e,this.onAccountGetQuotaResponse,this)},CAccountModel.prototype.parse=function(e,t){this.init(parseInt(e.AccountID,10),Utils.pString(e.Email),Utils.pString(e.FriendlyName)),this.allowMail(!!e.AllowMail),this.passwordSpecified(!!e.IsPasswordSpecified),this.signature().parse(this.id(),e.Signature),this.isCurrent(t===this.id()),this.isEdited(t===this.id())},CAccountModel.prototype.requestExtensions=function(){if(!this.extensionsRequested()&&App.Ajax){var e=window.jstz?window.jstz.determine():null;App.Ajax.send({AccountID:this.id(),Action:"SystemIsAuth",ClientTimeZone:e?e.name():""},this.onSystemIsAuthResponse,this)}},CAccountModel.prototype.onSystemIsAuthResponse=function(e,t){var i=!!e.Result,s=i?e.Result.Extensions:[];i&&(this.setExtensions(s),this.extensionsRequested(!0))},CAccountModel.prototype.setExtensions=function(e){_.isArray(e)&&this.extensions(e)},CAccountModel.prototype.extensionExists=function(e){return _.indexOf(this.extensions(),e)!==-1},CAccountModel.prototype.allowMailAfterConfiguring=function(){this.allowMail()||(this.passwordSpecified()&&App.Screens.showPopup(AlertPopup,[Utils.i18n("SETTINGS/ACCOUNTS_WARNING_AFTER_CONFIG_MAIL_HTML",{EMAIL:this.email()}),null,Utils.i18n("SETTINGS/ACCOUNTS_WARNING_AFTER_CONFIG_MAIL_TITLE",{EMAIL:this.email()})]),this.allowMail(!0),App.MailCache.getFolderList(this.id()))},CAccountModel.prototype.updateExtended=function(e){e&&(this.isExtended(!0),Utils.isNormal(e.FriendlyName)&&this.friendlyName(e.FriendlyName),Utils.isNormal(e.IncomingMailLogin)&&this.incomingMailLogin(e.IncomingMailLogin),Utils.isNormal(e.IncomingMailServer)&&this.incomingMailServer(e.IncomingMailServer),Utils.isNormal(e.IncomingMailPort)&&this.incomingMailPort(e.IncomingMailPort),Utils.isNormal(e.IncomingMailSsl)&&this.incomingMailSsl(!!e.IncomingMailSsl),Utils.isNormal(e.IsInternal)&&this.isInternal(e.IsInternal),Utils.isNormal(e.IsLinked)&&this.isLinked(e.IsLinked),Utils.isNormal(e.IsDefault)&&this.isDefault(e.IsDefault),Utils.isNormal(e.OutgoingMailAuth)&&this.outgoingMailAuth(e.OutgoingMailAuth),Utils.isNormal(e.OutgoingMailLogin)&&this.outgoingMailLogin(e.OutgoingMailLogin),Utils.isNormal(e.OutgoingMailServer)&&this.outgoingMailServer(e.OutgoingMailServer),Utils.isNormal(e.OutgoingMailPort)&&this.outgoingMailPort(e.OutgoingMailPort),Utils.isNormal(e.OutgoingMailSsl)&&this.outgoingMailSsl(!!e.OutgoingMailSsl),this.setExtensions(e.Extensions))},CAccountModel.prototype.changeAccount=function(){AppData.Accounts.changeCurrentAccount(this.id(),!0)},CAccountModel.prototype.getDefaultIdentity=function(){return _.find(this.identities()||[],function(e){return e.isDefault()})},CAccountModel.prototype.getFetchersIdentitiesEmails=function(){var e=this.fetchers()?this.fetchers().collection():[],t=this.identities()||[],i=[];return _.each(e,function(e){i.push(e.email())}),_.each(t,function(e){i.push(e.email())}),i},CAccountModel.prototype.remove=function(e){var t=_.bind(this.confirmedRemove,this);this.canBeRemoved()&&(this.fAfterRemoveHandler=e,App.Screens.showPopup(ConfirmPopup,[this.removeConfirmation(),t,this.email()]))},CAccountModel.prototype.confirmedRemove=function(e){var t={Action:"AccountDelete",AccountIDToDelete:this.id()};e?App.Ajax.send(t,this.onAccountDeleteResponse,this):this.fAfterRemoveHandler=void 0},CAccountModel.prototype.onAccountDeleteResponse=function(e,t){e.Result?(App.Api.closeComposePopup(),AppData.Accounts.deleteAccount(this.id()),this.isDefault()?Utils.Common.clearAndReloadLocation(App.browser.ie8AndBelow,!0):"function"==typeof this.fAfterRemoveHandler&&(this.fAfterRemoveHandler(),this.fAfterRemoveHandler=void 0)):App.Api.showErrorByCode(e,Utils.i18n("WARNING/REMOVING_ACCOUNT_ERROR"))},CAccountModel.prototype.requestFilters=function(){var e={Action:"AccountSieveFiltersGet",AccountID:this.id()};App.Ajax.send(e,this.onAccountSieveFiltersGetResponse,this)},CAccountModel.prototype.onAccountSieveFiltersGetResponse=function(e,t){var i=new CSieveFiltersModel,s=Utils.pInt(e.AccountID);i.parse(s,e.Result),this.filters(i)},CAccountListModel.prototype.checkIfMailAllowed=function(){var e=this.getCurrent();this.isCurrentAllowsMail(e.allowMail())},CAccountListModel.prototype.unlockEditedWhenCurrentChange=function(){this.bLockEditedWhenCurrentChange=!1},CAccountListModel.prototype.changeCurrentAccount=function(e,t){var i=this.getCurrent(),s=this.getAccount(e);s&&this.currentId()!==e&&(i.isCurrent(!1),this.currentId(e),s.isCurrent(!0),t&&App.Routing.setHash(App.Links.inbox()))},CAccountListModel.prototype.changeEditedAccount=function(e){var t=this.getEdited(),i=this.getAccount(e);i&&this.editedId()!==e&&(t.isEdited(!1),this.editedId(e),i.isEdited(!0))},CAccountListModel.prototype.parse=function(e,t){var i=null,s=!1,o=null,n=null;_.isArray(t)&&this.collection(_.map(t,function(t){var i=new CAccountModel;return i.parse(t,e),i.id()===e&&(s=!0),i})),!s&&this.collection.length>0&&(i=this.collection()[0],e=i.id(),s=!0),s&&(this.defaultId(e),o=this.getDefault(),o.allowMail()||(n=_.find(this.collection(),function(e){return e.allowMail()})),n?(this.currentId(n.id()),this.editedId(e)):(this.currentId(e),this.editedId(e)),_.defer(function(){o.isDefault(!0)}))},CAccountListModel.prototype.hasMailAccount=function(){var e=_.find(this.collection(),function(e){return e.allowMail()},this);return!!e},CAccountListModel.prototype.getAccount=function(e){var t=_.find(this.collection(),function(t){return t.id()===e},this);return t},CAccountListModel.prototype.getCurrent=function(){return this.getAccount(this.currentId())},CAccountListModel.prototype.getDefault=function(){return this.getAccount(this.defaultId())},CAccountListModel.prototype.getEdited=function(){return this.getAccount(this.editedId())},CAccountListModel.prototype.getEmail=function(e){e=e||this.currentId();var t="",i=this.getAccount(e);return i&&(t=i.email()),t},CAccountListModel.prototype.addAccount=function(e){var t=this.getCurrent();this.collection.push(e),t.allowMail()||this.changeCurrentAccount(e.id(),!1)},CAccountListModel.prototype.deleteAccount=function(e){this.currentId()===e&&this.changeCurrentAccount(this.defaultId(),!1),this.editedId()===e&&this.changeEditedAccount(this.defaultId()),this.collection.remove(function(t){return t.id()===e})},CAccountListModel.prototype.hasAccountWithId=function(e){var t=_.find(this.collection(),function(t){return t.id()===e},this);return!!t},CAccountListModel.prototype.populateFetchersIdentities=function(){this.populateFetchers(),this.populateIdentities()},CAccountListModel.prototype.populateFetchers=function(){AppData.User.AllowFetcher&&App.Ajax.send({Action:"AccountFetcherGetList",AccountID:AppData.Accounts.defaultId()},this.onAccountFetcherGetListResponse,this)},CAccountListModel.prototype.onAccountFetcherGetListResponse=function(e,t){var i=null,s=this.getDefault();Utils.isNonEmptyArray(e.Result)&&(i=new CFetcherListModel,i.parse(AppData.Accounts.defaultId(),e.Result)),s.fetchers(i)},CAccountListModel.prototype.populateIdentities=function(){AppData.AllowIdentities&&(this.isCurrentAllowsMail()||this.collection().length>1)&&App.Ajax.send({Action:"AccountIdentitiesGet"},this.onAccountIdentitiesGetResponse,this)},CAccountListModel.prototype.onAccountIdentitiesGetResponse=function(e,t){var i={};Utils.isNonEmptyArray(e.Result)&&_.each(e.Result,function(e){var t=new CIdentityModel,s=-1;t.parse(e),s=t.accountId(),i[s]||(i[s]=[]),i[s].push(t)}),_.each(this.collection(),function(e){var t=i[e.id()],s=new CIdentityModel;Utils.isNonEmptyArray(t)||(t=[]),s.parse({"@Object":"Object/CIdentity",Loyal:!0,Default:!_.find(t,function(e){return e.isDefault()}),Email:e.email(),Enabled:!0,FriendlyName:e.friendlyName(),IdAccount:e.id(),IdIdentity:1e5*e.id(),Signature:e.signature()?e.signature().signature():"",UseSignature:!!e.signature()&&!!e.signature().options()}),t.unshift(s),e.identities(t)})},CAccountListModel.prototype.populateIdentitiesFromSourceAccount=function(e){e&&_.each(this.collection(),function(t){var i=e.getAccount(t.id());i&&(t.fetchers(i.fetchers()),t.identities(i.identities()),t.signature(i.signature()))})},CAccountListModel.prototype.getAccountsEmails=function(){return _.uniq(_.map(AppData.Accounts.collection(),function(e){return e.email()}))},CAccountListModel.prototype.getAllFullEmails=function(){var e=[];return _.each(this.collection(),function(t){t&&(e.push(t.fullEmail()),t.fetchers()&&Utils.isNonEmptyArray(t.fetchers().collection())&&_.each(t.fetchers().collection(),function(t){t.isOutgoingEnabled()&&""!==t.fullEmail()&&e.push(t.fullEmail())}),Utils.isNonEmptyArray(t.identities())&&_.each(t.identities(),function(t){e.push(t.fullEmail())}))}),e},CAccountListModel.prototype.getCurrentFetchersAndFiltersFolderNames=function(){var e=this.getCurrent(),t=[];return e&&(e.filters()&&_.each(e.filters().collection(),function(e){t.push(e.folder())},this),e.fetchers()&&_.each(e.fetchers().collection(),function(e){t.push(e.folder())},this)),t},CAccountListModel.prototype.getAttendee=function(e){var t=[],i="";return _.each(this.collection(),function(e){t=e.isCurrent()?_.union(e.email(),e.getFetchersIdentitiesEmails(),t):_.union(t,e.email(),e.getFetchersIdentitiesEmails())}),t=_.uniq(t),_.each(t,_.bind(function(t){if(""===i){var s=_.find(e,function(e){return e===t});s===t&&(i=t)}},this)),i},CAddressModel.prototype.parse=function(e){null!==e&&(this.sName=Utils.pString(e.DisplayName),this.sEmail=Utils.pString(e.Email),this.sDisplay=this.sName.length>0?this.sName:this.sEmail,this.sFull=Utils.Address.getFullEmail(this.sName,this.sEmail))},CAddressModel.prototype.getEmail=function(){return this.sEmail},CAddressModel.prototype.getName=function(){return this.sName},CAddressModel.prototype.getDisplay=function(){return this.sDisplay},CAddressModel.prototype.getFull=function(){return this.sFull},CAddressListModel.prototype.parse=function(e){this.aCollection=_.map(e,function(e){var t=new CAddressModel;return t.parse(e),t})},CAddressListModel.prototype.addCollection=function(e){_.each(e,function(e){var t=_.find(this.aCollection,function(t){return e.sEmail===t.sEmail});t||this.aCollection.push(e)},this)},CAddressListModel.prototype.excludeCollection=function(e){_.each(e,function(e){this.aCollection=_.filter(this.aCollection,function(t){return e.sEmail!==t.sEmail})},this)},CAddressListModel.prototype.getFirstEmail=function(){return this.aCollection.length>0?this.aCollection[0].getEmail():""},CAddressListModel.prototype.getFirstName=function(){return this.aCollection.length>0?this.aCollection[0].getName():""},CAddressListModel.prototype.getFirstDisplay=function(){return this.aCollection.length>0?this.aCollection[0].getDisplay():""},CAddressListModel.prototype.getDisplay=function(e,t){var i=_.map(this.aCollection,function(i){return e&&t===i.sEmail?e:i.getDisplay(e)});return i.join(", ")},CAddressListModel.prototype.getFull=function(){var e=_.map(this.aCollection,function(e){return e.getFull()});return e.join(", ")},CAddressListModel.prototype.getEmails=function(){var e=_.map(this.aCollection,function(e){return e.getEmail()});return e},CDateModel.prototype.parse=function(e){this.iTimeStampInUTC=e,this.oMoment=moment.unix(this.iTimeStampInUTC)},CDateModel.prototype.setDate=function(e,t,i){this.oMoment=moment([e,t,i])},CDateModel.prototype.getTimeFormat=function(){return AppData.User.defaultTimeFormat()===Enums.TimeFormat.F24?"HH:mm":"hh:mm A"},CDateModel.prototype.getFullDate=function(){return this.oMoment?this.oMoment.format("ddd, MMM D, YYYY, "+this.getTimeFormat()):""},CDateModel.prototype.getMidDate=function(){return this.getShortDate(!0)},CDateModel.prototype.getShortDate=function(e){var t="",i=null;return this.oMoment&&(i=moment(),i.format("L")===this.oMoment.format("L")?t=this.oMoment.format(this.getTimeFormat()):(t=i.clone().subtract(1,"days").format("L")===this.oMoment.format("L")?Utils.i18n("DATETIME/YESTERDAY"):i.year()===this.oMoment.year()?this.oMoment.format("MMM D"):this.oMoment.format("MMM D, YYYY"),Utils.isUnd(e)||!e||(t+=", "+this.oMoment.format(this.getTimeFormat())))),t},CDateModel.prototype.getDate=function(){return this.oMoment?this.oMoment.format("ddd, MMM D, YYYY"):""},CDateModel.prototype.getTime=function(){return this.oMoment?this.oMoment.format(this.getTimeFormat()):""},CDateModel.prototype.convertDate=function(e){var t=Utils.getDateFormatForMoment(AppData.User.DefaultDateFormat)+" "+this.getTimeFormat();return moment(1e3*e).format(t)},CDateModel.prototype.getTimeStampInUTC=function(){return this.iTimeStampInUTC},CIdentityModel.prototype.parse=function(e){"Object/CIdentity"===e["@Object"]&&(this.loyal(!!e.Loyal),this.isDefault(!!e.Default),this.enabled(!!e.Enabled),this.email(Utils.pString(e.Email)),this.friendlyName(Utils.pString(e.FriendlyName)),this.accountId(Utils.pInt(e.IdAccount)),this.id(Utils.pInt(e.IdIdentity)),this.signature(Utils.pString(e.Signature)),this.useSignature(!!e.UseSignature))},CCommonFileModel.prototype.dataObjectName="",CCommonFileModel.prototype.isVisibleViewLink=function(){return this.uploaded()&&!this.uploadError()&&this.isViewMimeType()},CCommonFileModel.prototype.parse=function(e,t){e["@Object"]===this.dataObjectName&&(this.fileName(Utils.pString(e.FileName)),this.tempName(Utils.pString(e.TempName)),""===this.tempName()&&this.tempName(this.fileName()),this.type(Utils.pString(e.MimeType)),this.size(e.EstimatedSize?parseInt(e.EstimatedSize,10):parseInt(e.SizeInBytes,10)),this.content(Utils.pString(e.Content)),this.thumb(!!e.Thumb),this.hash(Utils.pString(e.Hash)),this.accountId(t),this.allowExpandSubFiles(!!e.Expand),this.iframedView(!!e.Iframed),this.uploadUid(this.hash()),this.uploaded(!0),Utils.isFunc(this.additionalParse)&&this.additionalParse(e))},CCommonFileModel.prototype.getInThumbQueue=function(e){this.thumbnailSessionUid(e),this.thumb()&&(!this.linked||this.linked&&!this.linked())&&Utils.thumbQueue(this.thumbnailSessionUid(),this.thumbnailLink(),this.thumbnailSrc)},CCommonFileModel.prototype.downloadFile=function(e){this.allowDownload()&&(e&&e.Api&&e.Api.downloadByUrl||(e=App),e&&this.downloadLink().length>0&&"#"!==this.downloadLink()&&e.Api.downloadByUrl(this.downloadLink()))},CCommonFileModel.prototype.onFileExpandResponse=function(e,t){this.subFiles([]),Utils.isNonEmptyArray(e.Result)&&(_.each(e.Result,_.bind(function(e){var t=this.getInstance();e["@Object"]=this.dataObjectName,t.parse(e,this.accountId()),this.subFiles.push(t)},this)),this.subFilesLoaded(!0),this.subFilesCollapsed(!0)),this.subFilesStartedLoading(!1)},CCommonFileModel.prototype.expandFile=function(){this.subFilesLoaded()?this.subFilesCollapsed(!0):(this.subFilesStartedLoading(!0),App.Ajax.send({Action:"FileExpand",RawKey:this.hash()},this.onFileExpandResponse,this))},CCommonFileModel.prototype.collapseFile=function(){this.subFilesCollapsed(!1)},CCommonFileModel.prototype.getInstance=function(){return new CCommonFileModel},CCommonFileModel.prototype.importFile=function(){var e=this.content(),t=_.bind(function(t){t&&App.Screens.showPopup(CImportOpenPgpKeyPopup,[t,e])},this);App.Api.pgp(t,AppData.User.IdUser)},CCommonFileModel.prototype.downloadOrViewByIconClick=function(e,t,i){""!==this.oembed()?this.viewFile(e,t):this.allowSelect()||this.downloadFile(i)},CCommonFileModel.prototype.viewFile=function(e,t){Utils.calmEvent(t),this.viewCommonFile()},CCommonFileModel.prototype.openLink=function(){Utils.WindowOpener.openTab(this.viewLink())},CCommonFileModel.prototype.viewCommonFile=function(){var e=Utils.Common.getAppPath()+this.viewLink(),t=null;this.visibleViewLink()&&this.viewLink().length>0&&"#"!==this.viewLink()&&(this.isLink()&&(e=this.linkUrl()),""!==this.oembedHtml()?App.Api.showPlayer(this.oembedHtml()):t=this.iframedView()?Utils.WindowOpener.openTab(e):Utils.WindowOpener.open(e,e,!1),t&&t.focus())},CCommonFileModel.prototype.eventDragStart=function(e,t){var i=t.originalEvent||t;return e&&i&&i.dataTransfer&&i.dataTransfer.setData&&i.dataTransfer.setData("DownloadURL",this.generateTransferDownloadUrl()),!0},CCommonFileModel.prototype.generateTransferDownloadUrl=function(){var e=this.downloadLink();return"http"!==e.substr(0,4)&&(e=Utils.Common.getAppPath()+e),this.type()+":"+this.fileName()+":"+e},CCommonFileModel.prototype.onUploadSelect=function(e,t){this.fileName(Utils.pString(t.FileName)),this.type(Utils.pString(t.Type)),this.size(Utils.pInt(t.Size)),this.uploadUid(e),this.uploaded(!1),this.visibleSpinner(!1),this.statusText(""),this.progressPercent(0),this.visibleProgress(!1)},CCommonFileModel.prototype.onUploadStart=function(){this.visibleSpinner(!0),this.visibleProgress(!0)},CCommonFileModel.prototype.onUploadProgress=function(e,t){t>0&&(this.progressPercent(Math.ceil(e/t*100)),this.visibleProgress(!0))},CCommonFileModel.prototype.onUploadComplete=function(e,t,i){var s=!(t&&i&&!i.Error),o=Utils.i18n("COMPOSE/UPLOAD_ERROR_UNKNOWN");if(this.visibleSpinner(!1),this.progressPercent(0),this.visibleProgress(!1),this.uploaded(!0),this.uploadError(s),s&&i)switch(i.Error){case"size":o=Utils.i18n("COMPOSE/UPLOAD_ERROR_SIZE");break;case"exception":110===i.ErrorCode&&(o=Utils.i18n("FILESTORAGE/UPLOAD_ERROR_MAXPATHLEN"))}this.statusText(s?o:Utils.i18n("COMPOSE/UPLOAD_COMPLETE")),s||(this.fillDataAfterUploadComplete(i,e),setTimeout(function(e){return function(){e.statusText("")}}(this),3e3))},CCommonFileModel.prototype.fillDataAfterUploadComplete=function(e,t){},CCommonFileModel.prototype.onImageLoad=function(e,t){this.thumb()&&!this.thumbnailLoaded()&&(this.thumbnailLoaded(!0),Utils.thumbQueue(this.thumbnailSessionUid()))},CCommonFileModel.prototype.saveToServer=function(){},Utils.extend(CMailAttachmentModel,CCommonFileModel),CMailAttachmentModel.prototype.dataObjectName="Object/CApiMailAttachment",CMailAttachmentModel.prototype.getInstance=function(){return new CMailAttachmentModel},CMailAttachmentModel.prototype.getCopy=function(){var e=new CMailAttachmentModel;return e.copyProperties(this),e},CMailAttachmentModel.prototype.copyProperties=function(e){this.fileName(e.fileName()),this.tempName(e.tempName()),this.size(e.size()),this.accountId(e.accountId()),this.hash(e.hash()),this.type(e.type()),this.cid(e.cid()),this.contentLocation(e.contentLocation()),this.inline(e.inline()),this.linked(e.linked()),this.thumb(e.thumb()),this.thumbnailSrc(e.thumbnailSrc()),this.thumbnailLoaded(e.thumbnailLoaded()),this.statusText(e.statusText()),this.uploaded(e.uploaded()),this.iframedView(e.iframedView())},CMailAttachmentModel.prototype.isVisibleViewLink=function(){return this.uploaded()&&!this.uploadError()&&(this.isViewMimeType()||this.isMessageType())},CMailAttachmentModel.prototype.additionalParse=function(e){this.mimePartIndex(Utils.pString(e.MimePartIndex)),this.cid(Utils.pString(e.CID)),this.contentLocation(Utils.pString(e.ContentLocation)),this.inline(!!e.IsInline),this.linked(!!e.IsLinked)},CMailAttachmentModel.prototype.setMessageData=function(e,t){this.folderName(e),this.messageUid(t)},CMailAttachmentModel.prototype.onMessageGetResponse=function(e,t){if(this.oNewWindow){var i=e.Result,s=new CMessageModel;i?(s.parse(i,e.AccountID,!1,!0),this.messagePart(s),this.messagePart().viewMessage(this.oNewWindow)):this.oNewWindow.close(),this.oNewWindow=void 0}},CMailAttachmentModel.prototype.viewFile=function(){this.isMessageType()?this.viewMessageFile():this.viewCommonFile()},CMailAttachmentModel.prototype.viewMessageFile=function(){var e=null,t='<div style="margin: 30px; text-align: center; font: normal 14px Tahoma;">'+Utils.i18n("MAIN/LOADING")+"</div>";e=Utils.WindowOpener.open("",this.fileName()),e&&(this.messagePart()?this.messagePart().viewMessage(e):($(e.document.body).html(t),this.oNewWindow=e,App.Ajax.send({Action:"MessageGet",Folder:this.folderName(),Uid:this.messageUid(),Rfc822MimeIndex:this.mimePartIndex()},this.onMessageGetResponse,this)),e.focus())},CMailAttachmentModel.prototype.viewCommonFile=function(){var e=null,t=Utils.Common.getAppPath()+this.viewLink();this.visibleViewLink()&&this.viewLink().length>0&&"#"!==this.viewLink()&&(t=Utils.Common.getAppPath()+this.viewLink(),e=this.iframedView()?Utils.WindowOpener.openTab(t):Utils.WindowOpener.open(t,t,!1),e&&e.focus())},CMailAttachmentModel.prototype.fillDataAfterUploadComplete=function(e,t){this.cid(t),this.tempName(e.Result.Attachment.TempName),this.type(e.Result.Attachment.MimeType),this.size(e.Result.Attachment.Size),this.hash(e.Result.Attachment.Hash),this.iframedView(e.Result.Attachment.Iframed),this.accountId(e.AccountID)},CMailAttachmentModel.prototype.parseFromUpload=function(e,t){this.fileName(e.Name.toString()),this.tempName(e.TempName?e.TempName.toString():this.fileName()),this.type(e.MimeType.toString()),this.size(parseInt(e.Size,10)),this.hash(e.Hash),this.accountId(t),this.uploadUid(this.hash()),this.uploaded(!0),this.uploadStarted(!1)},CMailAttachmentModel.prototype.errorFromUpload=function(){this.uploaded(!0),this.uploadError(!0),this.uploadStarted(!1),this.statusText(Utils.i18n("COMPOSE/UPLOAD_ERROR_UNKNOWN"))},CMailAttachmentModel.prototype.saveToServer=function(){this.savingToServer(!0),App.Ajax.send({Action:"MessageAttachmentSaveToServer",RawKey:this.hash()},this.onMessageAttachmentSaveToServer,this)},CMailAttachmentModel.prototype.onMessageAttachmentSaveToServer=function(e){this.savingToServer(!1),e.Result?App.Api.showReport(Utils.i18n("MESSAGE/REPORT_ATTACHMENT_SAVED_TO_SERVER")):App.Api.showErrorByCode(e,Utils.i18n("MESSAGE/ERROR_ATTACHMENT_SAVED_TO_SERVER"))},CFolderModel.prototype.setLevel=function(e){this.iLevel=e},CFolderModel.prototype.getMessageByUid=function(e){return this.oMessages[e]},CFolderModel.prototype.getFlaggedMessageUids=function(){var e=[];return _.each(this.oMessages,function(t){t.flagged()&&e.push(t.uid())}),e},CFolderModel.prototype.setMessageUnflaggedByUid=function(e){var t=this.oMessages[e];t&&t.flagged(!1)},CFolderModel.prototype.hideThreadMessages=function(e){_.each(e.threadUids(),function(e){var t=this.oMessages[e];t&&(t.deleted()||(t.threadShowAnimation(!1),t.threadHideAnimation(!0),setTimeout(function(){t.threadHideAnimation(!1)},1e3)))},this)},CFolderModel.prototype.getThreadMessages=function(e){var t=[],i=[],s=[],o=0,n=null,a=50;return _.each(e.threadUids(),function(r){if(o<e.threadCountForLoad()){var l=this.oMessages[r];l?l.deleted()||(l.markAsThreadPart(a,e.uid()),t.push(l),s.push(l.uid()),o++,n=l):(i.push(r),s.push(r),o++)}else s.push(r)},this),e.threadLoading()||this.loadThreadMessages(i),e.changeThreadUids(s,t.length),n&&t.length<e.threadUids().length&&n.showNextLoadingLink(_.bind(e.increaseThreadCountForLoad,e)),this.addThreadUidsToUidLists(e.uid(),e.threadUids()),t},CFolderModel.prototype.computeThreadData=function(e){var t=0,i=!1,s=[],o=[],n=e.oFrom.getFirstEmail();_.each(e.threadUids(),function(e){var a=this.oMessages[e],r="";a&&!a.deleted()&&(a.seen()||t++,a.flagged()&&(i=!0),r=a.oFrom.getFirstEmail(),r!==n&&-1===Utils.inArray(r,o)&&(o.push(r),r===AppData.Accounts.getEmail()?s.push(Utils.i18n("MESSAGE/ME_SENDER")):s.push(a.oFrom.getFirstDisplay())))},this),e.threadUnreadCount(t),e.partialFlagged(i),e.threadSenders(s)},CFolderModel.prototype.addThreadUidsToUidLists=function(e,t){_.each(this.oUids,function(i){_.each(i,function(i){i.addThreadUids(e,t)})})},CFolderModel.prototype.loadThreadMessages=function(e){if(e.length>0){var t={Action:"MessagesGetListByUids",Folder:this.fullName(),Uids:e};App.Ajax.send(t,this.onMessagesGetListByUidsResponse,this)}},CFolderModel.prototype.getThreadCheckedUidsFromList=function(e){var t=this,i=[];return _.each(e,function(e){e.threadCount()>0&&!e.threadOpened()&&_.each(e.threadUids(),function(e){var s=t.oMessages[e];s&&!s.deleted()&&s.checked()&&i.push(e)})}),i},CFolderModel.prototype.parseAndCacheMessage=function(e,t,i){var s=e.Uid.toString(),o=Utils.isUnd(this.oMessages[s]),n=o?new CMessageModel:this.oMessages[s];return n.parse(e,this.iAccountId,t,i),this.type()===Enums.FolderTypes.Inbox&&o&&n.flagged()&&App.MailCache.increaseStarredCount(),this.oMessages[n.uid()]=n,n},CFolderModel.prototype.onMessagesGetListByUidsResponse=function(e,t){var i=e.Result;i&&"Collection/MessageCollection"===i["@Object"]&&(_.each(i["@Collection"],function(e){this.parseAndCacheMessage(e,!0,!0)},this),App.MailCache.showOpenedThreads(this.fullName()))},CFolderModel.prototype.addRequestedUids=function(e){this.aRequestedUids=_.union(this.aRequestedUids,e)},CFolderModel.prototype.hasUidBeenRequested=function(e){return _.indexOf(this.aRequestedUids,e)!==-1},CFolderModel.prototype.addRequestedThreadUids=function(e){this.aRequestedThreadUids=_.union(this.aRequestedThreadUids,e)},CFolderModel.prototype.hasThreadUidBeenRequested=function(e){return _.indexOf(this.aRequestedThreadUids,e)!==-1},CFolderModel.prototype.hasListBeenRequested=function(e){var t=_.where(this.requestedLists,e),i=t.length>0;return i||this.requestedLists.push(e),i},CFolderModel.prototype.markMessageReplied=function(e,t){var i=this.oMessages[e];if(i)switch(t){case Enums.ReplyType.Reply:case Enums.ReplyType.ReplyAll:i.answered(!0);break;case Enums.ReplyType.Forward:i.forwarded(!0)}},CFolderModel.prototype.removeAllMessages=function(){var e=null;this.oMessages={},this.oUids={},this.messageCount(0),this.unseenMessageCount(0),this.sRealUnseenMessageCount=0,e=this.getUidList("",""),e.resultCount(0)},CFolderModel.prototype.removeAllMessageListsFromCacheIfHasChanges=function(){this.hasChanges()&&(this.oUids={},this.requestedLists=[],this.aRequestedThreadUids=[],this.hasChanges(!1))},CFolderModel.prototype.removeFlaggedMessageListsFromCache=function(){_.each(this.oUids,function(e,t){delete this.oUids[t][Enums.FolderFilter.Flagged]},this)},CFolderModel.prototype.removeUnseenMessageListsFromCache=function(){_.each(this.oUids,function(e,t){delete this.oUids[t][Enums.FolderFilter.Unseen]},this)},CFolderModel.prototype.setRelevantInformation=function(e,t,i,s,o){var n=this.hasExtendedInfo()&&(this.sHash!==t||this.sRealUnseenMessageCount!==s);return o||(this.sUidNext=e),this.sHash=t,this.hasExtendedInfo()&&o||(this.messageCount(i),this.unseenMessageCount(s),0===s&&this.unseenMessageCount.valueHasMutated()),this.sRealUnseenMessageCount=s,this.hasExtendedInfo(!0),n&&this.markHasChanges(),this.relevantInformationLastMoment=moment(),n},CFolderModel.prototype.increaseCountIfHasNotInfo=function(){this.hasExtendedInfo()||this.messageCount(this.messageCount()+1)};CFolderModel.prototype.markHasChanges=function(){this.hasChanges(!0)};if(CFolderModel.prototype.addMessagesCountsDiff=function(e,t){var i=this.messageCount()+e,s=this.unseenMessageCount()+t;i<0&&(i=0),this.messageCount(i),s<0&&(s=0),s>i&&(s=i),this.unseenMessageCount(s)},CFolderModel.prototype.markDeletedByUids=function(e){var t=0,i=0;return _.each(e,function(e){var s=this.oMessages[e];s&&(t++,s.seen()||i++,s.deleted(!0))},this),this.addMessagesCountsDiff(-t,-i),{MinusDiff:t,UnseenMinusDiff:i}},CFolderModel.prototype.revertDeleted=function(e){var t=0,i=0;return _.each(e,function(e){var s=this.oMessages[e];s&&s.deleted()&&(t++,s.seen()||i++,s.deleted(!1))},this),this.addMessagesCountsDiff(t,i),{PlusDiff:t,UnseenPlusDiff:i}},CFolderModel.prototype.commitDeleted=function(e){
_.each(e,_.bind(function(e){delete this.oMessages[e]},this)),_.each(this.oUids,function(t){_.each(t,function(t){t.deleteUids(e)})})},CFolderModel.prototype.getUidList=function(e,t){var i=null;return void 0===this.oUids[e]&&(this.oUids[e]={}),void 0===this.oUids[e][t]&&(i=new CUidListModel,i.search(e),i.filters(t),this.oUids[e][t]=i),this.oUids[e][t]},CFolderModel.prototype.initStarredFolder=function(e,t){this.bVirtual=!0,this.setLevel(e),this.fullName(t),this.name(Utils.i18n("MAIN/FOLDER_STARRED")),this.type(Enums.FolderTypes.Starred),this.initSubscriptions(""),this.initComputedFields(!0)},CFolderModel.prototype.parse=function(e,t,i,s){var o="",n=App.Storage.getData("folderAccordion")||[],a=e.Type;return"Object/Folder"===e["@Object"]?(o=Utils.pString(e.Name),AppData.App.AllowTemplateFolders||a!==Enums.FolderTypes.Template||(a=Enums.FolderTypes.User),this.name(o),this.nameForEdit(o),this.fullName(Utils.pString(e.FullNameRaw)),this.fullNameHash(Utils.pString(e.FullNameHash)),this.sDelimiter=e.Delimiter,this.type(a),this.isTemplateStorage(this.type()===Enums.FolderTypes.Template),this.bNamespace=s===this.fullName(),this.subscribed(this.type()===Enums.FolderTypes.Inbox||!!e.IsSubscribed),this.bSelectable=e.IsSelectable,this.bExists=e.Exists,e.Extended&&this.setRelevantInformation(e.Extended.UidNext.toString(),e.Extended.Hash,e.Extended.MessageCount,e.Extended.MessageUnseenCount,!1),_.find(n,function(e){return e===this.name()},this)&&this.expanded(!0),this.initSubscriptions(t),this.initComputedFields(i),e.SubFolders):null},CFolderModel.prototype.initSubscriptions=function(e){this.unseenMessageCount.subscribe(function(){_.delay(_.bind(function(){App.MailCache.countMessages(this)},this),1e3)},this),this.subscribed.subscribe(function(){if(e){var t=App.MailCache.folderList().getFolderByFullName(e);t&&App.MailCache.countMessages(t)}},this),this.edited.subscribe(function(e){e===!1&&this.nameForEdit(this.name())},this),this.hasChanges.subscribe(function(){this.requestedLists=[]},this)},CFolderModel.prototype.initComputedFields=function(e){this.routingHash=ko.computed(function(){return this.bVirtual?App.Routing.buildHashFromArray(App.Links.mailbox(this.fullName(),1,"","",Enums.FolderFilter.Flagged)):App.Routing.buildHashFromArray([Enums.Screens.Mailbox,this.fullName()])},this),this.isSystem=ko.computed(function(){return this.type()!==Enums.FolderTypes.User},this),this.showUnseenMessages=ko.computed(function(){return this.type()!==Enums.FolderTypes.Drafts},this),this.withoutThreads=ko.computed(function(){return this.type()===Enums.FolderTypes.Drafts||this.type()===Enums.FolderTypes.Spam||this.type()===Enums.FolderTypes.Trash},this),this.enableEmptyFolder=ko.computed(function(){return(this.type()===Enums.FolderTypes.Spam||this.type()===Enums.FolderTypes.Trash)&&this.messageCount()>0},this),this.virtualEmpty=ko.computed(function(){return this.bVirtual&&0===this.messageCount()},this),this.hasSubscribedSubfolders=ko.computed(function(){return _.any(this.subfolders(),function(e){return e.subscribed()})},this),this.canExpand=ko.computed(function(){return!this.bNamespace&&this.hasSubscribedSubfolders()},this),this.messageCountToShow=ko.computed(function(){return this.canExpand()?this.showUnseenMessages()?this.unseenMessageCount()+this.subfoldersMessagesCount():this.messageCount():this.showUnseenMessages()?this.unseenMessageCount():this.messageCount()},this),this.visible=ko.computed(function(){return this.subscribed()||this.isSystem()||this.hasSubscribedSubfolders()&&(!this.bExists||!this.bSelectable)},this),this.bCanBeSelected=this.bExists&&this.bSelectable,this.canSubscribe=ko.computed(function(){return!e&&!this.isSystem()&&this.bCanBeSelected},this),this.canDelete=ko.computed(function(){return!this.isSystem()&&this.hasExtendedInfo()&&0===this.messageCount()&&0===this.subfolders().length},this),this.canRename=ko.computed(function(){return this.bCanBeSelected&&!this.isSystem()},this),this.bAllowTemplateFolders=AppData.App.AllowTemplateFolders,this.visibleTemplateTrigger=ko.computed(function(){return AppData.App.AllowTemplateFolders&&(this.bSelectable&&!this.isSystem()||this.isTemplateStorage())},this),this.templateButtonHint=ko.computed(function(){return AppData.App.AllowTemplateFolders?this.isTemplateStorage()?Utils.i18n("SETTINGS/ACCOUNT_FOLDERS_TURN_TEMPLATE_OFF_HINT"):Utils.i18n("SETTINGS/ACCOUNT_FOLDERS_TURN_TEMPLATE_ON_HINT"):""},this),this.subscribeButtonHint=ko.computed(function(){return this.canSubscribe()?this.subscribed()?Utils.i18n("SETTINGS/ACCOUNT_FOLDERS_HIDE_FOLDER_HINT"):Utils.i18n("SETTINGS/ACCOUNT_FOLDERS_SHOW_FOLDER_HINT"):""},this),this.deleteButtonHint=ko.computed(function(){return this.canDelete()?Utils.i18n("SETTINGS/ACCOUNT_FOLDERS_DELETE_FOLDER_HINT"):""},this),this.usedAs=ko.computed(function(){switch(this.type()){case Enums.FolderTypes.Inbox:return Utils.i18n("SETTINGS/ACCOUNT_FOLDERS_USED_AS_INBOX");case Enums.FolderTypes.Sent:return Utils.i18n("SETTINGS/ACCOUNT_FOLDERS_USED_AS_SENT");case Enums.FolderTypes.Drafts:return Utils.i18n("SETTINGS/ACCOUNT_FOLDERS_USED_AS_DRAFTS");case Enums.FolderTypes.Trash:return Utils.i18n("SETTINGS/ACCOUNT_FOLDERS_USED_AS_TRASH");case Enums.FolderTypes.Spam:return Utils.i18n("SETTINGS/ACCOUNT_FOLDERS_USED_AS_SPAM")}return""},this),this.displayName=ko.computed(function(){switch(this.type()){case Enums.FolderTypes.Inbox:return Utils.i18n("MAIN/FOLDER_INBOX");case Enums.FolderTypes.Sent:return Utils.i18n("MAIN/FOLDER_SENT");case Enums.FolderTypes.Drafts:return Utils.i18n("MAIN/FOLDER_DRAFTS");case Enums.FolderTypes.Trash:return Utils.i18n("MAIN/FOLDER_TRASH");case Enums.FolderTypes.Spam:return Utils.i18n("MAIN/FOLDER_SPAM")}return this.name()},this),this.unseenMessagesTitle=ko.computed(function(){return this.showUnseenMessages()?Utils.i18n("MAILBOX/TITLE_UNSEEN_MESSAGES_ONLY"):""},this)},CFolderModel.prototype.onMessageGetResponse=function(e,t){var i=e.Result,s=null,o=i?i.Uid.toString():t.Uid.toString(),n=this.oMessages[o],a=!!n&&n.selected();i?(n=this.parseAndCacheMessage(i,!1,!1),n&&n.ical()&&n.ical().isReplyType()&&App.CalendarCache&&App.CalendarCache.calendarChanged(!0)):(a&&(App.Api.showErrorByCode(e,Utils.i18n("WARNING/UNKNOWN_ERROR")),App.Routing.replaceHashWithoutMessageUid(o)),n=null),s=this.aResponseHandlers[o],s&&(s.handler.call(s.context,n,o),delete this.aResponseHandlers[o])},CFolderModel.prototype.getCompletelyFilledMessage=function(e,t,i){var s=this.oMessages[e],o={Action:"MessageGet",Folder:this.fullName(),Uid:e};e.length>0&&(s&&s.completelyFilled()&&!s.trimmed()?t&&i&&t.call(i,s,e):(t&&i&&(this.aResponseHandlers[e]={handler:t,context:i}),App.Ajax.send(o,this.onMessageGetResponse,this)))},CFolderModel.prototype.showExternalPictures=function(e){var t=this.oMessages[e];void 0!==t&&t.showExternalPictures()},CFolderModel.prototype.alwaysShowExternalPicturesForSender=function(e){_.each(this.oMessages,function(t){var i=t.oFrom.aCollection;i.length>0&&i[0].sEmail===e&&t.alwaysShowExternalPicturesForSender()},this)},CFolderModel.prototype.executeGroupOperation=function(e,t,i){var s=0;_.each(this.oMessages,function(o){t.length>0?_.each(t,function(t){o&&o.uid()===t&&o[e]()!==i&&(o[e](i),s++)}):o[e](i)}),0===t.length&&(s=i?this.unseenMessageCount():this.messageCount()-this.unseenMessageCount()),"seen"===e&&s>0&&(i?this.addMessagesCountsDiff(0,-s):this.addMessagesCountsDiff(0,s),this.markHasChanges())},CFolderModel.prototype.emptyFolder=function(){var e=Utils.i18n("MAILBOX/CONFIRM_EMPTY_FOLDER"),t=_.bind(this.clearFolder,this);this.enableEmptyFolder()&&App.Screens.showPopup(ConfirmPopup,[e,t])},CFolderModel.prototype.clearFolder=function(e){var t={Action:"FolderClear",Folder:this.fullName()};this.enableEmptyFolder()&&e&&(App.Ajax.send(t),this.removeAllMessages(),App.MailCache.onClearFolder(this))},CFolderModel.prototype.getNameWhithLevel=function(){var e=this.iLevel;return!this.bNamespace&&e>0&&e--,Utils.strRepeat(" ",3*e)+this.name()},CFolderModel.prototype.onAccordion=function(e,t){var i=!this.expanded(),s=App.Storage.getData("folderAccordion")||[];i?s.push(this.name()):s=_.reject(s,function(e){return e===this.name()},this),App.Storage.setData("folderAccordion",s),this.expanded(i),App.MailCache.countMessages(this),t&&t.stopPropagation()},CFolderModel.prototype.executeUnseenFilter=function(){var e=!1;return this.messageCountToShow()>this.unseenMessageCount()&&this.onAccordion(),!(this.showUnseenMessages()&&this.unseenMessageCount()>0)||(App.MailCache.waitForUnseenMessages(!0),e=App.Routing.setHash(App.Links.mailbox(this.fullName(),1,"","",Enums.FolderFilter.Unseen)),e&&App.MailCache.changeCurrentMessageList(this.fullName(),1,"",Enums.FolderFilter.Unseen),!1)},CFolderModel.prototype.triggerTemplateState=function(){if(AppData.App.AllowTemplateFolders){this.isTemplateStorage()?(this.type(Enums.FolderTypes.User),this.isTemplateStorage(!1)):(this.type(Enums.FolderTypes.Template),this.isTemplateStorage(!0)),App.MailCache.changeTemplateFolder(this.fullName(),this.isTemplateStorage());var e={Action:"FolderSetTemplateType",Folder:this.fullName(),Remove:this.isTemplateStorage()?"0":"1"};App.Ajax.send(e,this.onFolderSetTemplateType,this)}},CFolderModel.prototype.onFolderSetTemplateType=function(e){e.Result||(App.Api.showErrorByCode(e,Utils.i18n("SETTINGS/ERROR_SETTINGS_SAVING_FAILED")),App.MailCache.getFolderList(AppData.Accounts.editedId()))},CFolderListModel.prototype.getTotalMessageCount=function(){var e=0;return _.each(this.oNamedCollection,function(t){e+=t.messageCount()},this),e},CFolderListModel.prototype.getFoldersWithoutCountInfo=function(){var e=_.compact(_.map(this.oNamedCollection,function(e,t){return e.bCanBeSelected&&!e.hasExtendedInfo()?t:null}));return e},CFolderListModel.prototype.setCurrentFolder=function(e,t){var i=this.getFolderByFullName(e);null===i&&(i=this.inboxFolder()),null!==i&&(this.currentFolder()&&(this.currentFolder().selected(!1),this.oStarredFolder&&this.oStarredFolder.selected(!1)),this.currentFolder(i),t===Enums.FolderFilter.Flagged?this.oStarredFolder&&this.oStarredFolder.selected(!0):this.currentFolder().selected(!0))},CFolderListModel.prototype.getFolderByFullName=function(e){var t=this.oNamedCollection[e];return t?t:null},CFolderListModel.prototype.parse=function(e,t,i){var s=Utils.pString(t.Namespace);s.length>0&&(this.sNamespaceFolder=s.substring(0,s.length-1)),this.iAccountId=e,this.bInitialized(!0),this.expandFolders(AppData.MailExpandFolders&&!App.Storage.hasData("folderAccordion")),App.Storage.hasData("folderAccordion")||App.Storage.setData("folderAccordion",[]),this.oNamedCollection={},this.aLinedCollection=[],this.collection(this.parseRecursively(t["@Collection"],i))},CFolderListModel.prototype.changeTemplateFolder=function(e,t){AppData.App.AllowTemplateFolders&&(t?this.aTemplateFolders.push(e):this.aTemplateFolders=_.without(this.aTemplateFolders,e))},CFolderListModel.prototype.parseRecursively=function(e,t,i,s){var o=this,n=[],a=0,r=0,l=null,h=null,c="",p=null,d=[],u=this.expandFolders(),m=AppData.Accounts.getAccount(this.iAccountId),g=m.extensionExists("DisableManageSubscribe"),A=function(){var e=o.spamFolder();m&&m.extensionExists("AllowSpamFolderExtension")||(e.type(Enums.FolderTypes.User),o.spamFolder(null))},f=function(){m&&m.extensionsRequested()&&(A(),m.extensionsRequestedSubscription.dispose(),m.extensionsRequestedSubscription=void 0)};if(s=s||"",Utils.isUnd(i)&&(i=-1),i++,_.isArray(e)){for(r=e.length;a<r;a++){switch(c=Utils.pString(e[a].FullNameRaw),h=t[c],l=new CFolderModel(this.iAccountId),p=l.parse(e[a],s,g,this.sNamespaceFolder),h&&h.hasExtendedInfo()&&!l.hasExtendedInfo()&&l.setRelevantInformation(h.sUidNext,h.sHash,h.messageCount(),h.unseenMessageCount(),!1),u&&null!==p&&(l.expanded(!0),this.expandNames().push(Utils.pString(e[a].Name))),l.setLevel(i),l.type()){case Enums.FolderTypes.Inbox:this.inboxFolder(l),this.sDelimiter=l.sDelimiter;break;case Enums.FolderTypes.Sent:this.sentFolder(l);break;case Enums.FolderTypes.Drafts:this.draftsFolder(l);break;case Enums.FolderTypes.Trash:this.trashFolder(l);break;case Enums.FolderTypes.Spam:this.spamFolder(l),m.extensionsRequested()?A():m.extensionsRequestedSubscription=m.extensionsRequested.subscribe(f);break;case Enums.FolderTypes.Template:this.aTemplateFolders.push(l.fullName())}this.oNamedCollection[l.fullName()]=l,this.aLinedCollection.push(l),n.push(l),null===p&&l.type()===Enums.FolderTypes.Inbox?(this.createStarredFolder(l.fullName(),i),this.oStarredFolder&&n.push(this.oStarredFolder)):null!==p&&(d=this.parseRecursively(p["@Collection"],t,i,l.fullName()),l.type()===Enums.FolderTypes.Inbox&&(l.bNamespace?(this.createStarredFolder(l.fullName(),i+1),this.oStarredFolder&&d.unshift(this.oStarredFolder)):(this.createStarredFolder(l.fullName(),i),this.oStarredFolder&&n.push(this.oStarredFolder))),l.subfolders(d))}u&&App.Storage.setData("folderAccordion",this.expandNames())}return n},CFolderListModel.prototype.createStarredFolder=function(e,t){this.oStarredFolder=new CFolderModel(this.iAccountId),this.oStarredFolder.initStarredFolder(t,e)},CFolderListModel.prototype.repopulateLinedCollection=function(){function e(i){_.each(i,function(i){t.aLinedCollection.push(i),i.subfolders().length>0&&e(i.subfolders())})}var t=this;return this.aLinedCollection=[],e(this.collection()),this.aLinedCollection},CFolderListModel.prototype.getOptions=function(e,t,i,s,o){t=t||!1,i=i||!1,s=s||!1,o=o||!1;var n="    ",a=[];return _.each(this.aLinedCollection,function(e){if(e&&!e.bVirtual&&(!i||Enums.FolderTypes.Inbox!==e.type())&&(!o||e.subscribed())){var r=new Array(e.iLevel+1).join(n);a.push({name:e.name(),fullName:e.fullName(),displayName:r+e.name(),translatedDisplayName:r+e.displayName(),disable:!t&&e.isSystem()||!s&&!e.bCanBeSelected})}}),""!==e&&a.unshift({name:e,fullName:"",displayName:e,translatedDisplayName:e,disable:!1}),a},CFolderListModel.prototype.deleteFolder=function(e){var t=function(i){return!(!e||e.fullName()!==i.fullName())||(i.subfolders.remove(t),!1)};this.collection.remove(t)},CMessageModel.prototype.viewMessage=function(e){var t=this.getDomText(Utils.Common.getAppPath());this.textBodyForNewWindow(t.html()),e&&(Utils.Message.displayPrintMessageInWindow(e,$(this.domMessageForPrint()).html()),e.focus(),_.each(this.attachments(),function(t){var i=$(e.document.body).find("[data-hash='download-"+t.hash()+"']");i.on("click",_.bind(t.downloadFile,t,App)),i=$(e.document.body).find("[data-hash='view-"+t.hash()+"']"),i.on("click",_.bind(t.viewFile,t))},this))},CMessageModel.prototype.fillFromOrToText=function(){var e=App.MailCache.folderList(),t=e?e.getFolderByFullName(this.folder()):null,i=e?e.sentFolder():null,s=e?e.draftsFolder():null,o=AppData.Accounts.getAccount(this.accountId());t&&(i&&t.fullName().indexOf(i.fullName())!==-1||s&&t.fullName().indexOf(s.fullName())!==-1)?this.fromOrToText(this.oTo.getDisplay(Utils.i18n("MESSAGE/ME_RECIPIENT"),o.email())):this.fromOrToText(this.oFrom.getDisplay(Utils.i18n("MESSAGE/ME_SENDER"),o.email()))},CMessageModel.prototype.changeThreadUids=function(e,t){this.threadUids(e),this.threadLoading(t<Math.min(this.threadUids().length,this.threadCountForLoad()))},CMessageModel.prototype.showNextLoadingLink=function(e){this.threadNextLoadingLinkVisible()&&(this.threadNextLoadingVisible(!0),this.threadFunctionLoadNext=e)},CMessageModel.prototype.increaseThreadCountForLoad=function(){this.threadCountForLoad(this.threadCountForLoad()+15),App.MailCache.showOpenedThreads(this.folder())},CMessageModel.prototype.loadNextMessages=function(){this.threadFunctionLoadNext&&(this.threadFunctionLoadNext(),this.threadNextLoadingLinkVisible(!1),this.threadFunctionLoadNext=null)},CMessageModel.prototype.markAsThreadPart=function(e,t){var i=this;this.threadPart(!0),this.threadParentUid(t),this.threadUids([]),this.threadNextLoadingVisible(!1),this.threadNextLoadingLinkVisible(!0),this.threadFunctionLoadNext=null,this.threadHideAnimation(!1),setTimeout(function(){i.threadShowAnimation(!0)},e)},CMessageModel.prototype.parse=function(e,t,i,s){var o=null,n=null,a="",r="";s&&this.threadPart(i),this.threadPart()||this.threadParentUid(""),"Object/MessageListItem"===e["@Object"]&&(this.seen(!!e.IsSeen),this.flagged(!!e.IsFlagged),this.answered(!!e.IsAnswered),this.forwarded(!!e.IsForwarded),e.Custom&&(this.Custom=e.Custom)),"Object/Message"!==e["@Object"]&&"Object/MessageListItem"!==e["@Object"]||(this.accountId(t),this.folder(e.Folder),this.uid(Utils.pString(e.Uid)),this.subject(Utils.pString(e.Subject)),this.messageId(Utils.pString(e.MessageId)),this.size(e.Size),this.textSize(e.TextSize),this.oDateModel.parse(e.TimeStampInUTC),this.oFrom.parse(e.From),this.oTo.parse(e.To),this.fillFromOrToText(),this.oCc.parse(e.Cc),this.oBcc.parse(e.Bcc),this.oSender.parse(e.Sender),this.oReplyTo.parse(e.ReplyTo),this.fullDate(this.oDateModel.getFullDate()),this.fullFrom(this.oFrom.getFull()),this.to(this.oTo.getFull()),this.cc(this.oCc.getFull()),this.bcc(this.oBcc.getFull()),this.hasAttachments(!!e.HasAttachments),this.hasIcalAttachment(!!e.HasIcalAttachment),this.hasVcardAttachment(!!e.HasVcardAttachment),"Object/MessageListItem"===e["@Object"]&&s&&this.threadUids(_.map(e.Threads,function(e){return e.toString()},this)),this.importance(e.Priority),_.isArray(e.DraftInfo)&&this.draftInfo(e.DraftInfo),this.sensitivity(e.Sensitivity),this.hash(Utils.pString(e.Hash)),"Object/Message"===e["@Object"]&&(this.trimmed(e.Trimmed),this.trimmedTextSize(e.TrimmedTextSize),this.inReplyTo(e.InReplyTo),this.references(e.References),this.readingConfirmation(e.ReadingConfirmation),a=Utils.pString(e.Html),r=Utils.pString(e.Plain),""!==a?(this.text(a),this.isPlain(!1)):(this.textRaw(e.PlainRaw),this.textRaw().indexOf("-----BEGIN PGP MESSAGE-----")!==-1?(this.text("<pre>"+Utils.encodeHtml(this.textRaw())+"</pre>"),this.encryptedMessage(!0)):this.textRaw().indexOf("-----BEGIN PGP SIGNED MESSAGE-----")!==-1?(this.text("<pre>"+Utils.encodeHtml(this.textRaw())+"</pre>"),this.signedMessage(!0)):this.text(""!==r?"<div>"+r+"</div>":""),this.isPlain(!0)),this.$text=null,this.isExternalsShown(!1),this.rtl(e.Rtl),this.hasExternals(!!e.HasExternals),this.foundCids(e.FoundedCIDs),this.parseAttachments(e.Attachments,t),this.safety(e.Safety),this.sourceHeaders(e.Headers),null!==e.ICAL&&(o=new CIcalModel,o.parse(e.ICAL,AppData.Accounts.getAttendee(this.oTo.getEmails())),this.ical(o)),null!==e.VCARD&&(n=new CVcardModel,n.parse(e.VCARD),this.vcard(n)),this.completelyFilled(!0)),this.updateMomentDate())},CMessageModel.prototype.updateMomentDate=function(){this.date(this.oDateModel.getShortDate(moment().clone().subtract(1,"days").format("L")===moment.unix(this.oDateModel.getTimeStampInUTC()).format("L")))},CMessageModel.prototype.getDomText=function(e,t){var i=this.$text;return e=e||"",null!==this.$text&&""===e||(this.completelyFilled()?(this.$text=$(this.text()),this.showInlinePictures(e),this.safety()===!0&&this.alwaysShowExternalPicturesForSender(),t&&this.isExternalsShown()&&this.showExternalPictures(),i=this.$text):i=$("")),i.clone()},CMessageModel.prototype.getConvertedHtml=function(e,t){var i=this.getDomText(e,t);return i.length>0?i.wrap("<p>").parent().html():""},CMessageModel.prototype.parseAttachments=function(e,t){if(_.isArray(e)){var i=Date.now().toString();this.attachments(_.map(e,function(e){var s=new CMailAttachmentModel;return s.parse(e,t),s.getInThumbQueue(i),s.setMessageData(this.folder(),this.uid()),s},this))}},CMessageModel.prototype.parseAddressArray=function(e){var t=[];return _.isArray(e)&&(t=_.map(e,function(e){var t=new CAddressModel;return t.parse(e),t})),t},CMessageModel.prototype.showInlinePictures=function(e){var t=_.map(this.attachments(),function(e){return{CID:e.cid(),ContentLocation:e.contentLocation(),ViewLink:e.viewLink()}});Utils.Message.showInlinePictures(this.$text,t,this.foundCids(),e)},CMessageModel.prototype.showExternalPictures=function(){Utils.Message.showExternalPictures(this.$text),this.isExternalsShown(!0)},CMessageModel.prototype.alwaysShowExternalPicturesForSender=function(){this.completelyFilled()&&(this.isExternalsAlwaysShown(!0),this.isExternalsShown()||this.showExternalPictures())},CMessageModel.prototype.openThread=function(){if(this.threadCountVisible()){var e=this.folder();this.threadOpened(!this.threadOpened()),this.threadOpened()?App.MailCache.showOpenedThreads(e):(App.MailCache.hideThreads(this),setTimeout(function(){App.MailCache.showOpenedThreads(e)},500))}},CMessageModel.prototype.downloadAllAttachments=function(){if(""!==this.allAttachmentsHash)App.Api.downloadByUrl(Utils.getDownloadLinkByHash(this.accountId(),this.allAttachmentsHash));else{var e=_.filter(this.attachments(),function(e){return!e.linked()}),t=_.map(e,function(e){return e.hash()});App.Ajax.send({Action:"MessageAttachmentsZip",Hashes:t},this.onMessageZipAttachments,this)}},CMessageModel.prototype.onMessageZipAttachments=function(e,t){e.Result&&(this.allAttachmentsHash=e.Result,App.Api.downloadByUrl(Utils.getDownloadLinkByHash(this.accountId(),this.allAttachmentsHash)))},CMessageModel.prototype.saveAttachmentsToFiles=function(){var e=_.filter(this.attachments(),function(e){return!e.linked()}),t=_.map(e,function(e){return e.hash()});App.filesRecievedAnim(!0),App.Ajax.send({Action:"MessageAttachmentsSaveToFiles",Attachments:t},this.onMessageAttachmentsSaveToFilesResponse,this)},CMessageModel.prototype.onMessageAttachmentsSaveToFilesResponse=function(e,t){var i=0,s=t.Attachments.length;e.Result&&_.each(t.Attachments,function(t){void 0!==e.Result[t]&&i++}),0===i?App.Api.showError(Utils.i18n("MESSAGE/ERROR_ATTACHMENTS_SAVED_TO_FILES")):i<s?App.Api.showError(Utils.i18n("MESSAGE/WARNING_ATTACHMENTS_SAVED_TO_FILES",{SAVED_COUNT:i,TOTAL_COUNT:s})):App.Api.showReport(Utils.i18n("MESSAGE/REPORT_ATTACHMENTS_SAVED_TO_FILES"))},CMessageModel.prototype.downloadAllAttachmentsSeparately=function(){_.each(this.attachments(),function(e){e.linked()||e.downloadFile(App)})},CMessageModel.prototype.toJSON=function(){return{uid:this.uid(),accountId:this.accountId(),to:this.to(),subject:this.subject(),threadPart:this.threadPart(),threadUids:this.threadUids(),threadOpened:this.threadOpened()}},CUidListModel.prototype.addThreadUids=function(e,t){-1!==_.indexOf(this.collection(),e)&&(this.threadUids[e]=t)},CUidListModel.prototype.setUidsAndCount=function(e){"Collection/MessageCollection"===e["@Object"]&&(_.each(e.Uids,function(t,i){this.collection()[i+e.Offset]=t.toString()},this),this.resultCount(e.MessageResultCount))},CUidListModel.prototype.getUidsForOffset=function(e,t){for(var i=0,s=this.collection().length,o="",n=0,a=[],r=null;i<s;i++)i>=e&&n<AppData.User.MailsPerPage&&(o=this.collection()[i],r=t[o],(r&&!r.deleted()||void 0===o)&&(n++,void 0!==o&&a.push(o)));return a},CUidListModel.prototype.deleteUids=function(e){for(var t=0,i=this.collection().length,s="",o=[],n=0;t<i;t++)s=this.collection()[t],_.indexOf(e,s)===-1?o.push(s):n++;this.collection(o),this.resultCount(this.resultCount()-n)},CIcalModel.prototype.fillDecisions=function(){var e=AppData.Accounts.getCurrent(),t=e?e.email():"";switch(this.cancelDecision(Utils.i18n("MESSAGE/APPOINTMENT_CANCELED",{SENDER:t})),this.icalConfig()){case Enums.IcalConfig.Accepted:this.replyDecision(Utils.i18n("MESSAGE/APPOINTMENT_ACCEPTED",{ATTENDEE:this.attendee()}));break;case Enums.IcalConfig.Declined:this.replyDecision(Utils.i18n("MESSAGE/APPOINTMENT_DECLINED",{ATTENDEE:this.attendee()}));break;case Enums.IcalConfig.Tentative:this.replyDecision(Utils.i18n("MESSAGE/APPOINTMENT_TENTATIVELY_ACCEPTED",{ATTENDEE:this.attendee()}))}},CIcalModel.prototype.parse=function(e,t){var i="";e&&"Object/CApiMailIcs"===e["@Object"]&&(i=Utils.pString(e.Description),this.uid(Utils.pString(e.Uid)),this.sSequence=Utils.pInt(e.Sequence),this.file(Utils.pString(e.File)),this.attendee(Utils.pString(e.Attendee)||t),this.type(e.Type),this.location(Utils.pString(e.Location)),this.description(i.replace(/\r/g,"").replace(/\n/g,"<br />")),this.when(Utils.pString(e.When)),this.calendarId(Utils.pString(e.CalendarId)),this.selectedCalendarId(Utils.pString(e.CalendarId)),App.CalendarCache.addIcal(this))},CIcalModel.prototype.acceptAppointment=function(){this.calendarId(this.selectedCalendarId()),this.changeAndSaveConfig(Enums.IcalConfig.Accepted)},CIcalModel.prototype.tentativeAppointment=function(){this.calendarId(this.selectedCalendarId()),this.changeAndSaveConfig(Enums.IcalConfig.Tentative)},CIcalModel.prototype.declineAppointment=function(){this.calendarId(""),this.selectedCalendarId(""),this.changeAndSaveConfig(Enums.IcalConfig.Declined)},CIcalModel.prototype.changeAndSaveConfig=function(e){this.icalConfig()!==e&&(this.icalConfig()===e||e===Enums.IcalConfig.Declined&&this.icalConfig()===Enums.IcalConfig.NeedsAction||App.CalendarCache.recivedAnim(!0),this.changeConfig(e),this.setAppointmentAction())},CIcalModel.prototype.changeConfig=function(e){this.type(this.icalType()+"-"+e),AppData.SingleMode&&window.opener&&window.opener.App?window.opener.App.CalendarCache.markIcalTypeByFile(this.file(),this.type(),this.cancelDecision(),this.replyDecision(),this.calendarId(),this.selectedCalendarId()):App.CalendarCache.markIcalTypeByFile(this.file(),this.type(),this.cancelDecision(),this.replyDecision(),this.calendarId(),this.selectedCalendarId())},CIcalModel.prototype.onCalendarAppointmentSetActionResponse=function(e,t){e.Result?App.CalendarCache&&App.CalendarCache.calendarChanged(!0):App.Api.showErrorByCode(e,Utils.i18n("WARNING/UNKNOWN_ERROR"))},CIcalModel.prototype.setAppointmentAction=function(){var e={Action:"CalendarAppointmentSetAction",AppointmentAction:this.icalConfig(),CalendarId:this.selectedCalendarId(),File:this.file(),Attendee:this.attendee()};App.Ajax.send(e,this.onCalendarAppointmentSetActionResponse,this)},CIcalModel.prototype.onCalendarSaveIcsResponse=function(e,t){e.Result?(e.Result.Uid&&this.uid(e.Result.Uid),App.CalendarCache&&App.CalendarCache.calendarChanged(!0)):App.Api.showErrorByCode(e)},CIcalModel.prototype.addEvent=function(){var e={Action:"CalendarSaveIcs",CalendarId:this.selectedCalendarId(),File:this.file()};App.Ajax.send(e,this.onCalendarSaveIcsResponse,this),this.isJustSaved(!0),this.calendarId(this.selectedCalendarId()),setTimeout(_.bind(function(){this.isJustSaved(!1)},this),2e4),App.CalendarCache.recivedAnim(!0)},CIcalModel.prototype.onEventDelete=function(){this.calendarId(""),this.selectedCalendarId(""),this.changeConfig(Enums.IcalConfig.NeedsAction)},CIcalModel.prototype.onEventTentative=function(){this.changeConfig(Enums.IcalConfig.Tentative)},CIcalModel.prototype.onEventAccept=function(){this.changeConfig(Enums.IcalConfig.Accepted)},CIcalModel.prototype.firstCalendarName=function(){return this.calendars()[0]?this.calendars()[0].name:""},CIcalModel.prototype.updateAttendeeStatus=function(e){if(this.icalType()===Enums.IcalType.Cancel||this.icalType()===Enums.IcalType.Reply){var t={Action:"CalendarAttendeeUpdateStatus",File:this.file(),FromEmail:e};App.Ajax.send(t,this.onCalendarAttendeeUpdateStatusResponse,this)}},CIcalModel.prototype.onCalendarAttendeeUpdateStatusResponse=function(e,t){e.Result&&App.CalendarCache&&(App.CalendarCache.recivedAnim(!0),App.CalendarCache.calendarChanged(!0))},CVcardModel.prototype.parse=function(e){e&&"Object/CApiMailVcard"===e["@Object"]&&(this.uid(Utils.pString(e.Uid)),this.file(Utils.pString(e.File)),this.name(Utils.pString(e.Name)),this.email(Utils.pString(e.Email)),this.exists(!!e.Exists),App.ContactsCache.addVcard(this))},CVcardModel.prototype.onContactsSaveVcfResponse=function(e,t){e&&e.Result&&e.Result.Uid&&this.uid(e.Result.Uid)},CVcardModel.prototype.addContact=function(){var e={Action:"ContactsSaveVcf",File:this.file()};App.Ajax.send(e,this.onContactsSaveVcfResponse,this),this.isJustSaved(!0),this.exists(!0),setTimeout(_.bind(function(){this.isJustSaved(!1)},this),2e4),App.ContactsCache.recivedAnim(!0),AppData.SingleMode&&window.opener&&window.opener.App?window.opener.App.ContactsCache.markVcardExistentByFile(this.file()):App.ContactsCache.markVcardExistentByFile(this.file())},CContactModel.birthdayMonths=Utils.getMonthNamesArray(),CContactModel.birthdayMonthSelect=[{text:Utils.i18n("DATETIME/MONTH"),value:"0"},{text:CContactModel.birthdayMonths[0],value:"1"},{text:CContactModel.birthdayMonths[1],value:"2"},{text:CContactModel.birthdayMonths[2],value:"3"},{text:CContactModel.birthdayMonths[3],value:"4"},{text:CContactModel.birthdayMonths[4],value:"5"},{text:CContactModel.birthdayMonths[5],value:"6"},{text:CContactModel.birthdayMonths[6],value:"7"},{text:CContactModel.birthdayMonths[7],value:"8"},{text:CContactModel.birthdayMonths[8],value:"9"},{text:CContactModel.birthdayMonths[9],value:"10"},{text:CContactModel.birthdayMonths[10],value:"11"},{text:CContactModel.birthdayMonths[11],value:"12"}],CContactModel.birthdayYearSelect=[{text:Utils.i18n("DATETIME/YEAR"),value:"0"}],CContactModel.prototype.getSendMailParts=function(e){return App.Links.composeWithToField(this.getFullEmail(e))},CContactModel.prototype.getSendMailLink=function(e){return App.Routing.buildHashFromArray(this.getSendMailParts(e))},CContactModel.prototype.sendMail=function(){return App.Api.composeMessageToAddresses(this.email()),bMobileApp},CContactModel.prototype.sendMailToPersonal=function(){return App.Api.composeMessageToAddresses(this.personalEmail()),bMobileApp},CContactModel.prototype.sendMailToBusiness=function(){return App.Api.composeMessageToAddresses(this.businessEmail()),bMobileApp},CContactModel.prototype.sendMailToOther=function(){return App.Api.composeMessageToAddresses(this.otherEmail()),bMobileApp},CContactModel.prototype.clear=function(){this.isNew(!1),this.readOnly(!1),this.idContact(""),this.idUser(""),this.global(!1),this.itsMe(!1),this.edited(!1),this.extented(!1),this.personalCollapsed(!1),this.businessCollapsed(!1),this.otherCollapsed(!1),this.groupsCollapsed(!1),this.displayName(""),this.firstName(""),this.lastName(""),this.nickName(""),this.skype(""),this.facebook(""),this.primaryEmail(this.sEmailDefaultType),this.primaryPhone(this.sPhoneDefaultType),this.primaryAddress(this.sAddressDefaultType),this.personalEmail(""),this.personalStreetAddress(""),this.personalCity(""),this.personalState(""),this.personalZipCode(""),this.personalCountry(""),this.personalWeb(""),this.personalFax(""),this.personalPhone(""),this.personalMobile(""),this.businessEmail(""),this.businessCompany(""),this.businessDepartment(""),this.businessJob(""),this.businessOffice(""),this.businessStreetAddress(""),this.businessCity(""),this.businessState(""),this.businessZipCode(""),this.businessCountry(""),this.businessWeb(""),this.businessFax(""),this.businessPhone(""),this.otherEmail(""),this.otherBirthdayMonth("0"),this.otherBirthdayDay("0"),this.otherBirthdayYear("0"),this.otherNotes(""),this.etag(""),this.sharedToAll(!1),this.groups([])},CContactModel.prototype.switchToNew=function(){this.clear(),this.edited(!0),this.extented(!1),this.isNew(!0),bMobileApp||this.displayNameFocused(!0)},CContactModel.prototype.switchToView=function(){this.edited(!1),this.extented(!1)},CContactModel.prototype.toObject=function(){var e={ContactId:this.idContact(),PrimaryEmail:this.primaryEmail(),PrimaryPhone:this.primaryPhone(),PrimaryAddress:this.primaryAddress(),UseFriendlyName:"1",Title:"",FullName:this.displayName(),FirstName:this.firstName(),LastName:this.lastName(),NickName:this.nickName(),Global:this.global()?"1":"0",ItsMe:this.itsMe()?"1":"0",Skype:this.skype(),Facebook:this.facebook(),HomeEmail:this.personalEmail(),HomeStreet:this.personalStreetAddress(),HomeCity:this.personalCity(),HomeState:this.personalState(),HomeZip:this.personalZipCode(),HomeCountry:this.personalCountry(),HomeFax:this.personalFax(),HomePhone:this.personalPhone(),HomeMobile:this.personalMobile(),HomeWeb:this.personalWeb(),BusinessEmail:this.businessEmail(),BusinessCompany:this.businessCompany(),BusinessJobTitle:this.businessJob(),BusinessDepartment:this.businessDepartment(),BusinessOffice:this.businessOffice(),BusinessStreet:this.businessStreetAddress(),BusinessCity:this.businessCity(),BusinessState:this.businessState(),
BusinessZip:this.businessZipCode(),BusinessCountry:this.businessCountry(),BusinessFax:this.businessFax(),BusinessPhone:this.businessPhone(),BusinessWeb:this.businessWeb(),OtherEmail:this.otherEmail(),Notes:this.otherNotes(),ETag:this.etag(),BirthdayDay:this.otherBirthdayDay(),BirthdayMonth:this.otherBirthdayMonth(),BirthdayYear:this.otherBirthdayYear(),SharedToAll:this.sharedToAll()?"1":"0",GroupsIds:this.groups()};return e},CContactModel.prototype.parse=function(e){if(e&&"Object/CContact"===e["@Object"]){var t=0,i=0,s=0,o=[];switch(this.idContact(Utils.pExport(e,"IdContact","").toString()),this.idUser(Utils.pExport(e,"IdUser","").toString()),this.global(!!Utils.pExport(e,"Global",!1)),this.itsMe(!!Utils.pExport(e,"ItsMe",!1)),this.readOnly(!!Utils.pExport(e,"ReadOnly",!1)),this.displayName(Utils.pExport(e,"FullName","")),this.firstName(Utils.pExport(e,"FirstName","")),this.lastName(Utils.pExport(e,"LastName","")),this.nickName(Utils.pExport(e,"NickName","")),this.skype(Utils.pExport(e,"Skype","")),this.facebook(Utils.pExport(e,"Facebook","")),t=Utils.pInt(Utils.pExport(e,"PrimaryEmail",0))){case 1:t=Enums.ContactEmailType.Business;break;case 2:t=Enums.ContactEmailType.Other;break;default:case 0:t=Enums.ContactEmailType.Personal}switch(this.primaryEmail(t),i=Utils.pInt(Utils.pExport(e,"PrimaryPhone",0))){case 2:i=Enums.ContactPhoneType.Business;break;case 1:i=Enums.ContactPhoneType.Personal;break;default:case 0:i=Enums.ContactPhoneType.Mobile}switch(this.primaryPhone(i),s=Utils.pInt(Utils.pExport(e,"PrimaryAddress",0))){case 1:s=Enums.ContactAddressType.Business;break;default:case 0:s=Enums.ContactAddressType.Personal}this.primaryAddress(s),this.personalEmail(Utils.pExport(e,"HomeEmail","")),this.personalStreetAddress(Utils.pExport(e,"HomeStreet","")),this.personalCity(Utils.pExport(e,"HomeCity","")),this.personalState(Utils.pExport(e,"HomeState","")),this.personalZipCode(Utils.pExport(e,"HomeZip","")),this.personalCountry(Utils.pExport(e,"HomeCountry","")),this.personalWeb(Utils.pExport(e,"HomeWeb","")),this.personalFax(Utils.pExport(e,"HomeFax","")),this.personalPhone(Utils.pExport(e,"HomePhone","")),this.personalMobile(Utils.pExport(e,"HomeMobile","")),this.businessEmail(Utils.pExport(e,"BusinessEmail","")),this.businessCompany(Utils.pExport(e,"BusinessCompany","")),this.businessDepartment(Utils.pExport(e,"BusinessDepartment","")),this.businessJob(Utils.pExport(e,"BusinessJobTitle","")),this.businessOffice(Utils.pExport(e,"BusinessOffice","")),this.businessStreetAddress(Utils.pExport(e,"BusinessStreet","")),this.businessCity(Utils.pExport(e,"BusinessCity","")),this.businessState(Utils.pExport(e,"BusinessState","")),this.businessZipCode(Utils.pExport(e,"BusinessZip","")),this.businessCountry(Utils.pExport(e,"BusinessCountry","")),this.businessWeb(Utils.pExport(e,"BusinessWeb","")),this.businessFax(Utils.pExport(e,"BusinessFax","")),this.businessPhone(Utils.pExport(e,"BusinessPhone","")),this.otherEmail(Utils.pExport(e,"OtherEmail","")),this.otherBirthdayMonth(Utils.pExport(e,"BirthdayMonth","0").toString()),this.otherBirthdayDay(Utils.pExport(e,"BirthdayDay","0").toString()),this.otherBirthdayYear(Utils.pExport(e,"BirthdayYear","0").toString()),this.otherNotes(Utils.pExport(e,"Notes","")),this.etag(Utils.pExport(e,"ETag","")),this.sharedToAll(!!Utils.pExport(e,"SharedToAll",!1)),o=Utils.pExport(e,"GroupsIds",[]),_.isArray(o)&&this.groups(_.map(o,function(e){return Utils.pString(e)}))}},CContactModel.prototype.getFullEmail=function(e){return Utils.Address.getFullEmail(this.displayName(),e)},CContactModel.prototype.getEmailsString=function(){return _.uniq(_.without([this.email(),this.personalEmail(),this.businessEmail(),this.otherEmail()],"")).join(",")},CContactModel.prototype.viewAllMails=function(){App.MailCache.searchMessagesInInbox("email:"+this.getEmailsString())},CContactModel.prototype.sendThisContact=function(){App.Api.composeMessageWithVcard(this)},CContactModel.prototype.isStrLink=function(e){return/^http/.test(e)},CContactModel.prototype.onCallClick=function(e){App.Phone.call(e)},CContactModel.prototype.viewAllMailsWithContact=function(){var e=this.getEmailsString();AppData.SingleMode&&window.opener&&window.opener.App?(window.opener.App.MailCache.searchMessagesInCurrentFolder("email:"+e),window.opener.focus(),window.close()):App.MailCache.searchMessagesInCurrentFolder("email:"+e)},CGroupModel.prototype.clear=function(){this.isNew(!1),this.idGroup(""),this.idUser(""),this.name(""),this.nameFocused(!1),this.edited(!1),this.isOrganization(!1),this.email(""),this.country(""),this.city(""),this.company(""),this.fax(""),this.phone(""),this.state(""),this.street(""),this.web(""),this.zip(""),this.events([])},CGroupModel.prototype.populate=function(e){this.isNew(e.isNew()),this.idGroup(e.idGroup()),this.idUser(e.idUser()),this.name(e.name()),this.nameFocused(e.nameFocused()),this.edited(e.edited()),this.isOrganization(e.isOrganization()),this.email(e.email()),this.country(e.country()),this.city(e.city()),this.company(e.company()),this.fax(e.fax()),this.phone(e.phone()),this.state(e.state()),this.street(e.street()),this.web(e.web()),this.zip(e.zip())},CGroupModel.prototype.switchToNew=function(){this.clear(),this.edited(!0),this.isNew(!0),bMobileApp||this.nameFocused(!0)},CGroupModel.prototype.switchToView=function(){this.edited(!1)},CGroupModel.prototype.toObject=function(){return{GroupId:this.idGroup(),Name:this.name(),IsOrganization:this.isOrganization()?"1":"0",Email:this.email(),Country:this.country(),City:this.city(),Company:this.company(),Fax:this.fax(),Phone:this.phone(),State:this.state(),Street:this.street(),Web:this.web(),Zip:this.zip()}},CContactListItemModel.prototype.parse=function(e){e&&"Object/CContactListItem"===Utils.pExport(e,"@Object","")&&(this.sId=Utils.pString(e.Id),this.sName=Utils.pString(e.Name),this.sEmail=Utils.pString(e.Email),this.bIsGroup=!!e.IsGroup,this.bIsOrganization=!!e.IsOrganization,this.bReadOnly=!!e.ReadOnly,this.bItsMe=!!e.ItsMe,this.bGlobal=!!e.Global,this.bSharedToAll=!!e.SharedToAll,this.groupType(this.getGroupType(e)))},CContactListItemModel.prototype.IsGroup=function(){return this.bIsGroup},CContactListItemModel.prototype.Global=function(){return this.bGlobal},CContactListItemModel.prototype.ReadOnly=function(){return this.bReadOnly},CContactListItemModel.prototype.ItsMe=function(){return this.bItsMe},CContactListItemModel.prototype.Id=function(){return this.sId},CContactListItemModel.prototype.Name=function(){return this.sName},CContactListItemModel.prototype.Email=function(){return this.sEmail},CContactListItemModel.prototype.EmailAndName=function(){return Utils.Address.getFullEmail(this.sName,this.sEmail)},CContactListItemModel.prototype.IsSharedToAll=function(){return this.bSharedToAll},CContactListItemModel.prototype.IsOrganization=function(){return this.bIsOrganization},CContactListItemModel.prototype.getGroupType=function(e){return e.SharedToAll?Enums.ContactsGroupListType.SharedToAll:e.Global?Enums.ContactsGroupListType.Global:e.Global?null:Enums.ContactsGroupListType.Personal},CCalendarModel.prototype.parseCssColor=function(e){var t=Utils.pString(e);return t.length>7?t=t.substr(0,7):t.length>4&&t.length<7&&(t=t.substr(0,4)),4===t.length&&(t=t[0]+t[1]+t[1]+t[2]+t[2]+t[3]+t[3]),t.match(/^#[A-Fa-f0-9]{6}$/i)||(t="#f09650"),t},CCalendarModel.prototype.parse=function(e){this.id=Utils.pString(e.Id),this.cTag=e.CTag,this.name(Utils.pString(e.Name)),this.description(Utils.pString(e.Description)),this.owner(Utils.pString(e.Owner)),this.active(!App.Storage.hasData(this.id)||App.Storage.getData(this.id)),this.isDefault=!!e.IsDefault,this.access(e.Access),this.isShared(!!e.Shared),this.isSharedToAll(!!e.SharedToAll),this.sharedToAllAccess=e.SharedToAllAccess,this.isPublic(!!e.IsPublic),this.color(this.parseCssColor(e.Color)),this.url(Utils.pString(e.Url)),this.davUrl(Utils.pString(e.ServerUrl)),this.exportUrl(Utils.Common.getAppPath()+"?/Raw/Calendars/0/"+Utils.pString(e.ExportHash)),this.pubUrl(Utils.Common.getAppPath()+"?calendar-pub="+Utils.pString(e.PubHash)),this.shares(e.Shares||[]),this.addEmailToName=e.AddEmailToName,_.each(e.Events,function(e){this.addEvent(e)},this)},CCalendarModel.prototype.eventExists=function(e){return _.find(this.events(),function(t){return e===t.id})},CCalendarModel.prototype.updateEvent=function(e){var t=!1;return e&&(this.removeEvent(e.id),this.addEvent(e)),t},CCalendarModel.prototype.addEvent=function(e){e&&!this.eventExists(e.id)&&this.events.push(this.parseEvent(e))},CCalendarModel.prototype.getEvent=function(e){return _.find(this.events(),function(t){return t.id===e},this)},CCalendarModel.prototype.getEvents=function(e,t){var i=_.filter(this.events(),function(i){var s=e.unix(),o=t.unix(),n=moment.utc(i.start).unix(),a=moment.utc(i.end).unix();return n>=s&&a<=o||n<=s&&a>=o||n>=s&&n<=o||a<=o&&a>=s},this);return Utils.isUnd(i)&&(i=[]),i},CCalendarModel.prototype.removeEvent=function(e){this.events(_.filter(this.events(),function(t){return t.id!==e},this))},CCalendarModel.prototype.removeEventByUid=function(e,t){Utils.isUnd(t)&&(t=!1),this.events(_.filter(this.events(),function(i){return!(i.uid===e||t&&i.excluded)},this))},CCalendarModel.prototype.removeEvents=function(){this.events([])},CCalendarModel.prototype.expungeEvents=function(e,t,i){var s=[];_.each(this.getEvents(moment.unix(t),moment.unix(i)),function(t){_.include(e,t.id)||s.push(t.id)},this),this.events(_.filter(this.events(),function(e){return!_.include(s,e.id)},this))},CCalendarModel.prototype.isEditable=function(){return this.access()!==Enums.CalendarAccess.Read},CCalendarModel.prototype.isOwner=function(){return this.account&&this.account.email()===this.owner()},CCalendarModel.prototype.parseEvent=function(e){if(e.title=Utils.getTitleForEvent(e.subject),e.editable=!e.appointment,e.backgroundColor=e.borderColor=this.color(),!_.isArray(e.className)){var t=e.className;e.className=[t]}return this.access()===Enums.CalendarAccess.Read?(e.className.push("fc-event-readonly"),e.editable=!1):e.className=_.filter(e.className,function(e){return"fc-event-readonly"!==e}),e.rrule&&!e.excluded?e.className.push("fc-event-repeat"):e.className=_.filter(e.className,function(e){return"fc-event-repeat"!==e}),Utils.isNonEmptyArray(e.attendees)?e.className.push("fc-event-appointment"):e.className=_.filter(e.className,function(e){return"fc-event-appointment"!==e}),e},CCalendarModel.prototype.reloadEvents=function(){this.events(_.map(this.events(),function(e){return this.parseEvent(e)},this))},CCalendarModel.prototype.canShare=function(){return!this.isShared()||this.isShared()&&this.access()===Enums.CalendarAccess.Write||this.isOwner()},CCalendarListModel.prototype.pickCurrentCalendar=function(e){var t=_.find(this.collection(),function(e){return e.active()&&e.isEditable()},this);this.currentCal()&&this.currentCal().active()||(e&&e.active()&&e.isEditable()?this.currentCal(e):this.defaultCal()&&(this.defaultCal().active()&&this.defaultCal().isEditable()||!t)?this.currentCal(this.defaultCal()):t&&this.currentCal(t))},CCalendarListModel.prototype.hideOtherCalendars=function(e){_.each(this.collection(),function(t){t.active(t.id===e)},this)},CCalendarListModel.prototype.getCalendarById=function(e){var t=_.find(this.collection(),function(t){return t.id===e},this);return t},CCalendarListModel.prototype.getEvents=function(e,t){var i=[],s=[];return _.each(this.collection(),function(o){o&&o.active()&&(s=Utils.isUnd(e)||Utils.isUnd(t)?o.events():o.getEvents(e,t),i=_.union(i,s))},this),i},CCalendarListModel.prototype.parseCalendar=function(e){var t=new CCalendarModel;return t.parse(e),t},CCalendarListModel.prototype.parseAndAddCalendar=function(e){var t=0,i=null,s=this.parseCalendar(e);return s.active.subscribe(function(e){this.parentOnCalendarActiveChange(s);var t=s.active()?s:this.defaultCal();this.pickCurrentCalendar(t),App.Storage.setData(s.id,e)},this),s.isDefault&&this.defaultCal(s),t=this.calendarExists(s.id),t||0===t?(i=this.getCalendarById(s.id),s.events(i.events()),this.collection.splice(t,1,s)):this.collection.push(s),s},CCalendarListModel.prototype.calendarExists=function(e){var t=_.indexOf(_.map(this.collection(),function(e){return e.id}),e);return!(t<0)&&t},CCalendarListModel.prototype.removeCalendar=function(e){this.collection(_.filter(this.collection(),function(t){return t.id!==e},this))},CCalendarListModel.prototype.clearCollection=function(){this.collection.removeAll()},CCalendarListModel.prototype.getColors=function(){return _.map(this.collection(),function(e){return e.color().toLowerCase()},this)},CCalendarListModel.prototype.setDefault=function(e){_.each(this.collection(),function(t){t.id!==e?(t.isDefault=!0,this.defaultCal(t)):t.isDefault=!1},this)},CCalendarListModel.prototype.sort=function(){var e=_.sortBy(this.collection(),function(e){return e.name()});this.collection(_.sortBy(e,function(e){return e.isShared()}))},CCalendarListModel.prototype.expunge=function(e){this.collection(_.filter(this.collection(),function(t){return _.include(e,t.id)},this))},Utils.extend(CFileModel,CCommonFileModel),CFileModel.prototype.getInstance=function(){return new CFileModel},CFileModel.prototype.parse=function(e,t){var i=new CDateModel;this.isFolder(!!e.IsFolder),this.isLink(!!e.IsLink),this.fileName(Utils.pString(e.Name)),this.id(Utils.pString(e.Id)),this.path(Utils.pString(e.Path)),this.fullPath(Utils.pString(e.FullPath)),this.storageType(Utils.pString(e.Type)),this.shared(!!e.Shared),this.isExternal(!!e.IsExternal),this.iframedView(!!e.Iframed),this.isLink()&&(this.linkUrl(Utils.pString(e.LinkUrl)),this.linkType(Utils.pInt(e.LinkType))),this.isFolder()||(this.size(Utils.pInt(e.Size)),i.parse(e.LastModified),this.lastModified(i.getShortDate()),this.owner(Utils.pString(e.Owner)),this.thumb(!!e.Thumb),this.thumbnailExternalLink(Utils.pString(e.ThumbnailLink)),this.hash(Utils.pString(e.Hash)),this.publicHash(t),this.oembedHtml(e.OembedHtml?e.OembedHtml:"")),this.thumb()&&""===this.thumbnailExternalLink()&&Utils.thumbQueue(this.thumbnailSessionUid(),this.thumbnailLink(),this.thumbnailSrc),this.content(Utils.pString(e.Content))},CFileModel.prototype.onUploadSelectOwn=function(e,t,i,s,o,n){var a=new CDateModel,r=new Date;this.onUploadSelect(e,t),a.parse(r.getTime()/1e3),this.fileName(i),this.lastModified(a.getShortDate()),this.owner(s),this.path(o),this.storageType(n)},CPostModel.prototype.parse=function(e){if(this.Id=e.IdHelpdeskPost,this.IdThread=e.IdHelpdeskThread,this.IdOwner=e.IdOwner,this.bThreadOwner=e.IsThreadOwner,this.sFrom=Utils.isNonEmptyArray(e.Owner)?e.Owner[1]||e.Owner[0]||"":Utils.i18n("HELPDESK/THREAD_DELETED_USER"),this.sDate=CDateModel.prototype.convertDate(e.Created),this.iType=e.Type,this.bSysType=e.SystemType,this.sText=Utils.pString(e.Text),this.itsMe(e.ItsMe),e.Attachments){var t=0,i=0,s=null,o=[],n=Date.now().toString();for(i=e.Attachments.length;t<i;t++)e.Attachments[t]&&"Object/CHelpdeskAttachment"===Utils.pExport(e.Attachments[t],"@Object","")&&(s=new CHelpdeskAttachmentModel,s.parse(e.Attachments[t]),s.getInThumbQueue(n),o.push(s));this.attachments(o)}},CThreadListModel.prototype.parse=function(e){this.Id=e.IdHelpdeskThread,this.ThreadHash=Utils.pString(e.ThreadHash),this.IdOwner=e.IdOwner,this.ItsMe=!!e.ItsMe,this.sSubject=Utils.pString(e.Subject),this.time(Utils.pInt(e.Updated)),this.aOwner=Utils.isNonEmptyArray(e.Owner)?e.Owner:["",""],this.sEmail=this.aOwner[0]||"",this.sName=this.aOwner[1]||"",this.sFrom=this.sName||this.sEmail,this.sFromFull=Utils.trim(""===this.sName?this.sEmail:this.sName+(""!==this.sEmail?" ("+this.sEmail+")":"")),this.postsCount(e.PostCount),this.state(e.Type),this.unseen(!e.IsRead)},CThreadListModel.prototype.Name=function(){return this.sName},CThreadListModel.prototype.Email=function(){return this.sEmail},CThreadListModel.prototype.updateMomentDate=function(){this.time.valueHasMutated()},Utils.extend(CHelpdeskAttachmentModel,CCommonFileModel),CHelpdeskAttachmentModel.prototype.dataObjectName="Object/CHelpdeskAttachment",CHelpdeskAttachmentModel.prototype.getInstance=function(){return new CHelpdeskAttachmentModel},CHelpdeskAttachmentModel.prototype.fillDataAfterUploadComplete=function(e){this.tempName(e.Result.HelpdeskFile.TempName),this.type(e.Result.HelpdeskFile.MimeType),this.hash(e.Result.HelpdeskFile.Hash)},CSignatureModel.prototype.parse=function(e,t){this.iAccountId=e,this.options(parseInt(t.Options,10)),this.signature(t.Signature)},CAutoresponderModel.prototype.parse=function(e,t){this.iAccountId=e,this.enable=!!t.Enable,this.subject=Utils.pString(t.Subject),this.message=Utils.pString(t.Message)},CFetcherModel.prototype.parse=function(e){this.id(Utils.pInt(e.IdFetcher)),this.accountId(Utils.pInt(e.IdAccount)),this.isEnabled(!!e.IsEnabled),this.isLocked(!!e.IsLocked),this.email(Utils.pString(e.Email)),this.userName(Utils.pString(e.Name)),this.folder(Utils.pString(e.Folder)),this.signatureOptions(!!e.SignatureOptions),this.signature(Utils.pString(e.Signature)),this.incomingMailServer(Utils.pString(e.IncomingMailServer)),this.incomingMailPort(Utils.pInt(e.IncomingMailPort)),this.incomingMailSsl(!!e.IncomingMailSsl),this.incomingMailLogin(Utils.pString(e.IncomingMailLogin)),this.leaveMessagesOnServer(!!e.LeaveMessagesOnServer),this.isOutgoingEnabled(!!e.IsOutgoingEnabled),this.outgoingMailServer(Utils.pString(e.OutgoingMailServer)),this.outgoingMailPort(Utils.pInt(e.OutgoingMailPort)),this.outgoingMailSsl(!!e.OutgoingMailSsl),this.outgoingMailAuth(!!e.OutgoingMailAuth)},CFetcherListModel.prototype.parse=function(e,t){var i=_.map(t,function(e){var t=new CFetcherModel;return t.parse(e),t});this.accountId=e,this.collection(i)},CFetcherListModel.prototype.hasFetcher=function(e){return!!this.getFetcher(e)},CFetcherListModel.prototype.getFetcher=function(e){var t=_.find(this.collection(),function(t){return t.id()===e});return t||null},CForwardModel.prototype.parse=function(e,t){this.iAccountId=e,this.enable=!!t.Enable,this.email=Utils.pString(t.Email)},CSieveFiltersModel.prototype.parse=function(e,t){var i=0,s=t.length,o=null;if(this.iAccountId=e,_.isArray(t))for(s=t.length;i<s;i++)o=new CSieveFilterModel(e),o.parse(t[i]),this.collection.push(o)},CSieveFilterModel.prototype.parse=function(e){this.enable(!!e.Enable),this.field(Utils.pInt(e.Field)),this.condition(Utils.pInt(e.Condition)),this.filter(Utils.pString(e.Filter)),this.action(Utils.pInt(e.Action)),this.folder(Utils.pString(e.FolderFullName)),this.commit()},CSieveFilterModel.prototype.revert=function(){this.enable.revert(),this.field.revert(),this.condition.revert(),this.filter.revert(),this.action.revert(),this.folder.revert()},CSieveFilterModel.prototype.commit=function(){this.enable.commit(),this.field.commit(),this.condition.commit(),this.filter.commit(),this.action.commit(),this.folder.commit()},CSieveFilterModel.prototype.toString=function(){var e=[this.enable(),this.field(),this.condition(),this.filter(),this.action(),this.folder()];return e.join(":")},CInformationViewModel.prototype.showLoading=function(e){e&&""!==e?this.loadingMessage(e):this.loadingMessage(Utils.i18n("MAIN/LOADING")),this.loadingVisible(!0),_.defer(_.bind(function(){this.loadingHidden(!1)},this))},CInformationViewModel.prototype.hideLoading=function(){this.loadingHidden(!0),setTimeout(_.bind(function(){this.loadingHidden()&&this.loadingVisible(!1)},this),this.iAnimationDuration)},CInformationViewModel.prototype.showReport=function(e,t){0!==t&&(t=t||this.iReportDuration),e&&""!==e?(this.reportMessage(e),this.reportVisible(!0),_.defer(_.bind(this.reportHidden,this,!1)),clearTimeout(this.iReportTimeout),0===t?this.reportVisibleClose(!0):(this.reportVisibleClose(!1),this.iReportTimeout=setTimeout(_.bind(this.selfHideReport,this),t))):(this.reportHidden(!0),this.reportVisible(!1))},CInformationViewModel.prototype.selfHideReport=function(){this.reportHidden(!0),setTimeout(_.bind(function(){this.reportHidden()&&this.reportVisible(!1)},this),this.iAnimationDuration)},CInformationViewModel.prototype.showError=function(e,t,i,s){e&&""!==e?(this.gray(!!s),this.errorMessage(e),this.isHtmlError(t),this.errorVisible(!0),_.defer(_.bind(function(){this.errorHidden(!1)},this)),clearTimeout(this.iErrorTimeout),i||(this.iErrorTimeout=setTimeout(_.bind(function(){this.selfHideError()},this),this.iErrorDuration))):this.selfHideError()},CInformationViewModel.prototype.selfHideError=function(){this.errorHidden(!0),setTimeout(_.bind(function(){this.errorHidden()&&this.errorVisible(!1)},this),this.iAnimationDuration)},CInformationViewModel.prototype.hideError=function(e){e=!Utils.isUnd(e)&&!!e,e===this.gray()&&this.selfHideError()},CHeaderBaseViewModel.prototype.__name="CHeaderBaseViewModel",CHeaderBaseViewModel.prototype.onRoute=function(){this.changeMailLinkText()},CHeaderBaseViewModel.prototype.changeMailLinkText=function(){var e=AppData.Accounts.getCurrent();e.allowMail()?this.mailLinkText(AppData.Accounts.getEmail()):this.mailLinkText(Utils.i18n("TITLE/MAILBOX_TAB"))},CHeaderBaseViewModel.prototype.logout=function(){App.logout()},CHeaderBaseViewModel.prototype.switchToFullVersion=function(){App.Ajax.send({Action:"SystemSetMobile",Mobile:0},function(){window.location.reload()},this)},_.extend(CHeaderViewModel.prototype,CHeaderBaseViewModel.prototype),CPageSwitcherViewModel.prototype.hotKeysBind=function(){$(document).on("keydown",$.proxy(function(e){if(this.shown&&!Utils.isTextFieldFocused()){var t=e.keyCode;e.ctrlKey&&t===Enums.Key.Left?this.clickPreviousPage():e.ctrlKey&&t===Enums.Key.Right&&this.clickNextPage()}},this))},CPageSwitcherViewModel.prototype.hide=function(){this.shown=!1},CPageSwitcherViewModel.prototype.show=function(){this.shown=!0},CPageSwitcherViewModel.prototype.clear=function(){this.currentPage(1),this.count(0)},CPageSwitcherViewModel.prototype.setCount=function(e){this.count(e),this.currentPage()>this.pagesCount()&&this.currentPage(this.pagesCount())},CPageSwitcherViewModel.prototype.setPage=function(e,t){this.perPage(t),e>this.pagesCount()?this.currentPage(this.pagesCount()):this.currentPage(e)},CPageSwitcherViewModel.prototype.clickPage=function(e){var t=e.number;t<1&&(t=1),t>this.pagesCount()&&(t=this.pagesCount()),this.currentPage(t)},CPageSwitcherViewModel.prototype.clickFirstPage=function(){this.currentPage(1)},CPageSwitcherViewModel.prototype.clickPreviousPage=function(){var e=this.currentPage()-1;e<1&&(e=1),this.currentPage(e)},CPageSwitcherViewModel.prototype.clickNextPage=function(){var e=this.currentPage()+1;e>this.pagesCount()&&(e=this.pagesCount()),this.currentPage(e)},CPageSwitcherViewModel.prototype.clickLastPage=function(){this.currentPage(this.pagesCount())},CHtmlEditorViewModel.prototype.__name="CHtmlEditorViewModel",CHtmlEditorViewModel.prototype.hasOpenedPopup=function(){return this.visibleInsertLinkPopup()||this.visibleLinkPopup()||this.visibleImagePopup()||this.visibleInsertImagePopup()||this.visibleFontColorPopup()},CHtmlEditorViewModel.prototype.resize=function(){var e=$(this.htmlEditorDom()),t=e.parent(),i=$(this.workareaDom()),s=$(this.toolbarDom());_.delay(function(){var o=i.outerWidth(!0)-i.width(),n=e.outerWidth(!0)-e.width(),a=t.width()-n,r=i.outerHeight(!0)-i.height(),l=t.height(),h=l-r-s.outerHeight();e.width(a),i.width(a-o),e.height(l),i.height(h)},1)},CHtmlEditorViewModel.prototype.init=function(){$(document.body).on("click",_.bind(function(){this.closeAllPopups(!0)},this)),this.initEditorUploader()},CHtmlEditorViewModel.prototype.correctFontFromSettings=function(){var e=this.sDefaultFont,t=!1;_.each(this.aFonts,function(i){i.toLowerCase()===e.toLowerCase()&&(e=i,t=!0)}),t?this.sDefaultFont=e:this.aFonts.push(e)},CHtmlEditorViewModel.prototype.showLinkPopup=function(e){var t=$(this.workareaDom()),i=t.closest(".panel.compose"),s=t.position(),o=e.position(),n=e.height(),a=Math.round(o.left+s.left),r=Math.round(o.top+n+s.top);this.linkHref(e.attr("href")||e.text()),$(this.linkPopupDom()).css({left:a,top:r}),$(this.linkHrefDom()).css({left:a,top:r}),App.browser.firefox||1!==i.length||$(this.linkPopupDom()).css({"max-width":i.width()-a-40+"px","white-space":"pre-line","word-wrap":"break-word"}),this.visibleLinkPopup(!0)},CHtmlEditorViewModel.prototype.hideLinkPopup=function(){this.visibleLinkPopup(!1)},CHtmlEditorViewModel.prototype.showChangeLink=function(){this.visibleLinkHref(!0),this.hideLinkPopup()},CHtmlEditorViewModel.prototype.changeLink=function(){this.oCrea.changeLink(this.linkHref()),this.hideChangeLink()},CHtmlEditorViewModel.prototype.hideChangeLink=function(){this.visibleLinkHref(!1)},CHtmlEditorViewModel.prototype.showImagePopup=function(e,t){var i=$(this.workareaDom()),s=i.position(),o=i.offset();this.imagePopupLeft(Math.round(t.pageX+s.left-o.left)),this.imagePopupTop(Math.round(t.pageY+s.top-o.top)),this.visibleImagePopup(!0),e.parent("a").length>0&&(this.oCrea.oCurrLink=e.parent("a").get(0),this.showLinkPopup(e.parent("a")))},CHtmlEditorViewModel.prototype.hideImagePopup=function(){this.visibleLinkPopup()&&this.visibleImagePopup()&&this.visibleLinkPopup(!1),this.visibleImagePopup(!1)},CHtmlEditorViewModel.prototype.resizeImage=function(e){var t={width:"auto",height:"auto"};switch(e){case Enums.HtmlEditorImageSizes.Small:t.width="300px";break;case Enums.HtmlEditorImageSizes.Medium:t.width="600px";break;case Enums.HtmlEditorImageSizes.Large:t.width="1200px";break;case Enums.HtmlEditorImageSizes.Original:t.width="auto"}this.oCrea.changeCurrentImage(t),this.visibleImagePopup(!1)},CHtmlEditorViewModel.prototype.onImageOver=function(e){if("IMG"===e.target.nodeName&&!this.visibleImagePopup()){this.imageSelected(!0),this.tooltipText(Utils.i18n("HTMLEDITOR/CLICK_TO_EDIT_IMAGE"));var t=this,i=$(this.workareaDom());i.bind("mousemove.image",function(e){var s=i.position(),o=i.offset();t.tooltipPopupTop(Math.round(e.pageY+s.top-o.top)),t.tooltipPopupLeft(Math.round(e.pageX+s.left-o.left))})}return!0},CHtmlEditorViewModel.prototype.onImageOut=function(e){if(this.imageSelected()){this.imageSelected(!1);var t=$(this.workareaDom());t.unbind("mousemove.image")}return!0},CHtmlEditorViewModel.prototype.commit=function(){this.textChanged(!1)},CHtmlEditorViewModel.prototype.initCrea=function(e,t,i){this.oCrea||(this.init(),this.oCrea=new Crea({creaId:this.creaId,fontNameArray:this.aFonts,defaultFontName:this.sDefaultFont,defaultFontSize:this.iDefaultSize,isRtl:Utils.isRTL(),enableDrop:!1,onChange:_.bind(this.textChanged,this,!0),onCursorMove:_.bind(this.setFontValuesFromText,this),onFocus:_.bind(this.onCreaFocus,this),onBlur:_.bind(this.onCreaBlur,this),onUrlIn:_.bind(this.showLinkPopup,this),onUrlOut:_.bind(this.hideLinkPopup,this),onImageSelect:_.bind(this.showImagePopup,this),onImageBlur:_.bind(this.hideImagePopup,this),onItemOver:bMobileDevice||bMobileApp?null:_.bind(this.onImageOver,this),onItemOut:bMobileDevice||bMobileApp?null:_.bind(this.onImageOut,this),openInsertLinkDialog:_.bind(this.insertLink,this),onUrlClicked:!0}),this.oCrea.start(this.isEnable(),AppData.App.AllowComposeShortcuts)),this.oCrea.setTabIndex(i),this.oCrea.clearUndoRedo(),this.setText(e,t),this.setFontValuesFromText(),this.uploadedImagePathes([]),this.selectedFont(this.sDefaultFont),this.selectedSize(this.iDefaultSize)},CHtmlEditorViewModel.prototype.setFocus=function(){this.oCrea&&this.oCrea.setFocus(!1)},CHtmlEditorViewModel.prototype.changeSignatureContent=function(e,t){this.oCrea&&this.oCrea.changeSignatureContent(e,t)},CHtmlEditorViewModel.prototype.setFontValuesFromText=function(){this.lockFontSubscribing(!0),this.selectedFont(this.oCrea.getFontName()),this.selectedSize(this.oCrea.getFontSizeInNumber().toString()),this.lockFontSubscribing(!1)},CHtmlEditorViewModel.prototype.isUndoAvailable=function(){return!!this.oCrea&&this.oCrea.isUndoAvailable()},CHtmlEditorViewModel.prototype.getPlainText=function(){return this.oCrea?this.oCrea.getPlainText():""},CHtmlEditorViewModel.prototype.getText=function(e){return this.oCrea?this.oCrea.getText(e):""},CHtmlEditorViewModel.prototype.setText=function(e,t){this.oCrea&&(t?this.oCrea.setPlainText(e):this.oCrea.setText(e),this.inactive.valueHasMutated())},CHtmlEditorViewModel.prototype.undoAndClearRedo=function(){this.oCrea&&(this.oCrea.undo(),this.oCrea.clearRedo())},CHtmlEditorViewModel.prototype.clearUndoRedo=function(){this.oCrea&&this.oCrea.clearUndoRedo()},CHtmlEditorViewModel.prototype.isEditing=function(){return!!this.oCrea&&this.oCrea.bEditing},CHtmlEditorViewModel.prototype.getNotDefaultText=function(){var e=this.getText();return this.removeAllTags(e)!==Utils.i18n("HTMLEDITOR/SIGNATURE_PLACEHOLDER")?e:""},CHtmlEditorViewModel.prototype.removeAllTags=function(e){return e.replace(/<style>.*<\/style>/g,"").replace(/<[^>]*>/g,"")},CHtmlEditorViewModel.prototype.setActivitySource=function(e){this.activitySource=e,null!==this.activitySourceSubscription&&this.activitySourceSubscription.dispose(),this.activitySourceSubscription=this.activitySource.subscribe(function(){this.inactive(0===Utils.pInt(this.activitySource()))},this),this.inactive(0===Utils.pInt(this.activitySource()))},CHtmlEditorViewModel.prototype.onCreaFocus=function(){this.oCrea&&(this.closeAllPopups(),this.activitySource(1),this.textFocused(!0))},CHtmlEditorViewModel.prototype.onCreaBlur=function(){this.oCrea&&this.textFocused(!1)},CHtmlEditorViewModel.prototype.onEscHandler=function(){0===App.Screens.popups.length&&this.closeAllPopups()},CHtmlEditorViewModel.prototype.closeAllPopups=function(e){e=!!e,e||this.visibleLinkPopup(!1),this.visibleInsertLinkPopup(!1),this.visibleImagePopup(!1),this.visibleInsertImagePopup(!1),this.visibleFontColorPopup(!1),AfterLogicApi.runPluginHook&&AfterLogicApi.runPluginHook("close-all-htmleditor-popups")},CHtmlEditorViewModel.prototype.insertHtml=function(e){this.oCrea&&(this.oCrea.isFocused()||this.oCrea.setFocus(!0),this.oCrea.insertHtml(e,!1))},CHtmlEditorViewModel.prototype.insertLink=function(e,t){t&&this.setActive(t),this.visibleInsertLinkPopup()||(this.linkForInsert(this.oCrea.getSelectedText()),this.closeAllPopups(),this.visibleInsertLinkPopup(!0),this.linkFocused(!0))},CHtmlEditorViewModel.prototype.insertLinkFromPopup=function(e,t){this.linkForInsert().length>0&&(Utils.Address.isCorrectEmail(this.linkForInsert())?this.oCrea.insertEmailLink(this.linkForInsert()):this.oCrea.insertLink(this.linkForInsert())),this.closeInsertLinkPopup(e,t)},CHtmlEditorViewModel.prototype.closeInsertLinkPopup=function(e,t){this.visibleInsertLinkPopup(!1),t&&t.stopPropagation()},CHtmlEditorViewModel.prototype.textColor=function(e,t){this.setActive(t),this.visibleFontColorPopup()?this.closeAllPopups():(this.closeAllPopups(),this.visibleFontColorPopup(!0),this.oFontColorPicker.onShow(),this.oBackColorPicker.onShow())},CHtmlEditorViewModel.prototype.colorToHex=function(e){if("#"===e.substr(0,1))return e;for(var t=/(.*?)rgb\((\d+), (\d+), (\d+)\)/.exec(e),i=parseInt(t[2],10),s=parseInt(t[3],10),o=parseInt(t[4],10),n=o|s<<8|i<<16,a=n.toString(16);a.length<6;)a="0"+a;return t[1]+"#"+a},CHtmlEditorViewModel.prototype.setTextColorFromPopup=function(e){this.oCrea.textColor(this.colorToHex(e)),this.closeAllPopups()},CHtmlEditorViewModel.prototype.setBackColorFromPopup=function(e){this.oCrea.backgroundColor(this.colorToHex(e)),this.closeAllPopups()},CHtmlEditorViewModel.prototype.insertImage=function(e,t){return this.setActive(t),this.allowInsertImage()&&!this.visibleInsertImagePopup()&&(this.imagePathFromWeb(""),this.closeAllPopups(),this.visibleInsertImagePopup(!0),this.initUploader()),!0},CHtmlEditorViewModel.prototype.insertWebImageFromPopup=function(e,t){this.allowInsertImage()&&this.imagePathFromWeb().length>0&&this.oCrea.insertImage(this.imagePathFromWeb()),this.closeInsertImagePopup(e,t)},CHtmlEditorViewModel.prototype.insertComputerImageFromPopup=function(e,t){var i=Utils.File.getViewLinkByHash(AppData.Accounts.currentId(),t.Hash),s=!1;this.allowInsertImage()&&i.length>0&&(s=this.oCrea.insertImage(i),s&&($(this.oCrea.$editableArea).find('img[src="'+i+'"]').attr("data-x-src-cid",e),t.CID=e,this.uploadedImagePathes.push(t))),this.closeInsertImagePopup()},CHtmlEditorViewModel.prototype.closeInsertImagePopup=function(e,t){
this.visibleInsertImagePopup(!1),t&&t.stopPropagation()},CHtmlEditorViewModel.prototype.initUploader=function(){this.imageUploaderButton()&&!this.oJua&&(this.oJua=new Jua({action:"?/Upload/Attachment/",name:"jua-uploader",queueSize:2,clickElement:this.imageUploaderButton(),hiddenElementsPosition:Utils.isRTL()?"right":"left",disableMultiple:!0,disableAjaxUpload:!1,disableDragAndDrop:!0,hidden:{Token:function(){return AppData.Token},AccountID:function(){return AppData.Accounts.currentId()}}}),this.bInsertImageAsBase64?this.oJua.on("onSelect",_.bind(this.onEditorDrop,this)):this.oJua.on("onSelect",_.bind(this.onFileUploadSelect,this)).on("onComplete",_.bind(this.onFileUploadComplete,this)))},CHtmlEditorViewModel.prototype.initEditorUploader=function(){if(AppData.App.AllowInsertImage&&this.uploaderAreaDom()&&!this.editorUploader){var e=null,t=null;this.oParent&&this.oParent.composeUploaderDragOver&&this.oParent.onFileUploadProgress&&this.oParent.onFileUploadStart&&this.oParent.onFileUploadComplete?(e=_.bind(function(){this.editorUploaderBodyDragOver(!0),this.oParent.composeUploaderDragOver(!0)},this),t=_.bind(function(){this.editorUploaderBodyDragOver(!1),this.oParent.composeUploaderDragOver(!1)},this),this.editorUploader=new Jua({action:"?/Upload/Attachment/",name:"jua-uploader",queueSize:1,dragAndDropElement:this.bAllowImageDragAndDrop?this.uploaderAreaDom():null,disableMultiple:!0,disableAjaxUpload:!1,disableDragAndDrop:!this.bAllowImageDragAndDrop,hidden:{Token:function(){return AppData.Token},AccountID:function(){return AppData.Accounts.currentId()}}}),this.editorUploader.on("onDragEnter",_.bind(this.oParent.composeUploaderDragOver,this.oParent,!0)).on("onDragLeave",_.bind(this.oParent.composeUploaderDragOver,this.oParent,!1)).on("onBodyDragEnter",e).on("onBodyDragLeave",t).on("onProgress",_.bind(this.oParent.onFileUploadProgress,this.oParent)).on("onSelect",_.bind(this.onEditorDrop,this)).on("onStart",_.bind(this.oParent.onFileUploadStart,this.oParent)).on("onComplete",_.bind(this.oParent.onFileUploadComplete,this.oParent))):(e=_.bind(this.editorUploaderBodyDragOver,this,!0),t=_.bind(this.editorUploaderBodyDragOver,this,!1),this.editorUploader=new Jua({queueSize:1,dragAndDropElement:this.bAllowImageDragAndDrop?this.uploaderAreaDom():null,disableMultiple:!0,disableAjaxUpload:!1,disableDragAndDrop:!this.bAllowImageDragAndDrop}),this.editorUploader.on("onBodyDragEnter",e).on("onBodyDragLeave",t).on("onSelect",_.bind(this.onEditorDrop,this)))}},CHtmlEditorViewModel.prototype.onEditorDrop=function(e,t){var i=null,s=null,o=this,n=!1,a=Math.random().toString(),r="";if(t&&t.File&&"string"==typeof t.File.type)if(AppData.App.AllowInsertImage&&0===t.File.type.indexOf("image/"))s=t.File,AppData.App.ImageUploadSizeLimit>0&&s.size>AppData.App.ImageUploadSizeLimit?App.Screens.showPopup(AlertPopup,[Utils.i18n("COMPOSE/UPLOAD_ERROR_SIZE")]):(i=new window.FileReader,n=this.oCrea.isFocused(),n||this.oCrea.setFocus(!0),r=s.name+"_"+a,this.oCrea.insertHtml('<img id="'+r+'" src="skins/Default/images/wait.gif" />',!0),n||this.oCrea.fixFirefoxCursorBug(),i.onload=function(e){o.oCrea.changeImageSource(r,e.target.result)},i.readAsDataURL(s));else{if(this.oParent&&this.oParent.onFileUploadSelect)return this.oParent.onFileUploadSelect(e,t),!0;App.browser.ie10AndAbove||App.Screens.showPopup(AlertPopup,[Utils.i18n("HTMLEDITOR/UPLOAD_ERROR_NOT_IMAGE")])}return!1},CHtmlEditorViewModel.prototype.isFileImage=function(e){if("string"==typeof e.Type)return-1!==e.Type.indexOf("image");var t=e.FileName.lastIndexOf("."),i=e.FileName.substr(t+1),s=["jpg","jpeg","gif","tif","tiff","png"];return-1!==$.inArray(i,s)},CHtmlEditorViewModel.prototype.onFileUploadSelect=function(e,t){return this.isFileImage(t)?(this.closeInsertImagePopup(),!0):(App.Screens.showPopup(AlertPopup,[Utils.i18n("HTMLEDITOR/UPLOAD_ERROR_NOT_IMAGE")]),!1)},CHtmlEditorViewModel.prototype.onFileUploadComplete=function(e,t,i){var s="";i&&i.Result?i.Result.Error?(s="size"===i.Result.Error?Utils.i18n("COMPOSE/UPLOAD_ERROR_SIZE"):Utils.i18n("COMPOSE/UPLOAD_ERROR_UNKNOWN"),App.Screens.showPopup(AlertPopup,[s])):(this.oCrea.setFocus(!0),this.insertComputerImageFromPopup(e,i.Result.Attachment)):App.Screens.showPopup(AlertPopup,[Utils.i18n("COMPOSE/UPLOAD_ERROR_UNKNOWN")])},CHtmlEditorViewModel.prototype.setActive=function(e){e.stopPropagation(),this.activitySource(1)},CColorPickerViewModel.prototype.onShow=function(){$(this.colorPickerDom()).find("span.color-item").on("click",_.bind(function(e){e.stopPropagation(),this.setColorFromPopup($(e.target).data("color"))},this))},CColorPickerViewModel.prototype.setColorFromPopup=function(e){this.pickHandler.call(this.pickContext,e)},CPhoneViewModel.prototype.answer=function(){this.action(Enums.PhoneAction.IncomingConnect)},CPhoneViewModel.prototype.multiAction=function(){var e=this.action();e===Enums.PhoneAction.OfflineActive?this.action(Enums.PhoneAction.Offline):e===Enums.PhoneAction.Online?(this.action(Enums.PhoneAction.OnlineActive),this.getLogs(),_.delay(_.bind(function(){this.inputFocus(!0)},this),500)):e===Enums.PhoneAction.OnlineActive&&this.validateNumber()?(this.phone&&(this.phone.phoneToCall(this.input()),this.action(Enums.PhoneAction.Outgoing)),this.inputFocus(!1)):e!==Enums.PhoneAction.OnlineActive||this.validateNumber()?e!==Enums.PhoneAction.Outgoing&&e!==Enums.PhoneAction.Incoming&&e!==Enums.PhoneAction.OutgoingConnect&&e!==Enums.PhoneAction.IncomingConnect||(this.action(Enums.PhoneAction.Online),this.dropdownShow(!1)):(this.action(Enums.PhoneAction.Online),this.dropdownShow(!1))},CPhoneViewModel.prototype.autocompleteCallback=function(e,t){var i={Action:"ContactSuggestions",Search:e,PhoneOnly:"1"};this.phoneAutocompleteItem(null),e=Utils.trim(e),""!==e&&App.Ajax.send(i,function(e){var i=[];e&&e.Result&&e.Result.List&&(_.each(e.Result.List,function(e){_.each(e.Phones,function(t,s){i.push({label:""!==e.Name?e.Name+" <"+e.Email+"> "+t:e.Email+" "+t,value:t,frequency:e.Frequency})},this)},this),i=_.sortBy(_.compact(i),function(e){return-e.frequency})),t(i)},this)},CPhoneViewModel.prototype.validateNumber=function(){return/^[^a-zA-Z\u00BF-\u1FFF\u2C00-\uD7FF]+$/g.test(this.input())},CPhoneViewModel.prototype.onLogItem=function(e){this.input(e.phoneToCall),this.dropdownShow(!1)},CPhoneViewModel.prototype.getLogs=function(){this.spinner(!0),this.logs([]),this.logsToShow([]),this.phone.getLogs(this.onLogsResponse,this)},CPhoneViewModel.prototype.onLogsResponse=function(e,t){e&&e.Result&&(this.logs([]),_.each(e.Result,function(e){e.phoneToCall=this.phone.getCleanedPhone("incoming"===e.UserDirection?e.From:e.To),e.UserDisplayName?e.phoneToShow=e.UserDisplayName:e.phoneToShow=e.phoneToCall,e.phoneToShow&&this.logs.push(e)},this),this.logs(_.sortBy(this.logs(),function(e){return-Date.parse(e.StartTime)}).slice(0,100)),this.seeMore()),this.spinner(!1)},CPhoneViewModel.prototype.seeMore=function(){this.logsToShow(this.logs().slice(0,this.logsToShow().length+10))},CPhoneViewModel.prototype.timer=function(){var e=0,t=0,i=0,s=function(e){var t=e.toString();return 1===t.length?t="0"+t:t};return function(o){"start"===o?(t=0,i=0,e=setInterval(_.bind(function(){60===t&&(t=0,i++),this.report(Utils.i18n("PHONE/PASSED_TIME")+" "+s(i)+":"+s(t)),t++},this),1e3)):"stop"===o&&clearInterval(e)}}(),CWrapLoginViewModel.prototype.__name="CWrapLoginViewModel",CWrapLoginViewModel.prototype.onShow=function(){this.oLoginViewModel.onShow&&this.oLoginViewModel.onShow()},CWrapLoginViewModel.prototype.onApplyBindings=function(){this.oLoginViewModel.onApplyBindings&&this.oLoginViewModel.onApplyBindings()},CWrapLoginViewModel.prototype.changeLanguage=function(e){e&&this.allowLanguages()&&(this.currentLanguage(e),this.oLoginViewModel.changingLanguage(!0),App.Ajax.send({Action:"SystemUpdateLanguageOnLogin",Language:e},function(){window.location.reload()},this))},CLoginAdvancedViewModel.prototype.onApplyBindings=function(){if(this.bEnabled&&_.isArray(AppData.LoginAdvanced.Hosts)){var e=_.compact(_.map(AppData.LoginAdvanced.Hosts,function(e){return"string"==typeof e?Utils.trim(e):""}));if(e.length>0){var t=this.advancedLoginForm().find("input.input.server"),i=this.oIncoming,s=this.oOutgoing;t.each(function(){var t=$(this);t.autocomplete({source:_.sortBy(e,function(e){return e}),select:function(e,o){t.parent()&&o.item&&(t.parent().hasClass("incoming")&&i.server(o.item.value),t.parent().hasClass("outgoing")&&s.server(o.item.value))},change:function(o,n){_.indexOf(e,t.val())===-1&&(t.parent().hasClass("incoming")&&i.server(""),t.parent().hasClass("outgoing")&&s.server(""),t.focus())}}),t.on("click",function(){t.autocomplete("option","minLength",0),t.autocomplete("search"),setTimeout(function(){t.autocomplete("option","minLength",1)}.bind(this),0)})})}}},CLoginAdvancedViewModel.prototype.triggerFormDisplaying=function(){this.displayForm(!this.displayForm())},CLoginAdvancedViewModel.prototype.getData=function(){return this.bEnabled&&this.displayForm()?{IncHost:this.oIncoming.server(),IncPort:this.oIncoming.getIntPort(),IncSsl:this.oIncoming.getIntSsl(),OutHost:this.oOutgoing.server(),OutPort:this.oOutgoing.getIntPort(),OutSsl:this.oOutgoing.getIntSsl(),OutAuth:this.useSmtpAuthentication()?"1":"0"}:{}},CLoginViewModel.prototype.__name="CLoginViewModel",CLoginViewModel.prototype.onApplyBindings=function(){$html.addClass("non-adjustable-valign"),this.oLoginAdvancedViewModel.onApplyBindings()},CLoginViewModel.prototype.onShow=function(){this.fillFields()},CLoginViewModel.prototype.fillFields=function(){_.delay(_.bind(function(){this.focusFields()},this),1)},CLoginViewModel.prototype.focusFields=function(){this.emailVisible()&&""===this.email()?this.emailFocus(!0):this.loginVisible()&&""===this.login()&&this.loginFocus(!0)},CLoginViewModel.prototype.signIn=function(){$(".check_autocomplete_input").trigger("input").trigger("change").trigger("keydown");var e=this.loginFormType(),t=this.email(),i=this.login(),s=this.password();this.loading()||this.changingLanguage()||""===Utils.trim(s)||!(Enums.LoginFormType.Login===e&&""!==Utils.trim(i)||Enums.LoginFormType.Email===e&&""!==Utils.trim(t)||Enums.LoginFormType.Both===e&&""!==Utils.trim(t))?this.shake(!0):this.sendRequest()},CLoginViewModel.prototype.onSystemLoginResponse=function(e,t){!1===e.Result?(this.loading(!1),this.shake(!0),App.Api.showErrorByCode(e,Utils.i18n("WARNING/LOGIN_PASS_INCORRECT"))):(App.Storage.setData("AuthToken",e.Result.AuthToken),""!==window.location.search&&null===Utils.Common.getRequestParam("reset-pass")&&null===Utils.Common.getRequestParam("invite-auth")&&null===Utils.Common.getRequestParam("external-services")?Utils.Common.clearAndReloadLocation(App.browser.ie8AndBelow,!0):Utils.Common.clearAndReloadLocation(App.browser.ie8AndBelow,!1))},CLoginViewModel.prototype.sendRequest=function(){var e={Action:"SystemLogin",Email:this.emailVisible()?this.email():"",IncLogin:this.loginVisible()?this.login():"",IncPassword:this.password(),SignMe:this.signMe()?"1":"0"};_.extend(e,this.oLoginAdvancedViewModel.getData()),this.loading(!0),App.Ajax.send(e,this.onSystemLoginResponse,this)},CForgotViewModel.prototype.__name="CForgotViewModel",CForgotViewModel.prototype.executeGetQuestion=function(){var e={Action:"AccountGetForgotQuestion",Email:this.email()};this.gettingQuestion(!0),App.Ajax.send(e,this.onAccountGetForgotQuestionResponse,this)},CForgotViewModel.prototype.onAccountGetForgotQuestionResponse=function(e,t){var i="";this.gettingQuestion(!1),!1===e.Result?App.Api.showErrorByCode(e,Utils.i18n("LOGIN/ERROR_GETTING_QUESTION")):(i=Utils.pString(e.Result.Question),""===i?App.Api.showError(Utils.i18n("LOGIN/ERROR_PASSWORD_RESET_NOT_AVAILABLE")):(this.question(i),this.visibleEmailForm(!1),this.visibleQuestionForm(!0),this.visiblePasswordForm(!1)))},CForgotViewModel.prototype.executeValidateAnswer=function(){var e={Action:"AccountValidateForgotQuestion",Email:this.email(),Question:this.question(),Answer:this.answer()};this.validatingAnswer(!0),App.Ajax.send(e,this.onAccountValidateForgotQuestionResponse,this)},CForgotViewModel.prototype.onAccountValidateForgotQuestionResponse=function(e,t){this.validatingAnswer(!1),!1===e.Result?App.Api.showErrorByCode(e,Utils.i18n("LOGIN/ERROR_WRONG_ANSWER")):(this.visibleEmailForm(!1),this.visibleQuestionForm(!1),this.visiblePasswordForm(!0))},CForgotViewModel.prototype.executeChangePassword=function(){if(this.password()!==this.confirmPassword())App.Api.showError(Utils.i18n("WARNING/PASSWORDS_DO_NOT_MATCH"));else{var e={Action:"AccountChangeForgotPassword",Email:this.email(),Question:this.question(),Answer:this.answer(),Password:this.password()};this.changingPassword(!0),App.Ajax.send(e,this.onAccountChangeForgotPasswordResponse,this)}},CForgotViewModel.prototype.onAccountChangeForgotPasswordResponse=function(e,t){this.changingPassword(!1),!1===e.Result?App.Api.showErrorByCode(e,Utils.i18n("LOGIN/ERROR_RESETTING_PASSWORD")):(this.gotoForgot(!1),App.Api.showReport(Utils.i18n("LOGIN/REPORT_PASSWORD_CHANGED")))},CRegisterViewModel.prototype.__name="CRegisterViewModel",CRegisterViewModel.prototype.registerAccount=function(){if(this.password()!==this.confirmPassword())App.Api.showError(Utils.i18n("WARNING/PASSWORDS_DO_NOT_MATCH"));else{var e={Action:"AccountRegister",Name:this.name(),Email:this.login()+"@"+this.selectedDomain(),Password:this.password(),Question:this.allowQuestionPart?this.visibleYourQuestion()?this.yourQuestion():this.question():"",Answer:this.allowQuestionPart?this.answer():""};this.loading(!0),App.Ajax.send(e,this.onAccountRegisterResponse,this)}},CRegisterViewModel.prototype.onAccountRegisterResponse=function(e,t){!1===e.Result?(this.loading(!1),App.Api.showErrorByCode(e,Utils.i18n("WARNING/LOGIN_PASS_INCORRECT"))):window.location.reload()},CMessageListViewModel.prototype.addNewAccount=function(){App.Api.createMailAccount(AppData.Accounts.getEmail())},CMessageListViewModel.prototype.createDatePickerObject=function(e){$(e).datepicker({showOtherMonths:!0,selectOtherMonths:!0,monthNames:Utils.getMonthNamesArray(),dayNamesMin:Utils.i18n("DATETIME/DAY_NAMES_MIN").split(" "),nextText:"",prevText:"",firstDay:AppData.User.CalendarWeekStartsOn,showOn:"focus",dateFormat:this.dateFormatDatePicker}),$(e).mousedown(function(){$("#ui-datepicker-div").toggle()})},CMessageListViewModel.prototype.changeRoutingForMessageList=function(e,t,i,s,o){var n=App.Routing.setHash(App.Links.mailbox(e,t,i,s,o));n&&s.length>0&&this.search()===s&&this.listChangedThrottle(!this.listChangedThrottle())},CMessageListViewModel.prototype.onEnterPress=function(e){e.openThread()},CMessageListViewModel.prototype.onMessageDblClick=function(e){if(!this.isSavingDraft(e)){var t=this.folderList().getFolderByFullName(e.folder()),i=-1!==Utils.inArray(e.folder(),App.MailCache.getCurrentTemplateFolders());t.type()===Enums.FolderTypes.Drafts||i?App.Api.composeMessageFromDrafts(e.folder(),e.uid()):this.openMessageInNewWindowBinded(e)}},CMessageListViewModel.prototype.onFolderListSubscribe=function(){this.setCurrentFolder(),this.requestMessageList()},CMessageListViewModel.prototype.onShow=function(e){this.selector.useKeyboardKeys(!0),this.oPageSwitcher.show(),this.oJua&&this.oJua.setDragAndDropEnabledStatus(!0)},CMessageListViewModel.prototype.onHide=function(e){this.selector.useKeyboardKeys(!1),this.oPageSwitcher.hide(),this.oJua&&this.oJua.setDragAndDropEnabledStatus(!1)},CMessageListViewModel.prototype.onRoute=function(e){var t=App.Links.parseMailbox(e),i=this.currentPage()!==t.Page||this.folderFullName()!==t.Folder||this.filters()!==t.Filters||t.Filters===Enums.FolderFilter.Unseen&&App.MailCache.waitForUnseenMessages()||this.search()!==t.Search,s=AppData.User.MailsPerPage!==this.oPageSwitcher.perPage();this.pageSwitcherLocked(!0),this.folderFullName()!==t.Folder||this.search()!==t.Search||this.filters()!==t.Filters?this.oPageSwitcher.clear():this.oPageSwitcher.setPage(t.Page,AppData.User.MailsPerPage),this.pageSwitcherLocked(!1),t.Page!==this.oPageSwitcher.currentPage()&&App.Routing.replaceHash(App.Links.mailbox(t.Folder,this.oPageSwitcher.currentPage(),t.Uid,t.Search,t.Filters)),this.currentPage(this.oPageSwitcher.currentPage()),this.folderFullName(t.Folder),this.filters(t.Filters),this.search(t.Search),this.searchInput(this.search()),this.searchSpan.notifySubscribers(),this.setCurrentFolder(),(i||s||0===this.collection().length)&&(t.Filters===Enums.FolderFilter.Unseen&&App.MailCache.waitForUnseenMessages(!0),this.requestMessageList()),this.highlightTrigger.notifySubscribers(!0)},CMessageListViewModel.prototype.setCurrentFolder=function(){this.folderList().setCurrentFolder(this.folderFullName(),this.filters()),this.folderType(App.MailCache.folderList().currentFolderType())},CMessageListViewModel.prototype.requestMessageList=function(){var e=this.folderList().currentFolderFullName(),t=this.oPageSwitcher.currentPage();e.length>0?App.MailCache.changeCurrentMessageList(e,t,this.search(),this.filters()):App.MailCache.checkCurrentFolderList()},CMessageListViewModel.prototype.calculateSearchStringFromAdvancedForm=function(){var e=this.searchInputFrom(),t=this.searchInputTo(),i=this.searchInputSubject(),s=this.searchInputText(),o=this.searchAttachmentsCheckbox(),n=(this.searchAttachments(),this.searchDateStart()),a=this.searchDateEnd(),r=[],l=function(e){return e=$.trim(e).replace(/"/g,'\\"'),(-1<e.indexOf(" ")||-1<e.indexOf('"'))&&(e='"'+e+'"'),e};return""!==e&&r.push("from:"+l(e)),""!==t&&r.push("to:"+l(t)),""!==i&&r.push("subject:"+l(i)),""!==s&&r.push("text:"+l(s)),o&&r.push("has:attachments"),""===n&&""===a||r.push("date:"+l(n)+"/"+l(a)),r.join(" ")},CMessageListViewModel.prototype.onSearchClick=function(){var e=this.folderList().currentFolderFullName(),t=1,i=this.searchInput();this.bAdvancedSearch()&&(i=this.calculateSearchStringFromAdvancedForm(),this.searchInput(i),this.bAdvancedSearch(!1)),this.changeRoutingForMessageList(e,t,"",i,this.filters())},CMessageListViewModel.prototype.onRetryClick=function(){this.requestMessageList()},CMessageListViewModel.prototype.onClearSearchClick=function(){var e=this.folderList().currentFolderFullName(),t=this.currentMessage()?this.currentMessage().uid():"",i="",s=1;this.clearAdvancedSearch(),this.changeRoutingForMessageList(e,s,t,i,this.filters())},CMessageListViewModel.prototype.onClearFilterClick=function(){var e=this.folderList().currentFolderFullName(),t=this.currentMessage()?this.currentMessage().uid():"",i="",s=1,o="";this.clearAdvancedSearch(),this.changeRoutingForMessageList(e,s,t,i,o)},CMessageListViewModel.prototype.onStopSearchClick=function(){this.onClearSearchClick()},CMessageListViewModel.prototype.isSavingDraft=function(e){var t=this.folderList().currentFolder();return t.type()===Enums.FolderTypes.Drafts&&e.uid()===App.MailCache.savingDraftUid()},CMessageListViewModel.prototype.routeForMessage=function(e){if(null!==e&&!this.isSavingDraft(e)){var t=this.folderList().currentFolder(),i=this.folderList().currentFolderFullName(),s=this.oPageSwitcher.currentPage(),o=e.uid(),n=this.search();""!==o&&(bMobileApp&&t.type()===Enums.FolderTypes.Drafts?App.Routing.setHash(App.Links.composeFromMessage("drafts",e.folder(),e.uid())):(this.changeRoutingForMessageList(i,s,o,n,this.filters()),bMobileApp&&App.MailCache.currentMessage()&&o===App.MailCache.currentMessage().uid()&&App.MailCache.currentMessage.valueHasMutated()))}},CMessageListViewModel.prototype.onApplyBindings=function(e){var t=this,i=_.bind(function(e){e&&e.stopPropagation&&e.stopPropagation()},this);$(".message_list",e).on("click",function(){t.isFocused(!1)}).on("click",".message_sub_list .item .flag",function(e){t.onFlagClick(ko.dataFor(this)),e&&e.stopPropagation&&e.stopPropagation()}).on("dblclick",".message_sub_list .item .flag",i).on("click",".message_sub_list .item .thread",i).on("dblclick",".message_sub_list .item .thread",i),this.selector.initOnApplyBindings(".message_sub_list .item",".message_sub_list .item.selected",".message_sub_list .item .custom_checkbox",$(".message_list",e),$(".message_list_scroll.scroll-inner",e)),this.initUploader()},CMessageListViewModel.prototype.onFlagClick=function(e){this.isSavingDraft(e)||App.MailCache.executeGroupOperation("MessageSetFlagged",[e.uid()],"flagged",!e.flagged())},CMessageListViewModel.prototype.executeMarkAsRead=function(){App.MailCache.executeGroupOperation("MessageSetSeen",this.checkedOrSelectedUids(),"seen",!0)},CMessageListViewModel.prototype.executeMarkAsUnread=function(){App.MailCache.executeGroupOperation("MessageSetSeen",this.checkedOrSelectedUids(),"seen",!1)},CMessageListViewModel.prototype.executeMarkAllRead=function(){App.MailCache.executeGroupOperation("MessagesSetAllSeen",[],"seen",!0)},CMessageListViewModel.prototype.executeMoveToFolder=function(e){App.MailCache.moveMessagesToFolder(e,this.checkedOrSelectedUids())},CMessageListViewModel.prototype.executeCopyToFolder=function(e){App.MailCache.copyMessagesToFolder(e,this.checkedOrSelectedUids())},CMessageListViewModel.prototype.onDeletePress=function(e){var t=_.map(e,function(e){return e.uid()});t.length>0&&App.Api.deleteMessages(t,App)},CMessageListViewModel.prototype.executeDelete=function(){App.Api.deleteMessages(this.checkedOrSelectedUids(),App)},CMessageListViewModel.prototype.executeSpam=function(){var e=this.folderList().spamFolderFullName();this.folderList().currentFolderFullName()!==e&&App.MailCache.moveMessagesToFolder(e,this.checkedOrSelectedUids())},CMessageListViewModel.prototype.executeNotSpam=function(){var e=this.folderList().inboxFolder();e&&this.folderList().currentFolderFullName()!==e.fullName()&&App.MailCache.moveMessagesToFolder(e.fullName(),this.checkedOrSelectedUids())},CMessageListViewModel.prototype.clearAdvancedSearch=function(){this.searchInputFrom(""),this.searchInputTo(""),this.searchInputSubject(""),this.searchInputText(""),this.bAdvancedSearch(!1),this.searchAttachmentsCheckbox(!1),this.searchAttachments(""),this.searchDateStart(""),this.searchDateEnd("")},CMessageListViewModel.prototype.onAdvancedSearchClick=function(){this.bAdvancedSearch(!this.bAdvancedSearch())},CMessageListViewModel.prototype.calculateSearchStringForDescription=function(){return'<span class="part">'+Utils.encodeHtml(this.search())+"</span>"},CMessageListViewModel.prototype.initUploader=function(){var e=this;this.uploaderArea()&&(this.oJua=new Jua({action:"?/Upload/Message/",name:"jua-uploader",queueSize:2,dragAndDropElement:this.uploaderArea(),disableAjaxUpload:this.isPublic,disableFolderDragAndDrop:this.isPublic,disableDragAndDrop:this.isPublic,disableAutoUploadOnDrop:!0,hidden:{Token:function(){return AppData.Token},AccountID:function(){return AppData.Accounts.currentId()},AdditionalData:function(t){return JSON.stringify({Folder:e.folderFullName()})}}}),this.oJua.on("onDrop",_.bind(this.onFileDrop,this)).on("onComplete",_.bind(this.onFileUploadComplete,this)).on("onBodyDragEnter",_.bind(this.bDragActive,this,!0)).on("onBodyDragLeave",_.bind(this.bDragActive,this,!1)))},CMessageListViewModel.prototype.onFileDrop=function(e,t,i){e&&e.File&&e.File.type&&0===e.File.type.indexOf("message/")?i():App.Api.showError(Utils.i18n("MAILBOX/ERROR_INCORRECT_FILE_EXTENSION"))},CMessageListViewModel.prototype.onFileUploadComplete=function(e,t,i){var s=!t||!i||i.Error||i.Result.Error||!1;s?i.ErrorCode&&i.ErrorCode===Enums.Errors.IncorrectFileExtension?App.Api.showError(Utils.i18n("MAILBOX/ERROR_INCORRECT_FILE_EXTENSION")):App.Api.showError(Utils.i18n("WARNING/ERROR_UPLOAD_FILE")):App.MailCache.executeCheckMail(!0)},CMessagePaneViewModel.prototype.__name="CMessagePaneViewModel",CMessagePaneViewModel.prototype.resizeDblClick=function(e,t){""!==t.target.className&&t.target.className.search(/add_contact|icon|link|title|subject|link|date|from/)&&(Utils.calmEvent(t),Utils.removeSelection(),this.jqPanelHelper||(this.jqPanelHelper=$(".MailLayout .panel_helper")),this.jqPanelHelper.trigger("resize",[5,"min",!0]))},CMessagePaneViewModel.prototype.notifySender=function(){this.currentMessage()&&""!==this.currentMessage().readingConfirmation()&&(App.Ajax.send({Action:"MessageSendConfirmation",Confirmation:this.currentMessage().readingConfirmation(),Subject:Utils.i18n("MESSAGE/RETURN_RECEIPT_MAIL_SUBJECT"),Text:Utils.i18n("MESSAGE/RETURN_RECEIPT_MAIL_TEXT",{EMAIL:AppData.Accounts.getEmail(),SUBJECT:this.subject()}),ConfirmFolder:this.currentMessage().folder(),ConfirmUid:this.currentMessage().uid()}),this.currentMessage().readingConfirmation(""))},CMessagePaneViewModel.prototype.onFolderListSubscribe=function(){AppData.SingleMode&&this.onMessagesSubscribe()},CMessagePaneViewModel.prototype.onMessagesSubscribe=function(){!this.currentMessage()&&this.uid().length>0&&App.MailCache.setCurrentMessage(this.uid(),this.folder())},CMessagePaneViewModel.prototype.onCurrentMessageSubscribe=function(){var e=null,t=null,i=this.currentMessage(),s=i?AppData.Accounts.getAccount(i.accountId()):null;if(this.singleMode()&&window.opener&&window.opener.oReplyDataFromViewPane?(this.replyText(window.opener.oReplyDataFromViewPane.ReplyText),this.replyDraftUid(window.opener.oReplyDataFromViewPane.ReplyDraftUid),window.opener.oReplyDataFromViewPane=null):i&&i.uid()===this.displayedMessageUid()||(this.replyText(""),this.replyDraftUid("")),i&&this.uid()===i.uid()){if(this.subject(i.subject()),this.importance(i.importance()),this.from(i.oFrom.getDisplay()),this.fromEmail(i.oFrom.getFirstEmail()),this.fullFrom(i.oFrom.getFull()),i.oFrom.aCollection.length>0?this.oFromAddr(i.oFrom.aCollection[0]):this.oFromAddr(null),this.to(i.oTo.getFull()),this.aToAddr(i.oTo.aCollection),this.cc(i.oCc.getFull()),this.aCcAddr(i.oCc.aCollection),this.bcc(i.oBcc.getFull()),this.aBccAddr(i.oBcc.aCollection),this.currentAccountEmail(s.email()),this.aAllRecipients(_.uniq(_.union(this.aToAddr(),this.aCcAddr(),this.aBccAddr()))),this.mobileApp||this.requestContactsFromCache(_.union(i.oFrom.aCollection,this.aAllRecipients())),this.midDate(i.oDateModel.getMidDate()),this.fullDate(i.oDateModel.getFullDate()),this.isLoading(""!==i.uid()&&!i.completelyFilled()),this.setMessageBody(),this.rtlMessage(i.rtl()),this.singleMode()){var o=[],n=Date.now().toString();_.each(i.attachments(),_.bind(function(e){var t=new CMailAttachmentModel;t.copyProperties(e),t.getInThumbQueue(n),o.push(t)},this)),this.attachments(o)}else this.attachments(i.attachments());if(null!==this.ical()&&this.ical().animation(!1),e=i.ical(),e&&this.singleMode()&&(e=this.getIcalCopy(e)),this.ical(e),null!==this.ical()&&(_.defer(_.bind(function(){null!==this.ical()&&this.ical().animation(!0)},this)),this.ical().updateAttendeeStatus(this.fromEmail())),t=i.vcard(),t&&this.singleMode()&&(t=this.getVcardCopy(t)),this.vcard(t),!i.completelyFilled()||i.trimmed()){var a=i.completelyFilled()?i.trimmed:i.completelyFilled;this.singleMode()?i.completelyFilledSingleModeSubscription=a.subscribe(this.onCurrentMessageSubscribe,this):i.completelyFilledSubscription=a.subscribe(this.onCurrentMessageSubscribe,this)}else i.completelyFilledSubscription?(i.completelyFilledSubscription.dispose(),i.completelyFilledSubscription=void 0):i.completelyFilledSingleModeSubscription&&(i.completelyFilledSingleModeSubscription.dispose(),i.completelyFilledSingleModeSubscription=void 0)}else this.isLoading(!1),$(this.domTextBody()).empty().data("displayed-message-uid",""),this.displayedMessageUid(""),this.rtlMessage(!1),this.attachments([]),this.visiblePicturesControl(!1),this.visibleShowPicturesLink(!1),this.ical(null),this.vcard(null),this.decryptPassword(""),this.visibleDecryptControl(!1),this.visibleVerifyControl(!1)},CMessagePaneViewModel.prototype.updateMomentDate=function(){var e=this.currentMessage();e&&e.oDateModel&&(this.midDate(e.oDateModel.getMidDate()),this.fullDate(e.oDateModel.getFullDate()))},CMessagePaneViewModel.prototype.requestContactsFromCache=function(e){var t=_.map(e,function(e){return e.sEmail});this.recipientsContacts([]),App.ContactsCache.getContactsByEmails(t,this.onContactResponse,this)},CMessagePaneViewModel.prototype.onContactResponse=function(e,t){e&&(this.recipientsContacts.push(e),this.recipientsContacts(_.uniq(this.recipientsContacts()))),_.each(_.union([this.oFromAddr()],this.aAllRecipients()),function(i){i&&i.sEmail===t&&(i.loaded(!0),i.found(!!e))})},CMessagePaneViewModel.prototype.getVcardCopy=function(e){var t=new CVcardModel;return t.uid(e.uid()),t.file(e.file()),t.name(e.name()),t.email(e.email()),t.exists(e.exists()),t.isJustSaved(e.isJustSaved()),t},CMessagePaneViewModel.prototype.getIcalCopy=function(e){var t=new CIcalModel;return t.uid(e.uid()),t.file(e.file()),t.attendee(e.attendee()),t.type(e.type()),t.cancelDecision(e.cancelDecision()),t.replyDecision(e.replyDecision()),t.isJustSaved(e.isJustSaved()),t.location(e.location()),t.description(e.description()),t.when(e.when()),t.calendarId(e.calendarId()),t.selectedCalendarId(e.selectedCalendarId()),t.calendars(e.calendars()),t.animation(e.animation()),t},CMessagePaneViewModel.prototype.setMessageBody=function(){if(this.currentMessage()){var e=this.currentMessage(),t=e.text(),i=$(this.domTextBody()),s=null,o="",n=t.length,a=5e6,r=[];this.textBody(t),i.data("displayed-message-uid")===e.uid()&&(r=this.getBlockquotesStatus()),i.empty(),e.isPlain()||n>a?(i.html(t),this.visiblePicturesControl(!1)):(s=e.getDomText(),o=s.length>0?s.html():"",i.append(o),this.visiblePicturesControl(e.hasExternals()&&!e.isExternalsAlwaysShown()),this.visibleShowPicturesLink(!e.isExternalsShown()),Utils.htmlStartsWithBlockquote(o)||this.doHidingBlockquotes(r)),this.decryptPassword(""),this.visibleDecryptControl(AppData.User.enableOpenPgp()&&e.encryptedMessage()),this.visibleVerifyControl(AppData.User.enableOpenPgp()&&e.signedMessage()),i.data("displayed-message-uid",e.uid()),this.displayedMessageUid(e.uid()),i.find("[data-id='appointment_actions_part']").hide()}},CMessagePaneViewModel.prototype.getBlockquotesStatus=function(){var e=[];return $($("blockquote",$(this.domTextBody())).get()).each(function(){var t=$(this);t.hasClass("blockquote_before_toggle")&&e.push(t.hasClass("collapsed"))}),e},CMessagePaneViewModel.prototype.doHidingBlockquotes=function(e){var t=120,i=80,s=0;$($("blockquote",$(this.domTextBody())).get()).each(function(){var o=$(this),n=o.parents("blockquote"),a=$('<span class="blockquote_toggle"></span>').html(Utils.i18n("MESSAGE/SHOW_QUOTED_TEXT")),r=!0;0===n.length&&o.height()>t&&(o.addClass("blockquote_before_toggle").after(a).wrapInner('<div class="blockquote_content"></div>'),a.bind("click",function(){r?(o.height("auto"),a.html(Utils.i18n("MESSAGE/HIDE_QUOTED_TEXT")),r=!1):(o.height(i),a.html(Utils.i18n("MESSAGE/SHOW_QUOTED_TEXT")),r=!0),o.toggleClass("collapsed",r)}),s<e.length&&(r=e[s],s++),o.height(r?i:"auto").toggleClass("collapsed",r))})},CMessagePaneViewModel.prototype.onRoute=function(e){var t=App.Links.parseMailbox(e);""!==this.replyText()&&this.uid()!==t.Uid&&this.saveReplyMessage(!1),this.uid(t.Uid),this.folder(t.Folder),App.MailCache.setCurrentMessage(this.uid(),this.folder()),this.contentHasFocus(!0)},CMessagePaneViewModel.prototype.showPictures=function(){App.MailCache.showExternalPictures(!1),this.visibleShowPicturesLink(!1),this.setMessageBody()},CMessagePaneViewModel.prototype.alwaysShowPictures=function(){var e=this.currentMessage()?this.currentMessage().oFrom.getFirstEmail():"";e.length>0&&App.Ajax.send({Action:"EmailSetSafety",Email:e}),App.MailCache.showExternalPictures(!0),this.visiblePicturesControl(!1),this.setMessageBody()},CMessagePaneViewModel.prototype.openInNewWindow=function(){this.openMessageInNewWindowBinded(this.currentMessage())},CMessagePaneViewModel.prototype.addToContacts=function(e,t){App.Api.contactCreate(t,e,this.onContactResponse,this)},CMessagePaneViewModel.prototype.onAddToContactsResponse=function(e,t){e.Result&&""!==t.HomeEmail&&(App.Api.showReport(Utils.i18n("CONTACTS/REPORT_CONTACT_SUCCESSFULLY_ADDED")),App.ContactsCache.clearInfoAboutEmail(t.HomeEmail),App.ContactsCache.getContactsByEmails([t.HomeEmail],this.onContactResponse,this))},CMessagePaneViewModel.prototype.getReplyHtmlText=function(){return'<div style="font-family: '+this.defaultFontName+'; font-size: 16px">'+App.MessageSender.getHtmlFromText(this.replyText())+"</div>";
},CMessagePaneViewModel.prototype.executeReplyOrForward=function(e){this.currentMessage()&&(App.MessageSender.setReplyData(this.getReplyHtmlText(),this.replyDraftUid()),this.replyText(""),this.replyDraftUid(""),App.Api.composeMessageAsReplyOrForward(e,this.currentMessage().folder(),this.currentMessage().uid()))},CMessagePaneViewModel.prototype.executeDeleteMessage=function(){this.currentMessage()&&(this.singleMode()&&window.opener&&window.opener.App?App.Api.deleteMessages([this.currentMessage().uid()],window.opener.App,function(){window.close()}):this.mobileApp&&App.Api.deleteMessages([this.currentMessage().uid()],App))},CMessagePaneViewModel.prototype.executePrevMessage=function(){this.isEnablePrevMessage()&&this.moveToSingleMessageView(this.prevMessageUid())},CMessagePaneViewModel.prototype.executeNextMessage=function(){this.isEnableNextMessage()&&this.moveToSingleMessageView(this.nextMessageUid())},CMessagePaneViewModel.prototype.moveToSingleMessageView=function(e){var t=App.MailCache.folderList().currentFolderFullName(),i=[Enums.Screens.SingleMessageView,t,"msg"+e];App.Routing.setHash(i)},CMessagePaneViewModel.prototype.executeReply=function(){this.executeReplyOrForward(Enums.ReplyType.Reply)},CMessagePaneViewModel.prototype.executeReplyAll=function(){this.executeReplyOrForward(Enums.ReplyType.ReplyAll)},CMessagePaneViewModel.prototype.executeResend=function(){this.executeReplyOrForward(Enums.ReplyType.Resend)},CMessagePaneViewModel.prototype.executeForward=function(){this.executeReplyOrForward(Enums.ReplyType.Forward)},CMessagePaneViewModel.prototype.executePrint=function(){var e=this.currentMessage(),t=e?Utils.WindowOpener.open("",this.subject()+"-print"):null;e&&t&&(this.textBodyForNewWindow(e.getConvertedHtml(Utils.Common.getAppPath(),!0)),Utils.Message.displayPrintMessageInWindow(t,$(this.domMessageForPrint()).html()),t.print())},CMessagePaneViewModel.prototype.executeSave=function(){this.currentMessage()&&App.Api.downloadByUrl(this.currentMessage().downloadLink())},CMessagePaneViewModel.prototype.executeForwardAsAttachment=function(){this.currentMessage()&&App.Api.composeMessageWithEml(this.currentMessage())},CMessagePaneViewModel.prototype.executeSaveAsPdf=function(){if(this.currentMessage()){var e=this.currentMessage().getDomText(),t=this.currentMessage().accountId(),i=function(e){try{var t=document.createElement("canvas"),i=null;t.width=e.width,t.height=e.height,i=t.getContext("2d"),i.drawImage(e,0,0),e.src=t.toDataURL("image/png")}catch(e){}};$("img[data-x-src-cid]",e).each(function(){i(this)}),App.Ajax.send({Action:"MessageGetPdfFromHtml",Subject:this.subject(),Html:e.html()},function(e){e&&e.Result&&e.Result.Hash?App.Api.downloadByUrl(Utils.getDownloadLinkByHash(t,e.Result.Hash)):App.Api.showError(Utils.i18n("WARNING/CREATING_PDF_ERROR"))},this)}},CMessagePaneViewModel.prototype.changeAddMenuVisibility=function(){var e=!this.visibleAddMenu();this.visibleAddMenu(e)},CMessagePaneViewModel.prototype.onMessageSendOrSaveResponse=function(e,t){var i=App.MessageSender.onMessageSendOrSaveResponse(e,t,this.requiresPostponedSending());switch(i.Action){case"MessageSend":this.replySendingStarted(!1),i.Result&&this.replyText("");break;case"MessageSave":i.Result&&this.replyDraftUid(i.NewUid),this.replySavingStarted(!1),this.replyAutoSavingStarted(!1)}},CMessagePaneViewModel.prototype.executeSendQuickReplyCommand=function(){this.isEnableSendQuickReply()&&(this.replySendingStarted(!0),this.requiresPostponedSending(this.replyAutoSavingStarted()),App.MessageSender.sendReplyMessage("MessageSend",this.getReplyHtmlText(),this.replyDraftUid(),this.onMessageSendOrSaveResponse,this,this.requiresPostponedSending()),this.replyTextFocus(!1))},CMessagePaneViewModel.prototype.executeSaveQuickReply=function(){this.saveReplyMessage(!1)},CMessagePaneViewModel.prototype.saveReplyMessage=function(e){this.isEnableSaveQuickReply()&&(e?this.replyAutoSavingStarted(!0):this.replySavingStarted(!0),App.MessageSender.sendReplyMessage("MessageSave",this.getReplyHtmlText(),this.replyDraftUid(),this.onMessageSendOrSaveResponse,this))},CMessagePaneViewModel.prototype.stopAutosaveTimer=function(){window.clearTimeout(this.autoSaveTimer)},CMessagePaneViewModel.prototype.startAutosaveTimer=function(){if(this.isEnableSaveQuickReply()){var e=_.bind(this.saveReplyMessage,this,!0);this.stopAutosaveTimer(),AppData.User.AllowAutosaveInDrafts&&(this.autoSaveTimer=window.setTimeout(e,1e3*AppData.App.AutoSaveIntervalSeconds))}},CMessagePaneViewModel.prototype.downloadAllAttachments=function(){this.currentMessage()&&this.currentMessage().downloadAllAttachments()},CMessagePaneViewModel.prototype.saveAttachmentsToFiles=function(){this.currentMessage()&&this.currentMessage().saveAttachmentsToFiles()},CMessagePaneViewModel.prototype.downloadAllAttachmentsSeparately=function(){this.currentMessage()&&this.currentMessage().downloadAllAttachmentsSeparately()},CMessagePaneViewModel.prototype.onApplyBindings=function(e){App.registerSessionTimeoutFunction(_.bind(function(){""!==this.replyText()&&this.saveReplyMessage(!1)},this)),$(e).on("mousedown","a",function(e){if(e&&3!==e.which){var t=$(this).attr("href");if(t&&"mailto:"===t.toString().toLowerCase().substr(0,7))return App.Api.composeMessageToAddresses(t.toString()),!1}return!0}),this.hotKeysBind()},CMessagePaneViewModel.prototype.hotKeysBind=function(){$(document).on("keydown",$.proxy(function(e){var t=App.Screens.currentScreen()===Enums.Screens.Mailbox&&e&&!e.ctrlKey&&!e.shiftKey&&!Utils.isTextFieldFocused()&&this.isEnableReply();t&&e.keyCode===Enums.Key.q?(e.preventDefault(),this.replyTextFocus(!0)):t&&e.keyCode===Enums.Key.r&&this.executeReply()},this))},CMessagePaneViewModel.prototype.showSourceHeaders=function(){var e=this.currentMessage(),t=e&&e.completelyFilled()?Utils.WindowOpener.open("",this.subject()+"-headers"):null;t&&$(t.document.body).html("<pre>"+Utils.encodeHtml(e.sourceHeaders())+"</pre>")},CMessagePaneViewModel.prototype.onDecryptMessageClick=function(){this.currentMessage()&&this.currentMessage().encryptedMessage()&&this.decryptVerifyMessage(!1)},CMessagePaneViewModel.prototype.onVerifyMessageClick=function(){this.currentMessage()&&this.currentMessage().signedMessage()&&this.decryptVerifyMessage(!0)},CMessagePaneViewModel.prototype.decryptVerifyMessage=function(e){var t=_.bind(function(t){var i=this.currentMessage();t&&i&&(e&&i.signedMessage()?this.verifyMessage(t):i.encryptedMessage()&&this.decryptMessage(t))},this);App.Api.pgp(t,AppData.User.IdUser)},CMessagePaneViewModel.prototype.decryptMessage=function(e){var t=this.currentMessage(),i=t.textRaw(),s=AppData.Accounts.getEmail(),o=t.oFrom.getFirstEmail(),n=this.decryptPassword(),a=e.decryptAndVerify(i,s,o,n),r=!1;a&&a.result&&!a.errors&&(t.text("<pre>"+Utils.encodeHtml(a.result)+"</pre>"),t.$text=null,t.encryptedMessage(!1),this.decryptPassword(""),this.visibleDecryptControl(!1),this.setMessageBody(),a.notices?App.Api.showReport(Utils.i18n("OPENPGP/REPORT_MESSAGE_SUCCESSFULLY_DECRYPTED")):App.Api.showReport(Utils.i18n("OPENPGP/REPORT_MESSAGE_SUCCESSFULLY_DECRYPTED_AND_VERIFIED"))),a&&(a.errors||a.notices)&&(r=App.Api.showPgpErrorByCode(a,Enums.PgpAction.DecryptVerify),r&&App.Api.showReport(Utils.i18n("OPENPGP/REPORT_MESSAGE_SUCCESSFULLY_DECRYPTED_AND_NOT_SIGNED")))},CMessagePaneViewModel.prototype.verifyMessage=function(e){var t=this.currentMessage(),i=t.textRaw(),s=t.oFrom.getFirstEmail(),o=e.verify(i,s);o&&o.result&&!o.errors&&!o.notices&&(t.text("<pre>"+Utils.encodeHtml(o.result)+"</pre>"),t.$text=null,t.signedMessage(!1),this.visibleVerifyControl(!1),this.setMessageBody(),App.Api.showReport(Utils.i18n("OPENPGP/REPORT_MESSAGE_SUCCESSFULLY_VERIFIED"))),o&&(o.errors||o.notices)&&App.Api.showPgpErrorByCode(o,Enums.PgpAction.Verify)},CMessagePaneViewModel.prototype.switchDetailsVisibility=function(){this.detailsVisible(!this.detailsVisible()),App.Storage.setData("MessageDetailsVisible",this.detailsVisible()?"1":"0")},CMailViewModel.prototype.executeCompose=function(){App.Api.composeMessage()},CMailViewModel.prototype.executeCheckMail=function(){App.MailCache.checkMessageFlags(),App.MailCache.executeCheckMail(!0)},CMailViewModel.prototype.openMessageInNewWindow=function(e){var t=this.folderList().getFolderByFullName(e.folder()),i=t.type()===Enums.FolderTypes.Drafts;!this.oMessagePane.currentMessage()||this.oMessagePane.currentMessage().uid()!==e.uid()||""===this.oMessagePane.replyText()&&""===this.oMessagePane.replyDraftUid()||(window.oReplyDataFromViewPane={ReplyText:this.oMessagePane.replyText(),ReplyDraftUid:this.oMessagePane.replyDraftUid()},this.oMessagePane.replyText(""),this.oMessagePane.replyDraftUid("")),Utils.WindowOpener.openMessage(e,i)},CMailViewModel.prototype.gotoFolderList=function(){this.changeSelectedPanel(Enums.MobilePanel.Groups)},CMailViewModel.prototype.gotoMessageList=function(){return this.changeSelectedPanel(Enums.MobilePanel.Items),!0},CMailViewModel.prototype.gotoMessagePane=function(){App.MailCache.currentMessage()?this.changeSelectedPanel(Enums.MobilePanel.View):this.gotoMessageList()},CMailViewModel.prototype.changeSelectedPanel=function(e){this.mobileApp&&this.selectedPanel()!==e&&(this.selectedPanel(e),(bIsWindowsPhone||App.browser.ie)&&(this.$viewModel.hide(),_.defer(_.bind(function(){this.$viewModel.show()},this))))},CMailViewModel.prototype.resizeDblClick=function(e,t){t.preventDefault(),t.stopPropagation?t.stopPropagation():t.cancelBubble=!0,Utils.removeSelection(),this.jqPanelHelper||(this.jqPanelHelper=$(".MailLayout .panel_helper")),this.jqPanelHelper.trigger("resize",[600,"max"])},CMailViewModel.prototype.onRoute=function(e){this.oMessageList.onRoute(e),this.oMessagePane.onRoute(e)},CMailViewModel.prototype.onShow=function(){this.oMessageList.onShow()},CMailViewModel.prototype.onHide=function(){this.oMessageList.onHide()},CMailViewModel.prototype.onApplyBindings=function(){var e=this;this.oMessageList.onApplyBindings(this.$viewModel),this.oMessagePane.onApplyBindings(this.$viewModel),$(this.domFolderList()).on("click","span.folder",function(t){e.folderList().currentFolderFullName()!==$(this).data("folder")&&(t.ctrlKey?e.oMessageList.executeCopyToFolder($(this).data("folder")):e.oMessageList.executeMoveToFolder($(this).data("folder")))}),this.hotKeysBind()},CMailViewModel.prototype.hotKeysBind=function(){$(document).on("keydown",$.proxy(function(e){var t=e.keyCode,i=e&&!e.ctrlKey&&!e.altKey&&!e.shiftKey&&!Utils.isTextFieldFocused()&&App.Screens.currentScreen()===Enums.Screens.Mailbox,s=this.oMessageList,o=s.collection()[0],n=o&&App.MailCache.currentMessage()&&o.uid()===App.MailCache.currentMessage().uid();i&&t===Enums.Key.s||i&&n&&t===Enums.Key.Up?(e.preventDefault(),this.searchFocus()):s.isFocused()&&e&&t===Enums.Key.Down&&o?(e.preventDefault(),s.isFocused(!1),s.routeForMessage(o)):i&&t===Enums.Key.n&&(window.location.href="#compose")},this))},CMailViewModel.prototype.dragAndDropHelper=function(e,t){e&&e.checked(!0);var i=Utils.draggableMessages(),s=this.oMessageList.checkedOrSelectedUids(),o=s.length;return i.data("p7-message-list-folder",this.folderList().currentFolderFullName()),i.data("p7-message-list-uids",s),$(".count-text",i).text(Utils.i18n("MAILBOX/DRAG_TEXT_PLURAL",{COUNT:t?"+ "+o:o},null,o)),i},CMailViewModel.prototype.messagesDrop=function(e,t,i){if(e){var s=i&&i.helper?i.helper:null,o=s?s.data("p7-message-list-folder"):"",n=s?s.data("p7-message-list-uids"):null;""!==o&&null!==n&&(Utils.uiDropHelperAnim(t,i),t.ctrlKey?this.oMessageList.executeCopyToFolder(e.fullName()):this.oMessageList.executeMoveToFolder(e.fullName()),this.uncheckMessages())}},CMailViewModel.prototype.searchFocus=function(){this.oMessageList.selector.useKeyboardKeys()&&!Utils.isTextFieldFocused()&&this.oMessageList.isFocused(!0)},CMailViewModel.prototype.backToList=function(){App.Routing.setPreviousHash()},CMailViewModel.prototype.onVolumerClick=function(e,t){t.stopPropagation()},CMailViewModel.prototype.uncheckMessages=function(){_.each(App.MailCache.messages(),function(e){e.checked(!1)})},CComposeViewModel.prototype.__name="CComposeViewModel",CComposeViewModel.prototype.isEnableSending=function(){var e=0===this.toAddr().length&&0===this.ccAddr().length&&0===this.bccAddr().length,t=this.folderList()&&0!==this.folderList().iAccountId;return t&&!this.sending()&&!e&&this.allAttachmentsUploaded()},CComposeViewModel.prototype.isEnableSaving=function(){var e=this.folderList()&&0!==this.folderList().iAccountId;return this.shown()&&e&&!this.sending()&&!this.saving()},CComposeViewModel.prototype.initInputosaurus=function(e,t,i,s){e()&&$(e()).length>0&&$(e()).inputosaurus({width:"auto",parseOnBlur:!0,autoCompleteSource:_.bind(function(e,t){this.autocompleteCallback(e.term,t)},this),autoCompleteDeleteItem:_.bind(function(e){this.autocompleteDeleteItem(e)},this),autoCompleteAppendTo:$(e()).closest("td"),change:_.bind(function(e){i(!0),this.setRecipient(t,e.target.value),this.minHeightAdjustTrigger(!0),i(!1)},this),copy:_.bind(function(e){this.inputosaurusBuffer=e},this),paste:_.bind(function(){var e=this.inputosaurusBuffer||"";return this.inputosaurusBuffer="",e},this),focus:_.bind(this.focusedField,this,s),mobileDevice:bMobileDevice})},CComposeViewModel.prototype.fromToExpandColaps=function(){this.fromToExpandColapssed(!this.fromToExpandColapssed()),this.oHtmlEditor.resize()},CComposeViewModel.prototype.onApplyBindings=function(){this.$viewModel.on("resize",".panel_content",_.debounce(_.bind(function(){this.oHtmlEditor.resize()},this),1)),ko.computed(function(){this.visibleBcc(),this.visibleCc(),this.fromToExpandColapssed(),this.oHtmlEditor.resize()},this),App.registerSessionTimeoutFunction(_.bind(this.executeSave,this,!1)),this.hotKeysBind()},CComposeViewModel.prototype.hotKeysBind=function(){AppData.App.AllowComposeShortcuts&&this.$viewModel.on("keydown",$.proxy(function(e){if(e&&e.ctrlKey&&!e.altKey&&!e.shiftKey){var t=e.keyCode,i=this.shown()&&(!this.minimized||!this.minimized()),s=i&&e&&e.ctrlKey,o=Enums.Key;s&&t===o.s?(e.preventDefault(),e.returnValue=!1,this.isEnableSaving()&&this.saveCommand()):s&&t===o.Enter&&""!==this.toAddr()&&this.sendCommand()}},this))},CComposeViewModel.prototype.getMessageOnRoute=function(){var e=this.routeParams(),t="",i="";""!==this.routeType()&&3===e.length&&(t=e[1],i=e[2],App.MailCache.getMessage(t,i,this.onMessageResponse,this))},CComposeViewModel.prototype.onShow=function(){var e=this.focusedField();this.shown(!0),$(this.splitterDom()).trigger("resize"),this.useSaveMailInSentItems(AppData.User.getUseSaveMailInSentItems()),this.saveMailInSentItems(AppData.User.getSaveMailInSentItems()),this.oHtmlEditor.initCrea(this.textBody(),this.plainText(),"7"),this.oHtmlEditor.commit(),this.initUploader(),this.backToListOnSendOrSave(!1),this.startAutosaveTimer(),this.focusedField(e),$html.addClass("screen-compose"),this.oJua&&this.oJua.setDragAndDropEnabledStatus(!0)},CComposeViewModel.prototype.onRoute=function(e){var t="",i={};switch(this.plainText(!1),this.pgpSecured(!1),this.pgpEncrypted(!1),this.fromDrafts(!1),this.bUploadStatus=!1,window.clearTimeout(this.iUploadAttachmentsTimer),this.messageUploadAttachmentsStarted(!1),this.templateUid(""),this.templateFolderName(App.MailCache.getTemplateFolder()),this.draftUid(""),this.draftInfo.removeAll(),this.setDataFromMessage(new CMessageModel),this.isDraftsCleared(!1),this.routeType(e.length>0?e[0]:""),this.routeType()){case Enums.ReplyType.Reply:case Enums.ReplyType.ReplyAll:case Enums.ReplyType.Resend:case Enums.ReplyType.Forward:case"drafts":this.routeParams(e),0!==this.folderList().iAccountId&&this.getMessageOnRoute();break;default:t=App.MessageSender.getSignatureText(this.senderAccountId(),this.selectedFetcherOrIdentity(),!0),AppData.SingleMode&&window.opener&&window.opener.aMessagesParametersFromCompose&&window.opener.aMessagesParametersFromCompose[window.name]?this.setMessageDataInSingleMode(window.opener.aMessagesParametersFromCompose[window.name]):""!==t&&this.textBody("<br /><br />"+t+"<br />"),"to"===this.routeType()&&2===e.length&&(i=App.Links.parseToAddr(e[1]),this.setRecipient(this.toAddr,i.to),i.hasMailto&&(this.subject(i.subject),this.setRecipient(this.ccAddr,i.cc),this.setRecipient(this.bccAddr,i.bcc),""!==i.body&&this.textBody("<div>"+i.body+"</div>"))),this.fillFieldsFromObject(e),"vcard"===this.routeType()&&2===e.length&&this.addContactAsAttachment(e[1]),"eml"===this.routeType()&&2===e.length&&this.addMessageAsAttachment(e[1]),"file"===this.routeType()&&2===e.length&&this.addFilesAsAttachment(e[1]),"data-as-file"===this.routeType()&&3===e.length&&this.addDataAsAttachment(e[1],e[2]),_.defer(_.bind(function(){this.focusAfterFilling()},this))}this.visibleCc(""!==this.ccAddr()),this.visibleBcc(""!==this.bccAddr()),this.commit(!0),this.allowFiles(AppData.User.IsFilesSupported&&AppData.User.filesEnable()),AppData.SingleMode&&this.changedInPreviousWindow()&&_.defer(_.bind(this.executeSave,this,!0))},CComposeViewModel.prototype.focusToAddr=function(){$(this.toAddrDom()).inputosaurus("focus")},CComposeViewModel.prototype.focusCcAddr=function(){$(this.ccAddrDom()).inputosaurus("focus")},CComposeViewModel.prototype.focusBccAddr=function(){$(this.bccAddrDom()).inputosaurus("focus")},CComposeViewModel.prototype.focusAfterFilling=function(){var e=!this.singleMode();if(this.singleMode())switch(this.focusedField()){case"to":this.focusToAddr();break;case"cc":this.visibleCc(!0),this.focusCcAddr();break;case"bcc":this.visibleBcc(!0),this.focusBccAddr();break;case"subject":this.subjectFocused(!0);break;case"text":this.oHtmlEditor.setFocus();break;default:e=!0}e&&(0===this.toAddr().length?this.focusToAddr():0===this.subject().length?this.subjectFocused(!0):this.oHtmlEditor.setFocus())},CComposeViewModel.prototype.beforeHide=function(e){var t=Utils.i18n("COMPOSE/CONFIRM_DISCARD_CHANGES"),i=_.bind(function(t){t&&Utils.isFunc(e)?(this.commit(),e()):App.Routing.historyBackWithoutParsing(Enums.Screens.Compose)},this);!this.closeBecauseSingleCompose()&&this.hasSomethingToSave()?App.Screens.showPopup(ConfirmPopup,[t,i]):Utils.isFunc(e)&&e()},CComposeViewModel.prototype.onHide=function(){this.clearFields()},CComposeViewModel.prototype.clearFields=function(){this.stopAutosaveTimer(),!Utils.isFunc(this.closeCommand)&&this.hasSomethingToSave()&&this.executeSave(!0),this.fromToExpandColapssed(!1),this.shown(!1),this.routeParams([]),this.subjectFocused(!1),this.focusedField(""),this.oHtmlEditor.closeAllPopups(),this.oHtmlEditor.visibleLinkPopup(!1),this.messageUploadAttachmentsStarted(!1),$html.removeClass("screen-compose").removeClass("screen-compose-cc").removeClass("screen-compose-bcc").removeClass("screen-compose-attachments"),this.minHeightRemoveTrigger(!0),this.oJua&&this.oJua.setDragAndDropEnabledStatus(!1)},CComposeViewModel.prototype.sendingAndSavingSubscription=function(){(this.sending()||this.saving())&&this.stopAutosaveTimer(),this.sending()||this.saving()||this.startAutosaveTimer()},CComposeViewModel.prototype.stopAutosaveTimer=function(){window.clearTimeout(this.autoSaveTimer)},CComposeViewModel.prototype.startAutosaveTimer=function(){if(this.shown()&&!this.pgpSecured()){var e=_.bind(this.executeSave,this,!0);this.stopAutosaveTimer(),AppData.User.AllowAutosaveInDrafts&&(this.autoSaveTimer=window.setTimeout(e,1e3*AppData.App.AutoSaveIntervalSeconds))}},CComposeViewModel.prototype.setRecipient=function(e,t){e()===t?e.valueHasMutated():e(t)},CComposeViewModel.prototype.onMessageResponse=function(e){var t=null;if(null===e)this.setDataFromMessage(new CMessageModel);else{switch(this.routeType()){case Enums.ReplyType.Reply:case Enums.ReplyType.ReplyAll:this.oSenderSelector.setFetcherOrIdentityByReplyMessage(e),t=App.MessageSender.getReplyDataFromMessage(e,this.routeType(),this.senderAccountId(),this.selectedFetcherOrIdentity(),!0),this.draftInfo(t.DraftInfo),this.draftUid(t.DraftUid),this.setRecipient(this.toAddr,t.To),this.setRecipient(this.ccAddr,t.Cc),this.setRecipient(this.bccAddr,t.Bcc),this.subject(t.Subject),this.textBody(t.Text),this.attachments(t.Attachments),this.inReplyTo(t.InReplyTo),this.references(t.References);break;case Enums.ReplyType.Forward:this.oSenderSelector.setFetcherOrIdentityByReplyMessage(e),t=App.MessageSender.getReplyDataFromMessage(e,this.routeType(),this.senderAccountId(),this.selectedFetcherOrIdentity(),!0),this.draftInfo(t.DraftInfo),this.draftUid(t.DraftUid),this.setRecipient(this.toAddr,t.To),this.setRecipient(this.ccAddr,t.Cc),this.subject(t.Subject),this.textBody(t.Text),this.attachments(t.Attachments),this.inReplyTo(t.InReplyTo),this.references(t.References);break;case Enums.ReplyType.Resend:this.setDataFromMessage(e);break;case"drafts":-1!==Utils.inArray(e.folder(),App.MailCache.getCurrentTemplateFolders())?(this.templateUid(e.uid()),this.templateFolderName(e.folder())):this.draftUid(e.uid()),this.setDataFromMessage(e),this.fromDrafts(!0)}this.routeType("")}this.attachments().length>0&&this.requestAttachmentsTempName(),this.visibleCc(""!==this.ccAddr()),this.visibleBcc(""!==this.bccAddr()),this.commit(!0),_.defer(_.bind(function(){this.focusAfterFilling()},this)),this.minHeightAdjustTrigger(!0)},CComposeViewModel.prototype.setDataFromMessage=function(e){var t="",i=!1,s=!1,o=App.MessageSender.getFirstFetcherOrIdentityByRecipientsOrDefault(e.oFrom.aCollection,e.accountId());this.oSenderSelector.changeSenderAccountId(e.accountId(),o),e.isPlain()?(i=e.textRaw().indexOf("-----BEGIN PGP MESSAGE-----")!==-1,s=e.textRaw().indexOf("-----BEGIN PGP SIGNED MESSAGE-----")!==-1,s||i?(t=e.textRaw(),this.pgpSecured(!0),this.pgpEncrypted(i)):t=e.textRaw()):t=e.getConvertedHtml(),this.draftInfo(e.draftInfo()),this.inReplyTo(e.inReplyTo()),this.references(e.references()),this.setRecipient(this.toAddr,e.oTo.getFull()),this.setRecipient(this.ccAddr,e.oCc.getFull()),this.setRecipient(this.bccAddr,e.oBcc.getFull()),this.subject(e.subject()),this.attachments(_.map(e.attachments(),function(e){return e.getCopy()})),this.plainText(e.isPlain()),this.textBody(t),this.selectedImportance(e.importance()),this.selectedSensitivity(e.sensitivity()),this.readingConfirmation(e.readingConfirmation())},CComposeViewModel.prototype.addDataAsAttachment=function(e,t){var i="data-as-attachment-"+Math.random(),s={Action:"DataAsAttachmentUpload",Data:e,FileName:t,Hash:i},o=new CMailAttachmentModel;this.subject(t.substr(0,t.length-4)),o.fileName(t),o.hash(i),o.uploadStarted(!0),this.attachments.push(o),this.messageUploadAttachmentsStarted(!0),App.Ajax.send(s,this.onDataAsAttachmentUpload,this)},CComposeViewModel.prototype.onDataAsAttachmentUpload=function(e,t){var i=e.Result,s=t.Hash,o=_.find(this.attachments(),function(e){return e.hash()===s});this.messageUploadAttachmentsStarted(!1),o&&(i&&i.Attachment?o.parseFromUpload(i.Attachment,e.AccountID):o.errorFromUpload())},CComposeViewModel.prototype.addFilesAsAttachment=function(e){var t=null,i=[],s=null;_.each(e,function(e){t=new CMailAttachmentModel,t.fileName(e.fileName()),t.hash(e.hash()),t.thumb(e.thumb()),t.uploadStarted(!0),this.attachments.push(t),i.push(e.hash())},this),i.length>0&&(s={Action:"FilesUpload",Hashes:i},this.messageUploadAttachmentsStarted(!0),App.Ajax.send(s,this.onFilesUpload,this))},CComposeViewModel.prototype.onFilesUpload=function(e,t){var i=e.Result,s=t.Hashes,o=Date.now().toString();this.messageUploadAttachmentsStarted(!1),$.isArray(i)?_.each(i,function(t){var i=_.find(this.attachments(),function(e){return e.hash()===t.Hash});i&&(i.parseFromUpload(t,e.AccountID),i.hash(t.NewHash),i.getInThumbQueue(o))},this):_.each(s,function(e){var t=_.find(this.attachments(),function(t){return t.hash()===e});t&&t.errorFromUpload()},this)},CComposeViewModel.prototype.addMessageAsAttachment=function(e){var t=new CMailAttachmentModel,i=null;e&&(t.fileName(e.subject()+".eml"),t.uploadStarted(!0),this.attachments.push(t),i={Action:"MessageEmlUpload",MessageFolder:e.folder(),MessageUid:e.uid(),Name:t.fileName()},this.messageUploadAttachmentsStarted(!0),App.Ajax.send(i,this.onMessageEmlUpload,this))},CComposeViewModel.prototype.onMessageEmlUpload=function(e,t){var i=e.Result,s=null;this.messageUploadAttachmentsStarted(!1),i?(s=_.find(this.attachments(),function(e){return e.fileName()===t.Name&&e.uploadStarted()}),s&&s.parseFromUpload(i,e.AccountID)):(s=_.find(this.attachments(),function(e){return e.fileName()===t.Name&&e.uploadStarted()}),s&&s.errorFromUpload())},CComposeViewModel.prototype.addContactAsAttachment=function(e){var t=new CMailAttachmentModel,i=null;e&&(t.fileName("contact-"+e.idContact()+".vcf"),t.uploadStarted(!0),this.attachments.push(t),i={Action:"ContactVCardUpload",ContactId:e.idContact(),Global:e.global()?"1":"0",Name:t.fileName(),SharedWithAll:e.sharedToAll()?"1":"0"},this.messageUploadAttachmentsStarted(!0),App.Ajax.send(i,this.onContactVCardUpload,this))},CComposeViewModel.prototype.onContactVCardUpload=function(e,t){var i=e.Result,s=null;this.messageUploadAttachmentsStarted(!1),i?(s=_.find(this.attachments(),function(e){return e.fileName()===i.Name&&e.uploadStarted()}),s&&s.parseFromUpload(i,e.AccountID)):(s=_.find(this.attachments(),function(e){return e.fileName()===t.Name&&e.uploadStarted()}),s&&s.errorFromUpload())},CComposeViewModel.prototype.requestAttachmentsTempName=function(){var e=_.map(this.attachments(),function(e){return e.uploadUid(e.hash()),e.uploadStarted(!0),e.hash()}),t={Action:"MessageAttachmentsUpload",Attachments:e};e.length>0&&(this.messageUploadAttachmentsStarted(!0),App.Ajax.send(t,this.onMessageUploadAttachmentsResponse,this))},CComposeViewModel.prototype.onMessageUploadAttachmentsResponse=function(e,t){var i=t.Attachments;this.messageUploadAttachmentsStarted(!1),e.Result?_.each(e.Result,_.bind(this.setAttachTepmNameByHash,this)):(_.each(i,function(e){var t=_.find(this.attachments(),function(t){return t.hash()===e});t&&t.errorFromUpload()},this),App.Api.showError(Utils.i18n("COMPOSE/UPLOAD_ERROR_REPLY_ATTACHMENTS")))},CComposeViewModel.prototype.setAttachTepmNameByHash=function(e,t){_.each(this.attachments(),function(i){i.hash()===e&&(i.tempName(t),i.uploadStarted(!1))})},CComposeViewModel.prototype.setMessageDataInSingleMode=function(e){this.draftInfo(e.draftInfo),this.draftUid(e.draftUid),this.templateUid(e.templateUid),this.templateFolderName(e.templateFolderName),this.inReplyTo(e.inReplyTo),this.references(e.references),this.setRecipient(this.toAddr,e.toAddr),this.setRecipient(this.ccAddr,e.ccAddr),this.setRecipient(this.bccAddr,e.bccAddr),this.subject(e.subject),this.attachments(_.map(e.attachments,function(e){var t=new CMailAttachmentModel;return t.parse(e,this.senderAccountId()),t},this)),this.textBody(e.textBody),this.selectedImportance(e.selectedImportance),this.selectedSensitivity(e.selectedSensitivity),this.readingConfirmation(e.readingConfirmation),this.changedInPreviousWindow(e.changedInPreviousWindow),this.oSenderSelector.changeSenderAccountId(e.senderAccountId,e.selectedFetcherOrIdentity),this.focusedField(e.focusedField)},CComposeViewModel.prototype.commit=function(e){this.toAddr.commit(),this.ccAddr.commit(),this.bccAddr.commit(),this.subject.commit(),this.oHtmlEditor.commit(),this.attachmentsChanged(!1),e||this.changedInPreviousWindow(!1)},CComposeViewModel.prototype.isChanged=function(){var e=this.toAddr.changed(),t=this.ccAddr.changed(),i=this.bccAddr.changed(),s=this.subject.changed(),o=this.oHtmlEditor.textChanged(),n=this.attachmentsChanged(),a=this.changedInPreviousWindow();return e||t||i||s||o||n||a},CComposeViewModel.prototype.executeBackToList=function(){AppData.SingleMode?window.close():this.shown()&&App.Routing.setPreviousHash(),this.backToListOnSendOrSave(!1)},CComposeViewModel.prototype.onFileUploadSelect=function(e,t){var i;return!App.Api.showErrorIfAttachmentSizeLimit(t.FileName,Utils.pInt(t.Size))&&(i=new CMailAttachmentModel,i.onUploadSelect(e,t),this.attachments.push(i),!0)},CComposeViewModel.prototype.getAttachmentByUid=function(e){return _.find(this.attachments(),function(t){return t.uploadUid()===e})},CComposeViewModel.prototype.onFileUploadStart=function(e){var t=this.getAttachmentByUid(e);t&&t.onUploadStart()},CComposeViewModel.prototype.onFileUploadProgress=function(e,t,i){var s=this.getAttachmentByUid(e);s&&s.onUploadProgress(t,i)},CComposeViewModel.prototype.onFileUploadComplete=function(e,t,i){var s=this.getAttachmentByUid(e),o=Date.now().toString();s&&(s.onUploadComplete(e,t,i),"image"===s.type().substr(0,5)&&(s.thumb(!0),s.getInThumbQueue(o)))},CComposeViewModel.prototype.onFileRemove=function(e){var t=this.getAttachmentByUid(e);this.oJua&&this.oJua.cancel(e),this.attachments.remove(t)},CComposeViewModel.prototype.initUploader=function(){this.shown()&&this.composeUploaderButton()&&null===this.oJua&&(this.oJua=new Jua({action:"?/Upload/Attachment/",name:"jua-uploader",queueSize:2,clickElement:this.composeUploaderButton(),hiddenElementsPosition:Utils.isRTL()?"right":"left",dragAndDropElement:this.composeUploaderDropPlace(),disableAjaxUpload:!1,disableFolderDragAndDrop:!1,disableDragAndDrop:!1,hidden:{Token:function(){return AppData.Token},AccountID:function(){return AppData.Accounts.currentId()}}}),this.oJua.on("onDragEnter",_.bind(this.composeUploaderDragOver,this,!0)).on("onDragLeave",_.bind(this.composeUploaderDragOver,this,!1)).on("onBodyDragEnter",_.bind(this.composeUploaderBodyDragOver,this,!0)).on("onBodyDragLeave",_.bind(this.composeUploaderBodyDragOver,this,!1)).on("onProgress",_.bind(this.onFileUploadProgress,this)).on("onSelect",_.bind(this.onFileUploadSelect,this)).on("onStart",_.bind(this.onFileUploadStart,this)).on("onComplete",_.bind(this.onFileUploadComplete,this)),this.allowDragNDrop(this.oJua.isDragAndDropSupported()))},CComposeViewModel.prototype.getSendSaveParameters=function(e,t){var i=App.MessageSender.convertAttachmentsForSending(this.attachments()),s=null;return _.each(this.oHtmlEditor.uploadedImagePathes(),function(e){i[e.TempName]=[e.Name,e.CID,"1","1"]}),s={AccountID:this.senderAccountId(),FetcherID:this.selectedFetcherOrIdentity()&&this.selectedFetcherOrIdentity().FETCHER?this.selectedFetcherOrIdentity().id():"",IdentityID:this.selectedFetcherOrIdentity()&&!this.selectedFetcherOrIdentity().FETCHER?this.selectedFetcherOrIdentity().id():"",DraftInfo:this.draftInfo(),DraftUid:this.draftUid(),To:this.toAddr(),Cc:this.ccAddr(),Bcc:this.bccAddr(),Subject:this.subject(),Text:this.plainText()?this.oHtmlEditor.getPlainText():this.oHtmlEditor.getText(e),IsHtml:this.plainText()?"0":"1",Importance:this.selectedImportance(),Sensitivity:this.selectedSensitivity(),ReadingConfirmation:this.readingConfirmation()?"1":"0",Attachments:i,InReplyTo:this.inReplyTo(),References:this.references()},""!==this.templateFolderName()&&t&&(s.DraftFolder=this.templateFolderName(),s.DraftUid=this.templateUid()),s},CComposeViewModel.prototype.onMessageSendOrSaveResponse=function(e,t){var i=App.MessageSender.onMessageSendOrSaveResponse(e,t,this.requiresPostponedSending());switch(this.commit(),i.Action){case"MessageSave":i.Result&&t.DraftUid===this.templateUid()&&t.DraftFolder===this.templateFolderName()?(this.templateUid(Utils.pString(i.NewUid)),AppData.SingleMode&&App.Routing.replaceHashDirectly(App.Links.composeFromMessage("drafts",t.DraftFolder,this.templateUid()))):i.Result&&t.DraftUid===this.draftUid()&&(this.draftUid(Utils.pString(i.NewUid)),AppData.SingleMode&&App.Routing.replaceHashDirectly(App.Links.composeFromMessage("drafts",t.DraftFolder,this.draftUid()))),this.saving(!1);break;case"MessageSend":i.Result&&this.backToListOnSendOrSave()&&(Utils.isFunc(this.closeCommand)?this.closeCommand():this.executeBackToList()),this.sending(!1)}},CComposeViewModel.prototype.verifyDataForSending=function(){var e=Utils.Address.getIncorrectEmailsFromAddressString(this.toAddr()),t=Utils.Address.getIncorrectEmailsFromAddressString(this.ccAddr()),i=Utils.Address.getIncorrectEmailsFromAddressString(this.bccAddr()),s=_.union(e,t,i),o=Utils.i18n("COMPOSE/WARNING_INPUT_CORRECT_EMAILS")+s.join(", ");return!(s.length>0)||(App.Screens.showPopup(AlertPopup,[o]),!1)},CComposeViewModel.prototype.executeSend=function(e){var t=e===!0;
this.isEnableSending()&&this.verifyDataForSending()&&(!t&&this.enableOpenPgp()&&AppData.User.AutosignOutgoingEmails&&!this.pgpSecured()?this.openPgpPopup(!0):(this.sending(!0),this.requiresPostponedSending(!this.allowStartSending()),App.MessageSender.send("MessageSend",this.getSendSaveParameters(!0),this.saveMailInSentItems(),!0,this.onMessageSendOrSaveResponse,this,this.requiresPostponedSending())),this.backToListOnSendOrSave(!0))},CComposeViewModel.prototype.executeSaveCommand=function(){this.executeSave(!1)},CComposeViewModel.prototype.executeTemplateSaveCommand=function(){this.executeSave(!1,!0,!0)},CComposeViewModel.prototype.executeSave=function(e,t,i){if(e=!Utils.isUnd(e)&&e,t=!!Utils.isUnd(t)||t,i=!Utils.isUnd(i)&&i,!e||!App.MailCache.disableComposeAutosave()){var s=Utils.i18n("OPENPGP/CONFIRM_SAVE_ENCRYPTED_DRAFT"),o=Utils.i18n("COMPOSE/TOOL_SAVE"),n=_.bind(function(s){s&&(t?(this.saving(!0),App.MessageSender.send("MessageSave",this.getSendSaveParameters(!1,i),this.saveMailInSentItems(),!e,this.onMessageSendOrSaveResponse,this)):App.MessageSender.send("MessageSave",this.getSendSaveParameters(!1,i),this.saveMailInSentItems(),!e,App.MessageSender.onMessageSendOrSaveResponse,App.MessageSender))},this);this.isEnableSaving()&&(!e||this.isChanged()?!e&&this.pgpSecured()?App.Screens.showPopup(ConfirmPopup,[s,n,"",o]):n(!0):e&&this.startAutosaveTimer(),this.backToListOnSendOrSave(!0))}},CComposeViewModel.prototype.changeBccVisibility=function(){this.visibleBcc(!this.visibleBcc()),this.visibleBcc()?this.focusBccAddr():this.focusToAddr()},CComposeViewModel.prototype.changeCcVisibility=function(){this.visibleCc(!this.visibleCc()),this.visibleCc()?this.focusCcAddr():this.focusToAddr()},CComposeViewModel.prototype.getMessageDataForSingleMode=function(){var e=_.map(this.attachments(),function(e){return{"@Object":"Object/CApiMailAttachment",FileName:e.fileName(),TempName:e.tempName(),MimeType:e.type(),MimePartIndex:e.mimePartIndex(),EstimatedSize:e.size(),CID:e.cid(),ContentLocation:e.contentLocation(),IsInline:e.inline(),IsLinked:e.linked(),Hash:e.hash()}});return{accountId:this.senderAccountId(),draftInfo:this.draftInfo(),draftUid:this.draftUid(),templateUid:this.templateUid(),templateFolderName:this.templateFolderName(),inReplyTo:this.inReplyTo(),references:this.references(),senderAccountId:this.senderAccountId(),selectedFetcherOrIdentity:this.selectedFetcherOrIdentity(),toAddr:this.toAddr(),ccAddr:this.ccAddr(),bccAddr:this.bccAddr(),subject:this.subject(),attachments:e,textBody:this.oHtmlEditor.getText(),selectedImportance:this.selectedImportance(),selectedSensitivity:this.selectedSensitivity(),readingConfirmation:this.readingConfirmation(),changedInPreviousWindow:this.isChanged(),focusedField:this.focusedField()}},CComposeViewModel.prototype.openInNewWindow=function(){var e="id"+Math.random().toString(),t={},i=null,s="#"+Enums.Screens.SingleCompose;this.closeBecauseSingleCompose(!0),t=this.getMessageDataForSingleMode(),this.draftUid().length>0&&!this.isChanged()?(s=App.Routing.buildHashFromArray(App.Links.composeFromMessage("drafts",App.MailCache.folderList().draftsFolderFullName(),this.draftUid(),!0)),i=Utils.WindowOpener.openTab(s)):this.templateUid().length>0&&!this.isChanged()?(s=App.Routing.buildHashFromArray(App.Links.composeFromMessage("drafts",this.templateFolderName(),this.templateUid(),!0)),i=Utils.WindowOpener.openTab(s)):this.isChanged()?(window.aMessagesParametersFromCompose||(window.aMessagesParametersFromCompose=[]),window.aMessagesParametersFromCompose[e]=t,i=Utils.WindowOpener.openTab(s,e)):(s=App.Routing.buildHashFromArray(_.union([Enums.Screens.SingleCompose],this.routeParams())),i=Utils.WindowOpener.openTab(s)),this.commit(),Utils.isFunc(this.closeCommand)?this.closeCommand():this.executeBackToList()},CComposeViewModel.prototype.autocompleteCallback=function(e,t){var i={Action:"ContactSuggestions",Search:e};App.Ajax.send(i,function(e){var i=[];e&&e.Result&&e.Result&&e.Result.List&&(i=_.map(e.Result.List,function(e){var t="",i=e.Email;return e.IsGroup?t=e.Name&&0<Utils.trim(e.Name).length?'"'+e.Name+'" ('+e.Email+")":"("+e.Email+")":(t=Utils.Address.getFullEmail(e.Name,e.Email),i=t),{label:t,value:i,frequency:e.Frequency,id:e.Id,global:e.Global,sharedToAll:e.SharedToAll}}),i=_.sortBy(_.compact(i),function(e){return e.frequency}).reverse()),t(i)},this)},CComposeViewModel.prototype.onShowFilesPopupClick=function(){var e=_.bind(this.addFilesAsAttachment,this);App.Screens.showPopup(FileStoragePopup,[e])},CComposeViewModel.prototype.confirmOpenPgp=function(){var e=Utils.i18n("OPENPGP/CONFIRM_HTML_TO_PLAIN_FORMATTING"),t=_.bind(function(e){e&&this.openPgpPopup(!1)},this);this.notInlineAttachments().length>0&&(e+="\r\n\r\n"+Utils.i18n("OPENPGP/CONFIRM_HTML_TO_PLAIN_ATTACHMENTS")),App.Screens.showPopup(ConfirmPopup,[e,t])},CComposeViewModel.prototype.openPgpPopup=function(e){var t=this.oHtmlEditor.getPlainText(),i=_.bind(function(t,i){e||(this.stopAutosaveTimer(),this.executeSave(!0)),this.plainText(!0),this.textBody(t),this.pgpSecured(!0),this.pgpEncrypted(i),e&&this.executeSend(!0)},this),s=_.bind(function(){e&&this.executeSend(!0)},this);App.Screens.showPopup(COpenPgpEncryptPopup,[t,AppData.Accounts.getEmail(this.senderAccountId()),this.recipientEmails(),e,i,s])},CComposeViewModel.prototype.undoPgp=function(){var e=this.textBody(),t=[];this.pgpSecured()&&(this.plainText(!1),this.fromDrafts()&&!this.pgpEncrypted()?(t=e.split("-----BEGIN PGP SIGNED MESSAGE-----"),2===t.length&&(e=t[1]),t=e.split("-----BEGIN PGP SIGNATURE-----"),2===t.length&&(e=t[0]),t=e.split("\r\n\r\n"),t.length>0&&(t.shift(),e=t.join("\r\n\r\n")),e="<div>"+e.replace(/\r\n/gi,"<br />")+"</div>",this.textBody(e)):this.oHtmlEditor.undoAndClearRedo(),this.fromToExpandColapssed(!1),this.pgpSecured(!1),this.pgpEncrypted(!1))},CComposeViewModel.prototype.autocompleteDeleteItem=function(e){var t={Action:"ContactSuggestionDelete",ContactId:e.id,SharedToAll:e.sharedToAll?"1":"0"};App.Ajax.send(t,function(e){return!0},this)},CComposeViewModel.prototype.fillFieldsFromObject=function(e){if("message-data-object"===this.routeType()&&e.length>1){var t=e[1];this.setRecipient(this.toAddr,t.to),this.setRecipient(this.ccAddr,t.cc),this.setRecipient(this.bccAddr,t.bcc),this.subject(t.subject),""!==t.body&&this.textBody("<div>"+t.body+"</div>"),Utils.isNonEmptyArray(t.attachments)&&_.each(t.attachments,function(e){var t=new CMailAttachmentModel;t.fileName(e.Name),t.tempName(e.TempName),t.type(e.MimeType),this.attachments.push(t)},this)}},CSenderSelector.prototype.changeSelectedSender=function(e){if(e){var t=Utils.pString(e.id());e.FETCHER&&(t="fetcher"+t),_.find(this.senderList(),function(e){return e.id===t})&&(this.lockSelectedSender(!0),this.selectedSender(t),this.selectedFetcherOrIdentity(e),this.lockSelectedSender(!1))}},CSenderSelector.prototype.changeSenderAccountId=function(e,t){var i=!1;this.senderAccountId()!==e&&(AppData.Accounts.hasAccountWithId(e)?(this.senderAccountId(e),i=!0):AppData.Accounts.hasAccountWithId(this.senderAccountId())||(this.senderAccountId(AppData.Accounts.currentId()),i=!0)),(i||0===this.senderList().length)&&(this.fillSenderList(t),i=!0),!i&&t&&this.changeSelectedSender(t)},CSenderSelector.prototype.fillSenderList=function(e){var t=[],i=AppData.Accounts.getAccount(this.senderAccountId());i&&(_.isArray(i.identities())&&_.each(i.identities(),function(e){e.enabled()&&t.push({fullEmail:e.fullEmail(),id:Utils.pString(e.id())})},this),i.identitiesSubscribtion||(i.identitiesSubscribtion=i.identities.subscribe(function(t){this.fillSenderList(e),this.changeSelectedSender(i.getDefaultIdentity())},this)),i.fetchers()?_.each(i.fetchers().collection(),function(e){var i=e.fullEmail();e.isOutgoingEnabled()&&i.length>0&&t.push({fullEmail:i,id:"fetcher"+e.id()})},this):i.fetchersSubscribtion||(i.fetchersSubscribtion=i.fetchers.subscribe(function(){this.fillSenderList(e)},this))),this.senderList(t),this.changeSelectedSender(e)},CSenderSelector.prototype.setFetcherOrIdentityByReplyMessage=function(e){var t=e.oTo.aCollection.concat(e.oCc.aCollection),i=App.MessageSender.getFirstFetcherOrIdentityByRecipientsOrDefault(t,e.accountId());i&&this.changeSelectedSender(i)},Utils.extend(ComposePopup,CComposeViewModel),ko.bindingHandlers.singleOrDoubleClick={init:function(e,t,i,s,o){var n=t().click,a=t().dblclick,r=t().delay||200,l=0;$(e).click(function(e){l++,1===l&&setTimeout(function(){1===l?void 0!==n&&n.call(s,o.$data,e):void 0!==a&&a.call(s,o.$data,e),l=0},r)})}},ComposePopup.prototype.popupTemplate=function(){return"Popups_ComposePopupViewModel"},ComposePopup.prototype.preventBackspaceOn=function(){$(document).on("keydown",this.fPreventBackspace)},ComposePopup.prototype.preventBackspaceOff=function(){$(document).off("keydown",this.fPreventBackspace)},ComposePopup.prototype.onHide=function(){this.preventBackspaceOff(),this.clearFields()},ComposePopup.prototype.onShow=function(e){if(e=e||[],1===e.length&&"close"===e[0])this.closeCommand();else{var t=3===e.length&&"drafts"===e[0]&&e[2]===this.draftUid(),i=this.minimized();this.maximize(),this.shown()?(e.length>0&&!t?this.hasSomethingToSave()?(this.stopAutosaveTimer(),App.Screens.showPopup(ConfirmAnotherMessageComposedPopup,[_.bind(function(t){switch(t){case Enums.AnotherMessageComposedAnswer.Discard:this.onRoute(e);break;case Enums.AnotherMessageComposedAnswer.SaveAsDraft:this.hasSomethingToSave()&&this.executeSave(!0,!1),this.onRoute(e);break;case Enums.AnotherMessageComposedAnswer.Cancel:}this.startAutosaveTimer()},this)])):this.onRoute(e):i||this.onRoute(e),this.oHtmlEditor.oCrea.clearUndoRedo()):(CComposeViewModel.prototype.onShow.call(this),this.onRoute(e)),this.preventBackspaceOn()}},ComposePopup.prototype.minimize=function(){this.minimized(!0),ComposePopup.__dom.addClass("minimized"),this.minHeightRemoveTrigger(!0)},ComposePopup.prototype.maximize=function(){this.minimized(!1),ComposePopup.__dom.removeClass("minimized"),this.minHeightAdjustTrigger(!0)},ComposePopup.prototype.saveAndClose=function(){this.hasSomethingToSave()&&this.saveCommand(),this.closeCommand()},ComposePopup.prototype.onCancelClick=function(){this.hasSomethingToSave()?this.minimize():this.closeCommand()},ComposePopup.prototype.onEscHandler=function(e){var t=this.oHtmlEditor.hasOpenedPopup(),i=!App.browser.ie&&e.target&&"input"===e.target.tagName.toLowerCase()&&"file"===e.target.type.toLowerCase();i&&e.target.blur(),1!==App.Screens.popups.length||t||i||this.minimize(),t&&this.oHtmlEditor.closeAllPopups()},CContactsImportViewModel.prototype.onApplyBindings=function(e){this.oJua=new Jua({action:"?/Upload/Contacts/",name:"jua-uploader",queueSize:1,clickElement:$("#jue_import_button",e),hiddenElementsPosition:Utils.isRTL()?"right":"left",disableAjaxUpload:!1,disableDragAndDrop:!0,disableMultiple:!0,hidden:{Token:function(){return AppData.Token},AccountID:function(){return AppData.Accounts.currentId()}}}),this.oJua.on("onStart",_.bind(this.onFileUploadStart,this)).on("onComplete",_.bind(this.onFileUploadComplete,this))},CContactsImportViewModel.prototype.onFileUploadStart=function(){this.importing(!0)},CContactsImportViewModel.prototype.onFileUploadComplete=function(e,t,i){var s=!t||!i||i.Error||i.Result.Error||!1,o=0;this.importing(!1),this.oParent.requestContactList(),s?i.ErrorCode&&i.ErrorCode===Enums.Errors.IncorrectFileExtension?App.Api.showError(Utils.i18n("CONTACTS/ERROR_INCORRECT_FILE_EXTENSION")):App.Api.showError(Utils.i18n("WARNING/ERROR_UPLOAD_FILE")):(o=Utils.pInt(i.Result.ImportedCount),0<o?App.Api.showReport(Utils.i18n("CONTACTS/CONTACT_IMPORT_HINT_PLURAL",{NUM:o},null,o)):App.Api.showError(Utils.i18n("WARNING/CONTACTS_IMPORT_NO_CONTACTS")))},CContactsViewModel.prototype.groupDropdownToggle=function(e,t){this.currentGroupDropdown(e)},CContactsViewModel.prototype.gotoGroupList=function(){this.changeSelectedPanel(Enums.MobilePanel.Groups)},CContactsViewModel.prototype.gotoContactList=function(){return this.changeSelectedPanel(Enums.MobilePanel.Items),!0},CContactsViewModel.prototype.gotoViewPane=function(){this.changeSelectedPanel(Enums.MobilePanel.View)},CContactsViewModel.prototype.backToContactList=function(){var e=this.selectedGroupType(),t=e===Enums.ContactsGroupListType.SubGroup?this.currentGroupId():"";App.Routing.setHash(App.Links.contacts(e,t,this.search(),this.oPageSwitcher.currentPage()))},CContactsViewModel.prototype.changeSelectedPanel=function(e){this.mobileApp&&this.selectedPanel()!==e&&(this.selectedPanel(e),(bIsWindowsPhone||App.browser.ie)&&(this.$viewModel.hide(),_.defer(_.bind(function(){this.$viewModel.show()},this))))},CContactsViewModel.prototype.executeSave=function(e){var t={},i=[];e===this.selectedItem()&&this.selectedItem().canBeSave()?e instanceof CContactModel&&!e.readOnly()?(_.each(this.groupFullCollection(),function(e){e&&e.checked()&&i.push(e.Id())}),e.groups(i),t=e.toObject(),t.Action=e.isNew()?"ContactCreate":"ContactUpdate",e.isNew()?t.SharedToAll=Enums.ContactsGroupListType.SharedToAll===this.selectedGroupType()?"1":"0":t.SharedToAll=e.sharedToAll()?"1":"0",e.edited()&&e.edited(!1),e.isNew()&&this.selectedItem(null),this.selectedItem()&&App.ContactsCache.clearInfoAboutEmail(this.selectedItem().email()),this.selectedGroupType()!==Enums.ContactsGroupListType.Global&&this.selectedGroupType()!==Enums.ContactsGroupListType.All||this.recivedAnimUnshare(!0),App.Ajax.send(t,this.onContactCreateResponse,this)):e instanceof CGroupModel&&!e.readOnly()&&(t=e.toObject(),t.Action=e.isNew()?"ContactsGroupCreate":"ContactsGroupUpdate",this.gotoGroupList(),e.edited()&&e.edited(!1),e.isNew()&&!this.mobileApp&&this.selectedItem(null),App.Ajax.send(t,this.onGroupCreateResponse,this)):App.Api.showError(Utils.i18n("CONTACTS/ERROR_EMPTY_CONTACT"))},CContactsViewModel.prototype.executeNewContact=function(){if(this.showPersonalContacts()){var e=this.selectedGroupInList();this.oContactModel.switchToNew(),this.oContactModel.groups(e?[e.Id()]:[]),this.selectedItem(this.oContactModel),this.selector.itemSelected(null),this.gotoViewPane()}},CContactsViewModel.prototype.executeNewGroup=function(){this.oGroupModel.switchToNew(),this.selectedItem(this.oGroupModel),this.selector.itemSelected(null),this.gotoViewPane()},CContactsViewModel.prototype.executeDelete=function(){var e=this.selectedGroupType();if(e===Enums.ContactsGroupListType.Personal||e===Enums.ContactsGroupListType.SharedToAll){var t=_.filter(this.selector.listCheckedOrSelected(),function(e){return!e.ReadOnly()}),i=t.length,s=Utils.i18n("CONTACTS/CONFIRM_DELETE_CONTACT_PLURAL",{},null,i),o=_.bind(function(e){e&&this.deleteContacts(t)},this);App.Screens.showPopup(ConfirmPopup,[s,o])}else e===Enums.ContactsGroupListType.SubGroup&&this.removeFromGroupCommand()},CContactsViewModel.prototype.deleteContacts=function(e){var t=this,i=this.selectedContact(),s=_.map(e,function(e){return e.Id()});0<s.length&&(this.preLoadingList(!0),_.each(e,function(e){e&&(App.ContactsCache.clearInfoAboutEmail(e.Email()),!i||e.IsGroup()||e.ReadOnly()||i.readOnly()||i.idContact()!==e.Id()||(i=null,this.selectedContact(null)))},this),_.each(this.collection(),function(t){-1<Utils.inArray(t,e)&&t.deleted(!0)}),_.delay(function(){t.collection.remove(function(e){return e.deleted()})},500),App.Ajax.send({Action:"ContactDelete",ContactsId:s.join(","),SharedToAll:Enums.ContactsGroupListType.SharedToAll===this.selectedGroupType()?"1":"0"},this.requestContactList,this),App.ContactsCache.markVcardsNonexistentByUid(s))},CContactsViewModel.prototype.executeRemoveFromGroup=function(){var e=this,t=this.selectedGroupInList(),i=this.selector.listCheckedOrSelected(),s=_.map(i,function(e){return e.ReadOnly()?"":e.Id()});s=_.compact(s),t&&0<s.length&&(this.preLoadingList(!0),_.each(this.collection(),function(e){-1<Utils.inArray(e,i)&&e.deleted(!0)}),_.delay(function(){e.collection.remove(function(e){return e.deleted()})},500),App.Ajax.send({Action:"ContactsRemoveFromGroup",GroupId:t.Id(),ContactsId:s.join(",")},this.requestContactList,this))},CContactsViewModel.prototype.executeImport=function(){this.selectedItem(null),this.oContactImportViewModel.visibility(!0),this.selector.itemSelected(null),this.selectedGroupType(Enums.ContactsGroupListType.Personal),this.gotoViewPane()},CContactsViewModel.prototype.executeCSVExport=function(){App.Api.downloadByUrl(Utils.getExportContactsLink("csv"))},CContactsViewModel.prototype.executeVCFExport=function(){App.Api.downloadByUrl(Utils.getExportContactsLink("vcf"))},CContactsViewModel.prototype.executeCancel=function(){var e=this.selectedItem();e&&(e instanceof CContactModel&&!e.readOnly()?e.isNew()?this.selectedItem(null):e.edited()&&e.edited(!1):e instanceof CGroupModel&&!e.readOnly()&&(e.isNew()?this.selectedItem(null):e.edited()&&(this.selectedItem(this.selectedOldItem()),e.edited(!1)),this.gotoGroupList())),this.oContactImportViewModel.visibility(!1)},CContactsViewModel.prototype.executeAddContactsToGroup=function(e,t){e&&_.isArray(t)&&0<t.length&&(e.recivedAnim(!0),this.executeAddContactsToGroupId(e.Id(),t))},CContactsViewModel.prototype.executeAddContactsToGroupId=function(e,t){e&&_.isArray(t)&&0<t.length&&App.Ajax.send({Action:"ContactsAddToGroup",GroupId:e,ContactsId:t},this.onContactsAddToGroupResponse,this)},CContactsViewModel.prototype.onContactsAddToGroupResponse=function(){this.requestContactList(),this.selector.itemSelected()&&this.requestContact(this.selector.itemSelected().sId)},CContactsViewModel.prototype.executeAddSelectedContactsToGroup=function(e){var t=this.selector.listCheckedOrSelected(),i=[];e&&_.isArray(t)&&0<t.length&&_.each(t,function(e){e&&!e.IsGroup()&&i.push([e.Id(),e.Global()?"1":"0"])},this),this.executeAddContactsToGroup(e,i)},CContactsViewModel.prototype.groupsInContactView=function(e){var t=[],i=[];return e&&!e.groupsIsEmpty()&&(i=e.groups(),t=_.filter(this.groupFullCollection(),function(e){return 0<=Utils.inArray(e.Id(),i)})),t},CContactsViewModel.prototype.onShow=function(){this.selector.useKeyboardKeys(!0),this.oPageSwitcher.show(),this.oPageSwitcher.perPage(AppData.User.ContactsPerPage),this.oJua&&this.oJua.setDragAndDropEnabledStatus(!0)},CContactsViewModel.prototype.onHide=function(){this.selector.listCheckedOrSelected(!1),this.selector.useKeyboardKeys(!1),this.selectedItem(null),this.oPageSwitcher.hide(),this.oJua&&this.oJua.setDragAndDropEnabledStatus(!1)},CContactsViewModel.prototype.onApplyBindings=function(){this.selector.initOnApplyBindings(".contact_sub_list .item",".contact_sub_list .selected.item",".contact_sub_list .item .custom_checkbox",$(".contact_list",this.$viewModel),$(".contact_list_scroll.scroll-inner",this.$viewModel));var e=this;this.$viewModel.on("click",".content .item.add_to .dropdown_helper .item",function(){$(this).hasClass("new-group")?e.executeNewGroup():e.executeAddSelectedContactsToGroup(ko.dataFor(this))}),this.showPersonalContacts(!!AppData.User.ShowPersonalContacts),this.showGlobalContacts(!!AppData.User.ShowGlobalContacts),this.showSharedToAllContacts(!!AppData.App.AllowContactsSharing),this.selectedGroupType.valueHasMutated(),this.oContactImportViewModel.onApplyBindings(this.$viewModel),this.requestGroupFullList(),this.hotKeysBind(),this.initUploader()},CContactsViewModel.prototype.hotKeysBind=function(){var e=!1;$(document).on("keydown",_.bind(function(t){var i=t.keyCode,s=this.collection()[0],o=this.isSearchFocused(),n=!1,a=App.Screens.currentScreen()===Enums.Screens.Contacts;a&&!Utils.isTextFieldFocused()&&!o&&t&&i===Enums.Key.s?(t.preventDefault(),this.searchFocus()):s&&(n=s.selected(),s&&o&&t&&i===Enums.Key.Down?(this.isSearchFocused(!1),this.selector.itemSelected(s),e=!0):!o&&e&&n&&t&&i===Enums.Key.Up?(this.isSearchFocused(!0),this.selector.itemSelected(!1),e=!1):n?e=!0:n||(e=!1))},this))},CContactsViewModel.prototype.requestContactList=function(){this.loadingList(!0),App.Ajax.send({Action:Enums.ContactsGroupListType.Global===this.selectedGroupType()?"ContactGlobalList":"ContactList",Offset:(this.oPageSwitcher.currentPage()-1)*AppData.User.ContactsPerPage,Limit:AppData.User.ContactsPerPage,SortField:this.sortType(),SortOrder:this.sortOrder()?"1":"0",Search:this.search(),GroupId:this.selectedGroupInList()?this.selectedGroupInList().Id():"",SharedToAll:Enums.ContactsGroupListType.SharedToAll===this.selectedGroupType()?"1":"0",SharedToAll1:Enums.ContactsGroupListType.SharedToAll===this.selectedGroupType()?"1":"0",All:Enums.ContactsGroupListType.All===this.selectedGroupType()?"1":"0"},this.onContactListResponse,this)},CContactsViewModel.prototype.requestGroupFullList=function(){App.Ajax.send({Action:"ContactsGroupFullList"},this.onGroupListResponse,this)},CContactsViewModel.prototype.requestContact=function(e){this.loadingViewPane(!0);var t=_.find(this.collection(),function(t){return t.sId===e});t&&(this.selector.itemSelected(t),App.Ajax.send({Action:t.Global()?"ContactGlobal":"ContactGet",ContactId:t.Id(),SharedToAll:t.IsSharedToAll()?"1":"0"},this.onContactGetResponse,this))},CContactsViewModel.prototype.requestContactById=function(e,t){this.loadingViewPane(!0),e&&App.Ajax.send({Action:t?"ContactGlobal":"ContactGet",ContactId:e},this.onContactGetResponse,this)},CContactsViewModel.prototype.editGroup=function(e){var t=new CGroupModel;t.populate(e),this.selectedOldItem(t),e.edited(!0)},CContactsViewModel.prototype.changeGroupType=function(e){App.Routing.setHash(App.Links.contacts(e))},CContactsViewModel.prototype.onViewGroupClick=function(e){App.Routing.setHash(App.Links.contacts(Enums.ContactsGroupListType.SubGroup,e.Id()))},CContactsViewModel.prototype.onRoute=function(e){var t=App.Links.parseContacts(e),i=[Enums.ContactsGroupListType.Personal,Enums.ContactsGroupListType.SharedToAll,Enums.ContactsGroupListType.Global,Enums.ContactsGroupListType.All],s=this.selectedGroupType()===Enums.ContactsGroupListType.SubGroup?this.currentGroupId():"",o=this.selectedGroupType()!==t.Type||s!==t.GroupId||this.search()!==t.Search,n=!0,a=!1;this.pageSwitcherLocked(!0),o?this.oPageSwitcher.clear():this.oPageSwitcher.setPage(t.Page,AppData.User.ContactsPerPage),this.pageSwitcherLocked(!1),t.Page!==this.oPageSwitcher.currentPage()&&App.Routing.replaceHash(App.Links.contacts(t.Type,t.GroupId,t.Search,this.oPageSwitcher.currentPage())),this.currentPage()!==t.Page&&(this.currentPage(t.Page),a=!0),-1!==Utils.inArray(t.Type,i)?this.selectedGroupType(t.Type):s===t.GroupId&&""!==t.Uid||(n=this.viewGroup(t.GroupId),n?a=!1:App.Routing.replaceHash(App.Links.contacts())),this.search()!==t.Search&&(this.search(t.Search),a=!0),this.contactUidForRequest(""),t.Uid?0===this.collection().length?this.contactUidForRequest(t.Uid):this.requestContact(t.Uid):(this.selector.itemSelected(null),this.gotoContactList()),a&&this.requestContactList(),this.createNewContact()},CContactsViewModel.prototype.viewGroup=function(e){var t=_.find(this.groupFullCollection(),function(t){return t&&t.Id()===e});return t&&(this.oGroupModel.clear(),this.oGroupModel.idGroup(t.Id()).name(t.Name()),t.IsOrganization()&&this.requestGroup(t),this.selectedGroupInList(t),this.selectedItem(this.oGroupModel),this.selector.itemSelected(null),this.selector.listCheckedOrSelected(!1),App.Ajax.send({Action:"ContactsGroupEvents",GroupId:e},this.onGroupEventsResponse,this)),!!t},CContactsViewModel.prototype.deleteGroup=function(e){e&&(App.Ajax.send({Action:"ContactsGroupDelete",GroupId:e},this.requestGroupFullList,this),this.selectedGroupType(Enums.ContactsGroupListType.Personal),this.groupFullCollection.remove(function(t){return t&&t.Id()===e}))},CContactsViewModel.prototype.mailGroup=function(e){e&&App.Ajax.send({Action:"ContactList",Offset:0,Limit:99,SortField:Enums.ContactSortType.Email,SortOrder:"1",GroupId:e.idGroup()},function(e){if(e&&e.Result&&e.Result.List){var t=0,i=0,s=[],o=null,n=[],a=e.Result.List;for(i=a.length;t<i;t++)a[t]&&"Object/CContactListItem"===Utils.pExport(a[t],"@Object","")&&(o=new CContactListItemModel,o.parse(a[t]),n.push(o));s=_.map(n,function(e){return e.EmailAndName()}),s=_.compact(s),App.Api.composeMessageToAddresses(s.join(", "))}},this)},CContactsViewModel.prototype.dragAndDropHelper=function(e){e&&e.checked(!0);var t=this.selector.itemSelected(),i=Utils.draggableMessages(),s=this.selector.listCheckedOrSelected().length,o=0<s?_.map(this.selector.listCheckedOrSelected(),function(e){return[e.Id(),e.Global()?"1":"0"]}):[];return t&&!t.checked()&&t.checked(!0),i.data("p7-contatcs-type",this.selectedGroupType()),i.data("p7-contatcs-uids",o),$(".count-text",i).text(Utils.i18n("CONTACTS/DRAG_TEXT_PLURAL",{COUNT:s},null,s)),i},CContactsViewModel.prototype.contactsDrop=function(e,t,i){if(e){var s=i&&i.helper?i.helper:null,o=s?s.data("p7-contatcs-uids"):null;null!==o&&(Utils.uiDropHelperAnim(t,i),this.executeAddContactsToGroup(e,o))}},CContactsViewModel.prototype.contactsDropToGroupType=function(e,t,i){var s=i&&i.helper?i.helper:null,o=s?s.data("p7-contatcs-type"):null,n=s?s.data("p7-contatcs-uids"):null;e!==o&&null!==o&&null!==n&&(Utils.uiDropHelperAnim(t,i),this.executeShare())},CContactsViewModel.prototype.searchFocus=function(){this.selector.useKeyboardKeys()&&!Utils.isTextFieldFocused()&&this.isSearchFocused(!0)},CContactsViewModel.prototype.onContactDblClick=function(e){e&&App.Api.composeMessageToAddresses(e.EmailAndName())},CContactsViewModel.prototype.onClearSearchClick=function(){this.searchInput(""),this.searchSubmitCommand()},CContactsViewModel.prototype.onContactGetResponse=function(e,t){if(e&&e.Action&&e.Result){var i=new CContactModel,s=this.selector.itemSelected();i.parse(e.Result),s&&s.Id()===i.idContact()&&this.selectedItem(i)}},CContactsViewModel.prototype.onContactCreateResponse=function(e,t){e&&e.Action&&e.Result&&(App.Api.showReport("ContactCreate"===e.Action?Utils.i18n("CONTACTS/REPORT_CONTACT_SUCCESSFULLY_ADDED"):Utils.i18n("CONTACTS/REPORT_CONTACT_SUCCESSFULLY_UPDATED")),this.requestContactList())},CContactsViewModel.prototype.onContactListResponse=function(e,t){if(e&&e.Action&&e.Result){var i=0,s=0,o=[],n=this.selector.itemSelected(),a=null,r=this.selector.listChecked(),l=r&&0<r.length?_.map(r,function(e){return e.Id()}):[],h=null;for(s=e.Result.List.length;i<s;i++)e.Result.List[i]&&"Object/CContactListItem"===Utils.pExport(e.Result.List[i],"@Object","")&&(h=new CContactListItemModel,h.parse(e.Result.List[i]),o.push(h));n&&(a=_.find(o,function(e){return n.Id()===e.Id()})),l&&0<l.length&&_.each(o,function(e){e.checked(-1<Utils.inArray(e.Id(),l))}),this.collection(o),this.loadingList(!1),this.oPageSwitcher.setCount(Utils.pInt(e.Result.ContactCount)),a&&(this.selector.itemSelected(a),this.requestContact(n.Id())),this.selectedGroupContactsList(e.Result.List),n&&this.requestContact(n.Id()),this.contactCount(e.Result.ContactCount)}},CContactsViewModel.prototype.viewAllMails=function(){var e=this.selectedGroupContactsList(),t="email:";e&&(_.each(e,function(e,i){_.each(e.Emails,function(e,i){t=t+e+","})}),App.MailCache.searchMessagesInInbox(t))},CContactsViewModel.prototype.onGroupListResponse=function(e,t){if(e&&e.Action&&e.Result){var i=0,s=0,o=[],n=_.find(this.groupFullCollection(),function(e){return e.selected()}),a=null;for(this.groupFullCollection(o),s=e.Result.length;i<s;i++)e.Result[i]&&"Object/CContactListItem"===Utils.pExport(e.Result[i],"@Object","")&&(a=new CContactListItemModel,a.parse(e.Result[i]),a.IsGroup()&&(n&&n.Id()===a.Id()&&this.selectedGroupInList(a),o.push(a)));this.groupFullCollection(o)}},CContactsViewModel.prototype.onGroupCreateResponse=function(e,t){if(e&&e.Action&&e.Result){var i=_.map(this.selector.listChecked(),function(e){return[e.Id(),e.Global()?"1":"0"]});this.executeAddContactsToGroupId(Utils.pString(e.Result.IdGroup),i),this.mobileApp||(this.selectedItem(null),this.selector.itemSelected(null)),App.Api.showReport(Utils.i18n("CONTACTS/REPORT_GROUP_SUCCESSFULLY_ADDED")),this.requestContactList(),this.requestGroupFullList()}},CContactsViewModel.prototype.executeShare=function(){var e=this,t=this.selector.listCheckedOrSelected(),i=this.selectedContact(),s=_.map(t,function(e){return e.ReadOnly()?"":e.Id()});s=_.compact(s),0<s.length&&(_.each(t,function(e){e&&(App.ContactsCache.clearInfoAboutEmail(e.Email()),!i||e.IsGroup()||e.ReadOnly()||i.readOnly()||i.idContact()!==e.Id()||(i=null,this.selectedContact(null)))},this),_.each(this.collection(),function(e){-1<Utils.inArray(e,t)&&e.deleted(!0)}),_.delay(function(){e.collection.remove(function(e){return e.deleted()})},500),Enums.ContactsGroupListType.SharedToAll===this.selectedGroupType()?this.recivedAnimUnshare(!0):this.recivedAnimShare(!0),App.Ajax.send({Action:"ContactUpdateSharedToAll",ContactsId:s.join(","),SharedToAll:Enums.ContactsGroupListType.SharedToAll===this.selectedGroupType()?"1":"0"},this.onContactUpdateSharedToAllResponse,this))},CContactsViewModel.prototype.onContactUpdateSharedToAllResponse=function(e,t){},CContactsViewModel.prototype.requestGroup=function(e){this.loadingViewPane(!0),e&&App.Ajax.send({Action:"ContactsGroup",GroupId:e.Id()},this.onGroupResponse,this)},CContactsViewModel.prototype.onGroupResponse=function(e,t){if(e&&e.Action&&e.Result){var i=e.Result;this.oGroupModel.idGroup(Utils.pString(i.IdGroup)).name(i.Name).isOrganization(i.IsOrganization).company(i.Company).country(i.Country).state(i.State).city(i.City).street(i.Street).zip(i.Zip).phone(i.Phone).fax(i.Fax).email(i.Email).web(i.Web)}},CContactsViewModel.prototype.onGroupEventsResponse=function(e,t){if(e&&e.Action&&e.Result){var i=e.Result;this.oGroupModel.events(i)}},CContactsViewModel.prototype.reload=function(){this.requestContactList()},CContactsViewModel.prototype.initUploader=function(){var e=this;this.uploaderArea()&&(this.oJua=new Jua({action:"?/Upload/Contacts/",name:"jua-uploader",queueSize:2,dragAndDropElement:this.uploaderArea(),disableAjaxUpload:this.isPublic,disableFolderDragAndDrop:this.isPublic,disableDragAndDrop:this.isPublic,hidden:{Token:function(){return AppData.Token},AccountID:function(){return AppData.Accounts.currentId()},AdditionalData:function(t){return JSON.stringify({GroupId:e.selectedGroupType()===Enums.ContactsGroupListType.SubGroup?e.currentGroupId():"",IsShared:e.selectedGroupType()===Enums.ContactsGroupListType.SharedToAll})}}}),this.oJua.on("onComplete",_.bind(this.onContactUploadComplete,this)).on("onBodyDragEnter",_.bind(this.bDragActive,this,!0)).on("onBodyDragLeave",_.bind(this.bDragActive,this,!1)))},CContactsViewModel.prototype.onContactUploadComplete=function(e,t,i){var s=!t||!i||i.Error||i.Result.Error||!1;s?i.ErrorCode?App.Api.showErrorByCode(i,Utils.i18n("The file must have .CSV or .VCF extension.")):App.Api.showError(Utils.i18n("WARNING/UNKNOWN_ERROR")):this.reload()},CContactsViewModel.prototype.createNewContact=function(){App.ContactsCache.newContactParams&&(this.newContactCommand(),this.selectedItem().extented(!0),_.each(App.ContactsCache.newContactParams,function(e,t){this.oContactModel[t]&&this.oContactModel[t](e)},this),App.ContactsCache.newContactParams=null)},CSettingsViewModel.prototype.__name="CSettingsViewModel",CSettingsViewModel.prototype.onHide=function(e){var t=null,i=this.tab();this.confirmSaving(i),t=this.getCurrentViewModel(),t&&Utils.isFunc(t.onHide)&&t.onHide(e),$html.removeClass("non-adjustable")},CSettingsViewModel.prototype.onApplyBindings=function(){_.each(this.aTabs(),function(e){e&&Utils.isFunc(e.onApplyBindings)&&e.onApplyBindings()})},CSettingsViewModel.prototype.onShow=function(e){var t=this.getCurrentViewModel();t&&Utils.isFunc(t.onShow)&&t.onShow(e),$html.addClass("non-adjustable")},CSettingsViewModel.prototype.viewTab=function(e){var t=this.getViewModel(Enums.SettingsTab.Common),i=t?Enums.SettingsTab.Common:Enums.SettingsTab.EmailAccounts,s=this.getViewModel(e),o=-1===Utils.inArray(e,Enums.SettingsTab);e=s&&o?e:i,this.tab(e)},CSettingsViewModel.prototype.onRoute=function(e){var t=null,i=this.tab();i=_.isArray(e)&&e.length>0?e[0]:Enums.SettingsTab.Common,this.tab()!==i&&(t=this.getCurrentViewModel(),t&&Utils.isFunc(t.onHide)&&t.onHide(e),this.confirmSaving(this.tab())),this.viewTab(i),t=this.getCurrentViewModel(),t&&Utils.isFunc(t.onRoute)&&t.onRoute(e);
},CSettingsViewModel.prototype.confirmSaving=function(e){var t=this.getViewModel(e),i=_.bind(function(e){t&&(e?t.onSaveClick&&t.onSaveClick():t.init&&t.init())},this);t&&Utils.isFunc(t.isChanged)&&t.isChanged()&&App.Screens.showPopup(ConfirmPopup,[Utils.i18n("SETTINGS/CONFIRM_SETTINGS_SAVE"),i,"",Utils.i18n("SETTINGS/BUTTON_SAVE"),Utils.i18n("SETTINGS/BUTTON_DISCARD")])},CSettingsViewModel.prototype.getViewModel=function(e){return _.find(this.aTabs(),function(t){return t.TabName===e})},CSettingsViewModel.prototype.getCurrentViewModel=function(){return this.getViewModel(this.tab())},CSettingsViewModel.prototype.showTab=function(e){App.Routing.setHash([Enums.Screens.Settings,e])},CSettingsViewModel.prototype.onResponseFolderChanges=function(e,t){e.Result||(App.Api.showErrorByCode(e,Utils.i18n("SETTINGS/ERROR_SETTINGS_SAVING_FAILED")),App.MailCache.getFolderList(AppData.Accounts.editedId()))},CSettingsViewModel.prototype.onResponseFolderRename=function(e,t,i){t&&t.Result?t&&e&&t.Result&&!Utils.isUnd(t.Result.FullName)&&(e.fullName(t.Result.FullName),e.fullNameHash(t.Result.FullNameHash)):(App.Api.showErrorByCode(t,Utils.i18n("SETTINGS/ERROR_SETTINGS_SAVING_FAILED")),App.MailCache.getFolderList(AppData.Accounts.editedId()))},CSettingsViewModel.prototype.deleteFolder=function(e,t,i){var s={Action:"FolderDelete",AccountID:AppData.Accounts.editedId(),Folder:e.fullName()};i&&t&&e&&(t.remove(function(t){return e.fullName()===t.fullName()}),App.Ajax.send(s,this.onResponseFolderChanges,this))},CSettingsViewModel.prototype.onSubscribeFolderClick=function(e){var t={Action:"FolderSubscribe",AccountID:AppData.Accounts.editedId(),Folder:e.fullName(),SetAction:e.subscribed()?0:1};e&&e.canSubscribe()&&(e.subscribed(!e.subscribed()),App.Ajax.send(t,this.onResponseFolderChanges,this))},CSettingsViewModel.prototype.onDeleteFolderClick=function(e,t){var i=Utils.i18n("SETTINGS/ACCOUNT_FOLDERS_CONFIRMATION_DELETE"),s=this.getCollectionFromParent(t),o=_.bind(this.deleteFolder,this,e,s),n=this.getViewModel(Enums.SettingsTab.EmailAccounts);e&&e.canDelete()?App.Screens.showPopup(ConfirmPopup,[i,o]):n&&n.oAccountFolders.highlighted(!0)},CSettingsViewModel.prototype.folderEditOnEnter=function(e){if(e.name()!==e.nameForEdit()){var t={Action:"FolderRename",AccountID:AppData.Accounts.editedId(),PrevFolderFullNameRaw:e.fullName(),NewFolderNameInUtf8:e.nameForEdit()};App.Ajax.send(t,_.bind(this.onResponseFolderRename,this,e),this),e.name(e.nameForEdit())}e.edited(!1)},CSettingsViewModel.prototype.folderEditOnEsc=function(e){e.edited(!1)},CSettingsViewModel.prototype.getCollectionFromParent=function(e){return e.subfolders?e.subfolders:e.collection},CSettingsViewModel.prototype.canMoveFolderUp=function(e,t,i){var s=this.getCollectionFromParent(i),o=s()[t-1],n="";return t>0&&o&&(n=s()[t-1].fullName()),0!==t&&e&&e.fullName()!==App.MailCache.editedFolderList().inboxFolderFullName()&&App.MailCache.editedFolderList().inboxFolderFullName()!==n},CSettingsViewModel.prototype.canMoveFolderDown=function(e,t,i){var s=this.getCollectionFromParent(i);return t!==s().length-1&&e.fullName()!==App.MailCache.editedFolderList().inboxFolderFullName()},CSettingsViewModel.prototype.moveFolderUp=function(e,t,i){var s=this.getCollectionFromParent(i);this.canMoveFolderUp(e,t,i)&&s&&(s.splice(t,1),s.splice(t-1,0,e),this.folderListOrderUpdateDebounce())},CSettingsViewModel.prototype.moveFolderDown=function(e,t,i){var s=this.getCollectionFromParent(i);this.canMoveFolderDown(e,t,i)&&s&&(s.splice(t,1),s.splice(t+1,0,e),this.folderListOrderUpdateDebounce())},CSettingsViewModel.prototype.afterSortableFolderMove=function(e){this.folderListOrderUpdateDebounce()},CSettingsViewModel.prototype.folderListOrderUpdate=function(){var e=App.MailCache.editedFolderList().repopulateLinedCollection(),t={Action:"FoldersUpdateOrder",AccountID:AppData.Accounts.editedId(),FolderList:_.map(e,function(e){return e.fullName()})};App.Ajax.send(t,this.onResponseFolderChanges,this)},CSettingsViewModel.prototype.removeTab=function(e){this.aTabs(_.filter(this.aTabs(),function(t){return t.TabName===e&&this.aHiddenTabs.push(t),t.TabName!==e},this))},CSettingsViewModel.prototype.addTab=function(e){this.aHiddenTabs(_.filter(this.aHiddenTabs(),function(t){return t.TabName===e&&this.aTabs.push(t),t.TabName!==e},this))},CCommonSettingsViewModel.prototype.TemplateName="Settings_CommonSettingsViewModel",CCommonSettingsViewModel.prototype.TabName=Enums.SettingsTab.Common,CCommonSettingsViewModel.prototype.TabTitle=Utils.i18n("SETTINGS/TAB_COMMON"),CCommonSettingsViewModel.prototype.onApplyBindings=function(){this.init(),this.updateFirstState()},CCommonSettingsViewModel.prototype.onShow=function(){this.aAccountsEmails=AppData.Accounts.getAccountsEmails()},CCommonSettingsViewModel.prototype.setMessagesPerPage=function(e){var t=this.rangeOfNumbers;-1===_.indexOf(t,e)&&(t=_.sortBy(_.union(t,[e]),function(e){return e},this)),this.messagesPerPageValues(t),this.messagesPerPage(e)},CCommonSettingsViewModel.prototype.setContactsPerPage=function(e){var t=this.rangeOfNumbers;-1===_.indexOf(t,e)&&(t=_.sortBy(_.union(t,[e]),function(e){return e},this)),this.contactsPerPageValues(t),this.contactsPerPage(e)},CCommonSettingsViewModel.prototype.init=function(){this.selectedSkin(AppData.User.DefaultTheme),this.selectedLanguage(AppData.User.DefaultLanguage),this.setMessagesPerPage(AppData.User.MailsPerPage),this.setContactsPerPage(AppData.User.ContactsPerPage),this.autocheckmailInterval(AppData.User.AutoCheckMailInterval),this.timeFormat(AppData.User.defaultTimeFormat()),this.dateFormat(AppData.User.DefaultDateFormat),this.useThreads(AppData.User.useThreads()),this.saveRepliedToCurrFolder(AppData.User.SaveRepliedToCurrFolder),this.allowChangeInputDirection(AppData.User.AllowChangeInputDirection),this.desktopNotifications(AppData.User.DesktopNotifications),this.emailNotification(AppData.User.EmailNotification)},CCommonSettingsViewModel.prototype.getState=function(){var e=[this.selectedSkin(),this.selectedLanguage(),this.messagesPerPage(),this.contactsPerPage(),this.autocheckmailInterval(),this.timeFormat(),this.dateFormat(),this.useThreads(),this.saveRepliedToCurrFolder(),this.allowChangeInputDirection(),this.desktopNotifications(),this.emailNotification()];return e.join(":")},CCommonSettingsViewModel.prototype.updateFirstState=function(){this.firstState=this.getState()},CCommonSettingsViewModel.prototype.isChanged=function(){return!(!this.firstState||this.getState()===this.firstState)},CCommonSettingsViewModel.prototype.onResponse=function(e,t){var i=!1;this.loading(!1),e.Result===!1?App.Api.showErrorByCode(e,Utils.i18n("SETTINGS/ERROR_SETTINGS_SAVING_FAILED")):(App.CalendarCache.calendarSettingsChanged(!0),i=t.DefaultTheme!==AppData.User.DefaultTheme||t.DefaultLanguage!==AppData.User.DefaultLanguage,i?window.location.reload():(this.setMessagesPerPage(t.MailsPerPage),this.setContactsPerPage(t.ContactsPerPage),AppData.User.updateCommonSettings(t.MailsPerPage,t.ContactsPerPage,t.AutoCheckMailInterval,t.DefaultTheme,t.DefaultLanguage,t.DefaultDateFormat,t.DefaultTimeFormat,t.UseThreads,t.SaveRepliedMessagesToCurrentFolder,t.DesktopNotifications,t.AllowChangeInputDirection,t.EmailNotification),App.Api.showReport(Utils.i18n("SETTINGS/COMMON_REPORT_UPDATED_SUCCESSFULLY"))))},CCommonSettingsViewModel.prototype.onSaveClick=function(){var e={Action:"UserSettingsUpdate",MailsPerPage:Utils.pInt(this.messagesPerPage()),ContactsPerPage:Utils.pInt(this.contactsPerPage()),AutoCheckMailInterval:Utils.pInt(this.autocheckmailInterval()),DefaultTheme:this.selectedSkin(),DefaultLanguage:this.selectedLanguage(),DefaultDateFormat:this.dateFormat(),DefaultTimeFormat:this.timeFormat(),UseThreads:this.useThreads()?"1":"0",SaveRepliedMessagesToCurrentFolder:this.saveRepliedToCurrFolder()?"1":"0",AllowChangeInputDirection:this.allowChangeInputDirection()?"1":"0",DesktopNotifications:this.desktopNotifications()?"1":"0",EmailNotification:this.emailNotification()};this.loading(!0),this.updateFirstState(),App.Ajax.send(e,this.onResponse,this)},CCommonSettingsViewModel.prototype.registerMailto=function(){Utils.registerMailto()},CCommonSettingsViewModel.prototype.removeDefaultAccount=function(){this.defaultAccount.remove()},CEmailAccountsSettingsViewModel.prototype.TemplateName="Settings_EmailAccountsSettingsViewModel",CEmailAccountsSettingsViewModel.prototype.TabName=Enums.SettingsTab.EmailAccounts,CEmailAccountsSettingsViewModel.prototype.TabTitle=Utils.i18n("SETTINGS/TAB_EMAIL_ACCOUNTS"),CEmailAccountsSettingsViewModel.prototype.isChanged=function(){return!1},CEmailAccountsSettingsViewModel.prototype.onRoute=function(e){this.bShown=!0;var t=AppData.Accounts.getEdited(),i=e[1]||this.tab();t&&(i!==Enums.AccountSettingsTab.Properties||this.allowProperties()||(i=Enums.AccountSettingsTab.Folders),i===Enums.AccountSettingsTab.Properties||this.isAllowMail()||(i=""),""===i?this.tab(""):(i!==e[1]&&App.Routing.replaceHash([Enums.Screens.Settings,Enums.SettingsTab.EmailAccounts,i]),this.changeCurrentTab(i)),(!_.isArray(e)||e.length<=1)&&this.onChangeAccount(this.editedAccountId()))},CEmailAccountsSettingsViewModel.prototype.onHide=function(e){var t=this.getCurrentViewModel();this.confirmSaving(this.tab()),t&&Utils.isFunc(t.onHide)&&t.onHide(),this.bShown=!1},CEmailAccountsSettingsViewModel.prototype.changeCurrentTab=function(e){var t=AppData.Accounts.getEdited(),i=null,s=this.isTabAllowed(e,t),o=_.bind(function(){this.tab()!==e&&(i=this.getCurrentViewModel(),i&&Utils.isFunc(i.onHide)&&i.onHide()),this.tab(e),i=this.getCurrentViewModel(),i&&Utils.isFunc(i.onShow)&&i.onShow(t)},this);t&&(s?o():this.tab()===e?(this.tab(Enums.AccountSettingsTab.Properties),App.Routing.replaceHash([Enums.Screens.Settings,Enums.SettingsTab.EmailAccounts,Enums.AccountSettingsTab.Properties]),this.editedFetcherId(null),this.editedIdentityId(null)):App.Routing.replaceHash([Enums.Screens.Settings,Enums.SettingsTab.EmailAccounts,this.tab()]))},CEmailAccountsSettingsViewModel.prototype.getViewModel=function(e){switch(e){case Enums.AccountSettingsTab.Folders:return this.oAccountFolders;case Enums.AccountSettingsTab.Filters:return this.oAccountFilters;case Enums.AccountSettingsTab.Forward:return this.oAccountForward;case Enums.AccountSettingsTab.Signature:return this.oAccountSignature;case Enums.AccountSettingsTab.Autoresponder:return this.oAccountAutoresponder;case Enums.AccountSettingsTab.FetcherInc:return this.oFetcherIncoming;case Enums.AccountSettingsTab.FetcherOut:return this.oFetcherOutgoing;case Enums.AccountSettingsTab.FetcherSig:return this.oFetcherSignature;case Enums.AccountSettingsTab.IdentityProperties:return this.oIdentityProperties;case Enums.AccountSettingsTab.IdentitySignature:return this.oIdentityProperties;default:case Enums.AccountSettingsTab.Properties:return this.oAccountProperties}},CEmailAccountsSettingsViewModel.prototype.getCurrentViewModel=function(){return this.getViewModel(this.tab())},CEmailAccountsSettingsViewModel.prototype.isTabAllowed=function(e,t){var i=[Enums.AccountSettingsTab.Properties,Enums.AccountSettingsTab.Signature,Enums.AccountSettingsTab.Folders,Enums.AccountSettingsTab.FetcherInc,Enums.AccountSettingsTab.FetcherOut,Enums.AccountSettingsTab.FetcherSig];return t.allowMail()&&t.extensionExists("AllowSieveFiltersExtension")&&i.push(Enums.AccountSettingsTab.Filters),t.allowMail()&&t.extensionExists("AllowForwardExtension")&&i.push(Enums.AccountSettingsTab.Forward),t.allowMail()&&t.extensionExists("AllowAutoresponderExtension")&&i.push(Enums.AccountSettingsTab.Autoresponder),AppData.AllowIdentities&&this.editedIdentityId()&&(i.push(Enums.AccountSettingsTab.IdentityProperties),i.push(Enums.AccountSettingsTab.IdentitySignature)),-1!==Utils.inArray(e,i)},CEmailAccountsSettingsViewModel.prototype.onTabClick=function(e){this.bShown&&this.confirmSaving(this.tab(),_.bind(function(){App.Routing.setHash([Enums.Screens.Settings,Enums.SettingsTab.EmailAccounts,e])},this))},CEmailAccountsSettingsViewModel.prototype.removeEditedAccount=function(){var e=_.bind(function(){this.onChangeAccount(AppData.Accounts.editedId())},this),t=AppData.Accounts.getEdited();t.remove(e)},CEmailAccountsSettingsViewModel.prototype.onAccountAdd=function(){App.Screens.showPopup(AccountCreatePopup,[Enums.AccountCreationPopupType.TwoSteps,"",_.bind(function(e){this.onChangeAccount(e)},this)])},CEmailAccountsSettingsViewModel.prototype.fillAccountPermissions=function(e){var t=AppData.Accounts.getAccount(e),i=!!t&&t.allowMail(),s=!!t&&t.isDefault(),o=!!t&&t.isLinked(),n=!!t&&t.extensionExists("AllowChangePasswordExtension"),a=!!t&&t.canBeRemoved()&&!t.isDefault();this.isAllowMail(t&&t.allowMail()),this.allowProperties((!s||s&&!o&&AppData.App.AllowUsersChangeEmailSettings)&&i||!AppData.AllowIdentities||n||a)},CEmailAccountsSettingsViewModel.prototype.onChangeAccount=function(e){this.fillAccountPermissions(e),this.confirmSaving(this.tab(),_.bind(function(){var t=AppData.Accounts.getAccount(e),i={Action:"AccountSettingsGet",AccountID:e},s=this.isFetcherTab(this.tab())||this.isIdentityTab(this.tab())||!this.allowProperties()&&Enums.AccountSettingsTab.Properties===this.tab()||!this.isAllowMail()&&Enums.AccountSettingsTab.Properties!==this.tab();s&&(this.allowProperties()?this.onTabClick(Enums.AccountSettingsTab.Properties):this.isAllowMail()?this.onTabClick(Enums.AccountSettingsTab.Folders):this.tab("")),this.confirmSaving(this.tab()),t&&this.populate(t),t&&t.isExtended()||App.Ajax.send(i,this.onAccountSettingsGetResponse,this),this.editedFetcherId(null),this.editedIdentityId(null)},this),e)},CEmailAccountsSettingsViewModel.prototype.onAccountSettingsGetResponse=function(e,t){if(e.Result){var i=AppData.Accounts.getAccount(t.AccountID);Utils.isUnd(i)||(i.updateExtended(e.Result),i.id()===this.editedAccountId()&&(this.populate(i),this.fillAccountPermissions(i.id())))}else App.Api.showErrorByCode(e,Utils.i18n("SETTINGS/ERROR_SETTINGS_SAVING_FAILED"))},CEmailAccountsSettingsViewModel.prototype.populate=function(e){this.allowAutoresponderExtension(e.allowMail()&&e.extensionExists("AllowAutoresponderExtension")),this.allowForwardExtension(e.allowMail()&&e.extensionExists("AllowForwardExtension")),this.allowSieveFiltersExtension(e.allowMail()&&e.extensionExists("AllowSieveFiltersExtension")),AppData.Accounts.changeEditedAccount(e.id()),this.bShown&&this.changeCurrentTab(this.tab())},CEmailAccountsSettingsViewModel.prototype.onIdentityAdd=function(e,t){t.stopPropagation(),App.Screens.showPopup(CreateIdentityPopup,[e])},CEmailAccountsSettingsViewModel.prototype.onConnectToMail=function(e,t){t.stopPropagation(),App.Api.showConfigureMailPopup(_.bind(function(e){this.onChangeAccount(e)},this))},CEmailAccountsSettingsViewModel.prototype.onFetcherAdd=function(e,t){App.Screens.showPopup(FetcherAddPopup,[])},CEmailAccountsSettingsViewModel.prototype.fetcherDelete=function(e,t){var i={Action:"AccountFetcherDelete",FetcherID:e};t&&App.Ajax.send(i,this.onAccountFetcherDeleteResponse,this)},CEmailAccountsSettingsViewModel.prototype.onFetcherDeleteClick=function(e){var t=Utils.i18n("WARNING/FETCHER_DELETE_WARNING"),i=_.bind(this.fetcherDelete,this,e.idFetcher()),s=e.incomingMailServer?e.incomingMailServer():"";App.Screens.showPopup(ConfirmPopup,[t,i,s])},CEmailAccountsSettingsViewModel.prototype.onAccountFetcherDeleteResponse=function(e,t){e.Result?(AppData.Accounts.populateFetchers(),this.editedFetcherId(null)):App.Api.showErrorByCode(e.ErrorCode,Utils.i18n("WARNING/FETCHER_DELETING_ERROR"))},CEmailAccountsSettingsViewModel.prototype.onChangeFetcher=function(e){this.fillAccountPermissions(AppData.Accounts.defaultId()),this.confirmSaving(this.tab(),_.bind(function(){var t=this.defaultAccount.fetchers().getFetcher(e);this.fetcher(t),this.isFetcherTab(this.tab())||this.onTabClick(Enums.AccountSettingsTab.FetcherInc),this.confirmSaving(this.tab()),this.oFetcherIncoming.populate(t),this.oFetcherOutgoing.populate(t),this.oFetcherSignature.populate(t),this.editedFetcherId(t.id()),this.editedIdentityId(null)},this),e)},CEmailAccountsSettingsViewModel.prototype.isFetcherTab=function(e){return-1!==Utils.inArray(e,[Enums.AccountSettingsTab.FetcherInc,Enums.AccountSettingsTab.FetcherOut,Enums.AccountSettingsTab.FetcherSig])},CEmailAccountsSettingsViewModel.prototype.onChangeIdentity=function(e){this.fillAccountPermissions(e.accountId()),this.confirmSaving(this.tab(),_.bind(function(){this.onTabClick(Enums.AccountSettingsTab.IdentityProperties),this.oIdentityProperties.populate(e),this.editedIdentityId(e.id()),this.editedFetcherId(null)},this),e)},CEmailAccountsSettingsViewModel.prototype.isIdentityTab=function(e){return-1!==Utils.inArray(e,[Enums.AccountSettingsTab.IdentityProperties,Enums.AccountSettingsTab.IdentitySignature])},CEmailAccountsSettingsViewModel.prototype.onRemoveIdentity=function(){this.editedIdentityId(null),this.changeCurrentTab(this.tab())},CEmailAccountsSettingsViewModel.prototype.confirmSaving=function(e,t,i){var s=this.getViewModel(e),o=_.bind(function(e){s&&setTimeout(function(){e?Utils.isFunc(s.onSaveClick)&&s.onSaveClick():(Utils.isFunc(s.revert)&&s.revert(),s.updateFirstState()),Utils.isFunc(t)&&(i?t(i):t())}.bind(this),1)},this);s&&Utils.isFunc(s.isChanged)&&s.isChanged()?App.Screens.showPopup(ConfirmPopup,[Utils.i18n("SETTINGS/CONFIRM_SETTINGS_SAVE"),o,"",Utils.i18n("SETTINGS/BUTTON_SAVE"),Utils.i18n("SETTINGS/BUTTON_DISCARD")]):Utils.isFunc(t)&&(i?t(i):t())},CCalendarSettingsViewModel.prototype.TemplateName="Settings_CalendarSettingsViewModel",CCalendarSettingsViewModel.prototype.TabName=Enums.SettingsTab.Calendar,CCalendarSettingsViewModel.prototype.TabTitle=Utils.i18n("SETTINGS/TAB_CALENDAR"),CCalendarSettingsViewModel.prototype.init=function(){this.showWeekends(AppData.User.CalendarShowWeekEnds),this.selectedWorkdayStarts(AppData.User.CalendarWorkDayStarts),this.selectedWorkdayEnds(AppData.User.CalendarWorkDayEnds),this.showWorkday(AppData.User.CalendarShowWorkDay),this.weekStartsOn(AppData.User.CalendarWeekStartsOn),this.defaultTab(AppData.User.CalendarDefaultTab)},CCalendarSettingsViewModel.prototype.getState=function(){var e=[this.showWeekends(),this.selectedWorkdayStarts(),this.selectedWorkdayEnds(),this.showWorkday(),this.weekStartsOn(),this.defaultTab()];return e.join(":")},CCalendarSettingsViewModel.prototype.updateFirstState=function(){this.firstState=this.getState()},CCalendarSettingsViewModel.prototype.isChanged=function(){return!(!this.firstState||this.getState()===this.firstState)},CCalendarSettingsViewModel.prototype.onResponse=function(e,t){this.loading(!1),e.Result===!1?App.Api.showErrorByCode(e,Utils.i18n("SETTINGS/ERROR_CALENDAR_SETTINGS_SAVING_FAILED")):(App.CalendarCache.calendarSettingsChanged(!0),AppData.User.updateCalendarSettings(t.ShowWeekEnds,t.ShowWorkDay,t.WorkDayStarts,t.WorkDayEnds,t.WeekStartsOn,t.DefaultTab),App.Api.showReport(Utils.i18n("SETTINGS/COMMON_REPORT_UPDATED_SUCCESSFULLY")))},CCalendarSettingsViewModel.prototype.onSaveClick=function(){var e={Action:"UserSettingsUpdate",ShowWeekEnds:this.showWeekends()?1:0,ShowWorkDay:this.showWorkday()?1:0,WorkDayStarts:parseInt(this.selectedWorkdayStarts(),10),WorkDayEnds:parseInt(this.selectedWorkdayEnds(),10),WeekStartsOn:parseInt(this.weekStartsOn(),10),DefaultTab:parseInt(this.defaultTab(),10)};this.loading(!0),this.updateFirstState(),App.Ajax.send(e,this.onResponse,this)},CMobileSyncSettingsViewModel.prototype.TemplateName="Settings_MobileSyncSettingsViewModel",CMobileSyncSettingsViewModel.prototype.TabName=Enums.SettingsTab.MobileSync,CMobileSyncSettingsViewModel.prototype.TabTitle=Utils.i18n("SETTINGS/TAB_MOBILE_SYNC"),CMobileSyncSettingsViewModel.prototype.onRoute=function(){AppData.User.requestSyncSettings()},CMobileSyncSettingsViewModel.prototype.onMobileSyncSubscribe=function(){this.enableDav(AppData.User.MobileSyncEnable&&this.mobileSync()&&this.mobileSync().EnableDav),this.enableDav()&&(this.davLogin(this.mobileSync().Dav.Login),this.davServer(this.mobileSync().Dav.Server),this.davCalendars(this.mobileSync().Dav.Calendars),this.davPersonalContactsUrl(this.mobileSync().Dav.PersonalContactsUrl),this.davCollectedAddressesUrl(this.mobileSync().Dav.CollectedAddressesUrl),this.davGlobalAddressBookUrl(this.mobileSync().Dav.GlobalAddressBookUrl),this.davSharedWithAllUrl(this.mobileSync().Dav.SharedWithAllUrl))},COutLookSyncSettingsViewModel.prototype.TemplateName="Settings_OutLookSyncSettingsViewModel",COutLookSyncSettingsViewModel.prototype.TabName=Enums.SettingsTab.OutLookSync,COutLookSyncSettingsViewModel.prototype.TabTitle=Utils.i18n("SETTINGS/TAB_OUTLOOK_SYNC"),COutLookSyncSettingsViewModel.prototype.onRoute=function(){AppData.User.requestSyncSettings()},COutLookSyncSettingsViewModel.prototype.onOutlookSyncSubscribe=function(){AppData.User.OutlookSyncEnable&&(this.visibleOutlookSync(!0),this.outlookSync()&&this.server(this.outlookSync().Server))},CResetPasswordViewModel.prototype.configureMail=function(){App.Api.showConfigureMailPopup()},CResetPasswordViewModel.prototype.resetPassword=function(){var e=AppData.Accounts.getDefault();""!==App.sResetPassHash||e.passwordSpecified()?App.Api.showChangeDefaultAccountPasswordPopup():App.Screens.showPopup(ConfirmPopup,[Utils.i18n("SETTINGS/ACCOUNTS_RESET_PASSWORD_POPUP_DESC",{EMAIL:e.email()}),_.bind(this.onResetPasswordPopupAnswer,this),e.passwordSpecified()?Utils.i18n("SETTINGS/ACCOUNTS_RESET_PASSWORD_POPUP_TITLE"):Utils.i18n("SETTINGS/ACCOUNTS_SET_PASSWORD_POPUP_TITLE"),Utils.i18n("MAIN/BUTTON_SEND"),Utils.i18n("MAIN/BUTTON_CANCEL")])},CResetPasswordViewModel.prototype.onResetPasswordPopupAnswer=function(e){e&&(App.Api.showLoading(Utils.i18n("COMPOSE/INFO_SENDING")),App.Ajax.send({Action:"AccountResetPassword",UrlHash:App.Routing.currentHash()},this.onResetPassword,this))},CResetPasswordViewModel.prototype.onResetPassword=function(e,t){App.Api.hideLoading(),e.Result?App.Api.showReport(Utils.i18n("SETTINGS/ACCOUNTS_RESET_PASSWORD_INFO_AFTER")):App.Api.showErrorByCode(e)},CPgpSettingsViewModel.prototype.TemplateName="Settings_PgpSettingsViewModel",CPgpSettingsViewModel.prototype.TabName=Enums.SettingsTab.Pgp,CPgpSettingsViewModel.prototype.TabTitle=Utils.i18n("SETTINGS/TAB_OPENPGP"),CPgpSettingsViewModel.prototype.init=function(){this.enableOpenPgp(AppData.User.enableOpenPgp()),this.allowAutosaveInDrafts(AppData.User.AllowAutosaveInDrafts),this.autosignOutgoingEmails(AppData.User.AutosignOutgoingEmails)},CPgpSettingsViewModel.prototype.getState=function(){var e=[this.enableOpenPgp(),this.allowAutosaveInDrafts(),this.autosignOutgoingEmails()];return e.join(":")},CPgpSettingsViewModel.prototype.updateFirstState=function(){this.firstState=this.getState()},CPgpSettingsViewModel.prototype.isChanged=function(){return!(!this.firstState||this.getState()===this.firstState)},CPgpSettingsViewModel.prototype.onRoute=function(){var e=_.bind(function(e){e&&(this.pgp=e,this.keys(this.pgp.getKeys()),this.pgp.getKeysObservable().subscribe(function(){this.keys(this.pgp.getKeys())},this)),this.pgpLoaded(!0)},this);App.Api.pgp(e,AppData.User.IdUser)},CPgpSettingsViewModel.prototype.importKey=function(){this.pgp&&App.Screens.showPopup(CImportOpenPgpKeyPopup,[this.pgp])},CPgpSettingsViewModel.prototype.generateNewKey=function(){this.pgp&&App.Screens.showPopup(CGenerateOpenPgpKeyPopup,[this.pgp])},CPgpSettingsViewModel.prototype.removeOpenPgpKey=function(e){var t="",i=_.bind(function(t){if(t){var i=this.pgp.deleteKey(e);i.result||App.Api.showError(Utils.i18n("OPENPGP/ERROR_DELETE_KEY"))}},this);this.pgp&&e&&(t=Utils.i18n("OPENPGP/CONFIRM_DELETE_KEY",{KEYEMAIL:e.getEmail()}),App.Screens.showPopup(ConfirmPopup,[t,i]))},CPgpSettingsViewModel.prototype.showArmor=function(e){this.pgp&&App.Screens.showPopup(CShowOpenPgpKeyArmorPopup,[e])},CPgpSettingsViewModel.prototype.onResponse=function(e,t){this.loading(!1),e.Result===!1?App.Api.showErrorByCode(e,Utils.i18n("SETTINGS/ERROR_SETTINGS_SAVING_FAILED")):(AppData.User.updateOpenPgpSettings(t.EnableOpenPgp,t.AllowAutosaveInDrafts,t.AutosignOutgoingEmails),App.Api.showReport(Utils.i18n("SETTINGS/COMMON_REPORT_UPDATED_SUCCESSFULLY")))},CPgpSettingsViewModel.prototype.onSaveClick=function(){var e={Action:"UserSettingsUpdate",EnableOpenPgp:this.enableOpenPgp()?"1":"0",AllowAutosaveInDrafts:this.allowAutosaveInDrafts()?"1":"0",AutosignOutgoingEmails:this.autosignOutgoingEmails()?"1":"0"};this.loading(!0),this.updateFirstState(),App.Ajax.send(e,this.onResponse,this)},CAccountPropertiesViewModel.prototype.onShow=function(e){this.account(e),this.populate()},CAccountPropertiesViewModel.prototype.onHide=function(){this.isAllowMail(!1)},CAccountPropertiesViewModel.prototype.getState=function(){var e=[this.friendlyName(),this.email(),this.incomingMailLogin(),this.oIncoming.port(),this.oIncoming.server(),this.oIncoming.ssl(),this.outgoingMailLogin(),this.oOutgoing.port(),this.oOutgoing.server(),this.oOutgoing.ssl(),this.useSmtpAuthentication()];return e.join(":")},CAccountPropertiesViewModel.prototype.updateFirstState=function(){this.firstState=this.getState()},CAccountPropertiesViewModel.prototype.isChanged=function(){return!!this.firstState&&this.getState()!==this.firstState},CAccountPropertiesViewModel.prototype.populate=function(){var e=this.account();e?(this.isAllowMail(e.allowMail()),this.allowChangePassword(e.extensionExists("AllowChangePasswordExtension")),this.isInternal(e.isInternal()),this.isLinked(e.isLinked()),this.isDefault(e.isDefault()),this.removeHint(e.removeHint()),this.canBeRemoved(e.canBeRemoved()),this.useSmtpAuthentication(2===Utils.pInt(e.outgoingMailAuth())),this.friendlyName(e.friendlyName()),this.email(e.email()),this.incomingMailLogin(e.incomingMailLogin()),this.oIncoming.set(e.incomingMailServer(),e.incomingMailPort(),e.incomingMailSsl()),this.outgoingMailLogin(e.outgoingMailLogin()),this.oOutgoing.set(e.outgoingMailServer(),e.outgoingMailPort(),e.outgoingMailSsl()),this.updateFirstState()):(this.allowChangePassword(!1),this.isLinked(!0),this.useSmtpAuthentication(!0),this.friendlyName(""),this.email(""),this.incomingMailLogin(""),this.oIncoming.clear(),this.outgoingMailLogin(""),this.oOutgoing.clear())},CAccountPropertiesViewModel.prototype.onAccountSettingsUpdateResponse=function(e,t){if(this.loading(!1),e.Result){var i=Utils.pInt(e.AccountID),s=0<i?AppData.Accounts.getAccount(i):null;s&&(s.updateExtended(t),App.Api.showReport(Utils.i18n("SETTINGS/COMMON_REPORT_UPDATED_SUCCESSFULLY")))}else App.Api.showErrorByCode(e,Utils.i18n("SETTINGS/ERROR_SETTINGS_SAVING_FAILED"))},CAccountPropertiesViewModel.prototype.prepareParameters=function(){var e={Action:"AccountSettingsUpdate",AccountID:this.account().id(),FriendlyName:this.friendlyName(),Email:this.email(),IncomingMailLogin:this.incomingMailLogin(),IncomingMailServer:this.oIncoming.server(),IncomingMailPort:this.oIncoming.getIntPort(),IncomingMailSsl:this.oIncoming.getIntSsl(),OutgoingMailLogin:this.outgoingMailLogin(),OutgoingMailServer:this.oOutgoing.server(),OutgoingMailPort:this.oOutgoing.getIntPort(),OutgoingMailSsl:this.oOutgoing.getIntSsl(),OutgoingMailAuth:this.useSmtpAuthentication()?2:0,IncomingMailPassword:this.incomingMailPassword()};return e},CAccountPropertiesViewModel.prototype.saveData=function(e){this.isAllowMail()&&(this.updateFirstState(),App.Ajax.send(e,this.onAccountSettingsUpdateResponse,this))},CAccountPropertiesViewModel.prototype.onSaveClick=function(){this.account()&&this.isAllowMail()&&(this.loading(!0),this.saveData(this.prepareParameters()))},CAccountPropertiesViewModel.prototype.onChangePasswordClick=function(){App.Screens.showPopup(ChangePasswordPopup,[!1,!0])},CAccountFoldersViewModel.prototype.__name="CAccountFoldersViewModel",CAccountFoldersViewModel.prototype.onHide=function(){var e=AppData.Accounts.editedId();_.delay(function(){App.MailCache.getFolderList(e)},3e3)},CAccountFoldersViewModel.prototype.onShow=function(){this.setTotalMessageCount()},CAccountFoldersViewModel.prototype.setTotalMessageCount=function(){var e=App.MailCache.editedFolderList();0===e.iAccountId?this.totalMessageCount(0):(this.totalMessageCount(e.getTotalMessageCount()),e.countsCompletelyFilled()||(e.countsCompletelyFilledSubscribtion&&(e.countsCompletelyFilledSubscribtion.dispose(),e.countsCompletelyFilledSubscribtion=null),e.countsCompletelyFilledSubscribtion=e.countsCompletelyFilled.subscribe(function(){e.countsCompletelyFilled()&&(this.totalMessageCount(e.getTotalMessageCount()),e.countsCompletelyFilledSubscribtion.dispose(),e.countsCompletelyFilledSubscribtion=null)},this)))},CAccountFoldersViewModel.prototype.isChanged=function(){return!1},CAccountFoldersViewModel.prototype.onAddNewFolderClick=function(){App.Screens.showPopup(FolderCreatePopup)},CAccountFoldersViewModel.prototype.onSystemFoldersClick=function(){App.Screens.showPopup(SystemFoldersPopup)},CAccountSignatureViewModel.prototype.__name="CAccountSignatureViewModel",CAccountSignatureViewModel.prototype.onShow=function(e){this.account(e),this.oHtmlEditor.initCrea(this.signature(),!1,""),this.oHtmlEditor.setActivitySource(this.useSignature),this.oHtmlEditor.resize(),this.enableImageDragNDrop(this.oHtmlEditor.editorUploader.isDragAndDropSupported()&&!App.browser.ie10AndAbove),this.updateFirstState()},CAccountSignatureViewModel.prototype.getState=function(){var e=[this.type(),this.useSignature(),this.oHtmlEditor.getText()];return e.join(":")},CAccountSignatureViewModel.prototype.updateFirstState=function(){this.firstState=this.getState()},CAccountSignatureViewModel.prototype.isChanged=function(){return!(!this.firstState||this.getState()===this.firstState)},CAccountSignatureViewModel.prototype.getSignature=function(){if(this.account())if(null!==this.account().signature())this.type(this.account().signature().type()),this.useSignature(this.account().signature().options()),this.signature(this.account().signature().signature()),this.updateFirstState();else{var e={Action:"AccountSignatureGet",AccountID:this.account().id()};App.Ajax.send(e,this.onAccountSignatureGetResponse,this)}},CAccountSignatureViewModel.prototype.onAccountSignatureGetResponse=function(e,t){var i=null,s=parseInt(e.AccountID,10);e.Result?this.account()&&s===this.account().id()&&(i=new CSignatureModel,i.parse(s,e.Result),this.account().signature(i),this.type(this.account().signature().type()),this.useSignature(this.account().signature().options()),this.signature(this.account().signature().signature()),this.updateFirstState()):App.Api.showErrorByCode(e)},CAccountSignatureViewModel.prototype.prepareParameters=function(){var e={Action:"AccountSignatureUpdate",AccountID:this.account().id(),Type:this.type()?1:0,Options:this.useSignature(),Signature:this.signature()};return e},CAccountSignatureViewModel.prototype.saveData=function(e){this.updateFirstState(),App.Ajax.send(e,this.onAccountSignatureUpdateResponse,this)},CAccountSignatureViewModel.prototype.onSaveClick=function(){this.account()&&(this.loading(!0),this.signature(this.oHtmlEditor.getNotDefaultText()),this.account().signature().type(this.type()),this.account().signature().options(this.useSignature()),this.account().signature().signature(this.signature()),this.saveData(this.prepareParameters()))},CAccountSignatureViewModel.prototype.onAccountSignatureUpdateResponse=function(e,t){this.loading(!1),e.Result?App.Api.showReport(Utils.i18n("SETTINGS/COMMON_REPORT_UPDATED_SUCCESSFULLY")):App.Api.showErrorByCode(e,Utils.i18n("SETTINGS/ERROR_SETTINGS_SAVING_FAILED"))},CAccountForwardViewModel.prototype.onShow=function(e){this.account(e)},CAccountForwardViewModel.prototype.getState=function(){return[this.enable(),this.email()].join(":")},CAccountForwardViewModel.prototype.updateFirstState=function(){this.firstState=this.getState()},CAccountForwardViewModel.prototype.isChanged=function(){return this.firstState&&this.getState()!==this.firstState},CAccountForwardViewModel.prototype.prepareParameters=function(){return{Action:"AccountForwardUpdate",AccountID:this.account().id(),Enable:this.enable()?"1":"0",Email:this.email()}},CAccountForwardViewModel.prototype.saveData=function(e){this.updateFirstState(),
App.Ajax.send(e,this.onAccountForwardUpdateResponse,this)},CAccountForwardViewModel.prototype.onSaveClick=function(){if(this.account()){var e=this,t=this.account().forward(),i=function(){t&&(t.enable=e.enable(),t.email=e.email()),e.loading(!0),e.saveData(e.prepareParameters())};this.enable()&&""===this.email()?this.emailFocus(!0):this.enable()&&""!==this.email()?Utils.Address.isCorrectEmail(this.email())?i():App.Screens.showPopup(AlertPopup,[Utils.i18n("COMPOSE/WARNING_INPUT_CORRECT_EMAILS")+" "+this.email()]):i()}},CAccountForwardViewModel.prototype.getForward=function(){if(this.account())if(null!==this.account().forward())this.enable(this.account().forward().enable),this.email(this.account().forward().email),this.firstState=this.getState();else{var e={Action:"AccountForwardGet",AccountID:this.account().id()};this.loading(!0),this.updateFirstState(),App.Ajax.send(e,this.onAccountForwardGetResponse,this)}},CAccountForwardViewModel.prototype.onAccountForwardGetResponse=function(e,t){if(this.loading(!1),t&&t.Action){if(e&&e.Result&&e.AccountID&&this.account()){var i=null,s=new CForwardModel,o=Utils.pInt(e.AccountID);o&&(i=AppData.Accounts.getAccount(o),i&&(s.parse(o,e.Result),i.forward(s),this.enable(i.forward().enable),this.email(i.forward().email),this.updateFirstState(),o===this.account().id()&&this.getForward()))}}else App.Api.showError(Utils.i18n("WARNING/UNKNOWN_ERROR"))},CAccountForwardViewModel.prototype.onAccountForwardUpdateResponse=function(e,t){this.loading(!1),t&&t.Action?e&&e.Result?App.Api.showReport(Utils.i18n("SETTINGS/ACCOUNT_FORWARD_SUCCESS_REPORT")):App.Api.showErrorByCode(e,Utils.i18n("SETTINGS/ERROR_SETTINGS_SAVING_FAILED")):App.Api.showError(Utils.i18n("WARNING/UNKNOWN_ERROR"))},CAccountAutoresponderViewModel.prototype.onShow=function(e){this.account(e)},CAccountAutoresponderViewModel.prototype.getState=function(){var e=[this.enable(),this.subject(),this.message()];return e.join(":")},CAccountAutoresponderViewModel.prototype.updateFirstState=function(){this.firstState=this.getState()},CAccountAutoresponderViewModel.prototype.isChanged=function(){return!(!this.firstState||this.getState()===this.firstState)},CAccountAutoresponderViewModel.prototype.prepareParameters=function(){var e={Action:"AccountAutoresponderUpdate",AccountID:this.account().id(),Enable:this.enable()?"1":"0",Subject:this.subject(),Message:this.message()};return e},CAccountAutoresponderViewModel.prototype.saveData=function(e){this.updateFirstState(),App.Ajax.send(e,this.onAccountAutoresponderUpdateResponse,this)},CAccountAutoresponderViewModel.prototype.onSaveClick=function(){if(this.account()){var e=this.account().autoresponder();e&&(e.enable=this.enable(),e.subject=this.subject(),e.message=this.message()),this.loading(!0),this.saveData(this.prepareParameters())}},CAccountAutoresponderViewModel.prototype.getAutoresponder=function(){if(this.account())if(null!==this.account().autoresponder())this.enable(this.account().autoresponder().enable),this.subject(this.account().autoresponder().subject),this.message(this.account().autoresponder().message),this.updateFirstState();else{var e={Action:"AccountAutoresponderGet",AccountID:this.account().id()};this.loading(!0),App.Ajax.send(e,this.onAccountAutoresponderGetResponse,this)}},CAccountAutoresponderViewModel.prototype.onAccountAutoresponderGetResponse=function(e,t){if(this.loading(!1),t&&t.Action){if(e&&e.Result&&e.AccountID&&this.account()){var i=null,s=new CAutoresponderModel,o=Utils.pInt(e.AccountID);o&&(i=AppData.Accounts.getAccount(o),i&&(s.parse(o,e.Result),i.autoresponder(s),o===this.account().id()&&this.getAutoresponder()))}}else App.Api.showError(Utils.i18n("WARNING/UNKNOWN_ERROR"))},CAccountAutoresponderViewModel.prototype.onAccountAutoresponderUpdateResponse=function(e,t){this.loading(!1),t&&t.Action?e&&e.Result?App.Api.showReport(Utils.i18n("SETTINGS/ACCOUNT_AUTORESPONDER_SUCCESS_REPORT")):App.Api.showErrorByCode(e,Utils.i18n("SETTINGS/ERROR_SETTINGS_SAVING_FAILED")):App.Api.showError(Utils.i18n("WARNING/UNKNOWN_ERROR"))},CAccountFiltersViewModel.prototype.onShow=function(e){this.bShown=!0,this.oEditedAccount=e,this.populate()},CAccountFiltersViewModel.prototype.onHide=function(){this.bShown=!1,this.collection([]),this.updateFirstState()},CAccountFiltersViewModel.prototype.populate=function(){var e=App.MailCache.editedFolderList(),t=[];e.iAccountId===this.oEditedAccount.id()?(t=e.getOptions(Utils.i18n("SETTINGS/ACCOUNT_FOLDERS_NOT_SELECTED"),!0,!0,!1,!0),this.foldersOptions(t),this.getFilters()):(this.loading(!0),this.collection([]))},CAccountFiltersViewModel.prototype.revert=function(){_.each(this.collection(),function(e){e.revert()})},CAccountFiltersViewModel.prototype.commit=function(){_.each(this.collection(),function(e){e.commit()})},CAccountFiltersViewModel.prototype.getState=function(){var e=":",t=_.map(this.collection(),function(e){return e.toString()},this);return t.length>0&&(e=t.join(":")),e},CAccountFiltersViewModel.prototype.updateFirstState=function(){this.firstState=this.getState()},CAccountFiltersViewModel.prototype.isChanged=function(){return this.firstState&&this.getState()!==this.firstState},CAccountFiltersViewModel.prototype.prepareParameters=function(){var e=_.map(this.collection(),function(e){return{Enable:e.enable()?"1":"0",Field:e.field(),Filter:e.filter(),Condition:e.condition(),Action:e.action(),FolderFullName:e.folder()}}),t={Action:"AccountSieveFiltersUpdate",AccountID:this.oEditedAccount.id(),Filters:e};return t},CAccountFiltersViewModel.prototype.saveData=function(e){var t=_.some(this.collection(),function(e){return""===e.filter()||"3"===Utils.pString(e.action())&&""===e.folder()});t?App.Api.showError(Utils.i18n("SETTINGS/ERROR_FILTERS_FIELDS_FILL")):(this.saving(!0),this.commit(),this.updateFirstState(),App.Ajax.send(e,this.onAccountSieveFiltersUpdateResponse,this))},CAccountFiltersViewModel.prototype.onSaveClick=function(){this.oEditedAccount&&this.saveData(this.prepareParameters())},CAccountFiltersViewModel.prototype.getFilters=function(){if(this.oEditedAccount)if(null!==this.oEditedAccount.filters())this.loading(!1),this.collection(this.oEditedAccount.filters().collection()),this.updateFirstState();else{var e={Action:"AccountSieveFiltersGet",AccountID:this.oEditedAccount.id()};this.loading(!0),this.collection([]),App.Ajax.send(e,this.onAccountSieveFiltersGetResponse,this)}},CAccountFiltersViewModel.prototype.deleteFilter=function(e){this.collection.remove(e)},CAccountFiltersViewModel.prototype.addFilter=function(){if(this.oEditedAccount){var e=new CSieveFilterModel(this.oEditedAccount.id());this.collection.push(e)}},CAccountFiltersViewModel.prototype.displayFilterPart=function(e,t){var i="";return i="%FIELD%"===e?"Field":"%CONDITION%"===e?"Condition":"%STRING%"===e?"String":"%ACTION%"===e?"Action":"%FOLDER%"===e?"Folder":"%DEPENDED"===e.substr(0,9)?"DependedText":"Text",t+i},CAccountFiltersViewModel.prototype.getDependedText=function(e){return e=Utils.pString(e),e&&(e=e.replace(/%/g,"").split("=")[1]||""),e},CAccountFiltersViewModel.prototype.getDependedField=function(e,t){return e=Utils.pString(e),e&&(e=e.replace(/[=](.*)/g,"").split("-")[1]||"",e=e.toLowerCase()),!Utils.isUnd(t[e])&&t[e]()},CAccountFiltersViewModel.prototype.onAccountSieveFiltersGetResponse=function(e,t){if(this.loading(!1),t&&t.Action){if(e&&e.Result&&e.AccountID&&this.oEditedAccount){var i=null,s=new CSieveFiltersModel,o=Utils.pInt(e.AccountID);o&&(i=AppData.Accounts.getAccount(o),i&&(s.parse(o,e.Result),i.filters(s),o===this.oEditedAccount.id()&&this.getFilters()))}}else App.Api.showError(Utils.i18n("WARNING/UNKNOWN_ERROR"))},CAccountFiltersViewModel.prototype.onAccountSieveFiltersUpdateResponse=function(e,t){this.saving(!1),t&&t.Action?e&&e.Result?App.Api.showReport(Utils.i18n("SETTINGS/ACCOUNT_FILTERS_SUCCESS_REPORT")):App.Api.showError(Utils.i18n("SETTINGS/ERROR_SETTINGS_SAVING_FAILED")):App.Api.showError(Utils.i18n("WARNING/UNKNOWN_ERROR"))},CFetcherIncomingViewModel.prototype.onShow=function(){this.bShown=!0,this.populateOptions()},CFetcherIncomingViewModel.prototype.populateOptions=function(){this.bShown&&(this.options(App.MailCache.folderList().getOptions("",!0,!1,!1)),this.sFetcherFolder!==this.folder()&&(this.folder(this.sFetcherFolder),this.updateFirstState()))},CFetcherIncomingViewModel.prototype.onHide=function(){this.bShown=!1},CFetcherIncomingViewModel.prototype.onSaveClick=function(){if(this.isEmptyRequiredFields())App.Api.showError(Utils.i18n("WARNING/FETCHER_CREATE_ERROR"));else{var e={Action:"AccountFetcherUpdate",AccountID:AppData.Accounts.defaultId(),FetcherID:this.idFetcher(),IsEnabled:this.isEnabled()?1:0,Folder:this.folder(),IncomingMailServer:this.oIncoming.server(),IncomingMailPort:this.oIncoming.getIntPort(),IncomingMailSsl:this.oIncoming.getIntSsl(),IncomingMailPassword:""===this.incomingMailPassword()?"******":this.incomingMailPassword(),LeaveMessagesOnServer:this.leaveMessagesOnServer()?1:0};this.loading(!0),App.Ajax.send(e,this.onAccountFetcherUpdateResponse,this)}},CFetcherIncomingViewModel.prototype.onAccountFetcherUpdateResponse=function(e,t){this.loading(!1),e.Result?(App.Api.showReport(Utils.i18n("SETTINGS/ACCOUNT_FETCHER_SUCCESSFULLY_SAVED")),this.updateFirstState(),AppData.Accounts.populateFetchers()):App.Api.showErrorByCode(e,Utils.i18n("WARNING/UNKNOWN_ERROR"))},CFetcherIncomingViewModel.prototype.populate=function(e){e&&(this.sFetcherFolder=e.folder(),this.idFetcher(e.id()),this.isEnabled(e.isEnabled()),this.folder(e.folder()),this.oIncoming.set(e.incomingMailServer(),e.incomingMailPort(),e.incomingMailSsl()),this.incomingMailLogin(e.incomingMailLogin()),this.incomingMailPassword("******"),this.leaveMessagesOnServer(e.leaveMessagesOnServer()),this.updateFirstState())},CFetcherIncomingViewModel.prototype.isEmptyRequiredFields=function(){switch(""){case this.oIncoming.server():return this.oIncoming.focused(!0),!0;case this.incomingMailPassword():return this.passwordIsSelected(!0),!0;default:return!1}},CFetcherIncomingViewModel.prototype.getState=function(){return[this.isEnabled(),this.oIncoming.server(),this.oIncoming.port(),this.oIncoming.ssl(),this.incomingMailPassword(),this.folder(),this.leaveMessagesOnServer()].join(":")},CFetcherIncomingViewModel.prototype.updateFirstState=function(){this.firstState=this.getState()},CFetcherIncomingViewModel.prototype.isChanged=function(){return!!this.firstState&&this.getState()!==this.firstState},CFetcherOutgoingViewModel.prototype.onSaveClick=function(){if(this.outgoingMailAuth()&&this.isEmptyRequiredFields())App.Api.showError(Utils.i18n("WARNING/FETCHER_CREATE_ERROR"));else{var e={Action:"AccountFetcherUpdate",AccountID:this.defaultAccountId(),FetcherID:this.idFetcher(),Email:this.email(),Name:this.userName(),IsOutgoingEnabled:this.isOutgoingEnabled()?1:0,OutgoingMailServer:this.oOutgoing.server(),OutgoingMailPort:this.oOutgoing.getIntPort(),OutgoingMailSsl:this.oOutgoing.getIntSsl(),OutgoingMailAuth:this.outgoingMailAuth()?1:0};this.loading(!0),App.Ajax.send(e,this.onAccountFetcherUpdateResponse,this)}},CFetcherOutgoingViewModel.prototype.onAccountFetcherUpdateResponse=function(e,t){this.loading(!1),e.Result?(App.Api.showReport(Utils.i18n("SETTINGS/ACCOUNT_FETCHER_SUCCESSFULLY_SAVED")),this.updateFirstState(),AppData.Accounts.populateFetchers()):App.Api.showErrorByCode(e,Utils.i18n("WARNING/UNKNOWN_ERROR"))},CFetcherOutgoingViewModel.prototype.populate=function(e){e&&(this.fetcher(e),this.idFetcher(e.id()),this.isEnabled(e.isEnabled()),this.email(e.email()),this.userName(e.userName()),this.isOutgoingEnabled(e.isOutgoingEnabled()),this.oOutgoing.set(e.outgoingMailServer(),e.outgoingMailPort(),e.outgoingMailSsl()),this.outgoingMailAuth(e.outgoingMailAuth()),this.updateFirstState())},CFetcherOutgoingViewModel.prototype.isEmptyRequiredFields=function(){return this.isOutgoingEnabled()&&""===this.oOutgoing.server()?(this.oOutgoing.focused(!0),!0):!(!this.outgoingMailAuth()||""!==this.email())&&(this.focusEmail(!0),!0)},CFetcherOutgoingViewModel.prototype.getState=function(){return[this.isOutgoingEnabled(),this.oOutgoing.server(),this.oOutgoing.port(),this.oOutgoing.ssl(),this.outgoingMailAuth(),this.userName(),this.email()].join(":")},CFetcherOutgoingViewModel.prototype.updateFirstState=function(){this.firstState=this.getState()},CFetcherOutgoingViewModel.prototype.isChanged=function(){return!!this.firstState&&this.getState()!==this.firstState},CFetcherSignatureViewModel.prototype.__name="CFetcherSignatureViewModel",CFetcherSignatureViewModel.prototype.onSaveClick=function(){var e={Action:"AccountFetcherUpdate",AccountID:this.defaultAccountId(),FetcherID:this.idFetcher(),SignatureOptions:this.useSignature(),Signature:this.oHtmlEditor.getNotDefaultText()};this.loading(!0),App.Ajax.send(e,this.onAccountFetcherUpdateResponse,this)},CFetcherSignatureViewModel.prototype.onAccountFetcherUpdateResponse=function(e,t){this.loading(!1),e.Result?(App.Api.showReport(Utils.i18n("SETTINGS/COMMON_REPORT_UPDATED_SUCCESSFULLY")),this.updateFirstState(),AppData.Accounts.populateFetchers()):App.Api.showErrorByCode(e,Utils.i18n("SETTINGS/ERROR_SETTINGS_SAVING_FAILED"))},CFetcherSignatureViewModel.prototype.populate=function(e){e&&(this.fetcher(e),this.idFetcher(e.id()),this.signature(e.signature()),this.useSignature(e.signatureOptions()),setTimeout(function(){this.updateFirstState()}.bind(this),1))},CFetcherSignatureViewModel.prototype.onShow=function(e,t){this.oHtmlEditor.initCrea(this.signature(),!1,""),this.oHtmlEditor.setActivitySource(this.useSignature),this.oHtmlEditor.resize(),this.enableImageDragNDrop(this.oHtmlEditor.editorUploader.isDragAndDropSupported()&&!App.browser.ie10AndAbove),this.updateFirstState()},CFetcherSignatureViewModel.prototype.getState=function(){return[this.type(),this.useSignature(),this.oHtmlEditor.getNotDefaultText()].join(":")},CFetcherSignatureViewModel.prototype.updateFirstState=function(){this.firstState=this.getState()},CFetcherSignatureViewModel.prototype.isChanged=function(){return!!this.firstState&&this.getState()!==this.firstState},CHelpdeskSettingsViewModel.prototype.TemplateName="Settings_HelpdeskSettingsViewModel",CHelpdeskSettingsViewModel.prototype.TabName=Enums.SettingsTab.Helpdesk,CHelpdeskSettingsViewModel.prototype.TabTitle=Utils.i18n("SETTINGS/TAB_HELPDESK"),CHelpdeskSettingsViewModel.prototype.onShow=function(){this.allowNotifications(AppData.User.AllowHelpdeskNotifications)},CHelpdeskSettingsViewModel.prototype.onApplyBindings=function(e){$(this.domSignature()).on("click",function(){this.signatureFocused(!0)}.bind(this))},CHelpdeskSettingsViewModel.prototype.onSaveClick=function(){var e={Action:"HelpdeskUserSettingsUpdate",AllowHelpdeskNotifications:this.allowNotifications()?"1":"0",HelpdeskSignature:this.signature(),HelpdeskSignatureEnable:this.signatureEnable()};this.loading(!0),App.Ajax.send(e,this.onUpdateResponse,this)},CHelpdeskSettingsViewModel.prototype.onUpdateResponse=function(e,t){this.loading(!1),e.Result===!1?App.Api.showErrorByCode(e,Utils.i18n("SETTINGS/ERROR_SETTINGS_SAVING_FAILED")):(AppData.User.updateHelpdeskSettings(this.allowNotifications(),this.signature(),this.signatureEnable()),App.Api.showReport(Utils.i18n("SETTINGS/COMMON_REPORT_UPDATED_SUCCESSFULLY")))},CCloudStorageSettingsViewModel.prototype.__name="CCloudStorageSettingsViewModel",CCloudStorageSettingsViewModel.prototype.TemplateName="Settings_CloudStorageSettingsViewModel",CCloudStorageSettingsViewModel.prototype.TabName=Enums.SettingsTab.CloudStorage,CCloudStorageSettingsViewModel.prototype.TabTitle=Utils.i18n("SETTINGS/TAB_CLOUD_STORAGE"),CCloudStorageSettingsViewModel.prototype.getState=function(){var e=[this.enableFiles()];return e.join(":")},CCloudStorageSettingsViewModel.prototype.updateFirstState=function(){this.firstState=this.getState()},CCloudStorageSettingsViewModel.prototype.isChanged=function(){return!(!this.firstState||this.getState()===this.firstState)},CCloudStorageSettingsViewModel.prototype.init=function(){this.enableFiles(AppData.User.filesEnable())},CCloudStorageSettingsViewModel.prototype.onApplyBindings=function(){},CCloudStorageSettingsViewModel.prototype.onShow=function(){},CCloudStorageSettingsViewModel.prototype.onRoute=function(){},CCloudStorageSettingsViewModel.prototype.onSaveClick=function(){var e={Action:"UserSettingsUpdate",FilesEnable:this.enableFiles()?"1":"0"};this.loading(!0),this.updateFirstState(),App.Ajax.send(e,this.onResponse,this)},CCloudStorageSettingsViewModel.prototype.onResponse=function(e,t){this.loading(!1),e.Result===!1?App.Api.showErrorByCode(e,Utils.i18n("SETTINGS/ERROR_SETTINGS_SAVING_FAILED")):(AppData.User.filesEnable(this.enableFiles()),App.Api.showReport(Utils.i18n("SETTINGS/COMMON_REPORT_UPDATED_SUCCESSFULLY")))},CIdentityPropertiesViewModel.prototype.__name="CIdentityPropertiesViewModel",CIdentityPropertiesViewModel.prototype.onShow=function(e,t){this.oHtmlEditor.initCrea(this.signature(),!1,""),this.oHtmlEditor.setActivitySource(this.useSignature),this.oHtmlEditor.resize(),this.enableImageDragNDrop(this.oHtmlEditor.editorUploader.isDragAndDropSupported()&&!App.browser.ie10AndAbove)},CIdentityPropertiesViewModel.prototype.onSaveClick=function(){var e={};if(this.updateFirstState(),""===this.email())App.Api.showError(Utils.i18n("WARNING/IDENTITY_CREATE_ERROR"));else if(this.identity().loyal()){var t=AppData.Accounts.getAccount(this.identity().accountId());this.loading(!0),this.signature(this.oHtmlEditor.getNotDefaultText()),t.signature().options(this.useSignature()),t.signature().signature(this.signature()),e={Action:"AccountIdentityLoyalUpdate",AccountID:t.id(),FriendlyName:this.friendlyName(),Type:t.signature().type()?1:0,Signature:this.signature(),Options:this.useSignature(),Loyal:1,Default:this.isDefault()?1:0},App.Ajax.send(e,this.onAccountIdentityUpdateResponse,this)}else this.loading(!0),this.signature(this.oHtmlEditor.getNotDefaultText()),e={Action:this.bCreate?"AccountIdentityCreate":"AccountIdentityUpdate",AccountID:this.identity().accountId(),Enabled:this.enabled()?1:0,Email:this.email(),Signature:this.signature(),UseSignature:this.useSignature(),FriendlyName:this.friendlyName(),Loyal:0,Default:this.isDefault()?1:0},this.bCreate||(e.IdIdentity=this.identity().id()),this.loading(!0),App.Ajax.send(e,this.onAccountIdentityUpdateResponse,this)},CIdentityPropertiesViewModel.prototype.onAccountIdentityUpdateResponse=function(e,t){if(this.loading(!1),e.Result){if(AppData.Accounts.populateIdentities(),this.bCreate&&this.oEmailAccountsSettings.closeCommand(),t.Loyal){var i=Utils.pInt(e.AccountID),s=0<i?AppData.Accounts.getAccount(i):null;s&&(s.updateExtended(t),s.isExtended(!1),App.Api.showReport(Utils.i18n("SETTINGS/COMMON_REPORT_UPDATED_SUCCESSFULLY")))}this.disableCheckbox(this.isDefault())}else App.Api.showErrorByCode(e,Utils.i18n("SETTINGS/ACCOUNTS_IDENTITY_ADDING_ERROR"))},CIdentityPropertiesViewModel.prototype.populate=function(e){e&&(this.identity(e),this.enabled(e.enabled()),this.isDefault(e.isDefault()),this.email(e.email()),this.loyal(e.loyal()),this.friendlyName(e.friendlyName()),this.signature(e.signature()),this.useSignature(e.useSignature()?1:0),this.disableCheckbox(e.isDefault()),setTimeout(function(){this.updateFirstState()}.bind(this),1))},CIdentityPropertiesViewModel.prototype.remove=function(){if(!this.identity().loyal()){var e={Action:"AccountIdentityDelete",AccountID:this.identity().accountId(),IdIdentity:this.identity().id()};App.Ajax.send(e,this.onAccountIdentityDeleteResponse,this),this.bCreate||this.oEmailAccountsSettings.onRemoveIdentity()}},CIdentityPropertiesViewModel.prototype.onAccountIdentityDeleteResponse=function(e,t){e.Result||App.Api.showErrorByCode(e,Utils.i18n("SETTINGS/ACCOUNTS_IDENTITY_DELETING_ERROR")),AppData.Accounts.populateIdentities()},CIdentityPropertiesViewModel.prototype.cancel=function(){this.bCreate&&this.oEmailAccountsSettings.cancel()},CIdentityPropertiesViewModel.prototype.getState=function(){return[this.friendlyName(),this.email(),this.useSignature(),this.oHtmlEditor.getNotDefaultText()].join(":")},CIdentityPropertiesViewModel.prototype.updateFirstState=function(){this.firstState=this.getState()},CIdentityPropertiesViewModel.prototype.isChanged=function(){return!!this.firstState&&this.getState()!==this.firstState},CServerPropertiesViewModel.prototype.set=function(e,t,i){this.server(e),this.port(t),this.ssl(i)},CServerPropertiesViewModel.prototype.clear=function(){this.server(""),this.port(this.defaultPort()),this.ssl(!1)},CServerPropertiesViewModel.prototype.getIntPort=function(){return parseInt(this.port(),10)},CServerPropertiesViewModel.prototype.getIntSsl=function(){return this.ssl()?1:0},CCalendarViewModel.prototype.hotKeysBind=function(){var e=this;$(document).on("keyup",function(t){var i=t.keyCode;e.calendars.getEvents().length>0&&"month"===e.selectedView()&&27===i&&e.popUpStatus&&($("body").trigger("click"),e.popUpStatus||$("body").trigger("mousedown"))})},CCalendarViewModel.prototype.getFCObject=function(){return this.$calendarGrid.fullCalendar("getCalendar")},CCalendarViewModel.prototype.getDateFromCurrentView=function(e){var t=this.$calendarGrid.fullCalendar("getView"),i=t&&t[e]?t[e]:null;return i&&"end"===e&&"agendaDay"===t.name&&i.add(1,"d"),i&&i.unix?t[e].unix():0},CCalendarViewModel.prototype.eventsSource=function(e,t,i,s){s(this.calendars.getEvents(e,t))},CCalendarViewModel.prototype.initFullCalendar=function(){this.$calendarGrid.fullCalendar(this.fullcalendarOptions)},CCalendarViewModel.prototype.applyCalendarSettings=function(){this.timeFormat=AppData.User.defaultTimeFormat()===Enums.TimeFormat.F24?"HH:mm":"hh:mm A",this.dateFormat=AppData.User.DefaultDateFormat,this.calendarGridDom().removeClass("fc-show-weekends"),AppData.User.CalendarShowWeekEnds&&this.calendarGridDom().addClass("fc-show-weekends"),this.fullcalendarOptions.timeFormat=this.timeFormat,this.fullcalendarOptions.axisFormat=this.timeFormat,this.fullcalendarOptions.defaultView=this.defaultViewName(),this.fullcalendarOptions.lang=moment.locale(),this.applyFirstDay(),this.$calendarGrid.fullCalendar("destroy"),this.$calendarGrid.fullCalendar(this.fullcalendarOptions),this.changeView(this.defaultViewName())},CCalendarViewModel.prototype.applyFirstDay=function(){var e=[],t="",i="";switch(AppData.Auth&&(this.fullcalendarOptions.firstDay=AppData.User.CalendarWeekStartsOn),_.each(this.aDayNames,function(t){e.push(t)}),AppData.User.CalendarWeekStartsOn){case 1:i=e.shift(),e.push(i);break;case 6:t=e.pop(),e.unshift(t)}this.$datePicker.datepicker("option","firstDay",AppData.User.CalendarWeekStartsOn)},CCalendarViewModel.prototype.initDatePicker=function(){this.$datePicker.datepicker({showOtherMonths:!0,selectOtherMonths:!0,monthNames:Utils.getMonthNamesArray(),dayNamesMin:Utils.i18n("DATETIME/DAY_NAMES_MIN").split(" "),nextText:"",prevText:"",onChangeMonthYear:_.bind(this.changeMonthYearFromDatePicker,this),onSelect:_.bind(this.selectDateFromDatePicker,this),beforeShowDay:_.bind(this.getDayDescription,this)})},CCalendarViewModel.prototype.onApplyBindings=function(){var e=this;this.$calendarGrid=$(this.calendarGridDom()),this.$datePicker=$(this.datePickerDom()),this.isPublic||this.initUploader(),$("body").on("click",function(t){if(e.calendars.getEvents().length>0&&"month"===e.selectedView())if($(t.target).hasClass("fc-more")){var i=$(t.target);$(".fc-more-cell.active").removeClass("active"),$(".fc-row.fc-week.active").removeClass("active"),i.closest(".fc-more-cell").addClass("active"),i.closest(".fc-row.fc-week").addClass("active");var s=$("body").find(".fc-popover.fc-more-popover"),o=i.closest("tr"),n=i.closest(".fc-day-grid"),a=parseInt(o.find(".fc-more-cell.active").index(".fc-more-cell")),r=parseInt(n.find(".fc-row.fc-week.active").index(".fc-row.fc-week"));s.length>0?(e.linkRow=r,e.linkColumn=a,e.popUpStatus=!0):(e.popUpStatus=!1,e.linkRow=0,e.linkColumn=0)}else $(t.target).hasClass("checkmail")||$(t.target).parent().hasClass("checkmail")?t.preventDefault():(e.popUpStatus=!1,e.linkRow=0,e.linkColumn=0)})},CCalendarViewModel.prototype.onShow=function(){this.initialized()||(this.initDatePicker(),this.applyCalendarSettings(),this.highlightWeekInDayPicker(),this.initialized(!0)),App.CalendarCache?(App.CalendarCache.calendarSettingsChanged()||App.CalendarCache.calendarChanged())&&(App.CalendarCache.calendarSettingsChanged()&&this.applyCalendarSettings(),App.CalendarCache.calendarSettingsChanged(!1),App.CalendarCache.calendarChanged(!1),this.getCalendars()):this.isPublic&&this.$calendarGrid.fullCalendar("render"),this.refetchEvents()},CCalendarViewModel.prototype.setTimeline=function(){var e=(this.$calendarGrid.fullCalendar("getView"),new Date),t=new Date(e.getFullYear(),e.getMonth(),e.getDate()),i=new Date(this.todayDate.getFullYear(),this.todayDate.getMonth(),this.todayDate.getDate()),s=null,o=null,n=0,a=0,r=0;i<t&&(this.execCommand("today"),this.todayDate=this.$calendarGrid.fullCalendar("getDate").toDate(),this.$calendarGrid.fullCalendar("render")),s=$(".fc-slats:visible").parent(),o=s.children(".timeline"),0===o.length&&(o=$("<hr>").addClass("timeline"),s.prepend(o)),o.css("left",$("td .fc-axis").width()+10),o.show(),n=60*e.getHours()*60+60*e.getMinutes()+e.getSeconds(),a=n/86400,r=Math.floor(s.height()*a),o.css("top",r+"px")},CCalendarViewModel.prototype.updateAllEvents=function(e){this.calendars.getEvents().length>0&&"month"===this.selectedView()&&(this.loadOnce?this.scrollModel().vertical.set(this.scrollHeight):(this.topPositionToday.valueHasMutated(),this.loadOnce=!0),this.popUpStatus&&$("body").find(".fc-row.fc-week").eq(this.linkRow).find(".fc-more-cell").eq(this.linkColumn).find("a.fc-more").click())},CCalendarViewModel.prototype.viewRenderCallback=function(e,t){var i,s=null,o="01/01/1971 ";this.changeDate(),this.loaded||this.initResizing(),"undefined"!=typeof i&&window.clearInterval(i),i=window.setInterval(_.bind(function(){this.setTimeline()},this),6e4);try{this.setTimeline()}catch(e){}"month"!==e.name&&AppData.User.CalendarShowWorkDay&&$(".fc-slats tr").each(function(){$("tr .fc-time span").each(function(){var e=AppData.User.defaultTimeFormat()===Enums.TimeFormat.F24?$(this).eq(0).text():moment($(this).eq(0).text(),"hh:mm A").format("HH:mm"),t=""!==e?Date.parse(o+e):s,i=Date.parse(o+AppData.User.CalendarWorkDayStarts+":00"),n=Date.parse(o+AppData.User.CalendarWorkDayEnds+":00");s=t,(t<i||t>=n)&&($(this).parent().parent().addClass("fc-non-working-time"),$(this).parent().parent().next().addClass("fc-non-working-time"))})}),this.activateCustomScrollInDayAndWeekView()},CCalendarViewModel.prototype.collectBusyDays=function(){var e=[],t=null,i=null,s=0,o=0;_.each(this.calendars.getEvents(),function(n){for(t=moment(n.start),i=n.end?moment(n.end):null,n.allDay&&i&&i.subtract(1,"days"),s=i?i.diff(t,"days"):0,o=0;o<=s;o++)e.push(t.clone().add(o,"days").toDate())},this),this.busyDays(e)},CCalendarViewModel.prototype.refreshDatePicker=function(){var e=this;_.defer(function(){e.collectBusyDays(),e.$datePicker.datepicker("refresh"),e.highlightWeekInDayPicker()})},CCalendarViewModel.prototype.getDayDescription=function(e){var t=!0,i=_.find(this.busyDays(),function(t){return t.getDate()===e.getDate()&&t.getMonth()===e.getMonth()&&t.getYear()===e.getYear()},this),s=i?"day_with_events":"",o="";return[t,s,o]},CCalendarViewModel.prototype.initResizing=function(){var e=_.throttle(_.bind(this.resize,this),50);$(window).bind("resize",function(t){(t.target===this||App.browser.ie8AndBelow)&&e()}),e()},CCalendarViewModel.prototype.resize=function(){var e=this.$calendarGrid.parent();e&&this.$calendarGrid.fullCalendar("option","height",e.height()),this.dayNamesResize()},CCalendarViewModel.prototype.dayNamesResize=function(){if("month"===this.selectedView()){var e=$("div.weekday-header-item"),t=$("tr.fc-first td.fc-day"),i=$(t[0]).width(),s=0;if(7===e.length&&7===t.length&&0!==i)for(;s<7;s++)$(e[s]).width(i)}},CCalendarViewModel.prototype.changeMonthYearFromDatePicker=function(e,t,i){if(this.changeFullCalendarDate){var s=this.$calendarGrid.fullCalendar("getDate");s.month(t-1).year(e),this.$calendarGrid.fullCalendar("gotoDate",s)}},CCalendarViewModel.prototype.selectDateFromDatePicker=function(e,t){var i=this.getFCObject().moment(e,"MM/DD/YYYY");this.$calendarGrid.fullCalendar("gotoDate",i),_.defer(_.bind(this.highlightWeekInDayPicker,this))},CCalendarViewModel.prototype.highlightWeekInDayPicker=function(){var e=this.$datePicker.find("td.ui-datepicker-current-day"),t=e.parent(),i=this.$datePicker.find("table.ui-datepicker-calendar"),s=this.$calendarGrid.fullCalendar("getView");switch(s.name){case"agendaDay":i.addClass("highlight_day").removeClass("highlight_week");break;case"agendaWeek":i.removeClass("highlight_day").addClass("highlight_week");break;default:i.removeClass("highlight_day").removeClass("highlight_week")}t.addClass("current_week")},CCalendarViewModel.prototype.changeDateTitle=function(){var e=this.$calendarGrid.fullCalendar("getDate"),t=this.$calendarGrid.fullCalendar("getView"),i=e.format("MMMM YYYY"),s=t.intervalStart,o=t.intervalEnd?t.intervalEnd.add(-1,"days"):null;switch(t.name){case"agendaDay":i=e.format("MMMM D, YYYY");break;case"agendaWeek":s&&o&&(i=s.format("MMMM D, YYYY")+" - "+o.format("MMMM D, YYYY"))}this.dateTitle(i)},CCalendarViewModel.prototype.changeDate=function(){this.changeDateInDatePicker(),this.changeDateTitle(),this.getTimeLimits(),this.getCalendars()},CCalendarViewModel.prototype.changeDateInDatePicker=function(){var e=this.$calendarGrid.fullCalendar("getDate");this.changeFullCalendarDate=!1,this.$datePicker.datepicker("setDate",e.local().toDate()),this.changeFullCalendarDate=!0,this.highlightWeekInDayPicker()},CCalendarViewModel.prototype.activateCustomScrollInDayAndWeekView=function(){if(!bMobileDevice){var e=this.$calendarGrid.fullCalendar("getView"),t="month"===e.name?"day":"time",i=$(".fc-"+t+"-grid-container"),s=$("<div></div>");i.parent().append(s),i.appendTo(s),s.hasClass("scroll-wrap")||(s.attr("data-bind","customScrollbar: {x: false, y: true, top: 0, scrollTo: topPositionToday, oScroll: scrollModel}"),i.css({overflow:"hidden"}).addClass("scroll-inner"),ko.applyBindings(this,s[0])),this.domScrollWrapper=s}},CCalendarViewModel.prototype.execCommand=function(e,t){t?this.$calendarGrid.fullCalendar(e,t):this.$calendarGrid.fullCalendar(e)},CCalendarViewModel.prototype.displayToday=function(){this.execCommand("today")},CCalendarViewModel.prototype.displayPrev=function(){this.execCommand("prev")},CCalendarViewModel.prototype.displayNext=function(){this.execCommand("next")},CCalendarViewModel.prototype.changeView=function(e){this.selectedView(e),"month"===e&&(this.loadOnce=!1),this.$calendarGrid.fullCalendar("changeView",e)},CCalendarViewModel.prototype.setAutoReloadTimer=function(){var e=this;clearTimeout(this.iAutoReloadTimer),AppData.User.AutoCheckMailInterval>0&&(this.iAutoReloadTimer=setTimeout(function(){e.getCalendars()},60*AppData.User.AutoCheckMailInterval*1e3))},CCalendarViewModel.prototype.getTimeLimits=function(){var e=this.getDateFromCurrentView("start"),t=this.getDateFromCurrentView("end");0===this.startDateTime&&0===this.endDateTime?(this.startDateTime=e,this.endDateTime=t,this.needsToReload=!0):e<this.startDateTime&&t>this.endDateTime?(this.startDateTime=e,this.endDateTime=t,this.needsToReload=!0):e<this.startDateTime?(t=this.startDateTime,this.startDateTime=e,this.needsToReload=!0):t>this.endDateTime&&(e=this.endDateTime,this.endDateTime=t,this.needsToReload=!0)},CCalendarViewModel.prototype.getCalendars=function(){this.checkStarted(!0),this.setCalendarGridVisibility(),App.Ajax.sendExt({Action:"CalendarList",IsPublic:this.isPublic?1:0,PublicCalendarId:this.publicCalendarId},this.onCalendarsResponse,this)},CCalendarViewModel.prototype.onCalendarsResponse=function(e,t){var i=[],s=[],o=null,n=null;this.loadOnce&&"month"===this.selectedView()?this.scrollHeight=this.scrollModel().vertical.get():this.scrollHeight=0,e.Result?(this.loaded=!0,_.each(e.Result,function(e){o=this.calendars.parseCalendar(e),i.push(o.id),n=this.calendars.getCalendarById(o.id),
(this.needsToReload||(n&&n.cTag)!==(o&&o.cTag))&&(o=this.calendars.parseAndAddCalendar(e),o&&(this.isPublic&&(App.setTitle(o.name()),this.publicCalendarName(o.name())),s.push(o.id)))},this),0===this.calendars.count()&&this.isPublic&&this.needsToReload&&(App.setTitle(Utils.i18n("CALENDAR/NO_CALENDAR_FOUND")),App.Api.showErrorByCode(0,Utils.i18n("CALENDAR/NO_CALENDAR_FOUND"))),this.needsToReload=!1,this.calendars.expunge(i),_.each(i,function(e){o=this.calendars.getCalendarById(e),o&&o.eventsCount()>0&&o.reloadEvents()},this),this.getEvents(s)):(this.setCalendarGridVisibility(),this.checkStarted(!1))},CCalendarViewModel.prototype.getEvents=function(e){e.length>0?App.Ajax.sendExt({Action:"CalendarEventList",CalendarIds:JSON.stringify(e),Start:this.startDateTime,End:this.endDateTime,IsPublic:this.isPublic?1:0,TimezoneOffset:moment().utcOffset(),Timezone:window.jstz?window.jstz.determine().name():""},this.onEventsResponse,this):(this.setAutoReloadTimer(),this.checkStarted(!1))},CCalendarViewModel.prototype.onEventsResponse=function(e,t){var i=null,s=t.CalendarIds?JSON.parse(t.CalendarIds):[],o=[];e.Result&&(_.each(e.Result,function(e){if(i=this.calendars.getCalendarById(e.calendarId)){o.push(e.id);var t=i.eventExists(e.id);Utils.isUnd(t)?i.addEvent(e):t.lastModified!==e.lastModified&&i.updateEvent(e)}},this),_.each(s,function(e){i=this.calendars.getCalendarById(e),i&&i.eventsCount()>0&&i.active()&&i.expungeEvents(o,this.startDateTime,this.endDateTime)},this),this.refreshView()),this.setAutoReloadTimer(),this.checkStarted(!1)},CCalendarViewModel.prototype.setCalendarGridVisibility=function(){this.$calendarGrid.css("visibility","").find(".fc-view div").first().css("visibility","")},CCalendarViewModel.prototype.getUnusedColor=function(){var e=_.difference(this.colors,this.calendars.getColors());return e.length>0?e[0]:this.colors[0]},CCalendarViewModel.prototype.openCreateCalendarForm=function(){if(!this.isPublic){var e=new CCalendarModel;e.color(this.getUnusedColor()),App.Screens.showPopup(CalendarPopup,[_.bind(this.createCalendar,this),this.colors,e])}},CCalendarViewModel.prototype.createCalendar=function(e,t,i){this.isPublic||App.Ajax.send({Name:e,Description:t,Color:i,Action:"CalendarCreate"},this.onCalendarCreateResponse,this)},CCalendarViewModel.prototype.onCalendarCreateResponse=function(e,t){e.Result&&this.calendars.parseAndAddCalendar(e.Result)},CCalendarViewModel.prototype.openImportCalendarForm=function(e){this.isPublic||App.Screens.showPopup(CalendarImportPopup,[_.bind(this.getCalendars,this),e])},CCalendarViewModel.prototype.openUpdateCalendarForm=function(e){this.isPublic||App.Screens.showPopup(CalendarPopup,[_.bind(this.updateCalendar,this),this.colors,e])},CCalendarViewModel.prototype.updateCalendar=function(e,t,i,s){this.isPublic||App.Ajax.send({Name:e,Description:t,Color:i,Id:s,Action:"CalendarUpdate"},this.onCalendarUpdateResponse,this)},CCalendarViewModel.prototype.onCalendarUpdateResponse=function(e,t){var i=null;e.Result&&(i=this.calendars.getCalendarById(t.Id),i&&(i.name(t.Name),i.description(t.Description),i.color(t.Color),this.refetchEvents()))},CCalendarViewModel.prototype.updateCalendarColor=function(e,t){this.isPublic||App.Ajax.send({Color:e,Id:t,Action:"CalendarUpdateColor"},this.onCalendarUpdateColorResponse,this)},CCalendarViewModel.prototype.onCalendarUpdateColorResponse=function(e,t){if(e.Result){var i=this.calendars.getCalendarById(t.Id);i&&(i.color(t.Color),this.refetchEvents())}},CCalendarViewModel.prototype.openGetLinkCalendarForm=function(e){this.isPublic||App.Screens.showPopup(CalendarGetLinkPopup,[_.bind(this.publicCalendar,this),e])},CCalendarViewModel.prototype.openShareCalendarForm=function(e){this.isPublic||App.Screens.showPopup(CalendarSharePopup,[_.bind(this.shareCalendar,this),e])},CCalendarViewModel.prototype.shareCalendar=function(e,t,i,s,o){this.isPublic||App.Ajax.send({Action:"CalendarShareUpdate",Id:e,IsPublic:t?1:0,Shares:JSON.stringify(i),ShareToAll:s?1:0,ShareToAllAccess:o},this.onCalendarShareUpdateResponse,this)},CCalendarViewModel.prototype.onCalendarShareUpdateResponse=function(e,t){if(e.Result){var i=this.calendars.getCalendarById(t.Id);i&&(i.shares(JSON.parse(t.Shares)),1===t.ShareToAll?(i.isShared(!0),i.isSharedToAll(!0),i.sharedToAllAccess=t.ShareToAllAccess):i.isSharedToAll(!1))}},CCalendarViewModel.prototype.publicCalendar=function(e,t){this.isPublic||App.Ajax.send({Action:"CalendarPublicUpdate",Id:e,IsPublic:t?1:0},this.onCalendarPublicUpdateResponse,this)},CCalendarViewModel.prototype.onCalendarPublicUpdateResponse=function(e,t){if(e.Result){var i=this.calendars.getCalendarById(t.Id);i&&i.isPublic(t.IsPublic)}},CCalendarViewModel.prototype.deleteCalendar=function(e,t){var i=this.calendars.getCalendarById(e),s=i?t?Utils.i18n("CALENDAR/CONFIRM_UNSUBSCRIBE_CALENDAR",{CALENDARNAME:i.name()}):Utils.i18n("CALENDAR/CONFIRM_REMOVE_CALENDAR",{CALENDARNAME:i.name()}):"",o=_.bind(function(t){t&&App.Ajax.send({Id:e,Action:"CalendarDelete"},this.onCalendarDeleteResponse,this)},this);!this.isPublic&&i&&App.Screens.showPopup(ConfirmPopup,[s,o])},CCalendarViewModel.prototype.onCalendarDeleteResponse=function(e,t){if(e.Result){var i=this.calendars.getCalendarById(t.Id);i&&!i.isDefault&&(this.calendars.currentCal().id===i.id&&this.calendars.pickCurrentCalendar(),this.calendars.removeCalendar(i.id),this.refetchEvents())}},CCalendarViewModel.prototype.onEventDragStart=function(){this.dragEventTrigger=!0,this.refreshDatePicker()},CCalendarViewModel.prototype.onEventDragStop=function(e){var t=this;this.dragEventTrigger=!1,this.delayOnEventResult&&this.delayOnEventResultData&&0<this.delayOnEventResultData.length?(this.delayOnEventResult=!1,_.each(this.delayOnEventResultData,function(e){t.onEventActionResponse(e[0],e[1],!1)}),this.delayOnEventResultData=[],this.refreshView()):this.refreshDatePicker()},CCalendarViewModel.prototype.onEventResizeStart=function(){this.dragEventTrigger=!0},CCalendarViewModel.prototype.onEventResizeStop=function(){var e=this;this.dragEventTrigger=!1,this.delayOnEventResult&&this.delayOnEventResultData&&0<this.delayOnEventResultData.length?(this.delayOnEventResult=!1,_.each(this.delayOnEventResultData,function(t){e.onEventActionResponse(t[0],t[1],!1)}),this.delayOnEventResultData=[],this.refreshView()):this.refreshDatePicker()},CCalendarViewModel.prototype.createEventInCurrentCalendar=function(){this.calendars.pickCurrentCalendar(),this.createEventToday(this.calendars.currentCal())},CCalendarViewModel.prototype.createEventInCalendar=function(e){this.createEventToday(this.calendars.getCalendarById(e))},CCalendarViewModel.prototype.createEventToday=function(e){var t=this.getFCObject().moment();t.minutes()>30?t.add(60-t.minutes(),"minutes"):t.minutes(30),t.seconds(0).milliseconds(0),this.openEventPopup(e,t,t.clone().add(30,"minutes"),!1)},CCalendarViewModel.prototype.getParamsFromEventData=function(e){return{id:e.id,uid:e.uid,calendarId:e.calendarId,newCalendarId:Utils.isUnd(e.newCalendarId)?e.calendarId:e.newCalendarId,subject:e.subject,allDay:e.allDay?1:0,location:e.location,description:e.description,alarms:e.alarms?JSON.stringify(e.alarms):"[]",attendees:e.attendees?JSON.stringify(e.attendees):"[]",owner:e.owner,recurrenceId:e.recurrenceId,excluded:e.excluded,allEvents:e.allEvents,modified:e.modified?1:0,start:e.start.local().toDate(),end:e.end.local().toDate(),startTS:e.start.unix(),endTS:e.end?e.end.unix():e.end.unix(),rrule:e.rrule?JSON.stringify(e.rrule):null,attachments:e.attachments?JSON.stringify(e.attachments):"[]"}},CCalendarViewModel.prototype.getEventDataFromParams=function(e){var t=e;return t.alarms=e.alarms?JSON.parse(e.alarms):[],t.attendees=e.attendees?JSON.parse(e.attendees):[],e.rrule&&(t.rrule=JSON.parse(e.rrule)),t},CCalendarViewModel.prototype.createEventFromGrid=function(e,t){var i=!e.hasTime();this.calendars.pickCurrentCalendar(),this.openEventPopup(this.calendars.currentCal(),e.local(),t.local(),i)},CCalendarViewModel.prototype.openEventPopup=function(e,t,i,s){!this.isPublic&&e&&App.Screens.showPopup(CalendarEventPopup,[{CallbackSave:_.bind(this.createEvent,this),CallbackDelete:_.bind(this.deleteEvent,this),FCMoment:this.getFCObject().moment,Calendars:this.calendars,SelectedCalendar:e?e.id:0,Start:t,End:i,AllDay:s,TimeFormat:this.timeFormat,DateFormat:this.dateFormat,CallbackAttendeeActionDecline:_.bind(this.attendeeActionDecline,this)}])},CCalendarViewModel.prototype.createEvent=function(e){var t=this.getParamsFromEventData(e);this.isPublic||(t.calendarId=e.newCalendarId,t.selectStart=this.getDateFromCurrentView("start"),t.selectEnd=this.getDateFromCurrentView("end"),t.Action="CalendarEventCreate",App.Ajax.send(t,this.onEventActionResponseWithSubThrottle,this))},CCalendarViewModel.prototype.eventClickCallback=function(e){var t=_.bind(function(t){var i={ID:e.id,Uid:e.uid,RecurrenceId:e.recurrenceId,Calendars:this.calendars,SelectedCalendar:e.calendarId,AllDay:e.allDay,Location:e.location,Description:e.description,Subject:e.subject,Alarms:e.alarms,Attendees:e.attendees,RRule:e.rrule?e.rrule:null,Excluded:!!e.excluded&&e.excluded,Owner:e.owner,Appointment:e.appointment,OwnerName:e.ownerName,Attachments:e.attachments,TimeFormat:this.timeFormat,DateFormat:this.dateFormat,AllEvents:t,CallbackSave:_.bind(this.updateEvent,this),CallbackDelete:_.bind(this.deleteEvent,this),CallbackAttendeeActionDecline:_.bind(this.attendeeActionDecline,this)};t!==Enums.CalendarEditRecurrenceEvent.None&&(t===Enums.CalendarEditRecurrenceEvent.AllEvents&&e.rrule?(i.Start=moment.unix(e.rrule.startBase),i.End=moment.unix(e.rrule.endBase)):(i.Start=e.start.clone(),i.Start=i.Start.local(),i.End=e.end.clone(),i.End=i.End.local()),App.Screens.showPopup(CalendarEventPopup,[i]))},this);e.rrule?e.excluded?t(Enums.CalendarEditRecurrenceEvent.OnlyThisInstance):App.Screens.showPopup(CalendarEditRecurrenceEventPopup,[t]):t(Enums.CalendarEditRecurrenceEvent.AllEvents)},CCalendarViewModel.prototype.eventAction=function(e,t,i){var s=this.calendars.getCalendarById(t.calendarId);s.isEditable()?this.isPublic||(i&&(this.revertFunction=i),t.Action=e,App.Ajax.send(t,this.onEventActionResponseWithSubThrottle,this)):i&&i()},CCalendarViewModel.prototype.updateEvent=function(e){var t=this.getParamsFromEventData(e);t.selectStart=this.getDateFromCurrentView("start"),t.selectEnd=this.getDateFromCurrentView("end"),e.modified&&(this.calendars.setDefault(e.newCalendarId),this.eventAction("CalendarEventUpdate",t))},CCalendarViewModel.prototype.moveEvent=function(e,t,i){var s=this.getParamsFromEventData(e);s.selectStart=this.getDateFromCurrentView("start"),s.selectEnd=this.getDateFromCurrentView("end"),this.isPublic||(s.rrule?i(!1):(s.allEvents=Enums.CalendarEditRecurrenceEvent.AllEvents,this.eventAction("CalendarEventUpdate",s,i)))},CCalendarViewModel.prototype.resizeEvent=function(e,t,i){var s=this.getParamsFromEventData(e),o=_.bind(function(e){e!==Enums.CalendarEditRecurrenceEvent.None?(s.allEvents=e,this.eventAction("CalendarEventUpdate",s,i)):i()},this);s.selectStart=this.getDateFromCurrentView("start"),s.selectEnd=this.getDateFromCurrentView("end"),e.rrule?s.excluded?o(Enums.CalendarEditRecurrenceEvent.OnlyThisInstance):App.Screens.showPopup(CalendarEditRecurrenceEventPopup,[o]):o(Enums.CalendarEditRecurrenceEvent.AllEvents)},CCalendarViewModel.prototype.deleteEvent=function(e){this.eventAction("CalendarEventDelete",this.getParamsFromEventData(e))},CCalendarViewModel.prototype.onEventActionResponseWithSubThrottle=function(e,t){this.dragEventTrigger?(this.delayOnEventResult=!0,this.delayOnEventResultData.push([e,t])):this.onEventActionResponse(e,t)},CCalendarViewModel.prototype.onEventActionResponse=function(e,t,i){if(AppData.App.CalendarNotificationEnabled&&e.Result){var s=(e.Result.Events&&e.Result.Events.length)>0?e.Result.Events[0]:null;s&&App.Ajax.send({Action:"CalendarSendEventNotifications",CalendarId:s.calendarId,EventUid:s.uid,Update:"CalendarEventUpdate"===e.Action?"1":"0"})}var o=this.calendars.getCalendarById(t.calendarId),n=null,a=null,r=0;i=!!Utils.isUnd(i)||!!i,e&&e.Result&&!Utils.isUnd(o)?(r=$(".calendar .fc-widget-content .scroll-inner").scrollTop(),"CalendarEventCreate"===t.Action||"CalendarEventUpdate"===t.Action?(a=o.getEvent(t.id),(Utils.isUnd(a)||Utils.isUnd(a.rrule))&&!t.rrule||t.allEvents!==Enums.CalendarEditRecurrenceEvent.AllEvents?o.removeEvent(t.id):o.removeEventByUid(t.uid,!0),t.newCalendarId&&t.newCalendarId!==t.calendarId&&(o=this.calendars.getCalendarById(t.newCalendarId)),_.each(e.Result.Events,function(e){o.addEvent(e)},this),o.cTag=e.Result.CTag,o.active()||o.active(!0),i&&this.refreshView(),this.restoreScroll(r),this.calendars.pickCurrentCalendar(o)):"CalendarEventDelete"===t.Action?(o.cTag=e.Result,t.allEvents===Enums.CalendarEditRecurrenceEvent.OnlyThisInstance?o.removeEvent(t.id):o.removeEventByUid(t.uid),i&&this.refreshView(),this.restoreScroll(r)):"CalendarEventBase"===t.Action&&(n=e.Result,App.Screens.showPopup(CalendarEventPopup,[{CallbackSave:_.bind(this.updateEvent,this),CallbackDelete:_.bind(this.deleteEvent,this),ID:n.id,Uid:n.uid,RecurrenceId:n.recurrenceId,Calendars:this.calendars,SelectedCalendar:n.calendarId,Start:moment(1e3*n.start),End:moment(1e3*n.end),AllDay:n.allDay,Location:n.location,Description:n.description,Subject:n.subject,Alarms:n.alarms,Attendees:n.attendees,RRule:n.rrule?n.rrule:null,Excluded:!!n.excluded&&n.excluded,Owner:n.owner,Appointment:n.appointment,TimeFormat:this.timeFormat,DateFormat:this.dateFormat,AllEvents:Enums.CalendarEditRecurrenceEvent.AllEvents}]))):"CalendarEventUpdate"!==t.Action||e.Result||Enums.Errors.NotDisplayedError!==Utils.pInt(e.ErrorCode)?(App.Api.showErrorByCode(e,Utils.i18n("CALENDAR/ERROR_EVENT_UPDATING")),this.revertFunction&&this.revertFunction()):this.revertFunction=null,this.revertFunction=null},CCalendarViewModel.prototype.attendeeActionDecline=function(e,t){e.removeEvent(t),this.refreshView()},CCalendarViewModel.prototype.refetchEvents=function(){this.$calendarGrid.fullCalendar("refetchEvents")},CCalendarViewModel.prototype.refreshViewSingle=function(){this.refetchEvents(),this.refreshDatePicker()},CCalendarViewModel.prototype.refreshView=function(){},CCalendarViewModel.prototype.initUploader=function(){var e=this;this.uploaderArea()&&(this.oJua=new Jua({action:"?/Upload/Calendars/",name:"jua-uploader",queueSize:2,dragAndDropElement:this.uploaderArea(),disableAjaxUpload:!1,disableFolderDragAndDrop:!1,disableDragAndDrop:!1,disableAutoUploadOnDrop:!0,hidden:{Token:function(){return AppData.Token},AccountID:function(){return AppData.Accounts.currentId()},AdditionalData:function(){return JSON.stringify({CalendarID:e.uploadCalendarId()})}}}),this.oJua.on("onDrop",_.bind(this.onFileDrop,this)).on("onComplete",_.bind(this.onFileUploadComplete,this)).on("onBodyDragEnter",_.bind(this.bDragActive,this,!0)).on("onBodyDragLeave",_.bind(this.bDragActive,this,!1)))},CCalendarViewModel.prototype.onFileDrop=function(e,t,i){var s=_.filter(this.calendars.collection(),function(e){return e.isEditable()});s.length>1?App.Screens.showPopup(CalendarSelectCalendarsPopup,[{CallbackSave:_.bind(this.uploadToSelectedCalendar,this),ProceedUploading:i,Calendars:this.calendars,EditableCalendars:s,DefaultCalendarId:this.defaultCalendarId()}]):this.uploadToSelectedCalendar(this.defaultCalendarId(),i)},CCalendarViewModel.prototype.onFileUploadComplete=function(e,t,i){var s=!t||!i||i.Error||i.Result.Error||!1;s?i.ErrorCode&&i.ErrorCode===Enums.Errors.IncorrectFileExtension?App.Api.showError(Utils.i18n("CALENDAR/ERROR_INCORRECT_FILE_EXTENSION")):App.Api.showError(Utils.i18n("WARNING/ERROR_UPLOAD_FILE")):this.getCalendars()},CCalendarViewModel.prototype.uploadToSelectedCalendar=function(e,t){this.uploadCalendarId(e),this.checkStarted(!0),t()},CCalendarViewModel.prototype.restoreScroll=function(e){this.domScrollWrapper&&this.domScrollWrapper.data("customscroll").vertical.set(e)},CFileStorageViewModel.prototype.__name="CFileStorageViewModel",CFileStorageViewModel.prototype.onApplyBindings=function(e){this.selector.initOnApplyBindings(".items_sub_list .item",".items_sub_list .selected.item",".items_sub_list .item .custom_checkbox",$(".panel.files .items_list",e),$(".panel.files .items_list .files_scroll.scroll-inner",e)),this.initUploader(),this.hotKeysBind()},CFileStorageViewModel.prototype.hotKeysBind=function(){var e=App.Screens.currentScreen()===Enums.Screens.FileStorage;$(document).on("keydown",_.bind(function(t){e&&t&&t.keyCode===Enums.Key.s&&this.selector.useKeyboardKeys()&&!Utils.isTextFieldFocused()&&(t.preventDefault(),this.isSearchFocused(!0))},this))},CFileStorageViewModel.prototype.initUploader=function(){var e=this;this.uploaderButton()&&this.uploaderArea()&&(this.oJua=new Jua({action:"?/Upload/File/",name:"jua-uploader",queueSize:2,clickElement:this.uploaderButton(),hiddenElementsPosition:Utils.isRTL()?"right":"left",dragAndDropElement:this.uploaderArea(),disableAjaxUpload:!!this.isPublic,disableFolderDragAndDrop:!!this.isPublic,disableDragAndDrop:!!this.isPublic,hidden:{Token:function(){return AppData.Token},AccountID:function(){return AppData.Accounts.currentId()},AdditionalData:function(t){return JSON.stringify({Type:e.storageType(),SubPath:t&&!Utils.isUnd(t.Folder)?t.Folder:"",Path:e.dropPath()})}}}),this.oJua.on("onProgress",_.bind(this.onFileUploadProgress,this)).on("onSelect",_.bind(this.onFileUploadSelect,this)).on("onStart",_.bind(this.onFileUploadStart,this)).on("onDrop",_.bind(this.onDrop,this)).on("onComplete",_.bind(this.onFileUploadComplete,this)).on("onBodyDragEnter",_.bind(this.bDragActive,this,!0)).on("onBodyDragLeave",_.bind(this.bDragActive,this,!1)),this.bAllowDragNDrop=this.oJua.isDragAndDropSupported())},CFileStorageViewModel.prototype.onFileUploadSelect=function(e,t){if(AppData.App.FileSizeLimit>0&&t.Size/1048576>AppData.App.FileSizeLimit)return App.Screens.showPopup(AlertPopup,[Utils.i18n("FILESTORAGE/ERROR_SIZE_LIMIT",{SIZE:AppData.App.FileSizeLimit})]),!1;if(""===this.searchPattern()){var i=new CFileModel,s=t.FileName,o=Utils.getFileExtension(s),n=Utils.getFileNameWithoutExtension(s),a=0,r=AppData.Accounts.getDefault();for(""!==o&&(o="."+o);!Utils.isUnd(this.getFileByName(s));)s=n+"_"+a+o,a++;i.onUploadSelectOwn(e,t,s,r.email(),this.path(),this.storageType()),this.uploadingFiles.push(i)}},CFileStorageViewModel.prototype.onFileUploadStart=function(e){var t=this.getUploadFileByUid(e);t&&t.onUploadStart()},CFileStorageViewModel.prototype.onFileUploadProgress=function(e,t,i){if(""===this.searchPattern()){var s=this.getUploadFileByUid(e);s&&s.onUploadProgress(t,i)}},CFileStorageViewModel.prototype.onFileUploadComplete=function(e,t,i){if(""===this.searchPattern()){var s=this.getUploadFileByUid(e);s&&(s.onUploadComplete(e,t,i),this.deleteUploadFileByUid(e),s.uploadError()?(this.uploadError(!0),App.Api.showError(s.statusText())):(this.files.push(s),0===this.uploadingFiles().length&&App.Api.showReport(Utils.i18n("COMPOSE/UPLOAD_COMPLETE")))),this.getFiles(this.storageType(),this.getPathItemByIndex(this.iPathIndex()),this.searchPattern(),!1)}},CFileStorageViewModel.prototype.onDrop=function(e,t){if(!this.isPublic)if(t&&t.target&&""===this.searchPattern()){var i=ko.dataFor(t.target);i&&i instanceof CFileModel&&i.isFolder()&&this.dropPath(i.fullPath())}else App.Api.showReport(Utils.i18n("FILESTORAGE/INFO_CANNOT_UPLOAD_SEARCH_RESULT"))},CFileStorageViewModel.prototype.filesDrop=function(e,t,i){if(!this.isPublic&&e&&t){var s=this,o="",n=!1,a=e.fullPath(),r=[],l=[];(this.path()!==a&&this.storageType()===e.storageType()||this.storageType()!==e.storageType())&&(e.recivedAnim(!0),Utils.uiDropHelperAnim(t,i),r=this.selector.listCheckedAndSelected(),_.each(r,function(e){o=e.path(),n=e.isFolder()&&a===o+"/"+e.id(),n||(t.ctrlKey||(e.isFolder()?s.deleteFolderByName(e.fileName()):s.deleteFileByName(e.id())),l.push({Name:e.id(),IsFolder:e.isFolder()}))}),l.length>0&&App.Ajax.send({Action:t.ctrlKey?"FilesCopy":"FilesMove",FromType:this.storageType(),ToType:e.storageType(),FromPath:o,ToPath:a,Files:JSON.stringify(l)},this.onFilesMoveResponse,this))}},CFileStorageViewModel.prototype.onFilesMoveResponse=function(e,t){this.getQuota(this.storageType())},CFileStorageViewModel.prototype.dragAndDropHelper=function(e){e&&e.checked(!0);var t=Utils.draggableMessages(),i=this.selector.listCheckedAndSelected(),s=i.length,o=0,n=0,a="";return _.each(i,function(e){e.isFolder()?n++:o++},this),0!==o&&0!==n?a=Utils.i18n("FILESTORAGE/DRAG_ITEMS_TEXT_PLURAL",{COUNT:s},null,s):0===o?a=Utils.i18n("FILESTORAGE/DRAG_FOLDERS_TEXT_PLURAL",{COUNT:n},null,n):0===n&&(a=Utils.i18n("FILESTORAGE/DRAG_TEXT_PLURAL",{COUNT:o},null,o)),$(".count-text",t).text(a),t},CFileStorageViewModel.prototype.onItemDelete=function(){this.executeDelete()},CFileStorageViewModel.prototype.onEnter=function(e){this.onItemDblClick(e)},CFileStorageViewModel.prototype.onItemDblClick=function(e){e&&(e.isFolder()?this.getFiles(this.storageType(),e):e.isViewable()?e.viewFile():this.isPopup?this.onSelectClickPopupBinded&&this.onSelectClickPopupBinded():e.downloadFile())},CFileStorageViewModel.prototype.onFilesResponse=function(e,t){if(e.Result){var i=[],s=[],o=Date.now().toString();e.Result.Quota&&(this.quota(e.Result.Quota[0]+e.Result.Quota[1]),this.used(e.Result.Quota[0])),_.each(e.Result.Items,function(e){var t=(new CFileModel).allowDrag(!0).allowSelect(!0).allowCheck(!0).allowDelete(!0).allowUpload(!0).allowSharing(!0).allowHeader(!0).allowDownload(!0).isPopupItem(this.isPopup);t.parse(e,this.publicHash),t.getInThumbQueue(o),t.isFolder()?i.push(t):s.push(t)},this),(this.isPublic||t.Type===this.storageType())&&(this.folders(i),this.files(s)),this.loading(!1),this.loadedFiles(!0),clearTimeout(this.timerId)}else this.loading(!1),this.error(!0)},CFileStorageViewModel.prototype.onQuotaResponse=function(e,t){e.Result&&e.Result.Quota&&(this.quota(e.Result.Quota[0]+e.Result.Quota[1]),this.used(e.Result.Quota[0]))},CFileStorageViewModel.prototype.onFilesDeleteResponse=function(e,t){e.Result?this.expungeFileItems():this.getFiles(this.storageType(),this.getPathItemByIndex(this.iPathIndex()),this.searchPattern())},CFileStorageViewModel.prototype.executeRename=function(){var e=this.selector.listCheckedAndSelected();!this.isPublic&&e[0]&&App.Screens.showPopup(FileStorageRenamePopup,[e[0],_.bind(this.renameItem,this)])},CFileStorageViewModel.prototype.executeDownload=function(){var e=this.selector.listCheckedAndSelected();e[0]&&!e[0].isFolder()&&e[0].downloadFile()},CFileStorageViewModel.prototype.executeShare=function(){var e=this.selector.listCheckedAndSelected();!this.isPublic&&e[0]&&App.Screens.showPopup(FileStorageSharePopup,[e[0]])},CFileStorageViewModel.prototype.executeSend=function(){var e=this.selector.listCheckedAndSelected(),t=_.filter(e,function(e){return!e.isFolder()},this);t.length>0&&App.Api.composeMessageWithFiles(t)},CFileStorageViewModel.prototype.onShareIconClick=function(e){e&&App.Screens.showPopup(FileStorageSharePopup,[e])},CFileStorageViewModel.prototype.renameItem=function(e){var t=Utils.trim(e.nameForEdit());return Utils.validateFileOrFolderName(t)?(App.Ajax.send({Action:"FilesRename",Type:this.storageType(),Path:e.path(),Name:e.id(),NewName:t,IsLink:e.isLink()?1:0},this.onFilesRenameResponse,this),""):e.isFolder()?Utils.i18n("FILESTORAGE/INVALID_FOLDER_NAME"):Utils.i18n("FILESTORAGE/INVALID_FILE_NAME")},CFileStorageViewModel.prototype.onFilesRenameResponse=function(e,t){this.getFiles(this.storageType(),this.getPathItemByIndex(this.iPathIndex()),this.searchPattern())},CFileStorageViewModel.prototype.executeDelete=function(){var e=this.selector.listCheckedAndSelected();!this.isPublic&&e&&e.length>0&&App.Screens.showPopup(ConfirmPopup,[Utils.i18n("FILESTORAGE/CONFIRMATION_DELETE"),_.bind(this.deleteItems,this,e)])},CFileStorageViewModel.prototype.onShow=function(){this.loaded(!0),this.getStorages(),this.selector.useKeyboardKeys(!0),this.oJua&&this.oJua.setDragAndDropEnabledStatus(!0)},CFileStorageViewModel.prototype.onHide=function(){this.selector.useKeyboardKeys(!1),this.oJua&&this.oJua.setDragAndDropEnabledStatus(!1)},CFileStorageViewModel.prototype.getQuota=function(e){App.Ajax.send({Action:"FilesQuota",Type:e},this.onQuotaResponse,this)},CFileStorageViewModel.prototype.getStorageByType=function(e){return _.find(this.storages(),function(t){return t.storageType()===e})},CFileStorageViewModel.prototype.getStorages=function(){this.isPublic?this.getFiles(this.storageType(),this.getPathItemByIndex(this.iPathIndex())):(this.getStorageByType("personal")||this.storages.push((new CFileModel).isFolder(!0).storageType("personal").displayName(Utils.i18n("FILESTORAGE/TAB_PERSONAL_FILES"))),this.IsCollaborationSupported&&(this.getStorageByType("corporate")||this.storages.push((new CFileModel).isFolder(!0).storageType("corporate").displayName(Utils.i18n("FILESTORAGE/TAB_CORPORATE_FILES"))),this.AllowFilesSharing&&(this.getStorageByType("shared")||this.storages.push((new CFileModel).isFolder(!0).storageType("shared").displayName(Utils.i18n("FILESTORAGE/TAB_SHARED_FILES"))))),this.isPopup?this.getFiles(this.storageType(),this.getPathItemByIndex(this.iPathIndex())):this.getExternalFileStorages())},CFileStorageViewModel.prototype.getExternalFileStorages=function(){App.Ajax.send({Action:"FileStoragesExternal"},this.onExternalStoragesResponse,this)},CFileStorageViewModel.prototype.onExternalStoragesResponse=function(e,t){e.Result&&(_.each(e.Result,function(e){this.getStorageByType(e.Type)||this.storages.push((new CFileModel).isExternal(!0).isFolder(!0).storageType(e.Type).displayName(e.DisplayName))},this),this.expungeExternalStorages(_.map(e.Result,function(e){return e.Type},this))),this.getStorageByType(this.storageType())||(this.storageType("personal"),this.pathItems([]),this.iPathIndex(-1)),this.getFiles(this.storageType(),this.getPathItemByIndex(this.iPathIndex()))},CFileStorageViewModel.prototype.getFiles=function(e,t,i,s){var o=this,n=this.storageType(),a=this.iPathIndex(),r=(new CFileModel).isFolder(!0).storageType(e);return this.isPublic?this.getFilesPub(t):(this.error(!1),this.storageType(e),o.loadedFiles(!1),(Utils.isUnd(s)||!Utils.isUnd(s)&&s)&&(this.timerId=setTimeout(function(){o.loadedFiles()||o.error()||(o.folders([]),o.files([]),o.loading(!0))},1500)),this.searchPattern(Utils.isUnd(i)?"":Utils.pString(i)),Utils.isUnd(t)||""===t.id()?(this.pathItems.removeAll(),r.displayName(this.rootPath())):r=t,this.pathItems.push(r),this.iPathIndex(this.pathItems().length-1),a===this.iPathIndex()&&n===this.storageType()||(this.folders([]),this.files([])),void App.Ajax.sendExt({Action:"Files",Type:e,Path:this.path(),Pattern:this.searchPattern()},this.onFilesResponse,this))},CFileStorageViewModel.prototype.getFilesPub=function(e){var t=this.iPathIndex(),i=(new CFileModel).isFolder(!0);Utils.isUnd(e)||""===e.id()?(this.pathItems.removeAll(),i.displayName(this.rootPath())):i=e,this.pathItems.push(i),this.iPathIndex(this.pathItems().length-1),t!==this.iPathIndex()&&(this.folders([]),this.files([])),App.Ajax.sendExt({Action:"FilesPub",Hash:AppData.FileStoragePubHash,Path:this.path()},this.onFilesResponse,this)},CFileStorageViewModel.prototype.deleteItems=function(e,t){if(t&&0<e.length){var i=_.map(e,function(e){return e.deleted(!0),{Path:e.path(),Name:e.id()}});App.Ajax.send({Action:"FilesDelete",Type:this.storageType(),Path:this.path(),Items:JSON.stringify(i)},this.onFilesDeleteResponse,this)}},CFileStorageViewModel.prototype.getPathItemByIndex=function(e){var t=this.pathItems()[e],i=(new CFileModel).fileName(this.rootPath()).id("");return this.pathItems(this.pathItems().slice(0,e)),t&&!this.isPublic&&(i=t),i},CFileStorageViewModel.prototype.getFullPathByIndex=function(e){var t=_.map(this.pathItems().slice(0,e),function(e){return e.fileName()});return t.join("/")},CFileStorageViewModel.prototype.getFileByName=function(e){return _.find(this.files(),function(t){return t.id()===e})},CFileStorageViewModel.prototype.deleteFileByName=function(e){this.files(_.filter(this.files(),function(t){return t.id()!==e}))},CFileStorageViewModel.prototype.deleteFolderByName=function(e){this.folders(_.filter(this.folders(),function(t){return t.fileName()!==e}))},CFileStorageViewModel.prototype.expungeFileItems=function(){this.folders(_.filter(this.folders(),function(e){return!e.deleted()},this)),this.files(_.filter(this.files(),function(e){return!e.deleted()},this))},CFileStorageViewModel.prototype.expungeExternalStorages=function(e){this.storages(_.filter(this.storages(),function(t){return!t.isExternal()||_.include(e,t.storageType())},this))},CFileStorageViewModel.prototype.deleteStorageByType=function(e){this.storages(_.filter(this.storages(),function(t){return t.storageType()!==e}))},CFileStorageViewModel.prototype.getUploadFileByUid=function(e){return _.find(this.uploadingFiles(),function(t){return t.uploadUid()===e})},CFileStorageViewModel.prototype.deleteUploadFileByUid=function(e){this.uploadingFiles(_.filter(this.uploadingFiles(),function(t){return t.uploadUid()!==e}))},CFileStorageViewModel.prototype.getUploadingFiles=function(){var e=[],t=this.uploadingFiles(),i=this;return Utils.isUnd(t)||(e=_.filter(t,function(e){return e.path()===i.path()&&e.storageType()===i.storageType()})),e},CFileStorageViewModel.prototype.onCancelUpload=function(e){this.oJua&&this.oJua.cancel(e),this.deleteUploadFileByUid(e)},CFileStorageViewModel.prototype.onCreateFolderResponse=function(e,t){this.getFiles(this.storageType(),this.getPathItemByIndex(this.iPathIndex()))},CFileStorageViewModel.prototype.createFolder=function(e){return e=Utils.trim(e),Utils.validateFileOrFolderName(e)?(App.Ajax.send({Action:"FilesFolderCreate",Type:this.storageType(),Path:this.path(),FolderName:e},this.onCreateFolderResponse,this),""):Utils.i18n("FILESTORAGE/INVALID_FOLDER_NAME")},CFileStorageViewModel.prototype.onCreateFolderClick=function(){App.Screens.showPopup(FileStorageFolderCreatePopup,[_.bind(this.createFolder,this)])},CFileStorageViewModel.prototype.onCreateLinkResponse=function(e,t){this.getFiles(this.storageType(),this.getPathItemByIndex(this.iPathIndex()))},CFileStorageViewModel.prototype.createLink=function(e){App.Ajax.send({Action:"FilesLinkCreate",Type:this.storageType(),Path:this.path(),Link:e.linkUrl(),Name:e.fileName()},this.onCreateLinkResponse,this)},CFileStorageViewModel.prototype.onCreateLinkClick=function(){var e=_.bind(this.createLink,this);App.Screens.showPopup(FileStorageLinkCreatePopup,[e])},CFileStorageViewModel.prototype.onSearch=function(){this.getFiles(this.storageType(),this.getPathItemByIndex(this.iPathIndex()),this.searchPattern())},CFileStorageViewModel.prototype.clearSearch=function(){this.getFiles(this.storageType(),this.getPathItemByIndex(this.iPathIndex()))},CHelpdeskViewModel.prototype.initInputosaurus=function(e,t,i,s){e()&&$(e()).length>0&&$(e()).inputosaurus({width:"auto",parseOnBlur:!0,autoCompleteSource:_.bind(function(e,t){this.autocompleteCallback(e.term,t)},this),autoCompleteAppendTo:$(e()).closest("td"),change:_.bind(function(e){i(!0),this.setRecipient(t,e.target.value),i(!1)},this),copy:_.bind(function(e){this.inputosaurusBuffer=e},this),paste:_.bind(function(){var e=this.inputosaurusBuffer||"";return this.inputosaurusBuffer="",e},this),focus:_.bind(this.focusedField,this,s),mobileDevice:bMobileDevice})},CHelpdeskViewModel.prototype.autocompleteCallback=function(e,t){var i={Action:"ContactSuggestions",Search:e};App.Ajax.send(i,function(e){var i=[];e&&e.Result&&e.Result&&e.Result.List&&(i=_.map(e.Result.List,function(e){var t="",i=e.Email;return e.IsGroup?t=e.Name&&0<Utils.trim(e.Name).length?'"'+e.Name+'" ('+e.Email+")":"("+e.Email+")":(t=Utils.Address.getFullEmail(e.Name,e.Email),i=t),{label:t,value:i,frequency:e.Frequency}}),i=_.compact(i)),t(i)},this)},CHelpdeskViewModel.prototype.setRecipient=function(e,t){e()===t?e.valueHasMutated():e(t)},CHelpdeskViewModel.prototype.requestFromLogin=function(){this.bExtApp&&App.Storage.getData("helpdeskQuestion")&&(this.newThreadText(App.Storage.getData("helpdeskQuestion")),App.Storage.removeData("helpdeskQuestion"),
this.executeThreadCreate())},CHelpdeskViewModel.prototype.cleanAll=function(){this.replyText(""),this.replyTextFocus(!1),this.newThreadText(""),this.uploadedFiles([]),this.posts([]),this.internalNote(!1),this.isQuickReplyActive(!1),this.ccbccVisible(!1),this.ccAddr(""),this.bccAddr("")},CHelpdeskViewModel.prototype.onOwnerContactResponse=function(e){e?(this.ownerContact(e),this.ownerExistsInContacts(!0)):(this.ownerContact(new CContactModel),this.ownerExistsInContacts(!1)),this.ownerContactInfoReceived(!0)},CHelpdeskViewModel.prototype.updateOpenerWindow=function(){this.singleMode&&window.opener&&window.opener.App&&window.opener.App.updateHelpdesk()},CHelpdeskViewModel.prototype.deletePost=function(e){e&&e.itsMe()&&App.Screens.showPopup(ConfirmPopup,[Utils.i18n("HELPDESK/CONFIRM_DELETE_THIS_POST"),_.bind(function(t){t&&(this.postForDelete(e),App.Ajax[this.ajaxSendFunc]({Action:"HelpdeskPostDelete",PostId:e.Id,ThreadId:e.IdThread,IsExt:this.bExtApp?1:0},this.onHelpdeskPostDeleteResponse,this))},this)])},CHelpdeskViewModel.prototype.onHelpdeskPostDeleteResponse=function(e,t){e.Result===!1?App.Api.showErrorByCode(e,Utils.i18n("HELPDESK/ERROR_COULDNT_DELETE_POST")):(this.posts.remove(this.postForDelete()),App.Api.showReport(Utils.i18n("HELPDESK/REPORT_POST_HAS_BEEN_DELETED"))),this.requestPosts(),this.updateOpenerWindow()},CHelpdeskViewModel.prototype.addToContacts=function(){this.selectedItem()&&App.ContactsCache.addToContacts("",this.selectedItem().sEmail,this.onAddToContactsResponse,this)},CHelpdeskViewModel.prototype.iHaveMoreToSay=function(){this.isQuickReplyHidden(!1),_.delay(_.bind(function(){this.replyTextFocus(!0)},this),300)},CHelpdeskViewModel.prototype.onAddToContactsResponse=function(e,t){e.Result&&this.selectedItem()&&""!==t.HomeEmail&&t.HomeEmail===this.selectedItem().sEmail&&(App.Api.showReport(Utils.i18n("CONTACTS/REPORT_CONTACT_SUCCESSFULLY_ADDED")),App.ContactsCache.clearInfoAboutEmail(this.selectedItem().sEmail),App.ContactsCache.getContactsByEmails([this.selectedItem().sEmail],this.onOwnerContactResponse,this))},CHelpdeskViewModel.prototype.scrollPostsToBottom=function(){this.scrollToBottomTrigger(!this.scrollToBottomTrigger())},CHelpdeskViewModel.prototype.scrollPostsToTop=function(){this.scrollToTopTrigger(!this.scrollToTopTrigger())},CHelpdeskViewModel.prototype.showClientDetails=function(){this.clientDetailsVisible(!0)},CHelpdeskViewModel.prototype.hideClientDetails=function(){this.clientDetailsVisible(!1)},CHelpdeskViewModel.prototype.startAutocheckmail=function(){var e=this,t=AppData&&AppData.User?AppData.User.AutoCheckMailInterval:1;0<t&&(clearTimeout(this.iAutoCheckTimer),this.iAutoCheckTimer=setTimeout(function(){e.checkCommand()},60*t*1e3))},CHelpdeskViewModel.prototype.onApplyBindings=function(e){this.selector.initOnApplyBindings(".items_sub_list .item",".items_sub_list .selected.item",".items_sub_list .item .custom_checkbox",$(".items_list",e),$(".threads_scroll.scroll-inner",e)),this.initUploader(),$(this.domQuickReply()).on("click",_.bind(function(e){this.preventFalseClick(!0)},this)),$(document.body).on("click",_.bind(function(e){App.Screens.currentScreen()===Enums.Screens.Helpdesk&&this.isQuickReplyPaneEmpty()&&!this.preventFalseClick()&&(this.replyText(""),this.isQuickReplyActive(!1))},this)),App.registerHelpdeskUpdateFunction&&App.registerHelpdeskUpdateFunction(_.bind(this.checkCommand,this)),this.startAutocheckmail()},CHelpdeskViewModel.prototype.onShow=function(){this.newThreadButtonWidth.notifySubscribers(),this.selector.useKeyboardKeys(!0),this.oPageSwitcher.show(),this.oPageSwitcher.perPage(this.ThreadsPerPage),this.oPageSwitcher.currentPage(1),this.requestThreadsList()},CHelpdeskViewModel.prototype.onHide=function(){this.selector.useKeyboardKeys(!1),this.oPageSwitcher.hide()},CHelpdeskViewModel.prototype.requestThreadsList=function(){this.newThreadCreating()||(this.loadingList(!0),this.checkStarted(!0),App.Ajax[this.ajaxSendFunc]({Action:"HelpdeskThreadsList",IsExt:this.bExtApp?1:0,Offset:(this.oPageSwitcher.currentPage()-1)*this.ThreadsPerPage,Limit:this.ThreadsPerPage,Filter:this.listFilter(),Search:this.search()},this.onHelpdeskThreadsListResponse,this),this.requestThreadsPendingCount())},CHelpdeskViewModel.prototype.requestThreadByIdOrHash=function(e,t){App.Ajax[this.ajaxSendFunc]({Action:"HelpdeskThreadByIdOrHash",IsExt:this.bExtApp?1:0,ThreadId:e?e:0,ThreadHash:t?t:""},this.onThreadByIdOrHashResponse,this)},CHelpdeskViewModel.prototype.requestThreadsPendingCount=function(){App.Ajax[this.ajaxSendFunc]({Action:"HelpdeskThreadsPendingCount",IsExt:this.bExtApp?1:0},this.onHelpdeskThreadsPendingCountResponse,this)},CHelpdeskViewModel.prototype.onHelpdeskThreadsListResponse=function(e,t){var i=0,s=0,o=this.selectedItem(),n=o?Utils.pString(o.Id):"",a=[],r=null,l=null,h=e.Result&&_.isArray(e.Result.List)?e.Result.List:[];if(this.checkStarted(!1),e.Result===!1)App.Api.showErrorByCode(e);else{for(s=h.length;i<s;i++)h[i]&&"Object/CHelpdeskThread"===Utils.pExport(h[i],"@Object","")&&(r=new CThreadListModel,r.parse(h[i]),r.OwnerIsMe=Utils.pString(r.IdOwner),n===Utils.pString(r.Id)&&(o.postsCount(r.postsCount()),r.selected(!0),this.selector.itemSelected(r)),a.push(r));if(this.loadingList(!1),this.newThreadId()){var c=this.newThreadId();this.onItemSelect(_.find(this.threads().concat(a),function(e){return e.ItsMe&&e.Id===c})),this.newThreadId(null)}this.threads(a),this.setUnseenCount(),this.oPageSwitcher.setCount(Utils.pInt(e.Result.ItemsCount)),AppData.HelpdeskThreadId&&(l=_.find(a,function(e){return e.Id===AppData.HelpdeskThreadId},this),l?this.onItemSelect(l):a.length&&this.requestThreadByIdOrHash(AppData.HelpdeskThreadId)),AppData.HelpdeskThreadAction&&("add"===AppData.HelpdeskThreadAction?this.iHaveMoreToSay():"close"===AppData.HelpdeskThreadAction&&this.closeCommand())}},CHelpdeskViewModel.prototype.onHelpdeskThreadsPendingCountResponse=function(e,t){e.Result===!1?App.Api.showErrorByCode(e):App.helpdeskPendingCount(e.Result)},CHelpdeskViewModel.prototype.requestPosts=function(e,t){var i=this.selectedItem(),s=e?e.Id:i?i.Id:0,o=t?t:0,n={};s&&(n={Action:"HelpdeskThreadPosts",IsExt:this.bExtApp?1:0,ThreadId:s,StartFromId:o,Limit:5},o&&this.loadingMoreMessages(!0),App.Ajax[this.ajaxSendFunc](n,this.onHelpdeskThreadPostsResponse,this))},CHelpdeskViewModel.prototype.onHelpdeskThreadPostsResponse=function(e,t){var i=this,s=0,o=0,n=[],a=[],r=null,l=e.Result&&_.isArray(e.Result.List)?e.Result.List:[];if(e.Result===!1)App.Api.showErrorByCode(e);else if(this.selectedItem()&&e.Result.ThreadId===this.selectedItem().Id){for(this.selectedItem().postsCount(Utils.pInt(e.Result.ItemsCount)),o=l.length;s<o;s++)l[s]&&"Object/CHelpdeskPost"===Utils.pExport(l[s],"@Object","")&&(r=new CPostModel,r.parse(l[s]),n.push(r));a=this.posts(),e.Result.StartFromId?(_.each(n,function(e,t){this.posts.unshift(e)},this),this.loadingMoreMessages(!1)):0!==a.length&&a[a.length-1].Id===n[0].Id||(0!==a.length?_.each(n.reverse(),function(e,t){_.find(a,function(t){return t.Id===e.Id})||this.posts.push(e)},this):this.posts(n.reverse()),_.delay(function(){i.scrollPostsToBottom()},100)),this.selectedItem().unseen()&&this.executeThreadSeen(this.selectedItem().Id)}},CHelpdeskViewModel.prototype.onRoute=function(e){var t=e[0],i=_.find(this.threads(),function(e){return e.ThreadHash===t});i?(i=i,this.onItemSelect(i)):0===this.threads().length&&this.loadingList()&&void 0===this.threadSubscription&&!AppData.SingleMode?this.threadSubscription=this.threads.subscribe(function(){this.onRoute(e),this.threadSubscription.dispose(),this.threadSubscription=void 0},this):t?this.requestThreadByIdOrHash(null,t):(this.selectedItem(null),this.selector.itemSelected(null))},CHelpdeskViewModel.prototype.onThreadByIdOrHashResponse=function(e,t){var i=new CThreadListModel;e.Result&&(i.parse(e.Result),i.OwnerIsMe=Utils.pString(i.IdOwner),this.onItemSelect(i))},CHelpdeskViewModel.prototype.onItemSelect=function(e){this.previousSelectedItem(this.selectedItem()),this.selectedItem()&&(!e||this.selectedItem().ThreadHash===e.ThreadHash&&this.selectedItem().Id===e.Id)||(this.replySendingStarted()||this.isQuickReplyPaneEmpty()&&this.isNewThreadPaneEmpty()?this.selectItem(e):App.Screens.showPopup(ConfirmPopup,[Utils.i18n("HELPDESK/CONFIRM_CANCEL_REPLY"),_.bind(function(t){t?this.selectItem(e):(this.replyTextFocus(!0),this.isQuickReplyHidden(!1),this.selector.itemSelected(this.previousSelectedItem()))},this)]))},CHelpdeskViewModel.prototype.onItemDelete=function(){this.executeDelete()},CHelpdeskViewModel.prototype.selectItem=function(e){this.visibleNewThread(!1),this.selector.listCheckedAndSelected(!1),this.cleanAll(),e&&(this.selector.itemSelected(e),this.selectedItem(e),this.isQuickReplyHidden(e.ItsMe||!this.bAgent),this.requestPosts(e),this.singleMode||App.Routing.setHash([Enums.Screens.Helpdesk,e.ThreadHash]),e.postsCount(0),this.posts([]))},CHelpdeskViewModel.prototype.openNewThread=function(){this.selector.itemSelected(null),this.selectedItem(null),this.visibleNewThread(!0),App.Routing.setHash([Enums.Screens.Helpdesk,""]),this.newThreadTextFocus(!0),this.setSignature(this.newThreadText,this.domNewThreadTextarea())},CHelpdeskViewModel.prototype.cancelNewThread=function(){this.onItemSelect(this.previousSelectedItem())},CHelpdeskViewModel.prototype.isEnableListActions=function(){return!!this.selectedItem()},CHelpdeskViewModel.prototype.executeDelete=function(){var e=this,t=this.selectedItem();t&&(_.each(this.threads(),function(e){e===t&&e.deleted(!0)}),_.delay(function(){e.threads.remove(function(e){return e.deleted()})},500),this.selectedItem(null),App.Ajax[this.ajaxSendFunc]({Action:"HelpdeskThreadDelete",IsExt:this.bExtApp?1:0,ThreadId:t.Id},this.onHelpdeskThreadDeleteResponse,this),App.Routing.setHash([Enums.Screens.Helpdesk,""]))},CHelpdeskViewModel.prototype.executeOpenNewWindow=function(){var e=App.Routing.buildHashFromArray([Enums.Screens.SingleHelpdesk,this.selectedItem().ThreadHash]);Utils.WindowOpener.openTab(e)},CHelpdeskViewModel.prototype.onHelpdeskThreadDeleteResponse=function(e,t){this.requestThreadsList(),this.updateOpenerWindow()},CHelpdeskViewModel.prototype.executeChangeState=function(e){var t=this.selectedItem();void 0!==e&&t&&(t.state(e),App.Ajax[this.ajaxSendFunc]({Action:"HelpdeskThreadChangeState",IsExt:this.bExtApp?1:0,ThreadId:t.Id,Type:t.state()},this.onHelpdeskThreadChangeStateResponse,this))},CHelpdeskViewModel.prototype.onHelpdeskThreadChangeStateResponse=function(e,t){this.requestThreadsList(),this.updateOpenerWindow()},CHelpdeskViewModel.prototype.executeThreadPing=function(e){void 0!==e&&App.Ajax[this.ajaxSendFunc]({Action:"HelpdeskThreadPing",IsExt:this.bExtApp?1:0,ThreadId:e},this.onThreadPingResponse,this)},CHelpdeskViewModel.prototype.onThreadPingResponse=function(e,t){this.watchers(_.map(e.Result,function(e){var t=e.length>0?e[0].replace(/"/g,""):"",i=e.length>0?e[1]:"",s={name:t,email:i,text:i,initial:i.substr(0,2),icon:""};return i.length>0&&t.length>0?(s.text='"'+t+'" <'+i+">",/\s/g.test(t)?s.initial=this.getInitials(t):s.initial=t.substr(0,2)):i.length>0?(s.text=i,s.initial=i.substr(0,2)):t.length>0&&(s.text=t,s.initial=this.getInitials(t)),s},this))},CHelpdeskViewModel.prototype.getInitials=function(e){return _.reduce(e.split(" ",2),function(e,t){return e+t.substr(0,1)},"")},CHelpdeskViewModel.prototype.executeThreadSeen=function(e){void 0!==e&&App.Ajax[this.ajaxSendFunc]({Action:"HelpdeskThreadSeen",IsExt:this.bExtApp?1:0,ThreadId:e},this.onHelpdeskThreadSeenResponse,this)},CHelpdeskViewModel.prototype.onHelpdeskThreadSeenResponse=function(e,t){e.Result&&this.selectedItem()&&(this.selectedItem().unseen(!1),this.setUnseenCount()),this.updateOpenerWindow()},CHelpdeskViewModel.prototype.executeThreadCreate=function(){var e=Utils.trim(this.newThreadText().replace(/[\n\r]/," ")),t=e.indexOf(" ",40);t>=0&&(e=e.substring(0,t)),this.newThreadCreating(!0),this.sendHelpdeskPostCreate(0,e,this.newThreadText(),this.onThreadCreateResponse)},CHelpdeskViewModel.prototype.onThreadCreateResponse=function(e,t){this.newThreadCreating(!1),e.Result&&t&&(App.Api.showReport(Utils.i18n("HELPDESK/REPORT_THREAD_SUCCESSFULLY_CREATED")),e.Result.ThreadIsNew&&this.newThreadId(e.Result.ThreadId),this.cleanAll(),this.visibleNewThread(!1)),this.requestThreadsList(),this.updateOpenerWindow()},CHelpdeskViewModel.prototype.executePostCreate=function(){this.selectedItem()&&(this.replySendingStarted(!0),this.sendHelpdeskPostCreate(this.selectedItem().Id,"",this.replyText(),this.onPostCreateResponse))},CHelpdeskViewModel.prototype.onPostCreateResponse=function(e,t){this.replySendingStarted(!1),e.Result&&t&&(App.Api.showReport(Utils.i18n("HELPDESK/REPORT_POST_SUCCESSFULLY_ADDED")),this.cleanAll(),this.requestPosts()),this.requestThreadsList(),this.updateOpenerWindow()},CHelpdeskViewModel.prototype.sendHelpdeskPostCreate=function(e,t,i,s){var o={},n={};_.each(this.uploadedFiles(),function(e){o[e.tempName()]=e.hash()}),n={Action:"HelpdeskPostCreate",IsExt:this.bExtApp?1:0,ThreadId:e,IsInternal:this.internalNote()?1:0,Subject:t,Text:i,Cc:this.ccAddr(),Bcc:this.bccAddr(),Attachments:o},App.Ajax[this.ajaxSendFunc](n,s,this)},CHelpdeskViewModel.prototype.onShowThreadsByOwner=function(){this.search("owner:"+this.selectedItem().aOwner[0]),this.listFilter(Enums.HelpdeskFilters.All),this.requestThreadsList()},CHelpdeskViewModel.prototype.onSearch=function(){this.requestThreadsList()},CHelpdeskViewModel.prototype.onClearSearch=function(){this.search(""),this.requestThreadsList()},CHelpdeskViewModel.prototype.initUploader=function(){this.oJua=this.createJuaObject(this.uploaderButton()),this.oJuaCompose=this.createJuaObject(this.uploaderButtonCompose())},CHelpdeskViewModel.prototype.createJuaObject=function(e){if(e){var t=new Jua({action:"?/Upload/HelpdeskFile/",name:"jua-uploader",queueSize:2,clickElement:e,hiddenElementsPosition:Utils.isRTL()?"right":"left",dragAndDropElement:e,disableAjaxUpload:!1,disableFolderDragAndDrop:!1,disableDragAndDrop:!1,hidden:{IsExt:this.bExtApp?"1":"0",Token:AppData.Token,TenantHash:this.bExtApp&&AppData?AppData.TenantHash:"",AccountID:this.bExtApp?0:AppData.Accounts.currentId()}});return t.on("onProgress",_.bind(this.onFileUploadProgress,this)).on("onSelect",_.bind(this.onFileUploadSelect,this)).on("onStart",_.bind(this.onFileUploadStart,this)).on("onComplete",_.bind(this.onFileUploadComplete,this)).on("onBodyDragEnter",_.bind(this.bDragActive,this,!0)).on("onBodyDragLeave",_.bind(this.bDragActive,this,!1)),t}return null},CHelpdeskViewModel.prototype.onFileRemove=function(e){var t=this.getUploadedFileByUID(e);this.oJua&&this.oJua.cancel(e),this.uploadedFiles.remove(t)},CHelpdeskViewModel.prototype.getUploadedFileByUID=function(e){return _.find(this.uploadedFiles(),function(t){return t.uploadUid()===e})},CHelpdeskViewModel.prototype.onFileUploadSelect=function(e,t){var i,s=Utils.i18n("HELPDESK/ERROR_UPLOAD_FILES_COUNT"),o=Utils.i18n("MAIN/BUTTON_CLOSE"),n=this.uploadedFiles().length;return n>=5?(App.Screens.showPopup(AlertPopup,[s,null,"",o]),!1):!App.Api.showErrorIfAttachmentSizeLimit(t.FileName,t.Size)&&(i=new CHelpdeskAttachmentModel,i.onUploadSelect(e,t),this.uploadedFiles.push(i),!0)},CHelpdeskViewModel.prototype.onFileUploadProgress=function(e,t,i){var s=this.getUploadedFileByUID(e);s&&s.onUploadProgress(t,i)},CHelpdeskViewModel.prototype.onFileUploadStart=function(e){var t=this.getUploadedFileByUID(e);t&&t.onUploadStart()},CHelpdeskViewModel.prototype.onFileUploadComplete=function(e,t,i){var s=this.getUploadedFileByUID(e),o=Date.now().toString();s&&(s.onUploadComplete(e,t,i),"image"===s.type().substr(0,5)&&(s.thumb(!0),s.getInThumbQueue(o)))},CHelpdeskViewModel.prototype.setUnseenCount=function(){App.helpdeskUnseenCount(_.filter(this.threads(),function(e){return e.unseen()},this).length)},CHelpdeskViewModel.prototype.quoteText=function(e){var t=this.replyText(),i=_.bind(function(){this.replyText(""===t?">"+e:t+"\n>"+e),this.replyTextFocus(!0)},this);this.isQuickReplyHidden()?_.delay(function(){i()},300):i(),this.isQuickReplyHidden(!1)},CHelpdeskViewModel.prototype.setSignature=function(e,t){e&&""===e()&&this.isSignatureVisible()&&e("\r\n\r\n"+this.signature()),t&&setTimeout(function(){if(t=t[0],t.setSelectionRange)t.focus(),t.setSelectionRange(0,0);else if(t.createTextRange){var e=t.createTextRange();e.moveStart("character",0),e.select()}}.bind(this),10)},CHelpdeskViewModel.prototype.changeCcbccVisibility=function(e,t){this.ccbccVisible(!0),$(this.ccAddrDom()).inputosaurus("focus")},CScreens.prototype.initScreens=function(){},CScreens.prototype.initLayout=function(){},CScreens.prototype.init=function(){this.initScreens(),this.initLayout(),$("#pSevenContent").addClass("single_mode"),_.defer(function(){AppData.SingleMode||$("#pSevenContent").removeClass("single_mode")}),this.informationScreen(this.showNormalScreen(Enums.Screens.Information))},CScreens.prototype.hasOpenedMinimizedPopups=function(){var e=!1;return _.each(this.popups,function(t){var i=t.__vm;i.minimized&&i.minimized()&&(e=!0)}),e},CScreens.prototype.hasOpenedMaximizedPopups=function(){var e=!1;return _.each(this.popups,function(t){var i=t.__vm;i.minimized&&i.minimized()||(e=!0)}),e},CScreens.prototype.getCurrentScreenModel=function(){var e=this.oScreens[this.currentScreen()],t="undefined"!=typeof e?e.Model:null;return t},CScreens.prototype.showCurrentScreen=function(e,t){var i=this.oScreens[this.currentScreen()],s="undefined"!=typeof i?i.Model:null;this.currentScreen()!==e&&(s&&i.bInitialized&&s.hideViewModel(),this.currentScreen(e)),this.showNormalScreen(e,t),this.resizeAll()},CScreens.prototype.showNormalScreen=function(e,t){var i=e,s=this.oScreens[i];return s&&(s.bInitialized="boolean"==typeof s.bInitialized&&s.bInitialized,s.bInitialized||(s.Model=this.initViewModel(s.Model,s.TemplateName),s.bInitialized=!0),s.Model.showViewModel(t)),s?s.Model:null},CScreens.prototype.initViewModel=function(e,t){var i=null,s=null;return i=new e,s=$('div[data-view-model="'+t+'"]').attr("data-bind","template: {name: '"+t+"'}").hide(),i.$viewModel=s,i.bShown=!1,i.showViewModel=function(e){bMobileApp&&(bIsWindowsPhone||App.browser.ie)?_.defer(_.bind(function(){this.$viewModel.show()},this)):this.$viewModel.show(),"function"==typeof this.onRoute&&this.onRoute(e),this.bShown||("function"==typeof this.onShow&&this.onShow(e),AfterLogicApi.runPluginHook&&this.__name&&AfterLogicApi.runPluginHook("view-model-on-show",[this.__name,this]),this.bShown=!0)},i.hideViewModel=function(){this.$viewModel.hide(),"function"==typeof this.onHide&&this.onHide(),this.bShown=!1},ko.applyBindings(i,s[0]),"function"==typeof i.onApplyBindings&&i.onApplyBindings(s),i},CScreens.prototype.showPopup=function(e,t){if(e){if(!e.__builded){var i=null,s=new e,o=s.popupTemplate?s.popupTemplate():"";""!==o&&(i=$('div[data-view-model="'+o+'"]').attr("data-bind","template: {name: '"+o+"'}").removeClass("visible").hide(),i&&1===i.length&&(s.visibility=ko.observable(!1),e.__builded=!0,e.__vm=s,s.$viewModel=i,e.__dom=i,s.showViewModel=Utils.createCommand(s,function(){App&&App.Screens&&App.Screens.showPopup(e)}),s.closeCommand=Utils.createCommand(s,function(){App&&App.Screens&&App.Screens.hidePopup(e)}),ko.applyBindings(s,i[0]),Utils.delegateRun(s,"onApplyBindings",[i])))}e.__vm&&e.__dom&&(e.__vm.visibility()||(e.__dom.show(),_.delay(function(){e.__dom.addClass("visible")},50),e.__vm.visibility(!0),this.popups.push(e),1===this.popups.length&&(this.keyupPopupBinded=_.bind(this.keyupPopup,this),$(document).on("keyup",this.keyupPopupBinded))),Utils.delegateRun(e.__vm,"onShow",t))}},CScreens.prototype.keyupPopup=function(e){var t=this.popups.length>0?this.popups[this.popups.length-1].__vm:null;if(e&&t&&(!t.minimized||!t.minimized())){var i=window.parseInt(e.keyCode,10);Enums.Key.Esc===i&&(t.onEscHandler?t.onEscHandler(e):t.closeCommand()),Enums.Key.Enter!==i&&Enums.Key.Space!==i||!t.onEnterHandler||t.onEnterHandler()}},CScreens.prototype.hidePopup=function(e){e&&e.__vm&&e.__dom&&(this.keyupPopupBinded&&1===this.popups.length&&($(document).off("keyup",this.keyupPopupBinded),this.keyupPopupBinded=void 0),e.__dom.removeClass("visible").hide(),e.__vm.visibility(!1),Utils.delegateRun(e.__vm,"onHide"),this.popups=_.without(this.popups,e))},CScreens.prototype.showLoading=function(e){this.informationScreen()&&this.informationScreen().showLoading(e)},CScreens.prototype.hideLoading=function(){this.informationScreen()&&this.informationScreen().hideLoading()},CScreens.prototype.showReport=function(e,t){this.informationScreen()&&this.informationScreen().showReport(e,t)},CScreens.prototype.showError=function(e,t,i,s){this.informationScreen()&&this.informationScreen().showError(e,t,i,s)},CScreens.prototype.hideError=function(e){this.informationScreen()&&this.informationScreen().hideError(e)},CScreens.prototype.initHelpdesk=function(){var e=this.oScreens[Enums.Screens.Helpdesk];AppData.User.IsHelpdeskSupported&&e&&!e.bInitialized&&(e.Model=this.initViewModel(e.Model,e.TemplateName),e.bInitialized=!0)},CScreens.prototype.initScreens=function(){this.oScreens[Enums.Screens.Information]={Model:CInformationViewModel,TemplateName:"Common_InformationViewModel"},this.oScreens[Enums.Screens.Login]={Model:CWrapLoginViewModel,TemplateName:"Login_WrapLoginViewModel"},this.oScreens[Enums.Screens.Header]={Model:CHeaderViewModel,TemplateName:"Common_HeaderViewModel"},this.oScreens[Enums.Screens.Mailbox]={Model:CMailViewModel,TemplateName:"Mail_LayoutSidePane_MailViewModel"},this.oScreens[Enums.Screens.SingleMessageView]={Model:CMessagePaneViewModel,TemplateName:"Mail_LayoutSidePane_MessagePaneViewModel"},this.oScreens[Enums.Screens.Compose]={Model:CComposeViewModel,TemplateName:"Mail_ComposeViewModel"},this.oScreens[Enums.Screens.SingleCompose]={Model:CComposeViewModel,TemplateName:"Mail_ComposeViewModel"},this.oScreens[Enums.Screens.Settings]={Model:CSettingsViewModel,TemplateName:"Settings_SettingsViewModel"},this.oScreens[Enums.Screens.SingleHelpdesk]={Model:CHelpdeskViewModel,TemplateName:"Helpdesk_ViewThreadInNewWindow"}},CScreens.prototype.initLayout=function(){$("#pSevenContent").append($("#Layout").html())},CMailCache.prototype.init=function(){var e=null;if(App.Ajax.openedRequestsCount.subscribe(function(){0===App.Ajax.openedRequestsCount()&&_.delay(_.bind(function(){0===App.Ajax.requests().length&&(this.checkMailStarted(!1),this.folderListLoading.removeAll(),this.messagesLoading(!1))},this),10)},this),AppData.SingleMode&&window.opener&&window.opener.App&&(e=window.opener.App.MailCache,this.oFolderListItems=e.oFolderListItems,this.uidList(e.uidList()),e.uidList.subscribe(_.bind(function(){this.uidList(e.uidList())},this)),window.name)){var t,i=Utils.pInt(window.name);0===i&&window.opener&&window.opener.aMessagesParametersFromCompose&&(t=window.opener.aMessagesParametersFromCompose[window.name],i=t?t.accountId:0),0!==i&&this.currentAccountId(i)}this.currentAccountId.valueHasMutated()},CMailCache.prototype.getCurrentFolder=function(){return this.folderList().currentFolder()},CMailCache.prototype.getFolderByFullName=function(e,t){var i=this.oFolderListItems[e];return i?i.getFolderByFullName(t):null},CMailCache.prototype.checkCurrentFolderList=function(){var e=AppData.Accounts.getCurrent(),t=this.oFolderListItems[e.id()];!e.allowMail()||t||this.messagesLoading()||(this.messagesLoading(!0),this.messagesLoadingError(!1),this.getFolderList(e.id()))},CMailCache.prototype.getFolderList=function(e){var t=AppData.Accounts.getAccount(e),i={AccountID:e,Action:"FoldersGetList"};t&&t.allowMail()?(this.folderListLoading.push(e),App.Ajax.send(i,this.onFoldersGetListResponse,this)):e===this.currentAccountId()&&this.messagesLoading(!1)},CMailCache.prototype.markMessageReplied=function(e,t,i,s){var o=this.oFolderListItems[e],n=null;o&&(n=o.getFolderByFullName(t),n&&n.markMessageReplied(i,s))},CMailCache.prototype.hideThreads=function(e){AppData.User.useThreads()&&e.folder()===this.folderList().currentFolderFullName()&&!e.threadOpened()&&this.folderList().currentFolder().hideThreadMessages(e)},CMailCache.prototype.showOpenedThreads=function(e){this.messages(this.getMessagesWithThreads(e,this.uidList(),this.messages()))},CMailCache.prototype.useThreadsInCurrentList=function(e){e=e||this.uidList();var t=this.folderList().currentFolder(),i=t&&t.withoutThreads(),s=""===e.search()&&""===e.filters();return AppData.User.useThreads()&&!i&&s},CMailCache.prototype.getMessagesWithThreads=function(e,t,i){var s=[],o=[],n=this.folderList().currentFolder();return n&&e===n.fullName()&&this.useThreadsInCurrentList(t)?(o=_.filter(i,function(e){return!e.threadPart()}),_.each(o,function(e){var t=[];s.push(e),e.threadCount()>0&&(e.threadOpened()&&(t=this.folderList().currentFolder().getThreadMessages(e),s=_.union(s,t)),n.computeThreadData(e))},this),s):i},CMailCache.prototype.setMessagesFromUidList=function(e,t,i,s){var o=e.getUidsForOffset(t,i),n=_.map(o,function(e){return i[e]},this),a=n.length;return s&&(this.messages(this.getMessagesWithThreads(this.folderList().currentFolderFullName(),e,n)),t+a<e.resultCount()&&a<AppData.User.MailsPerPage&&(e.filters()!==Enums.FolderFilter.Unseen||this.waitForUnseenMessages())&&this.messagesLoading(!0),this.currentMessage()&&(this.currentMessage().deleted()||this.currentMessage().folder()!==this.folderList().currentFolderFullName())&&this.currentMessage(null)),o},CMailCache.prototype.executeCheckMail=function(e){var t=this.oFolderListItems[this.currentAccountId()],i=AppData.Accounts.getCurrentFetchersAndFiltersFolderNames(),s=t?[t.inboxFolderFullName(),t.spamFolderFullName(),t.currentFolderFullName()]:[],o=t?t.iAccountId:0,n=this.checkMailStarted()&&this.checkMailStartedAccountId()===o,a=null;AppData.Auth&&(e||!App.Ajax.hasOpenedRequests("FoldersGetRelevantInformation")||!n)&&s.length>0&&(s=_.uniq(_.compact(_.union(s,i))),a={Action:"FoldersGetRelevantInformation",Folders:s,AccountID:o},this.checkMailStarted(!0),this.checkMailStartedAccountId(o),App.Ajax.send(a,this.onFoldersGetRelevantInformationResponse,this))},CMailCache.prototype.setAutocheckmailTimer=function(){clearTimeout(this.iAutoCheckMailTimer),!AppData.SingleMode&&AppData.User.AutoCheckMailInterval>0&&(this.iAutoCheckMailTimer=setTimeout(function(){App.Ajax.isSearchMessages()||(App.MailCache.checkMessageFlags(),App.MailCache.executeCheckMail(!1))},60*AppData.User.AutoCheckMailInterval*1e3))},CMailCache.prototype.checkMessageFlags=function(){var e=this.folderList().inboxFolder(),t=e?e.getFlaggedMessageUids():[],i={Action:"MessagesGetFlags",Folder:this.folderList().inboxFolderFullName(),Uids:t};t.length>0&&App.Ajax.send(i,this.onMessagesGetFlagsResponse,this)},CMailCache.prototype.onMessagesGetFlagsResponse=function(e,t){var i=this.oFolderListItems[t.AccountID],s=i?i.inboxFolder():null;s&&(e.Result&&_.each(e.Result,function(e,t){_.indexOf(e,"\\flagged")===-1&&s.setMessageUnflaggedByUid(t)}),s.removeFlaggedMessageListsFromCache(),App.Prefetcher.prefetchStarredMessageList())},CMailCache.prototype.changeCurrentMessageList=function(e,t,i,s){this.requestCurrentMessageList(e,t,i,s,!0)},CMailCache.prototype.requestCurrentMessageList=function(e,t,i,s,o){var n=this.requestMessageList(e,t,i,s||"",!0,o||!1),a=60*AppData.User.AutoCheckMailInterval*1e3,r=n.Folder.relevantInformationLastMoment?moment().diff(n.Folder.relevantInformationLastMoment):a+1;this.uidList(n.UidList),this.page(t),this.messagesLoading(n.RequestStarted),this.messagesLoadingError(!1),!n.RequestStarted&&a>0&&r>a&&this.executeCheckMail(!0)},CMailCache.prototype.requestMessageList=function(e,t,i,s,o,n){var a=this.oFolderListItems[this.currentAccountId()],r=a?a.getFolderByFullName(e):null,l=r&&r.withoutThreads(),h=AppData.User.useThreads()&&!l&&""===i&&""===s,c=r?r.getUidList(i,s):null,p=c&&c.resultCount()===-1,d=(t-1)*AppData.User.MailsPerPage,u={Action:"MessagesGetList",Folder:e,Offset:d,Limit:AppData.User.MailsPerPage,Search:i,Filters:s,UseThreads:h?"1":"0"},m=!1,g=!1,A=o?this.onCurrentMessagesGetListResponse:this.onMessagesGetListResponse,f=[];return r.type()===Enums.FolderTypes.Inbox&&""===s&&(u.InboxUidnext=r.sUidNext),p&&c.search()===this.uidList().search()&&c.filters()===this.uidList().filters()&&(c=this.uidList()),c&&(f=this.setMessagesFromUidList(c,d,r.oMessages,n)),c&&(g=p||d+f.length<c.resultCount()&&f.length<AppData.User.MailsPerPage,m=r.hasChanges()||g),m?App.Ajax.send(u,A,this):this.waitForUnseenMessages(!1),{UidList:c,RequestStarted:m,DataExpected:g,Folder:r}},CMailCache.prototype.executeEmptyTrash=function(){var e=this.folderList().trashFolder();e&&e.emptyFolder()},CMailCache.prototype.executeEmptySpam=function(){var e=this.folderList().spamFolder();e&&e.emptyFolder()},CMailCache.prototype.onClearFolder=function(e){if(e&&e.selected()){this.messages.removeAll(),this.currentMessage(null);var t=e?e.getUidList(this.uidList().search(),this.uidList().filters()):null;t?this.uidList(t):this.uidList(new CUidListModel),this.checkMailStarted(!1),this.setAutocheckmailTimer()}},CMailCache.prototype.moveMessagesToFolder=function(e,t,i){if(t.length>0){var s=this.folderList().currentFolder(),o=s&&s.type()===Enums.FolderTypes.Drafts,n=o&&Utils.WindowOpener.getOpenedDraftUids(),a=o&&_.find(t,_.bind(function(e){return-1!==Utils.inArray(e,n)},this)),r=this.folderList().getFolderByFullName(e),l={Action:"MessageMove",Folder:s?s.fullName():"",ToFolder:e,Uids:t.join(",")},h=null,c=_.bind(function(){this.uidList().filters()===Enums.FolderFilter.Unseen&&this.uidList().resultCount()>AppData.User.MailsPerPage&&this.waitForUnseenMessages(!0),h=s.markDeletedByUids(t),r.addMessagesCountsDiff(h.MinusDiff,h.UnseenMinusDiff),!Utils.isUnd(i)&&!i||r.recivedAnim(!0),this.excludeDeletedMessages(),r.markHasChanges(),App.Ajax.send(l,this.onMoveMessagesResponse,this),r&&r.type()===Enums.FolderTypes.Trash&&AfterLogicApi.runPluginHook("move-messages-to-trash",[AppData.Accounts.currentId(),l.Folder,t]),r&&r.type()===Enums.FolderTypes.Spam&&AfterLogicApi.runPluginHook("move-messages-to-spam",[AppData.Accounts.currentId(),l.Folder,t]),s&&s.type()===Enums.FolderTypes.Spam&&AfterLogicApi.runPluginHook("move-messages-from-spam",[AppData.Accounts.currentId(),l.Folder,t])},this);s&&r&&(a?(this.disableComposeAutosave(!0),App.Screens.showPopup(ConfirmPopup,[Utils.i18n("MAILBOX/CONFIRM_MESSAGE_FOR_DELETE_IS_EDITED"),_.bind(function(e){e&&(Utils.WindowOpener.closeComposesWithDraftUids(t),c()),this.disableComposeAutosave(!1)},this),"",Utils.i18n("MAILBOX/BUTTON_CLOSE_DELETE_DRAFT")])):c())}},CMailCache.prototype.copyMessagesToFolder=function(e,t,i){if(t.length>0){var s=this.folderList().currentFolder(),o=this.folderList().getFolderByFullName(e),n={Action:"MessageCopy",Folder:s?s.fullName():"",ToFolder:e,Uids:t.join(",")};s&&o&&(!Utils.isUnd(i)&&!i||o.recivedAnim(!0),o.markHasChanges(),App.Ajax.send(n,this.onCopyMessagesResponse,this),o&&o.type()===Enums.FolderTypes.Trash&&AfterLogicApi.runPluginHook("copy-messages-to-trash",[AppData.Accounts.currentId(),n.Folder,t]),o&&o.type()===Enums.FolderTypes.Spam&&AfterLogicApi.runPluginHook("copy-messages-to-spam",[AppData.Accounts.currentId(),n.Folder,t]))}},CMailCache.prototype.excludeDeletedMessages=function(){_.delay(_.bind(function(){var e=this.folderList().currentFolder(),t=(this.page()-1)*AppData.User.MailsPerPage;this.setMessagesFromUidList(this.uidList(),t,e.oMessages,!0)},this),500)},CMailCache.prototype.removeOneMessageFromCacheForFolder=function(e,t,i){var s=this.oFolderListItems[e],o=s?s.getFolderByFullName(t):null;o&&o.type()===Enums.FolderTypes.Drafts&&(o.markDeletedByUids([i]),o.commitDeleted([i]))},CMailCache.prototype.startMessagesLoadingWhenDraftSaving=function(e,t){var i=this.oFolderListItems[e],s=i?i.getFolderByFullName(t):null;s&&s.type()===Enums.FolderTypes.Drafts&&s.selected()&&this.messagesLoading(!0)},CMailCache.prototype.removeMessagesFromCacheForFolder=function(e,t){var i=this.oFolderListItems[e],s=i?i.getFolderByFullName(t):null,o=i?i.currentFolderFullName():null;s&&(s.markHasChanges(),this.currentAccountId()===e&&t===o&&this.requestCurrentMessageList(o,this.page(),this.uidList().search(),"",!0));
},CMailCache.prototype.deleteMessages=function(e){var t=this.folderList().currentFolder();t&&this.deleteMessagesFromFolder(t,e)},CMailCache.prototype.deleteMessagesFromFolder=function(e,t){var i={Action:"MessageDelete",Folder:e.fullName(),Uids:t.join(",")};e.markDeletedByUids(t),this.excludeDeletedMessages(),App.Ajax.send(i,this.onMoveMessagesResponse,this),AfterLogicApi.runPluginHook("delete-messages",[AppData.Accounts.currentId(),i.Folder,t])},CMailCache.prototype.showExternalPictures=function(e){var t=[],i=null;this.currentMessage()&&(t=this.currentMessage().oFrom.aCollection,i=this.folderList().getFolderByFullName(this.currentMessage().folder()),e&&t.length>0?i.alwaysShowExternalPicturesForSender(t[0].sEmail):i.showExternalPictures(this.currentMessage().uid()))},CMailCache.prototype.setCurrentMessage=function(e,t){var i=this.folderList().currentFolder(),s=i&&e?i.oMessages[e]:null;!AppData.SingleMode||i&&i.fullName()===t||(this.folderList().setCurrentFolder(t,""),i=this.folderList().currentFolder()),s&&!s.deleted()?(this.currentMessage(s),this.currentMessage().seen()||this.executeGroupOperation("MessageSetSeen",[this.currentMessage().uid()],"seen",!0),i.getCompletelyFilledMessage(e,this.onCurrentMessageResponse,this)):(this.currentMessage(null),AppData.SingleMode&&i&&i.getCompletelyFilledMessage(e,this.onCurrentMessageResponse,this))},CMailCache.prototype.onCurrentMessageResponse=function(e,t){var i=this.currentMessage()?this.currentMessage().uid():"";null===e&&i===t?this.currentMessage(null):e&&i===t?this.currentMessage.valueHasMutated():AppData.SingleMode&&e&&null===this.currentMessage()&&this.currentMessage(e)},CMailCache.prototype.getMessage=function(e,t,i,s){var o=this.folderList().getFolderByFullName(e);o&&o.getCompletelyFilledMessage(t,i,s)},CMailCache.prototype.executeGroupOperation=function(e,t,i,s){var o=this.folderList().currentFolder(),n={Action:e,Folder:o?o.fullName():"",Uids:t.join(","),SetAction:s?1:0},a=(this.page()-1)*AppData.User.MailsPerPage,r=t.length,l=this.folderList().oStarredFolder?this.folderList().oStarredFolder.messageCount():0,h=o?o.getUidList("",Enums.FolderFilter.Flagged):null;o&&("MessageSetSeen"===n.Action&&this.iMessageSetSeenCount++,App.Ajax.send(n,this.onExecuteGroupOperationResponse,this),o.executeGroupOperation(i,t,s),o.type()===Enums.FolderTypes.Inbox&&"flagged"===i&&(this.uidList().filters()===Enums.FolderFilter.Flagged?s||(this.uidList().deleteUids(t),this.folderList().oStarredFolder&&this.folderList().oStarredFolder.messageCount(h.resultCount())):(o.removeFlaggedMessageListsFromCache(),""===this.uidList().search()&&this.folderList().oStarredFolder&&(s?this.folderList().oStarredFolder.messageCount(l+r):this.folderList().oStarredFolder.messageCount(l-r>0?l-r:0)))),"seen"===i&&o.removeUnseenMessageListsFromCache(),(this.uidList().filters()!==Enums.FolderFilter.Unseen||this.waitForUnseenMessages())&&_.delay(_.bind(function(){this.setMessagesFromUidList(this.uidList(),a,o.oMessages,!0)},this)))},CMailCache.prototype.onExecuteGroupOperationResponse=function(e,t){"MessageSetSeen"===t.Action&&(this.iMessageSetSeenCount--,this.iMessageSetSeenCount<0&&(this.iMessageSetSeenCount=0),this.folderList().currentFolder()&&0===this.iMessageSetSeenCount&&(this.uidList().filters()!==Enums.FolderFilter.Unseen||this.waitForUnseenMessages())&&this.requestCurrentMessageList(this.folderList().currentFolder().fullName(),this.page(),this.uidList().search(),this.uidList().filters(),!1))},CMailCache.prototype.onFoldersGetListResponse=function(e,t){var i=new CFolderListModel,s=parseInt(e.AccountID,10),o=this.oFolderListItems[s],n=o?o.oNamedCollection:{};e.Result===!1?(App.Api.showErrorByCode(e),t.AccountID===this.currentAccountId()&&0===this.messages().length&&(this.messagesLoading(!1),this.messagesLoadingError(!0))):(i.parse(s,e.Result,n),o&&i.oStarredFolder.messageCount(o.oStarredFolder.messageCount()),this.oFolderListItems[s]=i,setTimeout(_.bind(this.getAllFoldersRelevantInformation,this,s),2e3),this.currentAccountId()===s&&this.folderList(i),this.editedAccountId()===s&&this.editedFolderList(i),AppData.Accounts.defaultId()===s&&this.defaultFolderList(i)),this.folderListLoading.remove(s)},CMailCache.prototype.setCurrentFolderList=function(e){var t=e.iAccountId;t===this.currentAccountId()&&t!==this.folderList().iAccountId&&this.folderList(e)},CMailCache.prototype.getAllFoldersRelevantInformation=function(e){var t=this.oFolderListItems[e],i=t?t.getFoldersWithoutCountInfo():[],s={Action:"FoldersGetRelevantInformation",Folders:i,AccountID:e};i.length>0&&App.Ajax.send(s,this.onFoldersGetRelevantInformationResponse,this)},CMailCache.prototype.onFoldersGetRelevantInformationResponse=function(e,t){var i=!1,s=e.AccountID,o=this.oFolderListItems[s],n=this.folderList().currentFolderFullName(),a=this.currentAccountId()===s;e.Result===!1?(App.Api.showErrorByCode(e),App.Ajax.hasOpenedRequests("FoldersGetRelevantInformation")&&(i=!0)):o&&(_.each(e.Result&&e.Result.Counts,function(e,t){if(_.isArray(e)&&e.length>3){var s=e[0],r=e[1],l=e[2],h=e[3],c=!1,p=!1,d=null;d=o.getFolderByFullName(t),d&&(p=a&&d.fullName()===n,c=d.setRelevantInformation(l,h,s,r,p),p&&c&&this.uidList().filters()!==Enums.FolderFilter.Unseen&&(this.requestCurrentMessageList(d.fullName(),this.page(),this.uidList().search(),this.uidList().filters(),!1),i=!0))}},this),o.countsCompletelyFilled(!0)),this.checkMailStarted(i),this.checkMailStarted()||this.setAutocheckmailTimer()},CMailCache.prototype.showNotificationsForNewMessages=function(e){var t=this.folderList().currentFolderFullName(),i=0,s="",o={};e.Result.New&&e.Result.New.length>0&&(i=e.Result.New.length,s=e.Result.New[0].Uid,o={action:"show",icon:"skins/wm_logo_140x140.png",title:Utils.i18n("NOTIFICATION/NEW_MESSAGE_PLURAL",{COUNT:i},null,i),timeout:5e3,callback:function(){window.focus(),App.Routing.setHash(App.Links.mailbox(t,1,s,"",""))}},1===i&&(o.body=Utils.i18n("MESSAGE/HEADER_SUBJECT")+": "+e.Result.New[0].Subject+"\r\n"+Utils.i18n("MESSAGE/HEADER_FROM")+": "+_.map(e.Result.New[0].From,function(e,t){return""!==e.DisplayName?e.DisplayName:e.Email}).join(", ")),App.desktopNotify(o))},CMailCache.prototype.onCurrentMessagesGetListResponse=function(e,t){this.checkMailStarted(!1),e.Result?(this.messagesLoadingError(!1),this.parseMessageList(e,t)):(App.Api.showErrorByCode(e),this.messagesLoading()!==!0||0!==this.messages().length&&e.ErrorCode===Enums.Errors.NotDisplayedError||this.messagesLoadingError(!0),this.messagesLoading(!1),this.setAutocheckmailTimer())},CMailCache.prototype.onMessagesGetListResponse=function(e,t){e&&e.Result&&this.parseMessageList(e,t)},CMailCache.prototype.parseMessageList=function(e,t){var i=e.Result,s=this.oFolderListItems[e.AccountID],o=null,n=null,a="1"===t.UseThreads,r=!1,l=this.currentAccountId()===e.AccountID&&this.folderList().currentFolderFullName()===i.FolderName,h=l&&this.uidList().search()===i.Search&&this.uidList().filters()===i.Filters,c=this.page()===i.Offset/AppData.User.MailsPerPage+1,p=[];this.showNotificationsForNewMessages(e),i!==!1&&"Collection/MessageCollection"===i["@Object"]&&(o=s.getFolderByFullName(i.FolderName),o.setRelevantInformation(i.UidNext.toString(),i.FolderHash,i.MessageCount,i.MessageUnseenCount,l&&!h),r=o.hasChanges(),o.removeAllMessageListsFromCacheIfHasChanges(),n=o.getUidList(i.Search,i.Filters),n.setUidsAndCount(i),_.each(i["@Collection"],function(e){var t=o.parseAndCacheMessage(e,!1,a);p.push(t)},this),AfterLogicApi.runPluginHook("response-custom-messages",[e.AccountID,o.fullName(),p]),h&&(this.uidList(n),c&&(n.filters()!==Enums.FolderFilter.Unseen||this.waitForUnseenMessages())&&(this.setMessagesFromUidList(n,i.Offset,o.oMessages,!0),this.messagesLoading(!1),this.waitForUnseenMessages(!1),this.setAutocheckmailTimer())),!r||!l||h&&c||this.uidList().filters()===Enums.FolderFilter.Unseen||this.requestCurrentMessageList(this.folderList().currentFolderFullName(),this.page(),this.uidList().search(),this.uidList().filters(),!1),o.type()===Enums.FolderTypes.Inbox&&n.filters()===Enums.FolderFilter.Flagged&&""===n.search()&&this.folderList().oStarredFolder&&(this.folderList().oStarredFolder.messageCount(n.resultCount()),this.folderList().oStarredFolder.hasExtendedInfo(!0)))},CMailCache.prototype.increaseStarredCount=function(){this.folderList().oStarredFolder&&this.folderList().oStarredFolder.increaseCountIfHasNotInfo()},CMailCache.prototype.onMoveMessagesResponse=function(e,t){var i=e.Result,s=this.folderList().getFolderByFullName(t.Folder),o=this.folderList().getFolderByFullName(t.ToFolder),n=o&&o.type()===Enums.FolderTypes.Trash,a=o&&o.type()===Enums.FolderTypes.Spam,r=null,l=n?Utils.i18n("MAILBOX/CONFIRM_MESSAGES_DELETE_WITHOUT_TRASH"):Utils.i18n("MAILBOX/CONFIRM_MESSAGES_MARK_SPAM_WITHOUT_SPAM"),h=_.bind(function(e){e&&s&&this.deleteMessagesFromFolder(s,t.Uids.split(","))},this),c=this.folderList().currentFolder(),p=c.fullName(),d=!1;if(i===!1?(r=s.revertDeleted(t.Uids.split(",")),o?(o.addMessagesCountsDiff(-r.PlusDiff,-r.UnseenPlusDiff),e.ErrorCode===Enums.Errors.ImapQuota&&(n||a)?App.Screens.showPopup(ConfirmPopup,[l,h]):App.Api.showErrorByCode(e,Utils.i18n("MAILBOX/ERROR_MOVING_MESSAGES"))):App.Api.showErrorByCode(e,Utils.i18n("MAILBOX/ERROR_DELETING_MESSAGES")),d=!0):s.commitDeleted(t.Uids.split(",")),p===s.fullName()||o&&p===o.fullName())switch(c.markHasChanges(),this.uidList().filters()){case Enums.FolderFilter.Flagged:break;case Enums.FolderFilter.Unseen:this.waitForUnseenMessages()&&this.requestCurrentMessageList(p,this.page(),this.uidList().search(),this.uidList().filters(),d);break;default:this.requestCurrentMessageList(p,this.page(),this.uidList().search(),this.uidList().filters(),d)}else p!==s.fullName()?App.Prefetcher.startFolderPrefetch(s):o&&p!==o.fullName()&&App.Prefetcher.startFolderPrefetch(o)},CMailCache.prototype.onCopyMessagesResponse=function(e,t){var i=e.Result,s=this.folderList().getFolderByFullName(t.Folder),o=this.folderList().getFolderByFullName(t.ToFolder),n=this.folderList().currentFolder(),a=n.fullName();i===!1&&App.Api.showErrorByCode(e,Utils.i18n("MAILBOX/ERROR_COPYING_MESSAGES")),a===s.fullName()||o&&a===o.fullName()?(n.markHasChanges(),this.requestCurrentMessageList(a,this.page(),this.uidList().search(),"",!1)):a!==s.fullName()?App.Prefetcher.startFolderPrefetch(s):o&&a!==o.fullName()&&App.Prefetcher.startFolderPrefetch(o)},CMailCache.prototype.searchMessagesInCurrentFolder=function(e){var t=this.folderList().currentFolderFullName()||"INBOX",i=this.currentMessage()?this.currentMessage().uid():"",s=this.uidList().filters();Enums.FolderFilter.Flagged===s&&(s=""),App.Routing.setHash(App.Links.mailbox(t,1,i,e,s))},CMailCache.prototype.searchMessagesInInbox=function(e){App.Routing.setHash(App.Links.mailbox(this.folderList().inboxFolderFullName()||"INBOX",1,"",e,""))},CMailCache.prototype.countMessages=function(e){var t=[],i=function(e){_.each(e.subfolders(),function(e,s){e.subscribed()&&(t.push(e.unseenMessageCount()),e.subfolders().length&&e.subscribed()&&i(e))},this)};e.expanded()||e.bNamespace?e.subfoldersMessagesCount(0):(i(e),e.subfoldersMessagesCount(_.reduce(t,function(e,t){return e+t},0)))},CMailCache.prototype.changeDatesInMessages=function(){_.each(this.oFolderListItems,function(e){_.each(e.oNamedCollection,function(e){_.each(e.oMessages,function(e){e.updateMomentDate()},this)})})},CMailCache.prototype.getTemplateFolder=function(){var e=this.folderList(),t="",i=e.currentFolder()?e.currentFolder().fullName():"";return Utils.isNonEmptyArray(this.getCurrentTemplateFolders())&&(t=-1!==Utils.inArray(i,this.getCurrentTemplateFolders())?i:_.find(this.getCurrentTemplateFolders(),function(t){return!!e.oNamedCollection[t]})),"string"==typeof t?t:""},CMailCache.prototype.getCurrentTemplateFolders=function(){return AppData.App.AllowTemplateFolders?this.folderList().aTemplateFolders:[]},CMailCache.prototype.changeTemplateFolder=function(e,t){AppData.App.AllowTemplateFolders&&this.folderList().changeTemplateFolder(e,t)},CContactsCache.prototype.clearInfoAboutEmail=function(e){this.contacts[e]=void 0},CContactsCache.prototype.getContactsByEmails=function(e,t,i){if(AppData.User.ShowContacts){var s=[],o=Math.random().toString();_.each(e,_.bind(function(e){var o=this.contacts[e];void 0!==o?t.apply(i,[o,e]):(this.contacts[e]=null,s.push(e))},this)),s.length>0&&(this.responseHandlers[o]={func:t,context:i},App.Ajax.send({Action:"ContactsGetByEmails",Emails:s.join(","),HandlerId:o},this.onContactsGetByEmailsResponse,this))}},CContactsCache.prototype.onContactsGetByEmailsResponse=function(e,t){var i=this.responseHandlers[t.HandlerId],s=e.Result;s&&_.each(s,_.bind(function(e,t){var s=new CContactModel;s&&(s.parse(e),this.contacts[t]=s,i&&i.func.apply(i.context,[s,t]))},this)),this.responseHandlers[t.HandlerId]=void 0},CContactsCache.prototype.addVcard=function(e){this.vcardAttachments.push(e)},CContactsCache.prototype.markVcardsNonexistentByUid=function(e){_.each(this.vcardAttachments,function(t){-1!==_.indexOf(e,t.uid())&&t.exists(!1)})},CContactsCache.prototype.markVcardExistentByFile=function(e){_.each(this.vcardAttachments,function(t){t.file()===e&&t.exists(!0)})},CCalendarCache.prototype.addIcal=function(e){_.each(this.icalAttachments,function(t){t.uid()===e.uid()&&(e.sSequence>=t.sSequence?t.lastModification(!1):e.lastModification(!1))}),this.icalAttachments.push(e),0===this.calendars().length&&this.canRequestCalendarList()&&this.requestCalendarList()},CCalendarCache.prototype.firstRequestCalendarList=function(){return this.canRequestCalendarList(!0),this.icalAttachments.length>0&&0===this.calendars().length&&this.requestCalendarList(),this.calendarsLoadingStarted()},CCalendarCache.prototype.onCalendarListResponse=function(e,t){if(e&&e.Result){var i=AppData.Accounts,s=i.currentId(),o=i.getAccount(s).email(),n=_.filter(e.Result,function(e){return e.Owner===o||e.Access===Enums.CalendarAccess.Full||e.Access===Enums.CalendarAccess.Write});this.calendars(_.map(n,function(e){return{name:e.Name+" <"+e.Owner+">",id:e.Id}}))}this.calendarsLoadingStarted(!1)},CCalendarCache.prototype.requestCalendarList=function(){this.calendarsLoadingStarted()||(App.Ajax.send({Action:"CalendarList"},this.onCalendarListResponse,this),this.calendarsLoadingStarted(!0))},CCalendarCache.prototype.markIcalNonexistent=function(e){_.each(this.icalAttachments,function(t){e===t.uid()&&t.onEventDelete()})},CCalendarCache.prototype.markIcalTypeByFile=function(e,t,i,s,o,n){_.each(this.icalAttachments,function(a){e===a.file()&&(a.type(t),a.cancelDecision(i),a.replyDecision(s),a.calendarId(o),a.selectedCalendarId(n))})},CCalendarCache.prototype.markIcalTentative=function(e){_.each(this.icalAttachments,function(t){e===t.uid()&&t.onEventTentative()})},CCalendarCache.prototype.markIcalAccepted=function(e){_.each(this.icalAttachments,function(t){e===t.uid()&&t.onEventAccept()})},AbstractApp.prototype.init=function(){},AbstractApp.prototype.collectScreensData=function(){},AbstractApp.prototype.run=function(){},AbstractApp.prototype.momentDateTriggerCallback=function(){var e=ko.dataFor(this);e&&e.updateMomentDate&&e.updateMomentDate()},AbstractApp.prototype.fastMomentDateTrigger=function(){$(".moment-date-trigger-fast").each(this.momentDateTriggerCallback)},AbstractApp.prototype.setTitle=function(e){document.title=".",document.title=e||""},AbstractApp.prototype.tokenProblem=function(){var e="window.location.reload(); return false;",t=Utils.i18n("WARNING/TOKEN_PROBLEM_HTML",{RELOAD_FUNC:e});AppData.Auth=!1,App.Api.showError(t,!0,!0)},_.extend(AppBase.prototype,AbstractApp.prototype),AppBase.prototype.initPhone=function(e){return null},AppBase.prototype.init=function(){var e=AppData.User,t=new CUserSettingsModel,i=AppData.Accounts,s=new CAccountListModel,o=AppData.App,n=new CAppSettingsModel(!!o.AllowOpenPGP&&this.Api.isPgpSupported());n.parse(o),AppData.App=n,t.parse(e),AppData.User=t,s.parse(Utils.pInt(AppData.Default),i),AppData.Accounts=s,this.MailCache=new CMailCache,this.Phone=this.initPhone(t.AllowVoice&&!this.browser.ie&&!bMobileApp),this.useGoogleAnalytics(),this.collectScreensData(),$(window).unload(function(){bMobileDevice||Utils.WindowOpener.closeAll()}),this.nowDateNumber=ko.observable(moment().date()),window.setInterval(function(){App.fastMomentDateTrigger(),App.nowDateNumber(moment().date())},6e4),this.nowDateNumber.subscribe(function(){this.MailCache.changeDatesInMessages()},this),this.browser.ie8AndBelow&&$("body").css("overflow","hidden"),this.Storage.setData("AuthToken",this.Storage.getData("AuthToken"))},AppBase.prototype.collectScreensData=function(){},AppBase.prototype.registerHelpdeskUpdateFunction=function(e){this.fHelpdeskUpdate=e},AppBase.prototype.updateHelpdesk=function(){this.fHelpdeskUpdate&&this.fHelpdeskUpdate()},AppBase.prototype.useGoogleAnalytics=function(){var e=null,t=null;AppData.App.GoogleAnalyticsAccount&&0<AppData.App.GoogleAnalyticsAccount.length&&(window._gaq=window._gaq||[],window._gaq.push(["_setAccount",AppData.App.GoogleAnalyticsAccount]),window._gaq.push(["_trackPageview"]),e=document.createElement("script"),e.type="text/javascript",e.async=!0,e.src=("https:"===document.location.protocol?"https://ssl":"http://www")+".google-analytics.com/ga.js",t=document.getElementsByTagName("script")[0],t.parentNode.insertBefore(e,t))},AppBase.prototype.logout=function(e){var t={Action:"SystemLogout",AuthToken:App.Storage.getData("AuthToken")};e&&(t.LastErrorCode=e),App.Ajax.send(t,this.onLogout,this),AppData.Auth=!1},AppBase.prototype.authProblem=function(){this.logout(Enums.Errors.AuthError)},AppBase.prototype.onLogout=function(){Utils.WindowOpener.closeAll(),App.Routing.finalize(),""!==AppData.App.CustomLogoutUrl?window.location.href=AppData.App.CustomLogoutUrl:Utils.Common.clearAndReloadLocation(App.browser.ie8AndBelow,!0)},AppBase.prototype.getAccounts=function(){return AppData.Accounts},AppBase.prototype.run=function(){this.Screens.init(),Utils.checkCookies(),bIsIosDevice&&AppData&&AppData.Auth&&AppData.App.IosDetectOnLogin&&AppData.App.AllowIosProfile?window.location.href="?ios":AppData&&AppData.Auth?(AppData.SingleMode=this.Routing.isSingleMode(),AppData.SingleMode&&window.opener&&window.opener.App&&AppData.Accounts.populateIdentitiesFromSourceAccount(window.opener.App.getAccounts()),AppData.App.AllowWebMail&&this.MailCache.init(),AppData.HelpdeskRedirect&&this.Routing.currentScreen!==Enums.Screens.Helpdesk&&this.Routing.setHash([Enums.Screens.Helpdesk]),this.initRouting()):AppData&&""!==AppData.App.CustomLoginUrl?window.location.href=AppData.App.CustomLoginUrl:(this.Screens.showCurrentScreen(Enums.Screens.Login),this.checkLoginScreenStartError()),this.phoneInOneTab(),AppData.App.AllowAppRegisterMailto&&Utils.registerMailto(this.browser.firefox),AppData.Accounts.unlockEditedWhenCurrentChange(),this.startResetPass(),this.displaySocialWelcome()},AppBase.prototype.startResetPass=function(){AppData.Auth&&""!==this.sResetPassHash&&App.Api.showChangeDefaultAccountPasswordPopup()},AppBase.prototype.displaySocialWelcome=function(){var e=AppData.Accounts.getDefault(),t=AppData.Accounts.hasMailAccount();t||!e||App.Storage.hasData("SocialWelcomeShowed"+e.id())||""===AppData.User.SocialName||(App.Screens.showPopup(ConfirmPopup,[Utils.i18n("MAILBOX/INFO_SOCIAL_WELCOME",{SOCIALNAME:AppData.User.SocialName,SITENAME:AppData.App.SiteName,EMAIL:e.email()}),function(e){e&&App.Api.showConfigureMailPopup()},"",Utils.i18n("MAILBOX/BUTTON_CONFIGURE_MAIL"),Utils.i18n("MAIN/BUTTON_CLOSE")]),App.Storage.setData("SocialWelcomeShowed"+e.id(),"1"))},AppBase.prototype.checkLoginScreenStartError=function(){var e=Utils.pInt(Utils.Common.getRequestParam("error"));0!==e&&App.Api.showErrorByCode({ErrorCode:e,ErrorMessage:""},"",!0),AppData&&AppData.LastErrorCode===Enums.Errors.AuthError&&this.Api.showError(Utils.i18n("WARNING/AUTH_PROBLEM"),!1,!0)},AppBase.prototype.initRouting=function(){var e=!!_.find(Enums.Screens,function(e){return e===AppData.App.DefaultTab});e&&(AppData.App.AllowWebMail||AppData.App.DefaultTab!==Enums.Screens.Mailbox)?this.Routing.init(AppData.App.DefaultTab):AppData.App.AllowWebMail?this.Routing.init(Enums.Screens.Mailbox):this.headerTabs().length>0&&this.Routing.init(this.headerTabs()[0].name)},AppBase.prototype.getHelpLink=function(e){return AppData&&AppData.Links&&AppData.Links[e]?AppData.Links[e]:""},AppBase.prototype.addScreenToHeader=function(e,t,i,s,o,n,a){var r=this.Routing.buildHashFromArray([e]),l=this;e===Enums.Screens.Helpdesk&&(r=ko.computed(function(){return"#"+l.Routing.lastHelpdeskHash()})),Enums.Screens[e]=e,this.Screens.oScreens[e]={Model:o,TemplateName:s},this.headerTabs.push({name:e,title:t,hash:r,koVisibleTab:n,koRecivedAnim:a}),this.screensTitle[e]=i},AppBase.prototype.registerSessionTimeoutFunction=function(e){this.sessionTimeoutFunctions.push(e)},AppBase.prototype.initSessionTimeout=function(){this.setSessionTimeout(),$("body").on("click",_.bind(this.setSessionTimeout,this)).on("keydown",_.bind(this.setSessionTimeout,this))},AppBase.prototype.setSessionTimeout=function(){clearTimeout(this.iSessionTimeout),AppData&&AppData.Auth&&AppData.App.IdleSessionTimeout&&(this.iSessionTimeout=setTimeout(_.bind(this.logoutBySessionTimeout,this),AppData.App.IdleSessionTimeout))},AppBase.prototype.logoutBySessionTimeout=function(){AppData.Auth&&(_.each(this.sessionTimeoutFunctions,function(e){e()}),_.delay(_.bind(this.logout,this),500))},AppBase.prototype.initHeaderInfo=function(){this.browser.ie?$(document).bind("focusin",_.bind(this.onFocus,this)).bind("focusout",_.bind(this.onBlur,this)):$(window).bind("focus",_.bind(this.onFocus,this)).bind("blur",_.bind(this.onBlur,this))},AppBase.prototype.onFocus=function(){this.focused(!0)},AppBase.prototype.onBlur=function(){this.focused(!1)},AppBase.prototype.setTitle=function(e){var t=this.newMessagesCount(),i="";e=e||"",e=this.focused()||0===t||!AppData.App.AllowWebMail?this.getTitleByScreen():Utils.i18n("TITLE/HAS_UNSEEN_MESSAGES_PLURAL",{COUNT:t},null,t)+" - "+AppData.Accounts.getEmail(),this.favico&&(i=99<t?"99+":t,this.favico._cachevalue!==i&&(this.favico._cachevalue=i,this.favico.badge(i))),document.title=".",document.title=e},AppBase.prototype.getTitleByScreen=function(){var e="",t="";try{this.MailCache.currentMessage()&&(t=this.MailCache.currentMessage().subject())}catch(e){}switch(this.currentScreen()){case Enums.Screens.Login:e=Utils.i18n("TITLE/LOGIN",null,"");break;case Enums.Screens.Mailbox:e=AppData.Accounts.getEmail()+" - "+Utils.i18n("TITLE/MAILBOX");break;case Enums.Screens.Compose:case Enums.Screens.SingleCompose:e=AppData.Accounts.getEmail()+" - "+Utils.i18n("TITLE/COMPOSE");break;case Enums.Screens.SingleMessageView:e=AppData.Accounts.getEmail()+" - "+Utils.i18n("TITLE/VIEW_MESSAGE"),t&&(e=t+" - "+e);break;default:this.screensTitle[this.currentScreen()]&&(e=this.screensTitle[this.currentScreen()])}return""===e?e=AppData.App.SiteName:e+=AppData.App.SiteName&&""!==AppData.App.SiteName?" - "+AppData.App.SiteName:"",e},AppBase.prototype.desktopNotify=function(e){Utils.desktopNotify(e)},AppBase.prototype.phoneInOneTab=function(){if(this.Phone&&window.localStorage){var e=this;$(window).on("storage",function(e){"false"!==window.localStorage.getItem("p7phoneLoad")&&window.localStorage.setItem("p7phoneLoad","false")}),window.localStorage.setItem("p7phoneLoad",Math.floor(900*Math.random()+100).toString()),window.setTimeout(function(){AppData.SingleMode||!e.Phone||"false"===window.localStorage.getItem("p7phoneLoad")&&!window.sessionStorage.getItem("p7phoneTab")||(e.Phone.init(),window.sessionStorage.setItem("p7phoneTab","true"))},1e3)}},_.extend(AppMain.prototype,AppBase.prototype),AppMain.prototype.initPhone=function(e){return e?new CPhone:null},AppMain.prototype.collectScreensData=function(){AppData.User.ShowContacts&&this.addScreenToHeader("contacts",Utils.i18n("HEADER/CONTACTS"),Utils.i18n("TITLE/CONTACTS"),"Contacts_ContactsViewModel",CContactsViewModel,!0,this.ContactsCache.recivedAnim),AppData.User.AllowCalendar&&this.addScreenToHeader("calendar",Utils.i18n("HEADER/CALENDAR"),Utils.i18n("TITLE/CALENDAR"),"Calendar_CalendarViewModel",CCalendarViewModel,!0,this.CalendarCache.recivedAnim,!0),AppData.User.IsFilesSupported&&this.addScreenToHeader("files",Utils.i18n("HEADER/FILESTORAGE"),Utils.i18n("TITLE/FILESTORAGE"),"FileStorage_FileStorageViewModel",CFileStorageViewModel,AppData.User.filesEnable,this.filesRecievedAnim),AppData.User.IsHelpdeskSupported&&this.addScreenToHeader("helpdesk",Utils.i18n("HEADER/HELPDESK"),Utils.i18n("TITLE/HELPDESK"),"Helpdesk_HelpdeskViewModel",CHelpdeskViewModel,!0)},App=new AppMain,window.App=App,AppData.AllowMobile&&AppData.IsMobile===-1){var bMobile=window.matchMedia("all and (min-width: 768px)").matches?0:1;window.App.Ajax.send({Action:"SystemSetMobile",Mobile:bMobile},function(){bMobile?window.location.reload():$(function(){_.defer(function(){App.run()})})},this)}else $(function(){_.defer(function(){App.run()})});window.Modernizr&&navigator&&window.Modernizr.addTest("mobile",function(){return bMobileApp}),window.AfterLogicApi=AfterLogicApi,window.Enums=Enums,$html.removeClass("no-js").addClass("js"),$html.hasClass("pdf")&&(aViewMimeTypes.push("application/pdf"),aViewMimeTypes.push("application/x-pdf"))}(jQuery,window,ko,crossroads,hasher);
